<!doctype html>
<!--
Copyright (c) 2013, Empirical Modelling Group
All rights reserved.

See LICENSE.txt
-->

<html>
<head>
	<script type="text/javascript">
		try {
		  if (window.localStorage) {
			  if (window.localStorage.getItem("developer") === "true") {
				var currentPath = document.location.pathname;
				document.location.pathname = currentPath.slice(0, currentPath.lastIndexOf("/")) + "/index-dev.html";
			  }
		  }
		} catch (e) {
		  //Cookies are blocked.
		}
	</script>
	<title>JS-EDEN</title>

	<link rel="stylesheet" type="text/css" href="css/jseden.css">
	<link rel="stylesheet" type="text/css" href="css/jquery-ui-1.12.1.min.css">
	<link rel="stylesheet" type="text/css" href="css/eden.css">
	<link rel="stylesheet" type="text/css" href="css/font-awesome.min.css">
	<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="plugins/jseden-plugins.min.css">
	<link rel="stylesheet" type="text/css" media="print" href="css/print.css" />

	<script type="text/javascript" src="js/lib/jquery-1.8.3.min.js"></script>
	<script type="text/javascript" src="js/lib/jquery-ui-1.12.1.min.js"></script>
	<style type="text/css">
		.ui-dialog {
			z-index: 9999;
		}
	</style>
	<script type="text/javascript" src="js/lib/jquery.dialogextend.min.js"></script>
		<style type="text/css">

		div.jseden-dialog-plisting {
			box-sizing: border-box;
			padding-top: 20px;
			/*padding-bottom:30px;*/
			padding-left: 50px;
			padding-right: 50px;
			/*border: 1px solid #eee;*/
			width: 100%;
			height: 100%;
			display: flex;
			flex-direction: row;
			flex-wrap: wrap;
			justify-content: center;
			overflow-y: auto;
		}

		div.jseden-project-cat {
			font-size: 16pt;
			font-family: "Source Sans Pro",Arial,sans-serif;
			color: #eee;
			font-weight: bold;
			/*background: #416d77;*/
			padding: 10px 30px;
			border-bottom: 1px solid #eee;
		}

		hr.jseden-project-cat {
			border: 1px solid #b5b5f5;
		}

		div#loadoptions {
			position: relative;
			top: 55px;
		}

		div.cadence-plisting-entry {
			width: 200px;
			height: 170px;
			margin: 15px;
			background-repeat: no-repeat;
			cursor: pointer;
			color: #132023;
			background: white;
			border: 1px solid #777;
			padding: 15px;
			box-shadow: 10px 10px 10px #111;
			border-radius: 6px;
		}

		div.project-content {
			position: relative;
			margin: 20px auto;
			max-width: 900px;
			width: 80%;
		}

		div.cadence-plisting-login {
			/*width: 200px;
			height: 150px;*/
			margin: 5px;
			background: #f5f5f5;
			cursor: pointer;
			color: #424249;
			font-size: 18pt;
			font-weight: bold;
			font-family: "Source Sans Pro",Arial,sans-serif;
			text-align: center;
			border: 1px solid #ddd;
			padding: 10px 30px;
			/*text-shadow: 0 0 5px silver;*/
		}

		span.cadence-plisting-loginicon {
			font-family: "FontAwesome";
			margin-right: 10px;
		}

		div.cadence-plisting-entry.special {
			height: 80px;
			width: 120px;
			background: none;
			border: none;
			box-shadow: none;
			margin-top: 5px;
			margin-bottom: 5px;
		}

		div.cadence-plisting-entry.more {
			height: 60px;
			width: 150px;
			background: transparent;
			border: none;
			margin-top: 10px;
			box-shadow: none;
		}

		div.cadence-plisting-icon {
			border-bottom: 1px solid #ddd;
			font-family: "FontAwesome";
			font-size: 60px;
			/*background: #d0f0f5;*/
			cursor: pointer;
			text-align: center;
			padding-top: 10px;
			padding-bottom: 10px;
			height: 95px;
		}

		div.cadence-plisting-img {
			border-bottom: 1px solid #ddd;
			background: white;
			cursor: pointer;
			text-align: center;
			/*height: 112;*/
			overflow: hidden;
			display: flex;
		}

		div.cadence-plisting-icon.special {
			background: none;
			height: 40px;
			font-size: 60px;
			border: none;
			color: white;
			text-shadow: 10px 10px 10px #111;
		}

		div.cadence-plisting-icon.more {
			background: transparent;
			height: 40px;
			font-size: 40px;
			color: #eee;
			border: none;
			font-weight: bold;
		}


		div.cadence-plisting-title {
			font-weight: bold;
			font-family: "Source Sans Pro",Arial,sans-serif;
			font-size: 14px;
			line-height: 16px;
			padding-left: 2px;
			margin-top: 8px;
		}

		div.cadence-plisting-subtitle {
			font-family: "Source Sans Pro",Arial,sans-serif;
			font-size: 12px;
			line-height: 16px;
			padding-left: 2px;
			color: #666;
		}

		div.cadence-plisting-entry:hover {
			color: #29454B;
		}

		div.cadence-plisting-entry:hover .cadence-plisting-icon {
			border-color: #222;
			/*background-color: white;*/
		}

		div.cadence-plisting-entry.special:hover .cadence-plisting-icon {
			background-color: none;
			color: #ddd;
		}

		div.cadence-plisting-entry.more:hover .cadence-plisting-icon {
			color: white;
			background: transparent;
		}

		div.cadence-plisting-entry:hover .cadence-plisting-img {
			border-color: #222;
			background-color: white;
		}

		div.importdialog {
			position: absolute;
			top: 65px;
			right: 150px;
			width: 400px;
			height: 200px;
			background: #f5f5f5;
			border-bottom-left-radius: 6px;
			border-bottom-right-radius: 6px;
			box-shadow: 0 0 15px #4a6887;
			font-size: 12pt;
			color: black;
		}

		span.importdialog-icon {
			font-family: "FontAwesome";
			margin-right: 20px;
		}

		div.importdialog-title {
			font-size: 16pt;
			font-weight: bold;
			margin-top: 20px;
			margin-left: 20px;
			color: #666;
		}

		div.importdialog-content {
			margin: 20px;
			color: black;
		}

		input.projectsearch {
			width: 300px;
			background: #132023;
			color: white;
			font-size: 10pt;
			padding: 8px;
			padding-left: 40px;
			border: 2px solid #eee;
		}

		div.projectsearch:before {
			color: white;
			font-size: 16pt;
			/*left: -285px;*/
			top: 3px;
		}

	</style>

	<script type="text/javascript" src="js/lib/jquery.dialogextend.min.js"></script>
	<script src="http://cdn.peerjs.com/0.3/peer.min.js"></script>
	<script src="js/lib/showdown.min.js"></script>
</head>
<body>

<script src="js/lib/jquery.color.js"></script>
<script src="js/lib/jquery.hotkeys.js"></script>
<script src="js/lib/json2.js"></script>
<script src="js/lib/diff_match_patch.js"></script>
<script src="js/core/jseden.min.js"></script>
<script src="js/ui/jseden-ui.min.js"></script>
<script src="js/core/engine.js"></script>
<script src="js/dummyconsole.js"></script>
<script src="js/arrayCompareFix.js"></script>
<script src="plugins/jseden-plugins.min.js"></script>

<script type="text/javascript">
	var projects;

	$(".loadmodal").show();
	Construit(undefined, function(loaded) {
		// Place to record projects by tag.
		Eden.projecttags = {};
		var cachedprojects;
		var maxres = URLUtil.getParameterByName("max");
		var searchstr = "";
		maxres = (maxres && maxres != "") ? parseInt(maxres) : undefined;

		$(".loadmodal").hide();
		if (!loaded) {
			var q = URLUtil.getParameterByName("q");
			var lopts = $("#loadoptions");

			function updateSearch() {
				var plist = lopts.find("#jseden-public-projects");

				//console.log("Load projects: " + path);

				Eden.DB.search(searchstr, function(data) {
					console.log("SEARCH",searchstr,data);
					var pliste = plist.get(0);
					while (pliste.lastChild) pliste.removeChild(pliste.lastChild);
					EdenUI.ProjectDetails._searchProjects(plist, true, data);
				});
			}

			Eden.Project.listenTo("load", this, function() {
				lopts.css("display","none");
			});

			lopts.css("display","block");
			lopts.on("click","#restoreold",function() {
				Eden.Project.restore();
				lopts.css("display","none");
			})
			.on("click","#loadnew",function() {
				Eden.Project.newFromExisting("NewProject");
				lopts.css("display","none");
			})
			.on("click","#importfile",function() {
				//Eden.loadFromURL("library2/NewProject.js-e");
				lopts.css("display","none");
				var importfile = $("#importdialog");
				importfile.css("display","block");

				importfile.on("click","#closeimport",function() {
					importfile.css("display","none");
					lopts.css("display","block");
				})
				.on("click","#openfile",function() {
					var fileinput = $("#theimportfile").get(0);
					var file = fileinput.files[0];
					var filename = file.name;
					filename = filename.substring(0,filename.lastIndexOf("."));
					filename = filename.replace(/\([0-9]+\)/,"");
					console.log("FILE",file);
					var reader = new FileReader();
					reader.onload = function(e) {
						//Eden.loadFromString(e.target.result);
						eden.project = new Eden.Project(undefined, filename, e.target.result.replace(/\r/g,""));
						eden.project.start();
						importfile.css("display","none");
					};
					reader.readAsText(file);
				});
			})
			.on("click","#plist-login", function() {
				if (Eden.DB.isConnected()) {
					lopts.find("#jseden-private-projects").html("<div style=\"background: white; padding: 10px; border-radius: 5px;\"><div class=\"menubar-sharebox-title\"><span class=\"menubar-shareicon\">&#xf090;</span>Login</div><iframe frameborder=\"0\" src=\""+Eden.DB.remoteURL+"/login"+"\" name=\"logintarget\" width=\"250\" height=\"200\" class=\"menubar-login-iframe\"></iframe></div>");
				}
			})
			.on("keyup",".search", function(e) {
				searchstr = e.currentTarget.value;
				updateSearch();
			})
			.on("click",".project",function(e) {
				var pid = e.currentTarget.getAttribute("data-pid");
				//var tag = parseInt(e.currentTarget.getAttribute("data-tag"));
				console.log("Load project: " + pid); // + "@"+tag);
				//lopts.css("display","none");
				//$(".loadmodal").show();
				//$(".loadmessage").html("Loading " + "" + "...");

				//Eden.load(path,tag,function() {

				//Eden.Project.load(pid, undefined, function() {
				//	$(".loadmodal").hide();
				//});

				projectdetails = new EdenUI.ProjectDetails(pid);

				//});
			});

			function setLoadObserver() {
				eden.root.lookup("_jseden_loaded").addJSObserver("hideProjects", function(sym, value) {
					if (value) {
						lopts.css("display","none");
						$(".loadmessage").html("Loading...");
						$(".loadmodal").hide();
					}
				});
			}
			setLoadObserver();

			window.addEventListener("popstate", function(e) {
				if (!e.state) {
					Eden.reset();
					setLoadObserver();
					lopts.css("display","block");
				} else {
					lopts.css("display","none");
				}
			});



			function displayProjects(id, query, cb) {
				var plist = lopts.find("#jseden-"+id+"-projects");
				EdenUI.ProjectDetails.searchProjects(plist, query, 6, cb);
			}

			if (Eden.DB.isConnected()) {
				if (q && q != "") {
					//searchstr = q;
					//updateSearch();
					//displayProjects(true, function() {
						//updateSearch(q);
					//});
					lopts.find(".searchouter").remove();
					var content = lopts.find(".project-content");
					//content[0].removeChild(content[0].firstChild);
					var newblock = $('<div class="jseden-project-cat">'+q+':</div>');
					var newres = $('<div id="jseden-custom-projects" class="jseden-dialog-plisting">');
					content.prepend(newres);
					content.prepend(newblock);
					EdenUI.ProjectDetails.searchProjects(newres, q, 6);
					displayProjects("featured", "#featured");
					displayProjects("recent");
				} else {
					displayProjects("featured", "#featured");
					displayProjects("recent");
				}
			} else {
				$("#project-browser").html('<div class="jseden-project-cat">Offline Examples:</div><div id="jseden-public-projects" class="jseden-dialog-plisting"></div>');
			}

			Eden.DB.listenTo("login", this, function(name) {
				var plist = lopts.find("#jseden-private-projects").get(0);
				if (!plist) return;
				var node = plist.firstChild;
				while (node) {
					var next = node.nextSibling;
					plist.removeChild(node);
					node = next;
				}

				displayProjects("private",":me");
			});

			Eden.DB.listenTo("logout", this, function() {
				var plist = lopts.find("#jseden-private-projects").get(0);
				if (!plist) return;
				var node = plist.firstChild;
				while (node) {
					var next = node.nextSibling;
					plist.removeChild(node);
					node = next;
				}

				//displayProjects(true);
			});
		}
	});
</script>

<div id="jseden-main">
<div id="jseden-views"></div>
</div>

<div class="loadmodal modal" style="display: block">
	<div class="loaddialog">
		<div class="mainloader">Loading...</div>
		<div class="loadmessage">Loading...</div>
	</div>
</div>

<div id="loadoptions" class="" style="display: none;">
	<div class="project-content" style="padding: 20px 0;">
		<div class="searchouter projectsearch"><input type="text" class="search projectsearch" placeholder="Search..."></input></div>
		<div class="jseden-dialog-plisting" style="padding: 10px">
			<div id="loadnew" class="cadence-plisting-entry noselect special"><div title="New blank project" class="cadence-plisting-icon special">&#xf067;</div></div>
			<div id="importfile" class="cadence-plisting-entry noselect special"><div title="Import a file" class="cadence-plisting-icon special">&#xf07c;</div></div>
			<div id="restoreold" class="cadence-plisting-entry noselect special"><div title="Restore last project" class="cadence-plisting-icon special">&#xf01e;</div></div>
		</div>
		<div id="project-browser">
			<div class="jseden-project-cat">Featured:</div>
			<div id="jseden-featured-projects" class="jseden-dialog-plisting">
			</div>
			<div class="jseden-project-cat">Recent:</div>
			<div id="jseden-recent-projects" class="jseden-dialog-plisting">
			</div>
			<div class="jseden-project-cat">Your Projects:</div>
			<div id="jseden-private-projects" class="jseden-dialog-plisting">
				<div id="plist-login" class="cadence-plisting-login"><span class="cadence-plisting-loginicon">&#xf090;</span>Login</div>
			</div>
		</div>
	</div>
</div>

<div id="importdialog" class="modal" style="display: none">
	<div class="modal-content" style="width: 300px;">
		<div class="importdialog-title"><span class="importdialog-icon">&#xf07c;</span>Import File</div>
		<div class="importdialog-content">
		<input id="theimportfile" type="file"></input><br/><br/>
		<div style="text-align: center; margin-top: 20px;"><button class="jseden" id="openfile">Import</button><button class="jseden" id="closeimport">Cancel</button></div>
		</div>
	</div>
</div>

<div id="tooltip" style="display:none"></div>
</body>
</html>
