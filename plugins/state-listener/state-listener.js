EdenUI.plugins.StateListener = function(edenUI, success){
	var me = this;
	var defaultview = "";

	this.html = function(name,content) {
	//This doesn't look like its ever being called
		if (name == "DEFAULT") {
			if (defaultview == "") {
				edenUI.createView(name,"StateListener");
			}
			$("#"+defaultview+"-content").html(content).onclick;
		} else {
			$("#"+name+"-dialog-content").html(content).onclick;
		}
	}
	
	this.createDialog = function(name,mtitle) {

		if (defaultview == "") {
			defaultview = name;
		}

		var viewData = {confirmClose: false};
		
		var slHTML = "<div class=\"sldiv\">" +
				"<div><label for=\"sl-ipaddr\">IP Address:</label><input type=\"text\" id=\"sl-ipaddr\" value=\"127.0.0.1\"></input></div>" +
				"<div><label for=\"sl-port\">Port:</label><input type=\"text\" id=\"sl-port\" value=\"8001\"></input></div>" +
				"<div><input type=\"button\" value=\"Connect\" id=\"connectBtn\"></input></div><p id=\"sl-status\"></p>";
		
		$dialog = $('<div id="'+name+'"></div>')
			.html(slHTML)
			.dialog(
				{
					title: mtitle,
					width: 300,
					height: 450,
					minHeight: 120,
					minWidth: 230
				}
			)
			
			$("#connectBtn").click(function(){
				window.WebSocket = window.WebSocket || window.MozWebSocket;
				 
				if (!window.WebSocket) {
					console.log("WebSockets not supported");
					return;
				}
				 
				// open connection
				var url = "ws://" + $("#sl-ipaddr").val() + ":" + $("#sl-port").val() + '/'; 
				var connection = new WebSocket(url);
				eden.listenTo('executeBegin',this,function(origin,code){
					if(origin != "net")
						connection.send(code);	
				});
				eden.listenTo('beforeAssign',this,function(symbol, value, origin){
					if (origin != "net") {
						connection.send(symbol.name.slice(1) + "=" + Eden.edenCodeForValue(value) + ";");
					}
				});
				$("#sl-status").html('<p>Connected to: ' + url + "</p>");
				
				connection.onerror = function (error) {
				// just in there were some problems with conenction...
					$("#sl-status").html('<p>Error connecting to server - please verify server is running at ' + url + ". For usage instructions please read the comments in the <a href='plugins/state-listener/state-listener-server.js'>state-listener-server.js</a> file.</p>");
					viewData.confirmClose = false;
				};
				 
				// most important part - incoming messages
				connection.onmessage = function (message) {
					$("#sl-status").html('<p>Received: ' + Eden.htmlEscape(message.data) + "</p>");
					eden.execute(message.data,"net","",{name:"/execute"},noop);
				};
				
				
				// Forces the current definition of an observable to be sent to the remote clients,
				// e.g. one defined before the connection was established.
				function pushSymbol(name) {
					var root = edenUI.eden.root;
					var currentDef = root.lookup("definitionOf").definition(root)(name);
					connection.send(currentDef);
				}

				connection.onopen = function () {
					viewData.confirmClose = true;
					//Make sure the pseudorandom numbers generated by different JS-EDEN instances
					//are the same.
					randomSeedSym = edenUI.eden.root.lookup("randomSeed");
					randomSeed = randomSeedSym.value();
					
					if (randomSeed === undefined) {
						randomSeedSym.assign((new Date()).getTime(), undefined, true);
					} else {
						pushSymbol("randomSeed");
					}
					pushSymbol("randomGenerator");
				};
				
			});
			
			return viewData;
	}
	
	
	//Register the HTML view options
	edenUI.views["StateListener"] = {dialog: this.createDialog, title: "State Listener", category: edenUI.viewCategories.extension};
	edenUI.eden.include("plugins/state-listener/state-listener.js-e", success);
};
/* Plugin meta information */
EdenUI.plugins.StateListener.title = "State Listener";
EdenUI.plugins.StateListener.description = "Provides the ability to synchronize observables over the internet.";
EdenUI.plugins.StateListener.author = "Jonny Foss";
