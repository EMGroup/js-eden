!function e(t,n,r){function a(s,o){if(!n[s]){if(!t[s]){var c="function"==typeof require&&require;if(!o&&c)return c(s,!0);if(i)return i(s,!0);var l=new Error("Cannot find module '"+s+"'");throw l.code="MODULE_NOT_FOUND",l}var h=n[s]={exports:{}};t[s][0].call(h.exports,function(e){var n=t[s][1][e];return a(n||e)},h,h.exports,e,t,n,r)}return n[s].exports}for(var i="function"==typeof require&&require,s=0;s<r.length;s++)a(r[s]);return a}({1:[function(e,t,n){var r=e("../parse/abc_common"),a=e("../parse/abc_parse_key_voice"),i=e("../write/abc_spacing");t.exports=function(){function e(e){for(var t,n,r,a,i=e.length-1;i>=0;i--){var s=e[i];"bar"===s.type?(s.top=r,s.nextTop=t,t=r,s.bottom=a,s.nextBottom=n,n=a):"event"===s.type&&(r=s.top,a=s.top+s.height)}}function t(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(e[n]);return t=t.sort(function(e,t){var n=e.seconds-t.seconds;return 0!==n?n:"bar"===e.type?-1:1})}this.getBeatLength=function(){for(var e=0;e<this.lines.length;e++)if(this.lines[e].staff)for(var t=0;t<this.lines[e].staff.length;t++)if(this.lines[e].staff[t].meter){var n=this.lines[e].staff[t].meter;if("specified"===n.type){if(n.value.length>0){var r=parseInt(n.value[0].num,10),a=parseInt(n.value[0].den,10);return 6===r&&8===a?3/8:9===r&&8===a?3/8:12===r&&8===a?3/8:1/a}return null}return"cut_time"===n.type?.5:.25}return null},this.reset=function(){this.version="1.0.1",this.media="screen",this.metaText={},this.formatting={},this.lines=[],this.staffNum=0,this.voiceNum=0,this.lineNum=0},this.cleanUp=function(e,t,n,i,s){function o(e){a.fixClef(e)}this.closeLine();var c,l,h,u=!1;for(c=0;c<this.lines.length;c++)if(void 0!==this.lines[c].staff){var f=!1;for(l=0;l<this.lines[c].staff.length;l++)if(void 0===this.lines[c].staff[l])u=!0,this.lines[c].staff[l]=null;else for(h=0;h<this.lines[c].staff[l].voices.length;h++)void 0===this.lines[c].staff[l].voices[h]?this.lines[c].staff[l].voices[h]=[]:this.containsNotes(this.lines[c].staff[l].voices[h])&&(f=!0);f||(this.lines[c]=null,u=!0)}if(u&&(this.lines=r.compact(this.lines),r.each(this.lines,function(e){e.staff&&(e.staff=r.compact(e.staff))})),n)for(c=0;c<this.lines.length;c++)if(void 0!==this.lines[c].staff)for(l=0;l<this.lines[c].staff.length;l++)for(h=0;h<this.lines[c].staff[l].voices.length;h++)for(var d=0,p=0;p<this.lines[c].staff[l].voices[h].length;p++)if("bar"===this.lines[c].staff[l].voices[h][p].el_type&&++d>=n&&p<this.lines[c].staff[l].voices[h].length-1){if(c===this.lines.length-1){var m=JSON.parse(JSON.stringify(this.lines[c]));this.lines.push(r.clone(m));for(var g=0;g<this.lines[c+1].staff.length;g++)for(var v=0;v<this.lines[c+1].staff[g].voices.length;v++)this.lines[c+1].staff[g].voices[v]=[]}var b=p+1,k=this.lines[c].staff[l].voices[h].slice(b);this.lines[c].staff[l].voices[h]=this.lines[c].staff[l].voices[h].slice(0,b),this.lines[c+1].staff[l].voices[h]=k.concat(this.lines[c+1].staff[l].voices[h])}if(n){for(u=!1,c=0;c<this.lines.length;c++)if(void 0!==this.lines[c].staff)for(l=0;l<this.lines[c].staff.length;l++){var y=!1;for(h=0;h<this.lines[c].staff[l].voices.length;h++)this.containsNotesStrict(this.lines[c].staff[l].voices[h])&&(y=!0);y||(u=!0,this.lines[c].staff[l]=null)}u&&r.each(this.lines,function(e){e.staff&&(e.staff=r.compact(e.staff))})}for(c=0;c<this.lines.length;c++)if(this.lines[c].staff)for(l=0;l<this.lines[c].staff.length;l++)delete this.lines[c].staff[l].workingClef;for(this.lineNum=0;this.lineNum<this.lines.length;this.lineNum++){var _=this.lines[this.lineNum].staff;if(_)for(this.staffNum=0;this.staffNum<_.length;this.staffNum++)for(_[this.staffNum].clef&&o(_[this.staffNum].clef),this.voiceNum=0;this.voiceNum<_[this.staffNum].voices.length;this.voiceNum++){var w=_[this.staffNum].voices[this.voiceNum];!function(e){for(var t,n=function(e,n,a){if(void 0===s[a]){for(t=0;t<s.length;t++)if(void 0!==s[t]){a=t;break}if(void 0===s[a]){var i=100*a+1;r.each(e.endSlur,function(e){i===e&&--i}),s[a]=[i]}}for(var o,c=0;c<n;c++)o=s[a].pop(),e.endSlur.push(o);return 0===s[a].length&&delete s[a],o},a=function(e,t,n,a){e.startSlur=[],void 0===s[n]&&(s[n]=[]);for(var i=100*n+1,o=0;o<t;o++)a&&(r.each(a,function(e){i===e&&++i}),r.each(a,function(e){i===e&&++i}),r.each(a,function(e){i===e&&++i})),r.each(s[n],function(e){i===e&&++i}),r.each(s[n],function(e){i===e&&++i}),s[n].push(i),e.startSlur.push({label:i}),i++},i=0;i<e.length;i++){var o=e[i];if("note"===o.el_type){if(o.gracenotes)for(var c=0;c<o.gracenotes.length;c++){if(o.gracenotes[c].endSlur){var l=o.gracenotes[c].endSlur;o.gracenotes[c].endSlur=[];for(var h=0;h<l;h++)n(o.gracenotes[c],1,20)}o.gracenotes[c].startSlur&&(t=o.gracenotes[c].startSlur,a(o.gracenotes[c],t,20))}if(o.endSlur&&(t=o.endSlur,o.endSlur=[],n(o,t,0)),o.startSlur&&a(o,t=o.startSlur,0),o.pitches){for(var u=[],f=0;f<o.pitches.length;f++)if(o.pitches[f].endSlur){var d=o.pitches[f].endSlur;o.pitches[f].endSlur=[];for(var p=0;p<d;p++){var m=n(o.pitches[f],1,f+1);u.push(m)}}for(f=0;f<o.pitches.length;f++)o.pitches[f].startSlur&&(t=o.pitches[f].startSlur,a(o.pitches[f],t,f+1,u));o.gracenotes&&o.pitches[0].endSlur&&100===o.pitches[0].endSlur[0]&&o.pitches[0].startSlur&&(o.gracenotes[0].endSlur?o.gracenotes[0].endSlur.push(o.pitches[0].startSlur[0].label):o.gracenotes[0].endSlur=[o.pitches[0].startSlur[0].label],1===o.pitches[0].endSlur.length?delete o.pitches[0].endSlur:100===o.pitches[0].endSlur[0]?o.pitches[0].endSlur.shift():100===o.pitches[0].endSlur[o.pitches[0].endSlur.length-1]&&o.pitches[0].endSlur.pop(),1===s[1].length?delete s[1]:s[1].pop())}}}}(w);for(var x=0;x<w.length;x++)"clef"===w[x].el_type&&o(w[x]);if(w.length>0&&w[w.length-1].barNumber){var N=function(e,t){for(t++;e.length>t;){if(e[t].staff)return e[t];t++}return null}(this.lines,this.lineNum);N&&(N.staff[0].barNumber=w[w.length-1].barNumber),delete w[w.length-1].barNumber}}}return this.formatting.pagewidth||(this.formatting.pagewidth=e),this.formatting.pageheight||(this.formatting.pageheight=t),delete this.staffNum,delete this.voiceNum,delete this.lineNum,delete this.potentialStartBeam,delete this.potentialEndBeam,delete this.vskipPending,s},this.reset(),this.getLastNote=function(){if(this.lines[this.lineNum]&&this.lines[this.lineNum].staff&&this.lines[this.lineNum].staff[this.staffNum]&&this.lines[this.lineNum].staff[this.staffNum].voices[this.voiceNum])for(var e=this.lines[this.lineNum].staff[this.staffNum].voices[this.voiceNum].length-1;e>=0;e--){var t=this.lines[this.lineNum].staff[this.staffNum].voices[this.voiceNum][e];if("note"===t.el_type)return t}return null},this.addTieToLastNote=function(){var e=this.getLastNote();return!!(e&&e.pitches&&e.pitches.length>0)&&(e.pitches[0].startTie={},!0)},this.getDuration=function(e){return e.duration?e.duration:0},this.closeLine=function(){this.potentialStartBeam&&this.potentialEndBeam&&(this.potentialStartBeam.startBeam=!0,this.potentialEndBeam.endBeam=!0),delete this.potentialStartBeam,delete this.potentialEndBeam},this.appendElement=function(e,t,n,a){var i=this;a.el_type=e,null!==t&&(a.startChar=t),null!==n&&(a.endChar=n);var s=function(){void 0!==i.potentialStartBeam&&void 0!==i.potentialEndBeam&&(i.potentialStartBeam.startBeam=!0,i.potentialEndBeam.endBeam=!0),delete i.potentialStartBeam,delete i.potentialEndBeam};"note"===e?i.getDuration(a)>=.25?s():a.force_end_beam_last&&void 0!==i.potentialStartBeam?s():a.end_beam&&void 0!==i.potentialStartBeam?void 0===a.rest?(i.potentialStartBeam.startBeam=!0,a.endBeam=!0,delete i.potentialStartBeam,delete i.potentialEndBeam):s():void 0===a.rest&&(void 0===i.potentialStartBeam?a.end_beam||(i.potentialStartBeam=a,delete i.potentialEndBeam):i.potentialEndBeam=a):s(),delete a.end_beam,delete a.force_end_beam_last,function(e){if(void 0!==e.pitches){var t=i.lines[i.lineNum].staff[i.staffNum].workingClef.verticalPos;r.each(e.pitches,function(e){e.verticalPos=e.pitch-t})}if(void 0!==e.gracenotes){var n=i.lines[i.lineNum].staff[i.staffNum].workingClef.verticalPos;r.each(e.gracenotes,function(e){e.verticalPos=e.pitch-n})}i.lines[i.lineNum].staff[i.staffNum].voices[i.voiceNum].push(e)}(a)},this.appendStartingElement=function(e,t,n,a){this.closeLine();var i;"key"===e&&(i=a.impliedNaturals,delete a.impliedNaturals);var s=r.clone(a);if(this.lines[this.lineNum].staff){"clef"===e&&(this.lines[this.lineNum].staff[this.staffNum].workingClef=s),this.lines[this.lineNum].staff.length<=this.staffNum&&(this.lines[this.lineNum].staff[this.staffNum]={},this.lines[this.lineNum].staff[this.staffNum].clef=r.clone(this.lines[this.lineNum].staff[0].clef),this.lines[this.lineNum].staff[this.staffNum].key=r.clone(this.lines[this.lineNum].staff[0].key),this.lines[this.lineNum].staff[0].meter&&(this.lines[this.lineNum].staff[this.staffNum].meter=r.clone(this.lines[this.lineNum].staff[0].meter)),this.lines[this.lineNum].staff[this.staffNum].workingClef=r.clone(this.lines[this.lineNum].staff[0].workingClef),this.lines[this.lineNum].staff[this.staffNum].voices=[[]]);for(var o=this.lines[this.lineNum].staff[this.staffNum].voices[this.voiceNum],c=0;c<o.length;c++){if("note"===o[c].el_type||"bar"===o[c].el_type)return s.el_type=e,s.startChar=t,s.endChar=n,i&&(s.accidentals=i.concat(s.accidentals)),void o.push(s);if(o[c].el_type===e)return s.el_type=e,s.startChar=t,s.endChar=n,i&&(s.accidentals=i.concat(s.accidentals)),void(o[c]=s)}this.lines[this.lineNum].staff[this.staffNum][e]=a}},this.getNumLines=function(){return this.lines.length},this.pushLine=function(e){this.vskipPending&&(e.vskip=this.vskipPending,delete this.vskipPending),this.lines.push(e)},this.addSubtitle=function(e){this.pushLine({subtitle:e})},this.addSpacing=function(e){this.vskipPending=e},this.addNewPage=function(e){this.pushLine({newpage:e})},this.addSeparator=function(e,t,n){this.pushLine({separator:{spaceAbove:e,spaceBelow:t,lineLength:n}})},this.addText=function(e){this.pushLine({text:e})},this.addCentered=function(e){this.pushLine({text:[{text:e,center:!0}]})},this.containsNotes=function(e){for(var t=0;t<e.length;t++)if("note"===e[t].el_type||"bar"===e[t].el_type)return!0;return!1},this.containsNotesStrict=function(e){for(var t=0;t<e.length;t++)if("note"===e[t].el_type&&void 0===e[t].rest)return!0;return!1},this.startNewLine=function(e){var t=this;this.closeLine();var n=function(e){if(t.lines[t.lineNum].staff[t.staffNum].voices[t.voiceNum]=[],t.isFirstLine(t.lineNum)?e.name&&(t.lines[t.lineNum].staff[t.staffNum].title||(t.lines[t.lineNum].staff[t.staffNum].title=[]),t.lines[t.lineNum].staff[t.staffNum].title[t.voiceNum]=e.name):e.subname&&(t.lines[t.lineNum].staff[t.staffNum].title||(t.lines[t.lineNum].staff[t.staffNum].title=[]),t.lines[t.lineNum].staff[t.staffNum].title[t.voiceNum]=e.subname),e.style&&t.appendElement("style",null,null,{head:e.style}),e.stem)t.appendElement("stem",null,null,{direction:e.stem});else if(t.voiceNum>0){if(void 0!==t.lines[t.lineNum].staff[t.staffNum].voices[0]){for(var n=!1,r=0;r<t.lines[t.lineNum].staff[t.staffNum].voices[0].length;r++)"stem"===t.lines[t.lineNum].staff[t.staffNum].voices[0].el_type&&(n=!0);if(!n){var a={el_type:"stem",direction:"up"};t.lines[t.lineNum].staff[t.staffNum].voices[0].splice(0,0,a)}}t.appendElement("stem",null,null,{direction:"down"})}e.scale&&t.appendElement("scale",null,null,{size:e.scale})},r=function(e){t.lines[t.lineNum].staff[t.staffNum]={voices:[],clef:e.clef,key:e.key,workingClef:e.clef},e.vocalfont&&(t.lines[t.lineNum].staff[t.staffNum].vocalfont=e.vocalfont),e.bracket&&(t.lines[t.lineNum].staff[t.staffNum].bracket=e.bracket),e.brace&&(t.lines[t.lineNum].staff[t.staffNum].brace=e.brace),e.connectBarLines&&(t.lines[t.lineNum].staff[t.staffNum].connectBarLines=e.connectBarLines),e.barNumber&&(t.lines[t.lineNum].staff[t.staffNum].barNumber=e.barNumber),n(e),e.part&&t.appendElement("part",e.startChar,e.endChar,{title:e.part}),void 0!==e.meter&&(t.lines[t.lineNum].staff[t.staffNum].meter=e.meter)};if(void 0===this.lines[this.lineNum])!function(e){t.lines[t.lineNum]={staff:[]},r(e)}(e);else if(void 0===this.lines[this.lineNum].staff)this.lineNum++,this.startNewLine(e);else if(void 0===this.lines[this.lineNum].staff[this.staffNum])r(e);else if(void 0===this.lines[this.lineNum].staff[this.staffNum].voices[this.voiceNum])n(e);else{if(!this.containsNotes(this.lines[this.lineNum].staff[this.staffNum].voices[this.voiceNum]))return;this.lineNum++,this.startNewLine(e)}},this.hasBeginMusic=function(){for(var e=0;e<this.lines.length;e++)if(this.lines[e].staff)return!0;return!1},this.isFirstLine=function(e){for(var t=e-1;t>=0;t--)if(void 0!==this.lines[t].staff)return!1;return!0},this.getMeter=function(){for(var e=0;e<this.lines.length;e++){var t=this.lines[e];if(t.staff)for(var n=0;n<t.staff.length;n++){var r=t.staff[n].meter;if(r)return r}}return{type:"common_time"}},this.getCurrentVoice=function(){return void 0!==this.lines[this.lineNum]&&void 0!==this.lines[this.lineNum].staff[this.staffNum]&&void 0!==this.lines[this.lineNum].staff[this.staffNum].voices[this.voiceNum]?this.lines[this.lineNum].staff[this.staffNum].voices[this.voiceNum]:null},this.setCurrentVoice=function(e,t){this.staffNum=e,this.voiceNum=t;for(var n=0;n<this.lines.length;n++)if(this.lines[n].staff&&(void 0===this.lines[n].staff[e]||void 0===this.lines[n].staff[e].voices[t]||!this.containsNotes(this.lines[n].staff[e].voices[t])))return void(this.lineNum=n);this.lineNum=n},this.addMetaText=function(e,t){void 0===this.metaText[e]?this.metaText[e]=t:this.metaText[e]+="\n"+t},this.addMetaTextArray=function(e,t){void 0===this.metaText[e]?this.metaText[e]=[t]:this.metaText[e].push(t)},this.addMetaTextObj=function(e,t){this.metaText[e]=t},this.setupEvents=function(n,r){for(var a=[],s={},o=n,c=!1,l=0;l<this.engraver.staffgroups.length;l++){for(var h=this.engraver.staffgroups[l],u=h.voices,f=h.staffs[0],d=f.absoluteY,p=d-f.top*i.STEP,m=h.staffs[h.staffs.length-1],g=(d=m.absoluteY)-m.bottom*i.STEP-p,v=0,b=0;b<u.length;b++){for(var k=o,y=u[b].children,_=0;_<y.length;_++){var w=y[_];if(w.hint)break;if(w.duration>0){var x=w.startTie;c?x||(c=!1):(s["event"+k]?(s["event"+k].left=Math.min(s["event"+k].left,w.x),s["event"+k].elements.push(w.elemset)):s["event"+k]={type:"event",seconds:k,top:p,height:g,left:w.x,width:w.w,elements:[w.elemset]},x&&(c=!0)),k+=w.duration/r}}v=Math.max(v,k)}o=v}return a=t(s),e(a),a},this.setTiming=function(e,t){var n=this.getMeter();this.barTimings=[];var r,a=this.getBeatLength(),i=e/60;switch(n.type){case"common_time":r=1,this.meter={num:4,den:4};break;case"cut_time":r=1,this.meter={num:2,den:2};break;default:r=n.value[0].num/n.value[0].den,this.meter={num:n.value[0].num,den:n.value[0].den}}var s=r/a*t/i,o=a*i;this.noteTimings=this.setupEvents(s,o)}}},{"../parse/abc_common":7,"../parse/abc_parse_key_voice":11,"../write/abc_spacing":13}],2:[function(e,t,n){var r,a=e("./abc_midi_flattener"),i=e("./abc_midi_js_preparer"),s=e("./abc_midi_renderer"),o=e("./abc_midi_sequencer");!function(){"use strict";function e(e){return 60+e}r=function(t,n){void 0===n&&(n={});var r=o(t,n),c=a(r,n),l=s(),h=new i,u=t.metaText?t.metaText.title:void 0;u&&u.length>128&&(u=u.substring(0,124)+"..."),l.setGlobalInfo(c.tempo,u),h.setGlobalInfo(c.tempo,u),void 0!==c.instrument&&(l.setInstrument(c.instrument),h.setInstrument(c.instrument)),void 0!==c.channel&&(l.setChannel(c.channel),h.setChannel(c.channel));for(var f=0;f<c.tracks.length;f++){l.startTrack(),h.startTrack();for(var d=0;d<c.tracks[f].length;d++){var p=c.tracks[f][d];switch(p.cmd){case"instrument":l.setInstrument(p.instrument),h.setInstrument(p.instrument);break;case"channel":l.setChannel(p.channel),h.setChannel(p.channel);break;case"start":l.startNote(e(p.pitch),p.volume),h.startNote(e(p.pitch),p.volume);break;case"stop":l.endNote(e(p.pitch),0),h.endNote(e(p.pitch));break;case"move":l.addRest(1920*p.duration),h.addRest(1920*p.duration);break;default:console.log("MIDI create Unknown: "+p.cmd)}}l.endTrack(),h.endTrack()}var m=l.getData(),g=h.getData();return void 0===n.generateInline&&(n.generateInline=!0),n.generateInline&&n.generateDownload?{download:m,inline:g}:n.generateInline?g:m}}(),t.exports=r},{"./abc_midi_flattener":3,"./abc_midi_js_preparer":4,"./abc_midi_renderer":5,"./abc_midi_sequencer":6}],3:[function(e,t,n){var r;!function(){"use strict";function e(e){if(B||!e.chord||0===e.chord.length)return null;for(var t=0;t<e.chord.length;t++){var n=e.chord[t];if("default"===n.position)return n.name;if(G.indexOf(n.name.toLowerCase())>=0)return"break"}return null}function t(){for(var e=0,t=0;t<S.length;t++)"move"===S[t].cmd&&(e+=S[t].duration);return e}function n(n,r){var i=r?0:64,c=e(n);if(c){var l=h(c);if(l){if(0===I.length){I.push({cmd:"instrument",instrument:0});var u=t();u>0&&I.push({cmd:"move",duration:u*V})}D=l,M.push({chord:D,beat:F})}}n.startTriplet&&(w=2===n.startTriplet?1.5:(n.startTriplet-1)/n.startTriplet);var f=n.duration*w;F+=f;var d;if(n.gracenotes){var p=_||P<0||0===S.length,m=p?f:S[P].duration;d=s(n.gracenotes,m),_||(f=o(d,p,f,null,i))}if(n.pitches){d&&_&&(f=o(d,!0,f,null,i));for(var g=[],v=0;v<n.pitches.length;v++){var b=n.pitches[v],k=a(b);g.push({pitch:k,startTie:b.startTie}),C[""+k]||S.push({cmd:"start",pitch:k,volume:i}),b.startTie?C[""+k]=!0:b.endTie&&(C[""+k]=!1)}S.push({cmd:"move",duration:(f-q)*V}),P=S.length-1;for(var y=0;y<g.length;y++)C[""+g[y].pitch]||S.push({cmd:"stop",pitch:g[y].pitch});S.push({cmd:"move",duration:q*V})}else n.rest&&S.push({cmd:"move",duration:f*V});n.endTriplet&&(w=1)}function a(e){var t=e.pitch;if(e.accidental)switch(e.accidental){case"sharp":b[t]=1;break;case"flat":b[t]=-1;break;case"natural":b[t]=0;break;case"dblsharp":b[t]=2;break;case"dblflat":b[t]=-2}var n=12*c(t)+U[l(t)];return void 0!==b[t]?n+=b[t]:n+=k[l(t)],n+=y}function i(e){var t=[0,0,0,0,0,0,0];if(!e.accidentals)return t;for(var n=0;n<e.accidentals.length;n++){var r=e.accidentals[n],a="sharp"===r.acc?1:"natural"===r.acc?0:-1;t[l(r.note.toLowerCase().charCodeAt(0)-"c".charCodeAt(0))]+=a}return t}function s(e,t){for(var n,r=0,a=[],i=0;i<e.length;i++)r+=(n=e[i]).duration;var s=2*(r/=H)>t?t/(2*r):1;for(i=0;i<e.length;i++)n=e[i],a.push({pitch:n.pitch,duration:n.duration/H*s});return a}function o(e,t,n,r,i){for(var s=0;s<e.length;s++){var o=a(e[s]);o!==r&&S.push({cmd:"start",pitch:o,volume:i}),S.push({cmd:"move",duration:e[s].duration*V}),o!==r&&S.push({cmd:"stop",pitch:o}),t||(S[P].duration-=e[s].duration),n-=e[s].duration}return n}function c(e){return Math.floor(e/7)}function l(e){return(e%=7)<0&&(e+=7),e}function h(e){if(0!==e.length){if("break"===e)return{chick:[]};var t=e.substring(0,1);if("("===t){if(0===(e=e.substring(1,e.length-2)).length)return;t=e.substring(0,1)}var n=K[t];if(n){var r,a=(n+=y)-5;1===e.length&&(r=u(n,""));var i=e.substring(1),s=i.substring(0,1);"b"===s||"♭"===s?(n--,a--,i=i.substring(1)):"#"!==s&&"♯"!==s||(n++,a++,i=i.substring(1));var o=i.split("/");return r=u(n,o[0]),2===o.length&&K[o[1]]&&(a=n=K[o[1]]+y),{boom:n,boom2:a,chick:r}}}}function u(e,t){var n=R[t];n||(n=R.M),e+=12;for(var r=[],a=0;a<n.length;a++)r.push(e+n[a]);return r}function f(e,t){void 0!==e&&I.push({cmd:"start",pitch:e,volume:64}),I.push({cmd:"move",duration:t/2*V}),void 0!==e&&I.push({cmd:"stop",pitch:e}),I.push({cmd:"move",duration:t/2*V})}function d(e,t){for(var n=0;n<e.length;n++)I.push({cmd:"start",pitch:e[n],volume:48});for(I.push({cmd:"move",duration:t/2*V}),n=0;n<e.length;n++)I.push({cmd:"stop",pitch:e[n]});I.push({cmd:"move",duration:t/2*V})}function p(){var e=z.num,t=z.den,n=1/t,r=j[e+"/"+t],a=parseInt(e,10)/parseInt(t,10),i=Math.abs(a-F);if(!r||i>.0078125){r=[];for(var s=F/n,o=0;o<s;o++)r.push("chick")}if(0===M.length&&M.push({beat:0,chord:D}),0!==M[0].beat&&D&&M.unshift({beat:0,chord:D}),1!==M.length){for(var c={},l=0;l<M.length;l++){var h=M[l];c[""+Math.floor(h.beat/n)]=h}for(var u=0;u<r.length;u++){var p;switch(c[""+u]&&(p=c[""+u]),r[u]){case"boom":c[""+(u+1)]?d(p.chord.chick,n):f(p.chord.boom,n);break;case"boom2":c[""+(u+1)]?d(p.chord.chick,n):f(p.chord.boom2,n);break;case"chick":d(p.chord.chick,n);break;case"":c[""+u]?d(p.chord.chick,n):I.push({cmd:"move",duration:n*V})}}}else for(var m=0;m<r.length;m++)switch(r[m]){case"boom":f(M[0].chord.boom,n);break;case"boom2":f(M[0].chord.boom2,n);break;case"chick":d(M[0].chord.chick,n);break;case"":I.push({cmd:"move",duration:n*V})}}function m(e){if(0===e.pattern.length||!1===e.on)return{on:!1};for(var t=e.pattern[0],n=[],r="",a=0,i=0;i<t.length;i++)if("d"===t[i]&&a++,"d"===t[i]||"z"===t[i])0!==r.length?(n.push(r),r=t[i]):r+=t[i];else{if(0===r.length)return{on:!1};r+=t[i]}if(0!==r.length&&n.push(r),e.pattern.length!==2*a+1)return{on:!1};for(var s={on:!0,bars:e.bars,pattern:[]},o=1/z.den,c=0,l=0;l<n.length;l++){r=n[l];for(var h=1,u=!1,f=0,d=1;d<r.length;d++)switch(r[d]){case"/":0!==f&&(h*=f),f=0,u=!0;break;case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":f=10*f+r[d];break;default:return{on:!1}}u?(0===f&&(f=2),h/=f):f&&(h*=f),"d"===r[0]?(s.pattern.push({len:h*o,pitch:e.pattern[1+c],velocity:e.pattern[1+c+a]}),c++):s.pattern.push({len:h*o,pitch:null})}for(var p=0,m=z.num/z.den,g=0;g<s.pattern.length;g++)p+=s.pattern[g].len;var v=p/(e.bars?e.bars:1)/m;for(g=0;g<s.pattern.length;g++)s.pattern[g].len=s.pattern[g].len/v;return s}function g(e,t,n){L.push({cmd:"start",pitch:e-60,volume:n}),L.push({cmd:"move",duration:t}),L.push({cmd:"stop",pitch:e-60})}function v(){if(0!==L.length||W.on){var e=z.num/z.den;if(0===L.length){L.push({cmd:"channel",channel:10}),L.push({cmd:"instrument",instrument:10});var n=t();if(n>0&&n<e-.01)return void L.push({cmd:"move",duration:n*V})}if(W.on)for(var r=0;r<W.pattern.length;r++){var a=W.pattern[r].len*V;W.pattern[r].pitch?g(W.pattern[r].pitch,a,W.pattern[r].velocity):L.push({cmd:"move",duration:a})}else L.push({cmd:"move",duration:e*V})}}var b,k,y,_,w,x,N,A,T,E,S,C,P,I,B,M,D,F,L,O,V=1,z={num:4,den:4},W={},q=1/128;r=function(e,t){t||(t={}),b=[],k=[0,0,0,0,0,0,0],_=!1,w=1,x=[],N=void 0,A=void 0,V=1,T=void 0,E=void 0,S=void 0,C={},z={num:4,den:4},I=[],B=!1,M=[],D=void 0,F=0,L=[],O=!1,W={};for(var r=0;r<e.length;r++){y=0,P=-1;var a=e[r];S=[],C={};for(var s=0;s<a.length;s++){var o=a[s];switch(o.el_type){case"note":n(o,t.voicesOff);break;case"key":k=i(o);break;case"meter":A||(A=o),z=o;break;case"tempo":N?V=o.qpm?N/o.qpm:1:N=o.qpm;break;case"transpose":y=o.transpose;break;case"bar":I.length>0&&(p(),M=[]),F=0,b=[],0===r&&v();break;case"bagpipes":_=!0;break;case"instrument":T=o.program;break;case"channel":E=o.channel;break;case"drum":W=m(o.params);break;default:console.log("MIDI creation. Unknown el_type: "+o.el_type+"\n")}}x.push(S),I.length>0&&(B=!0),L.length>0&&(O=!0)}I.length>0&&x.push(I),L.length>0&&x.push(L);var c=A?parseInt(A.num,10):z.num,l=A?parseInt(A.den,10):z.den;return 2===l?N*=2:8===l?parseInt(c,10)%3==0?N*=1.5:N/=2:16===l&&(c%3==0?N*=.75:N/=4),{tempo:N,instrument:T,channel:E,tracks:x}};var G=["break","(break)","no chord","n.c.","tacet"],U=[0,2,4,5,7,9,11],H=8,K={A:-27,B:-25,C:-24,D:-22,E:-20,F:-19,G:-17},R={M:[0,4,7],6:[0,4,7,9],7:[0,4,7,10],"+7":[0,4,8,10],aug7:[0,4,8,10],maj7:[0,4,7,11],"∆7":[0,4,7,11],9:[0,4,7,10,14],11:[0,4,7,10,14,16],13:[0,4,7,10,14,18],"+":[0,4,8],"7#5":[0,4,8,10],"7+5":[0,4,8,10],"7b9":[0,4,7,10,13],"7b5":[0,4,6,10],"9#5":[0,4,8,10,14],"9+5":[0,4,8,10,14],m:[0,3,7],"-":[0,3,7],m6:[0,3,7,9],"-6":[0,3,7,9],m7:[0,3,7,10],"-7":[0,3,7,10],dim:[0,3,6],dim7:[0,3,6,9],"°7":[0,3,6,9],"ø7":[0,3,6,9],"7sus4":[0,5,7,10],m7sus4:[0,5,7,10],sus4:[0,5,7]},j={"2/2":["boom","chick"],"2/4":["boom","chick"],"3/4":["boom","chick","chick"],"4/4":["boom","chick","boom2","chick"],"6/8":["boom","","chick","boom2","","chick"]}}(),t.exports=r},{}],4:[function(e,t,n){var r;!function(){"use strict";function e(e){for(var t=0;t<e.length;t++)for(var n=0,r=0;r<e[t].length;r++)n+=e[t][r][1],e[t][r].absTime=n}function t(e){for(var t=[],n=0;n<e.length;n++)for(var r=0;r<e[n].length;r++)t.push(e[n][r]);return t}function n(e){return e.sort(function(e,t){return e.absTime>t.absTime?1:-1})}function a(e){for(var t=0,n=0;n<e.length;n++){var r=e[n].absTime;e[n][1]=r-t,t=r}}function i(r){e(r);var i=t(r);return i=n(i),a(i),i}(r=function(){this.tempo=0,this.timeFactor=0,this.output=[],this.currentChannel=0,this.currentInstrument=0,this.track=0,this.nextDuration=0,this.tracks=[[]]}).prototype.setInstrument=function(e){var t=[{ticksToEvent:0,track:this.track,event:{channel:this.currentChannel,deltaTime:0,programNumber:this.currentInstrument,subtype:"programChange",type:"channel"}},this.nextDuration*this.timeFactor];this.tracks[this.track].push(t)},r.prototype.setChannel=function(e){},r.prototype.startTrack=function(){this.track++,this.tracks[this.track]=[],this.nextDuration=0},r.prototype.setGlobalInfo=function(e,t){this.tempo=e;var n=Math.round(1/e*6e7);this.timeFactor=n/48e4;this.track,this.nextDuration,this.timeFactor;this.track,this.nextDuration,this.timeFactor,this.track,this.nextDuration,this.timeFactor},r.prototype.startNote=function(e,t){var n=5*Math.floor(this.nextDuration/5),r=[{ticksToEvent:n,track:this.track,event:{deltaTime:n,channel:this.currentChannel,type:"channel",noteNumber:e,velocity:t,subtype:"noteOn"}},this.nextDuration*this.timeFactor];this.tracks[this.track].push(r),this.nextDuration=0},r.prototype.endNote=function(e){var t=5*Math.floor(this.nextDuration/5),n=[{ticksToEvent:t,track:this.track,event:{deltaTime:t,channel:this.currentChannel,type:"channel",noteNumber:e,velocity:0,subtype:"noteOff"}},this.nextDuration*this.timeFactor];this.tracks[this.track].push(n),this.nextDuration=0},r.prototype.addRest=function(e){this.nextDuration+=e},r.prototype.endTrack=function(){this.track},r.prototype.getData=function(){return i(this.tracks)}}(),t.exports=r},{}],5:[function(e,t,n){var r;!function(){"use strict";function e(e,t){for(var n in t)t.hasOwnProperty(n)&&e.setAttribute(n,t[n]);return e}function t(){this.trackstrings="",this.trackcount=0,this.noteOnAndChannel="%90"}function n(e){for(var t="",n=0;n<e.length;n+=2)t+="%",t+=e.substr(n,2);return t}function a(e,t){for(var r=e.toString(16);r.length<t;)r="0"+r;return n(r)}function i(e){for(var t=0,n=[];0!==e;)n.push(127&e),e>>=7;for(var r=n.length-1;r>=0;r--){t<<=8;var i=n[r];0!==r&&(i|=128),t|=i}var s=t.toString(16).length;return s+=s%2,a(t,s)}t.prototype.setTempo=function(e){0===this.trackcount&&(this.startTrack(),this.track+="%00%FF%51%03"+a(Math.round(6e7/e),6),this.endTrack())},t.prototype.setGlobalInfo=function(e,t){if(0===this.trackcount){if(this.startTrack(),this.track+="%00%FF%51%03"+a(Math.round(6e7/e),6),t){this.track+="%00%FF%03"+a(t.length,2);for(var n=0;n<t.length;n++)this.track+=a(t.charCodeAt(n),2)}this.endTrack()}},t.prototype.startTrack=function(){this.track="",this.silencelength=0,this.trackcount++,this.first=!0,this.instrument&&this.setInstrument(this.instrument)},t.prototype.endTrack=function(){var e=a(this.track.length/3+4,8);this.track="MTrk"+e+this.track+"%00%FF%2F%00",this.trackstrings+=this.track},t.prototype.setInstrument=function(e){this.track?this.track="%00%C0"+a(e,2)+this.track:this.track="%00%C0"+a(e,2),this.instrument=e},t.prototype.setChannel=function(e){this.channel=e-1,this.noteOnAndChannel="%9"+this.channel.toString(16)},t.prototype.startNote=function(e,t){this.track+=i(this.silencelength),this.silencelength=0,this.first&&(this.first=!1,this.track+=this.noteOnAndChannel),this.track+="%"+e.toString(16)+a(t,2)},t.prototype.endNote=function(e,t){this.track+=i(this.silencelength+t),this.silencelength=0,this.track+="%"+e.toString(16)+"%00"},t.prototype.addRest=function(e){this.silencelength+=e},t.prototype.getData=function(){return"data:audio/midi,MThd%00%00%00%06%00%01"+a(this.trackcount,4)+"%01%e0"+this.trackstrings},t.prototype.embed=function(t,n){var r=this.getData(),a=e(document.createElement("a"),{href:r});if(a.innerHTML="download midi",t.insertBefore(a,t.firstChild),!n){var i=e(document.createElement("embed"),{src:r,type:"video/quicktime",controller:"true",autoplay:"false",loop:"false",enablejavascript:"true",style:"display:block; height: 20px;"});t.insertBefore(i,t.firstChild)}},r=function(){return new t}}(),t.exports=r},{}],6:[function(e,t,n){var r;!function(){"use strict";function e(e){var t=.25;e.duration&&(t=e.duration[0]);var n=60;return e.bpm&&(n=e.bpm),n*t*4}function t(e){var t;switch(e.type){case"common_time":t={el_type:"meter",num:4,den:4};break;case"cut_time":t={el_type:"meter",num:2,den:2};break;case"specified":t={el_type:"meter",num:e.value[0].num,den:e.value[0].den};break;default:t={el_type:"meter"}}return n=t.num/t.den,t}var n;r=function(r,a){var i=180,s=(a=a||{}).program||0,o=a.transpose||0,c=a.channel||0,l=a.drum||"",h=a.drumBars||1,u=a.drumIntro||0,f=""!==l;s=parseInt(s,10),o=parseInt(o,10),c=parseInt(c,10),l=l.split(" "),h=parseInt(h,10),u=parseInt(u,10);var d=r.formatting.bagpipes;if(d&&(s=71),r.formatting.midi){var p=r.formatting.midi;p.program&&(s=p.program[0],p.program.length>1&&(c=p.program[1])),p.transpose&&(o=p.transpose[0]),p.channel&&(c=p.channel[0]),p.drum&&(l=p.drum),p.drumbars&&(h=p.drumbars[0]),p.drumon&&(f=!0)}r.metaText.tempo&&(i=e(r.metaText.tempo)),a.qpm&&(i=parseInt(a.qpm,10));var m=[];d&&m.push({el_type:"bagpipes"}),m.push({el_type:"instrument",program:s}),c&&m.push({el_type:"channel",channel:c}),o&&m.push({el_type:"transpose",transpose:o}),m.push({el_type:"tempo",qpm:i});for(var g=[],v=[],b=[],k=!1,y=0;y<r.lines.length;y++){var _=r.lines[y];if(_.staff)for(var w=_.staff,x=0,N=0;N<w.length;N++)for(var A=w[N],T=0;T<A.voices.length;T++){var E=A.voices[T];g[x]||(g[x]=[].concat(m)),A.key&&("HP"===A.key.root?g[x].push({el_type:"key",accidentals:[{acc:"natural",note:"g"},{acc:"sharp",note:"f"},{acc:"sharp",note:"c"}]}):g[x].push({el_type:"key",accidentals:A.key.accidentals})),A.meter&&g[x].push(t(A.meter)),!k&&f&&(g[x].push({el_type:"drum",params:{pattern:l,bars:h,on:f,intro:u}}),k=!0),A.clef&&A.clef.transpose&&(A.clef.el_type="clef",g[x].push({el_type:"transpose",transpose:A.clef.transpose})),r.formatting.midi&&r.formatting.midi.drumoff&&(g[x].push({el_type:"bar"}),g[x].push({el_type:"drum",params:{pattern:"",on:!1}}));for(var S=0,C=0;C<E.length;C++){var P=E[C];switch(P.el_type){case"note":P.rest&&"spacer"===P.rest.type||(g[x].push(P),S++);break;case"key":"HP"===P.root?g[x].push({el_type:"key",accidentals:[{acc:"natural",note:"g"},{acc:"sharp",note:"f"},{acc:"sharp",note:"c"}]}):g[x].push({el_type:"key",accidentals:P.accidentals});break;case"meter":g[x].push(t(P));break;case"clef":P.transpose&&g[x].push({el_type:"transpose",transpose:P.transpose});break;case"tempo":i=e(P),g[x].push({el_type:"tempo",qpm:i});break;case"bar":S>0&&g[x].push({el_type:"bar"}),S=0;var I="bar_right_repeat"===P.type||"bar_dbl_repeat"===P.type,B="1"===P.startEnding,M="bar_left_repeat"===P.type||"bar_dbl_repeat"===P.type||"bar_thick_thin"===P.type||"bar_thin_thick"===P.type||"bar_thin_thin"===P.type||"bar_right_repeat"===P.type;if(I){var D=v[x];D||(D=0);var F=b[x];F||(F=g[x].length),g[x]=g[x].concat(g[x].slice(D,F)),b[x]=void 0,v[x]=void 0}B&&(b[x]=g[x].length),M&&(v[x]=g[x].length);break;case"style":case"part":break;case"stem":case"scale":break;case"midi":var L=!1;switch(P.cmd){case"drumon":f=!0,L=!0;break;case"drumoff":f=!1,L=!0;break;case"drum":l=P.params,L=!0;break;case"drumbars":h=P.params[0],L=!0}L&&(g[0].push({el_type:"drum",params:{pattern:l,bars:h,intro:u,on:f}}),k=!0);break;default:console.log("MIDI: element type "+P.el_type+" not handled.")}}x++}}if(u)for(var O=0;O<g.length;O++){for(var V=0;"note"!==g[O][V].el_type&&g[O].length>V;)V++;if(g[O].length>V)for(var z=0;z<u;z++)g[O].splice(V,0,{el_type:"note",rest:{type:"rest"},duration:n},{el_type:"bar"})}return g}}(),t.exports=r},{}],7:[function(e,t,n){var r={};r.clone=function(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t},r.cloneArray=function(e){for(var t=[],n=0;n<e.length;n++)t.push(r.clone(e[n]));return t},r.cloneHashOfHash=function(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[n]=r.clone(e[n]));return t},r.cloneHashOfArrayOfHash=function(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[n]=r.cloneArray(e[n]));return t},r.gsub=function(e,t,n){return e.split(t).join(n)},r.strip=function(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")},r.startsWith=function(e,t){return 0===e.indexOf(t)},r.endsWith=function(e,t){var n=e.length-t.length;return n>=0&&e.lastIndexOf(t)===n},r.each=function(e,t,n){for(var r=0,a=e.length;r<a;r++)t.apply(n,[e[r],r])},r.last=function(e){return 0===e.length?null:e[e.length-1]},r.compact=function(e){for(var t=[],n=0;n<e.length;n++)e[n]&&t.push(e[n]);return t},r.detect=function(e,t){for(var n=0;n<e.length;n++)if(t(e[n]))return!0;return!1},t.exports=r},{}],8:[function(e,t,n){var r=e("./abc_common"),a=e("./abc_parse_directive"),i=e("./abc_parse_header"),s=e("./abc_parse_key_voice"),o=e("./abc_tokenizer"),c=e("../data/abc_tune");t.exports=function(){"use strict";function e(e,t,n){e.positioning||(e.positioning={}),e.positioning[t]=n}function t(e,t,n){e.fonts||(e.fonts={}),e.fonts[t]=n}function n(){var e={startChar:-1,endChar:-1};if(m.partForNextLine.length&&(e.part=m.partForNextLine),e.clef=m.currentVoice&&void 0!==m.staves[m.currentVoice.staffNum].clef?r.clone(m.staves[m.currentVoice.staffNum].clef):r.clone(m.clef),e.key=s.deepCopyKey(m.key),s.addPosToKey(e.clef,e.key),null!==m.meter?(m.currentVoice?(r.each(m.staves,function(e){e.meter=m.meter}),e.meter=m.staves[m.currentVoice.staffNum].meter,m.staves[m.currentVoice.staffNum].meter=null):e.meter=m.meter,m.meter=null):m.currentVoice&&m.staves[m.currentVoice.staffNum].meter&&(e.meter=m.staves[m.currentVoice.staffNum].meter,m.staves[m.currentVoice.staffNum].meter=null),m.currentVoice&&m.currentVoice.name&&(e.name=m.currentVoice.name),m.vocalfont&&(e.vocalfont=m.vocalfont),m.style&&(e.style=m.style),m.currentVoice){var t=m.staves[m.currentVoice.staffNum];t.brace&&(e.brace=t.brace),t.bracket&&(e.bracket=t.bracket),t.connectBarLines&&(e.connectBarLines=t.connectBarLines),t.name&&(e.name=t.name[m.currentVoice.index]),t.subname&&(e.subname=t.subname[m.currentVoice.index]),m.currentVoice.stem&&(e.stem=m.currentVoice.stem),m.currentVoice.scale&&(e.scale=m.currentVoice.scale),m.currentVoice.style&&(e.style=m.currentVoice.style),m.currentVoice.transpose&&(e.clef.transpose=m.currentVoice.transpose)}var n=void 0===m.currentVoice||0===m.currentVoice.staffNum&&0===m.currentVoice.index;0===m.barNumbers&&n&&1!==m.currBarNumber&&(e.barNumber=m.currBarNumber),d.startNewLine(e),m.partForNextLine=""}function l(e){var t=e.origMeter;return t&&"specified"===t.type&&t.value&&0!==t.value.length?parseInt(t.value[0].num,10)/parseInt(t.value[0].den,10):1}function h(e,t){e.push({el_type:"hint"});for(var n=0;n<t.length;n++){var a=t[n],i=r.clone(a);if(e.push(i),"bar"===a.el_type)return}}function u(e,t){for(var n=0;n<e.length;n++){var r=e[n],a=t[n];if(a)for(var i=0;i<a.voices.length;i++){var s=a.voices[i],o=r.voices[i];o&&h(o,s)}}}function f(){for(var e=0;e<d.lines.length;e++){var t=d.lines[e].staff;if(t){for(var n=e+1;n<d.lines.length&&void 0===d.lines[n].staff;)n++;n<d.lines.length&&u(t,d.lines[n].staff)}}}var d=new c,p=new o;this.getTune=function(){return d};var m={reset:function(){for(var e in this)this.hasOwnProperty(e)&&"function"!=typeof this[e]&&delete this[e];this.iChar=0,this.key={accidentals:[],root:"none",acc:"",mode:""},this.meter=null,this.origMeter=null,this.hasMainTitle=!1,this.default_length=.125,this.clef={type:"treble",verticalPos:0},this.next_note_duration=0,this.start_new_line=!0,this.is_in_header=!0,this.is_in_history=!1,this.partForNextLine="",this.havent_set_length=!0,this.voices={},this.staves=[],this.macros={},this.currBarNumber=1,this.inTextBlock=!1,this.inPsBlock=!1,this.ignoredDecorations=[],this.textBlock="",this.score_is_present=!1,this.inEnding=!1,this.inTie=!1,this.inTieChord={},this.vocalPosition="auto",this.dynamicPosition="auto",this.chordPosition="auto",this.ornamentPosition="auto",this.volumePosition="auto",this.openSlurs=[]},differentFont:function(e,t){return this[e].decoration!==t[e].decoration||this[e].face!==t[e].face||this[e].size!==t[e].size||this[e].style!==t[e].style||this[e].weight!==t[e].weight},addFormattingOptions:function(n,r,a){"note"===a?("auto"!==this.vocalPosition&&e(n,"vocalPosition",this.vocalPosition),"auto"!==this.dynamicPosition&&e(n,"dynamicPosition",this.dynamicPosition),"auto"!==this.chordPosition&&e(n,"chordPosition",this.chordPosition),"auto"!==this.ornamentPosition&&e(n,"ornamentPosition",this.ornamentPosition),"auto"!==this.volumePosition&&e(n,"volumePosition",this.volumePosition),this.differentFont("annotationfont",r)&&t(n,"annotationfont",this.annotationfont),this.differentFont("gchordfont",r)&&t(n,"gchordfont",this.gchordfont),this.differentFont("vocalfont",r)&&t(n,"vocalfont",this.vocalfont)):"bar"===a&&("auto"!==this.dynamicPosition&&e(n,"dynamicPosition",this.dynamicPosition),"auto"!==this.chordPosition&&e(n,"chordPosition",this.chordPosition),"auto"!==this.ornamentPosition&&e(n,"ornamentPosition",this.ornamentPosition),"auto"!==this.volumePosition&&e(n,"volumePosition",this.volumePosition),this.differentFont("measurefont",r)&&t(n,"measurefont",this.measurefont),this.differentFont("repeatfont",r)&&t(n,"repeatfont",this.repeatfont))}},g=function(e){m.warnings||(m.warnings=[]),m.warnings.push(e)},v=function(e){var t=r.gsub(e,""," ");return t=r.gsub(t,"&","&amp;"),t=r.gsub(t,"<","&lt;"),r.gsub(t,">","&gt;")},b=function(e,t,n){t||(t=" ");var r=t.charAt(n);" "===r&&(r="SPACE");var a=v(t.substring(0,n))+'<span style="text-decoration:underline;font-size:1.3em;font-weight:bold;">'+r+"</span>"+v(t.substring(n+1));g("Music Line:"+d.getNumLines()+":"+(n+1)+": "+e+":  "+a)},k=new i(p,b,m,d);this.getWarnings=function(){return m.warnings};var y=function(e,t){if('"'===e.charAt(t)){var n=p.getBrackettedSubstring(e,t,5);if(n[2]||b("Missing the closing quote while parsing the chord symbol",e,t),n[0]>0&&n[1].length>0&&"^"===n[1].charAt(0))n[1]=n[1].substring(1),n[2]="above";else if(n[0]>0&&n[1].length>0&&"_"===n[1].charAt(0))n[1]=n[1].substring(1),n[2]="below";else if(n[0]>0&&n[1].length>0&&"<"===n[1].charAt(0))n[1]=n[1].substring(1),n[2]="left";else if(n[0]>0&&n[1].length>0&&">"===n[1].charAt(0))n[1]=n[1].substring(1),n[2]="right";else if(n[0]>0&&n[1].length>0&&"@"===n[1].charAt(0)){n[1]=n[1].substring(1);var r=p.getFloat(n[1]);0===r.digits&&b("Missing first position in absolutely positioned annotation.",e,t),n[1]=n[1].substring(r.digits),","!==n[1][0]&&b("Missing comma absolutely positioned annotation.",e,t),n[1]=n[1].substring(1);var a=p.getFloat(n[1]);0===a.digits&&b("Missing second position in absolutely positioned annotation.",e,t),n[1]=n[1].substring(a.digits);var i=p.skipWhiteSpace(n[1]);n[1]=n[1].substring(i),n[2]=null,n[3]={x:r.value,y:a.value}}else n[1]=n[1].replace(/([ABCDEFG])b/g,"$1♭"),n[1]=n[1].replace(/([ABCDEFG])#/g,"$1♯"),n[2]="default";return n}return[0,""]},_=["trill","lowermordent","uppermordent","mordent","pralltriller","accent","fermata","invertedfermata","tenuto","0","1","2","3","4","5","+","wedge","open","thumb","snap","turn","roll","breath","shortphrase","mediumphrase","longphrase","segno","coda","D.S.","D.C.","fine","slide","^","marcato","upbow","downbow","/","//","///","////","trem1","trem2","trem3","trem4","turnx","invertedturn","invertedturnx","trill(","trill)","arpeggio","xstem","mark","umarcato","style=normal","style=harmonic","style=rhythm","style=x"],w=["p","pp","f","ff","mf","mp","ppp","pppp","fff","ffff","sfz"],x=["crescendo(","crescendo)","diminuendo(","diminuendo)"],N=[["<","accent"],[">","accent"],["tr","trill"],["plus","+"],["emphasis","accent"],["^","umarcato"],["marcato","umarcato"]],A=[["<(","crescendo("],["<)","crescendo)"],[">(","diminuendo("],[">)","diminuendo)"]],T=function(e,t){var n=m.macros[e.charAt(t)];if(void 0!==n)return"!"!==n.charAt(0)&&"+"!==n.charAt(0)||(n=n.substring(1)),"!"!==n.charAt(n.length-1)&&"+"!==n.charAt(n.length-1)||(n=n.substring(0,n.length-1)),r.detect(_,function(e){return n===e})?[1,n]:r.detect(w,function(e){return n===e})?("hidden"===m.volumePosition&&(n=""),[1,n]):r.detect(x,function(e){return"hidden"===m.dynamicPosition&&(n=""),n===e})?[1,n]:(r.detect(m.ignoredDecorations,function(e){return n===e})||b("Unknown macro: "+n,e,t),[1,""]);switch(e.charAt(t)){case".":return[1,"staccato"];case"u":return[1,"upbow"];case"v":return[1,"downbow"];case"~":return[1,"irishroll"];case"!":case"+":var a=p.getBrackettedSubstring(e,t,5);return a[1].length>0&&("^"===a[1].charAt(0)||"_"===a[1].charAt(0))&&(a[1]=a[1].substring(1)),r.detect(_,function(e){return a[1]===e})?a:r.detect(w,function(e){return a[1]===e})?("hidden"===m.volumePosition&&(a[1]=""),a):r.detect(x,function(e){return a[1]===e})?("hidden"===m.dynamicPosition&&(a[1]=""),a):r.detect(N,function(e){return a[1]===e[0]&&(a[1]=e[1],!0)})?a:r.detect(A,function(e){return a[1]===e[0]&&(a[1]=e[1],!0)})?("hidden"===m.dynamicPosition&&(a[1]=""),a):"!"!==e.charAt(t)||1!==a[0]&&"!"===e.charAt(t+a[0]-1)?(b("Unknown decoration: "+a[1],e,t),a[1]="",a):[1,null];case"H":return[1,"fermata"];case"J":return[1,"slide"];case"L":return[1,"accent"];case"M":return[1,"mordent"];case"O":return[1,"coda"];case"P":return[1,"pralltriller"];case"R":return[1,"roll"];case"S":return[1,"segno"];case"T":return[1,"trill"]}return[0,0]},E=function(e,t){for(var n=t;p.isWhiteSpace(e.charAt(t));)t++;return[t-n]},S=function(e,t){var n=p.getBarLine(e,t);if(0===n.len)return[0,""];if(n.warn)return b(n.warn,e,t),[n.len,""];for(var r=0;r<e.length&&" "===e.charAt(t+n.len+r);r++);var a=n.len;if("["===e.charAt(t+n.len+r)&&(n.len+=r+1),'"'===e.charAt(t+n.len)&&"["===e.charAt(t+n.len-1)){var i=p.getBrackettedSubstring(e,t+n.len,5);return[n.len+i[0],n.token,i[1]]}var s=p.getTokenOf(e.substring(t+n.len),"1234567890-,");return 0===s.len||"-"===s.token[0]?[a,n.token]:[n.len+s.len,n.token,s.token]},C=function(e,t){for(var n={},r=t;"("===e.charAt(t)||p.isWhiteSpace(e.charAt(t));)"("===e.charAt(t)&&(t+1<e.length&&e.charAt(t+1)>="2"&&e.charAt(t+1)<="9"?(void 0!==n.triplet?b("Can't nest triplets",e,t):(n.triplet=e.charAt(t+1)-"0",t+2<e.length&&":"===e.charAt(t+2)&&(t+3<e.length&&":"===e.charAt(t+3)?t+4<e.length&&e.charAt(t+4)>="1"&&e.charAt(t+4)<="9"?(n.num_notes=e.charAt(t+4)-"0",t+=3):b("expected number after the two colons after the triplet to mark the duration",e,t):t+3<e.length&&e.charAt(t+3)>="1"&&e.charAt(t+3)<="9"?t+4<e.length&&":"===e.charAt(t+4)?t+5<e.length&&e.charAt(t+5)>="1"&&e.charAt(t+5)<="9"&&(n.num_notes=e.charAt(t+5)-"0",t+=4):(n.num_notes=n.triplet,t+=3):b("expected number after the triplet to mark the duration",e,t))),t++):void 0===n.startSlur?n.startSlur=1:n.startSlur++),t++;return n.consumed=t-r,n},P=function(e,t){if(e){"-"!==(t=r.strip(t)).charAt(t.length-1)&&(t+=" ");for(var n=[],a=0,i=!1,s=function(e){var s=r.strip(t.substring(a,e));if(a=e+1,s.length>0){i&&(s=r.gsub(s,"~"," "));var o=t.charAt(e);return"_"!==o&&"-"!==o&&(o=" "),n.push({syllable:p.translateString(s),divider:o}),i=!1,!0}return!1},o=0;o<t.length;o++)switch(t.charAt(o)){case" ":case"":s(o);break;case"-":!s(o)&&n.length>0&&(r.last(n).divider="-",n.push({skip:!0,to:"next"}));break;case"_":s(o),n.push({skip:!0,to:"slur"});break;case"*":s(o),n.push({skip:!0,to:"next"});break;case"|":s(o),n.push({skip:!0,to:"bar"});break;case"~":i=!0}r.each(e,function(e){if(0!==n.length)if(n[0].skip)switch(n[0].to){case"next":case"slur":"note"===e.el_type&&null!==e.pitches&&n.shift();break;case"bar":"bar"===e.el_type&&n.shift()}else if("note"===e.el_type&&void 0===e.rest){var t=n.shift();void 0===e.lyric?e.lyric=[t]:e.lyric.push(t)}})}else b("Can't add words before the first line of music",e,0)},I=function(e,t){if(e){"-"!==(t=r.strip(t)).charAt(t.length-1)&&(t+=" ");for(var n=[],a=0,i=!1,s=function(e){var s=r.strip(t.substring(a,e));if(a=e+1,s.length>0){i&&(s=r.gsub(s,"~"," "));var o=t.charAt(e);return"_"!==o&&"-"!==o&&(o=" "),n.push({syllable:p.translateString(s),divider:o}),i=!1,!0}return!1},o=0;o<t.length;o++)switch(t.charAt(o)){case" ":case"":s(o);break;case"-":!s(o)&&n.length>0&&(r.last(n).divider="-",n.push({skip:!0,to:"next"}));break;case"_":s(o),n.push({skip:!0,to:"slur"});break;case"*":s(o),n.push({skip:!0,to:"next"});break;case"|":s(o),n.push({skip:!0,to:"bar"});break;case"~":i=!0}r.each(e,function(e){if(0!==n.length)if(n[0].skip)switch(n[0].to){case"next":case"slur":"note"===e.el_type&&null!==e.pitches&&n.shift();break;case"bar":"bar"===e.el_type&&n.shift()}else if("note"===e.el_type&&void 0===e.rest){var t=n.shift();void 0===e.lyric?e.lyric=[t]:e.lyric.push(t)}})}else b("Can't add symbols before the first line of music",e,0)},B=function(e,t){switch(e.charAt(t)){case">":return t<e.length-1&&">"===e.charAt(t+1)?[2,1.75,.25]:[1,1.5,.5];case"<":return t<e.length-1&&"<"===e.charAt(t+1)?[2,.25,1.75]:[1,.5,1.5]}return null},M=function(e){return void 0!==e.duration&&e.duration<.25&&(e.end_beam=!0),e},D={A:5,B:6,C:0,D:1,E:2,F:3,G:4,a:12,b:13,c:7,d:8,e:9,f:10,g:11},F={x:"invisible",y:"spacer",z:"rest",Z:"multimeasure"},L=function(e,t,n,r){for(var a=function(e){return"octave"===e||"duration"===e||"Zduration"===e||"broken_rhythm"===e||"end_slur"===e},i="startSlur",s=!1;;){switch(e.charAt(t)){case"(":if("startSlur"!==i)return a(i)?(n.endChar=t,n):null;void 0===n.startSlur?n.startSlur=1:n.startSlur++;break;case")":if(!a(i))return null;void 0===n.endSlur?n.endSlur=1:n.endSlur++;break;case"^":if("startSlur"===i)n.accidental="sharp",i="sharp2";else{if("sharp2"!==i)return a(i)?(n.endChar=t,n):null;n.accidental="dblsharp",i="pitch"}break;case"_":if("startSlur"===i)n.accidental="flat",i="flat2";else{if("flat2"!==i)return a(i)?(n.endChar=t,n):null;n.accidental="dblflat",i="pitch"}break;case"=":if("startSlur"!==i)return a(i)?(n.endChar=t,n):null;n.accidental="natural",i="pitch";break;case"A":case"B":case"C":case"D":case"E":case"F":case"G":case"a":case"b":case"c":case"d":case"e":case"f":case"g":if("startSlur"!==i&&"sharp2"!==i&&"flat2"!==i&&"pitch"!==i)return a(i)?(n.endChar=t,n):null;n.pitch=D[e.charAt(t)],i="octave",r&&0!==m.next_note_duration?(n.duration=m.default_length*m.next_note_duration,m.next_note_duration=0,s=!0):n.duration=m.default_length;break;case",":if("octave"!==i)return a(i)?(n.endChar=t,n):null;n.pitch-=7;break;case"'":if("octave"!==i)return a(i)?(n.endChar=t,n):null;n.pitch+=7;break;case"x":case"y":case"z":case"Z":if("startSlur"!==i)return a(i)?(n.endChar=t,n):null;n.rest={type:F[e.charAt(t)]},delete n.accidental,delete n.startSlur,delete n.startTie,delete n.endSlur,delete n.endTie,delete n.end_beam,delete n.grace_notes,"multimeasure"===n.rest.type?(n.duration=1,i="Zduration"):(r&&0!==m.next_note_duration?(n.duration=m.default_length*m.next_note_duration,m.next_note_duration=0,s=!0):n.duration=m.default_length,i="duration");break;case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"0":case"/":if("octave"===i||"duration"===i){var o=p.getFraction(e,t);for(n.duration=n.duration*o.value,n.endChar=o.index;o.index<e.length&&(p.isWhiteSpace(e.charAt(o.index))||"-"===e.charAt(o.index));)"-"===e.charAt(o.index)?n.startTie={}:n=M(n),o.index++;t=o.index-1,i="broken_rhythm"}else if("sharp2"===i)n.accidental="quartersharp",i="pitch";else{if("flat2"!==i){if("Zduration"===i){var c=p.getNumber(e,t);return n.duration=c.num,n.endChar=c.index,n}return null}n.accidental="quarterflat",i="pitch"}break;case"-":if("startSlur"===i)d.addTieToLastNote(),n.endTie=!0;else{if("octave"!==i&&"duration"!==i&&"end_slur"!==i)return"broken_rhythm"===i?(n.endChar=t,n):null;if(n.startTie={},s||!r)return p.isWhiteSpace(e.charAt(t+1))&&M(n),n.endChar=t+1,n;i="broken_rhythm"}break;case" ":case"\t":if(!a(i))return null;n.end_beam=!0;do{"-"===e.charAt(t)&&(n.startTie={}),t++}while(t<e.length&&(p.isWhiteSpace(e.charAt(t))||"-"===e.charAt(t)));if(n.endChar=t,s||!r||"<"!==e.charAt(t)&&">"!==e.charAt(t))return n;t--,i="broken_rhythm";break;case">":case"<":if(!a(i))return null;if(!r)return n.endChar=t,n;var l=B(e,t);t+=l[0]-1,m.next_note_duration=l[2],n.duration=l[1]*n.duration,i="end_slur";break;default:return a(i)?(n.endChar=t,n):null}if(++t===e.length)return a(i)?(n.endChar=t,n):null}return null},O=function(e,t){if("{"===e.charAt(t)){var n=p.getBrackettedSubstring(e,t,1,"}");n[2]||b("Missing the closing '}' while parsing grace note",e,t),")"===e[t+n[0]]&&(n[0]++,n[1]+=")");for(var r=[],a=0,i=!1;a<n[1].length;){var s=!1;"/"===n[1].charAt(a)&&(s=!0,a++);var o=L(n[1],a,{},!1);null!==o?(o.duration=o.duration/(8*m.default_length),s&&(o.acciaccatura=!0),r.push(o),i&&(o.endTie=!0,i=!1),o.startTie&&(i=!0),a=o.endChar,delete o.endChar):(" "===n[1].charAt(a)?r.length>0&&(r[r.length-1].end_beam=!0):b("Unknown character '"+n[1].charAt(a)+"' while parsing grace note",e,t),a++)}if(r.length)return[n[0],r]}return[0]},V=function(e){k.resolveTempo(),m.is_in_header=!1;for(var t=0,a=m.iChar;p.isWhiteSpace(e.charAt(t))&&t<e.length;)t++;if(t!==e.length&&"%"!==e.charAt(t)){var i=m.start_new_line;void 0===m.continueall?m.start_new_line=!0:m.start_new_line=!1;var s=0,o=k.letter_to_body_header(e,t);o[0]>0&&(t+=o[0],"V"===o[1]&&(i=!0));for(var c={};t<e.length;){var h=t;if("%"===e.charAt(t))break;var u=k.letter_to_inline_header(e,t);if(u[0]>0)t+=u[0],"V"===u[1]&&(i=!0);else{i&&(n(),i=!1);for(var f;;)if((f=p.eatWhiteSpace(e,t))>0&&(t+=f),t>0&&""===e.charAt(t-1)&&(f=k.letter_to_body_header(e,t))[0]>0&&("V"===f[1]&&n(),t=f[0],m.start_new_line=!1),(f=E(e,t))[0]>0&&(t+=f[0]),(f=y(e,t))[0]>0){c.chord||(c.chord=[]);var g=p.translateString(f[1]);g=g.replace(/;/g,"\n");for(var v=!1,_=0;_<c.chord.length;_++)c.chord[_].position===f[2]&&(v=!0,c.chord[_].name+="\n"+g);!1===v&&(null===f[2]&&f[3]?c.chord.push({name:g,rel_position:f[3]}):c.chord.push({name:g,position:f[2]})),t+=f[0];var w=p.skipWhiteSpace(e.substring(t));w>0&&(c.force_end_beam_last=!0),t+=w}else if((f=-1==="ABCDEFGabcdefgxyzZ[]|^_{".indexOf(e.charAt(t))?T(e,t):[0])[0]>0)null===f[1]?t+1<e.length&&n():f[1].length>0&&(0===f[1].indexOf("style=")?c.style=f[1].substr(6):(void 0===c.decoration&&(c.decoration=[]),c.decoration.push(f[1]))),t+=f[0];else{if(!((f=O(e,t))[0]>0))break;c.gracenotes=f[1],t+=f[0]}if((f=S(e,t))[0]>0){void 0!==c.gracenotes&&(c.rest={type:"spacer"},c.duration=.125,m.addFormattingOptions(c,d.formatting,"note"),d.appendElement("note",a+t,a+t+f[0],c),m.measureNotEmpty=!0,c={});var x={type:f[1]};0===x.type.length?b("Unknown bar type",e,t):(m.inEnding&&"bar_thin"!==x.type&&(x.endEnding=!0,m.inEnding=!1),f[2]&&(x.startEnding=f[2],m.inEnding&&(x.endEnding=!0),m.inEnding=!0),void 0!==c.decoration&&(x.decoration=c.decoration),void 0!==c.chord&&(x.chord=c.chord),x.startEnding&&void 0===m.barFirstEndingNum?m.barFirstEndingNum=m.currBarNumber:x.startEnding&&x.endEnding&&m.barFirstEndingNum?m.currBarNumber=m.barFirstEndingNum:x.endEnding&&(m.barFirstEndingNum=void 0),"bar_invisible"!==x.type&&m.measureNotEmpty&&(void 0===m.currentVoice||0===m.currentVoice.staffNum&&0===m.currentVoice.index)&&(m.currBarNumber++,m.barNumbers&&m.currBarNumber%m.barNumbers==0&&(x.barNumber=m.currBarNumber)),m.addFormattingOptions(c,d.formatting,"bar"),d.appendElement("bar",a+t,a+t+f[0],x),m.measureNotEmpty=!1,c={}),t+=f[0]}else if("&"===e[t])b("Overlay not yet supported",e,t),t++;else{if((f=C(e,t)).consumed>0&&(void 0!==f.startSlur&&(c.startSlur=f.startSlur),void 0!==f.triplet&&(s>0?b("Can't nest triplets",e,t):(c.startTriplet=f.triplet,s=void 0===f.num_notes?f.triplet:f.num_notes)),t+=f.consumed),"["===e.charAt(t)){var N=t;t++;for(var A=null,P=!1;!P;){var I=L(e,t,{},!1);if(null!==I)I.end_beam&&(c.end_beam=!0,delete I.end_beam),void 0===c.pitches?(c.duration=I.duration,c.pitches=[I]):c.pitches.push(I),delete I.duration,m.inTieChord[c.pitches.length]&&(I.endTie=!0,m.inTieChord[c.pitches.length]=void 0),I.startTie&&(m.inTieChord[c.pitches.length]=!0),t=I.endChar,delete I.endChar;else if(" "===e.charAt(t))b("Spaces are not allowed in chords",e,t),t++;else{if(t<e.length&&"]"===e.charAt(t)){t++,0!==m.next_note_duration&&(c.duration=c.duration*m.next_note_duration,m.next_note_duration=0),m.inTie&&(r.each(c.pitches,function(e){e.endTie=!0}),m.inTie=!1),s>0&&0==--s&&(c.endTriplet=!0);for(var D=!1;t<e.length&&!D;){switch(e.charAt(t)){case" ":case"\t":M(c);break;case")":void 0===c.endSlur?c.endSlur=1:c.endSlur++;break;case"-":r.each(c.pitches,function(e){e.startTie={}}),m.inTie=!0;break;case">":case"<":var F=B(e,t);t+=F[0]-1,m.next_note_duration=F[2],A?A*=F[1]:A=F[1];break;case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"/":var V=p.getFraction(e,t);A=V.value,t=V.index,"-"===e.charAt(t)||")"===e.charAt(t)||" "===e.charAt(t)||"<"===e.charAt(t)||">"===e.charAt(t)?t--:D=!0;break;default:D=!0}D||t++}}else b("Expected ']' to end the chords",e,t);void 0!==c.pitches&&(null!==A&&(c.duration=c.duration*A),m.addFormattingOptions(c,d.formatting,"note"),d.appendElement("note",a+N,a+t,c),m.measureNotEmpty=!0,c={}),P=!0}}}else{var z={},W=L(e,t,z,!0);void 0!==z.endTie&&(m.inTie=!0),null!==W&&(void 0!==W.pitch?(c.pitches=[{}],void 0!==W.accidental&&(c.pitches[0].accidental=W.accidental),c.pitches[0].pitch=W.pitch,void 0!==W.endSlur&&(c.pitches[0].endSlur=W.endSlur),void 0!==W.endTie&&(c.pitches[0].endTie=W.endTie),void 0!==W.startSlur&&(c.pitches[0].startSlur=W.startSlur),void 0!==c.startSlur&&(c.pitches[0].startSlur=c.startSlur),void 0!==W.startTie&&(c.pitches[0].startTie=W.startTie),void 0!==c.startTie&&(c.pitches[0].startTie=c.startTie)):(c.rest=W.rest,void 0!==W.endSlur&&(c.endSlur=W.endSlur),void 0!==W.endTie&&(c.rest.endTie=W.endTie),void 0!==W.startSlur&&(c.startSlur=W.startSlur),void 0!==W.startTie&&(c.rest.startTie=W.startTie),void 0!==c.startTie&&(c.rest.startTie=c.startTie)),void 0!==W.chord&&(c.chord=W.chord),void 0!==W.duration&&(c.duration=W.duration),void 0!==W.decoration&&(c.decoration=W.decoration),void 0!==W.graceNotes&&(c.graceNotes=W.graceNotes),delete c.startSlur,m.inTie&&(void 0!==c.pitches?(c.pitches[0].endTie=!0,m.inTie=!1):"spacer"!==c.rest.type&&(c.rest.endTie=!0,m.inTie=!1)),(W.startTie||c.startTie)&&(m.inTie=!0),t=W.endChar,s>0&&0==--s&&(c.endTriplet=!0),W.end_beam&&M(c),c.rest&&"rest"===c.rest.type&&1===c.duration&&(c.rest.type="whole",c.duration=l(m)),m.addFormattingOptions(c,d.formatting,"note"),d.appendElement("note",a+h,a+t,c),m.measureNotEmpty=!0,c={})}t===h&&(" "!==e.charAt(t)&&"`"!==e.charAt(t)&&b("Unknown character ignored",e,t),t++)}}}}},z=function(e){var t=k.parseHeader(e);t.regular&&V(t.str),t.newline&&void 0===m.continueall&&n(),t.words&&P(d.getCurrentVoice(),e.substring(2)),t.symbols&&I(d.getCurrentVoice(),e.substring(2)),t.recurse&&z(t.str)};this.parse=function(e,t){t||(t={}),d.reset(),t.print&&(d.media="print"),m.reset(),k.reset(p,b,m,d),e=r.gsub(e,"\r\n","\n"),e=r.gsub(e,"\r","\n");var n=(e=(e=(e+="\n").replace(/\n\\.*\n/g,"\n")).replace(/\\([ \t]*)(%.*)*\n/g,function(e,t,n){return t+" "+(n?"                                                                                                                                                                                                     ".substring(0,n.length):"")})).split("\n");0===r.last(n).length&&n.pop();try{t.format&&a.globalFormatting(t.format),r.each(n,function(e){if(t.header_only&&!1===m.is_in_header)throw"normal_abort";if(t.stop_on_warning&&m.warnings)throw"normal_abort";m.is_in_history?":"===e.charAt(1)?(m.is_in_history=!1,z(e)):d.addMetaText("history",p.translateString(p.stripComment(e))):m.inTextBlock?r.startsWith(e,"%%endtext")?(d.addText(m.textBlock),m.inTextBlock=!1):r.startsWith(e,"%%")?m.textBlock+=" "+e.substring(2):m.textBlock+=" "+e:m.inPsBlock?r.startsWith(e,"%%endps")?m.inPsBlock=!1:m.textBlock+=" "+e:z(e),m.iChar+=e.length+1});var i=792,s=612;switch(m.papersize){case"legal":i=1008,s=612;break;case"A4":i=842.4,s=597.6}if(m.landscape){var o=i;i=s,s=o}m.openSlurs=d.cleanUp(s,i,m.barsperstaff,m.staffnonote,m.openSlurs)}catch(e){if("normal_abort"!==e)throw e}t.hint_measures&&f()}}},{"../data/abc_tune":1,"./abc_common":7,"./abc_parse_directive":9,"./abc_parse_header":10,"./abc_parse_key_voice":11,"./abc_tokenizer":12}],9:[function(e,t,n){var r=e("./abc_common"),a={};!function(){"use strict";function e(){i.annotationfont={face:"Helvetica",size:12,weight:"normal",style:"normal",decoration:"none"},i.gchordfont={face:"Helvetica",size:12,weight:"normal",style:"normal",decoration:"none"},i.historyfont={face:'"Times New Roman"',size:16,weight:"normal",style:"normal",decoration:"none"},i.infofont={face:'"Times New Roman"',size:14,weight:"normal",style:"italic",decoration:"none"},i.measurefont={face:'"Times New Roman"',size:14,weight:"normal",style:"italic",decoration:"none"},i.partsfont={face:'"Times New Roman"',size:15,weight:"normal",style:"normal",decoration:"none"},i.repeatfont={face:'"Times New Roman"',size:13,weight:"normal",style:"normal",decoration:"none"},i.textfont={face:'"Times New Roman"',size:16,weight:"normal",style:"normal",decoration:"none"},i.vocalfont={face:'"Times New Roman"',size:13,weight:"bold",style:"normal",decoration:"none"},i.wordsfont={face:'"Times New Roman"',size:16,weight:"normal",style:"normal",decoration:"none"},s.formatting.composerfont={face:'"Times New Roman"',size:14,weight:"normal",style:"italic",decoration:"none"},s.formatting.subtitlefont={face:'"Times New Roman"',size:16,weight:"normal",style:"normal",decoration:"none"},s.formatting.tempofont={face:'"Times New Roman"',size:15,weight:"bold",style:"normal",decoration:"none"},s.formatting.titlefont={face:'"Times New Roman"',size:20,weight:"normal",style:"normal",decoration:"none"},s.formatting.footerfont={face:'"Times New Roman"',size:12,weight:"normal",style:"normal",decoration:"none"},s.formatting.headerfont={face:'"Times New Roman"',size:12,weight:"normal",style:"normal",decoration:"none"},s.formatting.voicefont={face:'"Times New Roman"',size:13,weight:"bold",style:"normal",decoration:"none"},s.formatting.annotationfont=i.annotationfont,s.formatting.gchordfont=i.gchordfont,s.formatting.historyfont=i.historyfont,s.formatting.infofont=i.infofont,s.formatting.measurefont=i.measurefont,s.formatting.partsfont=i.partsfont,s.formatting.repeatfont=i.repeatfont,s.formatting.textfont=i.textfont,s.formatting.vocalfont=i.vocalfont,s.formatting.wordsfont=i.wordsfont}var t,n,i,s;a.initialize=function(r,a,o,c){t=r,n=a,i=o,s=c,e()};var o={gchordfont:!0,measurefont:!0,partsfont:!0},c=function(e){switch(e){case"Arial-Italic":return{face:"Arial",weight:"normal",style:"italic",decoration:"none"};case"Arial-Bold":return{face:"Arial",weight:"bold",style:"normal",decoration:"none"};case"Bookman-Demi":return{face:"Bookman,serif",weight:"bold",style:"normal",decoration:"none"};case"Bookman-DemiItalic":return{face:"Bookman,serif",weight:"bold",style:"italic",decoration:"none"};case"Bookman-Light":return{face:"Bookman,serif",weight:"normal",style:"normal",decoration:"none"};case"Bookman-LightItalic":return{face:"Bookman,serif",weight:"normal",style:"italic",decoration:"none"};case"Courier":return{face:'"Courier New"',weight:"normal",style:"normal",decoration:"none"};case"Courier-Oblique":return{face:'"Courier New"',weight:"normal",style:"italic",decoration:"none"};case"Courier-Bold":return{face:'"Courier New"',weight:"bold",style:"normal",decoration:"none"};case"Courier-BoldOblique":return{face:'"Courier New"',weight:"bold",style:"italic",decoration:"none"};case"AvantGarde-Book":return{face:"AvantGarde,Arial",weight:"normal",style:"normal",decoration:"none"};case"AvantGarde-BookOblique":return{face:"AvantGarde,Arial",weight:"normal",style:"italic",decoration:"none"};case"AvantGarde-Demi":case"Avant-Garde-Demi":return{face:"AvantGarde,Arial",weight:"bold",style:"normal",decoration:"none"};case"AvantGarde-DemiOblique":return{face:"AvantGarde,Arial",weight:"bold",style:"italic",decoration:"none"};case"Helvetica-Oblique":return{face:"Helvetica",weight:"normal",style:"italic",decoration:"none"};case"Helvetica-Bold":return{face:"Helvetica",weight:"bold",style:"normal",decoration:"none"};case"Helvetica-BoldOblique":return{face:"Helvetica",weight:"bold",style:"italic",decoration:"none"};case"Helvetica-Narrow":return{face:'"Helvetica Narrow",Helvetica',weight:"normal",style:"normal",decoration:"none"};case"Helvetica-Narrow-Oblique":return{face:'"Helvetica Narrow",Helvetica',weight:"normal",style:"italic",decoration:"none"};case"Helvetica-Narrow-Bold":return{face:'"Helvetica Narrow",Helvetica',weight:"bold",style:"normal",decoration:"none"};case"Helvetica-Narrow-BoldOblique":return{face:'"Helvetica Narrow",Helvetica',weight:"bold",style:"italic",decoration:"none"};case"Palatino-Roman":return{face:"Palatino",weight:"normal",style:"normal",decoration:"none"};case"Palatino-Italic":return{face:"Palatino",weight:"normal",style:"italic",decoration:"none"};case"Palatino-Bold":return{face:"Palatino",weight:"bold",style:"normal",decoration:"none"};case"Palatino-BoldItalic":return{face:"Palatino",weight:"bold",style:"italic",decoration:"none"};case"NewCenturySchlbk-Roman":return{face:'"New Century",serif',weight:"normal",style:"normal",decoration:"none"};case"NewCenturySchlbk-Italic":return{face:'"New Century",serif',weight:"normal",style:"italic",decoration:"none"};case"NewCenturySchlbk-Bold":return{face:'"New Century",serif',weight:"bold",style:"normal",decoration:"none"};case"NewCenturySchlbk-BoldItalic":return{face:'"New Century",serif',weight:"bold",style:"italic",decoration:"none"};case"Times":case"Times-Roman":case"Times-Narrow":case"Times-Courier":case"Times-New-Roman":return{face:'"Times New Roman"',weight:"normal",style:"normal",decoration:"none"};case"Times-Italic":case"Times-Italics":return{face:'"Times New Roman"',weight:"normal",style:"italic",decoration:"none"};case"Times-Bold":return{face:'"Times New Roman"',weight:"bold",style:"normal",decoration:"none"};case"Times-BoldItalic":return{face:'"Times New Roman"',weight:"bold",style:"italic",decoration:"none"};case"ZapfChancery-MediumItalic":return{face:'"Zapf Chancery",cursive,serif',weight:"normal",style:"normal",decoration:"none"};default:return null}},l=function(e,t,r,a,i){function s(){var s=parseInt(e[0].token);return e.shift(),t?0===e.length?{face:t.face,weight:t.weight,style:t.style,decoration:t.decoration,size:s}:1===e.length&&"box"===e[0].token&&o[i]?{face:t.face,weight:t.weight,style:t.style,decoration:t.decoration,size:s,box:!0}:(n("Extra parameters in font definition.",r,a),{face:t.face,weight:t.weight,style:t.style,decoration:t.decoration,size:s}):(n("Can't set just the size of the font since there is no default value.",r,a),{face:'"Times New Roman"',weight:"normal",style:"normal",decoration:"none",size:s})}if("*"===e[0].token){if(e.shift(),"number"===e[0].type)return s();n("Expected font size number after *.",r,a)}if("number"===e[0].type)return s();for(var l,h=[],u="normal",f="normal",d="none",p=!1,m="face",g=!1;e.length;){var v=e.shift(),b=v.token.toLowerCase();switch(m){case"face":g||"utf"!==b&&"number"!==v.type&&"bold"!==b&&"italic"!==b&&"underline"!==b&&"box"!==b?h.length>0&&"-"===v.token?(g=!0,h[h.length-1]=h[h.length-1]+v.token):g?(g=!1,h[h.length-1]=h[h.length-1]+v.token):h.push(v.token):"number"===v.type?(l?n("Font size specified twice in font definition.",r,a):l=v.token,m="modifier"):"bold"===b?u="bold":"italic"===b?f="italic":"underline"===b?d="underline":"box"===b?(o[i]?p=!0:n('This font style doesn\'t support "box"',r,a),m="finished"):"utf"===b?(v=e.shift(),m="size"):n("Unknown parameter "+v.token+" in font definition.",r,a);break;case"size":"number"===v.type?l?n("Font size specified twice in font definition.",r,a):l=v.token:n("Expected font size in font definition.",r,a),m="modifier";break;case"modifier":"bold"===b?u="bold":"italic"===b?f="italic":"underline"===b?d="underline":"box"===b?(o[i]?p=!0:n('This font style doesn\'t support "box"',r,a),m="finished"):n("Unknown parameter "+v.token+" in font definition.",r,a);break;case"finished":n('Extra characters found after "box" in font definition.',r,a)}}void 0===l?t?l=t.size:(n("Must specify the size of the font since there is no default value.",r,a),l=12):l=parseFloat(l),h=h.join(" ");var k=c(h),y={};return k?(y.face=k.face,y.weight=k.weight,y.style=k.style,y.decoration=k.decoration,y.size=l,p&&(y.box=!0),y):(y.face=h,y.weight=u,y.style=f,y.decoration=d,y.size=l,p&&(y.box=!0),y)},h=function(e,t,n){return 0===t.length?'Directive "'+e+'" requires a font as a parameter.':(i[e]=l(t,i[e],n,0,e),i.is_in_header&&(s.formatting[e]=i[e]),null)},u=function(e,t,n){return 0===t.length?'Directive "'+e+'" requires a font as a parameter.':(s.formatting[e]=l(t,s.formatting[e],n,0,e),null)},f=function(e,t){var n="";r.each(t,function(e){n+=e.token});var a=parseFloat(n);if(isNaN(a)||0===a)return'Directive "'+e+'" requires a number as a parameter.';s.formatting.scale=a},d=function(e,n){var r=t.getMeasurement(n);return 0===r.used||0!==n.length?{error:'Directive "'+e+'" requires a measurement as a parameter.'}:r.value},p=function(e,n){var r=t.getMeasurement(n);return 0===r.used||0!==n.length?'Directive "'+e+'" requires a measurement as a parameter.':(s.formatting[e]=r.value,null)},m=function(e,t,n,r,a){if(1!==n.length||"number"!==n[0].type)return'Directive "'+t+'" requires a number as a parameter.';var s=n[0].intt;return void 0!==r&&s<r?'Directive "'+t+'" requires a number greater than or equal to '+r+" as a parameter.":void 0!==a&&s>a?'Directive "'+t+'" requires a number less than or equal to '+a+" as a parameter.":(i[e]=s,null)},g=function(e,t,n){var r=m(e,t,n,0,1);return null!==r?r:(i[e]=1===i[e],null)},v=function(e,t,n,r){if(1!==n.length)return'Directive "'+t+'" requires one of [ '+r.join(", ")+" ] as a parameter.";for(var a=n[0].token,s=!1,o=0;!s&&o<r.length;o++)r[o]===a&&(s=!0);return s?(i[e]=a,null):'Directive "'+t+'" requires one of [ '+r.join(", ")+" ] as a parameter."},b=["nobarlines","barlines","beataccents","nobeataccents","droneon","droneoff","drumon","drumoff","fermatafixed","fermataproportional","gchordon","gchordoff","controlcombo","temperamentnormal","noportamento"],k=["gchord","ptstress","beatstring"],y=["bassvol","chordvol","c","channel","beatmod","deltaloudness","drumbars","gracedivider","makechordchannels","randomchordattack","chordattack","stressmodel","transpose","rtranspose","volinc"],_=["program"],w=["ratio","snt","bendvelocity","pitchbend","control","temperamentlinear"],x=["beat"],N=["drone"],A=["drummap","portamento"],T=["expand","grace","trim"],E=["drum","chordname"],S=function(e,t,r){var a=e.shift().token,i=[];if(b.indexOf(a)>=0)0!==e.length&&n("Unexpected parameter in MIDI "+a,r,0);else if(k.indexOf(a)>=0)1!==e.length?n("Expected one parameter in MIDI "+a,r,0):i.push(e[0].token);else if(y.indexOf(a)>=0)1!==e.length?n("Expected one parameter in MIDI "+a,r,0):"number"!==e[0].type?n("Expected one integer parameter in MIDI "+a,r,0):i.push(e[0].intt);else if(_.indexOf(a)>=0)1!==e.length&&2!==e.length?n("Expected one or two parameters in MIDI "+a,r,0):"number"!==e[0].type?n("Expected integer parameter in MIDI "+a,r,0):2===e.length&&"number"!==e[1].type?n("Expected integer parameter in MIDI "+a,r,0):(i.push(e[0].intt),2===e.length&&i.push(e[1].intt));else if(w.indexOf(a)>=0)2!==e.length?n("Expected two parameters in MIDI "+a,r,0):"number"!==e[0].type||"number"!==e[1].type?n("Expected two integer parameters in MIDI "+a,r,0):(i.push(e[0].intt),i.push(e[1].intt));else if(A.indexOf(a)>=0)2!==e.length?n("Expected two parameters in MIDI "+a,r,0):"alpha"!==e[0].type||"number"!==e[1].type?n("Expected one string and one integer parameters in MIDI "+a,r,0):(i.push(e[0].token),i.push(e[1].intt));else if(T.indexOf(a)>=0)3!==e.length?n("Expected fraction parameter in MIDI "+a,r,0):"number"!==e[0].type||"/"!==e[1].token||"number"!==e[2].type?n("Expected fraction parameter in MIDI "+a,r,0):(i.push(e[0].intt),i.push(e[2].intt));else if(x.indexOf(a)>=0)4!==e.length?n("Expected four parameters in MIDI "+a,r,0):"number"!==e[0].type||"number"!==e[1].type||"number"!==e[2].type||"number"!==e[3].type?n("Expected four integer parameters in MIDI "+a,r,0):(i.push(e[0].intt),i.push(e[1].intt),i.push(e[2].intt),i.push(e[3].intt));else if(N.indexOf(a)>=0)5!==e.length?n("Expected five parameters in MIDI "+a,r,0):"number"!==e[0].type||"number"!==e[1].type||"number"!==e[2].type||"number"!==e[3].type||"number"!==e[4].type?n("Expected five integer parameters in MIDI "+a,r,0):(i.push(e[0].intt),i.push(e[1].intt),i.push(e[2].intt),i.push(e[3].intt),i.push(e[4].intt));else if(_.indexOf(a)>=0)1!==e.length||4!==e.length?n("Expected one or two parameters in MIDI "+a,r,0):"number"!==e[0].type?n("Expected integer parameter in MIDI "+a,r,0):4===e.length?("octave"!==e[1].token&&n("Expected octave parameter in MIDI "+a,r,0),"="!==e[2].token&&n("Expected octave parameter in MIDI "+a,r,0),"number"!==e[3].type&&n("Expected integer parameter for octave in MIDI "+a,r,0)):(i.push(e[0].intt),4===e.length&&i.push(e[3].intt));else if(E.indexOf(a)>=0)if(e.length<2)n("Expected string parameter and at least one integer parameter in MIDI "+a,r,0);else if("alpha"!==e[0].type)n("Expected string parameter and at least one integer parameter in MIDI "+a,r,0);else{var s=e.shift();for(i.push(s.token);e.length>0;)"number"!==(s=e.shift()).type&&n("Expected integer parameter in MIDI "+a,r,0),i.push(s.intt)}t.hasBeginMusic()?t.appendElement("midi",-1,-1,{cmd:a,params:i}):(void 0===t.formatting.midi&&(t.formatting.midi={}),t.formatting.midi[a]=i)};a.parseFontChangeLine=function(e){var t=e.split("$");if(t.length>1&&i.setfont){for(var n=[{text:t[0]}],r=1;r<t.length;r++)"0"===t[r].charAt(0)?n.push({text:t[r].substring(1)}):"1"===t[r].charAt(0)&&i.setfont[1]?n.push({font:i.setfont[1],text:t[r].substring(1)}):"2"===t[r].charAt(0)&&i.setfont[2]?n.push({font:i.setfont[2],text:t[r].substring(1)}):"3"===t[r].charAt(0)&&i.setfont[3]?n.push({font:i.setfont[3],text:t[r].substring(1)}):"4"===t[r].charAt(0)&&i.setfont[4]?n.push({font:i.setfont[4],text:t[r].substring(1)}):n[n.length-1].text+="$"+t[r];if(n.length>1)return n}return e};var C=["auto","above","below","hidden"];a.addDirective=function(e){var o=t.tokenize(e,0,e.length);if(0===o.length||"alpha"!==o[0].type)return null;var c=e.substring(e.indexOf(o[0].token)+o[0].token.length);c=t.stripComment(c);var b=o.shift().token.toLowerCase(),k="";switch(b){case"bagpipes":s.formatting.bagpipes=!0;break;case"landscape":i.landscape=!0;break;case"papersize":i.papersize=c;break;case"slurgraces":s.formatting.slurgraces=!0;break;case"stretchlast":s.formatting.stretchlast=!0;break;case"titlecaps":i.titlecaps=!0;break;case"titleleft":s.formatting.titleleft=!0;break;case"measurebox":s.formatting.measurebox=!0;break;case"vocal":return v("vocalPosition",b,o,C);case"dynamic":return v("dynamicPosition",b,o,C);case"gchord":return v("chordPosition",b,o,C);case"ornament":return v("ornamentPosition",b,o,C);case"volume":return v("volumePosition",b,o,C);case"botmargin":case"botspace":case"composerspace":case"indent":case"leftmargin":case"linesep":case"musicspace":case"partsspace":case"pageheight":case"pagewidth":case"rightmargin":case"staffsep":case"staffwidth":case"subtitlespace":case"sysstaffsep":case"systemsep":case"textspace":case"titlespace":case"topmargin":case"topspace":case"vocalspace":case"wordsspace":return p(b,o);case"vskip":var y=d(b,o);return y.error?y.error:(s.addSpacing(y),null);case"scale":f(b,o);break;case"sep":if(0===o.length)s.addSeparator();else{var _=t.getMeasurement(o);if(0===_.used)return'Directive "'+b+'" requires 3 numbers: space above, space below, length of line';var w=_.value;if(0===(_=t.getMeasurement(o)).used)return'Directive "'+b+'" requires 3 numbers: space above, space below, length of line';var x=_.value;if(0===(_=t.getMeasurement(o)).used||0!==o.length)return'Directive "'+b+'" requires 3 numbers: space above, space below, length of line';var N=_.value;s.addSeparator(w,x,N)}break;case"barsperstaff":if(null!==(k=m("barsperstaff",b,o)))return k;break;case"staffnonote":if(null!==(k=g("staffnonote",b,o)))return k;break;case"printtempo":if(null!==(k=g("printTempo",b,o)))return k;break;case"partsbox":if(null!==(k=g("partsBox",b,o)))return k;break;case"measurenb":case"barnumbers":if(null!==(k=m("barNumbers",b,o)))return k;break;case"begintext":i.inTextBlock=!0;break;case"continueall":i.continueall=!0;break;case"beginps":i.inPsBlock=!0,n("Postscript ignored",e,0);break;case"deco":c.length>0&&i.ignoredDecorations.push(c.substring(0,c.indexOf(" "))),n("Decoration redefinition ignored",e,0);break;case"text":var A=t.translateString(c);s.addText(a.parseFontChangeLine(A));break;case"center":var T=t.translateString(c);s.addCentered(a.parseFontChangeLine(T));break;case"font":break;case"setfont":var E=t.tokenize(c,0,c.length);if(E.length>=4&&"-"===E[0].token&&"number"===E[1].type){var P=parseInt(E[1].token);P>=1&&P<=4&&(i.setfont||(i.setfont=[]),E.shift(),E.shift(),i.setfont[P]=l(E,i.setfont[P],e,0,"setfont"))}break;case"gchordfont":case"partsfont":case"vocalfont":case"textfont":case"annotationfont":case"historyfont":case"infofont":case"measurefont":case"repeatfont":case"wordsfont":return h(b,o,e);case"composerfont":case"subtitlefont":case"tempofont":case"titlefont":case"voicefont":case"footerfont":case"headerfont":return u(b,o,e);case"barlabelfont":case"barnumberfont":case"barnumfont":return h("measurefont",o,e);case"staves":case"score":i.score_is_present=!0;for(var I,B=function(e,t,n,a,s){(t||0===i.staves.length)&&i.staves.push({index:i.staves.length,numVoices:0});var o=r.last(i.staves);void 0!==n&&(o.bracket=n),void 0!==a&&(o.brace=a),s&&(o.connectBarLines="end"),void 0===i.voices[e]&&(i.voices[e]={staffNum:o.index,index:o.numVoices},o.numVoices++)},M=!1,D=!1,F=!1,L=!1,O=!1,V=!1,z=!1,W=function(){if(z=!0,I){var e="start";I.staffNum>0&&("start"!==i.staves[I.staffNum-1].connectBarLines&&"continue"!==i.staves[I.staffNum-1].connectBarLines||(e="continue")),i.staves[I.staffNum].connectBarLines=e}};o.length;){var q=o.shift();switch(q.token){case"(":M?n("Can't nest parenthesis in %%score",e,q.start):(M=!0,L=!0);break;case")":!M||L?n("Unexpected close parenthesis in %%score",e,q.start):M=!1;break;case"[":D?n("Can't nest brackets in %%score",e,q.start):(D=!0,O=!0);break;case"]":!D||O?n("Unexpected close bracket in %%score",e,q.start):(D=!1,i.staves[I.staffNum].bracket="end");break;case"{":F?n("Can't nest braces in %%score",e,q.start):(F=!0,V=!0);break;case"}":!F||V?n("Unexpected close brace in %%score",e,q.start):(F=!1,i.staves[I.staffNum].brace="end");break;case"|":W();break;default:for(var G="";("alpha"===q.type||"number"===q.type)&&(G+=q.token,q.continueId);)q=o.shift();B(G,!M||L,O?"start":D?"continue":void 0,V?"start":F?"continue":void 0,z),L=!1,O=!1,V=!1,z=!1,I=i.voices[G],"staves"===b&&W()}}break;case"newpage":var U=t.getInt(c);s.addNewPage(0===U.digits?-1:U.value);break;case"abc":var H=c.split(" ");switch(H[0]){case"-copyright":case"-creator":case"-edited-by":case"-version":case"-charset":var K=H.shift();s.addMetaText(b+K,H.join(" "));break;default:return"Unknown directive: "+b+H[0]}break;case"header":case"footer":var R=t.getMeat(c,0,c.length);'"'===(R=c.substring(R.start,R.end)).charAt(0)&&'"'===R.charAt(R.length-1)&&(R=R.substring(1,R.length-1));var j=R.split("\t"),Q={};Q=1===j.length?{left:"",center:j[0],right:""}:2===j.length?{left:j[0],center:j[1],right:""}:{left:j[0],center:j[1],right:j[2]},j.length>3&&n("Too many tabs in "+b+": "+j.length+" found.",c,0),s.addMetaTextObj(b,Q);break;case"midi":var Z=t.tokenize(c,0,c.length,!0);Z.length>0&&"="===Z[0].token&&Z.shift(),0===Z.length?n("Expected midi command",c,0):S(Z,s,c);break;case"playtempo":case"auquality":case"continuous":case"nobarcheck":s.formatting[b]=c;break;default:return"Unknown directive: "+b}return null},a.globalFormatting=function(e){for(var r in e)if(e.hasOwnProperty(r)){var a,i=""+e[r],s=t.tokenize(i,0,i.length);switch(r){case"titlefont":case"gchordfont":h(r,s,i);break;case"scale":f(r,s);break;case"partsbox":null!==(a=g("partsBox",r,s))&&n(a);break;default:n("Formatting directive unrecognized: ",r,0)}}}}(),t.exports=a},{"./abc_common":7}],10:[function(e,t,n){var r=e("./abc_common"),a=e("./abc_parse_directive"),i=e("./abc_parse_key_voice");t.exports=function(e,t,n,s){this.reset=function(e,t,n,r){i.initialize(e,t,n,r),a.initialize(e,t,n,r)},this.reset(e,t,n,s),this.setTitle=function(t){if(n.hasMainTitle)s.addSubtitle(e.translateString(e.stripComment(t)));else{var r=e.translateString(e.theReverser(e.stripComment(t)));n.titlecaps&&(r=r.toUpperCase()),s.addMetaText("title",r),n.hasMainTitle=!0}},this.setMeter=function(r){if("C"===(r=e.stripComment(r)))return!0===n.havent_set_length&&(n.default_length=.125,n.havent_set_length=!1),{type:"common_time"};if("C|"===r)return!0===n.havent_set_length&&(n.default_length=.125,n.havent_set_length=!1),{type:"cut_time"};if("o"===r)return!0===n.havent_set_length&&(n.default_length=.125,n.havent_set_length=!1),{type:"tempus_perfectum"};if("c"===r)return!0===n.havent_set_length&&(n.default_length=.125,n.havent_set_length=!1),{type:"tempus_imperfectum"};if("o."===r)return!0===n.havent_set_length&&(n.default_length=.125,n.havent_set_length=!1),{type:"tempus_perfectum_prolatio"};if("c."===r)return!0===n.havent_set_length&&(n.default_length=.125,n.havent_set_length=!1),{type:"tempus_imperfectum_prolatio"};if(0===r.length||"none"===r.toLowerCase())return!0===n.havent_set_length&&(n.default_length=.125,n.havent_set_length=!1),null;var a=e.tokenize(r,0,r.length);try{var i=function(){var e={value:0,num:""},t=a.shift();for("("===t.token&&(t=a.shift());;){if("number"!==t.type)throw"Expected top number of meter";if(e.value+=parseInt(t.token),e.num+=t.token,0===a.length||"/"===a[0].token)return e;if(")"===(t=a.shift()).token){if(0===a.length||"/"===a[0].token)return e;throw"Unexpected paren in meter"}if("."!==t.token&&"+"!==t.token)throw"Expected top number of meter";if(e.num+=t.token,0===a.length)throw"Expected top number of meter";t=a.shift()}return e},s=function(){var e=i();if(0===a.length)return e;var t=a.shift();if("/"!==t.token)throw"Expected slash in meter";if("number"!==(t=a.shift()).type)throw"Expected bottom number of meter";return e.den=t.token,e.value=e.value/parseInt(e.den),e};if(0===a.length)throw"Expected meter definition in M: line";for(var o={type:"specified",value:[]},c=0;;){var l=s();c+=l.value;var h={num:l.num};if(void 0!==l.den&&(h.den=l.den),o.value.push(h),0===a.length)break}return!0===n.havent_set_length&&(n.default_length=c<.75?.0625:.125,n.havent_set_length=!1),o}catch(e){t(e,r,0)}return null},this.calcTempo=function(e){var t=.25;n.meter&&"specified"===n.meter.type?t=1/parseInt(n.meter.value[0].den):n.origMeter&&"specified"===n.origMeter.type&&(t=1/parseInt(n.origMeter.value[0].den));for(var r=0;r<e.duration;r++)e.duration[r]=t*e.duration[r];return e},this.resolveTempo=function(){n.tempo&&(this.calcTempo(n.tempo),s.metaText.tempo=n.tempo,delete n.tempo)},this.addUserDefinition=function(e,a,i){var s=e.indexOf("=",a);if(-1!==s){var o=r.strip(e.substring(a,s)),c=r.strip(e.substring(s+1));1===o.length?-1!=="HIJKLMNOPQRSTUVWXYhijklmnopqrstuvw~".indexOf(o)?0!==c.length?(void 0===n.macros&&(n.macros={}),n.macros[o]=c):t("Missing macro definition",e,a):t("Macro definitions must be H-Y, h-w, or tilde",e,a):t("Macro definitions can only be one character",e,a)}else t("Need an = in a macro definition",e,a)},this.setDefaultLength=function(e,t,a){var i=r.gsub(e.substring(t,a)," ","").split("/");if(2===i.length){var s=parseInt(i[0]),o=parseInt(i[1]);o>0&&(n.default_length=s/o,n.havent_set_length=!1)}else 1===i.length&&"1"===i[0]&&(n.default_length=1,n.havent_set_length=!1)},this.setTempo=function(r,a,i){try{var s=e.tokenize(r,a,i);if(0===s.length)throw"Missing parameter in Q: field";var o={},c=!0,l=s.shift();if("quote"===l.type&&(o.preString=l.token,l=s.shift(),0===s.length))return{type:"immediate",tempo:o};if("alpha"===l.type&&"C"===l.token){if(0===s.length)throw"Missing tempo after C in Q: field";if("punct"===(l=s.shift()).type&&"="===l.token){if(0===s.length)throw"Missing tempo after = in Q: field";if("number"!==(l=s.shift()).type)throw"Expected number after = in Q: field";o.duration=[1],o.bpm=parseInt(l.token)}else{if("number"!==l.type)throw"Expected number or equal after C in Q: field";if(o.duration=[parseInt(l.token)],0===s.length)throw"Missing = after duration in Q: field";if("punct"!==(l=s.shift()).type||"="!==l.token)throw"Expected = after duration in Q: field";if(0===s.length)throw"Missing tempo after = in Q: field";if("number"!==(l=s.shift()).type)throw"Expected number after = in Q: field";o.bpm=parseInt(l.token)}}else{if("number"!==l.type)throw"Unknown value in Q: field";var h=parseInt(l.token);if(0===s.length||"quote"===s[0].type)o.duration=[1],o.bpm=h;else{if(c=!1,"punct"!==(l=s.shift()).type&&"/"!==l.token)throw"Expected fraction in Q: field";if("number"!==(l=s.shift()).type)throw"Expected fraction in Q: field";var u=parseInt(l.token);for(o.duration=[h/u];s.length>0&&"="!==s[0].token&&"quote"!==s[0].type;){if("number"!==(l=s.shift()).type)throw"Expected fraction in Q: field";if(h=parseInt(l.token),"punct"!==(l=s.shift()).type&&"/"!==l.token)throw"Expected fraction in Q: field";if("number"!==(l=s.shift()).type)throw"Expected fraction in Q: field";u=parseInt(l.token),o.duration.push(h/u)}if("punct"!==(l=s.shift()).type&&"="!==l.token)throw"Expected = in Q: field";if("number"!==(l=s.shift()).type)throw"Expected tempo in Q: field";o.bpm=parseInt(l.token)}}if(0!==s.length&&("quote"===(l=s.shift()).type&&(o.postString=l.token,l=s.shift()),0!==s.length))throw"Unexpected string at end of Q: field";return!1===n.printTempo&&(o.suppress=!0),{type:c?"delaySet":"immediate",tempo:o}}catch(e){return t(e,r,a),{type:"none"}}},this.letter_to_inline_header=function(r,o){var c=e.eatWhiteSpace(r,o);if(o+=c,r.length>=o+5&&"["===r.charAt(o)&&":"===r.charAt(o+2)){var l=r.indexOf("]",o);switch(r.substring(o,o+3)){case"[I:":var h=a.addDirective(r.substring(o+3,l));return h&&t(h,r,o),[l-o+1+c];case"[M:":var u=this.setMeter(r.substring(o+3,l));return s.hasBeginMusic()&&u?s.appendStartingElement("meter",-1,-1,u):n.meter=u,[l-o+1+c];case"[K:":var f=i.parseKey(r.substring(o+3,l));return f.foundClef&&s.hasBeginMusic()&&s.appendStartingElement("clef",-1,-1,n.clef),f.foundKey&&s.hasBeginMusic()&&s.appendStartingElement("key",-1,-1,i.fixKey(n.clef,n.key)),[l-o+1+c];case"[P:":return s.lines.length<=s.lineNum?n.partForNextLine=r.substring(o+3,l):s.appendElement("part",-1,-1,{title:r.substring(o+3,l)}),[l-o+1+c];case"[L:":return this.setDefaultLength(r,o+3,l),[l-o+1+c];case"[Q:":if(l>0){var d=this.setTempo(r,o+3,l);return"delaySet"===d.type?s.appendElement("tempo",-1,-1,this.calcTempo(d.tempo)):"immediate"===d.type&&s.appendElement("tempo",-1,-1,d.tempo),[l-o+1+c,r.charAt(o+1),r.substring(o+3,l)]}break;case"[V:":if(l>0)return i.parseVoice(r,o+3,l),[l-o+1+c,r.charAt(o+1),r.substring(o+3,l)]}}return[0]},this.letter_to_body_header=function(e,o){if(e.length>=o+3)switch(e.substring(o,o+2)){case"I:":var c=a.addDirective(e.substring(o+2));return c&&t(c,e,o),[e.length];case"M:":var l=this.setMeter(e.substring(o+2));return s.hasBeginMusic()&&l&&s.appendStartingElement("meter",-1,-1,l),[e.length];case"K:":var h=i.parseKey(e.substring(o+2));return h.foundClef&&s.hasBeginMusic()&&s.appendStartingElement("clef",-1,-1,n.clef),h.foundKey&&s.hasBeginMusic()&&s.appendStartingElement("key",-1,-1,i.fixKey(n.clef,n.key)),[e.length];case"P:":return s.hasBeginMusic()&&s.appendElement("part",-1,-1,{title:e.substring(o+2)}),[e.length];case"L:":return this.setDefaultLength(e,o+2,e.length),[e.length];case"Q:":var u=e.indexOf("",o+2);-1===u&&(u=e.length);var f=this.setTempo(e,o+2,u);return"delaySet"===f.type?s.appendElement("tempo",-1,-1,this.calcTempo(f.tempo)):"immediate"===f.type&&s.appendElement("tempo",-1,-1,f.tempo),[u,e.charAt(o),r.strip(e.substring(o+2))];case"V:":return i.parseVoice(e,2,e.length),[e.length,e.charAt(o),r.strip(e.substring(o+2))]}return[0]};var o={A:"author",B:"book",C:"composer",D:"discography",F:"url",G:"group",I:"instruction",N:"notes",O:"origin",R:"rhythm",S:"source",W:"unalignedWords",Z:"transcription"};this.parseHeader=function(c){if(r.startsWith(c,"%%")){var l=a.addDirective(c.substring(2));return l&&t(l,c,2),{}}var h=c.indexOf("%");if(h>=0&&(c=c.substring(0,h)),0===(c=c.replace(/\s+$/,"")).length)return{};if(c.length>=2&&":"===c.charAt(1)){var u="";c.indexOf("")>=0&&"w"!==c.charAt(0)&&(u=c.substring(c.indexOf("")+1),c=c.substring(0,c.indexOf("")));var f=o[c.charAt(0)];if(void 0!==f)return"unalignedWords"===f?s.addMetaTextArray(f,a.parseFontChangeLine(e.translateString(e.stripComment(c.substring(2))))):s.addMetaText(f,e.translateString(e.stripComment(c.substring(2)))),{};switch(c.charAt(0)){case"H":s.addMetaText("history",e.translateString(e.stripComment(c.substring(2)))),n.is_in_history=!0;break;case"K":this.resolveTempo();var d=i.parseKey(c.substring(2));!n.is_in_header&&s.hasBeginMusic()&&(d.foundClef&&s.appendStartingElement("clef",-1,-1,n.clef),d.foundKey&&s.appendStartingElement("key",-1,-1,i.fixKey(n.clef,n.key))),n.is_in_header=!1;break;case"L":this.setDefaultLength(c,2,c.length);break;case"M":n.origMeter=n.meter=this.setMeter(c.substring(2));break;case"P":n.is_in_header?s.addMetaText("partOrder",e.translateString(e.stripComment(c.substring(2)))):n.partForNextLine=e.translateString(e.stripComment(c.substring(2)));break;case"Q":var p=this.setTempo(c,2,c.length);"delaySet"===p.type?n.tempo=p.tempo:"immediate"===p.type&&(s.metaText.tempo=p.tempo);break;case"T":this.setTitle(c.substring(2));break;case"U":this.addUserDefinition(c,2,c.length);break;case"V":if(i.parseVoice(c,2,c.length),!n.is_in_header)return{newline:!0};break;case"s":return{symbols:!0};case"w":return{words:!0};case"X":break;case"E":case"m":t("Ignored header",c,0);break;default:return u.length&&(u=""+u),{regular:!0,str:c+u}}return u.length>0?{recurse:!0,str:u}:{}}return{regular:!0,str:c}}}},{"./abc_common":7,"./abc_parse_directive":9,"./abc_parse_key_voice":11}],11:[function(e,t,n){var r=e("./abc_common"),a=e("./abc_parse_directive"),i={};!function(){var e,t,n,s;i.initialize=function(r,a,i,o){e=r,t=a,n=i,s=o},i.standardKey=function(e){var t={acc:"sharp",note:"f"},n={acc:"sharp",note:"c"},r={acc:"sharp",note:"g"},a={acc:"sharp",note:"d"},i={acc:"sharp",note:"A"},s={acc:"sharp",note:"e"},o={acc:"sharp",note:"B"},c={acc:"flat",note:"B"},l={acc:"flat",note:"e"},h={acc:"flat",note:"A"},u={acc:"flat",note:"d"},f={acc:"flat",note:"G"},d={acc:"flat",note:"c"},p={acc:"flat",note:"F"};return{"C#":[t,n,r,a,i,s,o],"A#m":[t,n,r,a,i,s,o],"G#Mix":[t,n,r,a,i,s,o],"D#Dor":[t,n,r,a,i,s,o],"E#Phr":[t,n,r,a,i,s,o],"F#Lyd":[t,n,r,a,i,s,o],"B#Loc":[t,n,r,a,i,s,o],"F#":[t,n,r,a,i,s],"D#m":[t,n,r,a,i,s],"C#Mix":[t,n,r,a,i,s],"G#Dor":[t,n,r,a,i,s],"A#Phr":[t,n,r,a,i,s],BLyd:[t,n,r,a,i,s],"E#Loc":[t,n,r,a,i,s],B:[t,n,r,a,i],"G#m":[t,n,r,a,i],"F#Mix":[t,n,r,a,i],"C#Dor":[t,n,r,a,i],"D#Phr":[t,n,r,a,i],ELyd:[t,n,r,a,i],"A#Loc":[t,n,r,a,i],E:[t,n,r,a],"C#m":[t,n,r,a],BMix:[t,n,r,a],"F#Dor":[t,n,r,a],"G#Phr":[t,n,r,a],ALyd:[t,n,r,a],"D#Loc":[t,n,r,a],A:[t,n,r],"F#m":[t,n,r],EMix:[t,n,r],BDor:[t,n,r],"C#Phr":[t,n,r],DLyd:[t,n,r],"G#Loc":[t,n,r],D:[t,n],Bm:[t,n],AMix:[t,n],EDor:[t,n],"F#Phr":[t,n],GLyd:[t,n],"C#Loc":[t,n],G:[t],Em:[t],DMix:[t],ADor:[t],BPhr:[t],CLyd:[t],"F#Loc":[t],C:[],Am:[],GMix:[],DDor:[],EPhr:[],FLyd:[],BLoc:[],F:[c],Dm:[c],CMix:[c],GDor:[c],APhr:[c],BbLyd:[c],ELoc:[c],Bb:[c,l],Gm:[c,l],FMix:[c,l],CDor:[c,l],DPhr:[c,l],EbLyd:[c,l],ALoc:[c,l],Eb:[c,l,h],Cm:[c,l,h],BbMix:[c,l,h],FDor:[c,l,h],GPhr:[c,l,h],AbLyd:[c,l,h],DLoc:[c,l,h],Ab:[c,l,h,u],Fm:[c,l,h,u],EbMix:[c,l,h,u],BbDor:[c,l,h,u],CPhr:[c,l,h,u],DbLyd:[c,l,h,u],GLoc:[c,l,h,u],Db:[c,l,h,u,f],Bbm:[c,l,h,u,f],AbMix:[c,l,h,u,f],EbDor:[c,l,h,u,f],FPhr:[c,l,h,u,f],GbLyd:[c,l,h,u,f],CLoc:[c,l,h,u,f],Gb:[c,l,h,u,f,d],Ebm:[c,l,h,u,f,d],DbMix:[c,l,h,u,f,d],AbDor:[c,l,h,u,f,d],BbPhr:[c,l,h,u,f,d],CbLyd:[c,l,h,u,f,d],FLoc:[c,l,h,u,f,d],Cb:[c,l,h,u,f,d,p],Abm:[c,l,h,u,f,d,p],GbMix:[c,l,h,u,f,d,p],DbDor:[c,l,h,u,f,d,p],EbPhr:[c,l,h,u,f,d,p],FbLyd:[c,l,h,u,f,d,p],BbLoc:[c,l,h,u,f,d,p],"A#":[c,l],"B#":[],"D#":[c,l,h],"E#":[c],"G#":[c,l,h,u],Gbm:[t,n,r,a,i,s,o]}[e]};var o={treble:{clef:"treble",pitch:4,mid:0},"treble+8":{clef:"treble+8",pitch:4,mid:0},"treble-8":{clef:"treble-8",pitch:4,mid:0},treble1:{clef:"treble",pitch:2,mid:2},treble2:{clef:"treble",pitch:4,mid:0},treble3:{clef:"treble",pitch:6,mid:-2},treble4:{clef:"treble",pitch:8,mid:-4},treble5:{clef:"treble",pitch:10,mid:-6},perc:{clef:"perc",pitch:6,mid:0},none:{clef:"none",mid:0},bass:{clef:"bass",pitch:8,mid:-12},"bass+8":{clef:"bass+8",pitch:8,mid:-12},"bass-8":{clef:"bass-8",pitch:8,mid:-12},"bass+16":{clef:"bass",pitch:8,mid:-12},"bass-16":{clef:"bass",pitch:8,mid:-12},bass1:{clef:"bass",pitch:2,mid:-6},bass2:{clef:"bass",pitch:4,mid:-8},bass3:{clef:"bass",pitch:6,mid:-10},bass4:{clef:"bass",pitch:8,mid:-12},bass5:{clef:"bass",pitch:10,mid:-14},tenor:{clef:"alto",pitch:8,mid:-8},tenor1:{clef:"alto",pitch:2,mid:-2},tenor2:{clef:"alto",pitch:4,mid:-4},tenor3:{clef:"alto",pitch:6,mid:-6},tenor4:{clef:"alto",pitch:8,mid:-8},tenor5:{clef:"alto",pitch:10,mid:-10},alto:{clef:"alto",pitch:6,mid:-6},alto1:{clef:"alto",pitch:2,mid:-2},alto2:{clef:"alto",pitch:4,mid:-4},alto3:{clef:"alto",pitch:6,mid:-6},alto4:{clef:"alto",pitch:8,mid:-8},alto5:{clef:"alto",pitch:10,mid:-10},"alto+8":{clef:"alto+8",pitch:6,mid:-6},"alto-8":{clef:"alto-8",pitch:6,mid:-6}},c=function(e,t){var n=o[e];return(n?n.mid:0)+t};i.fixClef=function(e){var t=o[e.type];t&&(e.clefPos=t.pitch,e.type=t.clef)},i.deepCopyKey=function(e){var t={accidentals:[],root:e.root,acc:e.acc,mode:e.mode};return r.each(e.accidentals,function(e){t.accidentals.push(r.clone(e))}),t};var l={A:5,B:6,C:0,D:1,E:2,F:3,G:4,a:12,b:13,c:7,d:8,e:9,f:10,g:11};i.addPosToKey=function(e,t){var n=e.verticalPos;r.each(t.accidentals,function(e){var t=l[e.note];t-=n,e.verticalPos=t}),t.impliedNaturals&&r.each(t.impliedNaturals,function(e){var t=l[e.note];t-=n,e.verticalPos=t}),n<-10?(r.each(t.accidentals,function(e){e.verticalPos-=7,(e.verticalPos>=11||10===e.verticalPos&&"flat"===e.acc)&&(e.verticalPos-=7),"A"===e.note&&"sharp"===e.acc&&(e.verticalPos-=7),"G"!==e.note&&"F"!==e.note||"flat"!==e.acc||(e.verticalPos-=7)}),t.impliedNaturals&&r.each(t.impliedNaturals,function(e){e.verticalPos-=7,(e.verticalPos>=11||10===e.verticalPos&&"flat"===e.acc)&&(e.verticalPos-=7),"A"===e.note&&"sharp"===e.acc&&(e.verticalPos-=7),"G"!==e.note&&"F"!==e.note||"flat"!==e.acc||(e.verticalPos-=7)})):n<-4?(r.each(t.accidentals,function(e){e.verticalPos-=7,-8!==n||"f"!==e.note&&"g"!==e.note||"sharp"!==e.acc||(e.verticalPos-=7)}),t.impliedNaturals&&r.each(t.impliedNaturals,function(e){e.verticalPos-=7,-8!==n||"f"!==e.note&&"g"!==e.note||"sharp"!==e.acc||(e.verticalPos-=7)})):n>=7&&(r.each(t.accidentals,function(e){e.verticalPos+=7}),t.impliedNaturals&&r.each(t.impliedNaturals,function(e){e.verticalPos+=7}))},i.fixKey=function(e,t){var n=r.clone(t);return i.addPosToKey(e,n),n};var h=function(e){for(var t=l[e.charAt(0)],n=1;n<e.length;n++)if(","===e.charAt(n))t-=7;else{if(","!==e.charAt(n))break;t+=7}return{mid:t-6,str:e.substring(n)}},u=function(e){for(var t=0;t<e.length;t++)"b"===e[t].note?e[t].note="B":"a"===e[t].note?e[t].note="A":"F"===e[t].note?e[t].note="f":"E"===e[t].note?e[t].note="e":"D"===e[t].note?e[t].note="d":"C"===e[t].note?e[t].note="c":"G"===e[t].note&&"sharp"===e[t].acc?e[t].note="g":"g"===e[t].note&&"flat"===e[t].acc&&(e[t].note="G")};i.parseKey=function(r){0===r.length&&(r="none");var s=e.tokenize(r,0,r.length),o={};switch(s[0].token){case"HP":a.addDirective("bagpipes"),n.key={root:"HP",accidentals:[],acc:"",mode:""},o.foundKey=!0,s.shift();break;case"Hp":a.addDirective("bagpipes"),n.key={root:"Hp",accidentals:[{acc:"natural",note:"g"},{acc:"sharp",note:"f"},{acc:"sharp",note:"c"}],acc:"",mode:""},o.foundKey=!0,s.shift();break;case"none":n.key={root:"none",accidentals:[],acc:"",mode:""},o.foundKey=!0,s.shift();break;default:var l=e.getKeyPitch(s[0].token);if(l.len>0){o.foundKey=!0;var h="",f="";s[0].token.length>1?s[0].token=s[0].token.substring(1):s.shift();var d=l.token;if(s.length>0){var p=e.getSharpFlat(s[0].token);if(p.len>0&&(s[0].token.length>1?s[0].token=s[0].token.substring(1):s.shift(),d+=p.token,h=p.token),s.length>0){var m=e.getMode(s[0].token);m.len>0&&(s.shift(),d+=m.token,f=m.token)}if(void 0===i.standardKey(d))return t("Unsupported key signature: "+d,r,0),o}var g=i.deepCopyKey(n.key);if(n.key=i.deepCopyKey({accidentals:i.standardKey(d)}),n.key.root=l.token,n.key.acc=h,n.key.mode=f,g){for(var v,b=0;b<n.key.accidentals.length;b++)for(v=0;v<g.accidentals.length;v++)g.accidentals[v].note&&n.key.accidentals[b].note.toLowerCase()===g.accidentals[v].note.toLowerCase()&&(g.accidentals[v].note=null);for(v=0;v<g.accidentals.length;v++)g.accidentals[v].note&&(n.key.impliedNaturals||(n.key.impliedNaturals=[]),n.key.impliedNaturals.push({acc:"natural",note:g.accidentals[v].note}))}}}if(0===s.length)return o;if("exp"===s[0].token&&s.shift(),0===s.length)return o;if("oct"===s[0].token&&s.shift(),0===s.length)return o;var k=e.getKeyAccidentals2(s);if(k.warn&&t(k.warn,r,0),k.accs){o.foundKey||(o.foundKey=!0,n.key={root:"none",acc:"",mode:"",accidentals:[]}),u(k.accs);for(var y=0;y<k.accs.length;y++){for(var _=!1,w=0;w<n.key.accidentals.length&&!_;w++)n.key.accidentals[w].note===k.accs[y].note&&(_=!0,n.key.accidentals[w].acc=k.accs[y].acc);if(!_&&(n.key.accidentals.push(k.accs[y]),n.key.impliedNaturals))for(var x=0;x<n.key.impliedNaturals.length;x++)n.key.impliedNaturals[x].note===k.accs[y].note&&n.key.impliedNaturals.splice(x,1)}}for(var N;s.length>0;)switch(s[0].token){case"m":case"middle":if(s.shift(),0===s.length)return t("Expected = after middle",r,0),o;if("="!==(N=s.shift()).token){t("Expected = after middle",r,N.start);break}if(0===s.length)return t("Expected parameter after middle=",r,0),o;var A=e.getPitchFromTokens(s);A.warn&&t(A.warn,r,0),A.position&&(n.clef.verticalPos=A.position-6);break;case"transpose":if(s.shift(),0===s.length)return t("Expected = after transpose",r,0),o;if("="!==(N=s.shift()).token){t("Expected = after transpose",r,N.start);break}if(0===s.length)return t("Expected parameter after transpose=",r,0),o;if("number"!==s[0].type){t("Expected number after transpose",r,s[0].start);break}n.clef.transpose=s[0].intt,s.shift();break;case"stafflines":if(s.shift(),0===s.length)return t("Expected = after stafflines",r,0),o;if("="!==(N=s.shift()).token){t("Expected = after stafflines",r,N.start);break}if(0===s.length)return t("Expected parameter after stafflines=",r,0),o;if("number"!==s[0].type){t("Expected number after stafflines",r,s[0].start);break}n.clef.stafflines=s[0].intt,s.shift();break;case"staffscale":if(s.shift(),0===s.length)return t("Expected = after staffscale",r,0),o;if("="!==(N=s.shift()).token){t("Expected = after staffscale",r,N.start);break}if(0===s.length)return t("Expected parameter after staffscale=",r,0),o;if("number"!==s[0].type){t("Expected number after staffscale",r,s[0].start);break}n.clef.staffscale=s[0].floatt,s.shift();break;case"style":if(s.shift(),0===s.length)return t("Expected = after style",r,0),o;if("="!==(N=s.shift()).token){t("Expected = after style",r,N.start);break}if(0===s.length)return t("Expected parameter after style=",r,0),o;switch(s[0].token){case"normal":case"harmonic":case"rhythm":case"x":n.style=s[0].token,s.shift();break;default:t("error parsing style element: "+s[0].token,r,s[0].start)}break;case"clef":if(s.shift(),0===s.length)return t("Expected = after clef",r,0),o;if("="!==(N=s.shift()).token){t("Expected = after clef",r,N.start);break}if(0===s.length)return t("Expected parameter after clef=",r,0),o;case"treble":case"bass":case"alto":case"tenor":case"perc":var T=s.shift();switch(T.token){case"treble":case"tenor":case"alto":case"bass":case"perc":case"none":break;case"C":T.token="alto";break;case"F":T.token="bass";break;case"G":T.token="treble";break;case"c":T.token="alto";break;case"f":T.token="bass";break;case"g":T.token="treble";break;default:t("Expected clef name. Found "+T.token,r,T.start)}s.length>0&&"number"===s[0].type&&(T.token+=s[0].token,s.shift()),s.length>1&&("-"===s[0].token||"+"===s[0].token)&&"8"===s[1].token&&(T.token+=s[0].token+s[1].token,s.shift(),s.shift()),n.clef={type:T.token,verticalPos:c(T.token,0)},n.currentVoice&&void 0!==n.currentVoice.transpose&&(n.clef.transpose=n.currentVoice.transpose),o.foundClef=!0;break;default:t("Unknown parameter: "+s[0].token,r,s[0].start),s.shift()}return o};var f=function(e){n.currentVoice=n.voices[e],s.setCurrentVoice(n.currentVoice.staffNum,n.currentVoice.index)};i.parseVoice=function(r,a,i){var s=e.getMeat(r,a,i),o=s.start,l=s.end,u=e.getToken(r,o,l);if(0!==u.length){var d=!1;void 0===n.voices[u]&&(n.voices[u]={},d=!0,n.score_is_present&&t("Can't have an unknown V: id when the %score directive is present",r,o)),o+=u.length,o+=e.eatWhiteSpace(r,o);for(var p={startStaff:d},m=function(n){var a=e.getVoiceToken(r,o,l);void 0!==a.warn?t("Expected value for "+n+" in voice: "+a.warn,r,o):0===a.token.length&&'"'!==r.charAt(o)?t("Expected value for "+n+" in voice",r,o):p[n]=a.token,o+=a.len},g=function(a,i,s){var c=e.getVoiceToken(r,o,l);void 0!==c.warn?t("Expected value for "+i+" in voice: "+c.warn,r,o):0===c.token.length&&'"'!==r.charAt(o)?t("Expected value for "+i+" in voice",r,o):("number"===s&&(c.token=parseFloat(c.token)),n.voices[a][i]=c.token),o+=c.len};o<l;){var v=e.getVoiceToken(r,o,l);if(o+=v.len,v.warn)t("Error parsing voice: "+v.warn,r,o);else{var b=null;switch(v.token){case"clef":case"cl":m("clef");var k=0;void 0!==p.clef&&(p.clef=p.clef.replace(/[',]/g,""),-1!==p.clef.indexOf("+16")&&(k+=14,p.clef=p.clef.replace("+16","")),p.verticalPos=c(p.clef,k));break;case"treble":case"bass":case"tenor":case"alto":case"none":case"treble'":case"bass'":case"tenor'":case"alto'":case"none'":case"treble''":case"bass''":case"tenor''":case"alto''":case"none''":case"treble,":case"bass,":case"tenor,":case"alto,":case"none,":case"treble,,":case"bass,,":case"tenor,,":case"alto,,":case"none,,":p.clef=v.token.replace(/[',]/g,""),p.verticalPos=c(p.clef,0);break;case"staves":case"stave":case"stv":m("staves");break;case"brace":case"brc":m("brace");break;case"bracket":case"brk":m("bracket");break;case"name":case"nm":m("name");break;case"subname":case"sname":case"snm":m("subname");break;case"merge":p.startStaff=!1;break;case"stems":void 0!==(b=e.getVoiceToken(r,o,l)).warn?t("Expected value for stems in voice: "+b.warn,r,o):"up"===b.token||"down"===b.token?n.voices[u].stem=b.token:t("Expected up or down for voice stem",r,o),o+=b.len;break;case"up":case"down":n.voices[u].stem=v.token;break;case"middle":case"m":m("verticalPos"),p.verticalPos=h(p.verticalPos).mid;break;case"gchords":case"gch":n.voices[u].suppressChords=!0;break;case"space":case"spc":m("spacing");break;case"scale":g(u,"scale","number");break;case"transpose":g(u,"transpose","number")}}o+=e.eatWhiteSpace(r,o)}if((p.startStaff||0===n.staves.length)&&(n.staves.push({index:n.staves.length,meter:n.origMeter}),n.score_is_present||(n.staves[n.staves.length-1].numVoices=0)),void 0===n.voices[u].staffNum){n.voices[u].staffNum=n.staves.length-1;var y=0;for(var _ in n.voices)n.voices.hasOwnProperty(_)&&n.voices[_].staffNum===n.voices[u].staffNum&&y++;n.voices[u].index=y-1}var w=n.staves[n.voices[u].staffNum];n.score_is_present||w.numVoices++,p.clef&&(w.clef={type:p.clef,verticalPos:p.verticalPos}),p.spacing&&(w.spacing_below_offset=p.spacing),p.verticalPos&&(w.verticalPos=p.verticalPos),p.name&&(w.name?w.name.push(p.name):w.name=[p.name]),p.subname&&(w.subname?w.subname.push(p.subname):w.subname=[p.subname]),f(u)}else t("Expected a voice id",r,o)}}(),t.exports=i},{"./abc_common":7,"./abc_parse_directive":9}],12:[function(e,t,n){var r=e("./abc_common");t.exports=function(){this.skipWhiteSpace=function(e){for(var t=0;t<e.length;t++)if(!this.isWhiteSpace(e.charAt(t)))return t;return e.length};var e=function(e,t){return t>=e.length};this.eatWhiteSpace=function(e,t){for(var n=t;n<e.length;n++)if(!this.isWhiteSpace(e.charAt(n)))return n-t;return n-t},this.getKeyPitch=function(t){var n=this.skipWhiteSpace(t);if(e(t,n))return{len:0};switch(t.charAt(n)){case"A":return{len:n+1,token:"A"};case"B":return{len:n+1,token:"B"};case"C":return{len:n+1,token:"C"};case"D":return{len:n+1,token:"D"};case"E":return{len:n+1,token:"E"};case"F":return{len:n+1,token:"F"};case"G":return{len:n+1,token:"G"}}return{len:0}},this.getSharpFlat=function(e){if("bass"===e)return{len:0};switch(e.charAt(0)){case"#":return{len:1,token:"#"};case"b":return{len:1,token:"b"}}return{len:0}},this.getMode=function(t){var n=function(e,t){for(;t<e.length&&(e.charAt(t)>="a"&&e.charAt(t)<="z"||e.charAt(t)>="A"&&e.charAt(t)<="Z");)t++;return t},r=this.skipWhiteSpace(t);if(e(t,r))return{len:0};var a=t.substring(r,r+3).toLowerCase();switch((a.length>1&&" "===a.charAt(1)||"^"===a.charAt(1)||"_"===a.charAt(1)||"="===a.charAt(1))&&(a=a.charAt(0)),a){case"mix":return{len:n(t,r),token:"Mix"};case"dor":return{len:n(t,r),token:"Dor"};case"phr":return{len:n(t,r),token:"Phr"};case"lyd":return{len:n(t,r),token:"Lyd"};case"loc":return{len:n(t,r),token:"Loc"};case"aeo":return{len:n(t,r),token:"m"};case"maj":case"ion":return{len:n(t,r),token:""};case"min":case"m":return{len:n(t,r),token:"m"}}return{len:0}},this.getClef=function(t,n){var a=t,i=this.skipWhiteSpace(t);if(e(t,i))return{len:0};var s=!1,o=t.substring(i);if(r.startsWith(o,"clef=")&&(s=!0,o=o.substring(5),i+=5),0===o.length&&s)return{len:i+5,warn:"No clef specified: "+a};var c=this.skipWhiteSpace(o);if(e(o,c))return{len:0};c>0&&(i+=c,o=o.substring(c));var l=null;if(r.startsWith(o,"treble"))l="treble";else if(r.startsWith(o,"bass3"))l="bass3";else if(r.startsWith(o,"bass"))l="bass";else if(r.startsWith(o,"tenor"))l="tenor";else if(r.startsWith(o,"alto2"))l="alto2";else if(r.startsWith(o,"alto1"))l="alto1";else if(r.startsWith(o,"alto"))l="alto";else if(!n&&s&&r.startsWith(o,"none"))l="none";else if(r.startsWith(o,"perc"))l="perc";else if(!n&&s&&r.startsWith(o,"C"))l="tenor";else if(!n&&s&&r.startsWith(o,"F"))l="bass";else{if(n||!s||!r.startsWith(o,"G"))return{len:i+5,warn:"Unknown clef specified: "+a};l="treble"}return o=o.substring(l.length),(c=this.isMatch(o,"+8"))>0?l+="+8":(c=this.isMatch(o,"-8"))>0&&(l+="-8"),{len:i+l.length,token:l,explicit:s}},this.getBarLine=function(e,t){switch(e.charAt(t)){case"]":switch(++t,e.charAt(t)){case"|":return{len:2,token:"bar_thick_thin"};case"[":return++t,e.charAt(t)>="1"&&e.charAt(t)<="9"||'"'===e.charAt(t)?{len:2,token:"bar_invisible"}:{len:1,warn:"Unknown bar symbol"};default:return{len:1,token:"bar_invisible"}}break;case":":switch(++t,e.charAt(t)){case":":return{len:2,token:"bar_dbl_repeat"};case"|":switch(++t,e.charAt(t)){case"]":switch(++t,e.charAt(t)){case"|":return++t,":"===e.charAt(t)?{len:5,token:"bar_dbl_repeat"}:{len:3,token:"bar_right_repeat"};default:return{len:3,token:"bar_right_repeat"}}break;case"|":return++t,":"===e.charAt(t)?{len:4,token:"bar_dbl_repeat"}:{len:3,token:"bar_right_repeat"};default:return{len:2,token:"bar_right_repeat"}}break;default:return{len:1,warn:"Unknown bar symbol"}}break;case"[":if(++t,"|"!==e.charAt(t))return e.charAt(t)>="1"&&e.charAt(t)<="9"||'"'===e.charAt(t)?{len:1,token:"bar_invisible"}:{len:0};switch(++t,e.charAt(t)){case":":return{len:3,token:"bar_left_repeat"};case"]":return{len:3,token:"bar_invisible"};default:return{len:2,token:"bar_thick_thin"}}break;case"|":switch(++t,e.charAt(t)){case"]":return{len:2,token:"bar_thin_thick"};case"|":return++t,":"===e.charAt(t)?{len:3,token:"bar_left_repeat"}:{len:2,token:"bar_thin_thin"};case":":for(var n=0;":"===e.charAt(t+n);)n++;return{len:1+n,token:"bar_left_repeat"};default:return{len:1,token:"bar_thin"}}}return{len:0}},this.getTokenOf=function(e,t){for(var n=0;n<e.length;n++)if(t.indexOf(e.charAt(n))<0)return{len:n,token:e.substring(0,n)};return{len:n,token:e}},this.getToken=function(e,t,n){for(var r=t;r<n&&!this.isWhiteSpace(e.charAt(r));)r++;return e.substring(t,r)},this.isMatch=function(t,n){var a=this.skipWhiteSpace(t);return e(t,a)?0:r.startsWith(t.substring(a),n)?a+n.length:0},this.getPitchFromTokens=function(e){var t={},n={A:5,B:6,C:0,D:1,E:2,F:3,G:4,a:12,b:13,c:7,d:8,e:9,f:10,g:11};if(t.position=n[e[0].token],void 0===t.position)return{warn:"Pitch expected. Found: "+e[0].token};for(e.shift();e.length;)switch(e[0].token){case",":t.position-=7,e.shift();break;case"'":t.position+=7,e.shift();break;default:return t}return t},this.getKeyAccidentals2=function(e){for(var t;e.length>0;){var n;if("^"===e[0].token){if(n="sharp",e.shift(),0===e.length)return{accs:t,warn:"Expected note name after "+n};switch(e[0].token){case"^":n="dblsharp",e.shift();break;case"/":n="quartersharp",e.shift()}}else if("="===e[0].token)n="natural",e.shift();else{if("_"!==e[0].token)return{accs:t};if(n="flat",e.shift(),0===e.length)return{accs:t,warn:"Expected note name after "+n};switch(e[0].token){case"_":n="dblflat",e.shift();break;case"/":n="quarterflat",e.shift()}}if(0===e.length)return{accs:t,warn:"Expected note name after "+n};switch(e[0].token.charAt(0)){case"a":case"b":case"c":case"d":case"e":case"f":case"g":case"A":case"B":case"C":case"D":case"E":case"F":case"G":void 0===t&&(t=[]),t.push({acc:n,note:e[0].token.charAt(0)}),1===e[0].token.length?e.shift():e[0].token=e[0].token.substring(1);break;default:return{accs:t,warn:"Expected note name after "+n+" Found: "+e[0].token}}}return{accs:t}},this.getKeyAccidental=function(t){var n={"^":"sharp","^^":"dblsharp","=":"natural",_:"flat",__:"dblflat","_/":"quarterflat","^/":"quartersharp"},r=this.skipWhiteSpace(t);if(e(t,r))return{len:0};var a=null;switch(t.charAt(r)){case"^":case"_":case"=":a=t.charAt(r);break;default:return{len:0}}if(r++,e(t,r))return{len:1,warn:"Expected note name after accidental"};switch(t.charAt(r)){case"a":case"b":case"c":case"d":case"e":case"f":case"g":case"A":case"B":case"C":case"D":case"E":case"F":case"G":return{len:r+1,token:{acc:n[a],note:t.charAt(r)}};case"^":case"_":case"/":if(a+=t.charAt(r),r++,e(t,r))return{len:2,warn:"Expected note name after accidental"};switch(t.charAt(r)){case"a":case"b":case"c":case"d":case"e":case"f":case"g":case"A":case"B":case"C":case"D":case"E":case"F":case"G":return{len:r+1,token:{acc:n[a],note:t.charAt(r)}};default:return{len:2,warn:"Expected note name after accidental"}}break;default:return{len:1,warn:"Expected note name after accidental"}}},this.isWhiteSpace=function(e){return" "===e||"\t"===e||""===e},this.getMeat=function(e,t,n){var r=e.indexOf("%",t);for(r>=0&&r<n&&(n=r);t<n&&(" "===e.charAt(t)||"\t"===e.charAt(t)||""===e.charAt(t));)t++;for(;t<n&&(" "===e.charAt(n-1)||"\t"===e.charAt(n-1)||""===e.charAt(n-1));)n--;return{start:t,end:n}};var t=function(e){return e>="A"&&e<="Z"||e>="a"&&e<="z"},n=function(e){return e>="0"&&e<="9"};this.tokenize=function(e,r,a,i){var s=this.getMeat(e,r,a);r=s.start,a=s.end;for(var o,c=[];r<a;){if('"'===e.charAt(r)){for(o=r+1;o<a&&'"'!==e.charAt(o);)o++;c.push({type:"quote",token:e.substring(r+1,o),start:r+1,end:o}),o++}else if(t(e.charAt(r))){if(o=r+1,i)for(;o<a&&!this.isWhiteSpace(e.charAt(o));)o++;else for(;o<a&&t(e.charAt(o));)o++;c.push({type:"alpha",token:e.substring(r,o),continueId:n(e.charAt(o)),start:r,end:o}),r=o+1}else if("."===e.charAt(r)&&n(e.charAt(o+1))){o=r+1;for(var l=null;o<a&&n(e.charAt(o));)o++;l=parseFloat(e.substring(r,o)),c.push({type:"number",token:e.substring(r,o),intt:null,floatt:l,continueId:t(e.charAt(o)),start:r,end:o}),r=o+1}else if(n(e.charAt(r))||"-"===e.charAt(r)&&n(e.charAt(o+1))){o=r+1;for(var h=null,u=null;o<a&&n(e.charAt(o));)o++;if("."===e.charAt(o)&&n(e.charAt(o+1)))for(o++;o<a&&n(e.charAt(o));)o++;else h=parseInt(e.substring(r,o));u=parseFloat(e.substring(r,o)),c.push({type:"number",token:e.substring(r,o),intt:h,floatt:u,continueId:t(e.charAt(o)),start:r,end:o}),r=o+1}else" "===e.charAt(r)||"\t"===e.charAt(r)?o=r+1:(c.push({type:"punct",token:e.charAt(r),start:r,end:r+1}),o=r+1);r=o}return c},this.getVoiceToken=function(e,t,n){for(var r=t;r<n&&this.isWhiteSpace(e.charAt(r))||"="===e.charAt(r);)r++;if('"'===e.charAt(r)){var a=e.indexOf('"',r+1);return-1===a||a>=n?{len:1,err:"Missing close quote"}:{len:a-t+1,token:this.translateString(e.substring(r+1,a))}}for(var i=r;i<n&&!this.isWhiteSpace(e.charAt(i))&&"="!==e.charAt(i);)i++;return{len:i-t+1,token:e.substring(r,i)}};var a={"`a":"à","'a":"á","^a":"â","~a":"ã",'"a':"ä",oa:"å","=a":"ā",ua:"ă",";a":"ą","`e":"è","'e":"é","^e":"ê",'"e':"ë","=e":"ē",ue:"ĕ",";e":"ę",".e":"ė","`i":"ì","'i":"í","^i":"î",'"i':"ï","=i":"ī",ui:"ĭ",";i":"į","`o":"ò","'o":"ó","^o":"ô","~o":"õ",'"o':"ö","=o":"ō",uo:"ŏ","/o":"ø","`u":"ù","'u":"ú","^u":"û","~u":"ũ",'"u':"ü",ou:"ů","=u":"ū",uu:"ŭ",";u":"ų","`A":"À","'A":"Á","^A":"Â","~A":"Ã",'"A':"Ä",oA:"Å","=A":"Ā",uA:"Ă",";A":"Ą","`E":"È","'E":"É","^E":"Ê",'"E':"Ë","=E":"Ē",uE:"Ĕ",";E":"Ę",".E":"Ė","`I":"Ì","'I":"Í","^I":"Î","~I":"Ĩ",'"I':"Ï","=I":"Ī",uI:"Ĭ",";I":"Į",".I":"İ","`O":"Ò","'O":"Ó","^O":"Ô","~O":"Õ",'"O':"Ö","=O":"Ō",uO:"Ŏ","/O":"Ø","`U":"Ù","'U":"Ú","^U":"Û","~U":"Ũ",'"U':"Ü",oU:"Ů","=U":"Ū",uU:"Ŭ",";U":"Ų",ae:"æ",AE:"Æ",oe:"œ",OE:"Œ",ss:"ß","'c":"ć","^c":"ĉ",uc:"č",cc:"ç",".c":"ċ",cC:"Ç","'C":"Ć","^C":"Ĉ",uC:"Č",".C":"Ċ","~n":"ñ","=s":"š",vs:"š",vz:"ž"},i={"#":"♯",b:"♭","=":"♮"},s={201:"♯",202:"♭",203:"♮",241:"¡",242:"¢",252:"a",262:"2",272:"o",302:"Â",312:"Ê",322:"Ò",332:"Ú",342:"â",352:"ê",362:"ò",372:"ú",243:"£",253:"«",263:"3",273:"»",303:"Ã",313:"Ë",323:"Ó",333:"Û",343:"ã",353:"ë",363:"ó",373:"û",244:"¤",254:"¬",264:"  ́",274:"1⁄4",304:"Ä",314:"Ì",324:"Ô",334:"Ü",344:"ä",354:"ì",364:"ô",374:"ü",245:"¥",255:"-",265:"μ",275:"1⁄2",305:"Å",315:"Í",325:"Õ",335:"Ý",345:"å",355:"í",365:"õ",375:"ý",246:"¦",256:"®",266:"¶",276:"3⁄4",306:"Æ",316:"Î",326:"Ö",336:"Þ",346:"æ",356:"î",366:"ö",376:"þ",247:"§",257:" ̄",267:"·",277:"¿",307:"Ç",317:"Ï",327:"×",337:"ß",347:"ç",357:"ï",367:"÷",377:"ÿ",250:" ̈",260:"°",270:" ̧",300:"À",310:"È",320:"Ð",330:"Ø",340:"à",350:"è",360:"ð",370:"ø",251:"©",261:"±",271:"1",301:"Á",311:"É",321:"Ñ",331:"Ù",341:"á",351:"é",361:"ñ",371:"ù"};this.translateString=function(e){var t=e.split("\\");if(1===t.length)return e;var n=null;return r.each(t,function(e){if(null===n)n=e;else{var t=a[e.substring(0,2)];void 0!==t?n+=t+e.substring(2):void 0!==(t=s[e.substring(0,3)])?n+=t+e.substring(3):(t=i[e.substring(0,1)],n+=void 0!==t?t+e.substring(1):"\\"+e)}}),n},this.getNumber=function(e,t){for(var n=0;t<e.length;)switch(e.charAt(t)){case"0":n*=10,t++;break;case"1":n=10*n+1,t++;break;case"2":n=10*n+2,t++;break;case"3":n=10*n+3,t++;break;case"4":n=10*n+4,t++;break;case"5":n=10*n+5,t++;break;case"6":n=10*n+6,t++;break;case"7":n=10*n+7,t++;break;case"8":n=10*n+8,t++;break;case"9":n=10*n+9,t++;break;default:return{num:n,index:t}}return{num:n,index:t}},this.getFraction=function(e,t){var n=1,r=1;if("/"!==e.charAt(t)){var a=this.getNumber(e,t);n=a.num,t=a.index}if("/"===e.charAt(t)){if(t++,"/"===e.charAt(t)){for(var i=.5;"/"===e.charAt(t++);)i/=2;return{value:n*i,index:t-1}}var s=t,o=this.getNumber(e,t);0===o.num&&s===t&&(o.num=2),0!==o.num&&(r=o.num),t=o.index}return{value:n/r,index:t}},this.theReverser=function(e){return r.endsWith(e,", The")?"The "+e.substring(0,e.length-5):r.endsWith(e,", A")?"A "+e.substring(0,e.length-3):e},this.stripComment=function(e){var t=e.indexOf("%");return t>=0?r.strip(e.substring(0,t)):r.strip(e)},this.getInt=function(e){var t=parseInt(e);if(isNaN(t))return{digits:0};var n=""+t;return{value:t,digits:e.indexOf(n)+n.length}},this.getFloat=function(e){var t=parseFloat(e);if(isNaN(t))return{digits:0};var n=""+t;return{value:t,digits:e.indexOf(n)+n.length}},this.getMeasurement=function(e){if(0===e.length)return{used:0};var t=1,n="";if("-"===e[0].token)e.shift(),n="-",t++;else if("number"!==e[0].type)return{used:0};if(n+=e.shift().token,0===e.length)return{used:1,value:parseInt(n)};var r=e.shift();if("."===r.token){if(t++,0===e.length)return{used:t,value:parseInt(n)};if("number"===e[0].type&&(r=e.shift(),n=n+"."+r.token,t++,0===e.length))return{used:t,value:parseFloat(n)};r=e.shift()}switch(r.token){case"pt":return{used:t+1,value:parseFloat(n)};case"cm":return{used:t+1,value:parseFloat(n)/2.54*72};case"in":return{used:t+1,value:72*parseFloat(n)};default:return e.unshift(r),{used:t,value:parseFloat(n)}}return{used:0}};var o=function(e){for(;-1!==e.indexOf("\\n");)e=e.replace("\\n","\n");return e};this.getBrackettedSubstring=function(e,t,n,r){for(var a=r||e.charAt(t),i=t+1;i<e.length&&e.charAt(i)!==a;)++i;return e.charAt(i)===a?[i-t+1,o(e.substring(t+1,i)),!0]:((i=t+n)>e.length-1&&(i=e.length-1),[i-t+1,o(e.substring(t+1,i)),!1])}}},{"./abc_common":7}],13:[function(e,t,n){var r={};r.FONTEM=360,r.FONTSIZE=30,r.STEP=93*r.FONTSIZE/720,r.SPACE=10,r.TOPNOTE=15,r.STAVEHEIGHT=100,r.INDENT=50,t.exports=r},{}],14:[function(e,t,n){abcjs={},abcjs.abcParser=e("abcjs/parse/abc_parse"),abcjs.midiCreate=e("abcjs/midi/abc_midi_create"),abcjs.currentTune=null,abcjs.abcToMIDI=function(e){var t=new abcjs.abcParser;return t.parse(e),abcjs.currentTune=t.getTune(),abcjs.midiCreate(abcjs.currentTune)}},{"abcjs/midi/abc_midi_create":2,"abcjs/parse/abc_parse":8}]},{},[14]);