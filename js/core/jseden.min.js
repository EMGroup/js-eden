function noop(){}function get_time_diff(e){var t=1e3*e,n=Date.now();if(t-=6e4*(new Date).getTimezoneOffset(),isNaN(t))return"";if(t<n)var r=n-t;else r=t-n;var i=Math.floor(r/1e3/60/1440),s=new Date(r);if(i>5)return new Date(t).toDateString();var o="";if(i>0)o+=i,o+=i>1?" days ago":" day ago";else if(s.getUTCHours()>0){var a=s.getUTCHours();o+=a,o+=a>1?" hours ago":" hour ago"}else{var d=s.getUTCMinutes();if(d>0)o+=d,o+=d>1?" minutes ago":" minute ago";else{var c=s.getUTCSeconds();o+=c,o+=" seconds ago"}}return o}function generateTimeStamp(e){for(var t,n=/(\d*)(minutes|minute|min|hours|hour|days|day|weeks|week|months|month|mon|years|year|Quarters|Quarter|seconds|second|sec|s|m|h|d|M|y|Y|Q|ms|w)/g,r=0;null!==(t=n.exec(e));)switch(console.log("Reltime:",t),t[2]){case"second":case"seconds":case"s":r+=1e3*parseInt(t[1]);break;case"minute":case"minutes":case"m":r+=6e4*parseInt(t[1]);break;case"hour":case"hours":case"h":r+=36e5*parseInt(t[1]);break;case"days":case"d":r+=36e5*parseInt(t[1])*24}return r}function hashCode(e){var t=0;if(0==e.length)return t;for(i=0;i<e.length;i++)char=e.charCodeAt(i),t=(t<<5)-t+char,t&=t;return t}function getTextWidth(e,t){var n=(getTextWidth.canvas||(getTextWidth.canvas=document.createElement("canvas"))).getContext("2d");return n.font=t,n.measureText(e).width}function unListen(e){for(var t in this.listeners)for(var n=this.listeners[t],r=0;r<n.length;r++)if(n[r].target===e){n.splice(r,1);break}}function listenTo(e,t,n){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push({target:t,callback:n})}function emit(e,t){var n=this.listeners[e];if(n){var r;for(r=0;r<n.length;++r){var i=n[r].target;if(n[r].callback.apply(i,t))return!0}return!1}}function concatAndResolveUrl(e,t){for(var n=e.split("/"),r=t.split("/"),i=[],s=0,o=n.length;s<o;s++)if(".."==n[s])i.pop();else{if("."==n[s])continue;i.push(n[s])}for(s=0,o=r.length;s<o;s++)if(".."==r[s])i.pop();else{if("."==r[s])continue;i.push(r[s])}return i.join("/")}function ajaxGet(e){return new Promise((t,n)=>{var r=new XMLHttpRequest;r.open("GET",e),r.onload=function(){this.status>=200&&this.status<300?t(r.response):n({status:this.status,statusText:r.statusText})},r.onerror=function(){n({status:this.status,statusText:r.statusText})},r.send()})}function ajaxPost(e,t){return new Promise((n,r)=>{var i=new XMLHttpRequest;i.open("POST",e),i.onload=function(){this.status>=200&&this.status<300?n(JSON.parse(i.response)):r({status:this.status,statusText:i.statusText})},i.onerror=function(){r({status:this.status,statusText:i.statusText})},i.send(t)})}if(mobilecheck=function(){if(void 0!==Eden.mobile)return Eden.mobile;var e,t=!1;return e=navigator.userAgent||navigator.vendor||window.opera,(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))&&(t=!0),Eden.mobile=t,t},Utils={flatten:function(e){for(var t=[],n=0,r=e.length;n<r;++n)t=t.concat(e[n]instanceof Array?this.flatten(e[n]):e[n]);return t},construct:function(){var e=function(){};return function(t){e.prototype=t.prototype;for(var n=new e,r=[],i=1;i<arguments.length;i++)r.push(arguments[i]);return t.apply(n,r),n}}()},"undefined"!=typeof require&&"undefined"!=typeof exports){const e=require("fs");Utils.getURL=function(t){return new Promise((n,r)=>{e.readFile(t,"utf8",function(e,t){e?r(e):n(t)})})}}else Utils.getURL=function(e){return ajaxGet(e)};"undefined"!=typeof require&&"undefined"!=typeof exports&&(exports.get_time_diff=get_time_diff,exports.noop=noop,exports.listenTo=listenTo,exports.emit=emit,exports.unListen=unListen,exports.flatten=Utils.flatten,exports.construct=Utils.construct,exports.getURL=Utils.getURL),function(e){function t(e){this.root=e||new t.Folder(null,this),this.root.base=this,this.dictionary={},this.errorNumber=0,this.listeners={},this.reportErrors=!0,this.ready=t.Project.init(this)}if(t.edenFunctions={apply:!0,array:!0,canvasURL:!0,centroid:!0,char:!0,charCode:!0,choose:!0,compose:!0,concat:!0,curry:!0,decodeHTML:!0,definitionOf:!0,definitionRHS:!0,doDefault:!0,edenCode:!0,escapeRE:!0,foldl:!0,foldr:!0,hasProperty:!0,hslColour:!0,htmlBulletList:!0,htmlNumberedList:!0,positionInList:!0,positionOfRE:!0,substringPosition:!0,int:!0,isBoolean:!0,isCallable:!0,isChar:!0,isDefined:!0,isDependency:!0,isDependent:!0,isFunc:!0,isInt:!0,isList:!0,isNaN:!0,isNumber:!0,isObject:!0,isPoint:!0,isPointer:!0,isProc:!0,isString:!0,isValue:!0,distanceMoved:!0,angleTurned:!0,List:!0,listcat:!0,lookup:!0,lowercase:!0,map:!0,mapPartial:!0,max:!0,Menu:!0,MenuItem:!0,min:!0,mod:!0,nameof:!0,partApply:!0,Point:!0,pow:!0,properties:!0,randomBoolean:!0,randomFloat:!0,randomInteger:!0,RE:!0,replaceFirst:!0,reverse:!0,rgbColour:!0,rotatePoint:!0,round:!0,roundMultiple:!0,scalePoint:!0,search:!0,sequenceItoJ:!0,sequenceN:!0,sequenceArithmeticN:!0,sequenceList:!0,sequencePrevious:!0,sort:!0,str:!0,sqrt:!0,strcat:!0,sublist:!0,substitute:!0,substr:!0,sum:!0,tail:!0,trim:!0,type:!0,uppercase:!0,include_css:!0,html:!0,time:!0,execute:!0,Text:!0,textWidth:!0,textHeight:!0,Arc:!0,Curve:!0,FillPattern:!0,Ellipse:!0,Line:!0,LinearGradient:!0,LineSequence:!0,PixelList:!0,GreyPixelList:!0,Rectangle:!0,RotateAboutCentre:!0,RotateAboutPoint:!0,CombinedRotation:!0,Scale:!0,Translate:!0,RoundedRectangle:!0,Polygon:!0,RegularPolygon:!0,Sector:!0,Shadow:!0,Circle:!0,Button:!0,Checkbox:!0,Div:!0,Image:!0,imageWithZones:!0,HTMLImage:!0,RadioButtons:!0,Slider:!0,Textbox:!0,DropDownList:!0,Combobox:!0,BulletSlide:!0,Video:!0,Audio:!0,Slide:!0,TitledSlide:!0,TitleSlide:!0,cos:!0,sin:!0,tan:!0,abs:!0,acos:!0,asin:!0,atan:!0,ceil:!0,roundUp:!0,exp:!0,floor:!0,roundDown:!0,log:!0,random:!0,forget:!0,forgetAll:!0,shapeOnTopAt:!0,zoneOnTopAt:!0,observableOnTopAt:!0,shapeOnBottomAt:!0,zoneOnBottomAt:!0,observableOnBottomAt:!0,shapesAt:!0,zonesAt:!0,observablesAt:!0,observableForShape:!0,alias:!0,arrangeWindows:!0,attemptMouseCapture:!0,bindCSSNumericProperty:!0,bindCSSProperty:!0,bindCSSRule:!0,createCanvas:!0,createHTMLView:!0,createProjectList:!0,createView:!0,destroyView:!0,eager:!0,error:!0,hideView:!0,highlightView:!0,moveView:!0,patch:!0,removeedenclock:!0,resizeView:!0,setedenclock:!0,showObservables:!0,showView:!0,stopHighlightingView:!0,todo:!0,touch:!0,unbind:!0,withAppendedItem:!0,writeln:!0},e.Eden=t,"undefined"!=typeof require&&"undefined"!=typeof exports){e.rt=require("./runtime").rt,require("./symbol"),require("./context"),require("./scope"),require("./warnings"),require("../language/lang"),require("../language/en"),require("../selectors/selector"),require("../ast/ast"),require("../lex"),require("./engine"),require("./errors"),require("../index");let n=require("../util/misc");e.listenTo=n.listenTo,e.emit=n.emit,e.unListen=n.unListen,t.Utils=n,require("../project")}else t.Utils=Utils;t.create=function(){return new Promise((e,n)=>{let r=new t;r.ready.then(t=>{e(r)})})},t.prototype.updateDictionary=function(e,t,n){this.dictionary[e]=t},t.isValidIdentifier=function(e){return Boolean(e&&/^[_a-zA-Z$]\w*$/.test(e))},t.load=function(e,n,r,i){console.log("Loading project: "+e+"@"+n),t.DB.load(e,n,void 0,function(t){if("object"==typeof t&&EdenUI.MenuBar.saveTitle(t.title),eden.root.lookup("_jseden_loaded").assign(!0,eden.root.scope),!i){var s=URLUtil.getParameterByName("master"),o=URLUtil.getParameterByName("id"),a="?load="+e+"&tag="+n;""!=o&&(a+="&id="+o),""!=s&&(a+="&master="+s),window.history.pushState({project:e,tag:n},"",a)}r&&r()})},t.reset=function(){edenUI.destroyAllViews(),eden.reset()},t.prototype.reset=function(){this.root.forgetAll("",!0,!1),this.root.collectGarbage(),this.errorNumber=0,this.reportErrors=!0},t.prototype.listenTo=listenTo,t.prototype.emit=emit,t.prototype.error=function(e,n,r){throw new t.RuntimeError(this.root,r||0,void 0,e)},t.prototype.assign=function(e,t,n){this.root.lookup(e).assign(t,n||this.root.scope,EdenSymbol.hciAgent)},t.prototype.get=function(e,t){return this.root.lookup(e).value(t)},t.prototype.getAttribute=function(e,n){var r="string"==typeof e?this.root.lookup(e):e;return t.Selectors.processResults([r],n)[0]},t.prototype.execute2=function(e,n,r){var i=n;void 0!==n&&"string"!=typeof n||(i={name:"*execute"},n&&(i.name=n));var s=new t.AST(e,void 0,i,{noindex:!0});0==s.script.errors.length?s.execute(i,this.root.scope,r):(console.error(s.script.errors[0].prettyPrint()),r&&r(!1))},t.prototype.execute=t.prototype.execute2,t.prototype.exec=function(e){return new Promise((n,r)=>{let i={name:"*execute"};var s=new t.AST(e,void 0,i,{noindex:!0});0==s.script.errors.length?s.execute(i,this.root.scope,e=>{n(e)}):r(s.script.errors[0].messageText())})},t.prototype.evalEden=function(e,n,r){var i=t.AST.parseExpression(e);if(!(i.errors.length>0)){r||(r=this.root.scope);var s={symbol:n,isconstant:!0,statement:n?n.origin:null};return t.AST.executeExpressionNode(i,r,s)}this.emit("error",[{name:n?n.name:"Inline"},i.errors[0]])},t.prototype.transpileExpression=function(e,n,r){var i=t.AST.parseExpression(e);if(!(i.errors.length>0)){r||(r=this.root.scope);var s={symbol:n,isconstant:!0,statement:n?n.origin:null};return t.AST.transpileExpressionNode(i,r,s)}this.emit("error",[{name:n?n.name:"Inline"},i.errors[0]])},t.prototype.parseExpression=function(e,n){if("string"!=typeof e)return err=new t.RuntimeError(this.root,t.RuntimeError.ARGUMENTS,null,"`parse()` requires a string"),void this.emit("error",[{name:n?n.name:"Inline"},err]);var r=t.AST.parseExpression(e);return r.errors.length>0?(console.error(r.errors[0]),void this.emit("error",[{name:n?n.name:"Inline"},r.errors[0]])):r},t.edenCodeForValue=function(e,n,r){var i=typeof e,s="";if("undefined"==i)s="@";else if(null===e)s="${{ null }}$";else if("string"==i)s=e.indexOf("\n")>=0?"<<END\n"+e.replace(/\n/g,"\\n")+"\nEND":'"'+e.replace(/\\/g,"\\\\").replace(/\"/g,'\\"')+'"';else if(Array.isArray(e))if(void 0===n&&(n=[]),-1!=n.indexOf(e))s+="<<circular reference>>";else{n.push(e),s="[";for(var o=0;o<e.length-1;o++)s=s+t.edenCodeForValue(e[o],n,r)+", ";e.length>0&&(s+=t.edenCodeForValue(e[e.length-1],n,r)),s+="]",n.pop()}else if("object"==i){if("getEdenCode"in e?s=e.getEdenCode(r):"keys"in e&&Array.isArray(e.keys)&&e.keys.length>0&&"parent"in e&&e.parent instanceof Symbol?s="&"+e.parent.name.slice(1)+"["+e.keys[0]+"]":"object"==typeof window&&"object"==typeof document&&"function"==typeof Element&&(e==window?s="${{ window }}$":e==document?s="${{ document }}$":e==document.documentElement?s="${{ document.documentElement }}$":e==document.body?s="${{ document.body }}$":e instanceof Element&&e.id&&(s='${{ document.getElementById("'+e.id+'") }}$')),""==s)if(void 0===n&&(n=[]),-1!=n.indexOf(e))s+="<<circular reference>>";else{for(var a in n.push(e),s="{",e)a in Object.prototype||(s=s+a+": "+t.edenCodeForValue(e[a],n,r)+", ");"{"!=s&&(s=s.slice(0,-2)),s+="}",n.pop()}}else s="function"==i?"${{\n\t"+e.toString().replace(/\n/g,"\n\t")+"\n}}$":"number"==i&&r?e.toFixed(r):String(e);return s},t.edenCodeForValues=function(){for(var e="",n=0;n<arguments.length-1;n++)e=e+t.edenCodeForValue(arguments[n])+", ";return e+=t.edenCodeForValue(arguments[arguments.length-1])},t.edenCodeForValuesP=function(e){for(var n="",r=1;r<arguments.length-1;r++)n=n+t.edenCodeForValue(arguments[r],void 0,e)+", ";return n+=t.edenCodeForValue(arguments[arguments.length-1],void 0,e)},t.intersection=function(e,t){return Object.keys(e).filter({}.hasOwnProperty.bind(t))},t.prettyPrintValue=function(e,n,r,i,s,o){void 0===s&&(s=!0);var a=typeof n,d="",c=!1;if("undefined"==a)d="@";else if(null===n)d="${{ null }}$";else if("string"==a)d='"'+n.replace(/\\/g,"\\\\").replace(/\"/g,'\\"')+'"',void 0!==r&&d.length>r+1&&(d=d.slice(0,r)+"...",c=!0);else if(Array.isArray(n))if(void 0===o&&(o=[]),-1!=o.indexOf(n))d+="...";else{o.push(n),d="[";for(var h=0;h<n.length-1;h++){if(d=t.prettyPrintValue(d,n[h],r,i,s,o)+",",void 0!==r&&d.length>=r-1){"..."!=d.slice(-3)&&(d+="..."),c=!0;break}d+=" "}n.length>0&&!c&&(d=t.prettyPrintValue(d,n[n.length-1],r,i,s,o)),d+="]",o.pop()}else if("object"==a){if(n instanceof Symbol?d=n.getEdenCode():"keys"in n&&Array.isArray(n.keys)&&n.keys.length>0&&"parent"in n&&n.parent instanceof Symbol?d="&"+n.parent.name.slice(1)+"["+n.keys[0]+"]":"object"==typeof window&&"object"==typeof document&&"function"==typeof Element&&(n==window?d="${{ window }}$":n==document?d="${{ document }}$":n==document.documentElement?d="${{ document.documentElement }}$":n==document.body?d="${{ document.body }}$":n instanceof Element&&n.id&&(d='${{ document.getElementById("'+n.id+'") }}$')),""==d)if(n.toString!=Object.prototype.toString)d=n.toString(),void 0!==r&&d.length>r&&(d=d.slice(0,r)+"...",c=!0);else if(void 0===o&&(o=[]),-1!=o.indexOf(n))d+="...";else{o.push(n),d="{";var p=!1;for(var l in n)if(!(l in Object.prototype)){if(p){d=d.slice(0,-1)+"...",c=!0;break}if(d=d+l+": ","..."==(d=t.prettyPrintValue(d,n[l],r,i,s,o)).slice(-3)){c=!0;break}void 0!==r&&d.length>=r&&(p=!0),d+=", "}"{"==d||c||(d=d.slice(0,-2)),d+="}",o.pop()}}else"function"==a?i?(d="${{\n\t"+n.toString().replace(/\n/g,"\n\t")+"\n}}$",void 0!==r&&d.length>r&&(d=d.slice(0,r)+"...",c=!0)):d="func":d=String(n);if(e)return e+d;var u=t.htmlEscape(d,!s);return u=u.replace(/\.\.\./g,"&hellip;"),s||(u=u.replace(/\n/g,"\\n")),u},t.htmlEscape=function(e,t,n){return void 0===e?"":(e=(e=(e=(e=(e=(e=String(e)).replace(/&/g,"&amp;")).replace(/</g,"&lt;")).replace(/>/g,"&gt;")).replace(/"/g,"&quot;")).replace(/'/g,"&#39;"),n?e=t?e.replace(/\n/g," "):e.replace(/\n/g,"<br/>"):t||(e=e.replace(/\n/g,"<br/>\n")),e)},t.prototype.nextEvalID=0,t.prototype.initialDefinition=function(){console.error("INIT DEF DEP")},"undefined"!=typeof require&&"undefined"!=typeof exports&&(exports.Eden=t)}("undefined"!=typeof window?window:global),function(e){function t(e){this.eden=e,this.views={},this.viewInstances={},this.embeddedInstances={},this.activeDialogs={},this.plugins={};this.loaded=!1,this.branding={},this.$uimsg=$("<div class='message-box'></div>"),this.$uimsg.appendTo("body"),this.$uimsg.hide(),this.messagetimeout=void 0,this.messagedisplaytime=5e3,this.eden.listenTo("executeFileLoad",this,function(e){edenUI.updateStatus("Loading "+e)}),this.eden.listenTo("executeError",this,function(e,t){console.error("DEPRECATED ERROR REPORTING",e);var n,r=Eden.htmlEscape(e.message);t.errorNumber,t.path&&t.path;n="string"==typeof e?e:e.message,edenUI.showMessage("error","Error: "+n)}),this.listeners={},this.windowHighlighter=new WindowHighlighter(this),this.currentView=void 0,this.viewCategories={},this.numberOfViewCategories=0,this.addViewCategory("comprehension","Comprehension"),this.addViewCategory("interpretation","Making Definitions"),this.addViewCategory("history","History &amp; State"),this.addViewCategory("visualization","Visualization"),this.addViewCategory("extension","Extensions"),this.addViewCategory("environment","Management"),$(document).on("click",function(e){if(e.ctrlKey||e.metaKey)for(var t=[],n=e.target;"BODY"!=n.nodeName;){var r=n.getAttribute("data-observables");r&&""!=r&&t.push.apply(t,r.split(",")),n=n.parentNode}})}t.prototype.brieflyHighlightView=function(e){var t=$("#"+viewName+"-dialog").dialog.parent();t.addClass("window-activated"),setTimeout(function(){t.removeClass("window-activated")},600)},t.prototype.cycleNextView=function(){this.stopHighlightingView(this.currentView,!0,!1);var e=Object.keys(this.activeDialogs);if(void 0===this.currentView)this.currentView=e[0];else for(i=0;i<e.length;i++)if(this.currentView==e[i]){this.currentView=e[(i+1)%e.length];break}this.highlightView(this.currentView,!0)},t.prototype.stopViewCycling=function(){this.stopHighlightingView(this.currentView,!0,!0)},t.plugins={},t.prototype.loadPlugin=function(e,n,r){if(2===arguments.length&&(r=n,n={name:"/loadPlugin"}),void 0===t.plugins[e])return this.eden.error("Plugin '"+e+"' does not exist"),r&&r.call(n,!1),!1;eden.peer&&eden.peer.doRequire(e);var i=this,s=function(){i.emit("loadPlugin",[e]),r&&r.call(n)};void 0===this.plugins[e]?(this.plugins[e]=!0,this.plugins[e]=new t.plugins[e](this,s)):s()},t.prototype.addViewCategory=function(e,t){this.viewCategories[e]=new function(e,t){this.getLabel=function(){return e},this.getMenuPriority=function(){return t}}(t,this.numberOfViewCategories),this.numberOfViewCategories++},t.prototype.updateStatus=function(e){this.loaded?this.showMessage("info",e):(console.log(e),$(".loadmessage").html(e))},t.prototype.hideMessage=function(){edenUI.$uimsg.hide("slow")},t.prototype.showMessage=function(e,t){"info"==e?this.$uimsg.html("<div class='message-infotext'>"+t+"</div>"):"error"==e&&this.$uimsg.html("<div class='message-errortext'>"+t+"</div>"),this.$uimsg.show("fast"),clearTimeout(this.messagetimeout),this.messagetimeout=setTimeout(this.hideMessage,this.messagedisplaytime)},t.prototype.finishedLoading=function(){this.loaded=!0},t.prototype.listenTo=listenTo,t.prototype.emit=emit,t.showTooltip=function(e,t){var n=document.getElementById("tooltip"),r=e.clientX+2,i=e.clientY+20,s=window.pageXOffset+window.innerWidth-r-15;s<200&&(r-=200-s,s=200),n.style.left=r+"px",n.style.maxWidth=s+"px",n.style.top=i+"px",n.innerHTML=t,n.style.display="block";let o=$(".ui-front"),a=0;for(var d=0;d<o.length;++d)o[d].style.zIndex>a&&(a=o[d].style.zIndex);n.style.zIndex=Math.max(a,1e4)+1},t.closeTooltip=function(){document.getElementById("tooltip").style.display="none"},t.prototype.options={},t.prototype.getOptionValue=function(e){if(e in this.options)return this.options[e];try{if(window.localStorage)return window.localStorage.getItem(e)}catch(e){return null}},t.prototype.setOptionValue=function(e,t){this.options[e]=String(t),this.emit("optionChange",[e,String(t)]);try{if(window.localStorage)return window.localStorage.setItem(e,t),!0}catch(e){return!1}},t.prototype.setDefaultOptionValue=function(e,t){null===this.getOptionValue(e)&&(this.options[e]=String(t),this.emit("optionChange",[e,String(t)]))},t.prototype.unsetOptionValue=function(e){delete this.options[e],this.emit("optionChange",[e,null]);try{window.localStorage&&window.localStorage.removeItem(e)}catch(e){}},t.prototype.fullscreen=function(e,t){var n=eden.root.lookup(t),r=n.value();if(document.webkitExitFullscreen)r?(document.onwebkitfullscreenchange=function(){document.webkitIsFullScreen||(n.assign(!1,eden.root.scope,Symbol.hciAgent),edenUI.menu.show())},document.getElementById(e+"-canvascontent").webkitRequestFullscreen(),edenUI.menu.hide()):(document.webkitExitFullscreen(),edenUI.menu.show());else if(document.mozCancelFullScreen){if(r)document.onmozfullscreenchange=function(){document.mozFullScreen||(n.assign(!1,eden.root.scope,Symbol.hciAgent),edenUI.menu.show())},document.getElementById(e+"-canvascontent").mozRequestFullScreen(),edenUI.menu.hide();else document.mozCancelFullScreen(),edenUI.menu.show()}},t.prototype.regExpFromStr=function(e,t,n,r){var i,s,o,a,d=!0;if("object"==typeof e&&(e=(o=e)[0].value),void 0===t&&(t=""),void 0===r)a=!/[\\+^$|({[]|(\.\*[^\s*?])/.test(e)&&"false"!==this.getOptionValue("optSimpleWildcards");else if("simple"==r)a=!0;else{if("regexp"!=r)throw new Error("EdenUI.regExpFromStr: Unsupported search language "+r);a=!1}if(/[A-Z]/.test(e)||(t+="i"),a){for(var c=(e=e.replace(/([\\+^$.|(){[])/g,"\\$1").replace(/([*?])/g,".$1")).split(new RegExp("\\s+(?:"+Language.ui.search.disjunction+"|or)\\s+","i")),h=0;h<c.length;h++){var p=c[h];n||/[?*]/.test(p)?c[h]="^("+p+")$":p.length<3&&(c[h]="^("+p+")")}i=c.join("|"),s=new RegExp(i,t)}else try{i=e,n&&(i="^("+i+")$"),s=new RegExp(i,t)}catch(r){d=!1;var l=e.match(/^([^*+?\\(){[]([^\\()[]*(\\.)?)*)?/)[0];n&&(l="^("+l+")"),s=new RegExp(l,t)}return o&&(d?o.removeClass("invalid_form"):o.addClass("invalid_form")),s},e.EdenUI=t,"undefined"!=typeof require&&"undefined"!=typeof exports&&(exports.EdenUI=t)}("undefined"!=typeof window?window:global),DiffUtil={},DiffUtil.diff=function(e,t){var n=new diff_match_patch,r=n.diff_main(e,t);n.diff_cleanupSemantic(r),console.log(r);for(var i={remove:{},insert:{}},s=0,o=0,a=0,d=0,c=0;c<r.length;c++){var h=r[c][1].match(/\n/g);if(0!=r[c][0]){if(1==r[c][0]){lines=r[c][1].split("\n");for(var p=0;p<lines.length&&(p!=lines.length-1||0!=lines[p].length);p++)void 0===i.insert[o+p]&&(i.insert[o+p]={oline:s,chars:[]}),i.insert[o+p].chars.push({start:a,length:lines[p].length}),p>0&&(i.insert[o+p].consecutive=!0),i.insert[o+p].partial=null===h,a+=lines[p].length,p<lines.length-1&&a++;null!==h&&(o+=h.length)}else if(-1==r[c][0]){lines=r[c][1].split("\n");for(p=0;p<lines.length&&(p!=lines.length-1||0!=lines[p].length);p++)void 0===i.remove[s+p]&&(i.remove[s+p]={nline:o,chars:[]}),i.remove[s+p].chars.push({start:d,length:lines[p].length}),i.remove[s+p].partial=null===h,p>0&&(i.remove[s+p].consecutive=!0),d+=lines[p].length,p<lines.length-1&&d++;null!==h&&(s+=h.length)}}else null!==h&&(s+=h.length,o+=h.length),d+=r[c][1].length,a+=r[c][1].length}var l=e.split("\n"),u=t.split("\n"),E=[0];for(c=0;c<l.length-1;c++)E.push(l[c].length+E[c]+1);var f=[0];for(c=0;c<u.length-1;c++)f.push(u[c].length+f[c]+1);for(var g in i.insert)if(i.insert[g].chars.length>0){for(c=0;c<i.insert[g].chars.length;c++)i.insert[g].chars[c].start-=f[g];i.insert[g].iline=u[g]}for(var g in i.remove)if(i.remove[g].chars.length>0){for(c=0;c<i.remove[g].chars.length;c++)i.remove[g].chars[c].start-=E[g];i.remove[g].rline=l[g]}return console.log(i),i},function(){var e={language:"en",loadSymbols:function(e){for(var t in this.symbols)t!=this.symbols[t]&&void 0===e.symbols[this.symbols[t]]&&(e.symbols[this.symbols[t]]=e.lookup(t))},addKeywords:function(e){for(var t in e)this.keywords[t]=e[t]},addSymbols:function(e){for(var t in e)this.symbols[t]=e[t]},importoptions:{readonly:"readonly",remote:"remote",local:"local",rebase:"rebase",noexec:"noexec",reload:"reload",force:"force",async:"async",create:"create",remove:"remove"},selectors:{"has-name":!0,name:!0,type:!0,definition:!0,assignment:!0,script:!0,when:!0,for:!0,if:!0,last:!0,nth:!0,executed:!0,not:!0,unexecuted:!0,remote:!0,value:!0,active:!0,depends:!0},doxytags:{title:"title",author:"author",version:"version",param:"param",return:"return",debug:"debug",local:"local",role:"role",shared:"shared",oracle:"oracle",handle:"handle",deprecated:"deprecated",see:"see","{":"{","}":"}",hidden:"hidden",script:"script"},keywords:{func:"func",function:"function",oracle:"oracle",handle:"handle",proc:"proc",auto:"auto",para:"para",action:"action",procedure:"procedure",local:"local",role:"role",if:"if",is:"is",in:"in",else:"else",for:"for",while:"while",do:"do",switch:"switch",case:"case",default:"default",break:"break",continue:"continue",return:"return",when:"when",wait:"wait",import:"import",insert:"insert",append:"append",delete:"delete",require:"require",shift:"shift",with:"with",and:"and",or:"or",not:"not",eval:"eval",sync:"sync",parse:"parse",compile:"compile",exec:"exec",execute:"exec"},symbols:{int:"int",str:"str",round:"round",min:"min",max:"max",random:"random",floor:"floor",ceil:"ceil",abs:"abs",acos:"acos",asin:"asin",atan:"atan",cos:"cos",exp:"exp",ln:"ln",log:"log",mod:"mod",randomInteger:"randomInteger",randomFloat:"randomFloat",sin:"sin",sqrt:"sqrt",sum:"sum",tan:"tan",length:"length",error:"error",substr:"substr",type:"type",createView:"createView",createCanvas:"createCanvas",zonesAt:"zonesAt",execute:"execute",indexOf:"indexOf",forget:"forget",eager:"eager",time:"time",writeln:"writeln",apply:"apply",todo:"todo",char:"char",isBoolean:"isBoolean",isCallable:"isCallable",isChar:"isChar",isDefined:"isDefined",isValue:"isValue",isFunc:"isFunc",isInt:"isInt",isNaN:"isNaN",isNumber:"isNumber",isObject:"isObject",isPoint:"isPoint",isProc:"isProc",showView:"showView",array:"array",sublist:"sublist",reverse:"reverse",search:"search",sort:"sort",tail:"tail",concat:"concat",decodeHTML:"decodeHTML"},values:{true:"true",false:"false"},errors:{}};function t(e){let t=Object.create(null);return Object.assign(t,e),t}Eden.Language=e,e.keywords=t(e.keywords),e.values=t(e.values),"undefined"!=typeof require&&"undefined"!=typeof exports&&(exports.Language=e)}(),Point=function(e,t){this.x=e,this.y=t},Point.prototype.toString=function(e){return"Point("+Eden.edenCodeForValue(this.x,void 0,e)+", "+Eden.edenCodeForValue(this.y,void 0,e)+")"},Point.prototype.getEdenCode=Point.prototype.toString;var rt={f:{},index:function(e){return"number"==typeof e?e-1:e},flattenPromise:function(e){return e instanceof Promise?e:Array.isArray(e)&&e.length>0&&e[0]instanceof Promise?Promise.all(e):Promise.resolve(e)},length:function(e){if(null!==e&&void 0!==e)return e.length},equal:function(e,t){var n;if(e===t)return!0;if(e instanceof Array&&t instanceof Array){if(e.length!==t.length)return!1;for(n=0;n<e.length;++n)if(!rt.equal(e[n],t[n]))return!1;return!0}return!1},notequal:function(e,t){return!rt.equal(e,t)},add:function(e,t){return void 0===e||void 0===t?void 0:e instanceof Point?new Point(e.x+t.x,e.y+t.y):e+t},subtract:function(e,t){return void 0===e||void 0===t?void 0:e instanceof Point?new Point(e.x-t.x,e.y-t.y):e-t},addA:function(e,t){return void 0===e||void 0===t?void 0:e+t},subtractA:function(e,t){return void 0===e||void 0===t?void 0:e-t},multiply:function(e,t){if(void 0!==e&&void 0!==t)return e*t},divide:function(e,t){if(void 0!==e&&void 0!==t)return e/t},mod:function(e,t){if(void 0!==e&&void 0!==t)return e%t},pow:function(e,t){if(void 0!==e&&void 0!==t)return Math.pow(e,t)},concat:function(e,t){if(void 0!==e&&void 0!==t){if(Array.isArray(e)){if(Array.isArray(t))return e.concat(t);throw new Error(Eden.RuntimeError.LEFTCONCAT)}if(Array.isArray(t))throw new Error(Eden.RuntimeError.RIGHTCONCAT);return String(e)+t}},concatS:function(e,t){return void 0===e||void 0===t?void 0:String(e)+t},regExpMatch:function(e,t){return void 0===e||void 0===t?void 0:t instanceof RegExp?t.test(e):new RegExp(t).test(e)},regExpNotMatch:function(e,t){return void 0===e||void 0===t?void 0:t instanceof RegExp?!t.test(e):!new RegExp(t).test(e)}};function WindowHighlighter(e){this.edenUI=e,this.lastDialog=void 0,this.lastDialogMinimized=!1,this.lastDialogHidden=!1,this.previousZIndex=void 0}function ScopeCache(e,t,n,r){this.up_to_date=e,this.value=t,this.symbol=n,this.scopes=null,this.override=r}function BoundValue(e,t){this.value=e,this.scope=t}function ScopeOverride(e,t,n,r,i){if(this.name=e,this.start=t,this.end=n,this.increment=r,this.current=i&&t?t[0]:t,this.isin=i,this.index=1,0==this.increment)throw new Error(Eden.RuntimeError.INFINITERANGE);if(this.isin&&void 0===this.end&&!(this.start instanceof Array))throw new Error(Eden.RuntimeError.NOLISTRANGE)}function Scope(e,t,n,r,i,s){if(this.parent=t,this.context=e,this.cache=void 0,this.pcache=Object.create(null),this.overrides=n,this.cause=t&&t.cause?t.cause:i,this.causecount=0,this.range=r,this.isolate=!1,this.depth=t?t.depth+1:0,e||console.error("MISSING SCOPE CONTEXT"),this.cachearray=null,this.depth>50)throw console.error("Recursive scope detected : "+(i?i.name:"")),"Scope Depth Exceeded";if(this.cause&&this.cause.hasOwnProperty("scopecount")&&++this.cause.scopecount>1e5)throw console.error("Scope limit exceeded",this.cause.name),"Scope limit exceeded";s||this.rebuild()}function ScopeList(){this.raw=[],this.caches=[]}function copy(e){var t,n;if(e instanceof Array){for(n=e.slice(),t=0;t<e.length;++t)n[t]=copy(n[t]);return n}return e}function Pointer(e){this.value=e}this.rt=rt,"undefined"!=typeof require&&"undefined"!=typeof exports&&(exports.rt=rt),WindowHighlighter.prototype.highlight=function(e){this.lastDialog=edenUI.getDialogWindow(e);var t=edenUI.getDialogContent(e);if(t.dialog("isOpen")){var n=t.data("dialog-extend-minimize-controls");n?(this.previousZIndex=n.css("z-index"),t.dialogExtend("restore"),this.lastDialog.removeClass("window-activated"),this.lastDialogMinimized=!0):(this.previousZIndex=this.lastDialog.css("z-index"),this.lastDialog.css("z-index",2147483646),this.lastDialogMinimized=!1),this.lastDialogHidden=!1}else this.previousZIndex=void 0,edenUI.showView(e),edenUI.moveView(e),this.lastDialogHidden=!0;this.lastDialogLeft=this.lastDialog[0].offsetLeft,this.lastDialogWidth=this.lastDialog[0].offsetWidth,this.lastDialogTop=this.lastDialog[0].offsetTop,this.lastDialogHeight=this.lastDialog[0].offsetHeight;var r=window.pageXOffset,i=window.pageYOffset;(this.lastDialogLeft>=r+window.innerWidth||this.lastDialogLeft+this.lastDialogWidth<r||this.lastDialogTop>=i+window.innerHeight||this.lastDialogTop+this.lastDialogHeight<i)&&t.parent().offset({left:r+(window.innerWidth-this.lastDialogWidth)/2,top:i+(window.innerHeight-this.lastDialogHeight)/2}),this.lastDialog.addClass("menubar-window-raise"),this.lastDialog.css("z-index",2147483646)},WindowHighlighter.prototype.stopHighlight=function(e,t){if(this.lastDialog){this.lastDialog.removeClass("menubar-window-raise");var n=edenUI.getDialogContent(e);if(n.parent().offset({left:this.lastDialogLeft,top:this.lastDialogTop+edenUI.menuBarHeight}),t){var r=window.pageXOffset,i=window.pageYOffset,s=!1;this.lastDialogLeft+this.lastDialogWidth>r+window.innerWidth?(r=this.lastDialogLeft+this.lastDialogWidth-window.innerWidth,s=!0):this.lastDialogLeft<r&&(r=this.lastDialogLeft,s=!0),this.lastDialogTop+this.lastDialogHeight>i+window.innerHeight-edenUI.menuBarHeight?(i=this.lastDialogTop+this.lastDialogHeight-window.innerHeight-edenUI.menuBarHeight+edenUI.scrollBarSize2+edenUI.bottomBarHeight,s=!0):this.lastDialogTop<i&&(i=this.lastDialogTop-edenUI.menuBarHeight,s=!0),s&&window.scrollTo(r,i)}else this.lastDialogHidden?edenUI.hideView(e):this.lastDialogMinimized&&n.dialogExtend("minimize");void 0!==this.previousZIndex&&this.lastDialog.css("z-index",this.previousZIndex),this.lastDialog=void 0,this.lastDialogMinimized=!1,this.lastDialogHidden=!1,this.previousZIndex=void 0}},WindowHighlighter.prototype.unpin=function(e){e===this.lastDialog&&(this.previousZIndex=void 0)},Scope.prototype.error=function(e,t){this.context.instance.error(e,t)},Scope.prototype.execute=function(e,t,n){return this.context.instance.execute(e,t,n)},Scope.prototype.exec=function(e){return this.context.instance.exec(e)},Scope.prototype.evalEden=function(e,t){return this.context.instance.evalEden(e,t,this)},Scope.prototype.symbol=function(e){let t=this.l(e);return t?t.symbol:null},Scope.prototype.project=function(){let e=this.context.instance.project;return e||this.context},Scope.prototype.assertNumber=function(e,t){let n=this.value(e);return"number"!=typeof n&&this.context.instance.error(`expected a number from '${e}'`,t,Eden.RuntimeError.ASSERTTYPE),n},Scope.prototype.assertBoolean=function(e,t){let n=this.value(e);return"boolean"!=typeof n&&this.context.instance.error(`expected a boolean from '${e}'`,t,Eden.RuntimeError.ASSERTTYPE),n},Scope.prototype.assertString=function(e,t){let n=this.value(e);return"string"!=typeof n&&this.context.instance.error(`expected a string from '${e}'`,t,Eden.RuntimeError.ASSERTTYPE),n},Scope.prototype.assertList=function(e,t){let n=this.value(e);return Array.isArray(n)||this.context.instance.error(`expected a list from '${e}'`,t,Eden.RuntimeError.ASSERTTYPE),n},Scope.prototype.assertObject=function(e,t){let n=this.value(e);return"object"!=typeof n&&this.context.instance.error(`expected an object from '${e}'`,t,Eden.RuntimeError.ASSERTTYPE),n},Scope.prototype.assertValid=function(e,t){let n=this.value(e);return void 0===n&&this.context.instance.error(`Missing required value for '${e}'`,t,Eden.RuntimeError.ASSERTVALID),n},Scope.prototype.hasCause=function(e){for(var t=this,n=e;t;){if(t.cause.name==n)return!0;t=t.parent}return!1},Scope.prototype.baseCause=function(){for(var e=this;e.parent&&e.parent.parent;)e=e.parent;return e.cause.name},Scope.prototype.allCauses=function(){for(var e=[],t=this;t;)t.cause&&e.push(t.cause),t=t.parent;return e},Scope.prototype.allOverrides=function(){},Scope.prototype.hasOverride=function(e){for(var t=this;t;){for(var n=0;n<t.overrides.length;n++)if(t.overrides[n].name==e)return!0;t=t.parent}return!1},Scope.prototype.primaryCause=function(){return this.cause&&"null"==this.cause.name&&this.parent&&this.parent.cause?this.parent.cause.name:"null"},Scope.prototype.isRange=function(){return this.range},Scope.prototype.clear=function(){this!==eden.root&&(this.cache=void 0)},Scope.prototype.resetCache=function(){if(this.cachearray)for(var e of this.cachearray)e.up_to_date=e.override;else for(var t in this.cachearray=[],this.cache){(e=this.cache[t]).up_to_date=e.override,this.cachearray.push(e)}},Scope.prototype.rebuild=function(){if(void 0===this.cache){this.cache=Object.create(null);for(var e=0;e<this.overrides.length;e++)this.updateOverride(this.overrides[e]);if(this.context)for(e=0;e<this.overrides.length;e++){var t=this.context.lookup(this.overrides[e].name);this.addSubscribers(t)}}},Scope.prototype.refresh=function(){for(var e=0;e<this.overrides.length;e++)this.updateOverride(this.overrides[e])},Scope.prototype.rebuildForce=function(){for(var e=0;e<this.overrides.length;e++)this.updateSubscriberForce(this.overrides[e],!0)},Scope.prototype.rebuildForceAll=function(){this.rebuildForce(),this.parent&&this.parent!==eden.root.scope&&this.parent.rebuildForceAll()},Scope.prototype.cloneAt=function(e){for(var t=[],n=0;n<this.overrides.length;n++)t.push(new ScopeOverride(this.overrides[n].name,this.overrides[n].start,this.overrides[n].end));var r=new Scope(this.context,this.parent,t,this.range,this.cause);for(n=0;n<e;n++)r.next();return r.range=!1,r},Scope.prototype.lookup=function(e){var t=this.cache[e];if(t)return t;if(this.parent)return this.parent.lookup(e);var n=new ScopeCache(!0,void 0,this.context.lookup(e),!1);return this.cache[e]=n,n},Scope.prototype.l=function(e){var t=this.cache[e];if(t)return t;if(this.parent){if(this.depth>3){let t=this.pcache[e];return t||((t=this.parent.l(e))&&(this.pcache[e]=t),t)}return this.parent.l(e)}},Scope.prototype.v=function(e){if(e.up_to_date)return e.value;var t=e.symbol;return t.definition&&(this.cause?t.liteEvaluate(this,e):t.evaluate(this,e)),e.value},Scope.prototype.value=function(e){var t=this.l(e);if(void 0!==t){if(t.up_to_date)return t.value;var n=t.symbol;return n.definition&&(this.cause?n.liteEvaluate(this,t):n.evaluate(this,t)),t.value}return this.parent?this.parent.value(e):void 0},Scope.prototype.assign=function(e,t,n){var r=this.context.lookup(e);this.isolate?void 0===this.cache[e]?this.cache[e]=new ScopeCache(!0,t,r,!0):(this.cache[e].up_to_date=!0,this.cache[e].override=!0,this.cache[e].value=t):r.assign(t,this,n)},Scope.prototype.mutate=function(e,t,n){this.context.lookup(e).mutate(this,t,n)},Scope.prototype.listAssign=function(e,t,n,r,i){this.context.lookup(e).listAssign(t,this,n,!1,i)},Scope.prototype.define=function(e,t,n,r){this.context.lookup(e).define(t,n,r)},Scope.prototype.lookup2=function(e){if(0==this.isolate)return this.lookup(e);var t=this.cache[e];void 0===t&&(t=new ScopeCache(!0,void 0,this.context.lookup(e),!1),this.cache[e]=t);return t},Scope.prototype.add=function(e,t){var n=new ScopeCache(!1,void 0,t,!1);return this.cache[e]=n,n},Scope.prototype.addIfNotExist=function(e,t){var n=this.cache[e];return n||(n=new ScopeCache(!1,void 0,t,!1),this.cache[e]=n,n)},Scope.prototype.addAlias=function(e,t,n){var r=this.cache[t];return this.cache[e]=r,r},Scope.prototype.addOverride=function(e){if(!this.updateOverride(e)&&this.context){var t=this.context.lookup(e.name);for(var n in t.subscribers)this.updateSubscriber(n)}},Scope.prototype.updateOverride=function(e){var t,n=e.name;if(t=e.current,void 0===this.cache[n]){var r=this.context.lookup(n);return this.cache[n]=new ScopeCache(!0,t,r,!0),!1}var i=this.cache[n];return i.value=t,i.up_to_date=!0,i.override=!0,!0},Scope.prototype.addSubscribers=function(e){var t=[];e.subscribersArray||(e.subscribersArray=Object.keys(e.subscribers)),t.push.apply(t,e.subscribersArray);for(var n=0;n<t.length;){if(!this.cache[t[n]]){var r=t[n],i=this.context.lookup(r);this.cache[r]=new ScopeCache(!1,void 0,i,!1),i.subscribersArray||(i.subscribersArray=Object.keys(i.subscribers)),t.push.apply(t,i.subscribersArray)}++n}},Scope.prototype.addSubscriber=function(e){if(!this.cache[e]){var t=this.context.lookup(e),n=new ScopeCache(!1,void 0,t,!1);for(var r of(this.cache[e]=n,this.cachearray&&this.cachearray.push(n),t.subscribersArray||(t.subscribersArray=Object.keys(t.subscribers)),t.subscribersArray))this.addSubscriber(r)}},Scope.prototype.updateSubscriber=function(e){if(void 0===this.cache[e]){var t=this.context.lookup(e);for(var n in this.cache[e]=new ScopeCache(!1,void 0,t,!1),t.subscribers)this.updateSubscriber(n)}else{var r=this.cache[e];r.up_to_date=!1,r.value=void 0}},Scope.prototype.updateSubscriberForce=function(e,t){var n;void 0===this.cache[e]?(n=new ScopeCache(!1,void 0,this.context.lookup(e),t),this.cache[e]=n):((n=this.cache[e]).up_to_date=!1,n.value=void 0);for(var r in n.symbol.subscribers)this.updateSubscriberForce(r,!1)},Scope.prototype.first=function(){for(var e=this.overrides.length-1;e>=0;e--){var t=this.overrides[e];if(void 0!==t.end){if(t.isin){var n=isbound?t.start.value.length:t.start?t.start.length:0;return t.index<n}if(t.current<=t.end)return!0}}return!1},Scope.prototype.mergeCache=function(e){e||console.error("Missing scope cache"),this.cache=e.cache,this.cachearray=e.cachearray},Scope.prototype.reset=function(){this.resetCache(),this.refresh()},Scope.prototype.next=function(){this.resetCache();for(var e=this.overrides.length-1;e>=0;e--){var t=this.overrides[e];if(void 0!==t.end||t.isin){var n=t.start?t.start.length:0;if(t.isin){if(t.index<n)return t.current=t.start[t.index],t.index++,this.refresh(),!0;t.index=1,t.current=t.start[0]}else{if(t.current<t.end)return t.increment?t.current+=t.increment:t.current++,this.refresh(),!0;t.current=t.start}}}return!1},Eden.Scope=Scope,Eden.ScopeOverride=ScopeOverride,edenCopy=copy,function(){function e(e,t){this.context=e,this.name=t,this.cache=e?e.scope.add(t,this):new ScopeCache(!0,void 0,this,!1),this.definition=void 0,this.def_scope=void 0,this.extend=void 0,this.needsGlobalNotify=0,this.has_evaled=!1,this.isasync=!1,this.volatile=!1,this.eager=!1,this.scopecount=0,this.changed=!0,this.dependencies=Object.create(null),this.subscribers=Object.create(null),this.subscribersArray=null,this.dynamicDependencies=Object.create(null),this.observers=Object.create(null),this.observees=Object.create(null),this.jsObservers={},this.origin=void 0,this.garbage=!1}Object.defineProperty(e.prototype,"type",{get:function(){return this.origin&&this.origin.type?this.origin.type:"assignment"}}),Object.defineProperty(e.prototype,"lvalue",{get:function(){return this.origin?this.origin.lvalue:void 0}}),Object.defineProperty(e.prototype,"expression",{get:function(){return this.origin?this.origin.expression:void 0}}),Object.defineProperty(e.prototype,"doxyComment",{get:function(){return this.origin?this.origin.doxyComment:void 0}}),Object.defineProperty(e.prototype,"parent",{get:function(){return this.context}}),Object.defineProperty(e.prototype,"stamp",{get:function(){return this.origin?this.origin.stamp:void 0}}),Object.defineProperty(e.prototype,"id",{get:function(){return this.origin&&this.origin.id?this.origin.id:this.name}}),Object.defineProperty(e.prototype,"executed",{get:function(){return 1}}),e.prototype.buildID=function(){},e.prototype.getStartLine=function(e){return this.origin?this.origin.getStartLine(e):-1},e.prototype.getASTOrigin=function(){if(this.origin){for(var e=this.origin;e.parent;)e=e.parent;if(e.base)return e.base.origin}},e.prototype.getOrigin=function(){if(this.origin)return this.origin.getOrigin()},InternalAgent=function(e,t){this.name=e,this.local=t,this.internal=!0},InternalAgent.prototype.getOrigin=function(){return"*Default"!=this.name?eden.project:void 0},InternalAgent.prototype.numlines=0,e.hciAgent=new InternalAgent("*Input Device",!0),e.jsAgent=new InternalAgent("*JavaScript",!1),e.localJSAgent=new InternalAgent("*JavaScript",!0),e.netAgent=new InternalAgent("*net",!0),e.defaultAgent=new InternalAgent("*Default",!0),e.NONOTIFY=0,e.CREATED=1,e.EXPIRED=2,e.REDEFINED=3,e.ASSIGNED=4,e.ASYN_UPDATE=5,e.prototype.value=function(e){if(e&&e.isRange())return this.multiValue(e);var t=e;this.garbage=!1,void 0===t&&(t=this.context.scope);var n=void 0===this.context||t===this.context.scope?this.cache:t.lookup(this.name);return this.definition&&(n.up_to_date||this.evaluate(t,n)),n.value},e.prototype.multiValue=function(e){var t=[];if(console.log("mutli value"),e.range=!1,!e.first())return[];for(;;){var n=this.value(e);if(void 0!==n&&t.push(n),0==e.next())break}return e.range=!0,(void 0===this.context||e===this.context.scope?this.cache:e.lookup(this.name)).scope=e,t},e.prototype.evaluate=function(e,t){this.context&&this.context.beginEvaluation(this),this.subscribersArray||(this.subscribersArray=Object.keys(this.subscribers));try{t.up_to_date=!this.volatile,this.has_evaled||this.clearDynamicDependencies(),this.has_evaled=!0,this.scopecount=0;let n=t.value;t.value=this.definition.call(this,this.context,e,t),this.scopecount>1e3&&console.log("Scope count for "+this.name,this.scopecount),this.changed=n!==t.value}catch(e){if(e instanceof Eden.RuntimeError&&this.context.instance.emit("error",[this,e]),t.up_to_date=!this.volatile,-1===e)return this.context&&this.context.endEvaluation(this),-1;t.value=void 0,this.changed=!0}this.context&&this.context.endEvaluation(this)},e.prototype.liteEvaluate=function(e,t){this.subscribersArray||(this.subscribersArray=Object.keys(this.subscribers)),t.up_to_date=!this.volatile,t.value=void 0,this.has_evaled||this.clearDynamicDependencies(),this.has_evaled=!0;try{t.value=this.definition.call(this,this.context,e,t)}catch(e){}},e.prototype.clearObservees=function(){for(var e in this.observees){this.observees[e].removeObserver(this.name)}this.observees=Object.create(null)},e.prototype.subscribe=function(){for(var e=Utils.flatten(arguments),t=0;t<e.length;++t){var n=e[t],r=this.context.lookup(n);if(r.name!=this.name){r.addSubscriber(this.name,this);var i=r.name;this.dependencies[i]=r,delete this.dynamicDependencies[i]}}return this},e.prototype.subscribeDynValue=function(e,t,n){let r=t.name;return this.subscribeDynamic(e,r,n),t.value(n)},e.prototype.subscribeDynamicSym=function(e){e.name in this.dependencies||e.name in this.dynamicDependencies||(e.addSubscriber(this.name,this),this.dynamicDependencies[e.name]=e)},e.prototype.subscribeDynamic=function(e,t,n){if(!Eden.isValidIdentifier(t))return"__error__";var r=this.context.lookup(t);return n&&n!==this.context.scope&&n.cause&&r.definition&&!n.cache[t]&&n.addSubscriber(t),this.dependencies[t]||this.dynamicDependencies[t]||(r.addSubscriber(this.name,this),this.dynamicDependencies[r.name]=r),t},e.prototype.clearDependencies=function(){for(var e in this.dependencies)this.dependencies[e].removeSubscriber(this.name);for(var e in this.dependencies=Object.create(null),this.dynamicDependencies)this.dynamicDependencies[e].removeSubscriber(this.name);this.dynamicDependencies=Object.create(null)},e.prototype.clearDynamicDependencies=function(){var e=0;for(var t in this.dynamicDependencies)this.dynamicDependencies[t].removeSubscriber(this.name),++e;e>0&&(this.dynamicDependencies=Object.create(null))},e.prototype.getSource=function(){return this.origin&&!this.origin.internal?this.origin.getSource():this.name+" = "+Eden.edenCodeForValue(this.value())+";"},e.prototype.toString=function(){return"&"+this.name},e.prototype.indirectDependencies=function(e){var t=e||{};for(var n in this.dependencies){var r=this.dependencies[n];t[n]=r,r.indirectDependencies(t)}for(var n in this.dynamicDependencies){r=this.dynamicDependencies[n];t[n]=r,r.indirectDependencies(t)}return t},e.prototype.indirectSubscribers=function(e){var t=e||{};for(var n in this.subscribers){var r=this.subscribers[n];t[n]=r,r.indirectSubscribers(t)}return t},e.prototype.define=function(t,n,r,i){return this.garbage=!1,this.definition=t,this.origin=n,this.needsGlobalNotify=e.REDEFINED,this.clearObservees(),this.clearDependencies(),this.subscribe(r),this.context&&this.context.expireEdenSymbol(this),this.context.instance.peer&&this.context.instance.peer.define(n,this.name,n.getSource(),r),this},e.prototype.expireSubscribers=function(){for(var t in this.subscribers){let n=this.subscribers[t];n.needsGlobalNotify=e.EXPIRED,this.context.expireEdenSymbol(n)}},e.prototype.expireAsync=function(){this.context&&(this.needsGlobalNotify=e.ASYNC_UPDATE,this.context.expireEdenSymbol(this))},e.prototype.observe=function(e){e=Utils.flatten(arguments);for(var t=0;t<e.length;++t){var n=this.context.lookup(e[t]);this.observees[n.name]=n,n.addObserver(this.name,this)}return this.context&&this.context.triggerEdenSymbol(this),this},e.prototype.stopObserving=function(e){this.observees[e].removeObserver(this.name),this.observees[e]=void 0},e.prototype.isUpToDate=function(){return this.cache.up_to_date},e.prototype.append=function(e,t,n){var r=this.value(t);r.push(e),this.assign(r,t,n)},e.prototype.hasChanged=function(){return this.cache.up_to_date||this.value(),this.changed},e.prototype.assign=function(t,n,r){this.garbage=!1,this.cache.value!==t&&(t=copy(t)),"autocalc"===this.name&&(!0===t?t=1:!1===t&&(t=0),this.context&&this.context.autocalc(1===t));var i=void 0===this.context||n==this.context.scope?this.cache:n.lookup2(this.name);return i.symbol!==this?(console.log("Different symbols for "+this.name),void i.symbol.assign(t,n,r)):(this.origin=r,this.needsGlobalNotify=this.definition?e.REDEFINED:e.ASSIGNED,this.definition=void 0,this.has_evaled=!0,this.extend=void 0,this.changed=i.value!==t,i.value=t,i.up_to_date=!0,this.clearObservees(),this.clearDependencies(),this.context&&this.context.expireEdenSymbol(this),this.context.instance&&this.context.instance.peer&&this.context.instance.peer.assign(r,this.name,t),this)},e.prototype.assigned=function(e){return this.garbage=!1,this.origin=e,this.definition=void 0,this.clearObservees(),this.clearDependencies(),this},e.prototype.mutate=function(t,n,r,i){this.garbage=!1;this.origin=r,this.value(t),this.definition=void 0,this.needsGlobalNotify=e.ASSIGNED;for(var s=[],o=1;o<arguments.length;o++)s.push(arguments[o]);return n.apply(void 0,[this].concat(s)),this.context&&this.context.expireEdenSymbol(this),this},e.prototype.getEdenCode=function(){return"&"+this.name},e.prototype.trigger=function(){try{this.value().call(this,this.context,this.context.scope)}catch(t){var e=new Eden.RuntimeError(void 0,Eden.RuntimeError.PROCAGENT,void 0,"Triggered proc failed: "+t);this.context.instance.emit("error",[this,e])}},e.prototype.fireJSObservers=function(){for(var e in this.jsObservers)try{this.jsObservers[e](this,this.value())}catch(r){var t=new Eden.RuntimeError(void 0,Eden.RuntimeError.JSOBSERVER,void 0,"JavaScript observer '"+e+"' failed: "+r);if(this.context.instance.emit("error",[this,t]),this.context){var n=this.cache.value;"object"==typeof n&&n.jsExceptions}else!1;throw r}},e.prototype.expire=function(t,n,r,i){if(this.has_evaled||i&&this.needsGlobalNotify!=e.EXPIRED)if(this.isasync&&this.definition&&this.needsGlobalNotify!=e.ASYNC_UPDATE){this.context&&this.context.beginEvaluation(this),this.has_evaled=!1;try{this.clearDynamicDependencies(),this.definition.call(this,this.context,this.context.scope,this.cache).then(e=>{this.has_evaled=!0,this.cache.up_to_date=!0,this.changed=this.cache.value!==e,this.cache.value=e,this.expireAsync()})}catch(e){e instanceof Eden.RuntimeError&&this.context.instance.emit("error",[this,e]),console.error(this.name,e),this.cache.value=void 0,this.changed=!0,this.cache.up_to_date=!0}this.context&&this.context.endEvaluation(this)}else{if(this.definition&&this.needsGlobalNotify!=e.ASYNC_UPDATE&&(this.cache.up_to_date=!1,this.has_evaled=!1,t[this.name]=n.value,n.value++,i&&(this.cache.scopes=null),this.eager&&-1===this.evaluate(this.context.scope,this.cache)))return;for(var s in this.observers)r[s]=this.observers[s];for(var o in this.needsGlobalNotify=e.EXPIRED,this.subscribers){var a=this.subscribers[o];a&&a.expire(t,n,r,i)}}},e.prototype.isDependentOn=function(e){if(e==this.name||this.dependencies[e])return!0;for(var t in this.dependencies)if(this.dependencies[t].isDependentOn(e))return!0;for(var t in this.dynamicDependencies)if(this.dynamicDependencies[t].isDependentOn(e))return!0;return!1},e.prototype.getDependencies=function(){var e=[];for(var t in this.dependencies)e.push(t);return console.log("Dependencies"),e},e.prototype.assertNotDependentOn=function(e,t){if(void 0===t&&(t=[]),t.push(this.name),this.dependencies[e]){var n=t.join(" -> ")+" -> "+e+" -> "+t[0];throw new Error("Cyclic dependency detected: "+n)}for(var r in this.dependencies)this.dependencies[r].assertNotDependentOn(e,t);for(var r in this.dynamicDependencies)this.dynamicDependencies[r].assertNotDependentOn(e,t);t.pop()},e.prototype.addSubscriber=function(e,t){this.garbage=!1,this.subscribers[e]=t,this.subscribersArray&&this.subscribersArray.push(e)},e.prototype.removeSubscriber=function(e){delete this.subscribers[e],this.subscribersArray=null,void 0===this.origin&&this.canSafelyBeForgotten()&&this.forget()},e.prototype.canSafelyBeForgotten=function(){for(var e in this.subscribers)return!1;for(var t in this.observers)return!1;return!0},e.prototype.forget=function(){for(var e in this.origin=void 0,this.definition=void 0,this.cache.value=void 0,this.cache.up_to_date=!0,this.context&&this.context.expireEdenSymbol(this),this.clearObservees(),this.clearDependencies(),this.garbage=!0,this.jsObservers)this.jsObservers[e].call(this,this,void 0);this.jsObservers={},this.context.queueForGarbageCollection(this)},e.prototype.addObserver=function(e,t){this.garbage=!1,this.observers[e]=t},e.prototype.addJSObserver=function(e,t){if("function"!=typeof t)throw new Error("Failed adding JavaScript observer "+t);this.jsObservers[e]=t,0==this.cache.up_to_date&&this.value()},e.prototype.removeObserver=function(e){delete this.observers[e],void 0===this.origin&&this.canSafelyBeForgotten()&&this.forget()},e.prototype.removeJSObserver=function(e){delete this.jsObservers[e]},e.prototype.addExtension=function(t,n,r,i,s){if(!this.definition)throw new Error(Eden.RuntimeError.EXTENDSTATIC);void 0===this.extend&&(this.extend={}),this.extend[t]={code:n,source:r,deps:s},this.subscribe(s),this.needsGlobalNotify=e.REDEFINED,this.context&&this.context.expireEdenSymbol(this)},e.prototype.listAssign=function(t,n,r,i,s){if(this.definition){if(this.origin&&"definition"==this.origin.type){var o=this.origin.locatePrimary(s);if(o)return void this.context.lookup(o).assign(t,n,r)}throw new Error(Eden.RuntimeError.ASSIGNTODEFINED)}for(var a=this.value(n),d=0;d<s.length-1;d++)a&&(a=a[s[d]]);if(!a)throw new Error(Eden.RuntimeError.ASSIGNDIMENSION);return a[s[s.length-1]]=t,this.origin=r,this.needsGlobalNotify=e.ASSIGNED,this.context&&this.context.expireEdenSymbol(this),this.context.instance.peer&&this.context.instance.peer.listAssign(r,this.name,t,s),this},Eden.EdenSymbol=e}();var EdenSymbol=Eden.EdenSymbol;function fireActions(e,t){let n=Date.now();for(var r in e){var i=e[r];i&&i.trigger(t,n)}}function fireJSActions(e){for(var t=0;t<e.length;t++)e[t].fireJSObservers()}function Folder(e,t,n,r){this.type="script",this.executed=1,this.start=0,this.end=0,this.prefix="",this.postfix="",this.id="ACTIVE",this.instance=t||{},this.name=e||"ACTIVE",this.base={origin:void 0},this.errors=[],this.lock=1,this.numlines=0,this.root=r||this,this.scope=new Eden.Scope(this,void 0,{}),this.symbols=Object.create(null),this.f=Object.create(null),this.delayedaction=Object.create(null),this.autoaction=!0,this.globalobservers=[],this.subscribers={},this.autocalc_state=!0,this.needsExpire=[],this.needsTrigger={},this.firetimer=void 0,this.needsGlobalNotify=[],this.globalNotifyIndex=0,this.expiryCount=new Pointer(0),this.potentialGarbage={},this.saved_autocalc_state=!0,this.saved_autocalc_level=0,this.currentObservables=[],Object.defineProperty(this,"statements",{enumerable:!0,get:function(){var e=this;return Object.keys(this.symbols).map(function(t){return e.symbols[t]})}}),Object.defineProperty(this,"parent",{enumerable:!0,get:function(){return eden.project.ast.script}})}if(Folder.prototype.registerAgent=function(e){},Folder.prototype.addSubscriber=function(e){this.subscribers[e]=this.lookup(e)},Folder.prototype.removeSubscriber=function(e){delete this.subscribers[e]},Folder.prototype.getNumberOfLines=function(){return this.numlines+1},Folder.prototype.hasErrors=function(){return!1},Folder.prototype.getOrigin=function(){return eden.project},Folder.prototype.getStatementByLine=function(e){},Folder.prototype.getStartLine=function(e){return this.parent?this.parent.getRelativeLine(this,e):-1},Folder.prototype.getRange=function(e){var t=this.getStartLine(e);return[t,t+this.getNumberOfLines()]},Folder.prototype.getInnerSource=function(){var e="";for(var t in this.numlines=0,this.symbols){var n=this.symbols[t];if(n.origin&&n.origin.getOrigin){var r=n.origin.getOrigin();if(!r||r&&!r.remote){var i=n.getSource();i&&(e+=i+"\n",this.numlines+=n.origin.numlines+1)}}}return e},Folder.prototype.destroy=function(){},Folder.prototype.getSource=function(){var e="action ACTIVE {\n";return e+=this.getInnerSource(),e+="}"},Folder.prototype.execute=function(){},Folder.prototype.lookup=function(e){if(void 0===this.symbols[e]){for(var t in this.symbols[e]=new Eden.EdenSymbol(this,e),this.subscribers)this.expireEdenSymbol(this.subscribers[t]);this.notifyGlobals(this.symbols[e],1)}return this.symbols[e]},Folder.prototype.currentObservableName=function(){return 0==this.currentObservables.length?void 0:this.currentObservables[this.currentObservables.length-1].name},Folder.prototype.beginEvaluation=function(e){this.currentObservables.push(e)},Folder.prototype.endEvaluation=function(e){this.currentObservables.pop()},Folder.prototype.queueForGarbageCollection=function(e){this.potentialGarbage[e.name]=e},Folder.prototype.collectGarbage=function(){for(var e in this.potentialGarbage)this.potentialGarbage[e].garbage&&delete this.symbols[e];this.potentialGarbage={}},Folder.prototype.putEval=function(e,t){this.evalResults[e]=t},Folder.prototype.getEval=function(e){return this.evalResults[e]},Folder.prototype.clearEval=function(e){delete this.evalResults[e]},Folder.prototype.addGlobal=function(e){this.globalobservers.push(e)},Folder.prototype.removeGlobal=function(e){for(var t=0;t<this.globalobservers.length;t++)if(this.globalobservers[t]===e)return this.globalobservers.splice(t,1),!0;return!1},Folder.prototype.notifyGlobals=function(e,t){for(var n=0;n<this.globalobservers.length;n++)void 0!==this.globalobservers[n]&&this.globalobservers[n].call(this,e,t)},Folder.prototype.autocalc=function(e){this.autocalc_state=e,this.expireAndFireActions()},Folder.prototype.beginAutocalcOff=function(){this.saved_autocalc_level++,1==this.saved_autocalc_level&&(this.saved_autocalc_state=this.autocalc_state,this.autocalc_state&&this.autocalc(!1))},Folder.prototype.endAutocalcOff=function(){this.saved_autocalc_level--,0==this.saved_autocalc_level&&this.saved_autocalc_state&&this.autocalc(!0)},Folder.prototype.expireEdenSymbol=function(e){-1==this.needsExpire.indexOf(e)&&this.needsExpire.push(e),this.expireAndFireActions()},Folder.prototype.triggerEdenSymbol=function(e){if(this.needsTrigger[e.name]=e,void 0===this.firetimer){var t=this;this.firetimer=setTimeout(function(){this.firetimer=void 0,t.expireAndFireActions()},0)}},Folder.prototype.expireAndFireActions=function(){if(this.autocalc_state){this.expiryCount.value=0;var e={},t=this.needsExpire;this.needsExpire=[];for(var n=0;n<t.length;n++){(s=t[n]).expire(e,this.expiryCount,this.needsTrigger,s.needsGlobalNotify==EdenSymbol.REDEFINED)}var r=Object.keys(e);r.sort(function(t,n){return e[t]-e[n]});var i=[];for(n=0;n<r.length;n++){var s;(s=this.symbols[r[n]]).needsGlobalNotify=EdenSymbol.EXPIRED,i.push(s)}var o=this.needsTrigger;if(this.needsTrigger={},fireActions(o,this.scope),this.autoaction)if(fireJSActions(t),fireJSActions(i),0==this.needsGlobalNotify.length){if(i.push.apply(i,t),i.length>0){this.needsGlobalNotify=i;var a=this;setTimeout(function(){a.processGlobalNotifyQueue()},0)}}else{var d=this.needsGlobalNotify;d.push.apply(d,i),d.push.apply(d,t)}else{for(var c of t)this.delayedaction[c.name]=c;for(var c of i)this.delayedaction[c.name]=c}}},Folder.prototype.enableActions=function(){this.autoaction=!0;var e=Object.values(this.delayedaction);e.length>0&&fireJSActions(e),this.delayedaction=Object.create(null)},Folder.prototype.processGlobalNotifyQueue=function(){for(var e=this.needsGlobalNotify,t=0;t<e.length;){this.globalNotifyIndex++;var n=e[t];if(n.needsGlobalNotify){var r=n.needsGlobalNotify;n.needsGlobalNotify=0,this.notifyGlobals(n,r)}t=this.globalNotifyIndex}this.needsGlobalNotify=[],this.globalNotifyIndex=0},Folder.prototype.forgetAll=function(){var e,t,n,r,i,s,o=void 0;if(arguments.length>4)return eden.error(new Error("forgetAll: This function requires at most 4 arguments."),"error"),[[],void 0,[]];if(0==arguments.length)e="";else if("string"==typeof arguments[0])e=arguments[0];else{if(!Array.isArray(arguments[0]))return void 0===arguments[0]?[[],void 0,[]]:(eden.error(new Error("forgetAll: The first argument must be a string, not a "+typeof arguments[0]),"error"),[[],void 0,[]]);o=arguments[0]}if(arguments.length>1){if("boolean"!=typeof arguments[1])return eden.error(new Error("forgetAll: The second argument must be a boolean, not a "+typeof arguments[1]),"error"),[[],void 0,[]];t=arguments[1]}else t=!0;if(void 0!==o&&arguments.length>2)return eden.error(new Error("forgetAll: Cannot specify case sensitivity when selecting using a list."),"error"),[[],void 0,[]];if(arguments.length>=3){if("boolean"!=typeof arguments[2])return eden.error(new Error("forgetAll: The third argument must be a boolean, not a "+typeof arguments[2]),"error"),[[],void 0,[]];n=arguments[2]}else n=void 0===o||2!=arguments.length||arguments[1];if(arguments.length>3){if("boolean"!=typeof arguments[3])return eden.error(new Error("forgetAll: The forth argument must be a boolean, not a "+typeof arguments[3]),"error"),[[],void 0,[]];r=arguments[3]}else r=!1;var a,d={},c=[],h={};if(void 0!==o)for(var p=0;p<o.length;p++){if(o[p]instanceof s)g=o[p].name,s=o[p];else{if("string"!=typeof o[p]){if(void 0===o)continue;return eden.error(new Error("forgetAll: All list items must be strings or pointers.  Item "+p+" is a "+typeof o[p]),"error"),[[],void 0,[]]}g=o[p],s=root.lookup(g)}if(r||!Eden.isitSystemEdenSymbol(g))if(a=eden.initialDefinition(g))h[g]=a;else{var l=[];for(var u in s.subscribers)l.push(u);for(var E in s.observers)l.push(E);d[g]=l}else c.push(g)}else{i=t?new RegExp(e):new RegExp(e,"i");var f=/^_[vV]iew(s?)_/;for(var g in root.symbols)if(i.test(g)){if(!r&&(Eden.isitSystemEdenSymbol(g)||f.test(g)))continue;s=root.symbols[g];l=[];for(var u in s.subscribers)l.push(u);for(var E in s.observers)l.push(E);d[g]=l}}var S,m={},y=function(e){if(e in m)return m[e];if(e in h)return!0;if(!(e in d))return m[e]=!1,!1;var t=d[e];if(0==t.length)return m[e]=!0,!0;for(var n=0;n<t.length;n++){if(!y(t[n]))return m[e]=!1,!1}return m[e]=!0,!0},v=[];for(g in d){y(g)?v.push(g):c.push(g)}var x=Object.keys(h),T=v.concat(x);if(T.length>0&&n)if(T.length<=50)S=confirm("You are about to delete the following "+T.length+" symbols.  Is this correct?\n\n"+T.join("\n"));else{var A=T.length-50;S=confirm("You are about to delete "+T.length+" symbols.  Is this correct?\n\n"+T.slice(0,50).join("\n")+"\n...\n("+A+" more)")}else S=!0;if(S){for(g in root.beginAutocalcOff(),h);for(p=0;p<v.length;p++){g=v[p];if(void 0!==(s=root.symbols[g])){"refreshView"in s.jsObservers&&(s.assign(void 0,root.scope),edenUI.plugins.Canvas2D&&edenUI.plugins.Canvas2D.destroyViews&&edenUI.plugins.Canvas2D.destroyViews(g)),s.forget();var b=g.match(/^_view_(.*)_content$/);null!==b&&edenUI.destroyView(b[1],!0)}}return root.collectGarbage(),root.endAutocalcOff(),[v,c,x]}return[[],c,[]]},Eden.Folder=Folder,Eden.DB={directory:{},meta:{},remoteMeta:{},remoteURL:void 0,username:void 0,userid:void 0,repositories:[document.location.protocol+"//jseden.dcs.warwick.ac.uk/construalmanager","http://localhost:18882"],repoindex:0,retrycount:0,connected:!1,searchServer:document.location.protocol+"//jseden.dcs.warwick.ac.uk",querycache:null,qcacheloaded:!1,qcachetimeout:void 0},Eden.DB.storageSpace=function(){var e,t=0;for(e in localStorage)t+=2*(localStorage[e].length+e.length);return t},console.log("Local Usage:",Eden.DB.storageSpace()/1024/1024+"Mb"),Eden.DB.storageSpace()>4194304)for(var x in console.log("WARNING - CLEARING LOCAL STORAGE"),window.localStorage)delete window.localStorage[x];function removeActive(e){for(var t=e.indexOf("action ACTIVE {"),n=1,r=t+16;r<e.length;r++){var i=e.charAt(r);if("{"==i?n++:"}"==i&&n--,0==n)break}return e.substring(0,t)+e.substring(r)}Eden.DB.listeners={},Eden.DB.emit=emit,Eden.DB.listenTo=listenTo,Eden.DB.isConnecting=function(){return void 0!==Eden.DB.remoteURL},Eden.DB.isConnected=function(){return Eden.DB.connected},Eden.DB.isLoggedIn=function(){return void 0!==Eden.DB.username},Eden.DB.logOut=function(e){Eden.DB.isLoggedIn()&&$.ajax({url:Eden.DB.remoteURL+"/logout",type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(t){Eden.DB.username=void 0,Eden.DB.emit("logout",[]),e&&e(),function e(){Eden.DB.isConnected()&&void 0===Eden.DB.username&&setTimeout(function(){Eden.DB.getLoginName(function(t){t?(Eden.DB.emit("login",[t]),eden.root.lookup("jseden_pm_user").assign(t,eden.root.scope,Symbol.localJSAgent)):e()})},5e3)}()},error:function(e){Eden.DB.disconnect(!0)}})},Eden.DB.connect=function(e,t){function n(){Eden.DB.isConnected()&&void 0===Eden.DB.username&&setTimeout(function(){Eden.DB.getLoginName(function(e){e?(Eden.DB.emit("login",[e]),eden.root.lookup("jseden_pm_user").assign(e,eden.root.scope,Symbol.localJSAgent),function e(){Eden.DB.isConnected()&&setTimeout(function(){Eden.DB.getLoginName(function(t){t?e():Eden.DB.disconnect()})},3e5)}()):n()})},5e3)}Eden.DB.remoteURL=e,function e(t){for(var n in t)t[n].missing=!0,t[n].children&&e(t[n].children)}(Eden.DB.directory),Eden.DB.refreshint=setInterval(function(){for(var e in Eden.DB.directory)Eden.DB.directory[e].missing=!0},2e4),Eden.DB.getLoginName(function(r){Eden.DB.isConnected()?(Eden.DB.retrycount=0,t&&t(Eden.DB.isConnected()),Eden.DB.emit("connected",[e]),eden.root.lookup("jseden_pm_connected").assign(!0,eden.root.scope,Symbol.localJSAgent),r?(Eden.DB.emit("login",[r]),eden.root.lookup("jseden_pm_user").assign(r,eden.root.scope,Symbol.localJSAgent)):n()):t&&t(Eden.DB.isConnected())})},Eden.DB.disconnect=function(e){Eden.DB.remoteURL=void 0,Eden.DB.connected&&(Eden.DB.emit("disconnected",[]),eden.root.lookup("jseden_pm_connected").assign(!1,eden.root.scope,Symbol.localJSAgent)),Eden.DB.connected=!1,Eden.DB.refreshint&&(clearInterval(Eden.DB.refreshint),Eden.DB.refreshint=void 0),e&&(Eden.DB.retrycount<12&&Eden.DB.retrycount++,setTimeout(function(){Eden.DB.repoindex>=Eden.DB.repositories.length&&(Eden.DB.repoindex=Eden.DB.repositories.length-1),Eden.DB.connect(Eden.DB.repositories[Eden.DB.repoindex]),Eden.DB.repoindex=(Eden.DB.repoindex+1)%Eden.DB.repositories.length},200*Math.pow(2,Math.ceil(Eden.DB.retrycount/Eden.DB.repositories.length))))},Eden.DB.getLoginName=function(e){Eden.DB.isConnecting()?$.ajax({url:Eden.DB.remoteURL+"/user/details",type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(t){Eden.DB.connected=!0,null==t||t.error?(Eden.DB.username=void 0,e()):(Eden.DB.username=t.name,Eden.DB.userid=t.id,!t.id||""!=t.name&&t.name||(Eden.DB.username="NoName"),e(Eden.DB.username))},error:function(t,n,r){Eden.DB.disconnect(!0),e(void 0)}}):e()},Eden.DB.localSave=function(e){if(window.localStorage){var t="project_"+e.id;window.localStorage.setItem(t+"_project",e.generate()),window.localStorage.setItem(t+"_id",e.id),window.localStorage.setItem(t+"_vid",e.vid),window.localStorage.setItem(t+"_author",e.author),window.localStorage.setItem(t+"_authorid",e.authorid),window.localStorage.setItem(t+"_name",e.name),window.localStorage.setItem(t+"_title",e.title),window.localStorage.setItem(t+"_thumb",e.thumb),window.localStorage.setItem(t+"_desc",e.desc),window.localStorage.setItem(t+"_tags",e.tags.join(" "));var n=JSON.parse(window.localStorage.getItem("project_list"));null===n&&(n={}),n[e.id]=!0,window.localStorage.setItem("project_list",JSON.stringify(n))}},Eden.DB.save=function(e,t,n){Eden.DB.isConnected()?$.ajax({url:this.remoteURL+"/project/add",type:"post",crossDomain:!0,xhrFields:{withCredentials:!0},data:{projectID:e.id,title:e.title,source:e.generate(),tags:e.tags.join(" "),minimisedTitle:e.name,from:e.vid,image:e.thumb,listed:t,metadata:JSON.stringify({description:e.desc,env:e.environment()}),parentProject:e.parentid},success:function(t){null===t||t.error?(Eden.DB.localSave(e),console.error(t),Eden.DB.emit("error",[t?t.description:"No response from server"]),n&&n(!1)):(console.log("Saved",t),e.id=t.projectID,e.vid=t.saveID,e.readPassword=t.readPassword,e.author=Eden.DB.username,e.authorid=Eden.DB.userid,Eden.DB.localSave(e),n&&n(!0))},error:function(t,r,i){Eden.DB.localSave(e),Eden.DB.handleError(t,r,i),n&&n(!1)}}):(Eden.DB.localSave(e),console.error("Cannot upload, not connected to server. Local save only."),n&&n(!1),eden.error("Cannot upload "+path+", not connected to server. Local save only"))},Eden.DB.getVersions=function(e,t){Eden.DB.isConnected()?$.ajax({url:Eden.DB.remoteURL+"/project/versions?projectID="+e,type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){t(e)},error:function(e){Eden.DB.disconnect(!0)}}):t(void 0)},Eden.DB.loadLocal=function(e){if(window.localStorage){var t="project_"+e,n=window.localStorage.getItem(t+"_project");"undefined"==(e=window.localStorage.getItem(t+"_id"))&&(e=void 0);var r=window.localStorage.getItem(t+"_vid");"undefined"==r&&(r=void 0);var i=window.localStorage.getItem(t+"_author");"undefined"==i&&(i=void 0);var s=window.localStorage.getItem(t+"_authorid"),o=window.localStorage.getItem(t+"_name"),a=window.localStorage.getItem(t+"_tags"),d=window.localStorage.getItem(t+"_thumb");"undefined"==d&&(d=void 0);var c=window.localStorage.getItem(t+"_desc"),h=window.localStorage.getItem(t+"_title");if(n&&""!=n)return{source:n,saveID:r,title:h,ownername:i,owner:s,image:d,tags:a,parentProject:null,minimisedTitle:o,projectMetaData:JSON.stringify({description:c})}}},Eden.DB.hasLocal=function(e,t){var n=JSON.parse(window.localStorage.getItem("project_list"));if(null!==n&&n[e]){if(!t)return!0;var r="project_"+e,i=window.localStorage.getItem(r+"_vid");return console.log("Load local",i,t),(i=parseInt(i))>=t}return!1},Eden.DB.load=function(e,t,n,r){if(3==arguments.length&&(r=n,n=void 0),Eden.DB.isConnected())$.ajax({url:Eden.DB.remoteURL+"/project/get?projectID="+e+(t?"&to="+t:"")+(n?"&readPassword="+n:""),type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(n){if(null==n||n.error)r(void 0,"No such version"),console.error("No such version "+t+" for "+e),console.log(n),Eden.DB.emit("error",[n?n.description:"No response from server"]);else if(eden.root.lookup("jseden_autosave").value()&&Eden.DB.hasLocal(e,n.saveID)){console.log("Yes, load local");var i=Eden.DB.loadLocal(e);if(removeActive(i.source)!=removeActive(n.source)){var s=window.confirm("You have local changes, restore these?");r(s?i:n)}else r(n)}else r(n)},error:function(e,t,n){Eden.DB.handleError(e,t,n),r(void 0,"Disconnected")}});else if(r){if(eden.root.lookup("jseden_autosave").value()&&Eden.DB.hasLocal(e,t))window.confirm("You have local changes, restore these?")?r(Eden.DB.loadLocal(e)):r(void 0,"Disconnected");else r(void 0,"Disconnected")}},Eden.DB.search=function(e,t,n,r,i){var s=this.remoteURL+"/project/";s+=""==e?"search?limit="+n+"&offset="+(t-1)*n:"search?limit="+n+"&offset="+(t-1)*n+"&query="+encodeURIComponent(e),r&&(s+="&by="+r),$.ajax({url:s,type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){if(e&&e.error)return console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]),void i(void 0);i(e||void 0)},error:function(e,t,n){Eden.DB.handleError(e,t,n),i(void 0)}})},Eden.DB.getMeta=function(e,t){var n=this.remoteURL+"/project/";n+="search?limit=20&query=.id("+e+")",$.ajax({url:n,type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){if(e&&e.error)return console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]),void t(void 0);t(e||void 0)},error:function(e,t,n){Eden.DB.handleError(e,t,n)}})},Eden.DB.remove=function(e,t){$.ajax({url:this.remoteURL+"/project/remove",type:"post",crossDomain:!0,xhrFields:{withCredentials:!0},data:{projectID:e},success:function(e){null===e||e.error?(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]),t&&t(!1)):(console.log("Removed",e),t&&t(!0))},error:function(e,n,r){Eden.DB.handleError(e,n,r),t&&t(!1)}})},Eden.DB.rate=function(e,t){$.ajax({url:this.remoteURL+"/project/rate",type:"post",crossDomain:!0,xhrFields:{withCredentials:!0},data:{projectID:e,stars:t},success:function(e){(null===e||e.error)&&(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]))},error:function(e,t,n){Eden.DB.handleError(e,t,n)}})},Eden.DB.patch=function(e,t){$.ajax({url:this.remoteURL+"/project/patch",type:"post",crossDomain:!0,xhrFields:{withCredentials:!0},data:{selector:e,source:t},success:function(e){(null===e||e.error)&&(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]))},error:function(e,t,n){Eden.DB.handleError(e,t,n)}})},Eden.DB.getSelector=function(e,t,n){Eden.DB.isConnected()?$.ajax({url:this.remoteURL+"/code/get?selector="+e.replace("#","%23")+"&timestamp="+t,type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){(null===e||e.error)&&(Eden.DB.emit("error",[e?e.description:"No response from server"]),n({})),n(e||{})},error:function(e,t,r){n({}),Eden.DB.handleError(e,t,r)}}):n({})},Eden.DB.searchSelector=function(e,t,n){if(Eden.DB.isConnected())$.ajax({url:this.remoteURL+"/code/search?selector="+e.replace("#","%23")+"&outtype="+t,type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(t){if((null===t||t.error)&&(Eden.DB.emit("error",[t?t.description:"No response from server"]),n([])),t)return Eden.DB.qcacheloaded||(Eden.DB.querycache=JSON.parse(window.localStorage.getItem("query_cache")),Eden.DB.qcacheloaded=!0,null===Eden.DB.querycache&&(Eden.DB.querycache={})),Eden.DB.querycache[e]=t,Eden.DB.requestQCacheSave(),void n(t);n([])},error:function(e,t,r){n([]),Eden.DB.handleError(e,t,r)}});else{console.log("ATTEMPT CACHE",e),Eden.DB.qcacheloaded||(Eden.DB.querycache=JSON.parse(window.localStorage.getItem("query_cache")),Eden.DB.qcacheloaded=!0,null===Eden.DB.querycache&&(Eden.DB.querycache={}));var r=Eden.DB.querycache[e];n(r||[])}},Eden.DB.requestQCacheSave=function(){Eden.DB.qcachetimeout||(Eden.DB.qcachetimeout=setTimeout(function(){window.localStorage.setItem("query_cache",JSON.stringify(Eden.DB.querycache)),Eden.DB.qcachetimeout=void 0},2e3))},Eden.DB.postComment=function(e,t,n){var r=e?e.id:-1,i=e?e.vid:-1;Eden.DB.isLoggedIn()&&$.ajax({url:this.remoteURL+"/comment/post",type:"post",crossDomain:!0,xhrFields:{withCredentials:!0},data:{projectID:r,versionID:i,publiclyVisible:n?0:1,comment:t},success:function(e){(null===e||e.error)&&(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]))},error:function(e,t,n){Eden.DB.handleError(e,t,n)}})};var waitingforcomment=!1;function guid(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}Eden.DB.searchComments=function(e,t,n,r,i,s){if(waitingforcomment)s();else{var o=e?e.id:-1;Eden.DB.isConnected()&&(waitingforcomment=!0,$.ajax({url:this.remoteURL+"/comment/search?projectID="+o+(i?"&newerThan="+i:"")+"&offset="+(n-1)*r+"&limit="+r,type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){waitingforcomment=!1,s(e||[])},error:function(e,t,n){waitingforcomment=!1,s(),Eden.DB.handleError(e,t,n)}}))}},Eden.DB.removeComment=function(e){Eden.DB.isLoggedIn()&&$.ajax({url:this.remoteURL+"/comment/delete",type:"post",crossDomain:!0,xhrFields:{withCredentials:!0},data:{commentID:e},success:function(e){(null===e||e.error)&&(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]))},error:function(e,t,n){Eden.DB.handleError(e,t,n)}})},Eden.DB.follow=function(e,t){Eden.DB.isLoggedIn()&&$.ajax({url:this.remoteURL+"/social/followproject?projectID="+e,type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){null===e||e.error?(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]),t&&t(!1)):t&&t(!0)},error:function(e,n,r){Eden.DB.handleError(e,n,r),t&&t(!1)}})},Eden.DB.adminCommentActivity=function(e,t,n){Eden.DB.isLoggedIn()&&$.ajax({url:this.remoteURL+"/comment/activity?limit=10&offset="+t+(e?"&newerThan="+e:""),type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){null===e||e.error?(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]),n&&n(!1)):n&&n(e)},error:function(e,t,r){Eden.DB.handleError(e,t,r),n&&n(!1)}})},Eden.DB.handleError=function(e,t,n){console.log("DB ERROR",t,n),"error"!=t||n?"error"==t?Eden.DB.emit("error",[n]):"timeout"==t?(Eden.DB.emit("error",["Network timeout"]),Eden.disconnect(!0)):(Eden.DB.emit("error","Unknown network error"),Eden.disconnect(!0)):(Eden.DB.disconnect(!0),Eden.DB.emit("error",["Not connected to construal cloud"]))},Eden.DB.adminProjectActivity=function(e,t,n){Eden.DB.isLoggedIn()&&$.ajax({url:this.remoteURL+"/project/activity?limit=30&offset="+t+(e?"&newerThan="+e:""),type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){null===e||e.error?(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]),n&&n(!1)):n&&n(e)},error:function(e,t,r){Eden.DB.handleError(e,t,r),n&&n(!1)}})},Eden.DB.getPopularTags=function(e,t){$.ajax({url:this.remoteURL+"/project/tags?tag="+e,type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){null===e||e.error?(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]),t&&t(!1)):t&&t(e)},error:function(e,n,r){Eden.DB.handleError(e,n,r),t&&t(!1)}})};var browserID=window.localStorage.construit_uid;null!==browserID&&void 0!==browserID&&""!=browserID||(browserID=guid(),window.localStorage.setItem("construit_uid",browserID));var sessionID=guid(),root,eden,edenUI,doneLoading;function touchHandler(e){var t=e.changedTouches[0],n=document.createEvent("MouseEvent");n.initMouseEvent({touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup"}[e.type],!0,!0,window,1,t.screenX,t.screenY,t.clientX,t.clientY,!1,!1,!1,!1,0,null),t.target.dispatchEvent(n),-1==e.target.className.indexOf("ui-dialog-titlebar")&&-1==e.target.className.indexOf("ui-resizable-handle")||e.preventDefault()}Eden.DB.log=function(e,t){console.log("LOG",browserID,Eden.DB.userid?Eden.DB.userid:-1,e,t),$.ajax({url:this.searchServer+"/jsedenlog/jsedenlog",type:"post",data:{browserID:browserID,sessionID:sessionID,userID:Eden.DB.userid,action:e,details:t}})},function(){function e(e,t){return root.lookup("view_"+e+"_"+t)}function t(e){return $("#"+e+"-dialog")}EdenUI.prototype.menuBarHeight=45,EdenUI.prototype.dialogBorderWidth=1,EdenUI.prototype.titleBarHeight=0,EdenUI.prototype.largeTitleBar=41.22+EdenUI.prototype.dialogBorderWidth,EdenUI.prototype.scrollBarSize=14+EdenUI.prototype.dialogBorderWidth,EdenUI.prototype.scrollBarSize2=window.innerHeight-$(window).height(),EdenUI.prototype.dialogFrameWidth=2*EdenUI.prototype.dialogBorderWidth,EdenUI.prototype.dialogFrameHeight=EdenUI.prototype.titleBarHeight+EdenUI.prototype.dialogBorderWidth,EdenUI.prototype.bottomBarHeight=34.906,EdenUI.prototype.gridSizeX=Math.floor(30*window.innerWidth/1920),EdenUI.prototype.gridSizeY=Math.floor(30*window.innerHeight/1920),EdenUI.prototype.minimumWindowWidthShowing=72+EdenUI.prototype.dialogBorderWidth,EdenUI.prototype.createEmbedded=function(e,t){return this.embeddedInstances[e]?this.embeddedInstances[e]:(edenUI.views[t].embed?n=edenUI.views[t].embed(e,e,""):edenUI.views[t].embedded&&(n=edenUI.views[t].embedded(e,e,"")),n?(this.embeddedInstances[e]=n,n):void 0);var n},EdenUI.prototype.createView=function(n,r,i){if(r in this.views){"name"in this.views[r]&&(n=this.views[r].name);var s=this,o=EdenSymbol.defaultAgent,a=this.activeDialogs[n],d=e(n,"visibility"),c=d.value(),h=e(n,"title"),p=h.value();if(a==r)return"visible"!=c&&d.assign("visible",root.scope,o),this.brieflyHighlightView(n),this.viewInstances[n];this.eden.root.beginAutocalcOff(),void 0!==a&&(p==this.views[a].title&&(p=void 0),this.destroyView(n,!1)),this.titleBarHeight="ScriptView"==a?this.largeTitleBar:this.titleBarHeight;var l=this.menuBarHeight,u=this.views[r].title,E=this.views[r].dialog(n+"-dialog",u);void 0===E&&(E={}),this.viewInstances[n]=E;var f;E.position;f="true"==edenUI.getOptionValue("optCollapseToTitleBar")?"collapse":"maximize";var g=t(n);g.dialog({closeOnEscape:!1,position:{using:function(){}},beforeClose:function(){return E.closing?(E.closing=!1,!0):s.closeView(n)},focus:function(){}});var S=[B("type"),B("x"),B("y"),B("width"),B("height"),B("lock"),B("noborder"),B("title"),B("visibility")];g.get(0).setAttribute("data-observables",S.join(","));var m=this.getDialogWindow(n);g.dialogExtend({dblclick:f,minimizable:!0,maximizable:!0,beforeMinimize:function(e){return $(e.target).parent().removeClass("window-activated"),s.hideView(n),!1},minimize:function(){var e=t(n).data("dialog-extend-minimize-controls");e.css("position","relative"),e.css("top",""),e.css("left","")},maximize:function(e){var t=m[0],n=g[0];t.style.top=l+"px";var r=window.innerHeight-l-s.scrollBarSize2-2*s.dialogBorderWidth;"true"!=edenUI.getOptionValue("optHideOnMinimize")&&(r-=s.bottomBarHeight),t.style.height=r+"px",n.style.height=r-s.titleBarHeight+"px"},restore:function(e){g.dialog("moveToTop"),s.brieflyHighlightView(e.target.id.slice(0,-7)),g.dialog("widget").draggable("option","containment",[-Number.MAX_VALUE,l,Number.MAX_VALUE,Number.MAX_VALUE])}}),this.activeDialogs[n]=r;var y=e(n,"type");y.value()!=r&&(y.removeJSObserver("changeType"),y.assign(r,root.scope,EdenSymbol.localJSAgent),y.addJSObserver("changeType",function(e,t){void 0!==t&&-1!==root.lookup("views_list").value().indexOf(n)&&s.createView(n,t)}));var v=root.lookup("views_list"),x=v.value();Array.isArray(x)?-1===x.indexOf(n)&&((x=x.slice()).push(n),v.assign(x,root.scope,EdenSymbol.localJSAgent)):v.assign([n],root.scope,EdenSymbol.localJSAgent);var T=e(n,"lock"),A=T.value();widthSym=e(n,"width"),widthSym.addJSObserver("plugins",_),widthSym.definition||void 0!==widthSym.value()||widthSym.assign(g.dialog("option","width"),root.scope,o);var b=e(n,"height");b.addJSObserver("plugins",_),b.definition||void 0!==b.value()||b.assign(g.dialog("option","height")-(A?0:this.titleBarHeight),root.scope,o),_();var w=g.closest(".ui-dialog").position(),k=e(n,"x");k.addJSObserver("plugins",P),k.definition||void 0!==k.value()||k.assign(w.left,root.scope,o);var I=e(n,"y");I.addJSObserver("plugins",P),I.definition||void 0!==I.value()||I.assign(w.top,root.scope,o),P(),"visible"!=c&&(void 0===c?d.assign("visible",root.scope,o):L(0,c)),d.addJSObserver("changeState",L);var N=E.titleBarInfo;delete E.titleBarInfo,Object.defineProperty(E,"titleBarInfo",{get:function(){return N},set:function(e){N=e;var t=h.value();void 0!==e&&(t=t+" ("+e+")"),g.dialog("option","title",t)},enumerable:!0}),h.addJSObserver("updateTitleBar",U),void 0===p?h.assign(u,root.scope,o):U(0,p),T.addJSObserver("changeState",j),void 0!==A&&j(0,A);var O=e(n,"noborder");O.addJSObserver("changeState",F);var R=O.value();void 0!==R&&F(0,R);var C=e(n,"pin");C.addJSObserver("changeState",M);var D=C.value();return void 0!==D?M(0,D):this.unpinView(n),g.dialog("widget").draggable("option","containment",[-Number.MAX_VALUE,l,Number.MAX_VALUE,Number.MAX_VALUE]),g.resizeExtend=0,g.on("dialogresizestop",function(t,r){g.previousWidth=void 0,g.momentum=0,g.resizeExtend=0;var i=e(n,"width"),o=e(n,"height"),a=s.eden.root;a.beginAutocalcOff(),i.assign(r.size.width,a.scope,EdenSymbol.hciAgent),o.assign(r.size.height-s.titleBarHeight,a.scope,EdenSymbol.hciAgent),a.endAutocalcOff()}),g.on("dialogdragstop",function(t,r){var i=s.eden.root;i.beginAutocalcOff(),console.log(r),e(n,"x").assign(r.position.left,eden.root.scope,EdenSymbol.hciAgent),e(n,"y").assign(r.position.top,eden.root.scope,EdenSymbol.hciAgent),i.endAutocalcOff()}),g.on("dialogdragstart",function(){if(e(n,"x").definition||e(n,"y").definition)return!1}),g.on("dialogresizestart",function(){if(e(n,"width").definition||e(n,"height").definition)return!1}),this.eden.root.endAutocalcOff(),this.emit("createView",[n,r]),e(n,"nostack").value()?g.get(0).parentNode.className+=" ui-back":g.get(0).parentNode.className+=" ui-front",E}function B(e){return"view_"+n+"_"+e}function _(e,t){s.resizeView(n)}function P(e,t){s.moveView(n)}function L(e,t){var r=g.dialogExtend("state");"hidden"==t?"minimized"!=r&&s.minimizeView(n):"maximized"==t||g.dialog("isOpen")&&"minimized"!=r&&"collapsed"!=r||s.showView(n)}function U(e,t){var n=t;void 0!==E.titleBarInfo&&(n=n+" ("+E.titleBarInfo+")"),E.title!==n&&(E.title=n,g.dialog("option","title",n),edenUI.menu&&edenUI.menu.updateViewsMenu())}function j(e,t){lockVal=t,t?(g.siblings(".ui-dialog-titlebar").css("display","none"),g.dialog("option","resizable",!1),s.resizeView(n)):(g.siblings(".ui-dialog-titlebar").css("display","block"),g.dialog("option","resizable",!0),s.resizeView(n))}function F(e,t){var n=g.get(0).parentNode.style;t?(n.border="none",n.boxShadow="none"):(n.border="1px solid #777",n.boxShadow="0 0 40px #6d8cac")}function M(e,t){t?s.pinView(n):s.unpinView(n)}this.eden.error(new Error("View type "+r+" is unavailable.  Check that the associated plug-in is loaded."))},EdenUI.prototype.closeView=function(e){return this.hideView(e),edenUI.eden.root.collectGarbage(),!0},EdenUI.prototype.destroyAllViews=function(){for(var e in this.viewInstances)this.destroyView(e,!0)},EdenUI.prototype.destroyView=function(e,n){if(e in this.viewInstances&&!this.viewInstances[e].closing){this.viewInstances[e].closing=!0,this.viewInstances[e].destroy&&this.viewInstances[e].destroy(),root.forgetAll("^View_"+e+"_",!0,!1,!0),n?root.forgetAll("^view_"+e+"_",!0,!1,!0):root.lookup("view_"+e+"_title").removeJSObserver("updateTitleBar");var r=t(e);if(r.dialog("destroy"),r.remove(),r.html(""),delete this.activeDialogs[e],delete this.viewInstances[e],n){var i=root.lookup("views_list"),s=i.value();if(Array.isArray(s)){var o,a=s.indexOf(e);if(-1!==a)0==a?o=s.slice(1):(s.splice(a,1),o=s),i.assign(o,root.scope,EdenSymbol.hciAgent)}}this.emit("destroyView",[e])}},EdenUI.prototype.getDialogContent=function(e){return t(e)},EdenUI.prototype.getDialogWindow=function(e){return t(e).parent()},EdenUI.prototype.showView=function(e){var n=t(e);n.dialog("open").dialog("moveToTop");var r=n.dialogExtend("state");return"normal"!=r&&"maximized"!=r&&n.dialogExtend("restore"),this.activeDialogs[e]},EdenUI.prototype.updateView=function(e,t){var n=this.viewInstances[e];n&&n.update&&n.update(t)},EdenUI.prototype.highlightView=function(e,t){t?this.windowHighlighter.highlight(e):(this.getDialogContent(e).data("dialog-extend-minimize-controls")||this.getDialogWindow(e)).addClass("window-highlighted")},EdenUI.prototype.stopHighlightingView=function(e,t,n){t?(this.windowHighlighter.stopHighlight(e,n),n&&this.getDialogContent(e).dialog("moveToTop")):(this.getDialogContent(e).data("dialog-extend-minimize-controls")||this.getDialogWindow(e)).removeClass("window-highlighted")},EdenUI.prototype.brieflyHighlightView=function(e){var t=this.getDialogWindow(e);t.addClass("window-activated"),setTimeout(function(){t.removeClass("window-activated")},600)},EdenUI.prototype.hideView=function(e){e in this.viewInstances&&(this.viewInstances[e].closing=!0,t(e).dialog("close"))},EdenUI.prototype.minimizeView=function(e){if("true"==edenUI.getOptionValue("optHideOnMinimize"))this.hideView(e);else{if(!(e in this.viewInstances))return;t(e).dialogExtend("minimize")}},EdenUI.prototype.minimizeObscuredViews=function(e){if("true"!=edenUI.getOptionValue("optHideOnMinimize")){var n=t(e),r=n.closest(".ui-dialog");if(!r.is(this.windowHighlighter.lastDialog)&&"normal"==n.dialogExtend("state"))for(var i=n.get(0),s=r.position(),o=s.left,a=s.top,d=n.dialog("option","width")+2*EdenUI.prototype.dialogBorderWidth,c=n.dialog("option","height")+2*EdenUI.prototype.dialogBorderWidth,h=r.hasClass("ui-top"),p=$(".ui-dialog-content"),l=0;l<p.length;l++){var u=$(p[l]);if(p[l]!==i&&"normal"==u.dialogExtend("state")){var E=u.closest(".ui-dialog");if(!E.hasClass("ui-front")||h){var f=E.position(),g=f.left,S=f.top,m=u.dialog("option","width")+2*EdenUI.prototype.dialogBorderWidth,y=u.dialog("option","height")+2*EdenUI.prototype.dialogBorderWidth;g>=o-0&&g+m<=o+d+0&&S>=a-0&&S+y<=a+c+0&&u.dialogExtend("minimize")}}}}},EdenUI.prototype.moveView=function(n){var r,i,s=t(n),o=e(n,"x"),a=e(n,"y"),d=o.value(),c=a.value(),h=this.minimumWindowWidthShowing-s.dialog("option","width");r=d<h?h:d,i=c<0?0:c;var p=s.parent().get(0);p.style.left=r+"px",p.style.top=i+"px"},EdenUI.prototype.resizeView=function(n){var r=this.viewInstances[n];if(!r.resizing){var i=t(n),s=e(n,"width"),o=s.value(),a=e(n,"height"),d=a.value()+this.titleBarHeight;s.origin!==EdenSymbol.hciAgent&&i.dialog("option","width",o),a.origin!==EdenSymbol.hciAgent&&i.dialog("option","height",d),"resize"in r&&r.resize(o,d)}},EdenUI.prototype.pinView=function(e){var t=this.getDialogWindow(e);t.removeClass("ui-front"),t.addClass("ui-top"),this.viewInstances[e].pinned=!0},EdenUI.prototype.unpinView=function(e){var t=this.getDialogWindow(e);this.viewInstances[e].pinned&&(t.removeClass("ui-top"),t.get(0).style.zIndex=9999,t.addClass("ui-front"),this.viewInstances[e].pinned=!1,this.windowHighlighter.unpin(t))},EdenUI.prototype.newProject=function(){this.eden.reset(),this.destroyView("jspe",!0),"Canvas2D"in this.plugins&&this.eden.executeEden('createCanvas("picture");',"new project","",EdenSymbol.hciAgent,noop),"ScriptInput"in this.plugins&&this.eden.executeEden('createView("input", "ScriptInput");',"new project","",EdenSymbol.hciAgent,noop),this.views.ErrorLog.errorWindow&&this.views.ErrorLog.errorWindow.html(""),Eden.Agent.removeAll()},EdenUI.prototype.modalDialog=function(e,t,n,r,i){var s=$('<div id="modal"></div>'),o=function(e){return function(t){s.dialog("destroy"),s.remove(),i(e)}},a=$("<div>"+t+"</div>");s.append(a);for(var d=[],c=0;c<n.length;c++){var h={text:n[c],click:o(c)};d.push(h)}var p=n.length,l={text:"Cancel",click:o(p)};d.push(l),s.dialog({buttons:d,modal:!0,resizable:!1,show:"fade",title:e,close:function(){i(p)},open:function(){$(this).parent().find("button")[r].focus()},width:375}),$(".ui-widget-overlay").css("z-index",10001),s.parent().css("z-index",10002)}}(),URLUtil={},URLUtil.getParameterByName=function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)"),n=window.location.href,r=t.exec(n);return null===r?"":decodeURIComponent(r[1].replace(/\+/g," "))},URLUtil.getParameters=function(){var e=window.location.href.split("?")[1];if(!e)return{};for(var t=e.split("&"),n={},r=0;r<t.length;r++){var i=t[r].split("=");void 0===n[i[0]]&&(n[i[0]]=[]),i.length>1&&n[i[0]].push(decodeURIComponent(i[1]))}return n},URLUtil.getArrayParameterByName=function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");for(var t=new RegExp("[\\?&]"+e+"=([^&#]*)","g"),n=window.location.href,r=t.exec(n),i=[];null!==r;){var s=decodeURIComponent(r[1].replace(/\+/g," "));i.push(s),r=t.exec(n)}return i},URLUtil.isCrossDomain=function(e){var t=e.match(/^([a-zA-Z][a-zA-Z\d+.\-]*:)(\/\/)?([^\/@]*@)?([^\/:]+)(:\d+)?(\/|$)/);return null!==t&&(t[1]!=window.location.protocol||t[4]!=document.domain||t[5].slice(1)!=window.location.port)},URLUtil.downloadFile=function(e){var t=e.url,n=e.dataType,r=e.sync,i=e.success,s=e.error;if(void 0===n&&(n="text"),"function"!=typeof s)throw new Error("An error handling function must be specified.");if("function"==typeof i)if(void 0!==t){t=String(t);var o=rt.config.proxyBaseURL,a=this.isCrossDomain(t);if(!0===r&&a&&this.isCrossDomain(o))s(null,"error","Synchronous downloading not possible");else{if("boolean"==typeof r){if(a){var d="crossDomainCallback"+Math.floor(9007199254740991*Math.random());return window[d]=function(e){try{if(e.success){var t,r=e.success,o=!1;switch(n){case"text":t=r;break;case"json":try{t=JSON.parse(r)}catch(e){s(null,"parserror",e),o=!0}break;default:s(null,"error","No cross-domain interpretation available for data type "+n),o=!0}o||i(t,"success",null)}else s(null,"error",e.error)}finally{delete window[d]}},$.ajax({url:o+"?url="+encodeURI(t)+"&callback="+d,dataType:"script",async:!r,error:s})}return e.async=!r,$.ajax(e)}s(null,"error","The sync option must be a boolean, not a "+typeof r)}}else s(null,"error","A URL must be specified.");else s(null,"error","A success callback function must be specified.")},URLUtil.updateQueryString=function(e){var t=URLUtil.getParameters();for(var n in e)t[n]=encodeURI(e[n]);var r="?",i=!0;for(var n in t)i||(r+="&"),i=!1,r+=n+"="+t[n];return r},"isInteger"in Number||(Number.isInteger=function(e){return parseInt(e)===e});var doingNavigateAway=!1,confirmUnload=function(e){if(Eden.DB.log("leave",{project:eden.project?eden.project.id:-1}),!doingNavigateAway&&(eden.root.lookup("jseden_autosave").value()&&eden.project.localSave(),eden.root.lookup("jseden_leaveprompt").value())){var t="Leaving this page will discard the current script. Your work will not be saved.";return e.returnValue=t,t}};function Construit(options,callback){eden=new Eden,root=eden.root;var menuBar="false"!=URLUtil.getParameterByName("menus"),pluginsStr=URLUtil.getParameterByName("plugins"),exec=URLUtil.getParameterByName("exec"),load=URLUtil.getParameterByName("load"),lang=URLUtil.getParameterByName("lang"),restore=URLUtil.getParameterByName("restore"),vid=URLUtil.getParameterByName("vid"),readPassword=URLUtil.getParameterByName("r"),writePassword=URLUtil.getParameterByName("w"),roles=URLUtil.getParameterByName("roles"),master=URLUtil.getParameterByName("master"),myid=URLUtil.getParameterByName("id"),query=URLUtil.getParameterByName("q"),mode=URLUtil.getParameterByName("mode"),urlparams=URLUtil.getParameters(),plugins;for(var x in urlparams)urlparams[x].length>1?eden.root.lookup("jseden_url_"+x).assign(urlparams[x],eden.root.scope,Symbol.localJSAgent):eden.root.lookup("jseden_url_"+x).assign(urlparams[x][0],eden.root.scope,Symbol.localJSAgent);""==lang&&(lang="en");var defaultPlugins=["Canvas2D","DependencyMap","HTMLContent","PluginManager","ScriptInput","SymbolLookUpTable","SymbolViewer","VersionViewer"];if(""==pluginsStr)plugins=defaultPlugins;else{var includeDefaultPlugins=" "==pluginsStr[0];includeDefaultPlugins&&(pluginsStr=pluginsStr.slice(1)),plugins=pluginsStr.split(","),includeDefaultPlugins&&(plugins=plugins.concat(defaultPlugins)),""!=views&&"default"!=views||(plugins.push("Canvas2D"),plugins.push("ScriptInput"))}$(document).ready(function(){edenUI=new EdenUI(eden),edenUI.scrollBarSize2=window.innerHeight-$(window).height(),eden.ismobile=mobilecheck(),eden.root.lookup("jseden_mobile").assign(eden.ismobile,eden.root.scope,Symbol.defaultAgent),eden.root.lookup("jseden_parser_cs3").assign(!0,eden.root.scope,EdenSymbol.defaultAgent),eden.root.lookup("jseden_parser_cs3").addJSObserver("parser",(e,t)=>{Eden.AST.version=t?Eden.AST.VERSION_CS3:Eden.AST.VERSION_CS2}),$.ajax({url:"version.json",dataType:"json",success:function(e){e.tag&&(document.title=document.title+" "+e.tag);var t=e.tag.slice(1).split("."),n=t[2].split("-");eden.root.lookup("jseden_version_major").assign(parseInt(t[0]),eden.root.scope,Symbol.defaultAgent),eden.root.lookup("jseden_version_minor").assign(parseInt(t[1]),eden.root.scope,Symbol.defaultAgent),eden.root.lookup("jseden_version_patch").assign(parseInt(n[0]),eden.root.scope,Symbol.defaultAgent),eden.root.lookup("jseden_version_commit").assign(parseInt(n[1]),eden.root.scope,Symbol.defaultAgent),eden.root.lookup("jseden_version_name").assign(e.tag,eden.root.scope,Symbol.defaultAgent),eden.root.lookup("jseden_version_sha").assign(e.sha,eden.root.scope,Symbol.defaultAgent)},cache:!1}),$(document).on("keydown",null,"ctrl+m",function(){edenUI.cycleNextView()}).on("keyup",null,"ctrl",function(){edenUI.stopViewCycling()}).on("keydown",null,"backspace",function(e){var t=e.target,n=t.tagName.toUpperCase();"INPUT"==n||"TEXTAREA"==n||t.isContentEditable||e.preventDefault()}),"false"!=edenUI.getOptionValue("optConfirmUnload")&&window.addEventListener("beforeunload",confirmUnload);var loadLanguage=function(lang,callback){$.getScript("js/language/"+lang+".js",function(data){Language.language=lang,eval(data),menuBar?edenUI.menu=new EdenUI.MenuBar:(document.getElementById("jseden-main").style.top="0",eden.root.lookup("jseden_nomenu").assign(!0,eden.root.scope,Symbol.defaultAgent)),options&&options.noload||(edenUI.feedback=new EdenUI.Feedback,edenUI.explorer=new EdenUI.Explorer),callback()})},loadPlugins=function(e,t){var n=function(){if(e.length>0){var r=e.shift();edenUI.loadPlugin(r,n)}else t()};n()};doneLoading=function(e){if(window.scrollTo(0,0),edenUI.finishedLoading(),exec&&(";"!=exec.slice(-1)&&(exec+=";"),eden.execute2(exec)),(""!=myid||""!=master)&&(eden.peer=new Eden.Peer(""!=master?master:void 0,""!=myid?myid:void 0),roles)){roles=roles.split(",");for(var t=0;t<roles.length;t++)eden.peer.roles[roles[t]]=!0}callback&&callback(e)},loadLanguage(lang,function(){options&&options.noload?Eden.DB.connect(Eden.DB.repositories[Eden.DB.repoindex],function(){console.log("DONE LOADING"),doneLoading(!0)}):loadPlugins(plugins,function(){Eden.DB.connect(Eden.DB.repositories[Eden.DB.repoindex],function(){""!=load?(null!==mode&&""!=mode&&eden.root.lookup("jseden_project_mode").assign(mode,eden.root.scope,Symbol.defaultAgent),Eden.DB.log("urlload",{href:window.location.href,useragent:navigator.userAgent,referrer:document.referrer,pid:load,vid:vid,private:null!==readPassword}),Eden.Project.load(parseInt(load),null===vid||""==vid?void 0:parseInt(vid),null===readPassword||""==readPassword?void 0:readPassword,function(){doneLoading(!0)})):""!=restore?(null!==mode&&""!=mode&&eden.root.lookup("jseden_project_mode").assign(mode,eden.root.scope,Symbol.defaultAgent),Eden.project.restore(),doneLoading(!0)):(Eden.DB.log("home",{href:window.location.href,referrer:document.referrer,useragent:navigator.userAgent}),doneLoading(!1))}),Eden.DB.repoindex=(Eden.DB.repoindex+1)%Eden.DB.repositories.length})})})}function removeHash(e){var t=e.lastIndexOf("_");return e.substring(0,t)}function scopehash(e){for(var t=0,n=e.length,r=0;r<n;r++)t=(t<<5)-t+e.charCodeAt(r),t&=t;return t}!function(){function e(){this.value=void 0,this.error=!1,this.line=0}Eden.EdenSyntaxData=e;var t=Eden.Language,n=t.keywords,r=t.values;function i(t){this.code=t,this.position=0,this.position_stack=[0],this.prevposition=0,this.line=1,this.prevline=1,this.data=new e}Eden.EdenStream=i,i.prototype.pushPosition=function(){this.position_stack.push(this.position)},i.prototype.popPosition=function(){this.position=this.position_stack.pop()},i.prototype.discardPosition=function(){this.position_stack.pop()},i.prototype.get=function(){return this.position<this.code.length?this.code.charCodeAt(this.position++):0},i.prototype.peek=function(){return this.position<this.code.length?this.code.charCodeAt(this.position):0},i.prototype.peek2=function(){return this.position+1>=this.code.length?0:this.code.charCodeAt(this.position+1)},i.prototype.peek3=function(){return this.position+2>=this.code.length?0:this.code.charCodeAt(this.position+2)},i.prototype.readLine=function(){var e=this.code.indexOf("\n",this.position);if(-1==e){var t=this.code.substring(this.position);return this.position=this.code.length,t}t=this.code.substring(this.position,e+1);return this.position=e+1,this.line++,t},i.prototype.peekLine=function(){var e=this.code.indexOf("\n",this.position);return-1==e?this.code.substring(this.position):this.code.substring(this.position,e+1)},i.prototype.move=function(e){this.position=e},i.prototype.reset=function(){this.position=0,this.position_stack=[0],this.prevposition=0,this.line=1},i.prototype.tokenText=function(){return this.code.substr(this.prevposition,this.position-this.prevposition)},i.prototype.isBEOL=function(){if(0==this.prevposition)return!0;if(10==this.peek2())return!0;for(var e=this.prevposition-1,t=this.code.charCodeAt(e);9==t||32==t;)e--,t=this.code.charCodeAt(e);return 10==t},i.prototype.isBOL=function(){if(0==this.prevposition)return!0;var e=this.prevposition-1;return 10==this.code.charCodeAt(e)},i.prototype.isFollowingWhiteSpace=function(){var e=this.prevposition-1>=0?this.code.charCodeAt(this.prevposition-1):0;return 0==this.prevposition||this.isWhiteSpace(e)},i.prototype.previousChar=function(){return this.prevposition-1>=0?this.code.charCodeAt(this.prevposition-1):0},i.prototype.skip=function(){this.position++},i.prototype.eof=function(){return this.position>=this.code.length},i.prototype.valid=function(){return this.position<this.code.length},i.prototype.unget=function(){this.position--},i.prototype.skipWhiteSpace=function(){for(;this.valid();){var e=this.peek();if(10===e&&this.line++,9!==e&&10!==e&&13!==e&&32!==e&&160!==e)break;this.skip()}},i.prototype.isWhiteSpace=function(e){return 9===e||10===e||13===e||32===e||160===e},i.prototype.skipLine=function(){for(;this.valid()&&10!==this.peek();)this.skip()},i.prototype.isAlphaNumeric=function(e){return e>=48&&e<=57||e>=65&&e<=90||e>=97&&e<=122||95===e||e>=128||36===e},i.prototype.isNumeric=function(e){return e>=48&&e<=57},i.prototype.tokenType=function(e){switch(e){case"OBSERVABLE":return"identifier";case"JAVASCRIPT":return"javascript";case"NUMBER":return"number";case"STRING":return"string";case"CHARACTER":return"character";case"BOOLEAN":return"boolean";case"(":case"[":case"{":return"openbracket";case")":case"]":case"}":return"closebracket";case",":case".":case";":case":":return"separator"}return"string"!=typeof e?(console.error(e),"INVALID"):this.isAlphaNumeric(e.charCodeAt(0))?"keyword":"operator"},i.prototype.parseAlphaNumeric=function(e){for(var t=this.position;this.isAlphaNumeric(this.peek());)++this.position;var n=this.code.substring(t,this.position);return e.value=n,this.position-t>0},i.prototype.parseString=function(e,t){for(var n="";this.valid()&&this.peek()!=t;){var r=String.fromCharCode(this.get());if("\n"===r)return this.unget(),e.error=!0,void(e.value="LINEBREAK");n+="\\"===r?"n"===(r=String.fromCharCode(this.get()))?"\n":"t"===r?"\t":r:r}this.valid()&&this.peek()===t?(this.skip(),e.error=!1):e.error=!0,e.value=n},i.prototype.parseCharacter=function(e){var t=String.fromCharCode(this.get());if("'"===t)return e.value="",void(e.error=!0);"\\"===t&&(t=String.fromCharCode(this.get())),e.value=t,this.valid()&&39==this.peek()?this.skip():e.error=!0},i.prototype.parseNumber=function(e){for(var t="";this.valid()&&this.isNumeric(this.peek());)t+=String.fromCharCode(this.get());if(46===this.peek()&&this.isNumeric(this.peek2()))for(this.skip(),t+=".";this.valid()&&this.isNumeric(this.peek());)t+=String.fromCharCode(this.get());e.value=parseFloat(t)},i.prototype.readCommentToken=function(){if(this.prevline=this.line,this.skipWhiteSpace(),this.prevposition=this.position,this.eof())return"EOF";for(var e=0;this.valid();){var t=this.code.charCodeAt(this.position++);if(10===t&&++this.line,47===t){if(42===e)return"*/";if(42==this.peek())return this.skip(),"/*"}e=t}return"INVALID"},i.prototype.readJSToken=function(){if(this.prevline=this.line,this.skipWhiteSpace(),this.prevposition=this.position,this.eof())return"EOF";for(var e=0,t=0;this.valid();){var n=this.code.charCodeAt(this.position++);if(10===n&&++this.line,36===n&&125===e&&125==t)return"}}$";t=e,e=n}return"INVALID"},i.prototype.readToken=function(e){if(this.prevline=this.line,this.skipWhiteSpace(),this.prevposition=this.position,this.eof())return"EOF";var t=this.code.charCodeAt(this.position);switch(this.position++,t){case 33:return 61===this.peek()?(this.skip(),"!="):126===this.peek()?(this.skip(),"!~"):"!";case 34:return this.parseString(this.data,34),"STRING";case 35:return 35===this.peek()?(this.skip(),"##"):"#";case 36:if(123===this.peek()&&123===this.peek2())return this.skip(),this.skip(),"${{";if(123===this.peek())return this.skip(),"${";break;case 37:return"%";case 38:return 38===this.peek()?(this.skip(),"&&"):61===this.peek()?(this.skip(),"&="):"&";case 39:return"'";case 40:return"(";case 41:return")";case 42:return 61===this.peek()?(this.skip(),"*="):47===this.peek()?(this.skip(),"*/"):"*";case 43:return 43===this.peek()?(this.skip(),"++"):61===this.peek()?(this.skip(),"+="):"+";case 44:return",";case 45:return 45===this.peek()?(this.skip(),"--"):61===this.peek()?(this.skip(),"-="):"-";case 46:return 46===this.peek()?(this.skip(),".."):".";case 47:return 47===this.peek()&&61==this.peek2()?(this.skip(),this.skip(),"//="):47===this.peek()?(this.skip(),"//"):61===this.peek()?(this.skip(),"/="):42===this.peek()?(this.skip(),"/*"):"/";case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.unget(),this.parseNumber(this.data),"NUMBER";case 58:return 58===this.peek()?(this.skip(),"::"):":";case 59:return";";case 60:return 60===this.peek()?(this.skip(),"<<"):61===this.peek()?(this.skip(),"<="):47===this.peek()?(this.skip(),"</"):"<";case 61:return 61===this.peek()?(this.skip(),"=="):126===this.peek()?(this.skip(),"=~"):"=";case 62:return 62===this.peek()?(this.skip(),">>"):61===this.peek()?(this.skip(),">="):">";case 63:return"?";case 64:return"@";case 91:return"[";case 92:return"\\";case 93:return"]";case 94:return"^";case 96:return"`";case 123:return"{";case 124:return 124===this.peek()?(this.skip(),"||"):61===this.peek()?(this.skip(),"|="):"|";case 125:return 125===this.peek()&&36===this.peek2()?(this.skip(),this.skip(),"}}$"):"}";case 126:return 62===this.peek()?(this.skip(),"~>"):"~"}if(this.unget(),this.parseAlphaNumeric(this.data)){let e=n[this.data.value];if(e)return e;let t=r[this.data.value];return t?(this.data.value=t,"BOOLEAN"):"OBSERVABLE"}return this.skip(),"INVALID"},"undefined"!=typeof require&&"undefined"!=typeof exports?(exports.EdenStream=i,exports.EdenSyntaxData=e):window.EdenStream=i}(),function(){Eden.SyntaxError=function(e,t,n){this.type="syntax",this.context=e,this.errno=t,this.extra=n,this.token=e.token,this.prevtoken=e.previous,this.line=e.stream.prevline,this.position=e.stream.position,this.prevposition=e.stream.prevposition},Eden.SyntaxError.UNKNOWN=0,Eden.SyntaxError.EXPCLOSEBRACKET=1,Eden.SyntaxError.BADFACTOR=2,Eden.SyntaxError.ACTIONCOLON=3,Eden.SyntaxError.ACTIONNOWATCH=4,Eden.SyntaxError.ACTIONCOMMAS=5,Eden.SyntaxError.ACTIONOPEN=6,Eden.SyntaxError.ACTIONCLOSE=7,Eden.SyntaxError.LOCALNAME=8,Eden.SyntaxError.LOCALSEMICOLON=9,Eden.SyntaxError.WHENTYPE=10,Eden.SyntaxError.LISTINDEXEXP=11,Eden.SyntaxError.LISTINDEXCLOSE=12,Eden.SyntaxError.LVALUE=13,Eden.SyntaxError.SEMICOLON=14,Eden.SyntaxError.STATEMENT=15,Eden.SyntaxError.DEFINITION=16,Eden.SyntaxError.FUNCCALLEND=17,Eden.SyntaxError.LISTLITCLOSE=18,Eden.SyntaxError.TERNIFCOLON=19,Eden.SyntaxError.IFCONDOPEN=20,Eden.SyntaxError.IFCONDCLOSE=21,Eden.SyntaxError.PARAMNAME=22,Eden.SyntaxError.PARAMSEMICOLON=23,Eden.SyntaxError.FUNCOPEN=24,Eden.SyntaxError.FUNCCLOSE=25,Eden.SyntaxError.FUNCNAME=26,Eden.SyntaxError.FOROPEN=27,Eden.SyntaxError.FORCLOSE=28,Eden.SyntaxError.FORSTART=29,Eden.SyntaxError.FORCOND=30,Eden.SyntaxError.SUBSCRIBEOPEN=31,Eden.SyntaxError.SUBSCRIBECLOSE=32,Eden.SyntaxError.SWITCHOPEN=33,Eden.SyntaxError.SWITCHCLOSE=34,Eden.SyntaxError.DEFAULTCOLON=35,Eden.SyntaxError.CASELITERAL=36,Eden.SyntaxError.CASECOLON=37,Eden.SyntaxError.INSERTCOMMA=38,Eden.SyntaxError.DELETECOMMA=39,Eden.SyntaxError.APPENDCOMMA=40,Eden.SyntaxError.SCOPENAME=41,Eden.SyntaxError.SCOPEEQUALS=42,Eden.SyntaxError.SCOPECLOSE=43,Eden.SyntaxError.BACKTICK=44,Eden.SyntaxError.WHILEOPEN=45,Eden.SyntaxError.WHILECLOSE=46,Eden.SyntaxError.WHILENOSTATEMENT=47,Eden.SyntaxError.NEGNUMBER=48,Eden.SyntaxError.DEFINELISTIX=49,Eden.SyntaxError.OUTOFBOUNDS=50,Eden.SyntaxError.PROPERTYNAME=51,Eden.SyntaxError.WHILEOFDO=52,Eden.SyntaxError.PARAMNUMBER=53,Eden.SyntaxError.AFTEROPEN=55,Eden.SyntaxError.AFTERCLOSE=56,Eden.SyntaxError.ACTIONNAME=57,Eden.SyntaxError.WHENOPEN=58,Eden.SyntaxError.WHENCLOSE=59,Eden.SyntaxError.DONAME=60,Eden.SyntaxError.PROCNAME=61,Eden.SyntaxError.IMPORTPATH=62,Eden.SyntaxError.IMPORTOPTION=63,Eden.SyntaxError.IMPORTCOMB=64,Eden.SyntaxError.IFNOSTATEMENT=65,Eden.SyntaxError.AFTERNOSTATEMENT=66,Eden.SyntaxError.WHENNOSTATEMENT=67,Eden.SyntaxError.LITCHAREMPTY=68,Eden.SyntaxError.LITCHARCLOSE=69,Eden.SyntaxError.LITSTRLINE=70,Eden.SyntaxError.LITSTRCLOSE=71,Eden.SyntaxError.IMPORTTAG=72,Eden.SyntaxError.SWITCHSCRIPT=73,Eden.SyntaxError.RANGEBANNED=74,Eden.SyntaxError.HEREDOCTOKEN=75,Eden.SyntaxError.SELECTORACTION=76,Eden.SyntaxError.SELECTORATTRIB=77,Eden.SyntaxError.SELECTORTAG=78,Eden.SyntaxError.SELECTORBTICK=79,Eden.SyntaxError.SELECTOROPTION=80,Eden.SyntaxError.QUERYOPEN=81,Eden.SyntaxError.QUERYCLOSE=82,Eden.SyntaxError.QUERYSELECTOPEN=83,Eden.SyntaxError.QUERYSELECTCLOSE=84,Eden.SyntaxError.QUERYSELECTCOMMA=85,Eden.SyntaxError.BLOCKCOMMENT=86,Eden.SyntaxError.NEWLINE=87,Eden.SyntaxError.WHENROLE=88,Eden.SyntaxError.ALIASQUERY=89,Eden.SyntaxError.EVALOPEN=90,Eden.SyntaxError.EVALCLOSE=91,Eden.SyntaxError.DOATTRIBCLOSE=92,Eden.SyntaxError.DOBADATTRIB=93,Eden.SyntaxError.QUERYNOTALLOWED=94,Eden.SyntaxError.SYNCNOTALLOWED=95,Eden.SyntaxError.BADEXPRTYPE=96,Eden.SyntaxError.db=[{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return"}"==this.token||"]"==this.token?0:";"==this.token?1:2},suggestion:{expected:[")"],next:[";","+","-","==","<=",">=","!=","/","*","%","^"]}},{message:function(){if("{"==this.token)return 0;if(")"==this.token)return"operator"==this.context.stream.tokenType(this.prevtoken)?3:1;var e=this.context.stream.tokenType(this.token);return"keyword"==e?4:"operator"==e?3:2},suggestion:{expected:["NUMBER","STRING","OBSERVABLE","&","!","("],next:["NUMBER","STRING","OBSERVABLE","&","!","(",";","+","-","==","<=",">=","!=","/","*","%","^"]}},{message:function(){return"{"==this.token?1:"OBSERVABLE"==this.token?0:"keyword"==this.context.stream.tokenType(this.token)?3:2},suggestion:{expected:[":"],next:["OBSERVABLE"]}},{message:function(){if("{"==this.token)return 2;if("("==this.token)return 3;if("["==this.token&&(":"==this.prevtoken||","==this.prevtoken))return 6;if("NUMBER"==this.token||"STRING"==this.token)return 4;if(","==this.token)return 5;var e=this.context.stream.tokenType(this.token);return"keyword"==e?0:1},suggestion:{expected:["OBSERVABLE"],next:[",","{"]}},{message:function(){return"{"==this.token?0:"("!=this.token||this.context.stream.isBEOL()?"keyword"==this.context.stream.tokenType(this.token)?2:3:1},suggestion:{expected:["OBSERVABLE"],next:[",","{"]}},{message:function(){if(("("==this.token||"["==this.token)&&this.context.stream.isBEOL())return 6;if("("==this.token)return 0;if("["==this.token)return 1;if(";"==this.token)return 2;var e=this.context.stream.tokenType(this.token);return"keyword"==e||"identifier"==e?3:"separator"==e?4:5},suggestion:{expected:["{"],next:["local","OBSERVABLE","if","for","switch","while","return"]}},{message:function(){return(")"==this.token||"]"==this.token)&&this.context.stream.isBEOL()?0:1},suggestion:{expected:["}"],next:["proc","func","if","for","OBSERVABLE","switch","while","return","continue","break"]}},{message:function(){return"keyword"==this.context.stream.tokenType(this.token)?0:";"==this.token?1:2},suggestion:{expected:["OBSERVABLE"],next:[";"]}},{message:function(){return"is"==this.token||"="==this.token?1:0},suggestion:{expected:[";"],next:["local","OBSERVABLE","if","for","switch","while","return"]}},{message:function(){return 0},suggestion:{expected:["touch","change","("],next:["OBSERVABLE",":","NUMBER","STRING","!","&"]}},{message:function(){return 0},suggestion:{expected:["(","OBSERVABLE","NUMBER"],next:["]","OBSERVABLE","NUMBER","+","-","/","*","%","^"]}},{message:function(){return 1},suggestion:{expected:["]"],next:["[",".","=","+=","-=","==","+","-","/","*",";","/=","*=","%","^","is"]}},{message:function(){return 0},suggestion:{expected:["OBSERVABLE"],next:[".","[","is","=","+=","-=","++","--","*=","/="]}},{message:function(){if("."==this.token){var e=this.position>=2?this.context.stream.code.charCodeAt(this.position-2):0;return"NUMBER"==this.prevtoken&&32!=e&&160!=e?1:2}return"OBSERVABLE"==this.token?this.context.stream.isBEOL()?3:4:0},suggestion:{expected:[";"],next:["proc","when","OBSERVABLE","if","for","while","EOF","switch","func"]}},{message:function(){return 0},suggestion:{expected:["proc","func","when","if","for","while","switch","OBSERVABLE","{"],next:["OBSERVABLE","(","change","touch","is","=","+=","-=","*=","proc","func","when","if","for","while","switch"]}},{message:function(){return 0},suggestion:{expected:["=","is","+=","-=","/=","*="],next:["(","OBSERVABLE","NUMBER","STRING","!"]}},{message:function(){return 0},suggestion:{expected:[")"],next:[";","(","[","+","-","/","*","%","^"]}},{message:function(){return 0},suggestion:{expected:["]"],next:[]}},{message:function(){return 0},suggestion:{expected:[":"],next:[]}},{message:function(){return 0},suggestion:{expected:["("],next:[]}},{message:function(){return 0},suggestion:{expected:[")"],next:[]}},{message:function(){return 0},suggestion:{expected:["OBSERVABLE"],next:[";"]}},{message:function(){return 0},suggestion:{expected:[";"],next:["para","local","OBSERVABLE","if","for","switch","while","return"]}},{message:function(){if(("("==this.token||"["==this.token)&&this.context.stream.isBEOL())return 6;if("("==this.token)return 0;if("["==this.token)return 1;if(";"==this.token)return 2;var e=this.context.stream.tokenType(this.token);return"keyword"==e||"identifier"==e?3:"separator"==e?4:5},suggestion:{expected:["{"],next:["local","OBSERVABLE","if","for","switch","while","return"]}},{message:function(){return 0},suggestion:{expected:["}"],next:[";"]}},{message:function(){return 0},suggestion:{expected:["OBSERVABLE"],next:["{"]}},{message:function(){return 0},suggestion:{expected:["("],next:[]}},{message:function(){return 0},suggestion:{expected:[")"],next:[]}},{message:function(){return 0},suggestion:{expected:[";"],next:[]}},{message:function(){return 0},suggestion:{expected:[";"],next:[]}},{message:function(){return 0},suggestion:{expected:["["],next:[]}},{message:function(){return 0},suggestion:{expected:["]"],next:[]}},{message:function(){return 0},suggestion:{expected:["("],next:[]}},{message:function(){return 0},suggestion:{expected:["]"],next:[]}},{message:function(){return 0},suggestion:{expected:[":"],next:[]}},{message:function(){return 0},suggestion:{expected:["NUMBER","STRING"],next:[]}},{message:function(){return 0},suggestion:{expected:[":"],next:[]}},{message:function(){return 0},suggestion:{expected:[","],next:[]}},{message:function(){return 0},suggestion:{expected:[","],next:[]}},{message:function(){return 0},suggestion:{expected:[","],next:[]}},{message:function(){return 0},suggestion:{expected:["OBSERVABLE"],next:[]}},{message:function(){return 0},suggestion:{expected:["="],next:[]}},{message:function(){return 0},suggestion:{expected:["}"],next:[]}},{message:function(){return 0},suggestion:{expected:["`"],next:[]}},{message:function(){return 0},suggestion:{expected:["("],next:[]}},{message:function(){return 0},suggestion:{expected:[")"],next:[]}},{message:function(){return 0},suggestion:{expected:[")"],next:[]}},{message:function(){return 0},suggestion:{expected:["NUMBER"],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){var e=this.context.stream.tokenType(this.token);return"keyword"==e?0:"boolean"==e||"character"==e||"string"==e||"number"==e?1:":"==this.token?4:"{"==this.token?5:"closebracket"==this.token?3:2},suggestion:{expected:["OBSERVABLE"],next:[":"]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}}];const e=Eden.Language;Eden.SyntaxError.prototype.extractBefore=function(e){for(var t=this.prevposition;t>0&&e>0&&10!=this.context.stream.code.charCodeAt(t);)t--,e--;return 10==this.context.stream.code.charCodeAt(t)&&t++,this.context.stream.code.substr(t,this.prevposition-t)},Eden.SyntaxError.prototype.extractToken=function(){return this.context.stream.code.substr(this.prevposition,this.position-this.prevposition)},Eden.SyntaxError.prototype.extractAfter=function(e){for(var t=this.position;t<this.context.stream.code.length&&e>0&&10!=this.context.stream.code.charCodeAt(t);)t++,e--;return this.context.stream.code.substr(this.position,t-this.position)},Eden.SyntaxError.prototype.buildSuggestion=function(){var e=Eden.SyntaxError.db[this.errno].suggestion;return-1!=e.next.indexOf(this.token)?this.extractBefore(10)+e.expected[0]+" "+this.extractToken()+this.extractAfter(10):this.extractBefore(10)+e.expected[0]+" "+this.extractAfter(10)},Eden.SyntaxError.prototype.messageText=function(){var t=Eden.SyntaxError.db[this.errno],n=e.errors[this.errno][t.message.call(this)];return void 0===this.extra?n:n+": "+this.extra},Eden.SyntaxError.prototype.prettyPrint=function(){this.context.stream.pushPosition(),this.context.stream.move(this.position);var t=Eden.SyntaxError.db[this.errno],n="Error:\n    "+e.errors[this.errno][t.message.call(this)]+"\n    Source : "+this.context.src+", line "+this.line+"\n    Code   : "+this.errno;return n+="\n    Here   : "+this.extractBefore(10)+">>> "+this.extractToken()+" <<<"+this.extractAfter(10),t.suggestion&&(n+="\n    Suggestion : "+this.buildSuggestion()),this.context.stream.popPosition(),n},Eden.SyntaxError.prototype.toString=function(){return this.prettyPrint()},Eden.RuntimeError=function(e,t,n,r){this.type="runtime",this.line=-1,this.statement=n,this.extra=r,this.errno=t,this.context=e},Eden.RuntimeError.UNKNOWN=0,Eden.RuntimeError.ASSIGNEXEC=1,Eden.RuntimeError.FUNCCALL=2,Eden.RuntimeError.ACTIONNAME=3,Eden.RuntimeError.NOAGENT=4,Eden.RuntimeError.NOTSUPPORTED=5,Eden.RuntimeError.ASSIGNTODEFINED=6,Eden.RuntimeError.ASSIGNDIMENSION=7,Eden.RuntimeError.EXTENDSTATIC=8,Eden.RuntimeError.INFINITERANGE=9,Eden.RuntimeError.NOLISTRANGE=10,Eden.RuntimeError.LEFTCONCAT=11,Eden.RuntimeError.RIGHTCONCAT=12,Eden.RuntimeError.AGENTSOURCE=13,Eden.RuntimeError.JSOBSERVER=14,Eden.RuntimeError.PROCAGENT=15,Eden.RuntimeError.ARGUMENTS=16,Eden.RuntimeError.NOTCHILD=17,Eden.RuntimeError.INFINITEWHEN=18,Eden.RuntimeError.ASSERTVALID=19,Eden.RuntimeError.ASSERTTYPE=20,Eden.RuntimeError.prototype.messageText=function(){var e=!this.statement||"functioncall"!=this.statement.type&&"definition"!=this.statement.type&&"assignment"!=this.statement.type?"":"'"+this.statement.lvalue.name+"': ";switch(!this.statement&&this.context&&this.context.currentObservables&&this.context.currentObservables.length>0&&(e=this.context.currentObservables[this.context.currentObservables.length-1].name+": "),this.errno){case Eden.RuntimeError.ACTIONNAME:case Eden.RuntimeError.NOAGENT:case Eden.RuntimeError.NOTSUPPORTED:case Eden.RuntimeError.AGENTSOURCE:case Eden.RuntimeError.JSOBSERVER:case Eden.RuntimeError.PROCAGENT:case Eden.RuntimeError.ARGUMENTS:case Eden.RuntimeError.EXTENDSTATIC:return e+this.extra;case Eden.RuntimeError.ASSERTVALID:return e+"Assert - "+this.extra;case Eden.RuntimeError.ASSERTTYPE:return e+"bad type - "+this.extra;case Eden.RuntimeError.ASSIGNTODEFINED:return e+"cannot assign to a defined list, use 'is'";case Eden.RuntimeError.ASSIGNDIMENSION:return e+"list does not have this many dimensions";case Eden.RuntimeError.RIGHTCONCAT:return e+"Concatenation: When the right hand side is a list then the left hand side must also be a list";case Eden.RuntimeError.LEFTCONCAT:return e+"Concatenation: When the left hand side is a list then the right hand side must also be a list";case Eden.RuntimeError.INFINITERANGE:return e+"range scope is infinite";case Eden.RuntimeError.NOLISTRANGE:return e+"range 'in' is not a list";case Eden.RuntimeError.INFINITEWHEN:return e+"infinite when loop detected"}return String(this.extra).search("is not a function")>=0?e+"function used does not exist":this.errno==Eden.RuntimeError.FUNCCALL&&(String(this.extra).search("Cannot read property 'call'")>=0||String(this.extra).search("Cannot read property 'apply'")>=0)?e+"procedure does not exist":String(this.extra).match(/Cannot read property .* of undefined/)?e+"uses an undefined list":this.extra},Eden.RuntimeError.prototype.edenSource=function(){if(this.statement)if("definition"==this.statement.type){var e=this.context.symbols[this.statement.lvalue.name];if(e&&e.definition)return e.getSource()}else if(this.statement.getSource)return this.statement.getSource()},Eden.RuntimeError.prototype.javascriptSource=function(){return this.statement.generate({scopes:[],dependencies:{}},"scope")},Eden.RuntimeError.prototype.details=function(){var e="";return"definition"!=this.statement.type&&"assignment"!=this.statement.type||(e+="Symbol: "+this.statement.lvalue.name+"\n"),String(this.extra).search("SyntaxError")>=0?e+="JavaScript: "+this.javascriptSource()+"\n":e+="Source: "+this.edenSource()+"\n",this.extra.message&&(e+="Original: "+this.extra.message+"\n"),e},Eden.RuntimeError.prototype.prettyPrint=function(){return this.extra&&this.extra.stack?"Run-time Error:\n"+this.extra.stack:"Run-time Error:\n"}}(),function(){Eden.Selectors={cache:{}};const e=Eden.EdenSymbol;Eden.Selectors.getScriptBase=function(e){for(var t=e;t.parent;)t=t.parent;return t.base.origin.name},Eden.Selectors.buildScriptTree=function(e){for(var t={},n=0;n<e.length;n++)for(var r=e[n].split(/[\.\:]+/),i=t,s=0;s<r.length;s++)void 0===i[r[s]]&&(i[r[s]]={}),i=i[r[s]];return t},Eden.Selectors.getID=function(e){for(var t=e,n=[];t;)"script"==t.type&&t.name?void 0===t.parent?t.base&&t.base.origin&&t.base.origin.id?n.splice(0,0,t.name+".id("+t.base.origin.id+")"):eden.project&&t===eden.project.ast.script?n.splice(0,0,":project"):n.splice(0,0,t.name+".id("+t.id+")"):n.splice(0,0,t.name):n.splice(0,0,".id("+t.id+")"),(t=t.parent)&&("script"==t.type&&t.parent&&"script"!=t.parent.type?t="codeblock"==t.parent.type?t.parent.parent:t.parent:"codeblock"==t.type&&(t=t.parent));return n.join(" > ")},Eden.Selectors.getPath=function(e){},Eden.Selectors.testType=function(e){if("binaryop"==e.type)switch(e.op){case"+":case"-":case"/":case"*":case"^":case"%":return"number";case"//":return"list";case"==":case"<":case">":case"<=":case">=":case"||":case"&&":case"!=":return"boolean";default:return"unknown"}else if("literal"==e.type)switch(e.datatype){case"NUMBER":return"number";case"BOOLEAN":return"boolean";case"STRING":return"string";case"LIST":return"list";default:return"unknown"}return"unknown"},Eden.Selectors.getChildren=function(e,t){var n=[];if(void 0===e)return n;for(var r=0;r<e.length;r++)if("script"==e[r].type)n.push.apply(n,e[r].statements),t&&n.push.apply(n,Eden.Selectors.getChildren(e[r].statements,t));else if("for"==e[r].type)e[r].statement&&"script"==e[r].statement.type&&(n.push.apply(n,e[r].statement.statements),t&&n.push.apply(n,Eden.Selectors.getChildren(e[r].statement.statements,t)));else if("if"==e[r].type)e[r].statement&&"script"==e[r].statement.type&&(n.push.apply(n,e[r].statement.statements),t&&n.push.apply(n,Eden.Selectors.getChildren(e[r].statement.statements,t))),e[r].elsestatement&&"script"==e[r].elsestatement.type&&(n.push.apply(n,e[r].elsestatement.statements),t&&n.push.apply(n,Eden.Selectors.getChildren(e[r].elsestatement.statements,t)));else if("when"==e[r].type)e[r].statement&&"script"==e[r].statement.type&&(n.push.apply(n,e[r].statement.statements),t&&n.push.apply(n,Eden.Selectors.getChildren(e[r].statement.statements,t)));else if("while"==e[r].type)e[r].statement&&"script"==e[r].statement.type&&(n.push.apply(n,e[r].statement.statements),t&&n.push.apply(n,Eden.Selectors.getChildren(e[r].statement.statements,t)));else if("do"==e[r].type)e[r].script&&"script"==e[r].script.type&&(n.push.apply(n,e[r].script.statements),t&&n.push.apply(n,Eden.Selectors.getChildren(e[r].script.statements,t)));else if("section"==e[r].type){for(var i=e[r].nextSibling,s=[];i&&("section"!=i.type||i.depth>e[r].depth);)"dummy"!=i.type&&(n.push(i),s.push(i)),i=i.nextSibling;t&&n.push.apply(n,Eden.Selectors.getChildren(s,t))}return n=n.filter(function(e){return"dummy"!=e.type})},Eden.Selectors.allowedOptions={external:!0,local:!0,history:!0,all:!0,indexed:!0,index:!0,nosort:!0,remote:!0,depend:!0},Eden.Selectors.resultTypes={brief:!0,comment:!0,source:!0,innersource:!0,title:!0,path:!0,name:!0,symbol:!0,line:!0,depends:!0,value:!0,tags:!0,rawcomment:!0,id:!0,remote:!0,root:!0,enabled:!0,executed:!0,exprtree:!0,single:!0,expression:!0,locked:!0,ast:!0,static:!0,volatile:!0,eager:!0,number:!0,string:!0,object:!0,list:!0,boolean:!0},Eden.Selectors.expressionToLists=function(e){switch(e.type){case"binaryop":return[e.op,Eden.Selectors.expressionToLists(e.l),Eden.Selectors.expressionToLists(e.r)];case"ternaryop":return["eif",Eden.Selectors.expressionToLists(e.first),Eden.Selectors.expressionToLists(e.condition),Eden.Selectors.expressionToLists(e.second)];case"unaryop":return[e.op,Eden.Selectors.expressionToLists(e.r)];case"length":return["#",Eden.Selectors.expressionToLists(e.l)];case"index":return Eden.Selectors.expressionToLists(e.expression);case"async":return["sync",Eden.Selectors.expressionToLists(e.expression)];case"query":return["query",Eden.Selectors.expressionToLists(e.selector),e.restypes]}if(console.log(e),"functioncall"==e.type){console.log("FUNCCALL");for(var t=[],n=0;n<e.params.length;n++)t.push(Eden.Selectors.expressionToLists(e.params[n]));return["(",t,")"]}if("literal"==e.type)switch(e.datatype){case"NUMBER":case"STRING":case"BOOLEAN":return["literal",e.value];case"LIST":for(t=[],n=0;n<e.value.length;n++)t.push(Eden.Selectors.expressionToLists(e.value[n]));return["literal",t]}else if("primary"==e.type){if(0==e.extras.length)return e.observable;var r=[e.observable];for(n=0;n<e.extras.length;n++)r.push(Eden.Selectors.expressionToLists(e.extras[n]));return r}},Eden.Selectors.listsToExpression=function(e){if(!Array.isArray(e))return e;for(var t=[],n=0;n<e.length;n++)t.push(Eden.Selectors.listsToExpression(e[n]));return"("+t.join(" ")+")"},Eden.Selectors.processResults=function(t,n){if(n){for(var r=Array.isArray(n)?n:n.split(","),i=[],s=!1,o=0;o<t.length;o++){for(var a=t[o],d=[],c=0;c<r.length;c++){var h=void 0;switch(r[c]){case"ast":h=a;break;case"single":s=!0;break;case"brief":a.doxyComment&&(h=a.doxyComment.brief());break;case"comment":a.doxyComment&&(h=a.doxyComment.stripped());break;case"source":h=a&&a.getSource?a.getSource():"";break;case"innersource":"script"==a.type?h=a.getInnerSource():"custom"==a.type?h=a.text:a&&a.getSource&&(h=a.getSource());break;case"outersource":h=a.getOuterSource();break;case"exprtree":a.expression&&(h=Eden.Selectors.expressionToLists(a.expression));break;case"expression":a.expression&&a.lvalue&&a.lvalue.source&&(h=a.getSource().substr(a.lvalue.source.length).trim(),"definition"==a.type?h=h.substring(2,h.length-1).trim():"assignment"==a.type&&(h=h.substr(1,h.length-1).trim()));break;case"title":if(a.base&&a.base.mainDoxyComment){a.base.mainDoxyComment.stripped();var p=a.base.mainDoxyComment.getControls();p&&p["@title"]&&(h=p["@title"][0])}break;case"type":h=a.type;break;case"locked":h=!!a.lock;break;case"name":a.lvalue&&a.lvalue.name?h=a.lvalue.name:a.name&&"do"!=a.type?h=a.name:void 0===a.parent&&a.base&&a.base.origin?h=a.base.origin.name:void 0!==a.path&&(h=a.path);break;case"symbol":a.lvalue&&a.lvalue.name&&(h=a.lvalue.name);break;case"line":void 0!==a.line&&(h=a.line);break;case"depends":h=a.dependencies?Object.keys(a.dependencies):[];break;case"value":if(a instanceof e)h=a.value();else try{h=a.expression?a.expression.execute({scopes:[]},eden.project.ast,eden.root.scope):void 0}catch(e){}break;case"active":h="when"==a.type&&a.enabled||a.lvalue&&eden.root.symbols[a.lvalue.name]&&eden.root.symbols[a.lvalue.name].origin&&eden.root.symbols[a.lvalue.name].origin.id==a.id;break;case"executed":h=a.executed>0;break;case"historic":h=-1==a.executed;break;case"tags":a.doxyComment&&(h=a.doxyComment.getHashTags());break;case"rawcomment":a.doxyComment&&(h=a.doxyComment.content);break;case"controls":case"id":h=a.id;break;case"path":h=Eden.Selectors.getID(a);break;case"remote":for(var l=a;l.parent;)l=l.parent;if(!l.base||!l.base.origin){h=!1;break}h=l.base.origin.remote;break;case"root":h=void 0===a.parent;break;case"static":h=!!(a instanceof e&&a.origin)&&a.origin.lvalue.isstatic}d.push(h)}d.length>1?i.push(d):1==d.length&&void 0!==d[0]&&i.push(d[0])}return s?i[0]:i}return t},Eden.Selectors.outerBracket=function(e){for(var t=0,n=0;n<e.length;n++)if("("==e.charAt(n))t++;else if(")"==e.charAt(n)&&0==--t)return n;return e.length},Eden.Selectors.makeRegex=function(e){return e="/"==e.charAt(0)?"/"==e.charAt(e.length-1)?e.substring(1,e.length-1):e.substring(1):"^"+e.replace(/([\\+^$.|(){[])/g,"\\$1").replace(/([*?])/g,".$1")+"$",new RegExp(e)},Eden.Selectors.SortNode=function(){this.type="sort",this.query=void 0},Eden.Selectors.DotNode=function(e){this.type="dot",this.label=e},Eden.Selectors.parse=function(e,t){var n=t;if(e&&""!=e){for(e=e.trim();e.length>0&&"@"==e.charAt(0);){n||(n={});var r=(e=e.substring(1)).search(/[^a-z]+/);-1==r&&(r=e.length);var i=e.substring(0,r);e=e.substring(r).trim(),n[i]=!0}return Eden.Selectors._parse(e,n)}},Eden.Selectors._parse=function(e,t){var n;if(e&&""!=e){if(">"==e.charAt(0))">"==e.charAt(1)?(n=new Eden.Selectors.NavigateNode(">",!0),e=e.substring(2).trim()):(n=new Eden.Selectors.NavigateNode(">",!1),e=e.substring(1).trim());else if("<"==e.charAt(0))"<"==e.charAt(1)?(n=new Eden.Selectors.NavigateNode("<",!0),e=e.substring(2).trim()):(n=new Eden.Selectors.NavigateNode("<",!1),e=e.substring(1).trim());else if(","==e.charAt(0))n=new Eden.Selectors.UnionNode,e=e.substring(1).trim();else if(":"==e.charAt(0)||"."==e.charAt(0)){-1==(h=(a=e.substring(1)).search(/[^a-zA-Z0-9\-]/))?h=e.length:h++;var r=e.substring(0,h),i=void 0;if(h<e.length&&"("==e.charAt(h)){var s=Eden.Selectors.outerBracket(e);i=e.substring(h+1,s),e=e.substring(s+1).trim()}else e=e.substring(h).trim();if(r.charAt(1).match(/[0-9]+/)){var o=parseInt(r.substring(1));n=new Eden.Selectors.PropertyNode(o)}else n=new Eden.Selectors.PropertyNode(r,i)}else if("^"==e.charAt(0)){var a;-1==(h=(a=e.substring(1)).search(/[^a-zA-Z0-9\-]/))&&(h=a.length);r=a.substring(0,h),i=void 0;if(h<a.length&&"("==a.charAt(h)){s=Eden.Selectors.outerBracket(a);i=a.substring(h+1,s),a=a.substring(s+1).trim()}else a=a.substring(h);(n=new Eden.Selectors.SortNode).addSort(r),e=a.trim()}else if("#"==e.charAt(0)){var d=e.match(/#[a-zA-Z0-9_*?]+/);if(null===d)return;d=d[0],n=new Eden.Selectors.TagNode(d),e=e.substring(d.length).trim()}else if(e.charAt(0).match(/[a-zA-Z*?]+/)){-1==(h=e.search(/[^a-zA-Z0-9_*?\s]+/))&&(h=e.length);var c=e.substring(0,h).trim();n=new Eden.Selectors.NameNode(c),e=e.substring(h).trim()}else if("/"==e.charAt(0)){for(var h=-1,p=1;p<e.length;p++){if("/"==e.charAt(p)){h=p+1;break}"\\"==e.charAt(p)&&p++}-1==h&&(h=e.length);c=e.substring(0,h).trim();n=new Eden.Selectors.NameNode(c),e=e.substring(h).trim()}else e="";var l=Eden.Selectors._parse(e,t);if(n)return n.options=t,n.append(l)}},Eden.Selectors.unique=function(e){for(var t={},n=0;n<e.length;n++)void 0!==e[n]&&(t[e[n].id]=e[n]);var r=[];for(var i in t)r.push(t[i]);return r},Eden.Selectors.sort=function(e){return e.sort(function(e,t){return t.stamp-e.stamp})},Eden.Selectors._depend=function(t){return this.options&&this.options.depend&&this.options.self&&this.options.self instanceof e?t.then(e=>{for(var t of e)t.addSubscriber&&this.options.self.subscribeDynamicSym(t);return e}):t},Eden.Selectors.queryWithinSync=function(e,t,n){var r=Eden.Selectors.parse(t),i=[];if(!r)return i;let s=r._filter(e);return s?(s=Eden.Selectors.unique(s),i=n?Eden.Selectors.processResults(s,n):s):[]},Eden.Selectors.queryWithin=function(e,t,n,r){r||console.error("QUERY WITHIN WITHOUT CB");var i=Eden.Selectors.parse(t),s=[];return i?(i.filter(e).then(e=>{var t=Eden.Selectors.unique(e);s=n?Eden.Selectors.processResults(t,n):t,r&&r(s)}),s):s},Eden.Selectors.query=function(e,t,n,r){if(!r)return[];Eden.Selectors._query(e,t,n,(e,n)=>{r(n?e:Eden.Selectors.processResults(e,t))})},Eden.Selectors._query=function(e,t,n,r){var i,s,o=[];if(r||console.warn("Selector query without callback: ",e),n&&(i=n.context,s=n.minimum),"boolean"==typeof s&&console.trace("Bool"),"string"!=typeof e||""==e){var a=[];return console.log("Invalid selector"),r&&r(a,!0),a}var d=Eden.Selectors.parse(e.trim(),n?n.options:void 0);if(void 0===d)return console.log("Selector parse error"),r&&r([],!0),[];let c=n=>{if(o=n,d.options&&d.options.remote||(d.options&&d.options.all||(o=Eden.Selectors.unique(o)),d.options&&d.options.nosort||(o=Eden.Selectors.sort(o))),0==d.local&&r&&(void 0===s||o.length<s)){var i=e.search(/[\s\.\:\#\@\>]/);-1==i&&(i=e.length);var a=e.substring(0,i).trim();if(a.startsWith("plugins")){for(var c=e.split(">"),h="",p=0;p<c.length;p++)c[p]=c[p].trim(),h+=c[p],p<c.length-1&&(h+="/");Eden.Utils.getURL(h+".js-e").then(function(t){var n=[new Eden.AST(t,void 0,{name:c[c.length-1],remote:!0}).script];Eden.Selectors.cache[e]=n[0],r(n)}).catch(e=>{r([])})}else d.options&&d.options.local||!Eden.DB?Eden.Project.local&&Eden.Project.local[a]?Eden.Utils.getURL(Eden.Project.local[a].file).then(function(e){var t=[new Eden.AST(e,void 0,{name:a,remote:!0}).script];Eden.Selectors.cache[a]=t[0],o=t,d.filter(t).then(e=>{var t=Eden.Selectors.unique(e);r(t)})}):r(o):Eden.DB.searchSelector(e,void 0===t?["outersource","path"]:t,function(e){if(void 0===t&&e.length>0){let t=n=>{if(n<e.length){var i;i=Eden.AST.parseStatement(e[n][0],{remote:!0,version:0});var s=Eden.AST.originFromDoxy(i.doxyComment);s.remote=!0,i.base.origin=s,i.id=s.id,Eden.Selectors.queryWithin([i],e[n][1],null,e=>{var r=e[0];r&&(o.push(r),d.options&&d.options.index&&i.addIndex()),t(++n)})}else r(o)};t(0)}else void 0===e||0==e.length?Eden.Project.local&&Eden.Project.local[a]?Eden.Utils.getURL(Eden.Project.local[a].file).then(function(e){var t=[new Eden.AST(e,void 0,{name:a,remote:!0}).script];Eden.Selectors.cache[a]=t[0],d.filter(t).then(e=>{var t=Eden.Selectors.unique(e);r(t)})}):r(o):(o.push.apply(o,e),r(o,!0))})}else r(o)};return d.options&&d.options.remote?c([]):!i||"script"!=i.type||d.options&&d.options.indexed?d.filter().then(e=>{c(e)}):d.filter(i.statements).then(e=>{e&&0!=e.length?c(e):d.filter().then(e=>{c(e)})}),n?n.returnvalue:void 0},Eden.Selectors.queryPromise=function(e,t,n){return new Promise((r,i)=>{Eden.Selectors.query(e,t,n,e=>{r(e)})})},Eden.Selectors.execute=function(t,n,r){Eden.Selectors.query(t,void 0,{minimum:1},function(t){t&&t.length>0?function i(s){for(var o=t[s];o.parent;)o=o.parent;o.base.executeStatement(t[s],n,e.localJSAgent,function(){++s<t.length?i(s):r&&r()})}(0):r&&r()})},Eden.Selectors.goto=function(t){Eden.Selectors.query(t,void 0,{minimum:1,noindex:!1},function(n){if(0==n.length)return!1;for(var r=[n[0]],i=n[0];i.parent;)r.push(i.parent),i=i.parent;for(var s=!1,o=0;o<r.length;o++)if(Eden.Fragment.emit("goto",[r[o],n[0]])){s=!0;break}if(!s){for(var a in console.log("No Goto Match, create view",t,n[0]),edenUI.activeDialogs)if("ScriptInput"==edenUI.activeDialogs[a]){var d=eden.root.lookup("view_"+a+"_tabs").value(),c="script"==n[0].type?t:Eden.Selectors.getID(n[0].parent);d.push(c),eden.root.lookup("view_"+a+"_tabs").assign(d,eden.root.scope,e.localJSAgent),Eden.Fragment.emit("goto",[void 0,n[0]]),eden.root.lookup("view_"+a+"_current").assign(d.length-1,eden.root.scope,e.localJSAgent),s=!0;break}if(!s){edenUI.createView("gotoscript","ScriptInput");d=[c="script"==n[0].type?t:Eden.Selectors.getID(n[0].parent)];eden.root.lookup("view_gotoscript_tabs").assign(d,eden.root.scope,e.localJSAgent),eden.root.lookup("view_gotoscript_current").assign(0,eden.root.scope,e.localJSAgent),s=!0}}return s})},Eden.Selectors.assign=function(e,t,n,r,i){Eden.Selectors.query(e,void 0,{minimum:1,noindex:!0,options:{self:r}},function(e){var r="string"==typeof t?t.split(","):t,s=Array.isArray(n)?n:[n];if(s.length<r.length)return console.error("Not enough values"),void(i&&i([]));for(var o=0;o<e.length;o++)for(var a=0;a<r.length;a++)switch(r[a]){case"source":if(e[o].parent){var d=e[o].parent;if("string"==typeof s[a]){var c=Eden.AST.parseStatement(s[a]);e[o].parent.replaceChild(e[o],c)}else void 0===s[a]&&e[o].parent.removeChild(e[o]);for(;d;)Eden.Fragment.emit("patch",[void 0,d]),d=d.parent}else console.error("Cannot replace outer source of root script");break;case"innersource":if("script"==e[o].type){c=Eden.AST.parseScript(s[a]);e[o].patchInner(c);for(d=e[o];d;)Eden.Fragment.emit("patch",[void 0,d]),d=d.parent}else console.error("Cannot replace innersource of non-script node");break;case"expression":if("definition"==e[o].type||"assignment"==e[o].type){c=Eden.AST.parseExpression(s[a]);e[o].expression=c,e[o].reset(),e[o].source=e[o].lvalue.source+("definition"==e[o].type?" is ":" = ")+s[a]+";";for(d=e[o];d;)Eden.Fragment.emit("patch",[void 0,d]),d=d.parent}else console.error("Cannot replace expression");break;case"locked":"script"==e[o].type?s[a]?0==e[o].lock&&(e[o].lock=1,Eden.Fragment.emit("lock",[void 0,e[o]])):(e[o].lock=0,Eden.Fragment.emit("unlock",[void 0,e[o]])):console.error("Cannot replace expression");break;case"title":case"comment":case"rawcomment":var h=new Eden.AST.DoxyComment(s[a],0,0),p=new Eden.AST.DummyStatement;p.setSource(0,0,"#! "+s[a].trim().replace(/\n/g,"\n# ")+"\n"),e[o].doxyComment?e[o].parent.replaceChild(e[o].previousSibling,p):e[o].parent.insertBefore(e[o],p),Eden.Index.remove(e[o]),e[o].setDoxyComment(h),Eden.Index.update(e[o]);break;case"tags":case"executed":break;case"enabled":"when"==e[o].type&&(e[o].enabled&&!s[a]?(eden.project.removeAgent(e[o]),e[o].enabled=!1):!e[o].enabled&&s[a]&&(eden.project.registerAgent(e[o]),e[o].enabled=!0));break;case"name":"script"==e[o].type?(Eden.Index.remove(e[o]),e[o].prefix="action "+s[a]+" {",e[o].name=s[a],Eden.Index.update(e[o])):"assignment"!=e[o].type&&"definition"!=e[o].type||(Eden.Index.remove(e[o]),e[o].lvalue.name=s[a],e[o].source=e[o].source.replace(/\w*/,s[a]),Eden.Index.update(e[o]));break;default:console.error("Cannot modify property '"+r[a]+"'")}i&&i(e)})},Eden.Selectors.append=function(e,t,n,r,i){Eden.Selectors.query(e,void 0,{minimum:1,noindex:!0,options:{self:r}},function(e){var r="string"==typeof t?t.split(","):t,s=Array.isArray(n)?n:[n];if(s.length<r.length)return console.error("Not enough values"),void(i&&i([]));for(var o=0;o<e.length;o++)for(var a=0;a<r.length;a++)switch(r[a]){case"source":if(e[o].parent){var d=e[o].parent;if("string"==typeof s[a]){var c=Eden.AST.parseStatement(s[a]);e[o].parent.insertBefore(e[o],c)}else s[a];for(;d;)Eden.Fragment.emit("patch",[void 0,d]),d=d.parent}else console.error("Cannot replace outer source of root script");break;case"innersource":if("script"==e[o].type){c=Eden.AST.parseScript(s[a]);for(var h=0;h<c.statements.length;h++)e[o].appendChild(c.statements[h]);for(d=e[o];d;)Eden.Fragment.emit("patch",[void 0,d]),d=d.parent}else console.error("Cannot replace innersource of non-script node");break;case"title":case"comment":case"rawcomment":var p=new Eden.AST.DoxyComment(s[a],0,0);e[o].doxyComment=p;var l=new Eden.AST.DummyStatement;l.setSource(s[a],0,0),e[o].parent.insertBefore(e[o],l);break;case"tags":case"name":"script"==e[o].type&&(Eden.Index.remove(e[o]),e[o].prefix="action "+s[a]+" {",e[o].name=s[a],Eden.Index.update(e[o]));break;default:console.error("Cannot modify property '"+r[a]+"'")}i&&i(e)})},"undefined"!=typeof require&&"undefined"!=typeof exports&&(require("./property"),require("./navigate"),require("./name"),require("./tag"),require("./union"),require("./intersection"))}(),Eden.Selectors.PropertyNode=function(e,t){if(this.type="property",this.name=e,this.param=t,this.compare=void 0,this.value=t,this.range=!1,this.isreg=!!t&&-1!=t.indexOf("*"),this.meta="string"==typeof e?"."==e.charAt(0)?Eden.Selectors.PropertyNode.attributes[e.substring(1)]:Eden.Selectors.PropertyNode.pseudo[e.substring(1)]:void 0,this.local=!!this.meta&&this.meta.local,t){switch(t.charAt(0)){case"<":this.compare="="==t.charAt(1)?"<=":"<";break;case">":this.compare="="==t.charAt(1)?">=":">";break;case"=":this.compare="=";break;case"!":this.compare="!="}if(this.compare)switch(this.compare){case"!":case"=":case">":case"<":this.value=t.substring(1);break;case">=":case"<=":this.value=t.substring(2)}if(this.isreg?this.value=Eden.Selectors.makeRegex(this.value):null!==t.match(/^[0-9]+\-[0-9]+$/)?this.range=!0:null!==t.match(/^[0-9]+$/)&&(this.value=parseInt(t)),".type"==this.name){switch(this.param){case"is":this.param="definition";break;case"assign":case"=":this.param="assignment";break;case"call":this.param="functioncall";break;case"proc":this.param="action";break;case"action":this.param="script";break;case"+=":case"-=":case"*=":case"/=":case"++":case"--":this.param="modify"}this.value=this.param}}},Eden.Selectors.PropertyNode.attributes={name:{local:!1,indexed:!0,rank:1},type:{local:!1,indexed:!1,rank:3},datatype:{local:!1,indexed:!1,rank:30},id:{local:!1,indexed:!0,rank:2},lines:{local:!1,indexed:!1,rank:3},depends:{local:!1,indexed:!1,rank:4},determines:{local:!1,indexed:!1,rank:4},time:{local:!0,indexed:!1,rank:3},date:{local:!1,indexed:!1,rank:3},title:{local:!1,indexed:!1,rank:10},warning:{local:!1,indexed:!1,rank:10},author:{local:!1,indexed:!1,rank:10},v:{local:!1,indexed:!1,rank:20},vid:{local:!1,indexed:!1,rank:20},version:{local:!1,indexed:!1,rank:20},source:{local:!0,indexed:!1,rank:50},comment:{local:!0,indexed:!1,rank:50}},Eden.Selectors.PropertyNode.pseudo={line:{local:!1,indexed:!1,rank:50},determines:{local:!0,indexed:!0,rank:10},depends:{local:!0,indexed:!0,rank:10},first:{local:!1,indexed:!0,rank:5},last:{local:!1,indexed:!0,rank:5},unexecuted:{local:!0,indexed:!1,rank:3},executed:{local:!0,indexed:!1,rank:3},root:{local:!1,indexed:!0,rank:3},project:{local:!0,indexed:!0,rank:3},nth:{local:!1,indexed:!0,rank:5},value:{local:!0,indexed:!1,rank:50},matches:{local:!1,indexed:!1,rank:100},age:{local:!1,indexed:!1,rank:6},remote:{local:!0,indexed:!0,rank:20},not:{local:!1,indexed:!1,rank:100},active:{local:!0,indexed:!1,rank:10},me:{local:!1,indexed:!1,rank:20},listed:{local:!1,indexed:!1,rank:20},prev:{local:!0,indexed:!1,rank:20},next:{local:!0,indexed:!1,rank:20},this:{local:!0,indexed:!1,rank:20}},Eden.Selectors.PropertyNode.prototype.append=function(e){if(!e)return this;switch(e.type){case"property":case"tag":case"name":var t=new Eden.Selectors.IntersectionNode(this,e);return t.options=this.options,t;case"union":case"intersection":case"navigate":return e.prepend(this),e}return this},Eden.Selectors.PropertyNode.prototype.prepend=function(e){if(!e)return this;switch(e.type){case"property":case"tag":case"name":var t=new Eden.Selectors.IntersectionNode(e,this);return t.options=this.options,t;case"union":case"intersection":case"navigate":return e.append(this),e}return this},Eden.Selectors.PropertyNode.prototype.depend=Eden.Selectors._depend,Eden.Selectors.PropertyNode.prototype.filter=function(e){return e?this.depend(new Promise((t,n)=>{t(this._filter(e))})):this.depend(this.construct())},Eden.Selectors.PropertyNode.prototype._indirectSubFilter=function(e,t){var n=eden.root.lookup(t).indirectSubscribers();return e.filter(function(e){var t=e.lvalue&&e.lvalue.name?e.lvalue.name:e.name?e.name:void 0;return t&&n.hasOwnProperty(t)})},Eden.Selectors.PropertyNode.prototype._indirectDepFilter=function(e,t){var n=eden.root.lookup(t).indirectDependencies();return e.filter(function(e){var t=e.lvalue&&e.lvalue.name?e.lvalue.name:e.name?e.name:void 0;return t&&n.hasOwnProperty(t)})},Eden.Selectors.PropertyNode.prototype._filter=function(e){var t=this,n=this.value,r=this.name;if(!e)return this._construct();if("number"!=typeof this.name)switch(r){case".name":if(!n)return e.filter(function(e){return void 0!==e.lvalue||void 0!==e.name});var i=edenUI.regExpFromStr(n);return e.filter(function(e){return e.lvalue&&i.test(e.lvalue.name)||e.name&&i.test(e.name)});case".id":return e.filter(function(e){return 0==e.id&&e.buildID(),void 0===e.parent&&e.base&&e.base.origin&&e.base.origin.id?e.base.origin.id==n:e.id==n});case".type":if(!n)break;return e.filter(function(e){return e.type==n});case".warning":return e.filter(function(e){return e.warning});case".datatype":return e.filter(function(e){return e.expression&&Eden.Selectors.testType(e.expression)==n||e.expression&&"scope"==e.expression.type&&e.expression.range&&"list"==n});case".lines":case":line":return e;case".op":case".operator":case":pattern":return e;case".depends":return e.filter(function(e){return("definition"==e.type||"when"==e.type)&&(e.dependencies[n]||e.dynamicDependencies&&e.dynamicDependencies[n])});case".determines":return e.filter(function(e){return e instanceof EdenSymbol&&e.subscribers[n]});case":depends":return this._indirectSubFilter(e,n);case":determines":return this._indirectDepFilter(e,n);case":active":return e.filter(function(e){if("definition"==e.type||"assignment"==e.type){var t=eden.root.symbols[e.lvalue.name];return t&&(t.origin===e||t.origin&&t.origin.id==e.id)}return"when"==e.type&&e.enabled});case":first":return e.length>0?[e[0]]:[];case":last":return e.length>0?[e[e.length-1]]:[];case":unexecuted":return e.filter(function(e){return 0==e.executed});case":executed":return e.filter(function(e){return 1==e.executed});case":root":return e.filter(function(e){return void 0===e.parent});case":project":return[eden.project.ast.script];case":nth":return e.filter(function(e){return e.parent&&Eden.Selectors.getChildren([e.parent],!1)[t.value-1]===e});case":prev":return e.map(function(e){let t=e.previousSibling;for(;t&&"dummy"==t.type;)t=t.previousSibling;return t});case":next":return e.map(function(e){let t=e.nextSibling;for(;t&&"dummy"==t.type;)t=t.nextSibling;return t});case":value":return e;case":":case":matches":var s=Eden.Selectors.parse(this.param);return s?s._filter(e):[];case".title":return this.isreg?e.filter(function(e){if(!e.doxyComment)return!1;var n=e.doxyComment.getProperty("title");return n&&t.value.test(n)}):e.filter(function(e){if(!e.doxyComment)return!1;var n=e.doxyComment.getProperty("title");return n&&n==t.value});case".author":return e;case".v":case".vid":case".version":return e;case".source":return this.isreg?e.filter(function(e){return t.value.test(e.getSource())}):e.filter(function(e){return e.getSource()==t.value});case".comment":return this.isreg?e.filter(function(e){return e.doxyComment&&t.value.test(e.doxyComment.stripped())}):e.filter(function(e){return e.doxyComment&&e.doxyComment.stripped()==t.value});case":age":var o=generateTimeStamp(this.value),a=Date.now(),d=a-o;return console.log("AGE",o,a,d),void 0===this.compare||"<"==this.compare?e.filter(function(e){return e.stamp>d}):e.filter(function(e){return e.stamp<d});case".time":case".date":return e;case":remote":return e.filter(function(e){for(var t=e;t.parent;)t=t.parent;return!(!t.base||!t.base.origin)&&1==t.base.origin.remote});case":not":if(this.param){var c=Eden.Selectors.parse(this.param)._filter(e);return e.filter(function(e){for(var t=0;t<c.length;t++)if(e===c[t])return!1;return!0})}default:return[]}else e&&e.length>=this.name?resolve([e[this.name-1]]):resolve([])},Eden.Selectors.PropertyNode.prototype._construct=function(){var e;switch(this.name){case".type":e=Eden.Index.getByType(this.value);break;case".id":e=Eden.Index.getByID(this.value);break;case".v":case".vid":case".version":e=[];break;case".name":e=void 0===this.param?Eden.Index.getAllWithName():this.isreg?Eden.Index.getByNameRegex(this.value):Eden.Index.getByName(this.value);break;case":root":e=[eden.project.ast.script].concat(Object.keys(Eden.Selectors.cache).map(function(e){return Eden.Selectors.cache[e]}));break;case":remote":e=Object.keys(Eden.Selectors.cache).map(function(e){return Eden.Selectors.cache[e]});break;case":project":e=[eden.project.ast.script];break;case":this":e=this.options&&this.options.self?[this.options.self]:[];break;case":prev":e=(e=this.options&&this.options.self?[this.options.self]:[]).map(e=>{let t=e.previousSibling;for(;t&&"dummy"==t.type;)t=t.previousSibling;return t});break;case":next":e=(e=this.options&&this.options.self?[this.options.self]:[]).map(e=>{let t=e.nextSibling;for(;t&&"dummy"==t.type;)t=t.nextSibling;return t});break;case":active":e=[eden.root];break;case":depends":e=Object.values(eden.root.lookup(this.value).indirectSubscribers());break;case":determines":e=Object.values(eden.root.lookup(this.value).indirectDependencies());break;case".determines":e=Object.values(eden.root.lookup(this.value).dependencies).concat(Object.values(eden.root.lookup(this.value).dynamicDependencies));break;case".depends":e=Object.values(eden.root.lookup(this.value).subscribers);break;default:e=this._filter(Eden.Index.getAll())}return e},Eden.Selectors.PropertyNode.prototype.construct=function(){var e=this._construct();return this.options&&this.options.history?Promise.resolve(e):Promise.resolve(e.filter(function(e){return e.executed>=0}))},Eden.Selectors.NameNode=function(e){this.type="name",this.name=e,this.options=void 0,this.isreg="/"==e.charAt(0)||-1!=e.indexOf("*"),this.local=!1},Eden.Selectors.NameNode.prototype.depend=Eden.Selectors._depend,Eden.Selectors.NameNode.prototype.filter=function(e){return e?this.depend(Promise.resolve(this._filter(e))):this.depend(this.construct())},Eden.Selectors.NameNode.prototype._filter=function(e){var t=this.name;if(!e)return this._construct();if(this.isreg){var n=Eden.Selectors.makeRegex(this.name);return e.filter(function(e){return e.lvalue&&n.test(e.lvalue.name)||e.name&&n.test(e.name)})}return e.filter(function(e){return e.lvalue&&e.lvalue.name==t||e.name&&e.name==t})},Eden.Selectors.NameNode.prototype._construct=function(){var e=[];if(this.isreg){var t=Eden.Selectors.makeRegex(this.name);e=Eden.Index.getByNameRegex(t)}else{e=Eden.Index.getByName(this.name);for(var n=this.name.toLowerCase().split(" "),r=Eden.Index.getByTag("#"+n[0]),i=1;i<n.length;i++)r=r.filter(function(e){return(!eden.project||e!==eden.project.ast.script)&&e.doxyComment&&e.doxyComment.hasTag("#"+n[i])});e.push.apply(e,r)}return e},Eden.Selectors.NameNode.prototype.construct=function(){let e=this._construct();return this.options&&this.options.history?Promise.resolve(e):Promise.resolve(e.filter(function(e){return e.executed>=0}))},Eden.Selectors.NameNode.prototype.append=Eden.Selectors.PropertyNode.prototype.append,Eden.Selectors.NameNode.prototype.prepend=Eden.Selectors.PropertyNode.prototype.prepend,Eden.Selectors.TagNode=function(e){this.type="tag",this.tag=e,this.options=void 0,this.isreg=-1!=e.indexOf("*"),this.local=!1},Eden.Selectors.TagNode.prototype.filter=function(e){return new Promise((t,n)=>{e?t(this._filter(e)):e=this.construct().then(e=>{t(e)})})},Eden.Selectors.TagNode.prototype._filter=function(e){var t=this;return e.filter(function(e){return e.doxyComment&&e.doxyComment.hasTag(t.tag)})},Eden.Selectors.TagNode.prototype.construct=function(){return new Promise((e,t)=>{if(this.isreg){var n=Eden.Selectors.makeRegex(this.tag);stats=Eden.Index.getByTagRegex(n)}else stats=Eden.Index.getByTag(this.tag);this.options&&this.options.history?e(stats):e(stats.filter(function(e){return e.executed>=0}))})},Eden.Selectors.TagNode.prototype.append=Eden.Selectors.PropertyNode.prototype.append,Eden.Selectors.TagNode.prototype.prepend=Eden.Selectors.PropertyNode.prototype.prepend,Eden.Selectors.IntersectionNode=function(e,t){this.type="intersection",this.children=[e,t],this.local=!1},Eden.Selectors.IntersectionNode.prototype.append=function(e){if(!e)return this;switch(e.local&&(this.local=!0),e.type){case"navigate":return e.prepend(this),e}return this.children.push(e),this},Eden.Selectors.IntersectionNode.prototype.prepend=function(e){return e?(e.local&&(this.local=!0),this.children.splice(0,0,e),this):this},Eden.Selectors.IntersectionNode.prototype._filter=function(e,t){let n=e;for(var r=0;r<this.children.length;++r)n=this.children[r]._filter(n,t);return n},Eden.Selectors.IntersectionNode.prototype.filter=function(e,t){return new Promise((n,r)=>{let i=(e,r)=>{e<this.children.length?this.children[e].filter(r,t).then(t=>{i(++e,t)}):n(r||[])};i(0,e)})},Eden.Selectors.IntersectionNode.prototype.construct=function(){},Eden.Selectors.UnionNode=function(){this.type="union",this.children=[void 0],this.local=!1},Eden.Selectors.UnionNode.prototype._filter=function(e,t){for(var n={},r=0;r<this.children.length;++r){let s=this.children[r]._filter(e,t);for(var i=0;i<s.length;i++)n[s[i].id]=s[i]}return Object.keys(n).map(function(e){return n[e]})},Eden.Selectors.UnionNode.prototype.filter=function(e,t){return new Promise((n,r)=>{var i={};let s=r=>{r<this.children.length?this.children[r].filter(e,t).then(e=>{for(var t=0;t<e.length;t++)i[e[t].id]=e[t];s(++r)}):n(Object.keys(i).map(function(e){return i[e]}))};s(0)})},Eden.Selectors.UnionNode.prototype.construct=function(){},Eden.Selectors.UnionNode.prototype.prepend=function(e){return e?(e.local&&(this.local=!0),void 0===this.children[0]?(this.children[0]=e,this):(this.children[0]=this.children[0].prepend(e),this)):this},Eden.Selectors.UnionNode.prototype.append=function(e){return e?(e.local&&(this.local=!0),this.children.push(e),this):this},Eden.Selectors.NavigateNode=function(e,t){this.type="navigate",this.left=void 0,this.right=void 0,this.direction=e,this.deep=t,this.local=!1},Eden.Selectors.NavigateNode.prototype.append=function(e){return e?(e.local&&(this.local=!0),"union"==e.type?(e.prepend(this),e):(this.right?this.right.append(e):this.right=e,this)):this},Eden.Selectors.NavigateNode.prototype.prepend=function(e){return e?(e.local&&(this.local=!0),this.left?this.left=this.left.prepend(e):this.left=e,this):this},Eden.Selectors.NavigateNode.prototype.filter=function(e,t){return new Promise((n,r)=>{if(">"==this.direction){e||void 0!==this.left||(this.right?this.right.filter(e,t).then(e=>{n(e.filter(function(e){return void 0!==e.parent}))}):n(Eden.Index.getAll().filter(function(e){return void 0!==e.parent})));let r=e=>{this.right?this.right.filter(e,t).then(e=>{n(e)}):n(e)};void 0===this.left?r(Eden.Selectors.getChildren(e,this.deep)):this.left.filter(e,t).then(e=>{r(Eden.Selectors.getChildren(e,this.deep))})}else if("<"==this.direction){if(!e&&void 0===this.left){if(this.right)return this.right.filter(e,t).then(e=>{n(e.filter(function(e){return"script"==e.type||"when"==e.type||"if"==e.type||"for"==e.type}))});n(Eden.Index.getAll().filter(function(e){return"script"==e.type||"when"==e.type||"if"==e.type||"for"==e.type}))}let r=e=>{if(this.deep){for(var r=[],i=0;i<e.length;i++)for(var s=e[i];s.parent;)"script"==s.parent.type&&s.parent.parent&&"script"!=s.parent.parent.type?"codeblock"==s.parent.parent.type?(s=s.parent.parent.parent,r.push(s)):(s=s.parent.parent,r.push(s)):"codeblock"==s.parent.type?(s=s.parent.parent,r.push(s)):(s=s.parent,r.push(s));this.right?this.right.filter(r,t).then(e=>{n(Eden.Selectors.unique(e))}):n(Eden.Selectors.unique(r))}else{for(r=[],i=0;i<e.length;i++)e[i].parent&&("script"==e[i].parent.type&&e[i].parent.parent&&"script"!=e[i].parent.parent.type?"codeblock"==e[i].parent.parent.type?r.push(e[i].parent.parent.parent):r.push(e[i].parent.parent):"codeblock"==e[i].parent.type?r.push(e[i].parent.parent):r.push(e[i].parent));this.right?this.right.filter(r,t).then(e=>{n(Eden.Selectors.unique(e))}):n(Eden.Selectors.unique(r))}};void 0===this.left?r(e.filter(function(e){return"script"==e.type||"when"==e.type||"if"==e.type||"for"==e.type})):this.left.filter(e,t).then(e=>{r(e)})}})},Eden.Selectors.NavigateNode.prototype._filter=function(e,t){if(">"==this.direction){if(!e&&void 0===this.left)return this.right?this.right._filter(e,t).filter(function(e){return void 0!==e.parent}):Eden.Index.getAll().filter(function(e){return void 0!==e.parent});let n=e=>this.right?this.right._filter(e,t):e;if(void 0===this.left)return n(Eden.Selectors.getChildren(e,this.deep));{let r=this.left._filter(e,t);return n(Eden.Selectors.getChildren(r,this.deep))}}if("<"==this.direction){if(!e&&void 0===this.left)return this.right?this.right._filter(e,t).filter(function(e){return"script"==e.type||"when"==e.type||"if"==e.type||"for"==e.type}):Eden.Index.getAll().filter(function(e){return"script"==e.type||"when"==e.type||"if"==e.type||"for"==e.type});let n=e=>{if(this.deep){for(var n=[],r=0;r<e.length;r++)for(var i=e[r];i.parent;)"script"==i.parent.type&&i.parent.parent&&"script"!=i.parent.parent.type?"codeblock"==i.parent.parent.type?(i=i.parent.parent.parent,n.push(i)):(i=i.parent.parent,n.push(i)):"codeblock"==i.parent.type?(i=i.parent.parent,n.push(i)):(i=i.parent,n.push(i));return this.right?Eden.Selectors.unique(this.right._filter(n,t)):Eden.Selectors.unique(n)}for(n=[],r=0;r<e.length;r++)e[r].parent&&("script"==e[r].parent.type&&e[r].parent.parent&&"script"!=e[r].parent.parent.type?"codeblock"==e[r].parent.parent.type?n.push(e[r].parent.parent.parent):n.push(e[r].parent.parent):"codeblock"==e[r].parent.type?n.push(e[r].parent.parent):n.push(e[r].parent));return this.right?Eden.Selectors.unique(this.right._filter(n,t)):Eden.Selectors.unique(n)};return void 0===this.left?n(e.filter(function(e){return"script"==e.type||"when"==e.type||"if"==e.type||"for"==e.type})):n(this.left._filter(e,t))}},Eden.Selectors.NavigateNode.prototype.construct=function(){return new Promise((e,t)=>{e([])})},Eden.SyntaxWarning=function(e,t,n,r){this.type="syntax",this.context=e,this.node=t,this.warnno=n,this.extra=r,this.token=e.token,this.prevtoken=e.previous,this.line=e.stream.prevline,this.position=e.stream.position,this.prevposition=e.stream.prevposition},Eden.SyntaxWarning.UNKNOWN=0,Eden.SyntaxWarning.DEPRECATED=1,Eden.SyntaxWarning.NESTEDWHEN=2,Eden.SyntaxWarning.DEFINWHEN=3,Eden.SyntaxWarning.EXPRESSIONLIT=4,Eden.SyntaxWarning.MISSINGSYNC=5,Eden.SyntaxWarning.NESTEDSCOPE=6,Eden.SyntaxWarning.USEOFWHILE=7,Eden.SyntaxWarning.prototype.messageText=function(){var e;switch(this.warnno){case Eden.SyntaxWarning.DEPRECATED:e="Deprecation: ";break;case Eden.SyntaxWarning.NESTEDWHEN:e='"when"\'s should not be nested';break;case Eden.SyntaxWarning.DEFINWHEN:e='"when"\'s should not contain definitions';break;case Eden.SyntaxWarning.EXPRESSIONLIT:e="Keep literals in separate observables";break;case Eden.SyntaxWarning.USEOFWHILE:e="Try and use 'for', 'when' or 'with' to achieve looping";break;default:e="Warning: "}return e+=this.extra},Eden.RuntimeWarning=function(e,t,n){this.type="runtime",this.node=e,this.warnno=t,this.extra=n,this.line=-1},Eden.RuntimeWarning.UNKNOWN=0,Eden.RuntimeWarning.EMPTYDO=1,Eden.RuntimeWarning.UNDEFINED=2,Eden.RuntimeWarning.AMBIGUITY=3,Eden.RuntimeWarning.prototype.messageText=function(){var e;switch(this.warnno){case Eden.RuntimeWarning.EMPTYDO:e="Empty result for: ";break;case Eden.RuntimeWarning.UNDEFINED:e="Expression is undefined: ";break;default:e="Warning: "}return void 0!==this.extra&&(e+=this.extra),e},Eden.TypeWarning=function(e,t,n){this.type="type",this.node=e,this.expected=t,this.got=n},Eden.TypeWarning.prototype.messageText=function(){function e(e){switch(e){case Eden.AST.TYPE_BOOLEAN:return"boolean";case Eden.AST.TYPE_STRING:return"string";case Eden.AST.TYPE_LIST:return"list";case Eden.AST.TYPE_OBJECT:return"object";case Eden.AST.TYPE_NUMBER:return"number";default:return"unknown"}}return this.got&&this.expected?`Expected type '${e(this.expected)}' but got '${e(this.got)}'`:this.expected?`Expected type '${e(this.expected)}'`:this.got?`Got unexpected type '${e(this.got)}'`:"Type mismatch"},Eden.Index={},Eden.Index.id_index={},Eden.Index.name_index={},Eden.Index.tag_index={},Eden.Index.type_index={},Eden.Index.idExists=function(e){return Eden.Index.id_index.hasOwnProperty(e)},Eden.Index.getByID=function(e){var t=Eden.Index.id_index[e];return t||[]},Eden.Index.getAll=function(){var e=[];return Object.values?e.concat.apply(e,Object.values(Eden.Index.id_index)):e.concat.apply(e,Object.keys(Eden.Index.id_index).map(function(e){return Eden.Index.id_index[e]}))},Eden.Index.getAllWithName=function(){var e=[];for(var t in Eden.Index.name_index)e.push.apply(e,Eden.Index.name_index[t].map(function(e){return Eden.Index.id_index[e]}));return e},Eden.Index.getByName=function(e){var t=[];return Eden.Index.name_index[e]?t.concat.apply(t,Eden.Index.name_index[e].map(function(e){return Eden.Index.id_index[e]})):t},Eden.Index.getByNameRegex=function(e){var t=[];for(var n in Eden.Index.name_index)e.test(n)&&(t=t.concat.apply(t,Eden.Index.name_index[n].map(function(e){return Eden.Index.id_index[e]})));return t},Eden.Index.getByType=function(e){var t=[];return Eden.Index.type_index[e]?t.concat.apply(t,Object.keys(Eden.Index.type_index[e]).map(function(e){return Eden.Index.id_index[e]})):t},Eden.Index.getByTag=function(e){var t=[];return Eden.Index.tag_index[e]?t.concat.apply(t,Eden.Index.tag_index[e].map(function(e){return Eden.Index.id_index[e]})):t},Eden.Index.getByTagRegex=function(e){var t=[];for(var n in Eden.Index.tag_index)e.test(n)&&(t=t.concat.apply(t,Eden.Index.tag_index[n].map(function(e){return Eden.Index.id_index[e]})));return t},Eden.Index.remove=function(e){var t=Eden.Index.id_index[e.id];if(t){for(var n=0;n<t.length;n++)t[n]===e&&t.splice(n,1);if(0==t.length){if(delete Eden.Index.id_index[e.id],delete Eden.Index.type_index[e.type][e.id],e.name&&"do"!=e.type||e.lvalue){var r=e.name?e.name:e.lvalue.name;if(void 0===Eden.Index.name_index[r])return;(s=Eden.Index.name_index[r].indexOf(e.id))>=0&&Eden.Index.name_index[r].splice(s,1)}if(e.tags){var i=e.tags;for(n=0;n<i.length;n++){var s;if(void 0!==Eden.Index.tag_index[i[n]])(s=Eden.Index.tag_index[i[n]].indexOf(e.id))>=0&&Eden.Index.tag_index[i[n]].splice(s,1)}}}}},Eden.Index.update=function(e){if(void 0===Eden.Index.id_index[e.id]&&(Eden.Index.id_index[e.id]=[]),Eden.Index.id_index[e.id].push(e),1==Eden.Index.id_index[e.id].length){if(void 0===Eden.Index.type_index[e.type]&&(Eden.Index.type_index[e.type]={}),Eden.Index.type_index[e.type][e.id]=!0,e.name&&"do"!=e.type||e.lvalue){var t=e.name?e.name:e.lvalue.name;void 0===Eden.Index.name_index[t]&&(Eden.Index.name_index[t]=[]),-1==Eden.Index.name_index[t].indexOf(e.id)&&Eden.Index.name_index[t].push(e.id)}if(e.tags)for(var n=e.tags,r=0;r<n.length;r++)void 0===Eden.Index.tag_index[n[r]]&&(Eden.Index.tag_index[n[r]]=[]),-1==Eden.Index.tag_index[n[r]].indexOf(e.id)&&Eden.Index.tag_index[n[r]].push(e.id)}},Eden.AST=function(e,t,n,r){if(this.stream=void 0!==e?new Eden.EdenStream(e):void 0,this.data=new Eden.EdenSyntaxData,this.token="INVALID",this.previous="INVALID",this.src="input",this.parent=void 0,this.scripts={},this.definitions={},this.origin=n,this.lastposition=0,this.lastline=0,this.errors=[],this.warnings=[],this.whens=[],this.options=r,this.lastresult=void 0,this.depth=0,this.localStatus=!1,this.last_error=null,n||console.error("NO ORIGIN",e),this.lastDoxyComment=[],this.mainDoxyComment=void 0,this.parentDoxy=void 0,this.lastStatement=void 0,this.lastStatementEndline=-1,this.stream&&(this.stream.data=this.data),this.stamp=Date.now(),this.strict=r&&r.strict,this.version=Eden.AST.version,r&&void 0!==r.version&&(this.version=r.version),!r||!r.noparse){for(this.next();"STRING"==this.token;)"use cs2;"==this.data.value&&(this.version=Eden.AST.VERSION_CS2),this.next();this.script=this.pSCRIPT(),this.script.base=this,this.script.name=n.name,n.id&&(this.script.id=n.id),this.script.setSource(0,e.length,e),this.script.setDoxyComment(this.doxyFromOrigin()),this.options&&this.options.noindex?0==this.script.id&&this.script.buildID():this.script.addIndex(),0==this.errors.length?this.errors=this.script.errors:this.errors.push.apply(this.errors,this.script.errors)}},Eden.AST.TYPE_UNKNOWN=0,Eden.AST.TYPE_NUMBER=1,Eden.AST.TYPE_STRING=2,Eden.AST.TYPE_LIST=3,Eden.AST.TYPE_BOOLEAN=4,Eden.AST.TYPE_SYMBOL=5,Eden.AST.TYPE_OBJECT=6,Eden.AST.TYPE_PROMISE=7,Eden.AST.TYPE_AST=8,Eden.AST.VERSION_CS2=0,Eden.AST.VERSION_CS3=1,Eden.AST.version=1,Eden.AST.fnEdenASTerror=function(e){this.errors.unshift(e)},Eden.AST.fnEdenASTleft=function(e){this.l=e,this.mergeExpr(e)},Eden.AST.transpileExpressionNode=function(e,t,n){n&&(n.dependencies||(n.dependencies={}));var r={dependencies:n?n.dependencies:{},vars:Object.create(null),isconstant:!0,scopes:[],locals:n?n.locals:void 0},i={symbol:n.symbol,bound:!1,scope:t,indef:n.statement&&"definition"===n.statement.type};t||console.warn("Missing scope in transpile",e);var s="",o=e.generate(r,"scope",i),a={};for(var d in r.vars){var c=r.vars[d];a.hasOwnProperty(c)||(a[c]=""),a[c]+="\tlet v_"+d+" = "+c+'.l("'+removeHash(d)+'");\n'}if(a.hasOwnProperty("scope")&&(s+=a.scope),r.scopes.length>0){s+="\tvar _scopes = [];\n";for(var h=0;h<r.scopes.length;h++)s+="\t_scopes.push("+r.scopes[h],s+=");\n",s+="\tif (cache && cache.scopes && "+h+" < cache.scopes.length) { _scopes["+h+"].mergeCache(cache.scopes["+h+"]); _scopes["+h+"].reset(); } else _scopes["+h+"].rebuild();\n",a.hasOwnProperty("_scopes["+h+"]")&&(s+=a["_scopes["+h+"]"]);s+="if (cache) cache.scopes = _scopes;\n"}return"async"==e.type?(s+="\tvar _r = rt.flattenPromise("+o+");\n",s+="\treturn _r;"):s+="\treturn "+o+";",n.isconstant=r.isconstant&&n.isconstant,s},Eden.AST.executeExpressionNode=function(e,t,n){var r=Eden.AST.transpileExpressionNode(e,t,n);try{var i=new Function(["context","scope","cache"],r);return n.symbol?i.call(n.symbol,t.context,t,t.lookup(n.symbol.name)):i(t.context,t,null)}catch(r){return err=new Eden.RuntimeError(t.context,Eden.RuntimeError.UNKNOWN,n.statement?n.statement:e,"Expression evaluation failed: "+e.toEdenString(t,n)),n.statement?(err.line=n.statement.line,n.statement.errors.push(err)):e.errors.push(err),void t.context.instance.emit("error",[{name:n.symbol?n.symbol.name:"Inline"},err])}},Eden.AST.debug=!1,Eden.AST.debugstep=!1,Eden.AST.debugstep_cb=void 0,Eden.AST.debugspeed=500,Eden.AST.debugbreakpoint=void 0,Eden.AST.debugbreakpoint_cb=void 0,Eden.AST.debug_begin_cb=void 0,Eden.AST.debug_end_cb=void 0,Eden.AST.fromNode=function(e,t){return new Promise((n,r)=>{var i=new Eden.AST(e.getInnerSource(),void 0,t,{noindex:!0,noparse:!0});i.script=e,i.errors=e.errors,Eden.Selectors.queryWithin([e],">>.type(when)",null,e=>{i.whens=e,n(i)})})},Eden.AST.prototype.doxyFromOrigin=function(){var e=this.origin.name;if(this.origin.title&&(e+="\n * @title "+this.origin.title),this.origin.author&&(e+="\n * @author "+this.origin.author),this.origin.id&&(e+="\n * @id "+this.origin.id),this.origin.saveID&&(e+="\n * @version "+this.origin.vid),this.origin.tags&&this.origin.tags.length>0){e+="\n *";for(var t=0;t<this.origin.tags.length;t++)e+=" #"+this.origin.tags[t]}return new Eden.AST.DoxyComment(e)},Eden.AST.originFromDoxy=function(e){var t={};if(void 0===e)return t;var n=e.getControls();return n["@title"]&&(t.title=n["@title"][0]),n["@author"]&&(t.author=n["@author"][0]),n["@id"]&&(t.id=n["@id"][0]),n["@version"]&&(t.vid=n["@version"][0]),t},Eden.AST.prototype.destroy=function(){for(var e=Eden.Selectors.queryWithin([this.script],">>"),t=0;t<e.length;t++)Eden.Index.remove(e[t]);this.script=void 0,this.stream=void 0,this.lines=void 0,this.scripts=void 0;for(t=0;t<this.whens.length;t++)this.whens[t].enabled&&eden.project.removeAgent(this.whens[t])},Eden.AST.prototype.getActionByName=function(e){var t;if(-1==e.indexOf("/")&&void 0===(t=this.scripts[e]))for(var n=0;n<this.imports.length;n++)if(this.imports[n]&&this.imports[n].ast&&(t=this.imports[n].ast.getActionByName(e)))return t;return t},Eden.AST.prototype.generate=function(){return this.script.generate()},Eden.AST.prototype.execute=function(e,t,n){this.executeStatement(this.script,t,e,n)},Eden.AST.prototype.clearExecutedState=function(){for(var e=0;e<this.lines.length;e++)this.lines[e]&&this.lines[e].executed>0&&(this.lines[e].executed=0)},Eden.AST.prototype.executeLine=function(e,t,n){var r,i=e;void 0!==(r=-1==e?this.script:this.lines[i])&&(r=this.getBase(r),this.executeStatement(r,i,t,n))},Eden.AST.prototype.syntaxError=function(e,t,n){var r=new Eden.SyntaxError(this,t,n);e.errors.push(r)},Eden.AST.prototype.typeWarning=function(e,t){var n=new Eden.TypeWarning(e,t);e.warning=n},Eden.AST.prototype.syntaxWarning=function(e,t,n){e.warning=new Eden.SyntaxWarning(this,e,t,n)},Eden.AST.prototype.deprecated=function(e,t){e.warning=new Eden.SyntaxWarning(this,e,Eden.SyntaxWarning.DEPRECATED,t)},Eden.AST.typeCheck=function(e,t){var n=typeof t;switch(e){case 0:return!0;case Eden.AST.TYPE_BOOLEAN:return"boolean"==n;case Eden.AST.TYPE_STRING:return"string"==n;case Eden.AST.TYPE_NUMBER:return"number"==n;case Eden.AST.TYPE_OBJECT:return"object"==n;case Eden.AST.TYPE_LIST:return Array.isArray(t);default:return!0}},Eden.AST.parseStatement=function(e,t){var n=new Eden.AST(e,void 0,t||{},{noparse:!0,noindex:!0});n.next();var r=n.pSTATEMENT();void 0===r&&(r=new Eden.AST.DummyStatement,console.error("Invalid statement: ",e),n.syntaxError(r,Eden.SyntaxError.UNKNOWN)),"EOF"!=n.token&&n.syntaxError(r,Eden.SyntaxError.UNKNOWN),r.base=n,r.setSource(0,e.length,e),r.stamp=n.stamp;var i=r.prefix?(r.prefix+r.postfix).match("\n"):e.match("\n");return r.numlines=null===i?0:i.length,r},Eden.AST.parseScript=function(e,t){if("string"!=typeof e||0==e.length)return null;var n=new Eden.AST(e,void 0,t||{},{noparse:!0,noindex:!0});n.next();var r=n.pSCRIPT();r.base=n,r.setSource(0,e.length,e),r.stamp=n.stamp;var i=e.match("\n");return r.numlines=null===i?0:i.length,r},Eden.AST.parseExpression=function(e){var t=new Eden.AST(e,void 0,{},{noparse:!0,noindex:!0});t.next();var n=t.pEXPRESSION();return"EOF"!=t.token&&t.syntaxError(n,Eden.SyntaxError.UNKNOWN),n},Eden.AST.parseRule=function(e,t,n){var r=new Eden.AST(t,void 0,{},{noparse:!0,noindex:!0});r.next();var i=n?r[e].apply(r,n):r[e]();return"EOF"!=r.token&&r.syntaxError(i,Eden.SyntaxError.UNKNOWN),i},Eden.AST.registerExpression=function(e){e.prototype.execute=Eden.AST.BaseExpression.execute,e.prototype.mergeExpr=Eden.AST.BaseExpression.mergeExpr,e.prototype.error=Eden.AST.fnEdenASTerror,e.prototype.toString=Eden.AST.BaseExpression.toString,e.prototype.getEdenCode=Eden.AST.BaseExpression.getEdenCode},Eden.AST.registerStatement=function(e){e.prototype.getOrigin=Eden.AST.BaseStatement.getOrigin,e.prototype.hasErrors=Eden.AST.BaseStatement.hasErrors,e.prototype.setSource=Eden.AST.BaseStatement.setSource,e.prototype.getSource=Eden.AST.BaseStatement.getSource,e.prototype.getOuterSource=Eden.AST.BaseStatement.getOuterSource,e.prototype.getNumberOfLines=Eden.AST.BaseStatement.getNumberOfLines,e.prototype.getStartLine=Eden.AST.BaseStatement.getStartLine,e.prototype.getEndLine=Eden.AST.BaseStatement.getEndLine,e.prototype.getRange=Eden.AST.BaseStatement.getRange,e.prototype.error=Eden.AST.fnEdenASTerror,e.prototype.addIndex=Eden.AST.BaseStatement.addIndex,e.prototype.removeIndex=Eden.AST.BaseStatement.removeIndex,e.prototype.destroy=Eden.AST.BaseStatement.destroy,e.prototype.buildID=Eden.AST.BaseStatement.buildID,e.prototype.setDoxyComment=Eden.AST.BaseStatement.setDoxyComment,e.prototype.addSubscriber=Eden.AST.BaseStatement.addSubscriber,e.prototype.removeSubscriber=Eden.AST.BaseStatement.removeSubscriber,e.prototype.getEdenCode=Eden.AST.BaseStatement.getEdenCode},Eden.AST.registerScript=function(e){Eden.AST.registerStatement(e),e.prototype.getStatementByLine=Eden.AST.BaseScript.getStatementByLine,e.prototype.getRelativeLine=Eden.AST.BaseScript.getRelativeLine,e.prototype.getNumberOfLines=Eden.AST.BaseScript.getNumberOfLines,e.prototype.getNumberOfInnerLines=Eden.AST.BaseScript.getNumberOfInnerLines,e.prototype.append=Eden.AST.BaseScript.append,e.prototype.appendChild=Eden.AST.BaseScript.appendChild,e.prototype.removeChild=Eden.AST.BaseScript.removeChild,e.prototype.insertBefore=Eden.AST.BaseScript.insertBefore,e.prototype.insertAfter=Eden.AST.BaseScript.insertAfter,e.prototype.replaceChild=Eden.AST.BaseScript.replaceChild,e.prototype.addIndex=Eden.AST.BaseScript.addIndex,e.prototype.addIndexReverse=Eden.AST.BaseScript.addIndexReverse,e.prototype.removeIndex=Eden.AST.BaseScript.removeIndex,e.prototype.destroy=Eden.AST.BaseScript.destroy,e.prototype.buildID=Eden.AST.BaseScript.buildID},Eden.AST.registerContext=function(e){Eden.AST.registerScript(e)},Eden.AST.prototype.getBase=function(e,t){void 0===t&&console.error("Undefined context in getBase");for(var n=e;n&&n.parent&&n.parent!==t;)n=n.parent;return n},Eden.AST.prototype.getBlockLines=function(e,t){for(var n=e,r=this.getBase(this.lines[n],t);n>0&&this.lines[n-1]&&this.getBase(this.lines[n-1],t)==r;)n--;for(var i=n;n<this.lines.length-1&&this.lines[n+1]&&(this.lines[n+1]===r||this.lines[n+1].parent!==t);)n++;return[i,n]},Eden.AST.prototype.getSource=function(e){return this.script.getSource()},Eden.AST.prototype.getRoot=function(){return this.script},Eden.AST.prototype.getErrors=function(){return this.script.errors},Eden.AST.prototype.hasErrors=function(){return this.script.errors.length>0},Eden.AST.prototype.prettyPrint=function(){var e="";if(this.script.errors.length>0)for(var t=0;t<this.script.errors.length;t++)e=e+this.script.errors[t].prettyPrint()+"\n\n";else e=JSON.stringify(this.script,function(e,t){if("errors"!=e)return"parent"==e?!!t||void 0:t},"    ");return e},Eden.AST.prototype.next=function(){this.previous=this.token,this.lastposition=this.stream.position,this.lastline=this.stream.line,this.token=this.stream.readToken();for(var e=this.stream.prevline;;)if("/*"===this.token){var t=1,n=!1,r=this.stream.position-2,i=this.stream.line;for(42==this.stream.peek()&&(n=!0);this.stream.valid()&&("*/"!==this.token||t>0);)this.token=this.stream.readCommentToken(),"/*"===this.token?t++:"*/"===this.token&&t--;if("*/"!==this.token){var s=new Eden.SyntaxError(this,Eden.SyntaxError.BLOCKCOMMENT);s.line=i,this.errors.push(s)}if(n){var o=new Eden.AST.DoxyComment(this.stream.code.substring(r+3,this.stream.position-2).trim(),i,this.stream.line);this.lastDoxyComment.push(o),o.parent=this.parentDoxy,o.content.endsWith("@{")?this.parentDoxy=o:o.content.startsWith("@}")&&this.parentDoxy&&(this.parentDoxy=this.parentDoxy.parent)}this.token=this.stream.readToken()}else{if("${{"!==this.token)break;r=this.stream.position,i=this.stream.line;for(this.data.line=i;this.stream.valid()&&"}}$"!==this.token;)this.token=this.stream.readJSToken();this.data.value=this.stream.code.substring(r,this.stream.position-3),this.token="JAVASCRIPT",this.stream.prevposition=r-3}this.stream.prevline=e},Eden.AST.prototype.peekNext=function(e){var t;for(this.stream.data={value:""},this.stream.pushPosition();e>0;)t=this.stream.readToken(),e--;return this.stream.popPosition(),this.stream.data=this.data,t},"undefined"!=typeof require&&"undefined"!=typeof exports&&(require("./basestatement"),require("./baseexpression"),require("./basescript"),require("./basecontext"),require("./after"),require("./alias"),require("./append"),require("./assignment"),require("./async"),require("./binaryop"),require("./break"),require("./case"),require("./codeblock"),require("./context"),require("./continue"),require("./cs3_html"),require("./customblock"),require("./declarations"),require("./default"),require("./definition"),require("./delete"),require("./do"),require("./doxycomments"),require("./dummy"),require("./for"),require("./function"),require("./functioncall"),require("./handle"),require("./if"),require("./import"),require("./index"),require("./indexed"),require("./insert"),require("./length"),require("./literal"),require("./llist"),require("./local"),require("./lvalue"),require("./modify"),require("./parameter"),require("./primary"),require("./proc"),require("./querystat"),require("./range"),require("./return"),require("./scope"),require("./scopedscript"),require("./scopepath"),require("./scopepattern"),require("./script"),require("./scriptexpr"),require("./section"),require("./shift"),require("./subscribers"),require("./substatement"),require("./switch"),require("./ternaryop"),require("./unaryop"),require("./virtual"),require("./wait"),require("./when"),require("./while"),require("../grammar/template"),require("../grammar/actionbody"),require("../grammar/after"),require("../grammar/attributes"),require("../grammar/cs3_html"),require("../grammar/declarations"),require("../grammar/do"),require("../grammar/expression"),require("../grammar/factor"),require("../grammar/for"),require("../grammar/function"),require("../grammar/if"),require("../grammar/import"),require("../grammar/listops"),require("../grammar/lists"),require("../grammar/lvalue"),require("../grammar/primary"),require("../grammar/proc"),require("../grammar/query"),require("../grammar/scope"),require("../grammar/script"),require("../grammar/section"),require("../grammar/selector"),require("../grammar/statement"),require("../grammar/switch"),require("../grammar/terms"),require("../grammar/wait"),require("../grammar/when"),require("../grammar/while")),Eden.AST.BaseStatement=function(){this.start=0,this.end=0,this.parent=void 0,this.errors=[],this.warning=void 0,this.executed=0,this.numlines=-1,this.doxyComment=void 0,this.lock=0,this.source=void 0,this.id=0,this.stamp=0,this.nextSibling=void 0,this.previousSibling=void 0,this.tags=void 0,this.local=!1,this.subscribers=null,this.line=-1,this.generated=null,this.dependencies=Object.create(null)},Eden.AST.BaseStatement.addSubscriber=function(e){this.subscribers||(this.subscribers={}),this.subscribers[e]=eden.root.lookup(e)},Eden.AST.BaseStatement.removeSubscriber=function(e){delete this.subscribers[e]},Eden.AST.BaseStatement.setDoxyComment=function(e){this.doxyComment=e,e&&(void 0===this.tags?this.tags=e.getHashTags():this.tags=this.tags.concat(e.getHashTags()),e.hasTag("#library")&&("function"===this.type||"action"===this.type?Eden.edenFunctions[this.name]=!0:"definition"!==this.type&&"assignment"!==this.type||(Eden.edenFunctions[this.lvalue.name]=!0)))},Eden.AST.BaseStatement.buildID=function(){var e=0,t=this.source;this.doxyComment&&(t=this.doxyComment.content+t);for(var n=t.length,r=0;r<n;r++)e=(e<<5)-e+t.charCodeAt(r),e&=e;this.name&&"do"!=this.type?this.id=this.name+"@"+e:this.lvalue?this.id=this.lvalue.name+"@"+e:this.id=this.type+"@"+e;for(var i=this.parent;i&&!i.name;)i=i.parent;i&&i.name&&(this.id=this.id+i.name)},Eden.AST.BaseStatement.addIndex=function(){if("dummy"==this.type&&console.trace("ADDING DUMMY INDEX"),this.buildID(),this.statements)for(var e=0;e<this.statements.length;e++)"dummy"!=this.statements[e].type&&this.statements[e].addIndex();Eden.Index.update(this)},Eden.AST.BaseStatement.removeIndex=function(){if(this.statements)for(var e=0;e<this.statements.length;e++)"dummy"!=this.statements[e].type&&this.statements[e].removeIndex();Eden.Index.remove(this)},Eden.AST.BaseStatement.destroy=function(){if(this.executed<1&&Eden.Index.remove(this),this.parent=void 0,this.nextSibling=void 0,this.previousSibling=void 0,this.statements)for(var e=0;e<this.statements.length;e++)"dummy"!=this.statements[e].type&&this.statements[e].destroy();this.executed=-1},Eden.AST.BaseStatement.hasErrors=function(){return this.errors.length>0},Eden.AST.BaseStatement.getNumberOfLines=function(){return this.numlines},Eden.AST.BaseStatement.getNumberOfInnerLines=function(){return this.numlines},Eden.AST.BaseStatement.getStartLine=function(e){return this.parent?this.parent.getRelativeLine(this,e):-1},Eden.AST.BaseStatement.getEndLine=function(e){return this.getStartLine(e)+this.getNumberOfLines()},Eden.AST.BaseStatement.getRange=function(e){var t=this.getStartLine(e);return[t,t+this.getNumberOfLines()]},Eden.AST.BaseStatement.setSource=function(e,t,n){this.start=e,this.end=t,this.source=n},Eden.AST.BaseStatement.getSource=function(){return this.source},Eden.AST.BaseStatement.getOuterSource=function(){var e=this.getSource();void 0===this.parent&&(e="action "+this.name+"{"+e+"}"),this.doxyComment&&(e="/** "+this.doxyComment.content+" */\n"+e);for(var t=this.parent;t;)"script"==t.type?(e=t.name?"action "+t.name+" {\n"+e+"\n}":"{\n"+e+"\n}",t.doxyComment&&(e="/** "+t.doxyComment.content+" */\n"+e),t=t.parent):t=void 0;return e},Eden.AST.BaseStatement.getOrigin=function(){for(var e=this;e.parent;)e=e.parent;return e.base?e.base.origin:void 0},Eden.AST.BaseStatement.getEdenCode=function(){return'parse("'+this.getSource()+'")'},Eden.AST.BaseScript=function(){Eden.AST.BaseStatement.apply(this),this.statements=[],this.parameters=void 0,this.locals=void 0,this.indexed=!1},Eden.AST.BaseScript.appendChild=function(e){this.statements.push(e),this.statements.length>1&&(e.previousSibling=this.statements[this.statements.length-2],this.statements[this.statements.length-2].nextSibling=e),e.parent=this,this.indexed&&0!=this.id&&console.log("INVALIDATE ID",this),"dummy"!=e.type&&this.indexed&&e.addIndex(),e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.BaseScript.append=Eden.AST.BaseScript.appendChild,Eden.AST.BaseScript.insertAfter=function(e,t){var n;for(n=0;n<this.statements.length&&this.statements[n]!==e;n++);if(n+1<this.statements.length)t.previousSibling=this.statements[n],t.nextSibling=this.statements[n+1],this.statements[n].nextSibling=t,this.statements[n+1].previousSibling=t,this.statements.splice(n+1,0,t);else{if(!(n<this.statements.length))return;t.previousSibling=this.statements[n],t.nextSibling=void 0,this.statements[n].nextSibling=t,this.statements.push(t)}t.parent=this,"dummy"!=t.type&&this.indexed&&t.addIndex(),t.errors.length>0&&this.errors.push.apply(this.errors,t.errors),this.indexed&&0!=this.id&&console.log("INVALIDATE ID",this)},Eden.AST.BaseScript.insertBefore=function(e,t){var n;for(n=0;n<this.statements.length&&this.statements[n]!==e;n++);n<this.statements.length?(n>0?(t.nextSibling=this.statements[n],t.previousSibling=this.statements[n-1],this.statements[n].previousSibling=t,this.statements[n-1].nextSibling=t):(t.nextSibling=this.statements[n],this.statements[n].previousSibling=t),this.statements.splice(n,0,t),t.parent=this,"dummy"!=t.type&&this.indexed&&t.addIndex(),t.errors.length>0&&this.errors.push.apply(this.errors,t.errors)):eden.emit("error",[new Eden.RuntimeError(void 0,Eden.RuntimeError.NOCHILD,this,"Statement is not a child when using insertBefore")])},Eden.AST.BaseScript.removeChild=function(e){var t;for(t=0;t<this.statements.length&&this.statements[t]!==e;t++);t<this.statements.length?(this.statements.splice(t,1),e.nextSibling&&(e.nextSibling.previousSibling=e.previousSibling),e.previousSibling&&(e.previousSibling.nextSibling=e.nextSibling),e.destroy()):eden.emit("error",[new Eden.RuntimeError(void 0,Eden.RuntimeError.NOCHILD,this,"Statement is not a child when using removeChild")])},Eden.AST.BaseScript.replaceChild=function(e,t){var n;if("number"==typeof e)n=e;else{var r;for(r=0;r<this.statements.length&&this.statements[r]!==e;r++);if(r>=this.statements.length)return void eden.emit("error",[new Eden.RuntimeError(void 0,Eden.RuntimeError.NOCHILD,this,"Statement is not a child when using replaceChild")]);n=r}t.nextSibling=this.statements[n].nextSibling,t.nextSibling&&(t.nextSibling.previousSibling=t),t.previousSibling=this.statements[n].previousSibling,t.previousSibling&&(t.previousSibling.nextSibling=t),this.statements[n].destroy(),this.statements[n]=t,t.parent=this,"dummy"!=t.type&&this.indexed&&t.addIndex(),this.indexed&&0!=this.id&&console.log("INVALIDATE ID",this)},Eden.AST.BaseScript.destroy=function(){this.executed<1&&Eden.Index.remove(this);for(var e=0;e<this.statements.length;e++)this.statements[e].destroy();this.executed=-1,this.statements=void 0,this.base=void 0,this.parent=void 0,this.nextSibling=void 0,this.previousSibling=void 0},Eden.AST.BaseScript.addIndex=function(){if(!this.indexed){0==this.id&&this.buildID();for(var e=0;e<this.statements.length;e++)"dummy"!=this.statements[e].type&&this.statements[e].addIndex();this.indexed=!0,Eden.Index.update(this)}},Eden.AST.BaseScript.addIndexReverse=function(){this.indexed||(0==this.id&&this.buildID(),this.parent&&this.parent.addIndexReverse(),this.indexed=!0,Eden.Index.update(this))},Eden.AST.BaseScript.removeIndex=function(){if(this.indexed){for(var e=0;e<this.statements.length;e++)"dummy"!=this.statements[e].type&&this.statements[e].removeIndex();this.indexed=!1,Eden.Index.remove(this)}},Eden.AST.BaseScript.buildID=function(){for(var e=0,t=this.getSource(),n=t.length,r=0;r<n;r++)e=(e<<5)-e+t.charCodeAt(r),e&=e;this.id=this.type+"@"+e},Eden.AST.BaseScript.getStatementByLine=function(e,t){var n=0;if(t&&this.parent&&(n=this.parent.getRelativeLine(this,t)),!(n>e)&&void 0!==this.statements)for(var r=0;r<this.statements.length;r++){var i=this.statements[r].getNumberOfLines();if(e>=n&&e<=n+i&&"dummy"!=this.statements[r].type)return this.statements[r];n+=i}},Eden.AST.BaseScript.getRelativeLine=function(e,t){var n=0;t&&t!==this&&this.parent&&(n=this.parent.getRelativeLine(this,t));for(var r=0;r<this.statements.length;r++){if(this.statements[r]===e)return n;n+=this.statements[r].getNumberOfLines()}return-1},Eden.AST.BaseScript.getNumberOfLines=function(){void 0===this.statements&&console.error("No Statements",this);for(var e=this.numlines,t=0;t<this.statements.length;t++)e+=this.statements[t].getNumberOfLines();return e},Eden.AST.BaseScript.getNumberOfInnerLines=function(){void 0===this.statements&&console.error("No Statements",this);for(var e=0,t=0;t<this.statements.length;t++)e+=this.statements[t].getNumberOfLines();return e},Eden.AST.BaseContext=function(){Eden.AST.BaseScript.apply(this),this.scopes=[],this.locals=void 0,this.params=void 0,this.dependencies={},this.vars=Object.create(null)},Eden.AST.BaseExpression=function(){this.isconstant=!0,this.isdependant=!1,this.isdynamic=!1,this.typevalue=Eden.AST.TYPE_UNKNOWN,this._is_eden_expression=!0,this.isscoped=!1,this.errors=[],this.warning=null},Eden.AST.BaseExpression.mergeExpr=function(e){e&&(this.isconstant=this.isconstant&&e.isconstant,this.isdependant=this.isdependant||e.isdependant,this.isdynamic=this.isdynamic||e.isdynamic,this.isscoped=this.isscoped||e.isscoped,0===this.typevalue?this.typevalue=e.typevalue:0===e.typevalue||e.typevalue!==this.typevalue&&(this.typevalue=0),e.errors&&e.errors.length>0&&(this.errors||(this.errors=[]),this.errors.push.apply(this.errors,e.errors)),e.warning&&!this.warning&&(this.warning=e.warning))},Eden.AST.BaseExpression.execute=function(e,t,n){var r={isconstant:!0,locals:e.locals,symbol:e.symbol},i=Eden.AST.transpileExpressionNode(this,n,r);return new Function(["context","scope","cache"],i).call(r.symbol?r.symbol:null,n.context,n,r.symbol?n.lookup(r.symbol.name):null)},Eden.AST.BaseExpression.toString=function(){return"__error__"},Eden.AST.BaseExpression.getEdenCode=Eden.AST.BaseExpression.toString,Eden.AST.Append=function(){this.type="append",Eden.AST.BaseStatement.apply(this),this.destination=void 0,this.index=void 0},Eden.AST.Append.prototype.setDest=function(e){this.destination=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Append.prototype.setIndex=function(e){this.index=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Append.prototype.generate=function(e,t,n){var r=this.index.generate(e,t,n),i=this.destination.generate(e,t,n);return this.destination.islocal?i+".push("+r+");\n":t+".mutate("+i+", function(s) { scope.lookup(s.name).value.push("+r+"); }, this);"},Eden.AST.Append.prototype.execute=function(e,t,n,r){this.executed=1;var i=this.index.execute(e,t,n);i instanceof BoundValue&&(i=i.value);var s=n.context.lookup(this.destination.name),o=s.value(n);o.push(i),s.assign(o,n,this)},Eden.AST.registerStatement(Eden.AST.Append),Eden.AST.Shift=function(){this.type="shift",Eden.AST.BaseStatement.apply(this),this.destination=void 0},Eden.AST.Shift.prototype.setDest=function(e){this.destination=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Shift.prototype.generate=function(e,t){var n=this.destination.generate(e,t);return this.destination.islocal?n+".shift();\n":t+".mutate("+n+", function(s) { scope.lookup(s.name).value.shift(); }, this);"},Eden.AST.Shift.prototype.execute=function(e,t,n,r){this.executed=1;var i=eden.root.lookup(this.destination.name),s=i.value(n);s.shift(),i.assign(s,n,this)},Eden.AST.registerStatement(Eden.AST.Shift),Eden.AST.Assignment=function(e){this.type="assignment",Eden.AST.BaseStatement.apply(this),this.errors=e?e.errors:[],e&&e.warning&&(this.warning=e.warning),this.expression=e,this.lvalue=void 0,this.compiled=void 0,this.dirty=!1,this.value=void 0,this.isstatic=!1},Eden.AST.Assignment.prototype.setExpression=function(e){this.expression=e,e&&e.errors.length>0&&(this.errors=e.errors),e&&e.warning&&!this.warning&&(this.warning=e.warning)},Eden.AST.Assignment.prototype.reset=function(){this.executed=0,this.dirty=!0},Eden.AST.Assignment.prototype.left=function(e){this.lvalue=e,e&&e.errors.length>0&&this.errors.push.apply(this.errors,e.errors),!this.warning&&e.warning&&(this.warning=e.warning)},Eden.AST.Assignment.prototype.setAttributes=function(e){for(var t in e)return!1;return!0},Eden.AST.Assignment.prototype.generate=function(e,t,n){n||console.warn("Missing assignment generator options");var r=this.lvalue.generate(e,t,n);return this.lvalue.islocal?(r+=" = ",r+=this.expression.generate(e,t,n),r+=";\n"):this.lvalue.hasListIndices()?(r=t+".listAssign("+r+",",r+=this.expression.generate(e,t,n),r+=", EdenSymbol.localJSAgent, false, ",r+=this.lvalue.generateCompList(e,t),r+=");\n"):(r=t+".assign("+r+",",r+=this.expression.generate(e,t,n),r+=", EdenSymbol.localJSAgent);\n")},Eden.AST.Assignment.prototype.compile=function(e,t,n){this.dirty=!1;var r={statement:this,symbol:n,isconstant:!0,dependant:!1,locals:e.locals},i=Eden.AST.transpileExpressionNode(this.expression,t,r);this.compiled=new Function(["context","scope","cache"],i)},Eden.AST.Assignment.prototype.execute=function(e,t,n,r){if(void 0!==this.expression){this.executed=1,this.doxyComment&&n.context.instance.updateDictionary(this.lvalue.name,this.doxyComment);try{var i,s=this.lvalue.getSymbol(e,t,n);if(this.compile(e,n,s),this.lvalue.hasListIndices()){i=this.compiled.call(s,n.context,n,n.lookup(s.name));var o=this.lvalue.executeCompList(e,n);s.listAssign(i,n,this,!1,o)}else{if(i=this.compiled.call(s,n.context,n,n.lookup(s.name)),s.origin&&s.origin.lvalue){var a=s.origin.lvalue;a.isstatic&&(this.warning=new Eden.RuntimeWarning(this,Eden.RuntimeWarning.UNKNOWN,"Changing a [static] symbol"));var d=0!==this.lvalue.typevalue?this.lvalue.typevalue:a.typevalue;if(!Eden.AST.typeCheck(d,i))throw"Type Error"}s.assign(i,n,this)}void 0===i&&(this.warning=new Eden.RuntimeWarning(this,Eden.RuntimeWarning.UNDEFINED))}catch(e){var c;if(0===e)return;e instanceof Eden.RuntimeError?(c=e).statement=this:c=/[0-9][0-9]*/.test(e.message)?new Eden.RuntimeError(n.context,parseInt(e.message),this,e.message):new Eden.RuntimeError(n.context,0,this,e),c.line=this.line,this.errors.push(c),n.context.instance.emit("error",[r||{name:"Unknown"},c])}}},Eden.AST.registerStatement(Eden.AST.Assignment),Eden.AST.BinaryOp=function(e){switch(this.type="binaryop",Eden.AST.BaseExpression.apply(this),this.op=e,this.l=void 0,this.r=void 0,"&"==this.op||"and"==this.op?this.op="&&":"|"!=this.op&&"or"!=this.op||(this.op="||"),e){case">":case"<":case">=":case"<=":case"==":case"!=":this.typevalue=Eden.AST.TYPE_BOOLEAN;break;case"*":case"/":case"^":case"%":this.typevalue=Eden.AST.TYPE_NUMBER}},Eden.AST.BinaryOp.prototype.left=Eden.AST.fnEdenASTleft,Eden.AST.BinaryOp.prototype.setRight=function(e){this.r=e,this.mergeExpr(e)},Eden.AST.BinaryOp.prototype.toEdenString=function(e,t){return`(${this.l.toEdenString(e,t)} ${this.op} ${this.r.toEdenString(e,t)})`},Eden.AST.BinaryOp.prototype.generate=function(e,t,n){var r,i=n,s=this.l.generate(e,t,i),o=this.r.generate(e,t,i),a=0;a=this.l.typevalue===this.r.typevalue?this.l.typevalue:this.l.typevalue===Eden.AST.TYPE_STRING||this.r.typevalue===Eden.AST.TYPE_STRING?Eden.AST.TYPE_STRING:0===this.l.typevalue?this.r.typevalue:this.l.typevalue;a=this.l.typevalue===this.r.typevalue?this.l.typevalue:this.l.typevalue===Eden.AST.TYPE_UNKNOWN?this.r.typevalue:this.l.typevalue;switch(this.op){case"//":r="concat";break;case"+":r="add";break;case"-":r="subtract";break;case"/":r="divide";break;case"*":r="multiply";break;case"==":r="equal";break;case"!=":r="notequal";break;case"%":r="mod";break;case"^":r="pow";break;default:r="RAW"}var d=this.op;return a===Eden.AST.TYPE_NUMBER?this.l.typevalue===this.r.typevalue?r="RAW":"+"==this.op?r="addA":"-"==this.op?r="subtractA":"=="==this.op?r="RAW":"!="==this.op&&(r="RAW"):a===Eden.AST.TYPE_STRING&&("//"==this.op?this.l.typevalue===this.r.typevalue?(r="RAW",d=" + "):r="concatS":"=="==this.op?r="RAW":"!="==this.op&&(r="RAW")),"RAW"!=r?"rt."+r+"(("+s+"),("+o+"))":"("+s+") "+d+" ("+o+")"},Eden.AST.registerExpression(Eden.AST.BinaryOp),Eden.AST.Break=function(){this.type="break",Eden.AST.BaseStatement.apply(this)},Eden.AST.Break.prototype.generate=function(e,t){return"break; "},Eden.AST.Break.prototype.execute=function(e,t,n,r){var i=new Eden.RuntimeError(n.context,Eden.RuntimeError.NOTSUPPORTED,this,"Break not supported here");i.line=this.line,this.errors.push(i),Eden.Agent.emit("error",[r,i])},Eden.AST.registerStatement(Eden.AST.Break),Eden.AST.Case=function(){this.type="case",Eden.AST.BaseStatement.apply(this),this.datatype="",this.literal=void 0},Eden.AST.Case.prototype.setLiteral=function(e,t){this.datatype=e,this.literal=t},Eden.AST.Case.prototype.generate=function(e,t){return"string"==typeof this.literal?'case "'+this.literal+'": ':"case "+this.literal+": "},Eden.AST.Case.prototype.execute=function(e,t,n,r){var i=new Eden.RuntimeError(n.context,Eden.RuntimeError.NOTSUPPORTED,this,"Case not supported here");i.line=this.line,this.errors.push(i),Eden.Agent.emit("error",[r,i])},Eden.AST.registerStatement(Eden.AST.Case),Eden.AST.Context=function(e){this.symbols={},this.parent=e},Eden.AST.Context.prototype.lookup=function(e){return console.log("LOOKUP CONTEXT",e),this.symbols[e]?this.symbols[e]:(this.symbols[e]=new Eden.AST.Handle(e),this.symbols[e])},Eden.AST.Continue=function(){this.type="continue",Eden.AST.BaseStatement.apply(this)},Eden.AST.Continue.prototype.generate=function(e,t){return"continue; "},Eden.AST.Continue.prototype.execute=function(e,t,n,r){var i=new Eden.RuntimeError(n.context,Eden.RuntimeError.NOTSUPPORTED,this,"Continue not supported here");i.line=this.line,this.errors.push(i),Eden.Agent.emit("error",[r,i])},Eden.AST.registerStatement(Eden.AST.Continue),Eden.AST.Declarations=function(){this.type="declarations",Eden.AST.BaseStatement.apply(this),this.list=[],this.kind="local"},Eden.AST.Declarations.prototype.toEdenString=function(e,t){var n="local"==this.kind?"local ":"para ",r=!0;for(var i of this.list)r||(n+=", "),r=!1,n+=i;return n+";"},Eden.AST.Declarations.prototype.execute=function(e,t,n,r){if("local"==this.kind)for(var i=0;i<this.list.length;i++){var s=new Eden.AST.Local(this.list[i]);n.addIfNotExist(this.list[i],s),e.locals[this.list[i]]=s}else if("oracle"==this.kind)for(i=0;i<this.list.length;i++){s=new Eden.AST.Local(this.list[i]);n.addAlias(this.list[i],"$"+(i+1),s),e.locals[this.list[i]]=s}},Eden.AST.Declarations.prototype.generate=function(e,t,n){if("local"==this.kind){var r="var ";void 0===e.locals&&(e.locals={});for(var i=0;i<this.list.length;i++)e.locals[this.list[i]]="local",r+=this.list[i],i<this.list.length-1&&(r+=",");return r+=";\n"}if(this.kind="oracle"){r="";void 0===e.locals&&(e.locals={});for(i=0;i<this.list.length;i++)e.locals[this.list[i]]="oracle";return r}},Eden.AST.registerStatement(Eden.AST.Declarations),Eden.AST.Default=function(){this.type="default",Eden.AST.BaseStatement.apply(this)},Eden.AST.Default.prototype.generate=function(e,t){return"default: "},Eden.AST.Default.prototype.execute=function(e,t,n,r){var i=new Eden.RuntimeError(n.context,Eden.RuntimeError.NOTSUPPORTED,this,"Default not supported here");i.line=this.line,this.errors.push(i),Eden.Agent.emit("error",[r,i])},Eden.AST.registerStatement(Eden.AST.Default),Eden.AST.Definition=function(){this.type="definition",Eden.AST.BaseStatement.apply(this),this.expression=void 0,this.lvalue=void 0,this.eager=!1,this.volatile=!1,this.isstatic=!1},Eden.AST.Definition.prototype.reset=function(){this.executed=0},Eden.AST.Definition.prototype.setAttributes=function(e){for(var t in e)switch(t){case"eager":this.eager=!0;break;case"volatile":this.volatile=!0;break;case"static":this.isstatic=!0;break;case"async":break;case"number":case"boolean":case"object":case"undefined":case"string":case"list":break;default:return!1}return!0},Eden.AST.Definition.prototype.setExpression=function(e){e&&e.warning&&(this.warning=e.warning),this.expression=e,this.errors=e.errors},Eden.AST.Definition.prototype.left=function(e){this.lvalue=e,e&&e.errors.length>0&&this.errors.push.apply(this.errors,e.errors),!this.warning&&e.warning&&(this.warning=e.warning)},Eden.AST.Definition.prototype.locatePrimary=function(e){for(var t=this.expression,n=0;n<e.length;++n){var r=e[n];if("literal"!=t.type)return;if("LIST"==t.datatype){if(!(Array.isArray(t.value)&&r<t.value.length))return;t=t.value[r]}else{if("OBJECT"!=t.datatype)return;t=t.value[r]}}if(t&&"primary"==t.type&&!t.backtick&&0==t.extras.length)return t.observable},Eden.AST.Definition.prototype.generate=function(e,t,n){throw Eden.RuntimeError(n.scope.context,Eden.RuntimeError.NOTSUPPORTED,this,"Cannot generate defintions here")},Eden.AST.Definition.prototype.safeEval=function(__name,__code){return eval(`(function ${__name}(context,scope,cache){${__code}})`)},Eden.AST.Definition.prototype.execute=function(e,t,n,r){this.executed=1;var i,s=this.lvalue.getSymbol(e,t,n),o=this.lvalue&&this.lvalue.name?"def_"+this.lvalue.name:"";if(this.lvalue.isDynamic()||this.expression.isdependant){var a={isconstant:!0,locals:e.locals,statement:this,symbol:s},d=this.expression.toEdenString(n,a);d=a.isconstant?s.name+" = "+d+";":s.name+" is "+d+";";var c=Eden.AST.parseStatement(d);c.generated=this,c.addIndex(),c.execute(e,t,n,r)}else try{a={statement:this,symbol:s,isconstant:!0,dependant:!1,locals:e.locals,dependencies:this.dependencies};i=Eden.AST.transpileExpressionNode(this.expression,n,a);var h=Object.keys(this.dependencies);s.isasync="async"==this.expression.type,s.eager=this.eager,s.volatile=this.volatile;var p=this.safeEval(o,i);s.origin&&s.origin.isstatic&&(this.warning=new Eden.RuntimeWarning(this,Eden.RuntimeWarning.UNKNOWN,"Changing a [static] symbol")),s.define(p,this,h)}catch(e){var l;console.log(i),l=e.message==Eden.RuntimeError.EXTENDSTATIC?new Eden.RuntimeError(n.context,Eden.RuntimeError.EXTENDSTATIC,this,"Can only define list items if the list is defined"):new Eden.RuntimeError(n.context,Eden.RuntimeError.UNKNOWN,this,e),this.errors.push(l),l.line=this.line,n.context.instance.emit("error",[r,this.errors[this.errors.length-1]])}},Eden.AST.registerStatement(Eden.AST.Definition),Eden.AST.Delete=function(){this.type="delete",Eden.AST.BaseStatement.apply(this),this.destination=void 0,this.index=void 0},Eden.AST.Delete.prototype.setDest=function(e){this.destination=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Delete.prototype.setIndex=function(e){this.index=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Delete.prototype.generate=function(e,t,n){var r=this.index.generate(e,t,n);return this.destination.generate(e)+".mutate(scope, function(s) { scope.lookup(s.name).value.splice(rt.index("+r+"), 1); }, this);"},Eden.AST.Delete.prototype.execute=function(e,t,n){this.executed=1;var r=this.index.execute(e,t,n);r instanceof BoundValue&&(r=r.value),n.context.lookup(this.destination.name).mutate(n,function(e){e.value().splice(r-1,1)},this)},Eden.AST.registerStatement(Eden.AST.Delete),Eden.AST.Do=function(){this.type="do",Eden.AST.BaseStatement.apply(this),this.name=void 0,this.script=void 0,this.scope=void 0,this.compScope=void 0,this.nscope=void 0,this.selector=void 0,this.literal=void 0,this.statements=void 0,this.attribs={}},Eden.AST.Do.attributes={atomic:!0,nonatomic:!0},Eden.AST.Do.prototype.setScript=function(e){this.script=e,this.script&&this.script.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Do.prototype.setAttributes=function(e){for(var t in this.attribs=e,e)if(!Eden.AST.Do.attributes.hasOwnProperty(t))return!1;return!0},Eden.AST.Do.prototype.setLiteral=function(e){this.literal=e,e&&e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Do.prototype.setName=function(e){e&&e.errors&&this.errors.push.apply(this.errors,e.errors),this.name=e},Eden.AST.Do.prototype.setScope=function(e){this.scope=e,e&&e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Do.prototype.getScope=function(e,t){if(void 0===this.compScope)if(this.scope)try{this.compScope=new Function(["context","scope"],"var s = "+this.scope.generateConstructor(e,"scope",{bound:!1,scope:t})+"; s.rebuild(); return s;")}catch(e){console.error("Scope generate failed",e)}else this.compScope=function(e,t){return new Eden.Scope(e,t,[],!1,null,!1)};return this.compScope},Eden.AST.Do.prototype.generate=function(e,t,n){if(this.literal)return"context.instance.execute("+this.literal.generate(e,t,n)+");";var r=new Eden.RuntimeError(n.scope.context,Eden.RuntimeError.NOTSUPPORTED,this,"Cannot use 'do' here");return this.errors.push(r),n.scope.emit("error",[EdenSymbol.defaultAgent,r]),""},Eden.AST.Do.prototype.execute=function(e,t,n,r){},Eden.AST.registerStatement(Eden.AST.Do),Eden.AST.DoxyComment=function(e,t,n){this.type="doxycomment",this.content=e,this.startline=t,this.endline=n,this.tags=void 0,this.controls=void 0,this.parent=void 0},Eden.AST.DoxyComment.prototype.getHashTags=function(){return this.tags?Object.keys(this.tags):(this.stripped(),this.tags?Object.keys(this.tags):[])},Eden.AST.DoxyComment.prototype.hasTag=function(e){return void 0===this.tags&&this.getHashTags(),!(!this.tags||!this.tags[e])},Eden.AST.DoxyComment.prototype.getControls=function(){return this.controls?this.controls:(this.stripped(),this.controls)},Eden.AST.DoxyComment.prototype.getProperty=function(e){var t=this.getControls();return t?t["@"+e]:void 0},Eden.AST.DoxyComment.prototype.stripped=function(){if(void 0===this.content)return"";for(var e={},t={},n=this.content.split("\n"),r="",i=0;i<n.length;i++)if("#"==n[i].charAt(0)?(n[i]=n[i].slice(1)," "==n[i].charAt(0)&&(n[i]=n[i].slice(1))):"*"==n[i].trim().charAt(0)&&(n[i]=n[i].trim().slice(1)," "==n[i].charAt(0)&&(n[i]=n[i].slice(1))),""!=n[i]){var s=n[i].trim();if("@"!=s.charAt(0)){for(var o=n[i].split(/[ \t]+/),a=0;a<o.length;a++)""!=o[a]&&"@"!=o[a].charAt(0)?(r+=o[a]+" ","#"==o[a].charAt(0)&&(t[o[a]]=!0)):r+=" ";r+="\n"}else{var d=s.indexOf(" ");if(-1==d)e[s]=!0;else{var c=s.substring(0,d),h=s.substring(d+1,s.length);void 0===e[c]&&(e[c]=[]),e[c].push(h)}n[i]=""}}else r+="\n";return this.controls=e,this.tags=t,r.trim()},Eden.AST.DoxyComment.prototype.brief=function(){var e=this.stripped();if(e)return e.split(".")[0]},Eden.AST.DoxyComment.prototype.pretty=function(){var e=this.stripped(),t=this.controls["@param"],n=EdenUI.Markdown.html(e);if(t&&t.length>0){n+='<div class="doxy-parameters">Parameters:';for(var r=0;r<t.length;r++){n+='<div class="doxy-parameter"><div class="doxy-parameter-name">'+(e=t[r].split(/[ \t]+/))[0]+'</div><div class="doxy-parameter-details">'+e.slice(1).join(" ")+"</div></div>"}n+="</div>"}return n},Eden.AST.DoxyComment.prototype.getParamString=function(){var e=this.getControls()["@param"];if(e&&e.length>0){for(var t="(",n=0;n<e.length;n++)t+=e[n].split(/[ \t]+/)[0],n<e.length-1&&(t+=", ");return t+=")"}return"()"},Eden.AST.DummyStatement=function(){this.type="dummy",Eden.AST.BaseStatement.apply(this),this.start=-1},Eden.AST.DummyStatement.prototype.generate=function(){return""},Eden.AST.DummyStatement.prototype.execute=function(){},Eden.AST.registerStatement(Eden.AST.DummyStatement),Eden.AST.DummyStatement.prototype.setSource=function(e,t,n){this.start=this.start<0?e:this.start,this.end=t,this.source?this.source+=n:this.source=n},Eden.AST.DummyStatement.prototype.toEdenString=function(e,t){return""},Eden.AST.DummyStatement.prototype.buildID=function(){var e=0,t=this.source+(this.previousSibling?this.previousSibling.getSource():"");this.doxyComment&&(t=this.doxyComment.content+t);for(var n=t.length,r=0;r<n;r++)e=(e<<5)-e+t.charCodeAt(r),e&=e;this.id=this.type+"@"+e},Eden.AST.For=function(){this.type="for",Eden.AST.BaseStatement.apply(this),this.sstart=void 0,this.condition=void 0,this.inc=void 0,this.statement=void 0,this.compiled=void 0,this.started=!1,this.list=void 0,this.index=0,this.dirty=!1},Eden.AST.For.prototype.setStart=function(e){this.sstart=e,e&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.For.prototype.setCondition=function(e){this.condition=e,e&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.For.prototype.setIncrement=function(e){this.inc=e,e&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.For.prototype.setStatement=function(e){this.statement=e,e&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.For.prototype.generate=function(e,t,n){var r="for (";this.sstart?r+=this.sstart.generate(e,t,n)+" ":r+="; ",this.condition?r+=this.condition.generate(e,"scope",n)+"; ":r+="; ";var i=this.inc.generate(e,t,n);return";"==i.charAt(i.length-2)&&(i=i.slice(0,-2)),r+=i+")\n",r+=this.statement.generate(e,t,n)},Eden.AST.For.prototype.getCondition=function(e,t){if(this.compiled&&0==this.dirty)return this.compiled;var n=this.condition.generate(e,"scope",{bound:!1,usevar:"scriptexpr"==e.type,scope:t});e.dirty&&(this.dirty=!0,e.dirty=!1);var r=new Function(["context","scope"],"return "+n+";");return this.compiled=r,r},Eden.AST.For.prototype.execute=function(e,t,n,r){if(this.executed=1,this.sstart&&"range"===this.sstart.type){void 0===this.list&&(this.sstart.second?(this.index=this.sstart.expression.execute(e,t,n,r),this.list=this.sstart.second.execute(e,t,n,r)):(this.list=this.sstart.expression.execute(e,t,n,r),this.index=0));var i=this.sstart.lvalue.getSymbol(e,t,n);if(this.sstart.second)return this.index<=this.list?(i.assign(this.index,n,this),this.index++,[this.statement,this]):(this.index=0,void(this.list=void 0));if(Array.isArray(this.list))return this.index<this.list.length?(i.assign(this.list[this.index],n,this),this.index++,[this.statement,this]):(this.index=0,void(this.list=void 0))}else if(this.sstart&&!this.started)return this.started=!0,[this.sstart,this];if(!this.condition||this.getCondition(e,n)(n.context,n))return this.inc?[this.statement,this.inc,this]:[this.statement,this];this.started=!1},Eden.AST.registerStatement(Eden.AST.For),Eden.AST.FunctionCall=function(){this.type="functioncall",Eden.AST.BaseStatement.apply(this),Eden.AST.BaseExpression.apply(this),this.lvalue=void 0,this.params=void 0},Eden.AST.FunctionCall.prototype.setParams=function(e){this.params=e;for(var t=0;t<e.length;t++)this.mergeExpr(e[t]);this.typevalue=0,this.isconstant=!1},Eden.AST.FunctionCall.prototype.left=function(e){this.lvalue=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.FunctionCall.prototype.toEdenString=function(e,t){var n="(";if(this.params)for(var r=0;r<this.params.length;++r)r>0&&(n+=", "),n+=this.params[r].toEdenString(e,t);return n+")"},Eden.AST.FunctionCall.prototype.generateArgs=function(e,t,n){var r="[";if(this.params)for(var i=0;i<this.params.length;i++){r+="("+this.params[i].generate(e,t,n)+")",i!=this.params.length-1&&(r+=",")}return r+"]"},Eden.AST.FunctionCall.prototype.generate=function(e,t,n){if(void 0===this.lvalue){var r=`(${t}).call(this`;if(this.params)for(var i=0;i<this.params.length;i++){r+=",",r+="("+this.params[i].generate(e,t,n)+")"}return r+")"}var s=this.lvalue.generate(e,t,n);r=`${t}.value(${s})(${t}).call(scope.lookup(${s}).symbol`;if(this.params)for(i=0;i<this.params.length;i++){r+=",",r+="("+this.params[i].generate(e,t,n)+")"}return r+");"},Eden.AST.registerExpression(Eden.AST.FunctionCall),Eden.AST.FunctionCall.prototype.execute=function(ctx,base,scope,agent){if(this.lvalue){this.executed=1;var sym=this.lvalue.getSymbol(ctx,base,scope),argsstr=this.generateArgs(ctx,"scope",{scope:scope});try{var args=eval(argsstr);sym.value(scope)(scope).apply(sym,args)}catch(e){var err=new Eden.RuntimeError(scope.context,Eden.RuntimeError.FUNCCALL,this,e);this.errors.push(err),err.line=this.line,scope.context.instance.emit("error",[agent,err]),console.error(func)}}},Eden.AST.registerStatement(Eden.AST.FunctionCall),Eden.AST.Handle=function(e){console.log("MAKE HANDLE",e),this.name=e,this.cvalue=void 0,this.definition=void 0},Eden.AST.Handle.prototype.assign=function(e,t){console.log("HANDLE ASSIGN",this.name,e,t),t?t.lookup(this.name).value=e:this.cvalue=e},Eden.AST.Handle.prototype.define=function(e,t,n){console.log("HANDLE DEFINE",e),this.definition=e},Eden.AST.Handle.prototype.value=function(e){return console.log("HANDLE SCOPE",this.name,e,this.cvalue),this.definition?this.definition.call(this,e.context,e):e?e.lookup(this.name).value:this.cvalue},Eden.AST.If=function(){this.type="if",Eden.AST.BaseStatement.apply(this),this.condition="",this.statement=void 0,this.elsestatement=void 0,this.statements=[]},Eden.AST.registerStatement(Eden.AST.If),Eden.AST.If.prototype.setCondition=function(e){this.condition=e,this.errors.push.apply(this.errors,e.errors)},Eden.AST.If.prototype.setStatement=function(e){this.statement=e,e&&(this.statements.push(e),e.parent=this,this.errors.push.apply(this.errors,e.errors),e.warning&&!this.warning&&(this.warning=e.warning))},Eden.AST.If.prototype.setElse=function(e){this.elsestatement=e,e&&(this.statements.push(e),e.parent=this,this.errors.push.apply(this.errors,e.errors),e.warning&&!this.warning&&(this.warning=e.warning))},Eden.AST.If.prototype.generate=function(e,t,n){var r="if (";return r+=this.condition.generate(e,t,n),r+=") ",r+=this.statement.generate(e,t,n)+" ",this.elsestatement&&(r+="\nelse "+this.elsestatement.generate(e,t,n)+"\n"),r},Eden.AST.If.prototype.getCondition=function(e,t){var n="return ";return n+=this.condition.generate(e,"scope",{bound:!1,scope:t}),n+=";",new Function(["context","scope","ctx"],n)},Eden.AST.If.prototype.execute=function(e,t,n,r){return this.executed=1,this.getCondition(e,n)(n.context,n,e)?[this.statement]:(this.executed=2,this.elsestatement?[this.elsestatement]:void 0)},Eden.AST.Import=function(){this.type="import",Eden.AST.BaseStatement.apply(this),this.path=void 0,this.selector=void 0,this.statements=void 0},Eden.AST.Import.prototype.setPath=function(e){this.path=e},Eden.AST.registerStatement(Eden.AST.Import),Eden.AST.Index=function(){this.type="index",Eden.AST.BaseExpression.apply(this),this.expression=void 0,this.errors=[]},Eden.AST.Index.prototype.setExpression=function(e){this.expression=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Index.prototype.toEdenString=function(e,t){return`[${this.expression.toEdenString(e,t)}]`},Eden.AST.Index.prototype.generate=function(e,t,n){var r=this.expression.generate(e,t,n);return"literal"==this.expression.type&&"NUMBER"==this.expression.datatype?"["+r+"-1]":"[rt.index("+r+")]"},Eden.AST.registerExpression(Eden.AST.Index),Eden.AST.Insert=function(){this.type="insert",Eden.AST.BaseStatement.apply(this),this.destination=void 0,this.index=void 0,this.value=void 0},Eden.AST.Insert.prototype.setDest=function(e){this.destination=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Insert.prototype.setIndex=function(e){this.index=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Insert.prototype.setValue=function(e){this.value=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Insert.prototype.generate=function(e,t,n){var r=this.index.generate(e,t,n),i=this.value.generate(e,t,n),s=this.destination.generate(e,t,n);return this.destination.islocal?s+".splice(rt.index("+r+"), 0, ("+i+"));":s+".mutate(scope, function(s) { scope.lookup(s.name).value.splice(rt.index("+r+"), 0, ("+i+")); }, this);"},Eden.AST.Insert.prototype.execute=function(e,t,n){this.executed=1;var r=this.index.execute(e,t,n),i=this.value.execute(e,t,n);r instanceof BoundValue&&(r=r.value),i instanceof BoundValue&&(i=i.value),n.context.lookup(this.destination.name).mutate(n,function(e){e.value().splice(r-1,0,i)},this)},Eden.AST.registerStatement(Eden.AST.Insert),Eden.AST.Length=function(){this.type="length",Eden.AST.BaseExpression.apply(this),this.l=void 0,this.typevalue=Eden.AST.TYPE_NUMBER},Eden.AST.Length.prototype.left=function(e){this.l=e,this.mergeExpr(e),this.typevalue=Eden.AST.TYPE_NUMBER},Eden.AST.Length.prototype.toEdenString=function(e,t){return`${this.l.toEdenString(e,t)}#`},Eden.AST.Length.prototype.generate=function(e,t,n){return"rt.length("+this.l.generate(e,t,n)+")"},Eden.AST.registerExpression(Eden.AST.Length),Eden.AST.Literal=function(e,t){switch(this.type="literal",Eden.AST.BaseStatement.apply(this),Eden.AST.BaseExpression.apply(this),this.datatype=e,this.value=t,e){case"NUMBER":this.typevalue=Eden.AST.TYPE_NUMBER;break;case"LIST":this.typevalue=Eden.AST.TYPE_LIST;break;case"OBJECT":this.typevalue=Eden.AST.TYPE_OBJECT;break;case"STRING":case"CHARACTER":this.typevalue=Eden.AST.TYPE_STRING;break;case"BOOLEAN":this.typevalue=Eden.AST.TYPE_BOOLEAN;break;default:this.typevalue=Eden.AST.TYPE_UNKNOWN}},Eden.AST.Literal.prototype.toEdenString=function(e,t){var n;switch(this.datatype){case"NUMBER":return Eden.edenCodeForValue(this.value);case"LIST":n="[";for(var r=0;r<this.value.length;r++)n+=this.value[r].toEdenString(e,t),r!=this.value.length-1&&(n+=",");return n+"]";case"OBJECT":n="[";var i=Object.keys(this.value);for(r=0;r<i.length;++r)n+=i[r]+": ",n+=this.value[i[r]].toEdenString(e,t),r!=i.length-1&&(n+=",");return n+"]";case"CHARACTER":case"STRING":return Eden.edenCodeForValue(this.value);case"BOOLEAN":return this.value?"true":"false";case"JAVASCRIPT":return"${{"+this.value+"}}$";case"UNDEFINED":return"@"}return"@"},Eden.AST.Literal.prototype.generate=function(e,t,n){var r;switch(this.datatype){case"NUMBER":r=this.value;break;case"LIST":r="[";for(var i=0;i<this.value.length;i++)r+=this.value[i].generate(e,t,n),i!=this.value.length-1&&(r+=",");r+="]";break;case"OBJECT":r="{";var s=Object.keys(this.value);for(i=0;i<s.length;++i)r+=s[i]+": ",r+=this.value[s[i]].generate(e,t,n),i!=s.length-1&&(r+=",");r+="}";break;case"CHARACTER":case"STRING":r=JSON.stringify(this.value);break;case"BOOLEAN":case"JAVASCRIPT":r=this.value}return r},Eden.AST.registerExpression(Eden.AST.Literal),Eden.AST.Literal.prototype.execute=function(ctx,base,scope){switch(this.datatype){case"NUMBER":case"CHARACTER":case"BOOLEAN":return eval(this.value);case"STRING":return eval('"'+this.value+'"');case"OBJECT":case"LIST":var rhs="return ";return rhs+=this.generate(ctx,"scope",{bound:!1,scope:scope}),rhs+=";",new Function(["context","scope"],rhs)(scope.context,scope);case"JAVASCRIPT":return eval(this.value)}},Eden.AST.registerStatement(Eden.AST.Literal),Eden.AST.LList=function(){this.type="lvaluelist",this.errors=[],this.llist=[]},Eden.AST.LList.prototype.append=function(e){this.llist.push(e),this.errors.push.apply(this.errors,e.errors)},Eden.AST.LList.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.Local=function(e){this.name=e,this.cvalue=void 0,this.definition=void 0},Eden.AST.Local.prototype.assign=function(e,t){var n=t.lookup2(this.name);n.value=e,n.up_to_date=!0},Eden.AST.Local.prototype.define=function(e,t,n){this.definition=e},Eden.AST.Local.prototype.value=function(e){return e||console.error("Missing scope in local read"),this.definition?this.definition.call(this,e.context,e):e.lookup2(this.name).value},Eden.AST.LValue=function(){this.type="lvalue",Eden.AST.BaseExpression.apply(this),this.name=void 0,this.express=void 0,this.primary=void 0,this.lvaluep=void 0,this.islocal=!1,this.source="",this.isstatic=!1},Eden.AST.LValue.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.LValue.prototype.isDynamic=function(){return void 0!==this.express},Eden.AST.LValue.prototype.toEdenString=function(e,t){if(this.name)return this.name;if(this.primary)return this.primary.toEdenString(e,t);if(this.express){var n,r={dependencies:{},isconstant:!0,scopes:[],locals:t.locals},i="return "+this.express.generate(r,"scope",{bound:!1,scope:e})+";";if(r.isconstant)n=new Function(["context","scope"],i)(e.context,e);else n="`"+this.express.toEdenString(e,t)+"`";return n}},Eden.AST.LValue.prototype.setAttributes=function(e){for(var t in e)switch(t){case"static":this.isstatic=!0;break;case"number":this.typevalue=Eden.AST.TYPE_NUMBER;break;case"string":this.typevalue=Eden.AST.TYPE_STRING;break;case"boolean":this.typevalue=Eden.AST.TYPE_BOOLEAN;break;case"list":this.typevalue=Eden.AST.TYPE_LIST;break;case"any":this.typevalue=0;break;case"object":this.typevalue=Eden.AST.TYPE_OBJECT;break;default:return!1}return!0},Eden.AST.LValue.prototype.setExtras=function(e){if(this.lvaluep=e,e)for(var t=0;t<e.length;t++)this.errors.push.apply(this.errors,e[t].errors),!this.warning&&e[t].warning&&(this.warning=e[t].warning)},Eden.AST.LValue.prototype.setObservable=function(e){this.name=e},Eden.AST.LValue.prototype.setPrimary=function(e){this.primary=e,e&&e.errors.length>0&&this.errors.push.apply(this.errors,e.errors),!this.warning&&e.warning&&(this.warning=e.warning),e&&"unaryop"===e.type&&(this.primary=e.r)},Eden.AST.LValue.prototype.setExpression=function(e){this.express=e,e&&e.errors.length>0&&this.errors.push.apply(this.errors,e.errors),!this.warning&&e.warning&&(this.warning=e.warning)},Eden.AST.LValue.prototype.setBackticks=Eden.AST.LValue.prototype.setExpression,Eden.AST.LValue.prototype.getSymbol=function(e,t,n){if(e&&e.locals&&"declarations"!=e.locals.type&&e.locals.hasOwnProperty(this.name))return this.islocal=!0,e.locals[this.name];if(this.name)return n.context.lookup(this.name);if(this.primary)return this.primary.execute(e,t,n);if(this.express){var r=this.express.execute(e,t,n);return n.context.lookup(r)}},Eden.AST.LValue.prototype.hasListIndices=function(){return this.lvaluep&&this.lvaluep.length>0&&"index"==this.lvaluep[0].kind},Eden.AST.LValue.prototype.generateCompList=function(e,t,n){for(var r="[",i=0;i<this.lvaluep.length;i++)r+="rt.index("+this.lvaluep[i].indexexp.generate(e,t,n)+")",i<this.lvaluep.length-1&&(r+=",");return r+="]"},Eden.AST.LValue.prototype.generateIndexList=function(e,t,n){for(var r="[",i=0;i<this.lvaluep.length;i++)r+="rt.index("+this.lvaluep[i].indexexp.generate(e,t,n)+")",i<this.lvaluep.length-1&&(r+="][");return r+="]"},Eden.AST.LValue.prototype.generateIdStr=function(){return'"'+this.generateCompList()+'"'},Eden.AST.LValue.prototype.executeCompList=function(e,t){for(var n=[],r=0;r<this.lvaluep.length;r++)if("index"==this.lvaluep[r].kind){var i=this.lvaluep[r].indexexp.generate(e,"scope",{bound:!1});n.push(rt.index(new Function(["context","scope"],"return "+i+";")(t.context,t)))}return n},Eden.AST.LValue.prototype.generate=function(e,t,n){if(this.name){if(e&&e.locals){if("declarations"==e.locals.type&&-1!=e.locals.list.indexOf(this.name)){this.islocal=!0;for(var r=this.name,i=0;i<this.lvaluep.length;i++)r+=this.lvaluep[i].generate(e,t,n);return r}if(e.locals.hasOwnProperty(this.name)){this.islocal=!0;for(r=this.name,i=0;i<this.lvaluep.length;i++)r+=this.lvaluep[i].generate(e,t,n);return r}}if(e&&e.params&&-1!=e.params.list.indexOf(this.name)){this.islocal=!0;for(r=this.name,i=0;i<this.lvaluep.length;i++)r+=this.lvaluep[i].generate(e,t,n);return r}return'"'+this.name+'"'}return this.primary?this.primary.generate(e,t,n):this.express?this.express.generate(e,t,n):void 0},Eden.AST.registerExpression(Eden.AST.LValue),Eden.AST.LValueComponent=function(e){this.type="lvaluecomponent",Eden.AST.BaseExpression.apply(this),this.kind=e,this.indexexp=void 0,this.observable=void 0},Eden.AST.LValueComponent.prototype.toEdenString=function(e,t){return""},Eden.AST.LValueComponent.prototype.index=function(e){this.indexexp=e,this.errors.push.apply(this.errors,e.errors)},Eden.AST.LValueComponent.prototype.property=function(e){this.observable=e},Eden.AST.LValueComponent.prototype.generate=function(e,t,n){if("index"==this.kind)return"[rt.index("+this.indexexp.generate(e,t,n)+")]"},Eden.AST.registerExpression(Eden.AST.LValueComponent),Eden.AST.Modify=function(e,t){this.type="modify",Eden.AST.BaseContext.apply(this),this.errors=t?t.errors:[],this.kind=e,this.expression=t,this.lvalue=void 0,t&&t.warning&&(this.warning=t.warning)},Eden.AST.Modify.prototype.left=function(e){this.lvalue=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors),!this.warning&&e.warning&&(this.warning=e.warning)},Eden.AST.Modify.prototype.generate=function(e,t){var n,r=this.lvalue.generate(e,t),i=r;return 0==this.lvalue.islocal?i=t+".assign("+r+","+t+".value("+r+")":i+=" = "+r,this.expression&&(n=this.expression.generate(e,t,{bound:!1,usevar:"scriptexpr"==e.type})),"+="==this.kind?i+=" + "+n:"-="==this.kind?i+=" - "+n:"/="==this.kind?i+=" / "+n:"*="==this.kind?i+=" * "+n:"++"==this.kind?i+="+1":"--"==this.kind&&(i+="-1"),0==this.lvalue.islocal?i+=", EdenSymbol.localJSAgent);\n":i+=";\n",i},Eden.AST.Modify.prototype.execute=function(e,t,n,r){this.executed=1;var i=this.lvalue.getSymbol(e,t,n);if("++"==this.kind){var s=i.value(n)+1;i.assign(s,n,this)}else if("--"==this.kind){s=i.value(n)-1;i.assign(s,n,this)}else{var o={statement:this,symbol:i,isconstant:!0,dependant:!1,locals:e.locals},a=Eden.AST.transpileExpressionNode(this.expression,n,o),d=new Function(["context","scope","cache"],a).call(i,n.context,n,n.lookup(i.name));switch(this.kind){case"+=":s=rt.add(i.value(n),d);break;case"-=":s=rt.subtract(i.value(n),d);break;case"/=":s=rt.divide(i.value(n),d);break;case"*=":s=rt.multiply(i.value(n),d);break;case"//=":s=rt.concat(i.value(n),d)}i.assign(s,n,this)}},Eden.AST.registerStatement(Eden.AST.Modify),Eden.AST.Parameter=function(e){this.type="parameter",this.index=e,this.errors=[],console.error("DEPRECATED PARAMETER")},Eden.AST.Parameter.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.Parameter.prototype.generate=function(e,t,n){if(-1==this.index){if(e&&e.parameters)return""+e.parameters.length;this.returnsbound=!1,r="0"}else if(e&&e.parameters){e.dirty=!0;var r=e.parameters[this.index-1];return this.returnsbound=r instanceof BoundValue,"ctx.parameters["+this.index+"-1]"}},Eden.AST.Primary=function(){this.type="primary",Eden.AST.BaseExpression.apply(this),this.observable="",this.extras=[],this.backtick=void 0,this.isconstant=!1,this.isstatic=!1,this.isrequired=!1,this.attrib=""},Eden.AST.Primary.prototype.setBackticks=function(e){this.backtick=e,this.mergeExpr(e),this.typevalue=Eden.AST.TYPE_UNKNOWN,this.isdynamic=!0},Eden.AST.Primary.prototype.setObservable=function(e){this.observable=e},Eden.AST.Primary.prototype.getObservable=function(){return this.observable},Eden.AST.Primary.prototype.prepend=function(e){this.extras.unshift(e),e.errors.length>0&&this.errors.push.apply(this.errors,e.errors),e.warning&&!this.warning&&(this.warning=e.warning)},Eden.AST.Primary.prototype.setAttributes=function(e){for(var t in e)switch(t){case"changed":case"source":case"expression":case"dependencies":case"subscribers":this.attrib=t;break;case"static":this.isstatic=!0;break;case"require":this.isrequired=!0;break;case"number":if(0!=this.typevalue)return!1;this.typevalue=Eden.AST.TYPE_NUMBER;break;case"string":if(0!=this.typevalue)return!1;this.typevalue=Eden.AST.TYPE_STRING;break;case"boolean":if(0!=this.typevalue)return!1;this.typevalue=Eden.AST.TYPE_BOOLEAN;break;case"object":if(0!=this.typevalue)return!1;this.typevalue=Eden.AST.TYPE_OBJECT;break;case"list":if(0!=this.typevalue)return!1;this.typevalue=Eden.AST.TYPE_LIST;break;default:return!1}return!0},Eden.AST.Primary.prototype.toEdenString=function(e,t){var n;if(t.isconstant=!1,"__BACKTICKS__"==this.observable){var r={dependencies:{},isconstant:!0,scopes:[],locals:t.locals},i="return "+this.backtick.generate(r,"scope",{bound:!1,scope:e})+";";if(r.isconstant){var s=new Function(["context","scope"],i)(e.context,e);if(!Eden.isValidIdentifier(s))return"__error__";n=s}else n="`"+this.backtick.toEdenString(e,t)+"`"}else n=this.observable,t.locals&&t.locals.hasOwnProperty(n)&&(t.isconstant=!0);for(var o=0;o<this.extras.length;o++)"index"==this.extras[o].type&&(n+="["),n+=this.extras[o].toEdenString(e,t),"index"==this.extras[o].type&&(n+="]");return n},Eden.AST.Primary.prototype._checkFunction=function(e){var t=e.context.lookup(this.observable);return!!(t.origin&&t.origin.isstatic&&e.context.f.hasOwnProperty("func_"+this.observable))&&(console.log("has static function: "+this.observable),!0)},Eden.AST.Primary.prototype.generate=function(e,t,n){var r;if(e&&e.locals)if("declarations"==e.locals.type){if(-1!=e.locals.list.indexOf(this.observable))return r=this.observable}else if(e.locals.hasOwnProperty(this.observable)){if(e.dirty=!0,n.usevar)r=this.observable;else if(n.indef)r=JSON.stringify(e.locals[this.observable].value(n.scope));else{var i=e.locals[this.observable].value(n.scope);r=`${t}.value("${this.observable}")`,void 0===i&&console.error("Local variable undefined",this.observable)}return r}if(e&&e.params&&-1!=e.params.list.indexOf(this.observable))return r=this.observable;if("__BACKTICKS__"==this.observable){var s;e&&(s=e.isconstant,e.isconstant=!0,e.dynamic_source);var o=this.backtick.generate(e,t,n);if(!e||e.isconstant||"definition"!=e.type){if(e&&e.isconstant&&"definition"==e.type){try{o=new Function("return "+o+";")()}catch(e){return console.error(e),'"__error__"'}this.isstatic||(e.dependencies[o]=!0),s=!1,Eden.isValidIdentifier(o)||(o="__error__"),o=JSON.stringify(o)}r=o}else r=this.isstatic?o:"this.subscribeDynamic(0,"+o+", "+t+")";e&&(e.isconstant=s)}else e&&e.dependencies&&!this.isstatic&&(e.dependencies[this.observable]=!0,e.isconstant=!1),r='"'+this.observable+'"';if(0===this.attrib.length)if(0!=this.typevalue)switch(this.typevalue){case Eden.AST.TYPE_NUMBER:r=`${t}.assertNumber(${r},this)`;break;case Eden.AST.TYPE_STRING:r=`${t}.assertString(${r},this)`;break;case Eden.AST.TYPE_LIST:r=`${t}.assertList(${r},this)`;break;case Eden.AST.TYPE_OBJECT:r=`${t}.assertObject(${r},this)`;break;case Eden.AST.TYPE_BOOLEAN:r=`${t}.assertBoolean(${r},this)`}else if(this.isrequired)r=`${t}.assertValid(${r},this)`;else{r=t+".value("+r+")"}else switch(this.attrib){case"changed":r=`${t}.symbol(${r}).hasChanged()`;break;case"source":r=`${t}.symbol(${r}).getSource()`;break;default:r=t+".value("+r+")"}return r},Eden.AST.registerExpression(Eden.AST.Primary),Eden.AST.Range=function(e){this.type="range",Eden.AST.BaseStatement.apply(this),this.parent=void 0,this.errors=e?e.errors:[],this.expression=e,this.lvalue=void 0,this.start=0,this.end=0,this.second=null},Eden.AST.Range.prototype.setSource=function(e,t){this.start=e,this.end=t},Eden.AST.Range.prototype.setSecond=function(e){this.second=e,e&&e.errors&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Range.prototype.left=function(e){this.lvalue=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Range.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.registerStatement(Eden.AST.Range),Eden.AST.Require=function(){this.type="require",Eden.AST.BaseStatement.apply(this),this.expression=void 0},Eden.AST.Require.prototype.setExpression=function(e){this.expression=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Require.prototype.generate=function(e,t,n){return"edenUI.loadPlugin("+this.expression.generate(e,t,n)+");"},Eden.AST.Require.prototype.execute=function(e,t,n){this.executed=1,edenUI.loadPlugin(this.expression.execute(e,t,n))},Eden.AST.registerStatement(Eden.AST.Require),Eden.AST.Return=function(){this.type="return",Eden.AST.BaseStatement.apply(this),this.result=void 0},Eden.AST.Return.prototype.setResult=function(e){this.result=e,this.errors.push.apply(this.errors,e.errors)},Eden.AST.Return.prototype.toEdenString=function(e,t){return`return ${this.result.toEdenString(e,t)};`},Eden.AST.Return.prototype.generate=function(e,t,n){return this.result?"return "+this.result.generate(e,t,n)+";\n":"return;\n"},Eden.AST.Return.prototype.execute=function(e,t,n,r){return e.result=this.result.execute(e,t,n,r),-1},Eden.AST.registerStatement(Eden.AST.Return),Eden.AST.Scope=function(){this.type="scope",Eden.AST.BaseExpression.apply(this),this.range=!1,this.overrides={},this.expression=void 0},Eden.AST.Scope.prototype.prepend=function(e){this.primary.prepend(e)},Eden.AST.Scope.prototype.setExpression=function(e){this.expression=e,this.mergeExpr(e),this.isscoped=!0},Eden.AST.Scope.prototype.addOverride=function(e,t,n,r,i){this.errors.push.apply(this.errors,e.errors),i&&(this.range=!0),r?(this.range=!0,this.overrides[e.observable]={start:t,end:r,increment:n,components:e.components,isin:i},this.errors.push.apply(this.errors,t.errors),this.errors.push.apply(this.errors,n.errors),this.errors.push.apply(this.errors,r.errors)):n?(this.range=!0,this.overrides[e.observable]={start:t,end:n,components:e.components,isin:i},this.errors.push.apply(this.errors,t.errors),this.errors.push.apply(this.errors,n.errors)):t&&(this.overrides[e.observable]={start:t,end:void 0,components:e.components,isin:i},this.errors.push.apply(this.errors,t.errors))},Eden.AST.Scope.prototype.toEdenString=function(e,t){var n="("+this.expression.toEdenString(e,t)+" with ";if(t.isconstant)return n;var r=!0;for(var i in this.overrides){var s=this.overrides[i],o=i,a={isconstant:!0,locals:t.locals};r||(o=", "+o),r=!1,s.isin||s.end?o+=" in ":o+=" = ";var d=s.start.toEdenString(e,a);a.isconstant?o+=Eden.AST.executeExpressionNode(s.start,e,a):o+=d,a.isconstant=!0,s.increment&&(o+=".."+s.increment.toEdenString(e,t)),s.end&&(o+=".."+s.end.toEdenString(e,t)),n+=o}return n+")"},Eden.AST.Scope.prototype.generateConstructor=function(e,t,n){var r;for(var i in r="new Eden.Scope(context, "+t+", [",this.overrides){var s=this.overrides[i];if(r+='new Eden.ScopeOverride("'+i+'", '+(this.range,s.start.generate(e,t,n)),s.end){var o=this.overrides[i].end.generate(e,t,n);if(s.increment)r+=", "+o+", "+s.increment.generate(e,t,n)+"),";else r+=", "+o+"),"}else r+=", undefined, undefined, "+s.isin+"),"}return r=r.slice(0,-1),r+="], "+this.range+", this,true)"},Eden.AST.Scope.prototype._generate_plain_range=function(e,t){var n="_scopes["+(e.scopes.length-1)+"]",r="(function() {\n";return r+=n+".range = false;\n",r+="var results = [];\n",r+="var scoperesults = [];\n",r+="while(true) {\n",r+="var val = "+this.expression.generate(e,"_scopes["+(e.scopes.length-1)+"]",t),t.bound&&(r+=";\n\tif (val.value !== undefined) scoperesults.push(val.scope);\n\tval = val.value"),r+=";\n",r+="if (val !== undefined) results.push(val);\n",r+="if ("+n+".next() == false) break;\n",r+="}\n"+n+".range = true;\n",t.bound?r+="if (cache) cache.scopes = scoperesults;\n return new BoundValue(results,"+n+");}).call(this)":r+="return results;}).call(this)",r},Eden.AST.Scope.prototype._generate_loop_opti=function(e,t,n){var r="_scopes["+(e.scopes.length-1)+"]",i=this.expression.generate(e,"_scopes["+(e.scopes.length-1)+"]",t);return`(function() {\n\t\t${r}.range = false;\n\t\tvar looper = ${r}.overrides[${n[0]}];\n\t\tvar ix = 0;\n\t\tvar loopsize = looper.end - looper.start+1;\n\t\tif (loopsize <= 0 || loopsize > 1000000 || isNaN(loopsize)) return [];\n\t\tvar results = new Array(loopsize);\n\t\tfor (var i=looper.start; i<=looper.end; i++) {\n\t\t\tif (i>looper.start) ${r}.resetCache();\n\t\t\tlooper.current = i;\n\t\t\t${r}.refresh();\n\t\t\tvar val = ${i};\n\t\t\tif (val !== undefined) results[ix++] = val;\n\t\t}\n\t\t${r}.range = true;\n\t\tif (results.length > ix) results.length = ix;\n\t\treturn results;\n\t}).call(this)`},Eden.AST.Scope.prototype.generate=function(e,t,n){e.scopes.push(this.generateConstructor(e,t,n));var r="";if(this.range){var i=!1,s=[],o=0;for(var a in this.overrides){if(!this.overrides[a].end){this.overrides[a].isin&&(i=!0);break}s.push(o),o++}r=i||1!=s.length?this._generate_plain_range(e,n):this._generate_loop_opti(e,n,s)}else{var d=this.expression.generate(e,"_scopes["+(e.scopes.length-1)+"]",n);r="async"==this.expression.type?"(function(){ var _r = "+d+"; _r.then(rr => { cache.value = rr; this.expireAsync(); }); return cache.value; }).call(this)":d}return r},Eden.AST.registerExpression(Eden.AST.Scope),Eden.AST.ScopedScript=function(e,t){this.type="scopedscript",this.statements=e,this.scope=t},Eden.AST.ScopedScript.prototype.execute=function(e,t,n,r){return this.statements},Eden.AST.ScopePath=function(){this.type="scopepath",this.errors=[],this.primary=void 0,this.path=new Eden.AST.Primary,this.scopestr=void 0},Eden.AST.ScopePath.prototype.prepend=function(e){this.path.prepend(e)},Eden.AST.ScopePath.prototype.setObservable=function(e){this.path.setObservable(e)},Eden.AST.ScopePath.prototype.setBackticks=function(e){this.path.setBackticks(e)},Eden.AST.ScopePath.prototype.getObservable=function(){return this.primary.getObservable()},Eden.AST.ScopePath.prototype.getScopeString=function(){return this.scopestr},Eden.AST.ScopePath.prototype.setPrimary=function(e){this.primary=e,this.primary.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.ScopePath.prototype.generate=function(e,t,n){var r=this.path.generate(e,t,{bound:!0,scopeonly:!0});return this.primary.generate(e,r,n)},Eden.AST.ScopePath.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.ScopePattern=function(){this.type="scopepattern",this.observable="NONAME",this.components=[],this.errors=[]},Eden.AST.ScopePattern.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.ScopePattern.prototype.setObservable=function(e){this.observable=e},Eden.AST.ScopePattern.prototype.addListIndex=function(e){this.components.push(e),e&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Script=function(){this.type="script",Eden.AST.BaseScript.apply(this),this.name=void 0,this.active=!1,this.base=void 0,this.prefix="",this.postfix="",this.readables=null,this.writables=null},Eden.AST.registerScript(Eden.AST.Script),Eden.AST.Script.prototype.getActionByName=function(e){for(var t=0;t<this.statements.length;t++)if("script"==this.statements[t].type&&this.statements[t].name==e)return this.statements[t]},Eden.AST.Script.prototype.getSource=function(){return this.prefix+this.getInnerSource()+this.postfix},Eden.AST.Script.prototype.getInnerSource=function(){for(var e="",t=0;t<this.statements.length;t++)e+=this.statements[t].getSource();return e},Eden.AST.Script.prototype.patchInner=function(e){for(var t=this;t.parent;)t=t.parent;this.source=null;for(var n=[],r=[],i=Eden.Selectors.getID(this),s={},o=0;o<this.statements.length;o++){void 0===s[(a=this.statements[o]).id]&&(s[a.id]=[]),s[a.id].push(a)}for(o=0;o<e.statements.length;o++){var a;(a=e.statements[o]).buildID(),s[a.id]&&s[a.id].length>0?(e.replaceChild(o,s[a.id][0]),s[a.id].shift(),0==s[a.id].length&&delete s[a.id]):("dummy"!=a.type&&this.indexed&&a.addIndex(),"dummy"==a.type?n.push({index:o,path:i,source:a.getSource(),id:a.previousSibling?a.previousSibling.id:0,ws:!0}):n.push({index:o,path:i,source:a.getSource(),ws:!1}))}for(var d in s){var c=s[d];for(o=0;o<c.length;o++)"when"==c[o].type&&c[o].enabled&&eden.project.removeAgent(c[o]),"dummy"==c[o].type?r.push({path:i,id:c[o].previousSibling?c[o].previousSibling.id:0,ws:!0}):r.push({path:i,id:c[o].id,ws:!1}),this.indexed&&0==c[o].executed?c[o].removeIndex():c[o].destroy()}if(void 0===this.parent)for(o=0;o<e.statements.length;o++)"script"==e.statements[o].type&&"ACTIVE"==e.statements[o].name?(e.statements[o]=eden.root,Eden.Index.remove(e.statements[o])):e.statements[o].parent=this;else for(o=0;o<e.statements.length;o++)e.statements[o].parent=this;if(this.statements=e.statements,this.subscribers)for(var h in this.subscribers)eden.root.expireEdenSymbol(this.subscribers[h]);return[n,r]},Eden.AST.Script.prototype.patchOuter=function(e){},Eden.AST.Script.prototype.getLine=function(){return this.line},Eden.AST.Script.prototype.isRemote=function(){for(var e=this;e.parent;)e=e.parent;return e.base.origin.remote},Eden.AST.Script.prototype.setLocals=function(e){this.locals=e,e&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Script.prototype.subscribeDynamic=function(e,t){return eden.root.lookup(t)},Eden.AST.Script.prototype.getParameterByNumber=function(e){if(this.parameters)return this.parameters[e-1]},Eden.AST.Script.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.Script.prototype.setName=function(e,t){this.name=t,this.shortName=t},Eden.AST.Script.prototype.setAttributes=function(e){return!0},Eden.AST.Script.prototype.setReadables=function(e){this.readables=e},Eden.AST.Script.prototype.setWritables=function(e){this.writables=e},Eden.AST.Script.prototype.setSource=function(e,t,n){if(this.start=e,this.end=t,n){0==this.statements.length||(this.prefix=n.substring(0,this.statements[0].start-e),this.postfix=n.substring(this.statements[this.statements.length-1].end-e)),this.numlines=0;for(var r=0;r<this.prefix.length;r++)"\n"==this.prefix.charAt(r)&&this.numlines++;for(r=0;r<this.postfix.length;r++)"\n"==this.postfix.charAt(r)&&this.numlines++}},Eden.AST.Script.prototype.execute=function(e,t,n,r){var i=[];if(this.executed=1,this.locals&&this.locals.list.length>0){void 0===e.locals&&(e.locals={});for(var s=0;s<this.locals.list.length;s++)e.locals[this.locals.list[s]]=new Eden.AST.Local(this.locals.list[s])}for(s=0;s<this.statements.length;s++)"script"!=this.statements[s].type&&"section"!=this.statements[s].type&&i.push(this.statements[s]);return i},Eden.AST.Script.prototype.generate=function(e,t,n){for(var r="{\n",i=0;i<this.statements.length;i++)r+=this.statements[i].generate(e,t,n);return r+="}"},Eden.AST.Virtual=function(e){this.type="script",Eden.AST.BaseScript.apply(this),this.name=e},Eden.AST.Virtual.prototype.getSource=function(){return""},Eden.AST.Virtual.prototype.getInnerSource=function(){return""},Eden.AST.ScriptExpr=function(){this.type="scriptexpr",Eden.AST.BaseScript.apply(this),Eden.AST.BaseExpression.apply(this),this.script=null},Eden.AST.ScriptExpr.prototype.toEdenString=function(e,t){for(var n="func {\n",r=0;r<this.script.statements.length;r++)n+=this.script.statements[r].toEdenString(e,t)+"\n";return n+="}"},Eden.AST.ScriptExpr.prototype.setScript=function(e){this.script=e,e&&e.errors&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.ScriptExpr.prototype.generate=function(e,t,n){var r="if (!scope) { console.warn('No function scope'); throw 'No scope'; }\n";r+="var context = scope.context;\n";var i=Object.assign({},n);if(i.usevar=!0,!n.scope)throw console.error("Missing scope"),"Missing scope";for(var s,o={dependencies:e.dependencies,locals:{}},a=[],d=0;d<this.script.statements.length;d++)r+=this.script.statements[d].generate(o,"scope",i);for(var c in o.locals)"oracle"==o.locals[c]&&a.push(c);void 0===n.funcindex&&(n.funcindex=0),n.symbol?(s=n.symbol.name,0!=n.funcindex++&&(s+=n.funcindex)):s=Math.random().toString(36).substr(2,9),r=`return function func_${s}(${a.join(",")}){ ${r} };`,this.script.setName(null,s),this.script.addIndex();try{var h=new Function(["scope"],r);n.scope.context.f["func_"+s]=h}catch(e){console.error("Func compile error: "+s,e,r)}return`context.f.func_${s}`},Eden.AST.registerScript(Eden.AST.ScriptExpr),Eden.AST.registerExpression(Eden.AST.ScriptExpr),Eden.AST.Subscribers=function(){this.type="subscribers",Eden.AST.BaseStatement.apply(this),this.list=[],this.lvalue=void 0},Eden.AST.Subscribers.prototype.left=function(e){this.lvalue=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Subscribers.prototype.execute=function(e,t,n){},Eden.AST.Subscribers.prototype.setList=function(e){this.list=e},Eden.AST.registerStatement(Eden.AST.Subscribers),Eden.AST.SubStatement=function(){this.type="substat",Eden.AST.BaseStatement.apply(this),this.kind="parse",this.expression=void 0},Eden.AST.SubStatement.prototype.setOperation=function(e,t){this.expression=t,t&&t.errors.length>0&&this.errors.push.apply(this.errors,t.errors)},Eden.AST.SubStatement.prototype.toEdenString=function(e,t){return Eden.AST.executeExpressionNode(this.expression,e,t)},Eden.AST.SubStatement.prototype.generate=function(e,t,n){var r={isconstant:!0,locals:e.locals,scope:n.scope,symbol:n.symbol},i=Eden.AST.executeExpressionNode(this.expression,n.scope,r),s=Eden.AST.parseStatement(i);return console.log("PARSE STRING = "+i,s),s.generate(e,t,n)},Eden.AST.SubStatement.prototype.execute=function(e,t,n,r){var i=new Eden.RuntimeError(n.context,Eden.RuntimeError.NOTSUPPORTED,this,"Sub-statements not supported here");i.line=this.line,this.errors.push(i),Eden.Agent.emit("error",[r,i])},Eden.AST.registerStatement(Eden.AST.SubStatement),Eden.AST.Switch=function(){this.type="switch",Eden.AST.BaseStatement.apply(this),this.expression="",this.statement=void 0,this.compiled=void 0},Eden.AST.Switch.prototype.setExpression=function(e){this.expression=e,e&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Switch.prototype.setStatement=function(e){this.statement=e,this.errors.push.apply(this.errors,e.errors)},Eden.AST.Switch.prototype.generate=function(e,t){void 0===t&&(t="eden.root.scope");var n="switch(";return n+=this.expression.generate(e,t,{bound:!1}),n+=") "+this.statement.generate(e,t)},Eden.AST.Switch.prototype.getSelector=function(e){if(this.compiled)return this.compiled;var t="return ";return t+=this.expression.generate(e,"scope",{bound:!1}),t+=";",this.compiled=new Function(["context","scope"],t),this.compiled},Eden.AST.Switch.prototype.execute=function(e,t,n,r){var i=new Eden.RuntimeError(n.context,Eden.RuntimeError.NOTSUPPORTED,this,"Switch not supported here");i.line=this.line,this.errors.push(i),Eden.Agent.emit("error",[r,i])},Eden.AST.registerStatement(Eden.AST.Switch),Eden.AST.TernaryOp=function(e){this.type="ternaryop",Eden.AST.BaseExpression.apply(this),this.op=e,this.first=void 0,this.second=void 0,this.condition=void 0},Eden.AST.TernaryOp.prototype.setFirst=function(e){this.first=e,this.mergeExpr(e)},Eden.AST.TernaryOp.prototype.setSecond=function(e){this.second=e,this.mergeExpr(e)},Eden.AST.TernaryOp.prototype.setCondition=function(e){this.condition=e,e&&(this.isconstant=this.isconstant&&e.isconstant,this.isdependant=this.isdependant||e.isdependant,this.isdynamic=this.isdynamic||e.isdynamic,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors),e.warning&&!this.warning&&(this.warning=e.warning))},Eden.AST.TernaryOp.prototype.left=function(e){void 0===this.condition?this.setCondition(e):this.setFirst(e)},Eden.AST.TernaryOp.prototype.toEdenString=function(e,t){return`(${this.first.toEdenString(e,t)} if ${this.condition.toEdenString(e,t)} else ${this.second.toEdenString(e,t)})`},Eden.AST.TernaryOp.prototype.generate=function(e,t,n){var r=this.first.generate(e,t,n);return"(("+this.condition.generate(e,t,n)+")?("+r+"):("+this.second.generate(e,t,n)+"))"},Eden.AST.registerExpression(Eden.AST.TernaryOp),Eden.AST.UnaryOp=function(e,t){switch(this.type="unaryop",Eden.AST.BaseExpression.apply(this),this.op=e,this.r=t,this.mergeExpr(t),e){case"&":this.typevalue=Eden.AST.TYPE_SYMBOL;break;case"!":this.typevalue=Eden.AST.TYPE_BOOLEAN;break;case"-":this.typevalue=Eden.AST.TYPE_NUMBER;break;case"*":this.typevalue=Eden.AST.TYPE_UNKNOWN,this.isconstant=!1,this.isdynamic=!0;break;case"sub":this.isdependant=!0,this.isconstant=!0,this.isdynamic=!1;break;case"compile":this.typevalue=Eden.AST.TYPE_STRING;break;case"parse":this.typevalue=Eden.AST.TYPE_AST}},Eden.AST.UnaryOp.prototype.toEdenString=function(e,t){if("sub"==this.op){var n=Eden.AST.executeExpressionNode(this.r,e,t),r=typeof n;return"object"==r&&n._is_eden_expression?n.toEdenString(e,t):n="object"==r&&n instanceof EdenSymbol?"&"+n.name:Eden.edenCodeForValue(n)}switch(this.op){case"*":case"&":return`${this.op}${this.r.toEdenString(e,t)}`;case"compile":case"eval":case"parse":case"!":case"-":return`${this.op}(${this.r.toEdenString(e,t)})`}},Eden.AST.UnaryOp.prototype.generate=function(e,t,n){if("sub"==this.op){var r={isconstant:!0,locals:e.locals},i=Eden.AST.executeExpressionNode(this.r,n.scope,r),s=typeof i;return i="object"==s&&i._is_eden_expression?i.generate(e,t,n):"object"==s&&i instanceof EdenSymbol?`${t}.context.lookup("${i.name}")`:JSON.stringify(i),e.dependant=!0,i}var o;e&&(o=e.isconstant,e.isconstant=!0);var a,d=this.r.generate(e,t,n),c=!1;if(e&&(c=e.isconstant,e.isconstant=o&&c),"compile"==this.op)return"scope.context.instance.transpileExpression("+d+", this, "+t+")";if("parse"==this.op)return"scope.context.instance.parseExpression("+d+", this)";if("eval"==this.op)return"scope.context.instance.evalEden("+d+", this, "+t+")";if("!"==this.op)a="!("+d+")";else if("&"==this.op){if(e&&e.dependencies)if(this.r.observable);else if(c){var h="ERROR";try{h=new Function(["context","scope"],"return "+d+";")(n.scope.context,n.scope)}catch(e){console.error("Backtick evaluation error",e)}d=h=JSON.stringify(h)}a="scope.context.lookup("+d+")"}else"-"==this.op?a="-("+d+")":"*"==this.op&&(a="this.subscribeDynValue(0, "+d+", "+t+")");return a},Eden.AST.registerExpression(Eden.AST.UnaryOp),Eden.AST.Wait=function(){this.type="wait",Eden.AST.BaseStatement.apply(this),this.delay=void 0,this.compiled_delay=void 0},Eden.AST.Wait.prototype.setDelay=function(e){this.delay=e,e&&e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Wait.prototype.compile=function(e){if(void 0!==this.delay&&!this.compiled_delay){var t="return ";t+=this.delay.generate(e,"scope",{bound:!1}),t+=";",this.compiled_delay=new Function(["context","scope"],t)}},Eden.AST.Wait.prototype.generate=function(e,t,n){var r=new Eden.RuntimeError(n.scope.context,Eden.RuntimeError.NOTSUPPORTED,this,"Cannot use 'wait' here");return this.errors.push(r),n.scope.context.instance.emit("error",[EdenSymbol.defaultAgent,r]),""},Eden.AST.registerStatement(Eden.AST.Wait),Eden.AST.When=function(){this.type="when",Eden.AST.BaseContext.apply(this),this.name="*When",this.id=0,this.expression=void 0,this.active=!1,this.compiled=void 0,this.scope=void 0,this.nscope=void 0,this.compScope=void 0,this.local=!1,this.dirty=!1,this.statement=void 0,this.enabled=!1,this.statements=[],this.retrigger=!1,this.roles=null,this.triggercount=0,this.refreshtimeout=null,this.triggertimestamp=0},Eden.AST.registerContext(Eden.AST.When),Eden.AST.When.prototype.getSource=function(){return this.statement?this.prefix+this.statement.getSource()+this.postfix:this.prefix+this.postfix},Eden.AST.When.prototype.setSource=function(e,t,n){if(this.start=e,this.end=t,n){this.statement?(this.prefix=n.substring(0,this.statement.start-e),this.postfix=n.substring(this.statement.end-e)):(this.prefix=n.substring(0,t),this.postfix=""),this.numlines=0;for(var r=0;r<this.prefix.length;r++)"\n"==this.prefix.charAt(r)&&this.numlines++;for(r=0;r<this.postfix.length;r++)"\n"==this.postfix.charAt(r)&&this.numlines++}},Eden.AST.When.prototype.getLine=function(){return this.line},Eden.AST.When.prototype.doDebug=function(){return this.doxyComment&&this.doxyComment.getControls()["@debug"]},Eden.AST.When.prototype.setScope=function(e){this.scope=e},Eden.AST.When.prototype.subscribeDynamic=function(e,t,n){return console.log("Subscribe Dyn: ",t,n),n.context.instance.project.addTrigger(this,t,n),n.context.lookup(t)},Eden.AST.When.prototype.setExpression=function(e){this.expression=e,e&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.When.prototype.setStatement=function(e){this.statement=e,e&&(this.statements.push(e),this.errors.push.apply(this.errors,e.errors),e.warning&&!this.warning&&(this.warning=e.warning))},Eden.AST.When.prototype.generate=function(e,t,n){var r=new Eden.RuntimeError(n.scope.context,Eden.RuntimeError.NOTSUPPORTED,this,"Cannot use 'when' here");return this.errors.push(r),n.scope.context.instance.emit("error",[EdenSymbol.defaultAgent,r]),""},Eden.AST.When.prototype.getScope=function(e){if(void 0===this.compScope)if(this.scope)try{this.compScope=new Function(["context","scope"],"var s = "+this.scope.generateConstructor(e,"scope",{bound:!1})+"; s.rebuild(); return s;")}catch(e){}else this.compScope=function(e,t){return new Eden.Scope(e,t,[],!1,null,!1)};return this.compScope},Eden.AST.When.prototype.compile=function(e,t){var n="try { return ";n+=this.expression.generate(this,"scope",{bound:!1,scope:t}),n+="; } catch(e) {}";try{this.compiled=new Function(["context","scope"],n)}catch(e){console.error("Error compiling when condition")}return""},Eden.AST.When.prototype.trigger=function(e,t){if(this.enabled){var n=eden.project.ast;if(0==this.active){if(this.triggercount++,this.triggercount>1e3){"*When"==this.name&&this.parent&&this.parent.name&&(this.name=this.parent.name+">when"),this.enabled=!1;var r=new Eden.RuntimeError(e.context,Eden.RuntimeError.INFINITEWHEN,this);return this.errors.push(r),r.line=this.line,void e.context.instance.emit("error",[this,r])}this.refreshtimeout||(this.refreshtimeout=setTimeout(()=>{this.refreshtimeout=null,this.triggercount=0},5e3)),this.active=!0,e=this.getScope(this)(e.context,e);var i=this.executeReal(this,n,e);if(i&&(void 0===eden.peer||eden.peer.authoriseWhen(this))){this.triggertimestamp=t;var s=this;n.executeStatements(i,-1,this,function(){s.active=!1,s.retrigger&&(s.retrigger=!1,setTimeout(function(){s.trigger(e,Date.now())},0))},this,e)}else this.active=!1}else this.retrigger=!0}},Eden.AST.When.prototype.executeReal=function(e,t,n){this.executed=1,this.compiled||this.compile(t,n),this.doxyComment&&this.doxyComment.getControls()["@local"]&&(this.local=!0),this.locals={};if(n.range){n.range=!1;for(var r=[];;){var i=n.clone();if(this.compiled.call(this,n.context,n)?r.push(new Eden.AST.ScopedScript(this.statement.statements,i)):this.executed=2,0==n.next())break}return n.range=!0,r}if(this.compiled.call(this,n.context,n))return n!==n.context.scope&&"script"==this.statement.type?[new Eden.AST.ScopedScript(this.statement.statements,n)]:[this.statement];this.executed=2},Eden.AST.When.prototype.execute=function(e,t,n,r){if(!this.enabled){this.doxyComment&&this.doxyComment.getControls()["@local"]&&(this.local=!0);let e=n.project();e&&e.registerAgent(this)}this.enabled=!0,n=this.nscope?this.nscope:this.getScope(this)(n.context,n),this.nscope=n,r&&!r.loading&&t.executeStatements(this.executeReal(e,t,n,r),-1,this,void 0,this,n)},Eden.AST.When.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.While=function(){this.type="while",Eden.AST.BaseStatement.apply(this),this.condition=void 0,this.statement=void 0,this.compiled=void 0},Eden.AST.While.prototype.setCondition=function(e){this.condition=e,this.errors.push.apply(this.errors,e.errors)},Eden.AST.While.prototype.setStatement=function(e){this.statement=e,e&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.While.prototype.generate=function(e,t,n){var r="while ("+this.condition.generate(e,t,n);return r+=") ",r+=this.statement.generate(e,t,n)+"\n"},Eden.AST.While.prototype.getCondition=function(ctx,scope){if(this.compiled)return this.compiled;var express=this.condition.generate(ctx,"scope",{bound:!1,scope:scope}),expfunc=eval("(function(context,scope){ return "+express+"; })");return this.compiled=expfunc,expfunc},Eden.AST.While.prototype.execute=function(e,t,n,r){if(this.executed=1,this.getCondition(e)(n.context,n))return[this.statement,this]},Eden.AST.registerStatement(Eden.AST.While),Eden.AST.Query=function(){this.type="query",Eden.AST.BaseStatement.apply(this),Eden.AST.BaseExpression.apply(this),this.selector=void 0,this.observable=void 0,this.restypes=[],this.modexpr=void 0,this.kind="=",this._expr=void 0,this._selector=null,this._modexpr=null},Eden.AST.Query.prototype.setSelector=function(e){this.selector=e,e&&e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Query.prototype.setResultTypes=function(e){this.restypes=e},Eden.AST.Query.prototype.setModify=function(e,t){this.modexpr=e,this.kind=t,e&&e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Query.prototype.generate=function(e,t,n){var r="",i=this.selector.generate(e,t,{bound:!1});if(this.modexpr){var s=new Eden.RuntimeError(t.context,Eden.RuntimeError.NOTSUPPORTED,this,"Cannot use '?' on lhs here");return this.errors.push(s),n.scope.context.instance.emit("error",[EdenSymbol.defaultAgent,s]),""}return r=0==this.restypes.length?"Eden.Selectors.queryWithinSync(null, "+i+', "value", {minimum: 1, options: {self: this.origin}})':"Eden.Selectors.queryWithinSync(null, "+i+', "'+this.restypes.join(",")+'", {minimum: 1, options: {self: this.origin}})',n.bound?"new BoundValue("+r+","+t+")":r},Eden.AST.registerExpression(Eden.AST.Query),Eden.AST.Query.prototype.execute=function(e,t,n,r){if(this.executed=1,this.observable){var i=n.context.lookup(this.observable).value(n);return console.log(i),void(t.lastresult=i)}if(void 0===this.modexpr){if(this._expr)return this._expr;Eden.Selectors.query(this.selector.execute(e,t,n,r),this.restypes,{minimum:1},n=>{t.lastresult=n,this._expr=n[0],e.cb&&e.cb(n)})}else{var s=this.selector.execute(e,t,n,r),o=this.modexpr.execute(e,t,n,r);switch(this.kind){case"=":Eden.Selectors.assign(s,this.restypes,o);break;case"+=":Eden.Selectors.append(s,this.restypes,o);break;case"//=":Eden.Selectors.concat(s,this.restypes,o)}}},Eden.AST.registerStatement(Eden.AST.Query),Eden.AST.Alias=function(){this.type="script",Eden.AST.BaseStatement.apply(this),this.name=void 0,this.active=!1,this.selector=void 0,this._statements=null,this.lock=1},Eden.AST.Alias.prototype.setName=function(e){this.name=e},Eden.AST.Alias.prototype.setSelector=function(e){this.selector=e,e&&e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Alias.prototype.setAttributes=function(e){return!0},Eden.AST.Alias.prototype.execute=function(e,t,n,r){var i=[];if(this.executed=1,this.locals&&this.locals.list.length>0){void 0===e.locals&&(e.locals={});for(var s=0;s<this.locals.list.length;s++)e.locals[this.locals.list[s]]=new Eden.AST.Local(this.locals.list[s])}for(s=0;s<this.statements.length;s++)"script"!=this.statements[s].type&&"section"!=this.statements[s].type&&i.push(this.statements[s]);return i},Eden.AST.Alias.prototype.generate=function(e,t,n){},Eden.AST.registerScript(Eden.AST.Alias),Eden.AST.Alias.prototype.getNumberOfLines=function(){return this.numlines},Object.defineProperty(Eden.AST.Alias.prototype,"statements",{get:function(){if(!this._statements&&this.selector){var e=this.selector.execute(this,eden.project?eden.project.ast:{},eden.root.scope,this);Eden.Selectors.query(e,void 0,{minimum:1},e=>{1==e.length&&"script"==e[0].type?(this._statements=e[0].statements,e[0].parent=this.parent):this._statements=e;for(let e=0;e<this._statements.length;e++)"dummy"!=this._statements[e].type&&this._statements[e].addIndex()})}return this._statements?this._statements:[]}}),Eden.AST.Alias.addIndex=function(){this.buildID(),Eden.Index.update(this)},Eden.AST.Alias.removeIndex=function(){Eden.Index.remove(this)},Eden.AST.Alias.prototype.destroy=function(){if(this.executed<1&&Eden.Index.remove(this),this._statements)for(var e=0;e<this._statements.length;e++)this._statements[e].destroy();this.executed=-1,this._statements=void 0,this.base=void 0,this.parent=void 0,this.nextSibling=void 0,this.previousSibling=void 0},Eden.AST.Alias.prototype.getInnerSource=function(){for(var e="",t=0;t<this._statements.length;t++)e+=this._statements[t].getSource();return e},Eden.AST.Indexed=function(){this.type="indexed",Eden.AST.BaseExpression.apply(this),this.indexes=[],this.expression=void 0},Eden.AST.Indexed.prototype.left=Eden.AST.fnEdenASTleft,Eden.AST.Indexed.prototype.setExpression=function(e){this.expression=e,this.mergeExpr(e),this.typevalue=0},Eden.AST.Indexed.prototype.addIndex=function(e){this.indexes.push(e),this.mergeExpr(e)},Eden.AST.Indexed.prototype.toEdenString=function(e,t){for(var n="",r=0;r<this.indexes.length;r++)n+=this.indexes[r].toEdenString(e,t);return"("+this.expression.toEdenString(e,t)+")"+n},Eden.AST.Indexed.prototype.generate=function(e,t,n){for(var r="",i=0;i<this.indexes.length;i++)r+=this.indexes[i].generate(e,t,n);var s="("+this.expression.generate(e,t,n)+")"+r;return n.bound?"new BoundValue("+s+","+t+")":s},Eden.AST.registerExpression(Eden.AST.Indexed),Eden.AST.Section=function(){this.type="section",Eden.AST.BaseStatement.apply(this),this.name=void 0,this.depth=1},Eden.AST.Section.prototype.setName=function(e){this.name=e;var t=e.match(/#[\w]+/g);null!==t&&(void 0===this.tags?this.tags=t:this.tags=this.tags.concat(t))},Eden.AST.Section.prototype.generate=function(e,t){return""},Eden.AST.Section.prototype.execute=function(e,t,n,r){for(var i=[],s=this.nextSibling;s&&("section"!=s.type||s.depth>this.depth);)"dummy"!=s.type&&"script"!=s.type&&"section"!=s.type&&i.push(s),s=s.nextSibling;return i},Eden.AST.registerStatement(Eden.AST.Section),Eden.AST.Section.prototype.getRange=function(e){for(var t=this.getStartLine(e),n=this.nextSibling;n&&n.nextSibling&&("section"!=n.nextSibling.type||n.nextSibling.depth>this.depth);)n=n.nextSibling;return n&&"dummy"==n.type&&(n=n.previousSibling),[t,n?n.getEndLine(e):t+this.getNumberOfLines()]},Eden.AST.CustomBlock=function(){this.type="custom",Eden.AST.BaseStatement.apply(this),this.name=null,this.text=null},Eden.AST.CustomBlock.prototype.setName=function(e){this.name=e;var t=e.match(/#[\w]+/g);null!==t&&(void 0===this.tags?this.tags=t:this.tags=this.tags.concat(t))},Eden.AST.CustomBlock.prototype.generate=function(e,t){return""},Eden.AST.CustomBlock.prototype.execute=function(e,t,n,r){this.executed=1,n.context.lookup("script_"+this.name+"_execute").assign(this.text,n);return[]},Eden.AST.registerStatement(Eden.AST.CustomBlock),Eden.AST.Async=function(){this.type="async",Eden.AST.BaseExpression.apply(this),this.expression=null},Eden.AST.Async.prototype.setExpression=function(e){this.expression=e,e&&e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Async.prototype.generate=function(e,t){return this.expression.generate(e,t,{bound:!1})},Eden.AST.Async.prototype.execute=function(e,t,n){},Eden.AST.registerExpression(Eden.AST.Async);var htmltags={h1:!0,h2:!0,h3:!0,h4:!0,h5:!0,h6:!0,input:!0,form:!0,p:!0,div:!0,span:!0,b:!0,i:!0,ul:!0,ol:!0,li:!0,button:!0,a:!0,img:!0,canvas:!0,video:!0};function patchDOM(e,t,n){if(t&&e){if("string"==typeof t||"number"==typeof t){if(e.childNodes[n]&&"#text"==e.childNodes[n].nodeType)return void(e.childNodes[n].textContent!=t&&(e.childNodes[n].textContent=t));t=document.createTextNode(t)}if(Array.isArray(t)){for(var r=0,i=0;i<t.length;i++)r+=patchDOM(e,t[i],n+i);return r}if(!e.childNodes||e.childNodes.length<=n)try{e.appendChild(t)}catch(e){}else if(e.childNodes[n]===t);else{console.log("PATCH DOM",t);try{e.replaceChild(t,e.childNodes[n])}catch(e){}}return 1}}rt.patchDOM=patchDOM,rt.cleanDOM=function(e,t){if(e&&e.childNodes)for(;e.childNodes.length>t;)e.removeChild(e.lastChild)};var classSym=Symbol("classname"),classcount=1;function cssFromObject(e){var t=[],n="{";for(var r in e){var i=r.charAt(0);":"==i||"."==i||"#"==i||"@"==i?t.push(r+cssFromObject(e[r]).join(r+": ")):htmltags.hasOwnProperty(r.split(/\s|\.|#|:/)[0])?t.push(r+" "+cssFromObject(e[r]).join(r+": ")):n+=camel2Dash(r)+": "+e[r]+";\n"}return[n+"}\n"].concat(t)}rt.setStyle=function(e,t){if("string"==typeof t)e.setAttribute("style",t);else{var n,r=document.getElementById("dynastyles");r||((r=document.createElement("style")).setAttribute("id","dynastyles"),document.head.appendChild(r));var i=r.sheet;(n=t[classSym])||(n="class"+classcount,classcount++,t[classSym]=n);for(var s=cssFromObject(t),o=0;o<s.length;o++){var a=s[o].charAt(0);":"==a||"."==a||"#"==a?i.insertRule("."+n+s[o],i.cssRules.length):i.insertRule("."+n+" "+s[o],i.cssRules.length)}if(n){var d=e.className?e.className.split(" "):[];-1==d.indexOf(n)&&(d.push(n),e.className=d.join(" "))}}};var attributemapping={class:"className"},svgtags={svg:!0,rect:!0};function _diff(e,t){var n=new diff_match_patch,r=n.diff_main(e,t);n.diff_cleanupSemantic(r);for(var i="",s=0,o=0;o<r.length;o++){var a=r[o][1].match(/[\n]+/g);if(0!=r[o][0]){if(1==r[o][0])i+="<div>line:"+(s+1)+' + <span style="background: #ddffdd;">'+EdenUI.Highlight.html(r[o][1])+"</span></div>",null!==a&&(s+=a.length);else if(2==r[o][1]){i+="<div>line:"+(s+1)+' - <span style="background: #ffdddd;">'+EdenUI.Highlight.html(r[o][1])+"</span></div>",null!==a&&(s-=a.length)}}else null!==a&&(s+=a.length)}return i}function sortByCount(e){var t=e.reduce(function(e,t){return e[t]=(e[t]||0)+1,e},{});return Object.keys(t).sort(function(e,n){return t[e]<t[n]})}function reduceByCount(e,t){var n=e.reduce(function(e,t){return e[t]=(e[t]||0)+1,e},{}),r=[];for(var i in n)n[i]>=t&&r.push(i);return r}function negativeFilter(e,t){for(var n=t.reduce(function(e,t){return e[t]=(e[t]||0)+1,e},{}),r=[],i=0;i<e.length;i++)n[e[i]]||r.push(e[i]);return r}function sortByLoaded(e){for(var t=[],n=[],r=0;r<e.length;r++)Eden.Agent.agents[e[r]]?t.push(e[r]):n.push(e[r]);return t.push.apply(t,n),t}function runEdenAction(e,t,n,r){var i=this;void 0===n&&(e.active=!1);var s=n.next();if(0==s.done)if("object"==typeof s.value){if(Eden.AST.debug&&"debug"===s.value.type){s.value.next=function(){runEdenAction.call(i,e,t,n,r)},s.value.statement&&Eden.AST.debugbreakpoint===s.value.statement?Eden.AST.debugbreakpoint_cb&&Eden.AST.debugbreakpoint_cb(s.value):Eden.AST.debugstep_cb&&setTimeout(function(){Eden.AST.debugstep_cb(s.value)},0)}else if("import"===s.value.type)s.value.executed=1,Eden.Selectors.query(s.value.selector,void 0,{context:s.value.parent,minimum:1,options:{external:!0,index:!0}},function(o){if(void 0===o){var a=new Eden.RuntimeError(i,Eden.RuntimeError.UNKNOWN,s.value,"Selector '"+s.value.selector+"' has no results");a.line=s.value.line,s.value.errors.push(a)}else s.value.statements=o;runEdenAction.call(i,e,t,n,r)});else if("query"===s.value.type){function o(s){runEdenAction.call(i,e,t,n,r)}switch(s.value.kind){case"=":Eden.Selectors.assign(s.value._selector,s.value.restypes,s.value._modexpr,s.value,o);break;case"+=":Eden.Selectors.append(s.value._selector,s.value.restypes,s.value._modexpr,s.value,o);break;case"//=":Eden.Selectors.concat(s.value._selector,s.value.restypes,s.value._modexpr,s.value,o)}}else if("do"===s.value.type){function o(o){if(o&&o.length>0){s.value.params;var a=s.value.nscope;if(a||(a=t),s.value.attribs.atomic&&t.context.beginAutocalcOff(),a.range){a.range=!1;for(var d=[];;){var c=a.clone();if(d.push(new Eden.AST.ScopedScript(o,c)),0==a.next())break}a.range=!0,i.executeStatements(d,void 0,e,function(){s.value.attribs.atomic&&t.context.endAutocalcOff(),runEdenAction.call(i,e,t,n,r)},{locals:{}},a)}else i.executeStatements(o,void 0,e,function(){s.value.attribs.atomic&&t.context.endAutocalcOff(),runEdenAction.call(i,e,t,n,r)},{locals:{}},a)}else{var h=new Eden.RuntimeWarning(s.value,Eden.RuntimeWarning.EMPTYDO,s.value.selector);h.line=s.value.line,s.value.warning=h,t.context.instance.emit("warning",[e,h]),s.value.attribs.atomic&&t.context.endAutocalcOff(),runEdenAction.call(i,e,t,n,r)}}s.value.statements?o(s.value.statements):s.value.name?Eden.Selectors.query(s.value.selector,void 0,{options:{self:s.value},context:s.value.parent,minimum:1},o):o(s.value.script.statements)}}else 0===s.value?runEdenAction.call(this,e,t,n,r):s.value>0&&setTimeout(function(){runEdenAction.call(i,e,t,n,r)},s.value);else e.active=!1,r&&r()}Eden.AST.HTML=function(){this.type="html",this.errors=[],this.name=null,this.attributes=null,this.contents=null},Eden.AST.HTML.prototype.setName=function(e){this.name=e},Eden.AST.HTML.prototype.generate=function(e,t,n){var r="(function($o) {\n",i=null;if(this.attributes&&this.attributes.hasOwnProperty("xmlns")?i=this.attributes.xmlns.value:parent&&parent.attributes&&parent.attributes.hasOwnProperty("xmlns")?i=parent.attributes.xmlns.value:svgtags.hasOwnProperty(this.name.toLowerCase())?i="http://www.w3.org/2000/svg":parent&&svgtags.hasOwnProperty(parent.name)&&(i="http://www.w3.org/2000/svg"),r+=null!==i?'let ele = ($o) ? $o : document.createElementNS("'+i+'", "'+this.name+'");\n':'let ele = ($o && $o.nodeName == "'+this.name+'") ? $o : document.createElement("'+this.name+'");\n',null!==this.attributes)for(var s in this.attributes)"xmlns"!=s&&(s.startsWith("on")?"primary"!=this.attributes[s].type||(void 0===this.attributes[s].backticks?r+='ele["'+s.toLowerCase()+'"] = function(e) { eden.root.lookup("'+this.attributes[s].observable+'").assign(true, eden.root.scope, EdenSymbol.hciAgent); };\n':r+='ele["'+s.toLowerCase()+'"] = function(e) { eden.root.lookup('+this.attributes[s].backticks.generate(e,t,n)+").assign(true, eden.root.scope, EdenSymbol.hciAgent); };\n"):r+="style"==s?"rt.setStyle(ele, "+this.attributes[s].generate(e,t,n)+");\n":'ele.setAttribute("'+s+'",'+this.attributes[s].generate(e,t,n)+");\n");if(null!==this.contents){r+="let count=0;\n";for(var o=0;o<this.contents.length;o++)r+="let item = "+this.contents[o].generate(e,t,n),"html"==this.contents[o].type?r+="(ele.childNodes["+o+"]);\n":r+=";\n",r+="count += rt.patchDOM(ele, item, count);\n";r+="rt.cleanDOM(ele, count);\n"}return r+="return ele;\n})(this.cache.value)"},Eden.AST.HTML.prototype.addAttribute=function(e,t){null===this.attributes&&(this.attributes={}),t.errors.length>0&&this.errors.push.apply(this.errors,t.errors),this.attributes[e]=t},Eden.AST.HTML.prototype.addContent=function(e){null===this.contents&&(this.contents=[]),this.contents.push(e),e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.prototype.pACTIONBODY=function(){var e=new Eden.AST.CodeBlock,t=this.parent;return this.parent=e,"{"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONOPEN)),this.parent=t,e):(this.next(),e.setLocals(this.pLOCALS()),e.locals.errors.length>0?(this.parent=t,e):(e.setScript(this.pSCRIPT()),"}"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)),this.parent=t,e):(this.next(),this.parent=t,e)))},Eden.AST.prototype.pAFTER=function(){var e=new Eden.AST.After;if("("!=this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.AFTEROPEN)),e;this.next();var t=this.pEXPRESSION();if(e.setExpression(t),e.errors.length>0)return e;if(")"!=this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.AFTEROPEN)),e;this.next();var n=this.pSTATEMENT();return void 0===n&&e.error(new Eden.SyntaxError(this,Eden.SyntaxError.AFTERNOSTATEMENT)),e.setStatement(n),e.warning=new Eden.SyntaxWarning(this,e,Eden.SyntaxWarning.DEPRECATED,"'after' should not be used, use 'wait' instead"),e},Eden.AST.prototype.pATTRIBUTES=function(){if("["!=this.token)return"OBSERVABLE"!=this.token?{errors:new Eden.SyntaxError(this,Eden.SyntaxError.DOBADATTRIB)}:((e={})[this.data.value]=!0,this.next(),e);this.next();for(var e={};;){if("OBSERVABLE"!=this.token)return{errors:new Eden.SyntaxError(this,Eden.SyntaxError.DOBADATTRIB)};if(e[this.data.value]=!0,this.next(),","!=this.token)break;this.next()}return"]"!=this.token?{error:new Eden.SyntaxError(this,Eden.SyntaxError.DOATTRIBCLOSE)}:(this.next(),e)},Eden.AST.prototype.pPARAMS=function(){var e=new Eden.AST.Declarations;for(e.kind="oracle";"para"==this.token||"oracle"==this.token;){this.next();var t=this.pOLIST();if(e.list.push.apply(e.list,t),0==t.length||"NONAME"==t[t.length-1])return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.PARAMNAME)),e;if(";"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.PARAMSEMICOLON)),e;this.next()}return e},Eden.AST.prototype.pLOCALS=function(){var e=new Eden.AST.Declarations;for(e.kind="local";"auto"===this.token||"local"===this.token;){if(this.next(),"when"===this.token)return this.next(),this.localStatus=!0,e=this.pWHEN(),this.localStatus=!1,e;var t=this.pOLIST();if(e.list.push.apply(e.list,t),0===t.length||"NONAME"===t[t.length-1])return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LOCALNAME)),e;if(";"!==this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LOCALSEMICOLON)),e;this.next()}return e},Eden.AST.prototype.pEXEC=function(){var e=new Eden.AST.Do,t=this.parent;if(this.parent=e,"["==this.token){var n=this.pATTRIBUTES();if(!e.setAttributes(n))return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.DOBADATTRIB)),this.parent=t,e}if("("!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)),this.parent=t,e;this.next();var r=this.pEXPRESSION();return e.setLiteral(r),")"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)),this.parent=t,e):(this.next(),"with"!=this.token&&"::"!=this.token||(this.next(),e.setScope(this.pSCOPE())),";"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)),this.parent=t,e):(this.next(),this.parent=t,e))},Eden.AST.prototype.pDO=function(){var e=new Eden.AST.Do,t=this.parent;if(this.parent=e,"["==this.token){var n=this.pATTRIBUTES();if(!e.setAttributes(n))return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.DOBADATTRIB)),this.parent=t,e}if("{"==this.token){this.next();var r=this.pSCRIPT();return r.parent=e,"}"!=this.token?(e.setScript(r),e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)),this.parent=t,e):(this.next(),e.setScript(r),this.parent=t,"with"!=this.token&&"::"!=this.token||(this.next(),e.setScope(this.pSCOPE())),e)}if("OBSERVABLE"!=this.token&&"."!=this.token&&">>"!=this.token&&">"!=this.token&&"<"!=this.token&&"<<"!=this.token&&":"!=this.token&&"*"!=this.token&&"@"!=this.token&&"#"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.DONAME)),this.parent=t,e;var i=this.pCODESELECTOR();return e.setName(i),e.errors.length>0?(this.parent=t,e):("with"!=this.token&&"::"!=this.token||(this.next(),e.setScope(this.pSCOPE())),";"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)),this.parent=t,e):(this.next(),this.parent=t,e))},Eden.AST.prototype.pEXPRESSION_PPPPP=function(){if("#"==this.token)return this.next(),new Eden.AST.Length},Eden.AST.prototype.pEXPRESSION_PPPPPP=function(){if("if"===this.token){this.next();var e=new Eden.AST.TernaryOp("?");return e.setCondition(this.pEXPRESSION()),e.errors.length>0?e:"else"!==this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.TERNIFCOLON)),e):(this.next(),e.setSecond(this.pEXPRESSION()),e)}},Eden.AST.prototype.pEXPRESSION_PLAIN=function(){for(var e=this.pTERM();this.stream.valid();)switch(this.token){case"&&":case"||":case"&":case"|":case"and":case"or":var t=new Eden.AST.BinaryOp(this.token);this.next(),t.left(e),t.setRight(this.pTERM()),e=t;continue;default:return e}return e},Eden.AST.prototype.pEXPRESSION_ASYNC=function(){var e;return"sync"===this.token?(this.next(),(e=new Eden.AST.Async).setExpression(this.pEXPRESSION())):e=this.pEXPRESSION(),e},Eden.AST.prototype.pFUNC_EXPR=function(){let e;if(this.next(),"{"!==this.token){var t=new Eden.AST.ScriptExpr;return t.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONOPEN)),t}return this.next(),e=this.pSCRIPTEXPR(),"}"!==this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)),e):(this.next(),e)},Eden.AST.prototype.pEXPRESSION=function(){var e;if("sync"===this.token)return(e=new Eden.AST.Async).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SYNCNOTALLOWED)),e;switch(this.token){case"func":e=this.pFUNC_EXPR();break;case"action":return e=this.pFUNC_EXPR();default:e=this.pEXPRESSION_PLAIN()}for(;"with"===this.token||"::"===this.token;){this.next(),e.isscoped&&this.syntaxWarning(e,Eden.SyntaxWarning.NESTEDSCOPE,"Should not chain scopes in single expression");var t=this.pSCOPE();t.setExpression(e),e.isconstant&&!t.range&&t.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BADEXPRTYPE)),e=t}return e},Eden.AST.prototype.pFACTOR_SUBEXP=function(){this.next();var e=this.pEXPRESSION();if(e.errors.length>0)return e;if(")"!==this.token?e.error(new Eden.SyntaxError(this,Eden.SyntaxError.EXPCLOSEBRACKET)):this.next(),"["===this.token||"."===this.token||"("===this.token){var t=this.pINDEXED();return t.setExpression(e),t}return e},Eden.AST.prototype.pFACTOR_OBJECTLITERAL=function(){this.next();var e={};"}"!==this.token&&(e=this.pLLIST());var t=new Eden.AST.Literal("OBJECT",e);for(var n in e){var r=e[n];t.mergeExpr(r)}return t.typevalue=Eden.AST.TYPE_OBJECT,t.errors.length>0?t:("}"!==this.token?t.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LISTLITCLOSE)):this.next(),t)},Eden.AST.prototype.pFACTOR_LISTLITERAL=function(){this.next();var e=[];"]"!==this.token&&(e=this.pELIST());for(var t=new Eden.AST.Literal("LIST",e),n=0;n<e.length;n++)t.mergeExpr(e[n]);return t.typevalue=Eden.AST.TYPE_LIST,t.errors.length>0?t:("]"!==this.token?t.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LISTLITCLOSE)):this.next(),t)},Eden.AST.prototype.pFACTOR_UNDEFINED=function(){return this.next(),new Eden.AST.Literal("UNDEFINED","@")},Eden.AST.prototype.pFACTOR_JAVASCRIPT=function(){var e=new Eden.AST.Literal("JAVASCRIPT",this.data.value);return this.next(),e},Eden.AST.prototype.pFACTOR_NUMBER=function(){var e=new Eden.AST.Literal("NUMBER",this.data.value);return this.next(),e},Eden.AST.prototype.pFACTOR_STRING=function(){var e=new Eden.AST.Literal("STRING",this.data.value);for(this.data.error||this.next();0==this.data.error&&"STRING"==this.token;)e.value+="\n"+this.data.value,this.next();return this.data.error&&("LINEBREAK"===this.data.value?e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LITSTRLINE)):e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LITSTRCLOSE))),e},Eden.AST.prototype.pFACTOR_HEREDOC=function(){if(this.next(),"OBSERVABLE"!==this.token)return(i=new Eden.AST.Literal("STRING",this.data.value)).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.HEREDOCTOKEN)),i;var e=this.data.value;if(10!=this.stream.get())return(i=new Eden.AST.Literal("STRING",this.data.value)).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.HEREDOCTOKEN)),i;for(var t="";this.stream.valid();){var n=this.stream.position,r=this.stream.readLine();if(r.startsWith(e)){this.stream.position=n;break}t+=r}var i=new Eden.AST.Literal("STRING",t.slice(0,-1));return this.stream.valid()?(this.next(),this.next(),i):(i.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.NEWLINE)),i)},Eden.AST.prototype.pFACTOR_BOOLEAN=function(){var e=new Eden.AST.Literal("BOOLEAN",this.data.value);return this.next(),e},Eden.AST.prototype.pFACTOR_NEGATION=function(){if(this.next(),"NUMBER"===this.token){var e=new Eden.AST.Literal("NUMBER",-this.data.value);return this.next(),e}var t=this.pFACTOR(),n=new Eden.AST.UnaryOp("-",t);return 0!==t.typevalue&&t.typevalue!==Eden.AST.TYPE_NUMBER&&this.typeWarning(n,Eden.AST.TYPE_NUMBER,t.typevalue),n},Eden.AST.prototype.pFACTOR_QUERY=function(){this.next();var e=this.pQUERY();if("["===this.token){var t=this.pINDEXED();return t.setExpression(e),t}return e},Eden.AST.prototype.pFACTOR_HTML=function(){return this.pHTML()},Eden.AST.prototype.pFACTOR_NOT=function(){this.next();var e=this.pFACTOR();return new Eden.AST.UnaryOp("!",e)},Eden.AST.prototype.pFACTOR_DEREFERENCE=function(){if(this.next(),"("===this.token){this.next();let e=this.pFACTOR_PRIMARY();return")"!==this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.EXPCLOSEBRACKET)),e):(this.next(),new Eden.AST.UnaryOp("*",e))}{let t=this.pPRIMARY(),n=new Eden.AST.UnaryOp("*",t);if("["===this.token||"."===this.token||"("===this.token){var e=this.pINDEXED();return e.setExpression(n),e}return n}},Eden.AST.prototype.pFACTOR_DEREFERENCE_NOIX=function(){if(this.next(),"("===this.token){this.next();let e=this.pFACTOR_PRIMARY();return")"!==this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.EXPCLOSEBRACKET)),e):(this.next(),new Eden.AST.UnaryOp("*",e))}{let e=this.pPRIMARY();return new Eden.AST.UnaryOp("*",e)}},Eden.AST.prototype.pFACTOR_ADDRESSOF=function(){this.next();var e=this.pLVALUE();return e.lvaluep&&e.lvaluep.length>0&&e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),new Eden.AST.UnaryOp("&",e)},Eden.AST.prototype.pFACTOR_BUILTIN=function(){var e=this.token;if(this.next(),"("!==this.token)return(t=new Eden.AST.UnaryOp(e,null)).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.EVALCLOSE)),t;this.next();var t,n=this.pEXPRESSION();return(t=new Eden.AST.UnaryOp(e,n)).isconstant&&0!=t.typevalue&&t.typevalue!=Eden.AST.TYPE_STRING&&this.typeWarning(t,Eden.AST.TYPE_STRING),")"!==this.token?(t.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.EVALCLOSE)),t):(this.next(),t)},Eden.AST.prototype.pFACTOR_SUBSTITUTION=function(){this.next();var e=this.pEXPRESSION(),t=new Eden.AST.UnaryOp("sub",e);if("}"!==this.token)return t.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.EVALCLOSE)),t;if(this.next(),"["===this.token||"."===this.token||"("===this.token){var n=this.pINDEXED();return n.setExpression(t),n}return t},Eden.AST.prototype.pFACTOR_PRIMARY=function(){let e=this.pPRIMARY();if(e.errors.length>0)return e;if("["===this.token||"."===this.token||"("===this.token){var t=this.pINDEXED();return t.setExpression(e),t}return e},Eden.AST.prototype.pFACTOR_TYPED_TSTRING=function(){if(this.next(),"OBSERVABLE"!==this.token){let e=new Eden.AST.Literal("UNDEFINED");return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e}this.data.value;if(this.next(),"'"!==this.token){let e=new Eden.AST.Literal("UNDEFINED");return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e}return this.pTEMPLATE_STRING(!0)},Eden.AST.prototype.pFACTOR=function(){switch(this.token){case"(":return this.pFACTOR_SUBEXP();case"{":return this.pFACTOR_OBJECTLITERAL();case"[":return this.pFACTOR_LISTLITERAL();case"@":return this.pFACTOR_UNDEFINED();case"JAVASCRIPT":return this.pFACTOR_JAVASCRIPT();case"NUMBER":return this.pFACTOR_NUMBER();case"?":return this.pFACTOR_QUERY();case"-":return this.pFACTOR_NEGATION();case"<":return this.pFACTOR_HTML();case"<<":return this.pFACTOR_HEREDOC();case"%":return this.pFACTOR_TYPED_TSTRING();case"'":return this.pTEMPLATE_STRING(!0);case"STRING":return this.pFACTOR_STRING();case"BOOLEAN":return this.pFACTOR_BOOLEAN();case"!":case"not":return this.pFACTOR_NOT();case"&":return this.pFACTOR_ADDRESSOF();case"*":return this.pFACTOR_DEREFERENCE();case"eval":case"parse":case"compile":return this.pFACTOR_BUILTIN();case"${":return this.pFACTOR_SUBSTITUTION();default:return this.pFACTOR_PRIMARY()}},Eden.AST.prototype.pFOR=function(){var e=new Eden.AST.For,t=this.parent;if(this.parent=e,"("!==this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.FOROPEN)),this.parent=t,e;if(this.next(),";"===this.token)this.next();else{if(e.setStart(this.pSTATEMENT_P(!0)),e.errors.length>0)return this.parent=t,e;if("range"!==e.sstart.type&&";"!==this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.FORSTART)),this.parent=t,e;";"===this.token&&this.next()}if(e.sstart&&"range"===e.sstart.type){if(")"!==this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.FORCLOSE)),this.parent=t,e;this.next()}else{if(";"===this.token)this.next();else{if(e.setCondition(this.pEXPRESSION()),e.errors.length>0)return this.parent=t,e;if(";"!==this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.FORCOND)),this.parent=t,e;this.next()}if(")"===this.token)this.next();else{if(e.setIncrement(this.pSTATEMENT_P()),e.errors.length>0)return this.parent=t,e;if(")"!==this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.FORCLOSE)),this.parent=t,e;this.next()}}return";"!==this.token?(e.setStatement(this.pSTATEMENT()),e.statement&&(e.statement.parent=e)):this.next(),e.parent=t,this.parent=t,e},Eden.AST.prototype.pFUNCTION=function(){var e=new Eden.AST.Assignment,t=this.parent;this.parent=e;this.token;if(this.next(),"OBSERVABLE"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.FUNCNAME)),this.parent=t,e;var n=new Eden.AST.LValue;if(n.setObservable(this.data.value),this.next(),":"==this.token){this.next();var r=this.pATTRIBUTES();if(!n.setAttributes(r))return n.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.FUNCNAME)),e.left(n),this.parent=t,e}if(e.left(n),"{"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.FUNCOPEN)),this.parent=t,e;this.next();var i=this.pSCRIPTEXPR();return e.setExpression(i),"}"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)),this.parent=t,i):(this.next(),this.parent=t,e)},Eden.AST.prototype.pIF=function(){var e=new Eden.AST.If;e.parent=this.parent;var t=this.parent;return this.parent=e,e.setCondition(this.pEXPRESSION()),e.errors.length>0?(this.parent=t,e):(e.setStatement(this.pSTATEMENT()),e.errors.length>0?(this.parent=t,e):void 0===e.statement?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.IFNOSTATEMENT)),this.parent=t,e):(e.setElse(this.pIF_P()),this.parent=t,e))},Eden.AST.prototype.pIF_P=function(){if("else"==this.token)return this.next(),this.pSTATEMENT()},Eden.AST.prototype.pREQUIRE=function(){var e=new Eden.AST.Require,t=this.pEXPRESSION();return e.setExpression(t),e.warning=new Eden.SyntaxWarning(this,e,Eden.SyntaxWarning.DEPRECATED,"require."),";"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)),e):(this.next(),e)},Eden.AST.prototype.pIMPORT=function(){var e=new Eden.AST.Import;e.warning=new Eden.SyntaxWarning(this,e,Eden.SyntaxWarning.DEPRECATED,"use of import, use action alias instead");var t=this.pCODESELECTOR();return void 0===t||t.errors.length>0?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.IMPORTPATH)),e):(e.setPath(t),";"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)),e):(this.next(),e))},Eden.AST.prototype.pINSERT=function(){var e=new Eden.AST.Insert;return"("!=this.token?this.deprecated(e,"'insert' should use brackets: 'insert(a,b,c)'"):this.next(),e.setDest(this.pLVALUE()),e.errors.length>0?e:","!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.INSERTCOMMA)),e):(this.next(),e.setIndex(this.pEXPRESSION()),e.errors.length>0?e:","!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.INSERTCOMMA)),e):(this.next(),e.setValue(this.pEXPRESSION()),e.errors.length>0?e:(")"==this.token&&this.next(),";"!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)),e):(this.next(),e))))},Eden.AST.prototype.pDELETE=function(){var e=new Eden.AST.Delete;return"("!=this.token?this.deprecated(e,"'delete' should use brackets: 'delete(a,b)'"):this.next(),e.setDest(this.pLVALUE()),e.errors.length>0?e:","!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.DELETECOMMA)),e):(this.next(),e.setIndex(this.pEXPRESSION()),e.errors.length>0?e:(")"==this.token&&this.next(),";"!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)),e):(this.next(),e)))},Eden.AST.prototype.pAPPEND=function(){var e=new Eden.AST.Append;return"("!=this.token?this.deprecated(e,"'append' should use brackets: 'append(a,b)'"):this.next(),e.setDest(this.pLVALUE()),e.errors.length>0?e:","!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.APPENDCOMMA)),e):(this.next(),e.setIndex(this.pEXPRESSION()),e.errors.length>0?e:(")"==this.token&&this.next(),";"!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)),e):(this.next(),e)))},Eden.AST.prototype.pSHIFT=function(){var e=new Eden.AST.Shift;return"("!=this.token?this.deprecated(e,"'shift' should use brackets: 'shift(a)'"):this.next(),e.setDest(this.pLVALUE()),e.errors.length>0?e:(")"==this.token&&this.next(),";"!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)),e):(this.next(),e))},Eden.AST.prototype.pELIST=function(){var e=this.pEXPRESSION();if(e.errors.length>0)return[e];var t=this.pELIST_P();return t.unshift(e),t},Eden.AST.prototype.pELIST_P=function(){for(var e=[];","==this.token;){this.next();var t=this.pEXPRESSION();if(e.push(t),t.errors.length>0)return e}return e},Eden.AST.prototype.pLLIST=function(){if("OBSERVABLE"!=this.token){var e=new Eden.AST.Literal("UNDEFINED");return this.syntaxError(e,Eden.SyntaxError.UNKNOWN),{__error__:e}}var t=this.data.value;if(this.next(),":"!=this.token){e=new Eden.AST.Literal("UNDEFINED");return this.syntaxError(e,Eden.SyntaxError.UNKNOWN),{label:e}}this.next();var n,r=this.pEXPRESSION();return r.errors.length>0?((n={})[t]=r,n):((n=this.pLLIST_P()).hasOwnProperty(t)?(this.syntaxError(r,Eden.SyntaxError.UNKNOWN),n[t]=r):n[t]=r,n)},Eden.AST.prototype.pLLIST_P=function(){for(var e={};","==this.token;){if(this.next(),"OBSERVABLE"!=this.token){var t=new Eden.AST.Literal("UNDEFINED");return this.syntaxError(t,Eden.SyntaxError.UNKNOWN),{__error__:t}}var n=this.data.value;if(this.next(),":"!=this.token){t=new Eden.AST.Literal("UNDEFINED");return this.syntaxError(t,Eden.SyntaxError.UNKNOWN),{label:t}}this.next();var r=this.pEXPRESSION();if(e.hasOwnProperty(n)?(this.syntaxError(r,Eden.SyntaxError.UNKNOWN),e[n]=r):e[n]=r,r.errors.length>0)return e}return e},Eden.AST.prototype.pOLIST=function(){if("OBSERVABLE"!=this.token)return[];var e=this.data.value;this.next();var t=this.pOLIST_P();return t.unshift(e),t},Eden.AST.prototype.pOLIST_P=function(){for(var e=[];","==this.token;){if(this.next(),"OBSERVABLE"!=this.token)return e.push("NONAME"),e;e.push(this.data.value),this.next()}return e},Eden.AST.prototype.pLVALUE_P=function(){for(var e=[];;)if("["===this.token){this.next();var t=new Eden.AST.LValueComponent("index"),n=this.pEXPRESSION();if(t.index(n),e.push(t),n.errors.length>0&&t.errors.unshift(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXEXP)),"literal"==t.indexexp.type&&"NUMBER"==t.indexexp.datatype&&t.indexexp.value<1&&t.error(new Eden.SyntaxError(this,Eden.SyntaxError.OUTOFBOUNDS)),"]"!==this.token)return t.error(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXCLOSE)),e;this.next()}else{if("."!==this.token)break;this.next();t=new Eden.AST.LValueComponent("index");if("OBSERVABLE"!=this.token)return t.errors.unshift(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXEXP)),e.push(t),e;n=new Eden.AST.Literal("STRING",this.data.value);this.next(),t.index(n),e.push(t)}return e},Eden.AST.prototype.pLVALUE=function(){var e=new Eden.AST.LValue;if("*"===this.token){let t=this.pFACTOR_DEREFERENCE_NOIX();e.setPrimary(t)}else if("`"===this.token){var t;if(this.version===Eden.AST.VERSION_CS2){if(this.next(),t=this.pEXPRESSION(),this.deprecated(t,"Backticks are now identifier templates"),"`"!==this.token)return(n=new Eden.AST.Primary).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BACKTICK)),n;this.next()}else t=this.pTEMPLATE_STRING(!1);if(0!=t.typevalue&&t.typevalue!=Eden.AST.TYPE_STRING){var n=new Eden.AST.Primary;this.typeWarning(n,Eden.AST.TYPE_STRING,t.typevalue)}if(e.setExpression(t),e.errors.length>0)return e}else{if("OBSERVABLE"!==this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.LVALUE)),e;var r=this.data.value;if(this.next(),"{"===this.token&&this.version===Eden.AST.VERSION_CS2){var i=this.pDEPRECATED_BTICK(r);this.deprecated(i,"Backticks are now identifier templates"),e.setExpression(i)}else e.setObservable(r);if(":"===this.token){this.next();var s=this.pATTRIBUTES();if(!e.setAttributes(s))return this.syntaxError(e,Eden.SyntaxError.DOBADATTRIB),e}}return e.setExtras(this.pLVALUE_P()),e},Eden.AST.prototype.pDEPRECATED_BTICK=function(e){var t=new Eden.AST.Literal("STRING",e||"");for(t.typevalue=Eden.AST.TYPE_STRING;"{"==this.token;){this.next();var n,r=this.pEXPRESSION();if(r.errors.length>0)return(n=new Eden.AST.Primary).setBackticks(r),n;if("}"!=this.token)return(n=new Eden.AST.Primary).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BACKTICK)),n;if(this.next(),(i=new Eden.AST.BinaryOp("//")).left(t),i.setRight(r),i.typevalue=Eden.AST.TYPE_STRING,t=i,"OBSERVABLE"==this.token){var i;(i=new Eden.AST.BinaryOp("//")).left(t);var s=new Eden.AST.Literal("STRING",this.data.value);s.typevalue=Eden.AST.TYPE_STRING,i.setRight(s),i.typevalue=Eden.AST.TYPE_STRING,t=i,this.next()}}return t},Eden.AST.prototype.pPRIMARY_DEPRECATED_BTICK=function(e,t){var n=this.pDEPRECATED_BTICK(t);return(e=this.pPRIMARY_P(e)).setBackticks(n),e.setObservable("__BACKTICKS__"),this.isdynamic=!0,e},Eden.AST.prototype.pIDENTIFIER=function(e){if("`"===this.token){var t;if(this.version===Eden.AST.VERSION_CS2){if(this.next(),t=this.pEXPRESSION(),this.deprecated(t,"Backticks are now identifier templates"),"`"!==this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BACKTICK)),e;this.next()}else t=this.pTEMPLATE_STRING(!1);return e=this.pPRIMARY_P(e),0!=t.typevalue&&t.typevalue!=Eden.AST.TYPE_STRING&&this.typeWarning(e,Eden.AST.TYPE_STRING,t.typevalue),e.errors.length>0?e:(e.setBackticks(t),e.setObservable("__BACKTICKS__"),e)}if("OBSERVABLE"===this.token){var n=this.data.value;if(this.next(),"{"===this.token&&this.version===Eden.AST.VERSION_CS2){var r=this.pPRIMARY_DEPRECATED_BTICK(e,n);return this.deprecated(r,"Backticks are now identifier templates"),r}return(e=this.pPRIMARY_P(e)).errors.length>0?e:(e.setObservable(n),e)}return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BADFACTOR)),e},Eden.AST.prototype.pPRIMARY=function(){let e=new Eden.AST.Primary;return this.pIDENTIFIER(e)},Eden.AST.prototype.pPRIMARY_P=function(e){var t;return":"==this.token&&(this.next(),t=this.pATTRIBUTES(),e.setAttributes(t)||e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.DOBADATTRIB))),e},Eden.AST.prototype.pACTION=function(){var e=new Eden.AST.Action,t=this.parent;if(this.parent=e,e.warning=new Eden.SyntaxWarning(this,e,Eden.SyntaxWarning.DEPRECATED,"attempt to use 'when' instead of 'proc'"),"OBSERVABLE"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.PROCNAME)),this.parent=t,e;if(e.name=this.data.value,this.next(),":"==this.token){this.next();var n=this.pOLIST();if(0==n.length)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONNOWATCH)),this.parent=t,e;if("NONAME"==n[n.length-1])return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCOMMAS)),this.parent=t,e;e.triggers=n}return e.setBody(this.pFUNCBODY()),this.parent=t,e},Eden.AST.prototype.pSCOPE=function(){let e;if("("===this.token){if(this.next(),e=this.pSCOPE_P(),")"!==this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SCOPECLOSE)),e;this.next()}else e=this.pSCOPE_P();return e},Eden.AST.prototype.pSCOPEPATTERN=function(){var e=new Eden.AST.ScopePattern;if("OBSERVABLE"!==this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.SCOPENAME)),e;for(e.setObservable(this.data.value),this.next();;)if("["===this.token){this.next();var t=this.pEXPRESSION();if(e.addListIndex(t),t.errors.length>0)return e;if("]"!==this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXCLOSE)),e;this.next()}else if("."!==this.token)break;return e},Eden.AST.prototype.pSCOPE_P=function(e){var t,n=!1,r=this.peekNext(1);if(void 0===e&&(e=1),"is"!==r&&"="!==r&&"in"!==r)(t=new Eden.AST.ScopePattern).setObservable("$"+e),e++;else{if((t=this.pSCOPEPATTERN()).errors.length>0)return(a=new Eden.AST.Scope).addOverride(t,void 0,void 0,void 0,!1),a;if("is"!==this.token&&"="!==this.token&&"in"!==this.token)return(a=new Eden.AST.Scope).error(new Eden.SyntaxError(this,Eden.SyntaxError.SCOPEEQUALS)),a;"in"===this.token&&(n=!0),this.next()}var i=this.pEXPRESSION();if(i.errors.length>0)return(a=new Eden.AST.Scope).errors.push.apply(a.errors,i.errors),a;if(n&&".."!==this.token&&0!==i.typevalue&&i.typevalue!==Eden.AST.TYPE_LIST)return(a=new Eden.AST.Scope).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BADEXPRTYPE)),a;var s=void 0;if(".."===this.token){if(0!==i.typevalue&&i.typevalue!==Eden.AST.TYPE_NUMBER)return(a=new Eden.AST.Scope).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BADEXPRTYPE)),a;if(this.next(),(s=this.pEXPRESSION()).errors.length>0)return(a=new Eden.AST.Scope).addOverride(t,i,s,void 0,!1),a;if(0!==s.typevalue&&s.typevalue!==Eden.AST.TYPE_NUMBER)return(a=new Eden.AST.Scope).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BADEXPRTYPE)),a}var o=void 0;if(".."===this.token){var a;if(this.next(),(o=this.pEXPRESSION()).errors.length>0)return(a=new Eden.AST.Scope).addOverride(t,i,s,o,!1),a;if(0!==o.typevalue&&o.typevalue!==Eden.AST.TYPE_NUMBER)return(a=new Eden.AST.Scope).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BADEXPRTYPE)),a}return(a=this.pSCOPE_PP(e)).addOverride(t,i,s,o,n),a},Eden.AST.prototype.pSCOPE_PP=function(e){return","===this.token?(this.next(),this.pSCOPE_P(e)):new Eden.AST.Scope},Eden.AST.prototype.pNAMEDSCRIPT=function(){var e,t=null;if("["===this.token&&(t=this.pATTRIBUTES()),"OBSERVABLE"!==this.token)return(s=new Eden.AST.Script).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONNAME)),s;let n,r;if(e=this.data.value,this.next(),"("===this.token){if(this.next(),"oracle"===this.token&&(this.next(),n=this.pCODESELECTOR()),";"===this.token&&this.next(),"handle"===this.token&&(this.next(),r=this.pCODESELECTOR()),")"!==this.token)return(s=new Eden.AST.Script).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)),s;this.next()}if("is"===this.token){this.next();var i=new Eden.AST.Alias;return i.setAttributes(t)?"?"!==this.token?(i.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ALIASQUERY)),i):(this.next(),"("!==this.token?(i.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.QUERYOPEN)),i):(this.next(),i.setSelector(this.pCODESELECTOR()),")"!==this.token?(i.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.QUERYCLOSE)),i):(this.next(),i.setName(e),";"!==this.token?(i.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)),i):(this.next(),i)))):(i.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.DOBADATTRIB)),i)}var s;return"{"!==this.token?((s=new Eden.AST.Script).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONOPEN)),s):(this.next(),(s=this.pSCRIPT()).setAttributes(t)?(s.setName(this,e),n&&s.setReadables(n),r&&s.setWritables(r),"}"!==this.token?(s.error(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)),s):(this.next(),this.scripts[e]=s,s)):(s.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.DOBADATTRIB)),s))},Eden.AST.prototype.pSCRIPT=function(){var e=new Eden.AST.Script;e.parent=this.parent;var t=this.parent;this.parent=e,(s=new Eden.AST.DummyStatement).setSource(this.lastposition,this.stream.prevposition,this.stream.code.substring(this.lastposition,this.stream.prevposition)),s.numlines=s.source.match(/\n/g),null===s.numlines?s.numlines=0:s.numlines=s.numlines.length,e.append(s);for(var n=s;this.stream.valid();){var r=this.pSTATEMENT();if(void 0!==r){!e.warning&&r.warning&&(e.warning=r.warning);var i=r.end;"dummy"===r.type&&n&&"dummy"===n.type?(n.setSource(r.start,r.end,r.source),n.numlines+=r.numlines):(e.appendChild(r),n=r);var s,o=this.stream.code.substring(i,this.stream.prevposition);if(o.length>0)(s=new Eden.AST.DummyStatement).setSource(i,this.stream.prevposition,o),s.numlines=s.source.match(/\n/g),null===s.numlines?s.numlines=0:s.numlines=s.numlines.length,n&&"dummy"===n.type?(n.setSource(s.start,s.end,s.source),n.numlines+=s.numlines):(e.appendChild(s),n=s)}else{if(";"!==this.token)break;this.next()}}return this.parent=t,e},Eden.AST.prototype.pSCRIPTEXPR=function(){var e=new Eden.AST.ScriptExpr,t=this.pSCRIPT();return e.setScript(t),e},function(){const e=Eden.Language;Eden.AST.prototype.pCODESELECTOR=function(t){var n=void 0;if("OBSERVABLE"==this.token||e.keywords[this.token]&&"with"!=this.token)n=new Eden.AST.Literal("STRING",this.data.value),this.next();else if(":"==this.token||"."==this.token){var r=":"==this.token;if(this.next(),"OBSERVABLE"==this.token||e.keywords[this.token]){if(!(!r&&Eden.Selectors.PropertyNode.attributes[this.data.value]||r&&Eden.Selectors.PropertyNode.pseudo[this.data.value]))return(n=new Eden.AST.Literal("STRING","")).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTORATTRIB)),n;n=new Eden.AST.Literal("STRING",(r?":":".")+this.data.value),this.next()}else if("NUMBER"==this.token)n=new Eden.AST.Literal("STRING",(r?":":".")+this.data.value),this.next();else if("{"==this.token)n=new Eden.AST.Literal("STRING",r?":":".");else{if("("!=this.token)return(n=new Eden.AST.Literal("STRING","")).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTORATTRIB)),n;var i=this.stream.position;for(this.next();this.stream.valid()&&")"!=this.token;)this.next();var s=this.stream.prevposition,o=":("+this.stream.code.substring(i,s).replace(/[\r\n]*/g,"")+")";if(n=new Eden.AST.Literal("STRING",o),")"!=this.token)return n.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTORATTRIB)),n;this.next()}}else if("@"==this.token){if(this.next(),"OBSERVABLE"!=this.token)return(n=new Eden.AST.Literal("STRING","")).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTOROPTION)),n;if(!Eden.Selectors.allowedOptions[this.data.value])return(n=new Eden.AST.Literal("STRING","")).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTOROPTION)),n;n=new Eden.AST.Literal("STRING","@"+this.data.value+" "),this.next()}else if("#"==this.token)if(this.next(),"OBSERVABLE"==this.token)n=new Eden.AST.Literal("STRING","#"+this.data.value),this.next();else{if("{"!=this.token)return(n=new Eden.AST.Literal("STRING","")).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTORTAG)),n;n=new Eden.AST.Literal("STRING","#")}else if("{"==this.token){if(this.next(),n=this.pEXPRESSION(),"}"!=this.token)return n.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTORBTICK)),n;this.next()}else if(">"==this.token)n=new Eden.AST.Literal("STRING"," > "),this.next();else if(">>"==this.token)n=new Eden.AST.Literal("STRING"," >> "),this.next();else if("<"==this.token)n=new Eden.AST.Literal("STRING"," < "),this.next();else if(","==this.token)n=new Eden.AST.Literal("STRING",","),this.next();else if("<<"==this.token)n=new Eden.AST.Literal("STRING"," << "),this.next();else if("("==this.token){i=this.stream.position;if(this.next(),"{"==this.token){this.next();var a=this.pEXPRESSION();if("}"!=this.token)return a.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTORBTICK)),a;if(this.next(),")"!=this.token)return a.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTORBTICK)),a;this.next(),(d=new Eden.AST.BinaryOp("//")).left(new Eden.AST.BinaryOp("//")),d.l.left(new Eden.AST.Literal("STRING","(")),d.l.setRight(a),d.setRight(new Eden.AST.Literal("STRING",")")),n=d}else{for(;this.stream.valid()&&")"!=this.token;)this.next();s=this.stream.prevposition,o="("+this.stream.code.substring(i,s).replace(/[\r\n]*/g,"")+")";if(n=new Eden.AST.Literal("STRING",o),")"!=this.token)return n.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTORATTRIB)),n;this.next()}}else{if(")"==this.token)return;"*"==this.token&&(n=new Eden.AST.Literal("STRING","*"),this.next())}if(n){var d;if(void 0===(d=this.pCODESELECTOR(!0)))return n;if(d.errors.length>0)return d;if("literal"==n.type&&"literal"==d.type)n.value+=d.value;else{var c=new Eden.AST.BinaryOp("//");c.left(n),c.setRight(d),n=c}}else t||(n=new Eden.AST.Literal("STRING","")).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN));return n}}(),Eden.AST.prototype.pDEFINITION=function(){this.next();var e,t=new Eden.AST.Definition,n=this.parent;if(this.parent=t,this.isdynamic=!1,":"==this.token&&(this.next(),e=this.pATTRIBUTES(),!t.setAttributes(e)))return t.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.DOBADATTRIB)),this.parent=n,t;var r=this.pEXPRESSION_ASYNC();return t.setExpression(r),this.isdynamic&&(t.isdynamic=!0),this.parent=n,t},Eden.AST.prototype.pRANGE_STATEMENT=function(){this.next();var e=new Eden.AST.Range(this.pEXPRESSION());return".."===this.token||e.expression.typevalue!==Eden.AST.TYPE_NUMBER&&e.expression.typevalue!==Eden.AST.TYPE_BOOLEAN?(".."===this.token&&(this.next(),e.setSecond(this.pEXPRESSION())),e):(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BADEXPRTYPE)),e)},Eden.AST.prototype.pASSIGNMENT=function(){var e;this.next(),":"==this.token&&(this.next(),e=this.pATTRIBUTES());var t=new Eden.AST.Assignment(this.pEXPRESSION());return t.setAttributes(e)?(t.expression&&"query"==t.expression.type&&(t.warning=new Eden.SyntaxWarning(this,t,Eden.SyntaxWarning.MISSINGSYNC,"This is an asynchronous statement")),t):(t.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.DOBADATTRIB)),this.parent=parent,t)},Eden.AST.prototype.pMODIFY_PLUS=function(){return this.next(),new Eden.AST.Modify("+=",this.pEXPRESSION())},Eden.AST.prototype.pMODIFY_ARITH=function(){let e=this.token;this.next();let t=new Eden.AST.Modify(e,this.pEXPRESSION());return t.expression&&t.expression.typevalue!==Eden.AST.TYPE_NUMBER&&0!==t.expression.typevalue&&t.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BADEXPRTYPE)),t},Eden.AST.prototype.pMODIFY_CONCAT=function(){this.next();let e=new Eden.AST.Modify("//=",this.pEXPRESSION());return!e.expression||e.expression.typevalue!==Eden.AST.TYPE_NUMBER&&e.expression.typevalue!==Eden.AST.TYPE_BOOLEAN&&e.expression.typevalue!==Eden.AST.TYPE_OBJECT||e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BADEXPRTYPE)),e},Eden.AST.prototype.pMODIFY_INCDEC=function(){let e=this.token;return this.next(),new Eden.AST.Modify(e,void 0)},Eden.AST.prototype.pSUBSCRIBERS=function(){this.next();var e=new Eden.AST.Subscribers;return"["!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.SUBSCRIBEOPEN)),e):(this.next(),e.setList(this.pOLIST()),e.errors.length>0?e:"]"!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.SUBSCRIBECLOSE)),e):(this.next(),e))},Eden.AST.prototype.pFUNCCALL_STAT=function(){var e=new Eden.AST.FunctionCall;if(this.next(),")"!=this.token){if(e.setParams(this.pELIST()),e.errors.length>0)return e;if(")"!=this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.FUNCCLOSE)),e}return this.next(),e},Eden.AST.prototype.pSTATEMENT_PP=function(e){switch(this.scopedependencies=null,this.token){case"is":return this.pDEFINITION();case"in":return this.pRANGE_STATEMENT();case"=":return this.pASSIGNMENT();case"+=":return this.pMODIFY_PLUS();case"-=":case"/=":case"*=":return this.pMODIFY_ARITH();case"//=":return this.pMODIFY_CONCAT();case"++":case"--":return this.pMODIFY_INCDEC();case"~>":return this.pSUBSCRIBERS();case"(":return this.pFUNCCALL_STAT()}var t=[];t.push(new Eden.SyntaxError(this,Eden.SyntaxError.DEFINITION));var n=new Eden.AST.Assignment(void 0);return n.errors.unshift(t[0]),n},Eden.AST.prototype.pSTATEMENT_P=function(e){var t=this.pLVALUE();if(t.errors.length>0)return t;var n=this.pSTATEMENT_PP(e);return n.left(t),n.errors.length,n},Eden.AST.prototype.pSUB_STATEMENT=function(){var e=new Eden.AST.SubStatement;if("parse"==this.token){if(this.next(),"("!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.EVALCLOSE)),e;this.next();var t=this.pEXPRESSION();return e.setOperation("parse",t),t.isconstant&&0!=t.typevalue&&t.typevalue!=Eden.AST.TYPE_STRING&&this.typeWarning(e,Eden.AST.TYPE_STRING,t.typevalue),")"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.EVALCLOSE)),e):(this.next(),e)}return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BADEXPRTYPE)),e},Eden.AST.prototype.pSTAT_DEFAULT=function(){this.next();var e=new Eden.AST.Default;return":"!=this.token?e.error(new Eden.SyntaxError(this,Eden.SyntaxError.DEFAULTCOLON)):this.next(),e},Eden.AST.prototype.pSTAT_COMMENT=function(){var e=this.stream.position+1,t=this.stream.line,n=33==this.stream.peek(),r=0;do{let e=this.stream;for(;e.valid();){let t=e.code.charCodeAt(e.position);if(123===t?++r:125===t&&--r,10===t||r<0)break;++e.position}if(r<0)break;this.stream.valid()||this.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.NEWLINE)),this.stream.skip(),this.stream.line++}while(35==this.stream.peek()&&35!=this.stream.peek2());if(n){var i=new Eden.AST.DoxyComment(this.stream.code.substring(e,this.stream.position-1).trim(),t,this.stream.line);i.parent=this.parentDoxy,i.content.endsWith("@{")?this.parentDoxy=i:i.content.startsWith("@}")&&this.parentDoxy&&(this.parentDoxy=this.parentDoxy.parent),!this.lastStatement||void 0!==this.lastStatement.doxyComment||this.lastStatEndline!=t-1&&this.lastStatEndline!=t?this.lastDoxyComment.push(i):this.lastStatement.setDoxyComment(i)}return this.next(),new Eden.AST.DummyStatement},Eden.AST.prototype.pSTAT_RETURN=function(){this.next();var e=new Eden.AST.Return;return";"==this.token?(this.next(),e):(e.setResult(this.pEXPRESSION()),e.errors.length>0?e:(";"!=this.token?e.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)):this.next(),e))},Eden.AST.prototype.pSTAT_OBSERVABLE=function(e){var t,n=this.pLVALUE();if(n.errors.length>0)return(t=new Eden.AST.DummyStatement).lvalue=n,t.errors=n.errors,t;n.source=this.stream.code.substring(e,this.lastposition).trim();var r=this.pSTATEMENT_PP();return r.left(n),r.errors.length>0?t=r:(";"!==this.token?r.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)):this.next(),t=r)},Eden.AST.prototype.pSTATEMENT=function(){var e,t,n=this.stream.prevposition,r=this.stream.line-1,i=void 0,s=this.lastDoxyComment&&this.lastDoxyComment.length>0?this.lastDoxyComment.pop():void 0;0==this.lastDoxyComment.length&&this.parentDoxy&&this.lastDoxyComment.push(this.parentDoxy);var o=!1;switch(this.token){case"proc":case"func":i=this.pFUNCTION();break;case"when":this.next(),i=this.pWHEN();break;case"action":this.next(),i=this.pNAMEDSCRIPT();break;case"for":this.next(),i=this.pFOR();break;case"while":this.next(),i=this.pWHILE();break;case"do":this.next(),i=this.pDO();break;case"exec":this.next(),i=this.pEXEC();break;case"wait":this.next(),i=this.pWAIT();break;case"switch":this.next(),i=this.pSWITCH();break;case"case":this.next(),i=this.pCASE();break;case"insert":this.next(),i=this.pINSERT();break;case"delete":this.next(),i=this.pDELETE();break;case"append":this.next(),i=this.pAPPEND();break;case"shift":this.next(),i=this.pSHIFT();break;case"require":this.next(),i=this.pREQUIRE();break;case"after":this.next(),i=this.pAFTER();break;case"import":this.next(),i=this.pIMPORT();break;case"para":i=this.pPARAMS();break;case"const":case"local":case"auto":i=this.pLOCALS();break;case"default":i=this.pSTAT_DEFAULT();break;case"if":this.next(),i=this.pIF();break;case"#":i=this.pSTAT_COMMENT();break;case"##":i=this.pSECTION(),this.lastDoxyComment.length>0&&this.lastline==this.lastDoxyComment[0].startline-1&&i.setDoxyComment(this.lastDoxyComment.shift());break;case"%":i=this.pCUSTOM_SECTION();break;case"return":o=!0,i=this.pSTAT_RETURN();break;case"continue":this.next(),o=!0;var a=new Eden.AST.Continue;if(a.errors.length>0){i=a;break}";"!=this.token?a.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)):this.next(),i=a;break;case"break":this.next(),o=!0;var d=new Eden.AST.Break;if(d.errors.length>0){i=d;break}";"!=this.token?d.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)):this.next(),i=d;break;case"{":this.next();var c=this.pSCRIPT();if("}"!==this.token){c.error(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)),i=c;break}this.next(),i=c;break;case"${":if(this.next(),i=this.pSUB_STATEMENT(),"}"!==this.token){i.error(new Eden.SyntaxError(this,Eden.SyntaxError.EVALCLOSE));break}this.next();break;case"JAVASCRIPT":r=this.data.line-1;var h=this.data.value;this.next(),i=new Eden.AST.Literal("JAVASCRIPT",h);break;case"?":this.next(),o=!0,i=this.pQUERY(),";"!==this.token?i.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)):this.next();break;case"(":case"`":case"*":case"OBSERVABLE":o=!0,i=this.pSTAT_OBSERVABLE(n);break;default:i=void 0}if(!i&&this.options&&this.options.tolerant)switch(this.token){case"is":case"=":var p=new Eden.AST.LValue;p.setObservable("__error__");var l=this.pSTATEMENT_PP();l.left(p),";"!==this.token?l.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)):this.next(),i=l,console.error("Recovery",i)}if(!i)return i;if(i.errors.length>0&&i.errors[i.errors.length-1]!==this.last_error&&(this.last_error=i.errors[i.errors.length-1],o&&";"!=this.token))if(this.options&&this.options.autorecover){for(;";"!=this.token&&"EOF"!=this.token;)this.next();this.next()}else i.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.STATEMENT));t=this.lastposition,e=this.lastline,i.parent=this.parent,i.local=this.localStatus,i.line=this.stream.line-r,void 0===i.doxyComment&&(i.setDoxyComment||console.error("Bad stat",i),i.setDoxyComment(s)),i.stamp=this.stamp;var u=this.stream.code.substring(n,t);const E=s?(s.content.match(/\n/g)||"").length:0;return i.numlines=e-r-1+E,i.setSource(n,t,u),"dummy"!==i.type&&(this.lastStatement=i,this.lastStatEndline=e),i},Eden.AST.prototype.pSTATEXPR=function(){this.stream.prevposition;var e=void 0,t=this.lastDoxyComment;switch(this.parentDoxy&&(this.lastDoxyComment=this.parentDoxy),this.token){case"proc":case"func":case"when":case"wait":case"do":case"require":case"after":case"import":case"action":(e=new Eden.AST.DummyStatement).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN));break;case"for":this.next(),e=this.pFOR();break;case"while":this.next(),e=this.pWHILE();break;case"switch":this.next(),e=this.pSWITCH();break;case"case":this.next(),e=this.pCASE();break;case"insert":this.next(),e=this.pINSERT();break;case"delete":this.next(),e=this.pDELETE();break;case"append":this.next(),e=this.pAPPEND();break;case"shift":this.next(),e=this.pSHIFT();break;case"para":case"oracle":e=this.pPARAMS();break;case"local":case"auto":e=this.pLOCALS();break;case"default":this.next();var n=new Eden.AST.Default;":"!=this.token?n.error(new Eden.SyntaxError(this,Eden.SyntaxError.DEFAULTCOLON)):this.next(),e=n;break;case"if":this.next(),e=this.pIF();break;case"return":this.next();var r=new Eden.AST.Return;if(";"==this.token){this.next(),e=r;break}if(r.setResult(this.pEXPRESSION()),r.errors.length>0){e=r;break}";"!=this.token?r.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)):this.next(),e=r;break;case"continue":this.next();var i=new Eden.AST.Continue;if(i.errors.length>0){e=i;break}";"!=this.token?i.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)):this.next(),e=i;break;case"break":this.next();var s=new Eden.AST.Break;if(s.errors.length>0){e=s;break}";"!=this.token?s.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)):this.next(),e=s;break;case"{":this.next();var o=this.pSCRIPT();if("}"!=this.token){o.error(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)),endline=this.stream.line,e=o;break}endline=this.stream.line,this.next(),e=o;break;case"JAVASCRIPT":curline=this.data.line-1;var a=this.data.value;this.next(),e=new Eden.AST.Literal("JAVASCRIPT",a);break;case"`":case"*":case"OBSERVABLE":var d=this.pLVALUE();if(d.errors.length>0){(e=new Eden.AST.DummyStatement).lvalue=d,e.errors=d.errors;break}var c=this.pSTATEMENT_PP();if(c.left(d),c.errors.length>0){e=c,endline=this.stream.line;break}";"!=this.token?c.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)):(end=this.stream.position,endline=this.stream.line,this.next()),void 0===this.definitions[d.name]&&(this.definitions[d.name]=[]),this.definitions[d.name].push(c),e=c;break;default:return}return e.parent=this.parent,e.doxyComment=t,e},Eden.AST.prototype.pSWITCH=function(){var e=new Eden.AST.Switch,t=this.parent;return this.parent=e,"("!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.SWITCHOPEN)),this.parent=t,e):(this.next(),e.setExpression(this.pEXPRESSION()),e.errors.length>0?(this.parent=t,e):")"!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.SWITCHCLOSE)),this.parent=t,e):(this.next(),"{"!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.SWITCHSCRIPT)),this.parent=t,e):(e.setStatement(this.pSTATEMENT()),this.parent=t,e)))},Eden.AST.prototype.pCASE=function(){var e=new Eden.AST.Case;return"STRING"!=this.token&&"NUMBER"!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.CASELITERAL)),e):(e.setLiteral(this.token,this.data.value),this.next(),":"!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.CASECOLON)),e):(this.next(),e))},Eden.AST.prototype.pTERM=function(){var e=this.pTERM_A(),t=this.pEXPRESSION_PPPPPP();return t?(t.left(e),t):e},Eden.AST.prototype.pTERM_A=function(){for(var e=this.pTERM_P();"<"===this.token||"<="===this.token||">"===this.token||">="===this.token||"=="===this.token||"!="===this.token;){var t=new Eden.AST.BinaryOp(this.token);this.next(),t.left(e),t.setRight(this.pTERM_P()),e=t,t.typevalue=Eden.AST.TYPE_BOOLEAN}return e},Eden.AST.prototype.pTERM_P=function(){for(var e=this.pTERM_PP();"+"===this.token||"-"===this.token||"//"===this.token;){var t=new Eden.AST.BinaryOp(this.token);this.next(),t.left(e),t.setRight(this.pTERM_PP()),e=t,"//"===t.op?(0!==t.l.typevalue&&0!==t.r.typevalue&&t.l.typevalue!==t.r.typevalue&&this.typeWarning(t),t.l.typevalue!==Eden.AST.TYPE_NUMBER&&t.r.typevalue!==Eden.AST.TYPE_NUMBER||this.typeWarning(t,null,Eden.AST.TYPE_NUMBER),t.l.typevalue!==Eden.AST.TYPE_OBJECT&&t.r.typevalue!==Eden.AST.TYPE_OBJECT||this.typeWarning(t,null,Eden.AST.TYPE_OBJECT)):(t.l.typevalue!==Eden.AST.TYPE_OBJECT&&t.r.typevalue!==Eden.AST.TYPE_OBJECT||this.typeWarning(t,null,Eden.AST.TYPE_OBJECT),t.l.typevalue!==Eden.AST.TYPE_LIST&&t.r.typevalue!==Eden.AST.TYPE_LIST||this.typeWarning(t,null,Eden.AST.TYPE_LIST))}return e},Eden.AST.prototype.pTERM_PP=function(){for(var e=this.pTERM_PPP();"*"===this.token||"/"===this.token||"%"===this.token||"^"===this.token;){var t=new Eden.AST.BinaryOp(this.token);this.next(),t.left(e),t.setRight(this.pTERM_PPP()),e=t,(0!==t.l.typevalue&&t.l.typevalue!==Eden.AST.TYPE_NUMBER||0!==t.r.typevalue&&t.r.typevalue!==Eden.AST.TYPE_NUMBER)&&this.typeWarning(t,Eden.AST.TYPE_NUMBER)}return e},Eden.AST.prototype.pTERM_PPP=function(){var e=this.pFACTOR(),t=this.pEXPRESSION_PPPPP();return t?(t.left(e),e.typevalue!==Eden.AST.TYPE_UNKNOWN&&e.typevalue!==Eden.AST.TYPE_LIST&&e.typevalue!==Eden.AST.TYPE_STRING&&t.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BADEXPRTYPE)),t):e},Eden.AST.prototype.pWAIT=function(){var e=new Eden.AST.Wait;if(";"==this.token)return this.next(),e;var t=this.pEXPRESSION();return e.setDelay(t),";"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)),e):(this.next(),e)},Eden.AST.prototype.pWHEN=function(){var e=new Eden.AST.When,t=this.parent;if(this.parent=e,"role"==this.token){if(this.next(),"OBSERVABLE"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.WHENROLE)),this.parent=t,e;e.roles=this.pOLIST()}if("("!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.WHENOPEN)),this.parent=t,e;if(this.next(),e.setExpression(this.pEXPRESSION()),e.errors.length>0)return this.parent=t,e;if(")"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.WHENCLOSE)),this.parent=t,e;if(this.next(),e.setStatement(this.pSTATEMENT()),e.errors.length>0)return this.parent=t,e;if(void 0===e.statement)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.WHENNOSTATEMENT)),e.active=!0,this.parent=t,e;if("with"==this.token||"::"==this.token){this.next();var n=this.pSCOPE();if(e.setScope(n),n.errors.length>0)return e;if(";"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)),e;this.next()}return e.compile(this),this.whens.push(e),this.parent=t,e},Eden.AST.prototype.pWHILE=function(){var e=new Eden.AST.While,t=this.parent;return this.parent=e,e.warning=new Eden.SyntaxWarning(this,e,Eden.SyntaxWarning.USEOFWHILE),e.setCondition(this.pEXPRESSION()),e.errors.length>0?(this.parent=t,e):(e.setStatement(this.pSTATEMENT()),void 0===e.statement?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.WHILENOSTATEMENT)),this.parent=t,e):(this.parent=t,e))},Eden.AST.prototype.pQUERY=function(){var e=new Eden.AST.Query,t=[];if("OBSERVABLE"==this.token)return e.observable=this.data.value,this.next(),e;if("("!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.QUERYOPEN)),e;if(this.next(),e.setSelector(this.pCODESELECTOR()),")"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.QUERYCLOSE)),e;if(this.next(),":"==this.token){this.next();let e=this.pATTRIBUTES();t=Object.keys(e)}else if("["==this.token){let e=this.pATTRIBUTES();t=Object.keys(e)}if("="==this.token||"+="==this.token||"//="==this.token){var n=this.token;this.next();var r=this.pEXPRESSION();e.setModify(r,n)}return t.length,e.setResultTypes(t),e},Eden.AST.prototype.pINDEXED=function(){for(var e=new Eden.AST.Indexed;this.stream.valid()&&("["==this.token||"."==this.token||"("==this.token);)if("["==this.token){this.next();var t=new Eden.AST.Index;if("]"==this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXEXP)),e;if((i=this.pEXPRESSION()).errors.length>0)return t.setExpression(i),e.addIndex(t),e;if("literal"==i.type&&"NUMBER"==i.datatype&&i.value<1)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.OUTOFBOUNDS)),e;if("]"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXCLOSE)),e;this.next(),t.setExpression(i),e.addIndex(t)}else if("("==this.token){this.next();var n=new Eden.AST.FunctionCall;if(")"==this.token)this.next(),e.addIndex(n);else{var r=this.pELIST();if(n.setParams(r),n.errors.length>0)return e.addIndex(n),e;if(")"!=this.token)return e.addIndex(n),n.errors.length>0?e:(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.FUNCCALLEND)),e);this.next(),e.addIndex(n)}}else{this.next();t=new Eden.AST.Index;if("OBSERVABLE"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXEXP)),e;var i=new Eden.AST.Literal("STRING",this.data.value);this.next(),t.setExpression(i),e.addIndex(t)}return e},Eden.AST.prototype.pSECTION=function(){for(var e=1;35==this.stream.peek();)e++,this.stream.skip();var t=this.stream.readLine().trim();return this.stream.valid()?(this.stream.position--,this.stream.line--):this.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.NEWLINE)),this.next(),stat=new Eden.AST.Section,stat.setName(t),stat.depth=e,stat},Eden.AST.prototype.pCUSTOM_SECTION=function(){if(this.next(),"OBSERVABLE"!=this.token)return(e=new Eden.AST.Literal("STRING",this.data.value)).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.HEREDOCTOKEN)),e;var e,t=this.data.value;if(10!=this.stream.get())return(e=new Eden.AST.Literal("STRING",this.data.value)).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.HEREDOCTOKEN)),e;for(var n="";this.stream.valid();){var r=this.stream.position,i=this.stream.readLine();if(i.startsWith("%eden")){this.stream.position=r+5;break}n+=i}this.stream.valid()||this.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.NEWLINE)),this.next();var s=new Eden.AST.CustomBlock;return s.text=n,s.setName(t),s},Eden.AST.prototype.pHTML=function(){this.next();var e=new Eden.AST.HTML;if("OBSERVABLE"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e;for(e.setName(this.data.value),this.next();"OBSERVABLE"==this.token;){var t=this.stream.prevposition,n=this.data.value;for(this.next();"-"==this.token;){if(n+="-",this.next(),"OBSERVABLE"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e;n+=this.data.value,this.next()}if(this.stream.prevposition-t!=n.length)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e;if("OBSERVABLE"!=this.token&&">"!=this.token&&"/"!=this.token){if("="!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e;if(this.next(),"STRING"!=this.token){if("{"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e;if(this.next(),e.addAttribute(n,this.pEXPRESSION()),e.errors.length>0)return e;if("}"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e;this.next()}else e.addAttribute(n,new Eden.AST.Literal("STRING",this.data.value)),this.next()}else e.addAttribute(n,new Eden.AST.Literal("BOOLEAN",!0))}if("/"==this.token)return this.next(),">"!=this.token&&e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),this.next(),e;if(">"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e;var r=this.stream.position,i=this.stream.position;for(this.next();this.stream.valid()&&"</"!=this.token;)if("<"==this.token)i-1>r&&e.addContent(new Eden.AST.Literal("STRING",this.stream.code.substring(r,i).replace(/\n/g,"\\n"))),e.addContent(this.pHTML()),r=i=this.stream.prevposition;else if("{"==this.token){if(this.next(),i-1>r&&e.addContent(new Eden.AST.Literal("STRING",this.stream.code.substring(r,i).replace(/\n/g,"\\n"))),e.addContent(this.pEXPRESSION()),"}"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e;r=i=this.stream.position,this.next()}else i=this.stream.position,this.next();return i>r&&e.addContent(new Eden.AST.Literal("STRING",this.stream.code.substring(r,i).replace(/\n/g,"\\n"))),"</"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e):(this.next(),"OBSERVABLE"!=this.token||this.data.value!=e.name?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e):(this.next(),">"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e):(this.next(),e)))},Eden.AST.prototype.pTEMPLATE_STRING=function(e){for(var t,n=this.token,r=this.stream.position;!this.stream.eof();){var i=this.stream.get(),s=String.fromCharCode(i);if(s===n)return d=(d=this.stream.code.substring(r,this.stream.position-1)).replace(/\\([\\\{\}'])/g,"$1"),this.next(),0==d.length&&t?t:t?((o=new Eden.AST.BinaryOp("//")).left(t),o.setRight(new Eden.AST.Literal("STRING",d)),o):new Eden.AST.Literal("STRING",d);if("\\"===s)this.stream.skip();else{if("}"===s)return t=new Eden.AST.Literal("UNDEFINED"),this.syntaxError(t,Eden.SyntaxError.UNKNOWN),t;if("{"===s){if(d=(d=this.stream.code.substring(r,this.stream.position-1)).replace(/\\([\\\{\}'])/g,"$1"),this.next(),(a=this.pEXPRESSION()).typevalue!=Eden.AST.TYPE_LIST&&a.typevalue!=Eden.AST.TYPE_OBJECT||this.typeWarning(a,Eden.AST.TYPE_STRING,a.typevalue),"}"!==this.token)return a.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN,"Missing template expression close")),a;if(r=this.stream.position,d.length>0&&t)(o=new Eden.AST.BinaryOp("//")).left(t),o.setRight(new Eden.AST.Literal("STRING",d)),t=o,(o=new Eden.AST.BinaryOp("//")).left(t),o.setRight(a),t=o;else if(d.length>0){var o;(o=new Eden.AST.BinaryOp("//")).left(new Eden.AST.Literal("STRING",d)),o.setRight(a),t=o}else t=a}else if("${"===s){var a=this.pEXPRESSION();this.token}else if(!e&&this.stream.isWhiteSpace(i)){return d=(d=this.stream.code.substring(r,this.stream.position-1)).replace(/\\([\\\{\}'])/g,"$1"),(c=new Eden.AST.Literal("STRING",d)).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN,"White space not allowed")),c}}}var d,c;return d=(d=this.stream.code.substring(r,this.stream.position-1)).replace(/\\([\\\{\}'])/g,"$1"),(c=new Eden.AST.Literal("STRING",d)).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN,"End of input")),c},Eden.Project=function(e,t,n,r){this.title=t,this.name=t.replace(/[^a-zA-Z0-9]/g,""),this.author=void 0,this.authorid=-1,this.tags=t.toLowerCase().split(" "),this.src=n,this.ast=new Eden.AST(n,void 0,this,{autorecover:!0,tolerant:!0}),this.id=e,this.vid=void 0,this.parentid=void 0,this.thumb=void 0,this.desc=void 0,this.readPassword=void 0,this.autosavetimeout=void 0,this.success=this.ast&&0==this.ast.script.errors.length,this.instance=r,this.ast&&0==this.ast.script.errors.length||(console.error("Project Error",this.ast.script.errors),r.exec("do lib:unexecuted; do lib > recovery;").then(e=>{r.emit("error",[{name:"Project"},this.ast.script.errors[0]])})),r.root.lookup("jseden_project_name").assign(this.name,r.root.scope,EdenSymbol.localJSAgent),Object.defineProperty(this,"statements",{enumerable:!0,get:function(){return this.ast.script.statements}})},Eden.Project.listenTo=listenTo,Eden.Project.emit=emit,Eden.Project.unListen=unListen,Eden.Project.listeners={},Eden.Project.init=function(e){return e.root.lookup("jseden_project_title").addJSObserver("project",function(t,n){if(t.origin!==e.project){if(void 0===e.project)return;e.project.title=n,void 0===this.id&&(Eden.Index.remove(e.project.ast.script),e.project.name=n.replace(/[^a-zA-Z0-9]/g,""),e.project.ast.script.name=e.project.name,console.log("REINDEX PROJECT"),Eden.Index.update(e.project.ast.script)),e.project.ast.script.doxyComment=e.project.ast.doxyFromOrigin(),Eden.Fragment.emit("aststatus",[e.project.ast.script])}}),Eden.Utils.getURL("resources/projects.db.json").then(function(e){Eden.Project.local=JSON.parse(e)})},Eden.Project.loadFromFile=function(e){var t=e.name;t=(t=t.substring(0,t.lastIndexOf("."))).replace(/\([0-9]+\)/,""),console.log("FILE",e),Eden.Project.emit("loading",[this]);var n=new FileReader;n.onload=function(e){eden.project=new Eden.Project(void 0,t,e.target.result.replace(/\r/g,""),eden),eden.project.start()},n.readAsText(e)},Eden.Project.newFromExisting=function(e,t,n){var r=this;Eden.Project.emit("loading",[r]),Eden.Project.local[e]&&(Eden.Project.local[e].id?Eden.Project.load(Eden.Project.local[e].id,void 0,void 0,n):Eden.Utils.getURL(Eden.Project.local[e].file).then(function(i){t.root.lookup("jseden_project_mode").assign("restore",t.root.scope,EdenSymbol.defaultAgent),t.project=new Eden.Project(void 0,e,i,t),t.project.start(function(){Eden.Project.emit("load",[r]),n&&n(t.project)})}))},Eden.Project.search=function(e,t){},Eden.Project.load=function(e,t,n,r){var i=this;3==arguments.length&&(r=n,n=void 0),Eden.Project.emit("loading",[i]),Eden.DB.load(e,t,n,function(t){if(t){var s,o=t,a=!0;if(null!==o.projectMetaData&&(s=JSON.parse(o.projectMetaData)).env){if(!Eden.Project.verifyEnvironment(s.env)){var d=Eden.Project.findEnvironment(s.env);d?document.location=d+URLUtil.updateQueryString({load:e,vid:t.saveID,r:n||""}):alert("This project needs a different version of JS-Eden")}s.env.parser_cs3&&(a=!1)}var c=a&&!t.source.startsWith('"use cs2;"')?'"use cs2;"\n'+t.source:t.source;eden.project=new Eden.Project(e,o.minimisedTitle,c,eden),console.log("LOAD PROJECT",t),eden.project.vid=t.saveID,eden.project.title=o.title,eden.project.author=o.ownername,eden.project.authorid=o.owner,eden.project.thumb=o.image,eden.project.tags=o.tags.trim().split(" "),eden.project.parentid=o.parentProject,eden.root.lookup("jseden_project_title").assign(o.title,eden.root.scope,EdenSymbol.localJSAgent),eden.root.lookup("jseden_project_name").assign(o.minimisedTitle,eden.root.scope,EdenSymbol.localJSAgent),eden.root.lookup("jseden_project_thumb").assign(o.image,eden.root.scope,EdenSymbol.localJSAgent),eden.root.lookup("jseden_project_author").assign(o.ownername,eden.root.scope,EdenSymbol.localJSAgent),s&&(eden.project.desc=s.description),eden.project.ast.script.doxyComment=eden.project.ast.doxyFromOrigin(),eden.project.start(function(){Eden.Project.emit("load",[i])});var h=URLUtil.updateQueryString({load:eden.project.id,vid:eden.project.vid,r:n||""});document.location.search!=h&&window.history.pushState({id:eden.project.id,vid:eden.project.vid},"",h)}r&&r(eden.project)})},Eden.Project.verifyEnvironment=function(e){for(var t in console.log("Environment:",e),e.hasOwnProperty("parser_cs3")&&0!=e.parser_cs3||(Eden.AST.version=Eden.AST.VERSION_CS2,eden.root.lookup("jseden_parser_cs3").assign(!1,eden.root.scope,EdenSymbol.defaultAgent),console.log("Disable cs3")),e){var n=eden.root.lookup("jseden_"+t).value();if("string"==typeof e[t])switch(e[t].charAt(0)){case">":if(n<=parseInt(e[t].substring(1)))return!1;break;case"<":if(n>=parseInt(e[t].substring(1)))return!1;break;case">=":if(n<parseInt(e[t].substring(1)))return!1;break;case"<=":if(n>parseInt(e[t].substring(1)))return!1;break;case"=":if(n!==parseInt(e[t].substring(1)))return!1;break;default:if(n!=e[t])return!1}else if(n!=e[t])return console.log("Environment mismatch: ",t,n,e[t]),!1}return!0},Eden.Project.findEnvironment=function(e){return e.webgl&&!eden.root.lookup("jseden_webgl").value()?"http://jseden.dcs.warwick.ac.uk/webgl/index.html":!e.webgl&&eden.root.lookup("jseden_webgl").value()?"http://jseden.dcs.warwick.ac.uk/construit/index.html":null},Eden.Project.prototype.environment=function(){return{version_major:eden.root.lookup("jseden_version_major").value(),webgl:eden.root.lookup("jseden_webgl").value(),p2p_constructs:eden.root.lookup("jseden_p2p_constructs").value(),parser_cs3:eden.root.lookup("jseden_parser_cs3").value()}},Eden.Project.prototype.start=function(e){var t=this;if(this.ast.errors.length>0){for(var n=0;n<this.ast.errors.length;++n)console.error("Project parse error: ",this.ast.errors[n].toString());e&&e()}else{if("recover"==this.instance.get("jseden_project_mode"))return this.success=!1,void eden.exec("do lib:unexecuted; do lib > recovery;").then(t=>{eden.root.enableActions(),e&&e()});this.ast.execute(this,eden.root.scope,function(){if(t.ast.scripts.ACTIVE){for(var n=0;n<t.ast.script.statements.length;n++)if(t.ast.script.statements[n]===t.ast.scripts.ACTIVE){console.log(t.ast.script.statements[n]),t.ast.script.statements[n].removeIndex(),t.ast.script.statements[n].destroy(),eden.root.start=t.ast.script.statements[n].start,eden.root.end=t.ast.script.statements[n].end,eden.root.prefix=t.ast.script.statements[n].prefix,eden.root.postfix=t.ast.script.statements[n].postfix,eden.root.parent=eden.project.ast.script,Eden.Index.update(eden.root),t.ast.script.statements[n]=eden.root;break}}else t.ast.script.appendChild(eden.root);eden.root.parent=t.ast.script,t.ast.scripts.ACTIVE=eden.root,eden.root.enableActions(),e&&e()})}},Eden.Project.prototype.diff=function(e,t){return _diff(e||this.ast.stream.code,t||this.generate())},Eden.Project.prototype.save=function(e,t){Eden.DB.save(this,e,t)},Eden.Project.prototype.restore=function(){},Eden.Project.prototype.autosave=function(){if(!this.autosavetimeout){var e=this;this.autosavetimeout=setTimeout(function(){this.autosavetimeout=void 0,Eden.DB.localSave(e),console.log("Doing an autosave")},1e4)}},Eden.Project.prototype.patch=function(e,t){},Eden.Project.prototype.localSave=function(){Eden.DB.localSave(this)},Eden.Project.prototype.snapshot=function(){},Eden.Project.prototype.addAction=function(e){var t=Eden.AST.parseStatement("action "+e+" {}");return this.ast.script.appendChild(t),t.addIndex(),t},Eden.Project.prototype.generate=function(){return this.success?this.ast.getSource():this.src},Eden.Project.prototype.getDescription=function(){return void 0===this.desc&&(this.desc="# "+this.title+"\nEnter a project description here,\nand some hashtags as below.\n\nTags: #"+this.tags.join(" #")),this.desc},Eden.Project.prototype.setDescription=function(e){this.desc=e;var t=new Eden.AST.DoxyComment(e,0,0);this.tags=t.getHashTags().map(function(e){return e.substring(1)})},Eden.Project.prototype.registerAgent=function(e,t){for(var n in e.executed=1,e.dependencies)eden.root.lookup(n).addObserver(e.id,e);!t&&eden.peer&&eden.peer.activateWhen(e.id)},Eden.Project.prototype.removeAgent=function(e,t){for(var n in e.executed=0,e.dependencies)eden.root.lookup(n).removeObserver(e.id);!t&&eden.peer&&eden.peer.deactivateWhen(e.id)},Eden.Fragment=function(e,t){this.name=e,this.selector=e,this.originast=void 0,this.origin=void 0,this.source=void 0,this.ast=void 0,this.lastast=void 0,this.locked=!0,this.remote=!1,this.results=[],this.title=e,this.scratch=!1,this.edited=!1,this.autosavetimer=void 0,this.history=[],this.snapshot="",this.index=-1;var n=this;this.reset(()=>{Eden.Fragment.listenTo("aststatus",this,function(e){if(e===n.originast){var t=n.originast.doxyComment;if(t){var r=t.getControls();r["@title"]&&(n.title=r["@title"][0])}Eden.Fragment.emit("status",[n])}}),Eden.Fragment.listenTo("patch",this,function(e,t){e!==n&&t===n.originast&&(n.source=n.originast.getInnerSource(),n.ast=Eden.AST.fromNode(n.originast,n),Eden.Fragment.emit("changed",[n]))}),Eden.Fragment.listenTo("lock",this,function(e,t){t===n.originast&&(n.locked=!0,Eden.Fragment.emit("locked",[n]))}),Eden.Fragment.listenTo("unlock",this,function(e,t){t===n.originast&&(n.locked=!1,Eden.Fragment.emit("unlocked",[n]))}),Eden.Fragment.listenTo("goto",this,function(e,t){if(this.originast===e){console.log("Goto line",t.getStartLine(e));var r=t.getStartLine(e);return Eden.Fragment.emit("gotoline",[n,r]),!0}return void 0===e&&this.setSourceInitial(t.source),!1}),t&&t()})},Eden.Fragment.listenTo=listenTo,Eden.Fragment.emit=emit,Eden.Fragment.unListen=unListen,Eden.Fragment.listeners={},Eden.Fragment.prototype.destroy=function(){Eden.Fragment.unListen(this),this.unlock()},Eden.Fragment.prototype.reset=function(e){var t=this;if(this.scratch)return t.lock(),t.snapshot=t.source,Eden.Fragment.emit("changed",[t]),void(e&&e());Eden.Selectors.query(this.selector,void 0,{minimum:1},function(n){if(t.results=n,t.results&&1==t.results.length&&"script"==t.results[0].type)t.originast=t.results[0];else if(t.results&&1==t.results.length&&"assignment"==t.results[0].type)t.originast=void 0;else if(t.results&&t.results.length>1){for(var r="",i=0;i<t.results.length;i++)r+=t.results[i].getSource()+"\n";t.source=r,t.originast=void 0}else t.source="",t.originast=void 0;t.originast?(t.name=t.originast.name?t.originast.name:t.selector,Eden.AST.fromNode(t.originast,t).then(n=>{t.ast=n,t.source=t.ast.stream.code;for(var r=t.originast;r&&r.parent;)r=r.parent;t.origin=r.base?r.base.origin:{remote:!0},t.remote=t.origin.remote,t.locked=t.originast.lock>0||t.remote;var i=t.originast.doxyComment;if(i){t.doxy=i;var s=i.getControls();s["@title"]&&(t.title=s["@title"][0])}else t.doxy=void 0;Eden.Fragment.emit("changed",[t]),t.locked&&Eden.Fragment.emit("locked",[t]),t.lock(),t.snapshot=t.source,e&&e()})):(console.log("Make scratch fragment"),t.locked=!1,t.remote=!1,t.ast=new Eden.AST(t.source,void 0,t,{noindex:!0,strict:!0}),t.originast=t.ast.script,t.name="*Scratch*",t.title=t.name,t.scratch=!0,Eden.Fragment.emit("changed",[t]),t.lock(),t.snapshot=t.source,e&&e())})},Eden.Fragment.prototype.getSource=function(){return this.source?this.source:""},Eden.Fragment.prototype.makeReal=function(e){if(this.scratch){this.name=e,this.title=e,this.originast=eden.project.addAction(e),this.selector=Eden.Selectors.getID(this.originast),this.scratch=!1,this.remote=!1,this.setSource(this.source);for(var t=this.originast;t&&t.parent;)t=t.parent;this.origin=t.base.origin,this.lock()}},Eden.Fragment.prototype.setSourceInitial=function(e){this.source=e,this.snapshot=e,this.ast=new Eden.AST(e,void 0,this,{strict:!0,noindex:this.scratch})},Eden.Fragment.AUTOSAVE_INTERVAL=2e3,Eden.Fragment.prototype.undo=function(){if(!(this.index<0)&&0!=this.history.length){var e,t=this.history[this.index];if(this.index--,this.index>=0&&this.history[this.index].snapshot)e=this.history[this.index].snapshot;else{var n=new diff_match_patch,r=n.patch_fromText(t.undo);e=n.patch_apply(r,this.snapshot)[0]}this.snapshot=e,this.setSource(e)}},Eden.Fragment.prototype.canUndo=function(){return this.history.length>0&&this.index>=0},Eden.Fragment.prototype.canRedo=function(){return this.index<this.history.length-1},Eden.Fragment.prototype.redo=function(){if(!(this.index>=this.history.length-1)){this.index++;var e,t=this.history[this.index];if(t.snapshot)e=t.snapshot;else{var n=new diff_match_patch,r=n.patch_fromText(t.redo);e=n.patch_apply(r,this.snapshot)[0]}this.snapshot=e,this.setSource(e)}},Eden.Fragment.prototype.addHistory=function(e,t){this.history.push({time:Date.now()/1e3|0,redo:e,undo:t}),this.index=this.history.length-1},Eden.Fragment.prototype.autoSave=function(){if(!(void 0===this.ast||this.ast.script.errors.length>0)&&this.originast&&!this.scratch){for(var e=this.originast;e.parent;)e=e.parent;e.base&&e.base.origin&&!e.base.origin.authorid==Eden.DB.userid&&(eden.root.lookup("jseden_script_livepatch").value()&&(console.log("AUTOSAVE",this.selector),Eden.DB.patch(Eden.Selectors.getID(this.originast),this.ast.script.getInnerSource())),this.autosavetimer=void 0)}},Eden.Fragment.prototype.diff=function(){if(this.origin&&this.origin.ast&&this.originast.end>0){var e=this.origin.ast.stream.code.substring(this.originast.start,this.originast.end),t=this.originast.prefix.length,n=this.originast.postfix.length;return e=e.substring(t,e.length-n),DiffUtil.diff(e,this.source)}},Eden.Fragment.prototype.setSource=function(e){if(!this.locked){var t=this;if(this.source=e,this.edited=!0,this.ast=new Eden.AST(e,void 0,this,{noindex:!0,strict:!0}),0==this.ast.errors.length){if(clearTimeout(this.autosavetimer),this.autosavetimer=setTimeout(function(){t.autoSave()},Eden.Fragment.AUTOSAVE_INTERVAL),this.originast){var n=this.originast.parent,r=this.originast.patchInner(this.ast.script);for(Eden.Fragment.emit("patch",[this,this.originast,r]);n;)Eden.Fragment.emit("patch",[this,n]),n=n.parent}Eden.Fragment.emit("status",[this]),eden.root.lookup("jseden_fragment_changed").assign(t.selector,eden.root.scope,Symbol.localJSAgent)}else Eden.Fragment.emit("errored",[this])}},Eden.Fragment.prototype.lock=function(){if(this.originast)for(var e=this.originast.parent;e;)e.lock++,Eden.Fragment.emit("lock",[this,e]),e=e.parent},Eden.Fragment.prototype.unlock=function(){if(this.originast)for(var e=this.originast.parent;e;)e.lock--,0==e.lock&&Eden.Fragment.emit("unlock",[this,e]),e=e.parent},Eden.Fragment.prototype.getTitle=function(){return this.originast&&this.originast.name?this.originast.name:this.name},Eden.Query={},Eden.Query.sortByCount=sortByCount,Eden.Query.reduceByCount=reduceByCount,Eden.Query.negativeFilter=negativeFilter,Eden.Query.search=function(e,t){var n=e.split(/[ ]+/),r=0,i=n.length,s=!0,o=!0,a=!0,d=!0,c={views:[],symbols:[],whens:[],projects:[],scripts:[],statements:[]};if(n.length>0&&":"==n[0].charAt(n[0].length-1)){if(r=1,!0,"select:"==n[0]){var h=e.substring(n[0].length).trim();return c.all=Eden.Selectors.queryWithinSync(null,h,"source"),void 0===c.all&&(c.all=[]),t&&t(c),t&&h.length>=3&&(Eden.Query.dbseltimeout&&clearTimeout(Eden.Query.dbseltimeout),Eden.Query.dbseltimeout=setTimeout(function(){Eden.Query.dbseltimeout=void 0,Eden.DB.searchSelector(h,"source",function(e){c.all.push.apply(c.all,e),t(c)})},1e3)),c}switch(n[0]){case"procs:":case"whens:":case"agents:":o=!0,s=!1,!1,a=!1,doremovescripts=!1,!0,!1;break;case"scripts:":o=!1,s=!1,a=!0,d=!0,!1,!1,!1}}for(i-=r;r<n.length;r++)if(""!=n[r])if(n[r].startsWith("depends:")){var p=n[r].split(":");if(""==p[1]){i--;continue}var l=edenUI.regExpFromStr(p[1],void 0,void 0,"regexp");s&&c.symbols.push.apply(c.symbols,Eden.Query.searchDepends(l))}else if("#"==n[r].charAt(0)){var u=edenUI.regExpFromStr("^"+n[r].substring(1),void 0,void 0,"regexp");s&&c.symbols.push.apply(c.symbols,Eden.Query.searchTags(u))}else{l=edenUI.regExpFromStr(n[r],void 0,void 0,"regexp"),u=edenUI.regExpFromStr("^"+n[r],void 0,void 0,"regexp");s&&c.symbols.push.apply(c.symbols,Eden.Query.searchSymbols(l,u)),o&&c.whens.push.apply(c.whens,Eden.Query.searchWhens(l)),d&&n[r].length>2?function(e){Eden.Query.dbtimeout&&clearTimeout(Eden.Query.dbtimeout),Eden.Query.dbtimeout=setTimeout(function(){Eden.Query.dbtimeout=void 0,Eden.DB.search(e,function(e){c.scripts.push.apply(c.scripts,e),c.scripts=reduceByCount(c.scripts,i),c.scripts=sortByLoaded(c.scripts),Eden.Query.mergeResults(c),t&&t(c)})},500)}(n[r]):a&&c.scripts.push.apply(c.scripts,Eden.Query.searchScripts(l))}else i--;return c.symbols=reduceByCount(c.symbols,i),Eden.Query.mergeResults(c),t&&t(c),c},Eden.Query.mergeResults=function(e){e.all=[];var t=0;!function n(r,i){t=0;for(var s=i;s<e.symbols.length&&!(t>=r);s++)t++,e.all.push("/"+e.symbols[s]);t=0;for(s=i;s<e.whens.length&&!(t>=r);s++)t++,e.all.push(e.whens[s]);t=0;for(s=i;s<e.scripts.length&&!(t>=r-1);s++)t++,e.all.push("*script"+e.scripts[s]);t=0;for(s=i;s<e.statements.length&&!(t>=r);s++)t++,e.all.push(e.statements[s]);(e.symbols.length>i+r||e.whens.length>i+r||e.scripts.length>i+r)&&n(2,i+r)}(3,0)},Eden.Query.searchViews=function(e){},Eden.Query.searchSymbols=function(e,t){var n=[];for(var r in eden.root.symbols){var i=eden.root.symbols[r];if(e.test(r))i.last_modified_by.internal||"_"==r.charAt(0)||n.push(r);else if(t&&eden.dictionary[r]){var s=eden.dictionary[r].getHashTags();if(s)for(var o=0;o<s.length;o++)if(t.test(s[o].substring(1))){i.last_modified_by.internal||"_"==r.charAt(0)||n.push(r);break}}}return n},Eden.Query.searchTags=function(e){var t=[];for(var n in eden.root.symbols){var r=eden.root.symbols[n];if(e&&eden.dictionary[n]){var i=eden.dictionary[n].getHashTags();if(i)for(var s=0;s<i.length;s++)if(e.test(i[s].substring(1))){r.last_modified_by.internal||"_"==n.charAt(0)||t.push(n);break}}}return t},Eden.Query.searchDepends=function(e){var t=[];for(var n in eden.root.symbols)for(var r in eden.root.symbols[n].dependencies)e.test(r)&&t.push(n);return t},Eden.Query.searchWhens=function(e){var t=[];for(var n in Eden.Agent.agents){var r=Eden.Agent.agents[n];if(r.ast)for(var i in r.ast.triggers)if(e.test(i))for(var s=r.ast.triggers[i],o=0;o<s.length;o++)-1==t.indexOf(s[o].statement)&&t.push(s[o].statement)}return t},Eden.Query.searchProjects=function(e){},Eden.Query.searchScripts=function(e){var t=[];for(var n in Eden.DB.meta)e.test(n)&&t.push(n);return t},Eden.Query.treeBottomUp=function(){var e={};for(var t in eden.root.symbols){var n=eden.root.symbols[t];void 0!==n.definition&&0!=Object.keys(n.dependencies).length||(e[t]={})}return function e(t){for(var n in t){var r=eden.root.symbols[n];if(r){var i=t[n];for(var s in r.subscribers)i[s]={};e(i)}}}(e),e},Eden.Query.treeTopDown=function(e){if(void 0===e)for(var t in e={},eden.root.symbols){var n=eden.root.symbols[t];n&&(0==Object.keys(n.subscribers).length&&(e[t]={}))}else if(Array.isArray(e)){for(var r={},i=0;i<e.length;i++)r[e[i]]={};e=r}return function e(t){for(var n in t){var r=eden.root.symbols[n];if(r){var i=t[n];for(var s in r.dependencies)i[s]={};e(i)}}}(e),e},Eden.Query.objectHierarchy=function(){function e(e){if(void 0!==e.statid){var t=Eden.Statement.statements[e.statid];if(t.statement&&t.statement.doxyComment&&t.statement.doxyComment.hasTag("#library"))return!1}return!0}var t={};for(var n in eden.root.symbols){var r=eden.root.symbols[n];r&&e(r)&&(0==Object.keys(r.subscribers).length&&0!=Object.keys(r.dependencies).length&&(t[n]={}))}return function t(n){for(var r in n){var i=eden.root.symbols[r];if(i&&e(i)){var s=n[r];for(var o in i.dependencies)s[o]={};t(s)}}}(t),t},Eden.Query.dependencyTree=function(e){var t={};function n(e,t){for(var r in t)void 0===e[r]?e[r]=t[r]:n(e[r],t[r])}function r(e){var i=e.name;if(0==Object.keys(e.subscribers).length)return void 0===t[i]&&(t[i]={}),t[i];var s={};for(var o in e.subscribers){var a=r(e.subscribers[o]);void 0!==a[i]&&n(s,a[i]),a[i]=s}return s}for(var i in e)r(eden.root.lookup(i));return t},Eden.Generator={},Eden.Generator.symbolScript=function(e){var t="## Functions\n",n="\n## Definitions\n",r="\n## Restored Definition\n",i="\n## Agent Definitions\n",s="\n## Assignments\n",o="\n## Agent Assignments\n",a="\n## Input Device Assignments\n",d="\n## Restored Assignments\n";for(var c in eden.root.symbols){var h=eden.root.symbols[c],p=h.last_modified_by;if(void 0===p&&console.log(h),"string"!=typeof p.name&&console.log(p),"*Default"!=p.name&&(p.canUndo&&p.canUndo()||e&&e[p.name]||p.meta&&p.last_exec_version!=p.meta.saveID||"*"==p.name.charAt(0)||"/"==p.name.charAt(0)))if(h.eden_definition)h.eden_definition.startsWith("func")?t+=h.eden_definition+"\n":"*Restore"==p.name?r+=h.eden_definition+"\n":"*When"==p.name?i+=h.eden_definition+"\n":n+=h.eden_definition+"\n";else if(void 0!==h.cache.value){var l=c+" = "+Eden.edenCodeForValue(h.cache.value)+";\n";p instanceof Symbol&&p.eden_definition&&p.eden_definition.startsWith("proc")||"*JavaScript"==p.name||"*When"==p.name?o+=l:"*Input Device"==p.name?a+=l:"*Restore"==p.name?d+=l:s+=l}}return t+n+r+i+s+d+o+a+"\n## Procedures\n"},Eden.Generator.importsScript=function(){var e="";for(var t in Eden.Agent.agents){var n=Eden.Agent.agents[t],r="";if(-1!=n.meta.saveID||n.meta.file||(r=" create"),n.last_exec_version)e+="import "+t+"@"+(-1==n.last_exec_version?"origin":n.last_exec_version)+r+";\n";if(n.last_exec_version!=n.meta.saveID)e+="import "+t+"@"+(-1==n.meta.saveID?"origin":n.meta.saveID)+r+" noexec;\n"}return e},Eden.Generator.getScript=function(){return Eden.Generator.importsScript()+"\n"+Eden.Generator.symbolScript()},Eden.Peer=function(e,t){this.connections={},this.id=t,this.master=e;var n=this;function r(e){!function e(t,n,r){Eden.Selectors.query(n.remove[t].path,void 0,void 0,function(i){var s=i[0];if(s){this.frags[n.remove[t].path]=s;var o=void 0;if(0==n.remove[t].id)o=s.statements[0];else for(var a=0;a<s.statements.length;a++)if(s.statements[a].id==n.remove[t].id){n.remove[t].ws?(o=s.statements[a].nextSibling)&&"dummy"!=o.type&&(o=void 0):o=s.statements[a];break}if(o){for(var a=0;a<n.add.length;a++)n.add[a].ws&&n.add[a].id==o.id&&(n.add[a].id=o.previousSibling?o.previousSibling.id:0);this.todorm.push([s,o])}t<n.remove.length-1?e(t+1,n,r):r()}else t<n.remove.length-1?e(t+1,n,r):r()})}(0,e,function(){for(var t=0;t<this.todorm.length;t++)this.todorm[t][0].removeChild(this.todorm[t][1]);!function(e){!function e(t,n,r){Eden.Selectors.query(n.add[t].path,void 0,void 0,function(i){var s=i[0];if(s){if(this.frags[n.add[t].path]=s,n.add[t].ws){var o=new Eden.AST.DummyStatement;if(o.source=n.add[t].source,o.numlines=o.source.split("\n").length-1,0==n.add[t].id)s.statements[0]?s.insertBefore(s.statements[0],o):s.appendChild(o),o.buildID();else{for(var a=0;a<s.statements.length;a++)if(s.statements[a].id==n.add[t].id){var d=s.statements[a].nextSibling;d?s.insertBefore(d,o):s.appendChild(o),o=void 0;break}o&&(s.appendChild(o),o.buildID())}}else{var o=Eden.AST.parseStatement(n.add[t].source);s.statements[n.add[t].index]?s.insertBefore(s.statements[n.add[t].index],o):s.appendChild(o)}t<n.add.length-1?e(t+1,n,r):r()}else t<n.add.length-1?e(t+1,n,r):r()})}(0,e,function(){for(var t in this.frags)Eden.Fragment.emit("patch",[void 0,this.frags[t]]);n.broadcastExcept(e.id,e)})}(e)})}function i(e,t){var i=JSON.parse(t);i.id=e.peer;var s=n.connections[i.id];switch(i.cmd){case"assign":s.observe&&function(e){var t=eden.root.lookup(e.symbol),r=Eden.AST.parseExpression(e.value);t.assign(r.execute({},EdenSymbol.netAgent,eden.root.scope),eden.root.scope,EdenSymbol.netAgent),n.broadcastExcept(e.id,e)}(i);break;case"define":s.observe&&function(e){eden.root.lookup(e.symbol);var t=Eden.AST.parseStatement(e.source);t.local=!0,t.execute({},EdenSymbol.netAgent,eden.root.scope),n.broadcastExcept(e.id,e)}(i);break;case"do":s.observe&&processDo(i);break;case"listassign":s.observe&&function(e){var t=eden.root.lookup(e.symbol),r=Eden.AST.parseExpression(e.value);t.listAssign(r.execute({},EdenSymbol.netAgent,eden.root.scope),eden.root.scope,EdenSymbol.netAgent,!1,e.components),n.broadcastExcept(e.id,e)}(i);break;case"restore":s.observe&&function(e){n.loading=!0,eden.root.lookup("jseden_project_mode").assign(eden.root.lookup("jseden_p2p_doactive").value()?"restore":"normal",eden.root.scope,Symbol.defaultAgent),eden.project=new Eden.Project(e.pid,e.name,e.script),Eden.Project.emit("loading",[eden.project]),eden.project.vid=e.vid,eden.project.title=e.title,eden.project.author=e.ownername,eden.project.authorid=e.owner,eden.project.start(function(){Eden.Project.emit("load",[eden.project]),n.loading=!1})}(i);break;case"execstatus":s.observe;break;case"register":!function(e){console.log("Register peer",e.id,e.username),Eden.Peer.emit("user",[e.id,e.username]),eden.root.lookup("jseden_p2p_"+e.id+"_name").assign(e.username,eden.root.scope,EdenSymbol.localJSAgent),n.connections[e.id].connection.send(JSON.stringify({cmd:"status",status:"Connected",code:1}))}(i);break;case"status":Eden.Peer.emit("status",[i.status,i.code]);break;case"getsnapshot":!function(e){var t=eden.project.generate();n.connections[e.id].connection.send(JSON.stringify({cmd:"callback",data:t,cbid:e.cbid}))}(i);break;case"callback":!function(e){var t=n.callbacks[e.cbid];t&&t(e.data),delete n.callbacks[e.cbid]}(i);break;case"reqshare":!function(e){var t=n.connections[e.id];if(e.value){if(t.share=!0,eden.project&&n.clone){var r=eden.project.generate();t.connection.send(JSON.stringify({cmd:"restore",script:r,pid:eden.project.id,vid:eden.project.vid,ownername:eden.project.author,owner:eden.project.authorid,name:eden.project.name,title:eden.project.title}))}t.connection.send(JSON.stringify({cmd:"callback",data:!0,cbid:e.cbid})),Eden.Peer.emit("share",[e.id])}else t.share=!1,Eden.Peer.emit("unshare",[e.id])}(i);break;case"reqobserve":!function(e){var t=n.connections[e.id];e.value?(t.observe=!0,t.connection.send(JSON.stringify({cmd:"callback",data:!0,cbid:e.cbid})),Eden.Peer.emit("observe",[e.id])):(t.observe=!1,Eden.Peer.emit("unobserve",[e.id]))}(i);break;case"patch":!function(e){this.frags={},this.todorm=[],r(e)}(i);break;case"when":!function(e){console.log("ProcessWhen",e),Eden.Selectors.query(".id("+e.wid+")",void 0,void 0,function(t){for(var n=0;n<t.length;n++)e.status?eden.project.registerAgent(t[n],!0):eden.project.removeAgent(t[n],!0)})}(i);break;case"require":!function(e){edenUI.loadPlugin(e.name)}(i);break;case"call":!function(e){var t=eden.root.lookup(e.name);try{t.value().apply(t,e.args)}catch(e){}}(i)}n.config.logging&&console.log(i)}function s(r){if(!n.enabled){if(r){var s;r.replace(/[ \!\'\-\?\&]/g,"");s=t?new Peer(t,{config:{iceServers:[{url:"stun:stun.l.google.com:19302"}]}}):new Peer({config:{iceServers:[{url:"stun:stun.l.google.com:19302"}]}}),(t||e)&&(n.enabled=!0),s.on("open",function(t){if(console.log("My peer id is "+t),e){var o=s.connect(e,{reliable:!0});o.on("open",function(){n.connections[o.peer]={id:o.peer,username:void 0,connection:o,share:!1,observe:!1},o.on("data",function(e){i(o,e)}),eden.root.lookup("jseden_p2p_newconnections").append(o.peer,eden.root.scope,EdenSymbol.localJSAgent),o.send(JSON.stringify({cmd:"register",username:r,id:t}))})}}),s.on("connection",function(e){n.connections[e.peer]={id:e.peer,username:void 0,connection:e,share:!1,observe:!1},e.on("data",function(t){i(e,t)}),console.log("Peer connection from "+e.peer),Eden.Peer.emit("peer",[e.peer]),eden.root.lookup("jseden_p2p_newconnections").append(e.peer,eden.root.scope,EdenSymbol.localJSAgent),e.on("open",function(){if(n.config.share&&n.clone){var t=eden.project.generate();e.connection.send(JSON.stringify({cmd:"restore",script:t,pid:eden.project.id,vid:eden.project.vid,ownername:eden.project.author,owner:eden.project.authorid,name:eden.project.name,title:eden.project.title}))}})}),s.on("error",function(e){console.log("Peer error: ",e),Eden.Peer.emit("error",[e]),eden.root.lookup("jseden_p2p_errors").append(e,eden.root.scope,EdenSymbol.localJSAgent)}),s.on("disconnected",function(e){Eden.Peer.emit("disconnect",[e.peer,n.connections[e.peer]?n.connections[e.peer].username:void 0]),delete n.connections[e.peer],eden.root.lookup("jseden_p2p_newdisconnections").append(e.peer,eden.root.scope,EdenSymbol.localJSAgent)})}Eden.Fragment.listenTo("patch",this,function(e,t,r){if(r&&r.length>0&&n.capturepatch){var i={cmd:"patch",remove:r[1],add:r[0]};n.broadcast(i)}})}}this.roles={},this.enabled=!1,this.loading=!1,this.config={control:!0,share:!1,observe:!1,logging:!1},this.callbacks={},this.callbackid=0,this.capturepatch=!1,this.record=!1,this.clone=!0,this.startrecordtime=0,this.log=null,this.frags={},this.todorm=[],void 0===eden.root.lookup("jseden_p2p_newconnections").value()&&eden.root.lookup("jseden_p2p_newconnections").assign([],eden.root.scope,EdenSymbol.defaultAgent),void 0===eden.root.lookup("jseden_p2p_newdisconnections").value()&&eden.root.lookup("jseden_p2p_newdisconnections").assign([],eden.root.scope,EdenSymbol.defaultAgent),void 0===eden.root.lookup("jseden_p2p_errors").value()&&eden.root.lookup("jseden_p2p_errors").assign([],eden.root.scope,EdenSymbol.defaultAgent),void 0===eden.root.lookup("jseden_p2p_doactive").value()&&eden.root.lookup("jseden_p2p_doactive").assign(!0,eden.root.scope,EdenSymbol.defaultAgent),Eden.Selectors.execute("lib > p2p",eden.root.scope),Eden.DB.listenTo("login",this,s),(e||Eden.DB.isLoggedIn()&&t)&&s(Eden.DB.username?Eden.DB.username:"Anonymous"),eden.root.lookup("jseden_p2p_captureinput").addJSObserver("p2p",function(e,t){t?(EdenSymbol.hciAgent.local=!1,EdenSymbol.localJSAgent.local=!1):(EdenSymbol.hciAgent.local=!0,EdenSymbol.localJSAgent.local=!0)});var o=eden.root.lookup("jseden_p2p_clone");void 0===o.value()&&o.assign(!0,eden.root.scope,EdenSymbol.defaultAgent),o.addJSObserver("p2p",function(e,t){n.clone=!!t}),eden.root.lookup("jseden_p2p_captureedits").addJSObserver("p2p",function(e,t){n.capturepatch=t}),eden.root.lookup("jseden_p2p_record").addJSObserver("p2p",function(e,t){n.record=t,t&&(n.startrecordtime=Date.now(),n.log=[])}),edenUI.views.Peers={dialog:function(e,t){e.slice(0,-7),$('<div id="'+e+'"></div>').html("").dialog({title:"Peer Connections",width:200,height:300,minHeight:120,minWidth:100})},title:"Connections",category:edenUI.viewCategories.environment},edenUI.menu.updateViewsMenu()},Eden.Peer.listeners={},Eden.Peer.emit=emit,Eden.Peer.listenTo=listenTo,Eden.Peer.prototype.broadcast=function(e){if(!this.loading)for(var t in e=JSON.stringify(e),this.record&&this.log.push('{"timestamp": '+(Date.now()-this.startrecordtime)+', "message": "'+e+'"}'),this.connections){var n=this.connections[t];n.share&&n.connection.send(e)}},Eden.Peer.prototype.broadcastExcept=function(e,t){if(!this.loading&&void 0!==this.id)for(var n in t=JSON.stringify(t),this.connections)if(n!=e){var r=this.connections[n];r.share&&r.connection.send(t)}},Eden.Peer.prototype.authoriseWhen=function(e){if(this.enabled){if(e.roles){var t=e.roles;if(t&&t.length>0){for(var n=0;n<t.length;n++)if(this.roles[t[n]])return!0;return!1}}return!0}return!0},Eden.Peer.prototype.assign=function(e,t,n){!e||e.loading||e.local||this.broadcast({cmd:"assign",symbol:t,value:Eden.edenCodeForValue(n)})},Eden.Peer.prototype.define=function(e,t,n,r){!e||e.loading||e.local||this.broadcast({cmd:"define",symbol:t,source:n,dependencies:r})},Eden.Peer.prototype.doRequire=function(e){this.broadcast({cmd:"require",name:e})},Eden.Peer.prototype.doImport=function(e,t){},Eden.Peer.prototype.callProcedure=function(e,t){this.broadcast({cmd:"call",name:e,args:t})},Eden.Peer.prototype.activateWhen=function(e){this.broadcast({cmd:"when",status:!0,wid:e})},Eden.Peer.prototype.deactivateWhen=function(e){this.broadcast({cmd:"when",status:!1,wid:e})},Eden.Peer.prototype.listAssign=function(e,t,n,r){!e||e.loading||e.local||this.broadcast({cmd:"listassign",symbol:t,value:Eden.edenCodeForValue(n),components:r})},Eden.Peer.prototype.addCallback=function(e){var t=this.callbackid++;return this.callbacks[t]=e,t},Eden.Peer.prototype.getSnapshot=function(e,t){this.connections[e]&&this.connections[e].connection.send(JSON.stringify({cmd:"getsnapshot",cbid:this.addCallback(t)}))},Eden.Peer.prototype.requestShare=function(e,t){var n=this.connections[e];n&&(n.observe=!0,n.connection.send(JSON.stringify({cmd:"reqshare",value:!0,cbid:this.addCallback(t)})))},Eden.Peer.prototype.requestUnShare=function(e,t){var n=this.connections[e];n&&(n.observe=!1,n.connection.send(JSON.stringify({cmd:"reqshare",value:!1,cbid:this.addCallback(t)})))},Eden.Peer.prototype.requestObserve=function(e,t){var n=this.connections[e];if(n&&(n.share=!0,n.connection.send(JSON.stringify({cmd:"reqobserve",value:!0,cbid:this.addCallback(t)})),eden.project&&this.clone)){var r=eden.project.generate();n.connection.send(JSON.stringify({cmd:"restore",script:r,pid:eden.project.id,vid:eden.project.vid,ownername:eden.project.author,owner:eden.project.authorid,name:eden.project.name,title:eden.project.title}))}},Eden.Peer.prototype.requestUnObserve=function(e,t){var n=this.connections[e];n&&(n.share=!1,n.connection.send(JSON.stringify({cmd:"reqobserve",value:!1,cbid:this.addCallback(t)})))},Eden.Peer.prototype.requestCollaborate=function(e,t){var n=this,r=this.connections[e];if(r&&(r.connection.send(JSON.stringify({cmd:"reqshare",value:!0,cbid:this.addCallback(function(){r.observe=!0,n.requestObserve(e,t)})})),eden.project&&n.clone)){var i=eden.project.generate();r.connection.send(JSON.stringify({cmd:"restore",script:i,pid:eden.project.id,vid:eden.project.vid,ownername:eden.project.author,owner:eden.project.authorid,name:eden.project.name,title:eden.project.title}))}},Eden.Peer.prototype.requestUnCollaborate=function(e,t){},Eden.AST.DummyContext={subscribeDynamic:function(e,t){return t},scopes:[]},Eden.AST.prototype.executeGenerator=function*(e,t,n,r,i){var s=[];this.executed=1;var o=0;if(void 0!==e)for(;o<e.length||s.length>0;){if(o>=e.length&&s.length>0){e=s[s.length-1].statements,o=s[s.length-1].index,r=s[s.length-1].scope,s.pop(),!0;continue}let u=e[o];if(Eden.AST.debug&&"script"!==u.type)if(Eden.AST.debugstep||i&&i.doDebug&&i.doDebug())yield{type:"debug",base:n,script:this,index:o,statement:u,context:t,agent:i};switch(u.type){case"wait":u.executed=1,u.compile(t),u.compiled_delay?yield u.compiled_delay(r.context,r):yield 0;break;case"import":void 0===u.statements&&(u.selector=u.path?u.path.execute(t,n,r,i):void 0,yield u);break;case"query":u.modexpr&&(u.executed=1,u._selector=u.selector.execute(t,n,r,i),u._modexpr=u.modexpr.execute(t,n,r,i),yield u);break;case"do":if(u.executed=1,u.selector=u.name?u.name.execute(t,n,r,i):void 0,u.nscope=u.getScope(t,r)(r.context,r),u.literal){var a={isconstant:!1,locals:t.locals},d=Eden.AST.executeExpressionNode(u.literal,u.nscope,a),c=Eden.AST.parseScript(d,u);if(c&&c.errors.length>0)throw c.errors[0];u.statements=c?c.statements:[]}yield u;break;case"when":var h=u;if(0==h.active)h.active=!0,(p=h.execute(void 0,n,r,i))?n.executeStatements(p,-1,h,null,null,r):h.active=!1;break;default:var p;if((p=u.execute(t,n,r,i))&&Array.isArray(p)&&p.length>0){var l=r;"scopedscript"==u.type&&(l=u.scope),++o<e.length&&s.push({statements:e,index:o,scope:r}),e=p,r=l,o=0;continue}if(-1===p)return}u.errors.length>0&&this.script.errors.push.apply(this.script.errors,u.errors),o++}},Eden.AST.prototype.executeStatement=function(e,t,n,r){Eden.AST.debug&&(Eden.AST.debugstep||n&&n.doDebug&&n.doDebug())&&Eden.AST.debug_begin_cb&&Eden.AST.debug_begin_cb({base:this,agent:n}),Eden.AST.DummyContext.locals=void 0;let i={cb:r,result:void 0};try{var s=this.executeGenerator([e],i,this,t,n);runEdenAction.call(this,n,t,s,function(){Eden.AST.debug&&(Eden.AST.debugstep||n&&n.doDebug&&n.doDebug())&&Eden.AST.debug_end_cb&&Eden.AST.debug_end_cb({base:this,agent:n}),r&&r(i.result)})}catch(e){var o;Eden.AST.debug&&(Eden.AST.debugstep||n&&n.doDebug&&n.doDebug())&&Eden.AST.debug_end_cb&&Eden.AST.debug_end_cb({base:this,agent:n}),r&&r(e),(o=/[0-9][0-9]*/.test(e.message)?new Eden.RuntimeError(t.context,parseInt(e.message),void 0,e.message):new Eden.RuntimeError(t.context,0,void 0,e)).line=this.line,n?t.context.instance.emit("error",[n,o]):console.log(o.prettyPrint())}},Eden.AST.prototype.executeStatements=function(e,t,n,r,i,s){if(!s)throw"Missing scope";Eden.AST.debug&&(Eden.AST.debugstep||n&&n.doDebug&&n.doDebug())&&Eden.AST.debug_begin_cb&&Eden.AST.debug_begin_cb({base:this,agent:n});try{var o=this.executeGenerator(e,i,this,s,n);runEdenAction.call(this,n,s,o,function(){Eden.AST.debug&&(Eden.AST.debugstep||n&&n.doDebug&&n.doDebug())&&Eden.AST.debug_end_cb&&Eden.AST.debug_end_cb({base:this,agent:n}),r&&r()})}catch(e){var a;console.error(e),Eden.AST.debug&&(Eden.AST.debugstep||n&&n.doDebug&&n.doDebug())&&Eden.AST.debug_end_cb&&Eden.AST.debug_end_cb({base:this,agent:n}),r&&r(),(a=/[0-9][0-9]*/.test(e.message)?new Eden.RuntimeError(this,parseInt(e.message),void 0,e.message):new Eden.RuntimeError(this,0,void 0,e)).line=this.line,n?s.context.instance.emit("error",[n,a]):console.log(a.prettyPrint())}};