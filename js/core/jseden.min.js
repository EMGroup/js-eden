function noop(){}function get_time_diff(e){var t=1e3*e,n=Date.now();if(t-=6e4*(new Date).getTimezoneOffset(),isNaN(t))return"";if(t<n)var r=n-t;else r=t-n;var i=Math.floor(r/1e3/60/1440),s=new Date(r);if(i>5)return new Date(t).toDateString();var o="";if(i>0)o+=i,o+=i>1?" days ago":" day ago";else if(s.getUTCHours()>0){var a=s.getUTCHours();o+=a,o+=a>1?" hours ago":" hour ago"}else{var d=s.getUTCMinutes();if(d>0)o+=d,o+=d>1?" minutes ago":" minute ago";else{var h=s.getUTCSeconds();o+=h,o+=" seconds ago"}}return o}function generateTimeStamp(e){for(var t,n=/(\d*)(minutes|minute|min|hours|hour|days|day|weeks|week|months|month|mon|years|year|Quarters|Quarter|seconds|second|sec|s|m|h|d|M|y|Y|Q|ms|w)/g,r=0;null!==(t=n.exec(e));)switch(console.log("Reltime:",t),t[2]){case"second":case"seconds":case"s":r+=1e3*parseInt(t[1]);break;case"minute":case"minutes":case"m":r+=6e4*parseInt(t[1]);break;case"hour":case"hours":case"h":r+=36e5*parseInt(t[1]);break;case"days":case"d":r+=36e5*parseInt(t[1])*24}return r}function hashCode(e){var t=0;if(0==e.length)return t;for(i=0;i<e.length;i++)char=e.charCodeAt(i),t=(t<<5)-t+char,t&=t;return t}function getTextWidth(e,t){var n=(getTextWidth.canvas||(getTextWidth.canvas=document.createElement("canvas"))).getContext("2d");return n.font=t,n.measureText(e).width}function unListen(e){for(var t in this.listeners)for(var n=this.listeners[t],r=0;r<n.length;r++)if(n[r].target===e){n.splice(r,1);break}}function listenTo(e,t,n){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push({target:t,callback:n})}function emit(e,t){var n=this.listeners[e];if(n){var r;for(r=0;r<n.length;++r){var i=n[r].target;if(n[r].callback.apply(i,t))return!0}return!1}}function concatAndResolveUrl(e,t){for(var n=e.split("/"),r=t.split("/"),i=[],s=0,o=n.length;s<o;s++)if(".."==n[s])i.pop();else{if("."==n[s])continue;i.push(n[s])}for(s=0,o=r.length;s<o;s++)if(".."==r[s])i.pop();else{if("."==r[s])continue;i.push(r[s])}return i.join("/")}mobilecheck=function(){if(void 0!==Eden.mobile)return Eden.mobile;var e,t=!1;return e=navigator.userAgent||navigator.vendor||window.opera,(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))&&(t=!0),Eden.mobile=t,t},Utils={flatten:function(e){for(var t=[],n=0,r=e.length;n<r;++n)t=t.concat(e[n]instanceof Array?this.flatten(e[n]):e[n]);return t},construct:function(){var e=function(){};return function(t){e.prototype=t.prototype;for(var n=new e,r=[],i=1;i<arguments.length;i++)r.push(arguments[i]);return t.apply(n,r),n}}()},DiffUtil={},DiffUtil.diff=function(e,t){var n=new diff_match_patch,r=n.diff_main(e,t);n.diff_cleanupSemantic(r),console.log(r);for(var i={remove:{},insert:{}},s=0,o=0,a=0,d=0,h=0;h<r.length;h++){var c=r[h][1].match(/\n/g);if(0!=r[h][0]){if(1==r[h][0]){lines=r[h][1].split("\n");for(var p=0;p<lines.length&&(p!=lines.length-1||0!=lines[p].length);p++)void 0===i.insert[o+p]&&(i.insert[o+p]={oline:s,chars:[]}),i.insert[o+p].chars.push({start:a,length:lines[p].length}),p>0&&(i.insert[o+p].consecutive=!0),i.insert[o+p].partial=null===c,a+=lines[p].length,p<lines.length-1&&a++;null!==c&&(o+=c.length)}else if(-1==r[h][0]){lines=r[h][1].split("\n");for(p=0;p<lines.length&&(p!=lines.length-1||0!=lines[p].length);p++)void 0===i.remove[s+p]&&(i.remove[s+p]={nline:o,chars:[]}),i.remove[s+p].chars.push({start:d,length:lines[p].length}),i.remove[s+p].partial=null===c,p>0&&(i.remove[s+p].consecutive=!0),d+=lines[p].length,p<lines.length-1&&d++;null!==c&&(s+=c.length)}}else null!==c&&(s+=c.length,o+=c.length),d+=r[h][1].length,a+=r[h][1].length}var l=e.split("\n"),u=t.split("\n"),E=[0];for(h=0;h<l.length-1;h++)E.push(l[h].length+E[h]+1);var f=[0];for(h=0;h<u.length-1;h++)f.push(u[h].length+f[h]+1);for(var m in i.insert)if(i.insert[m].chars.length>0){for(h=0;h<i.insert[m].chars.length;h++)i.insert[m].chars[h].start-=f[m];i.insert[m].iline=u[m]}for(var m in i.remove)if(i.remove[m].chars.length>0){for(h=0;h<i.remove[m].chars.length;h++)i.remove[m].chars[h].start-=E[m];i.remove[m].rline=l[m]}return console.log(i),i};var Language={language:"en",loadSymbols:function(e){for(var t in this.symbols)t!=this.symbols[t]&&void 0===e.symbols[this.symbols[t]]&&(e.symbols[this.symbols[t]]=e.lookup(t))},addKeywords:function(e){for(var t in e)this.keywords[t]=e[t]},addSymbols:function(e){for(var t in e)this.symbols[t]=e[t]},importoptions:{readonly:"readonly",remote:"remote",local:"local",rebase:"rebase",noexec:"noexec",reload:"reload",force:"force",async:"async",create:"create",remove:"remove"},selectors:{"has-name":!0,name:!0,type:!0,definition:!0,assignment:!0,script:!0,when:!0,for:!0,if:!0,last:!0,nth:!0,executed:!0,not:!0,unexecuted:!0,remote:!0,value:!0,active:!0,depends:!0},doxytags:{title:"title",author:"author",version:"version",param:"param",return:"return",debug:"debug",local:"local",role:"role",shared:"shared",oracle:"oracle",handle:"handle",deprecated:"deprecated",see:"see","{":"{","}":"}",hidden:"hidden",script:"script"},keywords:{func:"func",function:"function",oracle:"oracle",handle:"handle",proc:"proc",auto:"auto",para:"para",action:"action",procedure:"procedure",local:"local",role:"role",if:"if",is:"is",in:"in",else:"else",for:"for",while:"while",do:"do",switch:"switch",case:"case",default:"default",break:"break",continue:"continue",return:"return",when:"when",wait:"wait",import:"import",insert:"insert",append:"append",delete:"delete",require:"require",after:"after",shift:"shift",with:"with",and:"and",or:"or",not:"not",eval:"eval",sync:"sync"},symbols:{int:"int",str:"str",round:"round",min:"min",max:"max",random:"random",floor:"floor",ceil:"ceil",abs:"abs",acos:"acos",asin:"asin",atan:"atan",cos:"cos",exp:"exp",ln:"ln",log:"log",mod:"mod",randomInteger:"randomInteger",randomFloat:"randomFloat",sin:"sin",sqrt:"sqrt",sum:"sum",tan:"tan",length:"length",error:"error",substr:"substr",type:"type",createView:"createView",createCanvas:"createCanvas",zonesAt:"zonesAt",execute:"execute",indexOf:"indexOf",forget:"forget",eager:"eager",time:"time",writeln:"writeln",apply:"apply",todo:"todo",char:"char",isBoolean:"isBoolean",isCallable:"isCallable",isChar:"isChar",isDefined:"isDefined",isValue:"isValue",isFunc:"isFunc",isInt:"isInt",isNaN:"isNaN",isNumber:"isNumber",isObject:"isObject",isPoint:"isPoint",isProc:"isProc",showView:"showView",array:"array",sublist:"sublist",reverse:"reverse",search:"search",sort:"sort",tail:"tail",concat:"concat",decodeHTML:"decodeHTML"},values:{true:"true",false:"false"},errors:{}};"undefined"!=typeof require&&"undefined"!=typeof exports&&(exports.Language=Language),Point=function(e,t){this.x=e,this.y=t},Point.prototype.toString=function(e){return"Point("+Eden.edenCodeForValue(this.x,void 0,e)+", "+Eden.edenCodeForValue(this.y,void 0,e)+")"},Point.prototype.getEdenCode=Point.prototype.toString;var rt={index:function(e){return"number"==typeof e?e-1:e},flattenPromise:function(e){return e instanceof Promise?e:Array.isArray(e)&&e.length>0&&e[0]instanceof Promise?Promise.all(e):Promise.resolve(e)},length:function(e){if(null!=e)return e instanceof BoundValue?e.value.length:e.length},equal:function(e,t){var n;if(e===t)return!0;if(e instanceof Array&&t instanceof Array){if(e.length!==t.length)return!1;for(n=0;n<e.length;++n)if(!rt.equal(e[n],t[n]))return!1;return!0}return!1},notequal:function(e,t){return!rt.equal(e,t)},add:function(e,t){return void 0===e||void 0===t?void 0:e instanceof Point?new Point(e.x+t.x,e.y+t.y):e+t},subtract:function(e,t){return void 0===e||void 0===t?void 0:e instanceof Point?new Point(e.x-t.x,e.y-t.y):e-t},multiply:function(e,t){if(void 0!==e&&void 0!==t)return e*t},divide:function(e,t){if(void 0!==e&&void 0!==t)return e/t},mod:function(e,t){if(void 0!==e&&void 0!==t)return e%t},pow:function(e,t){if(void 0!==e&&void 0!==t)return Math.pow(e,t)},concat:function(e,t){if(void 0!==e&&void 0!==t){if(Array.isArray(e)){if(Array.isArray(t))return e.concat(t);throw new Error(Eden.RuntimeError.LEFTCONCAT)}if(Array.isArray(t))throw new Error(Eden.RuntimeError.RIGHTCONCAT);return String(e)+t}},regExpMatch:function(e,t){return void 0===e||void 0===t?void 0:t instanceof RegExp?t.test(e):new RegExp(t).test(e)},regExpNotMatch:function(e,t){return void 0===e||void 0===t?void 0:t instanceof RegExp?!t.test(e):!new RegExp(t).test(e)}};function WindowHighlighter(e){this.edenUI=e,this.lastDialog=void 0,this.lastDialogMinimized=!1,this.lastDialogHidden=!1,this.previousZIndex=void 0}function ScopeCache(e,t,n,r){this.up_to_date=e,this.value=t,this.scope=n,this.scopes=null,this.override=r}function BoundValue(e,t){this.value=e,this.scope=t}function ScopeOverride(e,t,n,r,i){if(this.name=e,this.start=t,this.end=n,this.increment=r,this.current=i&&t?t[0]:t,this.isin=i,this.index=1,0==this.increment)throw new Error(Eden.RuntimeError.INFINITERANGE);if(this.isin&&void 0===this.end&&!(this.start instanceof Array))throw new Error(Eden.RuntimeError.NOLISTRANGE)}function Scope(e,t,n,r,i,s){if(this.parent=t,this.context=e,this.cache=void 0,this.overrides=n,this.cause=t&&t.cause?t.cause:i,this.causecount=0,this.range=r,this.isolate=!1,this.cachearray=null,this.cause&&this.cause.hasOwnProperty("scopecount")&&++this.cause.scopecount>1e5)throw console.error("Scope limit exceeded",this.cause.name),"Scope limit exceeded";s||this.rebuild()}function ScopeList(){this.raw=[],this.caches=[]}function EdenSymbol(e,t){this.context=e,this.name=t,this.cache=e?e.scope.add(t):new ScopeCache(!0,void 0,void 0,!1),this.definition=void 0,this.def_scope=void 0,this.extend=void 0,this.needsGlobalNotify=0,this.has_evaled=!1,this.isasync=!1,this.scopecount=0,this.dependencies={},this.subscribers={},this.subscribersArray=null,this.dynamicDependencies={},this.dynamicDependencyTable=[],this.dynamicDependencyRefCount={},this.observers={},this.observees={},this.jsObservers={},this.origin=void 0,this.garbage=!1}function fireActions(e){for(var t in e){var n=e[t];n&&n.trigger()}}function fireJSActions(e){for(var t=0;t<e.length;t++)e[t].fireJSObservers()}function Pointer(e){this.value=e}function copy(e){var t,n;if(e instanceof Array){for(n=e.slice(),t=0;t<e.length;++t)n[t]=copy(n[t]);return n}return e}function Folder(e,t,n){this.type="script",this.executed=1,this.start=0,this.end=0,this.prefix="",this.postfix="",this.id="ACTIVE",this.name=e||"ACTIVE",this.base={origin:void 0},this.errors=[],this.lock=1,this.numlines=0,this.root=n||this,this.scope=new Scope(this,void 0,{}),this.symbols={},this.evalResults={},this.globalobservers=[],this.autocalc_state=!0,this.needsExpire=[],this.needsTrigger={},this.firetimer=void 0,this.needsGlobalNotify=[],this.globalNotifyIndex=0,this.expiryCount=new Pointer(0),this.potentialGarbage={},this.saved_autocalc_state=!0,this.saved_autocalc_level=0,this.currentObservables=[],Object.defineProperty(this,"statements",{enumerable:!0,get:function(){var e=this;return Object.keys(this.symbols).map(function(t){return e.symbols[t]})}}),Object.defineProperty(this,"parent",{enumerable:!0,get:function(){return eden.project.ast.script}})}if(this.rt=rt,"undefined"!=typeof require&&"undefined"!=typeof exports&&(exports.rt=rt),WindowHighlighter.prototype.highlight=function(e){this.lastDialog=edenUI.getDialogWindow(e);var t=edenUI.getDialogContent(e);if(t.dialog("isOpen")){var n=t.data("dialog-extend-minimize-controls");n?(this.previousZIndex=n.css("z-index"),t.dialogExtend("restore"),this.lastDialog.removeClass("window-activated"),this.lastDialogMinimized=!0):(this.previousZIndex=this.lastDialog.css("z-index"),this.lastDialog.css("z-index",2147483646),this.lastDialogMinimized=!1),this.lastDialogHidden=!1}else this.previousZIndex=void 0,edenUI.showView(e),edenUI.moveView(e),this.lastDialogHidden=!0;this.lastDialogLeft=this.lastDialog[0].offsetLeft,this.lastDialogWidth=this.lastDialog[0].offsetWidth,this.lastDialogTop=this.lastDialog[0].offsetTop,this.lastDialogHeight=this.lastDialog[0].offsetHeight;var r=window.pageXOffset,i=window.pageYOffset;(this.lastDialogLeft>=r+window.innerWidth||this.lastDialogLeft+this.lastDialogWidth<r||this.lastDialogTop>=i+window.innerHeight||this.lastDialogTop+this.lastDialogHeight<i)&&t.parent().offset({left:r+(window.innerWidth-this.lastDialogWidth)/2,top:i+(window.innerHeight-this.lastDialogHeight)/2}),this.lastDialog.addClass("menubar-window-raise"),this.lastDialog.css("z-index",2147483646)},WindowHighlighter.prototype.stopHighlight=function(e,t){if(this.lastDialog){this.lastDialog.removeClass("menubar-window-raise");var n=edenUI.getDialogContent(e);if(n.parent().offset({left:this.lastDialogLeft,top:this.lastDialogTop+edenUI.menuBarHeight}),t){var r=window.pageXOffset,i=window.pageYOffset,s=!1;this.lastDialogLeft+this.lastDialogWidth>r+window.innerWidth?(r=this.lastDialogLeft+this.lastDialogWidth-window.innerWidth,s=!0):this.lastDialogLeft<r&&(r=this.lastDialogLeft,s=!0),this.lastDialogTop+this.lastDialogHeight>i+window.innerHeight-edenUI.menuBarHeight?(i=this.lastDialogTop+this.lastDialogHeight-window.innerHeight-edenUI.menuBarHeight+edenUI.scrollBarSize2+edenUI.bottomBarHeight,s=!0):this.lastDialogTop<i&&(i=this.lastDialogTop-edenUI.menuBarHeight,s=!0),s&&window.scrollTo(r,i)}else this.lastDialogHidden?edenUI.hideView(e):this.lastDialogMinimized&&n.dialogExtend("minimize");void 0!==this.previousZIndex&&this.lastDialog.css("z-index",this.previousZIndex),this.lastDialog=void 0,this.lastDialogMinimized=!1,this.lastDialogHidden=!1,this.previousZIndex=void 0}},WindowHighlighter.prototype.unpin=function(e){e===this.lastDialog&&(this.previousZIndex=void 0)},Scope.prototype.hasCause=function(e){for(var t=this,n=e;t;){if(t.cause.name==n)return!0;t=t.parent}return!1},Scope.prototype.baseCause=function(){for(var e=this;e.parent&&e.parent.parent;)e=e.parent;return e.cause.name},Scope.prototype.allCauses=function(){for(var e=[],t=this;t;)t.cause&&e.push(t.cause),t=t.parent;return e},Scope.prototype.allOverrides=function(){},Scope.prototype.hasOverride=function(e){for(var t=this;t;){for(var n=0;n<t.overrides.length;n++)if(t.overrides[n].name==e)return!0;t=t.parent}return!1},Scope.prototype.primaryCause=function(){return this.cause&&"null"==this.cause.name&&this.parent&&this.parent.cause?this.parent.cause.name:"null"},Scope.prototype.isRange=function(){return this.range},Scope.prototype.clear=function(){this!==eden.root&&(this.cache=void 0)},Scope.prototype.resetCache=function(){if(this.cachearray)for(var e of this.cachearray)e.up_to_date=e.override;else for(var t in this.cachearray=[],this.cache){(e=this.cache[t]).up_to_date=e.override,this.cachearray.push(e)}},Scope.prototype.rebuild=function(){if(void 0===this.cache){this.cache={},this.add("cause"),this.add("has"),this.add("from");for(var e=0;e<this.overrides.length;e++)this.updateOverride(this.overrides[e]);if(this.context)for(e=0;e<this.overrides.length;e++){var t=this.context.lookup(this.overrides[e].name);this.addSubscribers(t)}}},Scope.prototype.refresh=function(){for(var e=0;e<this.overrides.length;e++)this.updateOverride(this.overrides[e])},Scope.prototype.rebuildForce=function(){for(var e=0;e<this.overrides.length;e++)this.updateSubscriberForce(this.overrides[e],!0)},Scope.prototype.rebuildForceAll=function(){this.rebuildForce(),this.parent&&this.parent!==eden.root.scope&&this.parent.rebuildForceAll()},Scope.prototype.cloneAt=function(e){for(var t=[],n=0;n<this.overrides.length;n++)t.push(new ScopeOverride(this.overrides[n].name,this.overrides[n].start,this.overrides[n].end));var r=new Scope(this.context,this.parent,t,this.range,this.cause);for(n=0;n<e;n++)r.next();return r.range=!1,r},Scope.prototype.clone=function(){return this},Scope.prototype.lookup=function(e){var t=this.cache[e];return t||(this.parent?this.parent.lookup(e):(this.cache[e]=new ScopeCache(!0,void 0,void 0,!1),this.cache[e]))},Scope.prototype.value=function(e){var t=this.cache[e];return void 0!==t?t.up_to_date?t.value:this.context.lookup(e).value(this):this.parent?this.parent.value(e):void 0},Scope.prototype.assign=function(e,t,n){this.isolate?void 0===this.cache[e]?this.cache[e]=new ScopeCache(!0,t,this,!0):(this.cache[e].up_to_date=!0,this.cache[e].override=!0,this.cache[e].value=t,this.cache[e].scope=this):this.context.lookup(e).assign(t,this,n)},Scope.prototype.mutate=function(e,t,n){this.context.lookup(e).mutate(this,t,n)},Scope.prototype.listAssign=function(e,t,n,r,i){this.context.lookup(e).listAssign(t,this,n,!1,i)},Scope.prototype.define=function(e,t,n,r){this.context.lookup(e).define(t,n,r)},Scope.prototype.boundValue=function(e){return this.context.lookup(e).boundValue(this)},Scope.prototype.scope=function(e){var t=this.cache[e];return t&&t.up_to_date?t.scope:this.context.lookup(e).boundValue(this).scope},Scope.prototype.lookup2=function(e){if(0==this.isolate)return this.lookup(e);var t=this.cache[e];return void 0===t&&(t=new ScopeCache(!0,void 0,void 0,!1),this.cache[e]=t),t},Scope.prototype.add=function(e){var t=new ScopeCache(!1,void 0,this,!1);return this.cache[e]=t,t},Scope.prototype.addOverride=function(e){if(!this.updateOverride(e)&&this.context){var t=this.context.lookup(e.name);for(var n in t.subscribers)this.updateSubscriber(n)}},Scope.prototype.updateOverride=function(e){var t,n,r=e.name;return e.current instanceof BoundValue?(t=e.current.value,n=e.current.scope):(t=e.current,n=this),void 0===this.cache[r]?(this.cache[r]=new ScopeCache(!0,t,n,!0),!1):(this.cache[r].value=t,this.cache[r].scope=n,this.cache[r].up_to_date=!0,this.cache[r].override=!0,!0)},Scope.prototype.addSubscribers=function(e){var t=[];e.subscribersArray||(e.subscribersArray=Object.keys(e.subscribers)),t.push.apply(t,e.subscribersArray);for(var n=0;n<t.length;){if(!this.cache.hasOwnProperty(t[n])){var r=t[n];this.cache[r]=new ScopeCache(!1,void 0,this,!1);var i=this.context.lookup(r);i.subscribersArray||(i.subscribersArray=Object.keys(i.subscribers)),t.push.apply(t,i.subscribersArray)}++n}},Scope.prototype.addSubscriber=function(e){if(!this.cache.hasOwnProperty(e)){var t=new ScopeCache(!1,void 0,this,!1);this.cache[e]=t,this.cachearray&&this.cachearray.push(t);var n=this.context.lookup(e);for(var r of(n.subscribersArray||(n.subscribersArray=Object.keys(n.subscribers)),n.subscribersArray))this.addSubscriber(r)}},Scope.prototype.updateSubscriber=function(e){if(void 0===this.cache[e]){this.cache[e]=new ScopeCache(!1,void 0,this,!1);var t=this.context.lookup(e);for(var n in t.subscribers)this.updateSubscriber(n)}else this.cache[e].up_to_date=!1,this.cache[e].value=void 0,this.cache[e].scope=this},Scope.prototype.updateSubscriberForce=function(e,t){void 0===this.cache[e]?this.cache[e]=new ScopeCache(!1,void 0,this,t):(this.cache[e].up_to_date=!1,this.cache[e].value=void 0,this.cache[e].scope=this);var n=this.context.lookup(e);for(var r in n.subscribers)this.updateSubscriberForce(r,!1)},Scope.prototype.first=function(){for(var e=this.overrides.length-1;e>=0;e--){var t=this.overrides[e];if(void 0!==t.end){if(t.isin){var n=isbound?t.start.value.length:t.start?t.start.length:0;return t.index<n}if(t.current<=t.end)return!0}}return!1},Scope.prototype.mergeCache=function(e){this.range;e||console.error("Missing scope cache"),this.cache=e.cache,this.cachearray=e.cachearray},Scope.prototype.reset=function(){this.resetCache(),this.refresh()},Scope.prototype.next=function(){this.resetCache();for(var e=this.overrides.length-1;e>=0;e--){var t=this.overrides[e];if(void 0!==t.end||t.isin){var n=t.start instanceof BoundValue,r=n?t.start.value.length:t.start?t.start.length:0;if(t.isin){if(t.index<r)return t.current=n?t.start.value[t.index]:t.start[t.index],t.index++,this.refresh(),!0;t.index=1,t.current=n?t.start.value[0]:t.start[0]}else{if(t.current<t.end)return t.increment?t.current+=t.increment:t.current++,this.refresh(),!0;t.current=t.start}}}return!1},Object.defineProperty(EdenSymbol.prototype,"type",{get:function(){return this.origin&&this.origin.type?this.origin.type:"assignment"}}),Object.defineProperty(EdenSymbol.prototype,"lvalue",{get:function(){return this.origin?this.origin.lvalue:void 0}}),Object.defineProperty(EdenSymbol.prototype,"expression",{get:function(){return this.origin?this.origin.expression:void 0}}),Object.defineProperty(EdenSymbol.prototype,"doxyComment",{get:function(){return this.origin?this.origin.doxyComment:void 0}}),Object.defineProperty(EdenSymbol.prototype,"parent",{get:function(){return eden.root}}),Object.defineProperty(EdenSymbol.prototype,"stamp",{get:function(){return this.origin?this.origin.stamp:void 0}}),Object.defineProperty(EdenSymbol.prototype,"id",{get:function(){return this.origin&&this.origin.id?this.origin.id:this.name}}),Object.defineProperty(EdenSymbol.prototype,"executed",{get:function(){return 1}}),EdenSymbol.prototype.getStartLine=function(e){return this.origin?this.origin.getStartLine(e):-1},EdenSymbol.prototype.getASTOrigin=function(){if(this.origin){for(var e=this.origin;e.parent;)e=e.parent;if(e.base)return e.base.origin}},EdenSymbol.prototype.getOrigin=function(){if(this.origin)return this.origin.getOrigin()},InternalAgent=function(e,t){this.name=e,this.local=t,this.internal=!0},InternalAgent.prototype.getOrigin=function(){return"*Default"!=this.name?eden.project:void 0},InternalAgent.prototype.numlines=0,EdenSymbol.hciAgent=new InternalAgent("*Input Device",!0),EdenSymbol.jsAgent=new InternalAgent("*JavaScript",!1),EdenSymbol.localJSAgent=new InternalAgent("*JavaScript",!0),EdenSymbol.netAgent=new InternalAgent("*net",!0),EdenSymbol.defaultAgent=new InternalAgent("*Default",!0),EdenSymbol.NONOTIFY=0,EdenSymbol.CREATED=1,EdenSymbol.EXPIRED=2,EdenSymbol.REDEFINED=3,EdenSymbol.ASSIGNED=4,EdenSymbol.ASYN_UPDATE=5,EdenSymbol.prototype.boundValue=function(e,t){var n=this.value(e),r=e.lookup(this.name);return t?new BoundValue(n[t[0]],r.scopes[t[0]]):new BoundValue(n,r.scope)},EdenSymbol.prototype.value=function(e){if(e&&e.isRange())return this.multiValue(e);var t=e;this.garbage=!1,void 0===t&&(t=this.context.scope);var n=void 0===this.context||t===this.context.scope?this.cache:t.lookup(this.name);return this.definition&&(n.up_to_date||this.evaluate(t,n)),n.value},EdenSymbol.prototype.multiValue=function(e){var t=[];if(e.range=!1,!e.first())return[];for(;;){var n=this.value(e);if(void 0!==n&&t.push(n),0==e.next())break}return e.range=!0,(void 0===this.context||e===this.context.scope?this.cache:e.lookup(this.name)).scope=e,t},EdenSymbol.prototype.evaluateIfDependenciesExist=function(){this.evaluate(this.context.scope,this.context.scope.lookup(this.name))},EdenSymbol.prototype.getValueScope=function(e){return e.lookup(this.name).scope},EdenSymbol.prototype.evaluate=function(e,t){this.context&&this.context.beginEvaluation(this),this.subscribersArray||(this.subscribersArray=Object.keys(this.subscribers));try{if(t.up_to_date=!0,this.has_evaled=!0,this.scopecount=0,this.clearDynamicDependencies(),t.value=this.definition.call(this,this.context,e,t),this.scopecount>100&&console.log("Scope count for "+this.name,this.scopecount),this.extend)for(var n in this.extend)this.extend[n].code(this.context,e,t.value)}catch(n){n instanceof Eden.RuntimeError&&eden.emit("error",[this,n]),t.value=void 0,t.up_to_date=!0}this.context&&this.context.endEvaluation(this)},EdenSymbol.prototype.clearEvalIDs=function(){var e=this.context;for(var t in this.evalIDs)e.clearEval(this.evalIDs[t]);this.evalIDs={},this.evalResolved=!1},EdenSymbol.prototype.clearObservees=function(){for(var e in this.observees){this.observees[e].removeObserver(this.name)}this.observees={}},EdenSymbol.prototype.subscribe=function(){for(var e=Utils.flatten(arguments),t=0;t<e.length;++t){var n=e[t],r=this.context.lookup(n);if(r.name!=this.name){r.addSubscriber(this.name,this);var i=r.name;this.dependencies[i]=r,delete this.dynamicDependencies[i]}}return this},EdenSymbol.prototype.subscribeDynValue=function(e,t,n){let r=t.name;return this.subscribeDynamic(e,r,n),t.value(n)},EdenSymbol.prototype.subscribeDynamic=function(e,t,n){var r=this.context.lookup(t);return n&&n!==eden.root.scope&&n.cause&&r.definition&&!n.cache.hasOwnProperty(t)&&n.addSubscriber(t),this.dependencies.hasOwnProperty(t)||this.dynamicDependencies.hasOwnProperty(t)||(r.addSubscriber(this.name,this),this.dynamicDependencies[r.name]=r),t},EdenSymbol.prototype.clearDependencies=function(){for(var e in this.dependencies)this.dependencies[e].removeSubscriber(this.name);for(var e in this.dependencies={},this.dynamicDependencies)this.dynamicDependencies[e].removeSubscriber(this.name);this.dynamicDependencies={},this.dynamicDependencyTable=[],this.dynamicDependencyRefCount={}},EdenSymbol.prototype.clearDynamicDependencies=function(){var e;for(var t in this.dynamicDependencies)e=this.dynamicDependencies[t],this.dependencies.hasOwnProperty(t)||e.removeSubscriber(this.name);this.dynamicDependencies={}},EdenSymbol.prototype.getSource=function(){return this.origin&&!this.origin.internal?this.origin.getSource():this.name+" = "+Eden.edenCodeForValue(this.value())+";"},EdenSymbol.prototype.getDynamicSource=function(){return this.origin&&!this.origin.internal?this.origin.sources?this.origin.sources[this.name]:this.origin.getSource():this.name+" = "+Eden.edenCodeForValue(this.value())+";"},EdenSymbol.prototype.toString=function(){return"&"+this.name},EdenSymbol.prototype.indirectDependencies=function(e){var t=e||{};for(var n in this.dependencies){var r=this.dependencies[n];t[n]=r,r.indirectDependencies(t)}for(var n in this.dynamicDependencies){r=this.dynamicDependencies[n];t[n]=r,r.indirectDependencies(t)}return t},EdenSymbol.prototype.indirectSubscribers=function(e){var t=e||{};for(var n in this.subscribers){var r=this.subscribers[n];t[n]=r,r.indirectSubscribers(t)}return t},EdenSymbol.prototype.define=function(e,t,n,r){if(this.garbage=!1,this.definition=e,this.origin=t,this.needsGlobalNotify=EdenSymbol.REDEFINED,this.clearObservees(),this.clearDependencies(),this.subscribe(n),this.extend)for(var i in this.extend)this.subscribe(this.extend[i].deps);return this.context&&this.context.expireEdenSymbol(this),eden.peer&&eden.peer.define(t,this.name,t.getSource(),n),this},EdenSymbol.prototype.expireSubscribers=function(){for(var e in this.subscribers)this.subscribers[e].needsGlobalNotify=EdenSymbol.EXPIRED,this.context.expireEdenSymbol(this.subscribers[e])},EdenSymbol.prototype.expireAsync=function(){this.context&&(this.needsGlobalNotify=EdenSymbol.ASYNC_UPDATE,this.context.expireEdenSymbol(this))},EdenSymbol.prototype.observe=function(e){e=Utils.flatten(arguments);for(var t=0;t<e.length;++t){var n=this.context.lookup(e[t]);this.observees[n.name]=n,n.addObserver(this.name,this)}return this.context&&this.context.triggerEdenSymbol(this),this},EdenSymbol.prototype.stopObserving=function(e){this.observees[e].removeObserver(this.name),this.observees[e]=void 0},EdenSymbol.prototype.append=function(e,t,n){var r=this.value(t);r.push(e),this.assign(r,t,n)},EdenSymbol.prototype.assign=function(e,t,n){this.garbage=!1,this.cache.value!==e&&(e=copy(e)),"autocalc"===this.name&&(!0===e?e=1:!1===e&&(e=0),this.context&&this.context.autocalc(1===e)),this.clearEvalIDs(),this.origin=n,this.definition=void 0,this.needsGlobalNotify=EdenSymbol.ASSIGNED,this.has_evaled=!0,this.extend=void 0;var r=void 0===this.context||t==this.context.scope?this.cache:t.lookup2(this.name);return r.value=e,r.up_to_date=!0,this.clearObservees(),this.clearDependencies(),this.context&&this.context.expireEdenSymbol(this),eden.peer&&eden.peer.assign(n,this.name,e),this},EdenSymbol.prototype.assigned=function(e){return this.garbage=!1,this.clearEvalIDs(),this.evalResolved=!0,this.origin=e,this.definition=void 0,this.clearObservees(),this.clearDependencies(),this},EdenSymbol.prototype.mutate=function(e,t,n,r){this.garbage=!1;this.origin=n,this.value(e),this.definition=void 0,this.needsGlobalNotify=EdenSymbol.ASSIGNED;for(var i=[],s=1;s<arguments.length;s++)i.push(arguments[s]);return t.apply(void 0,[this].concat(i)),this.context&&this.context.expireEdenSymbol(this),this},EdenSymbol.prototype.loggers={console:function(e){console.log("<JSEDEN:"+this.name+"> "+e)}},EdenSymbol.prototype.logError=function(e){for(var t in this.loggers){this.loggers[t].call(this,e)}},EdenSymbol.prototype.getEdenCode=function(){return"&"+this.name},EdenSymbol.prototype.trigger=function(){try{this.value().call(this,this.context,this.context.scope)}catch(t){var e=new Eden.RuntimeError(void 0,Eden.RuntimeError.PROCAGENT,void 0,"Triggered proc failed: "+t);eden.emit("error",[this,e])}},EdenSymbol.prototype.fireJSObservers=function(){for(var e in this.jsObservers)try{this.jsObservers[e](this,this.value())}catch(r){var t=new Eden.RuntimeError(void 0,Eden.RuntimeError.JSOBSERVER,void 0,"JavaScript observer '"+e+"' failed: "+r);if(eden.emit("error",[this,t]),this.context){var n=this.cache.value;"object"==typeof n&&n.jsExceptions}else!1;throw r}},EdenSymbol.prototype.expire=function(e,t,n,r){if(this.has_evaled||r&&this.needsGlobalNotify!=EdenSymbol.EXPIRED)if(this.isasync&&this.definition&&this.needsGlobalNotify!=EdenSymbol.ASYNC_UPDATE){this.context&&this.context.beginEvaluation(this),this.has_evaled=!1;try{this.clearDynamicDependencies(),this.definition.call(this,this.context,this.context.scope,this.cache).then(e=>{this.has_evaled=!0,this.cache.up_to_date=!0,this.cache.value=e,this.expireAsync()})}catch(e){e instanceof Eden.RuntimeError&&eden.emit("error",[this,e]),console.error(this.name,e),this.cache.value=void 0,this.cache.up_to_date=!0}this.context&&this.context.endEvaluation(this)}else{for(var i in this.observers)n[i]=this.observers[i];for(var s in this.definition&&this.needsGlobalNotify!=EdenSymbol.ASYNC_UPDATE&&(this.cache.up_to_date=!1,this.has_evaled=!1,e[this.name]=t.value,t.value++,r&&(this.cache.scopes=null)),this.needsGlobalNotify=EdenSymbol.EXPIRED,this.subscribers){var o=this.subscribers[s];o&&o.expire(e,t,n,r)}}},EdenSymbol.prototype.isDependentOn=function(e){if(e==this.name||this.dependencies[e])return!0;for(var t in this.dependencies)if(this.dependencies[t].isDependentOn(e))return!0;for(var t in this.dynamicDependencies)if(this.dynamicDependencies[t].isDependentOn(e))return!0;return!1},EdenSymbol.prototype.getDependencies=function(){var e=[];for(var t in this.dependencies)e.push(t);return console.log("Dependencies"),e},EdenSymbol.prototype.assertNotDependentOn=function(e,t){if(void 0===t&&(t=[]),t.push(this.name),this.dependencies[e]){var n=t.join(" -> ")+" -> "+e+" -> "+t[0];throw new Error("Cyclic dependency detected: "+n)}for(var r in this.dependencies)this.dependencies[r].assertNotDependentOn(e,t);for(var r in this.dynamicDependencies)this.dynamicDependencies[r].assertNotDependentOn(e,t);t.pop()},EdenSymbol.prototype.addSubscriber=function(e,t){this.garbage=!1,this.subscribers[e]=t,this.subscribersArray&&this.subscribersArray.push(e)},EdenSymbol.prototype.removeSubscriber=function(e){delete this.subscribers[e],this.subscribersArray=null,void 0===this.origin&&this.canSafelyBeForgotten()&&this.forget()},EdenSymbol.prototype.canSafelyBeForgotten=function(){for(var e in this.subscribers)return!1;for(var t in this.observers)return!1;return!0},EdenSymbol.prototype.forget=function(){for(var e in this.origin=void 0,this.clearEvalIDs(),this.evalResolved=!0,this.definition=void 0,this.cache.value=void 0,this.cache.up_to_date=!0,this.context&&this.context.expireEdenSymbol(this),this.clearObservees(),this.clearDependencies(),this.garbage=!0,this.jsObservers)this.jsObservers[e].call(this,this,void 0);this.jsObservers={},this.context.queueForGarbageCollection(this)},EdenSymbol.prototype.addObserver=function(e,t){this.garbage=!1,this.observers[e]=t},EdenSymbol.prototype.addJSObserver=function(e,t){if("function"!=typeof t)throw new Error("Failed adding JavaScript observer "+t);this.jsObservers[e]=t,0==this.cache.up_to_date&&this.value()},EdenSymbol.prototype.removeObserver=function(e){delete this.observers[e],void 0===this.origin&&this.canSafelyBeForgotten()&&this.forget()},EdenSymbol.prototype.removeJSObserver=function(e){delete this.jsObservers[e]},EdenSymbol.prototype.addExtension=function(e,t,n,r,i){if(!this.definition)throw new Error(Eden.RuntimeError.EXTENDSTATIC);void 0===this.extend&&(this.extend={}),this.extend[e]={code:t,source:n,deps:i},this.subscribe(i),this.needsGlobalNotify=EdenSymbol.REDEFINED,this.context&&this.context.expireEdenSymbol(this)},EdenSymbol.prototype.listAssign=function(e,t,n,r,i){if(this.definition){if(this.origin&&"definition"==this.origin.type){var s=this.origin.locatePrimary(i);if(s)return void eden.root.lookup(s).assign(e,t,n)}throw new Error(Eden.RuntimeError.ASSIGNTODEFINED)}for(var o=this.value(t),a=0;a<i.length-1;a++)o&&(o=o[i[a]]);if(!o)throw new Error(Eden.RuntimeError.ASSIGNDIMENSION);return o[i[i.length-1]]=e,this.origin=n,this.needsGlobalNotify=EdenSymbol.ASSIGNED,this.context&&this.context.expireEdenSymbol(this),eden.peer&&eden.peer.listAssign(n,this.name,e,i),this},edenCopy=copy,Folder.prototype.getNumberOfLines=function(){return this.numlines+1},Folder.prototype.hasErrors=function(){return!1},Folder.prototype.getOrigin=function(){return eden.project},Folder.prototype.getStatementByLine=function(e){},Folder.prototype.getStartLine=function(e){return this.parent?this.parent.getRelativeLine(this,e):-1},Folder.prototype.getRange=function(e){var t=this.getStartLine(e);return[t,t+this.getNumberOfLines()]},Folder.prototype.getInnerSource=function(){var e="";for(var t in this.numlines=0,this.symbols){var n=this.symbols[t];if(n.origin&&n.origin.getOrigin){var r=n.origin.getOrigin();if(!r||r&&!r.remote){var i=n.getSource();i&&(e+=i+"\n",this.numlines+=n.origin.numlines+1)}}}return e},Folder.prototype.destroy=function(){},Folder.prototype.getSource=function(){var e="action ACTIVE {\n";return e+=this.getInnerSource(),e+="}"},Folder.prototype.execute=function(){},Folder.prototype.lookup=function(e){return void 0===this.symbols[e]&&(this.symbols[e]=new EdenSymbol(this,e),this.notifyGlobals(this.symbols[e],1)),this.symbols[e]},Folder.prototype.currentObservableName=function(){return 0==this.currentObservables.length?void 0:this.currentObservables[this.currentObservables.length-1].name},Folder.prototype.beginEvaluation=function(e){this.currentObservables.push(e)},Folder.prototype.endEvaluation=function(e){this.currentObservables.pop()},Folder.prototype.queueForGarbageCollection=function(e){this.potentialGarbage[e.name]=e},Folder.prototype.collectGarbage=function(){for(var e in this.potentialGarbage)this.potentialGarbage[e].garbage&&delete this.symbols[e];this.potentialGarbage={}},Folder.prototype.putEval=function(e,t){this.evalResults[e]=t},Folder.prototype.getEval=function(e){return this.evalResults[e]},Folder.prototype.clearEval=function(e){delete this.evalResults[e]},Folder.prototype.addGlobal=function(e){this.globalobservers.push(e)},Folder.prototype.removeGlobal=function(e){for(var t=0;t<this.globalobservers.length;t++)if(this.globalobservers[t]===e)return this.globalobservers.splice(t,1),!0;return!1},Folder.prototype.notifyGlobals=function(e,t){for(var n=0;n<this.globalobservers.length;n++)void 0!==this.globalobservers[n]&&this.globalobservers[n].call(this,e,t)},Folder.prototype.autocalc=function(e){this.autocalc_state=e,this.expireAndFireActions()},Folder.prototype.beginAutocalcOff=function(){this.saved_autocalc_level++,1==this.saved_autocalc_level&&(this.saved_autocalc_state=this.autocalc_state,this.autocalc_state&&this.autocalc(!1))},Folder.prototype.endAutocalcOff=function(){this.saved_autocalc_level--,0==this.saved_autocalc_level&&this.saved_autocalc_state&&this.autocalc(!0)},Folder.prototype.expireEdenSymbol=function(e){-1==this.needsExpire.indexOf(e)&&this.needsExpire.push(e),this.expireAndFireActions()},Folder.prototype.triggerEdenSymbol=function(e){if(this.needsTrigger[e.name]=e,void 0===this.firetimer){var t=this;this.firetimer=setTimeout(function(){this.firetimer=void 0,t.expireAndFireActions()},0)}},Folder.prototype.expireAndFireActions=function(){if(this.autocalc_state){this.expiryCount.value=0;for(var e={},t=0;t<this.needsExpire.length;t++){(s=this.needsExpire[t]).expire(e,this.expiryCount,this.needsTrigger,s.needsGlobalNotify==EdenSymbol.REDEFINED)}var n=this.needsExpire;this.needsExpire=[];var r=Object.keys(e);r.sort(function(t,n){return e[t]-e[n]});var i=[];for(t=0;t<r.length;t++){var s;(s=this.symbols[r[t]]).needsGlobalNotify=EdenSymbol.EXPIRED,i.push(s)}var o=this.needsTrigger;if(this.needsTrigger={},fireActions(o),fireJSActions(n),fireJSActions(i),0==this.needsGlobalNotify.length){if(i.push.apply(i,n),i.length>0){this.needsGlobalNotify=i;var a=this;setTimeout(function(){a.processGlobalNotifyQueue()},0)}}else{var d=this.needsGlobalNotify;d.push.apply(d,i),d.push.apply(d,n)}}},Folder.prototype.processGlobalNotifyQueue=function(){for(var e=this.needsGlobalNotify,t=0;t<e.length;){this.globalNotifyIndex++;var n=e[t];if(n.needsGlobalNotify){var r=n.needsGlobalNotify;n.needsGlobalNotify=0,this.notifyGlobals(n,r)}t=this.globalNotifyIndex}this.needsGlobalNotify=[],this.globalNotifyIndex=0},Folder.prototype.forgetAll=function(){var e,t,n,r,i,s,o=void 0;if(arguments.length>4)return eden.error(new Error("forgetAll: This function requires at most 4 arguments."),"error"),[[],void 0,[]];if(0==arguments.length)e="";else if("string"==typeof arguments[0])e=arguments[0];else{if(!Array.isArray(arguments[0]))return void 0===arguments[0]?[[],void 0,[]]:(eden.error(new Error("forgetAll: The first argument must be a string, not a "+typeof arguments[0]),"error"),[[],void 0,[]]);o=arguments[0]}if(arguments.length>1){if("boolean"!=typeof arguments[1])return eden.error(new Error("forgetAll: The second argument must be a boolean, not a "+typeof arguments[1]),"error"),[[],void 0,[]];t=arguments[1]}else t=!0;if(void 0!==o&&arguments.length>2)return eden.error(new Error("forgetAll: Cannot specify case sensitivity when selecting using a list."),"error"),[[],void 0,[]];if(arguments.length>=3){if("boolean"!=typeof arguments[2])return eden.error(new Error("forgetAll: The third argument must be a boolean, not a "+typeof arguments[2]),"error"),[[],void 0,[]];n=arguments[2]}else n=void 0===o||2!=arguments.length||arguments[1];if(arguments.length>3){if("boolean"!=typeof arguments[3])return eden.error(new Error("forgetAll: The forth argument must be a boolean, not a "+typeof arguments[3]),"error"),[[],void 0,[]];r=arguments[3]}else r=!1;var a,d={},h=[],c={};if(void 0!==o)for(var p=0;p<o.length;p++){if(o[p]instanceof s)m=o[p].name,s=o[p];else{if("string"!=typeof o[p]){if(void 0===o)continue;return eden.error(new Error("forgetAll: All list items must be strings or pointers.  Item "+p+" is a "+typeof o[p]),"error"),[[],void 0,[]]}m=o[p],s=root.lookup(m)}if(r||!Eden.isitSystemEdenSymbol(m))if(a=eden.initialDefinition(m))c[m]=a;else{var l=[];for(var u in s.subscribers)l.push(u);for(var E in s.observers)l.push(E);d[m]=l}else h.push(m)}else{i=t?new RegExp(e):new RegExp(e,"i");var f=/^_[vV]iew(s?)_/;for(var m in root.symbols)if(i.test(m)){if(!r&&(Eden.isitSystemEdenSymbol(m)||f.test(m)))continue;s=root.symbols[m];l=[];for(var u in s.subscribers)l.push(u);for(var E in s.observers)l.push(E);d[m]=l}}var g,S={},y=function(e){if(e in S)return S[e];if(e in c)return!0;if(!(e in d))return S[e]=!1,!1;var t=d[e];if(0==t.length)return S[e]=!0,!0;for(var n=0;n<t.length;n++){if(!y(t[n]))return S[e]=!1,!1}return S[e]=!0,!0},v=[];for(m in d){y(m)?v.push(m):h.push(m)}var x=Object.keys(c),b=v.concat(x);if(b.length>0&&n)if(b.length<=50)g=confirm("You are about to delete the following "+b.length+" symbols.  Is this correct?\n\n"+b.join("\n"));else{var A=b.length-50;g=confirm("You are about to delete "+b.length+" symbols.  Is this correct?\n\n"+b.slice(0,50).join("\n")+"\n...\n("+A+" more)")}else g=!0;if(g){for(m in root.beginAutocalcOff(),c);for(p=0;p<v.length;p++){m=v[p];if(void 0!==(s=root.symbols[m])){"refreshView"in s.jsObservers&&(s.assign(void 0,root.scope),edenUI.plugins.Canvas2D&&edenUI.plugins.Canvas2D.destroyViews&&edenUI.plugins.Canvas2D.destroyViews(m)),s.forget();var T=m.match(/^_view_(.*)_content$/);null!==T&&edenUI.destroyView(T[1],!0)}}return root.collectGarbage(),root.endAutocalcOff(),[v,h,x]}return[[],h,[]]},function(e){function t(e){this.eden=e,this.views={},this.viewInstances={},this.embeddedInstances={},this.activeDialogs={},this.plugins={};this.loaded=!1,this.branding={},this.$uimsg=$("<div class='message-box'></div>"),this.$uimsg.appendTo("body"),this.$uimsg.hide(),this.messagetimeout=void 0,this.messagedisplaytime=5e3,this.eden.listenTo("executeFileLoad",this,function(e){edenUI.updateStatus("Loading "+e)}),this.eden.listenTo("executeError",this,function(e,t){console.error("DEPRECATED ERROR REPORTING",e);var r,i=n.htmlEscape(e.message);t.errorNumber,t.path&&t.path;r="string"==typeof e?e:e.message,edenUI.showMessage("error","Error: "+r)}),this.listeners={},this.windowHighlighter=new WindowHighlighter(this),this.currentView=void 0,this.viewCategories={},this.numberOfViewCategories=0,this.addViewCategory("comprehension","Comprehension"),this.addViewCategory("interpretation","Making Definitions"),this.addViewCategory("history","History &amp; State"),this.addViewCategory("visualization","Visualization"),this.addViewCategory("extension","Extensions"),this.addViewCategory("environment","Management"),$(document).on("click",function(e){if(e.ctrlKey||e.metaKey)for(var t=[],n=e.target;"BODY"!=n.nodeName;){var r=n.getAttribute("data-observables");r&&""!=r&&t.push.apply(t,r.split(",")),n=n.parentNode}})}function n(e){this.root=e,e.base=this,this.dictionary={},this.errorNumber=0,this.listeners={},this.reportErrors=!0}"undefined"!=typeof require&&"undefined"!=typeof exports&&(Polyglot=require("./polyglot").Polyglot,rt=require("./runtime").rt),t.prototype.brieflyHighlightView=function(e){var t=$("#"+viewName+"-dialog").dialog.parent();t.addClass("window-activated"),setTimeout(function(){t.removeClass("window-activated")},600)},t.prototype.cycleNextView=function(){this.stopHighlightingView(this.currentView,!0,!1);var e=Object.keys(this.activeDialogs);if(void 0===this.currentView)this.currentView=e[0];else for(i=0;i<e.length;i++)if(this.currentView==e[i]){this.currentView=e[(i+1)%e.length];break}this.highlightView(this.currentView,!0)},t.prototype.stopViewCycling=function(){this.stopHighlightingView(this.currentView,!0,!0)},t.plugins={},t.prototype.loadPlugin=function(e,n,r){if(2===arguments.length&&(r=n,n={name:"/loadPlugin"}),void 0===t.plugins[e])return this.eden.error("Plugin '"+e+"' does not exist"),r&&r.call(n,!1),!1;eden.peer&&eden.peer.doRequire(e);var i=this,s=function(){i.emit("loadPlugin",[e]),r&&r.call(n)};void 0===this.plugins[e]?(this.plugins[e]=!0,this.plugins[e]=new t.plugins[e](this,s)):s()},t.prototype.addViewCategory=function(e,t){this.viewCategories[e]=new function(e,t){this.getLabel=function(){return e},this.getMenuPriority=function(){return t}}(t,this.numberOfViewCategories),this.numberOfViewCategories++},t.prototype.updateStatus=function(e){this.loaded?this.showMessage("info",e):(console.log(e),$(".loadmessage").html(e))},t.prototype.hideMessage=function(){edenUI.$uimsg.hide("slow")},t.prototype.showMessage=function(e,t){"info"==e?this.$uimsg.html("<div class='message-infotext'>"+t+"</div>"):"error"==e&&this.$uimsg.html("<div class='message-errortext'>"+t+"</div>"),this.$uimsg.show("fast"),clearTimeout(this.messagetimeout),this.messagetimeout=setTimeout(this.hideMessage,this.messagedisplaytime)},t.prototype.finishedLoading=function(){this.loaded=!0},t.prototype.listenTo=listenTo,t.prototype.emit=emit,t.showTooltip=function(e,t){var n=document.getElementById("tooltip"),r=e.clientX+2,i=e.clientY+20,s=window.pageXOffset+window.innerWidth-r-15;s<200&&(r-=200-s,s=200),n.style.left=r+"px",n.style.maxWidth=s+"px",n.style.top=i+"px",n.innerHTML=t,n.style.display="block"},t.closeTooltip=function(){document.getElementById("tooltip").style.display="none"},t.prototype.options={},t.prototype.getOptionValue=function(e){if(e in this.options)return this.options[e];try{if(window.localStorage)return window.localStorage.getItem(e)}catch(e){return null}},t.prototype.setOptionValue=function(e,t){this.options[e]=String(t),this.emit("optionChange",[e,String(t)]);try{if(window.localStorage)return window.localStorage.setItem(e,t),!0}catch(e){return!1}},t.prototype.setDefaultOptionValue=function(e,t){null===this.getOptionValue(e)&&(this.options[e]=String(t),this.emit("optionChange",[e,String(t)]))},t.prototype.unsetOptionValue=function(e){delete this.options[e],this.emit("optionChange",[e,null]);try{window.localStorage&&window.localStorage.removeItem(e)}catch(e){}},t.prototype.fullscreen=function(e,t){var n=eden.root.lookup(t),r=n.value();if(document.webkitExitFullscreen)r?(document.onwebkitfullscreenchange=function(){document.webkitIsFullScreen||(n.assign(!1,eden.root.scope,Symbol.hciAgent),edenUI.menu.show())},document.getElementById(e+"-canvascontent").webkitRequestFullscreen(),edenUI.menu.hide()):(document.webkitExitFullscreen(),edenUI.menu.show());else if(document.mozCancelFullScreen){if(r)document.onmozfullscreenchange=function(){document.mozFullScreen||(n.assign(!1,eden.root.scope,Symbol.hciAgent),edenUI.menu.show())},document.getElementById(e+"-canvascontent").mozRequestFullScreen(),edenUI.menu.hide();else document.mozCancelFullScreen(),edenUI.menu.show()}},t.prototype.regExpFromStr=function(e,t,n,r){var i,s,o,a,d=!0;if("object"==typeof e&&(e=(o=e)[0].value),void 0===t&&(t=""),void 0===r)a=!/[\\+^$|({[]|(\.\*[^\s*?])/.test(e)&&"false"!==this.getOptionValue("optSimpleWildcards");else if("simple"==r)a=!0;else{if("regexp"!=r)throw new Error("EdenUI.regExpFromStr: Unsupported search language "+r);a=!1}if(/[A-Z]/.test(e)||(t+="i"),a){for(var h=(e=e.replace(/([\\+^$.|(){[])/g,"\\$1").replace(/([*?])/g,".$1")).split(new RegExp("\\s+(?:"+Language.ui.search.disjunction+"|or)\\s+","i")),c=0;c<h.length;c++){var p=h[c];n||/[?*]/.test(p)?h[c]="^("+p+")$":p.length<3&&(h[c]="^("+p+")")}i=h.join("|"),s=new RegExp(i,t)}else try{i=e,n&&(i="^("+i+")$"),s=new RegExp(i,t)}catch(r){d=!1;var l=e.match(/^([^*+?\\(){[]([^\\()[]*(\\.)?)*)?/)[0];n&&(l="^("+l+")"),s=new RegExp(l,t)}return o&&(d?o.removeClass("invalid_form"):o.addClass("invalid_form")),s},n.prototype.updateDictionary=function(e,t,n){this.dictionary[e]=t},n.prototype.isValidIdentifier=function(e){return Boolean(e&&/^[_a-zA-Z]\w*$/.test(e))},n.load=function(e,r,i,s){console.log("Loading project: "+e+"@"+r),n.DB.load(e,r,void 0,function(n){if("object"==typeof n&&t.MenuBar.saveTitle(n.title),eden.root.lookup("_jseden_loaded").assign(!0,eden.root.scope),!s){var o=URLUtil.getParameterByName("master"),a=URLUtil.getParameterByName("id"),d="?load="+e+"&tag="+r;""!=a&&(d+="&id="+a),""!=o&&(d+="&master="+o),window.history.pushState({project:e,tag:r},"",d)}i&&i()})},n.loadFromString=function(e,t){eden.execute2(e),eden.root.lookup("_jseden_loaded").assign(!0,eden.root.scope),t&&t(data)},n.reset=function(){edenUI.destroyAllViews(),eden.reset()},n.prototype.reset=function(){this.root.forgetAll("",!0,!1),this.root.collectGarbage(),this.errorNumber=0,this.reportErrors=!0},n.prototype.listenTo=listenTo,n.prototype.emit=emit,n.prototype.error=function(e,t){eden.emit("error",[EdenSymbol.jsAgent,new n.RuntimeError(void 0,0,void 0,e)])},n.prototype.executeEden=function(e,t,n,r,i){console.error("DEPRECATED USE OF OLD PARSER",e),i&&i()},n.prototype.include=function(e,t,n,r){console.error("DEPRECATED USE OF INCLUDE: ",e),r&&r()},n.prototype.attribute=function(e,t){var r="string"==typeof e?eden.root.lookup(e):e;return n.Selectors.processResults([r],t)[0]},n.prototype.execute2=function(e,t,r){var i=t;void 0!==t&&"string"!=typeof t||(i={name:"*execute"},t&&(i.name=t));var s=new n.AST(e,void 0,i,{noindex:!0});0==s.script.errors.length?s.execute(i,r):(console.error(s.script.errors[0].prettyPrint()),r&&r(!1))},n.prototype.execute=n.prototype.execute2,n.prototype.agentFromFile=function(e,t,r){(void 0===n.Agent.agents[e]?new n.Agent(void 0,e):n.Agent.agents[e]).loadFromFile(t,r)},n.edenCodeForValue=function(e,t,r){var i=typeof e,s="";if("undefined"==i)s="@";else if(null===e)s="${{ null }}$";else if("string"==i)s=e.indexOf("\n")>=0?"<<END\n"+e.replace(/\n/g,"\\n")+"\nEND":'"'+e.replace(/\\/g,"\\\\").replace(/\"/g,'\\"')+'"';else if(Array.isArray(e))if(void 0===t&&(t=[]),-1!=t.indexOf(e))s+="<<circular reference>>";else{t.push(e),s="[";for(var o=0;o<e.length-1;o++)s=s+n.edenCodeForValue(e[o],t,r)+", ";e.length>0&&(s+=n.edenCodeForValue(e[e.length-1],t,r)),s+="]",t.pop()}else if("object"==i){if("getEdenCode"in e?s=e.getEdenCode(r):"keys"in e&&Array.isArray(e.keys)&&e.keys.length>0&&"parent"in e&&e.parent instanceof Symbol?s="&"+e.parent.name.slice(1)+"["+e.keys[0]+"]":"object"==typeof window&&"object"==typeof document&&"function"==typeof Element&&(e==window?s="${{ window }}$":e==document?s="${{ document }}$":e==document.documentElement?s="${{ document.documentElement }}$":e==document.body?s="${{ document.body }}$":e instanceof Element&&e.id&&(s='${{ document.getElementById("'+e.id+'") }}$')),""==s)if(void 0===t&&(t=[]),-1!=t.indexOf(e))s+="<<circular reference>>";else{for(var a in t.push(e),s="Object(",e)a in Object.prototype||(s=s+a+", "+n.edenCodeForValue(e[a],t,r)+", ");"Object("!=s&&(s=s.slice(0,-2)),s+=")",t.pop()}}else s="function"==i?"${{\n\t"+e.toString().replace(/\n/g,"\n\t")+"\n}}$":"number"==i&&r?e.toFixed(r):String(e);return s},n.edenCodeForValues=function(){for(var e="",t=0;t<arguments.length-1;t++)e=e+n.edenCodeForValue(arguments[t])+", ";return e+=n.edenCodeForValue(arguments[arguments.length-1])},n.edenCodeForValuesP=function(e){for(var t="",r=1;r<arguments.length-1;r++)t=t+n.edenCodeForValue(arguments[r],void 0,e)+", ";return t+=n.edenCodeForValue(arguments[arguments.length-1],void 0,e)},n.intersection=function(e,t){return Object.keys(e).filter({}.hasOwnProperty.bind(t))},n.prettyPrintValue=function(e,t,r,i,s,o){void 0===s&&(s=!0);var a=typeof t,d="",h=!1;if("undefined"==a)d="@";else if(null===t)d="${{ null }}$";else if("string"==a)d='"'+t.replace(/\\/g,"\\\\").replace(/\"/g,'\\"')+'"',void 0!==r&&d.length>r+1&&(d=d.slice(0,r)+"...",h=!0);else if(Array.isArray(t))if(void 0===o&&(o=[]),-1!=o.indexOf(t))d+="...";else{o.push(t),d="[";for(var c=0;c<t.length-1;c++){if(d=n.prettyPrintValue(d,t[c],r,i,s,o)+",",void 0!==r&&d.length>=r-1){"..."!=d.slice(-3)&&(d+="..."),h=!0;break}d+=" "}t.length>0&&!h&&(d=n.prettyPrintValue(d,t[t.length-1],r,i,s,o)),d+="]",o.pop()}else if("object"==a){if(t instanceof Symbol?d=t.getEdenCode():"keys"in t&&Array.isArray(t.keys)&&t.keys.length>0&&"parent"in t&&t.parent instanceof Symbol?d="&"+t.parent.name.slice(1)+"["+t.keys[0]+"]":"object"==typeof window&&"object"==typeof document&&"function"==typeof Element&&(t==window?d="${{ window }}$":t==document?d="${{ document }}$":t==document.documentElement?d="${{ document.documentElement }}$":t==document.body?d="${{ document.body }}$":t instanceof Element&&t.id&&(d='${{ document.getElementById("'+t.id+'") }}$')),""==d)if(t.toString!=Object.prototype.toString)d=t.toString(),void 0!==r&&d.length>r&&(d=d.slice(0,r)+"...",h=!0);else if(void 0===o&&(o=[]),-1!=o.indexOf(t))d+="...";else{o.push(t),d="{";var p=!1;for(var l in t)if(!(l in Object.prototype)){if(p){d=d.slice(0,-1)+"...",h=!0;break}if(d=d+l+": ","..."==(d=n.prettyPrintValue(d,t[l],r,i,s,o)).slice(-3)){h=!0;break}void 0!==r&&d.length>=r&&(p=!0),d+=", "}"{"==d||h||(d=d.slice(0,-2)),d+="}",o.pop()}}else"function"==a?i?(d="${{\n\t"+t.toString().replace(/\n/g,"\n\t")+"\n}}$",void 0!==r&&d.length>r&&(d=d.slice(0,r)+"...",h=!0)):d="func":d=String(t);if(e)return e+d;var u=n.htmlEscape(d,!s);return u=u.replace(/\.\.\./g,"&hellip;"),s||(u=u.replace(/\n/g,"\\n")),u},n.htmlEscape=function(e,t,n){return void 0===e?"":(e=(e=(e=(e=(e=(e=String(e)).replace(/&/g,"&amp;")).replace(/</g,"&lt;")).replace(/>/g,"&gt;")).replace(/"/g,"&quot;")).replace(/'/g,"&#39;"),n?e=t?e.replace(/\n/g," "):e.replace(/\n/g,"<br/>"):t||(e=e.replace(/\n/g,"<br/>\n")),e)},n.prototype.nextEvalID=0,n.prototype.initialDefinition=function(){console.error("INIT DEF DEP")},n.prototype.getDefinition=function(e,t){return t.eden_definition?t.eden_definition+";":e+" = "+t.context.scope.lookup(t.name).value+";"},e.EdenUI=t,e.Eden=n,"undefined"!=typeof require&&"undefined"!=typeof exports&&(exports.Eden=n)}("undefined"!=typeof window?window:global),Eden.DB={directory:{},meta:{},remoteMeta:{},remoteURL:void 0,username:void 0,userid:void 0,repositories:[document.location.protocol+"//jseden.dcs.warwick.ac.uk/construalmanager","http://localhost:18882"],repoindex:0,retrycount:0,connected:!1,searchServer:document.location.protocol+"//jseden.dcs.warwick.ac.uk",querycache:null,qcacheloaded:!1,qcachetimeout:void 0},Eden.DB.storageSpace=function(){var e,t=0;for(e in localStorage)t+=2*(localStorage[e].length+e.length);return t},console.log("Local Usage:",Eden.DB.storageSpace()/1024/1024+"Mb"),Eden.DB.storageSpace()>4194304)for(var x in console.log("WARNING - CLEARING LOCAL STORAGE"),window.localStorage)delete window.localStorage[x];function removeActive(e){for(var t=e.indexOf("action ACTIVE {"),n=1,r=t+16;r<e.length;r++){var i=e.charAt(r);if("{"==i?n++:"}"==i&&n--,0==n)break}return e.substring(0,t)+e.substring(r)}Eden.DB.listeners={},Eden.DB.emit=emit,Eden.DB.listenTo=listenTo,Eden.DB.isConnecting=function(){return void 0!==Eden.DB.remoteURL},Eden.DB.isConnected=function(){return Eden.DB.connected},Eden.DB.isLoggedIn=function(){return void 0!==Eden.DB.username},Eden.DB.logOut=function(e){Eden.DB.isLoggedIn()&&$.ajax({url:Eden.DB.remoteURL+"/logout",type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(t){Eden.DB.username=void 0,Eden.DB.emit("logout",[]),e&&e(),function e(){Eden.DB.isConnected()&&void 0===Eden.DB.username&&setTimeout(function(){Eden.DB.getLoginName(function(t){t?(Eden.DB.emit("login",[t]),eden.root.lookup("jseden_pm_user").assign(t,eden.root.scope,Symbol.localJSAgent)):e()})},5e3)}()},error:function(e){Eden.DB.disconnect(!0)}})},Eden.DB.connect=function(e,t){function n(){Eden.DB.isConnected()&&void 0===Eden.DB.username&&setTimeout(function(){Eden.DB.getLoginName(function(e){e?(Eden.DB.emit("login",[e]),eden.root.lookup("jseden_pm_user").assign(e,eden.root.scope,Symbol.localJSAgent),function e(){Eden.DB.isConnected()&&setTimeout(function(){Eden.DB.getLoginName(function(t){t?e():Eden.DB.disconnect()})},3e5)}()):n()})},5e3)}Eden.DB.remoteURL=e,function e(t){for(var n in t)t[n].missing=!0,t[n].children&&e(t[n].children)}(Eden.DB.directory),Eden.DB.refreshint=setInterval(function(){for(var e in Eden.DB.directory)Eden.DB.directory[e].missing=!0},2e4),Eden.DB.getLoginName(function(r){Eden.DB.isConnected()?(Eden.DB.retrycount=0,t&&t(Eden.DB.isConnected()),Eden.DB.emit("connected",[e]),eden.root.lookup("jseden_pm_connected").assign(!0,eden.root.scope,Symbol.localJSAgent),r?(Eden.DB.emit("login",[r]),eden.root.lookup("jseden_pm_user").assign(r,eden.root.scope,Symbol.localJSAgent)):n()):t&&t(Eden.DB.isConnected())})},Eden.DB.disconnect=function(e){Eden.DB.remoteURL=void 0,Eden.DB.connected&&(Eden.DB.emit("disconnected",[]),eden.root.lookup("jseden_pm_connected").assign(!1,eden.root.scope,Symbol.localJSAgent)),Eden.DB.connected=!1,Eden.DB.refreshint&&(clearInterval(Eden.DB.refreshint),Eden.DB.refreshint=void 0),e&&(Eden.DB.retrycount<12&&Eden.DB.retrycount++,setTimeout(function(){Eden.DB.repoindex>=Eden.DB.repositories.length&&(Eden.DB.repoindex=Eden.DB.repositories.length-1),Eden.DB.connect(Eden.DB.repositories[Eden.DB.repoindex]),Eden.DB.repoindex=(Eden.DB.repoindex+1)%Eden.DB.repositories.length},200*Math.pow(2,Math.ceil(Eden.DB.retrycount/Eden.DB.repositories.length))))},Eden.DB.getLoginName=function(e){Eden.DB.isConnecting()?$.ajax({url:Eden.DB.remoteURL+"/user/details",type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(t){Eden.DB.connected=!0,null==t||t.error?(Eden.DB.username=void 0,e()):(Eden.DB.username=t.name,Eden.DB.userid=t.id,!t.id||""!=t.name&&t.name||(Eden.DB.username="NoName"),e(Eden.DB.username))},error:function(t,n,r){Eden.DB.disconnect(!0),e(void 0)}}):e()},Eden.DB.localSave=function(e){if(window.localStorage){var t="project_"+e.id;window.localStorage.setItem(t+"_project",e.generate()),window.localStorage.setItem(t+"_id",e.id),window.localStorage.setItem(t+"_vid",e.vid),window.localStorage.setItem(t+"_author",e.author),window.localStorage.setItem(t+"_authorid",e.authorid),window.localStorage.setItem(t+"_name",e.name),window.localStorage.setItem(t+"_title",e.title),window.localStorage.setItem(t+"_thumb",e.thumb),window.localStorage.setItem(t+"_desc",e.desc),window.localStorage.setItem(t+"_tags",e.tags.join(" "));var n=JSON.parse(window.localStorage.getItem("project_list"));null===n&&(n={}),n[e.id]=!0,window.localStorage.setItem("project_list",JSON.stringify(n))}},Eden.DB.save=function(e,t,n){Eden.DB.isConnected()?$.ajax({url:this.remoteURL+"/project/add",type:"post",crossDomain:!0,xhrFields:{withCredentials:!0},data:{projectID:e.id,title:e.title,source:e.generate(),tags:e.tags.join(" "),minimisedTitle:e.name,from:e.vid,image:e.thumb,listed:t,metadata:JSON.stringify({description:e.desc,env:e.environment()}),parentProject:e.parentid},success:function(t){null===t||t.error?(Eden.DB.localSave(e),console.error(t),Eden.DB.emit("error",[t?t.description:"No response from server"]),n&&n(!1)):(console.log("Saved",t),e.id=t.projectID,e.vid=t.saveID,e.readPassword=t.readPassword,e.author=Eden.DB.username,e.authorid=Eden.DB.userid,Eden.DB.localSave(e),n&&n(!0))},error:function(t,r,i){Eden.DB.localSave(e),Eden.DB.handleError(t,r,i),n&&n(!1)}}):(Eden.DB.localSave(e),console.error("Cannot upload, not connected to server. Local save only."),n&&n(!1),eden.error("Cannot upload "+path+", not connected to server. Local save only"))},Eden.DB.getVersions=function(e,t){Eden.DB.isConnected()?$.ajax({url:Eden.DB.remoteURL+"/project/versions?projectID="+e,type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){t(e)},error:function(e){Eden.DB.disconnect(!0)}}):t(void 0)},Eden.DB.loadLocal=function(e){if(window.localStorage){var t="project_"+e,n=window.localStorage.getItem(t+"_project");"undefined"==(e=window.localStorage.getItem(t+"_id"))&&(e=void 0);var r=window.localStorage.getItem(t+"_vid");"undefined"==r&&(r=void 0);var i=window.localStorage.getItem(t+"_author");"undefined"==i&&(i=void 0);var s=window.localStorage.getItem(t+"_authorid"),o=window.localStorage.getItem(t+"_name"),a=window.localStorage.getItem(t+"_tags"),d=window.localStorage.getItem(t+"_thumb");"undefined"==d&&(d=void 0);var h=window.localStorage.getItem(t+"_desc"),c=window.localStorage.getItem(t+"_title");if(n&&""!=n)return{source:n,saveID:r,title:c,ownername:i,owner:s,image:d,tags:a,parentProject:null,minimisedTitle:o,projectMetaData:JSON.stringify({description:h})}}},Eden.DB.hasLocal=function(e,t){var n=JSON.parse(window.localStorage.getItem("project_list"));if(null!==n&&n[e]){if(!t)return!0;var r="project_"+e,i=window.localStorage.getItem(r+"_vid");return console.log("Load local",i,t),(i=parseInt(i))>=t}return!1},Eden.DB.load=function(e,t,n,r){if(3==arguments.length&&(r=n,n=void 0),Eden.DB.isConnected())$.ajax({url:Eden.DB.remoteURL+"/project/get?projectID="+e+(t?"&to="+t:"")+(n?"&readPassword="+n:""),type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(n){if(null==n||n.error)r(void 0,"No such version"),console.error("No such version "+t+" for "+e),console.log(n),Eden.DB.emit("error",[n?n.description:"No response from server"]);else if(eden.root.lookup("jseden_autosave").value()&&Eden.DB.hasLocal(e,n.saveID)){console.log("Yes, load local");var i=Eden.DB.loadLocal(e);if(removeActive(i.source)!=removeActive(n.source)){var s=window.confirm("You have local changes, restore these?");r(s?i:n)}else r(n)}else r(n)},error:function(e,t,n){Eden.DB.handleError(e,t,n),r(void 0,"Disconnected")}});else if(r){if(eden.root.lookup("jseden_autosave").value()&&Eden.DB.hasLocal(e,t))window.confirm("You have local changes, restore these?")?r(Eden.DB.loadLocal(e)):r(void 0,"Disconnected");else r(void 0,"Disconnected")}},Eden.DB.search=function(e,t,n,r,i){var s=this.remoteURL+"/project/";s+=""==e?"search?limit="+n+"&offset="+(t-1)*n:"search?limit="+n+"&offset="+(t-1)*n+"&query="+encodeURIComponent(e),r&&(s+="&by="+r),$.ajax({url:s,type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){if(e&&e.error)return console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]),void i(void 0);i(e||void 0)},error:function(e,t,n){Eden.DB.handleError(e,t,n),i(void 0)}})},Eden.DB.getMeta=function(e,t){var n=this.remoteURL+"/project/";n+="search?limit=20&query=.id("+e+")",$.ajax({url:n,type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){if(e&&e.error)return console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]),void t(void 0);t(e||void 0)},error:function(e,t,n){Eden.DB.handleError(e,t,n)}})},Eden.DB.remove=function(e,t){$.ajax({url:this.remoteURL+"/project/remove",type:"post",crossDomain:!0,xhrFields:{withCredentials:!0},data:{projectID:e},success:function(e){null===e||e.error?(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]),t&&t(!1)):(console.log("Removed",e),t&&t(!0))},error:function(e,n,r){Eden.DB.handleError(e,n,r),t&&t(!1)}})},Eden.DB.rate=function(e,t){$.ajax({url:this.remoteURL+"/project/rate",type:"post",crossDomain:!0,xhrFields:{withCredentials:!0},data:{projectID:e,stars:t},success:function(e){(null===e||e.error)&&(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]))},error:function(e,t,n){Eden.DB.handleError(e,t,n)}})},Eden.DB.patch=function(e,t){$.ajax({url:this.remoteURL+"/project/patch",type:"post",crossDomain:!0,xhrFields:{withCredentials:!0},data:{selector:e,source:t},success:function(e){(null===e||e.error)&&(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]))},error:function(e,t,n){Eden.DB.handleError(e,t,n)}})},Eden.DB.getSelector=function(e,t,n){Eden.DB.isConnected()?$.ajax({url:this.remoteURL+"/code/get?selector="+e.replace("#","%23")+"&timestamp="+t,type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){(null===e||e.error)&&(Eden.DB.emit("error",[e?e.description:"No response from server"]),n({})),n(e||{})},error:function(e,t,r){n({}),Eden.DB.handleError(e,t,r)}}):n({})},Eden.DB.searchSelector=function(e,t,n){if(Eden.DB.isConnected())$.ajax({url:this.remoteURL+"/code/search?selector="+e.replace("#","%23")+"&outtype="+t,type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(t){if((null===t||t.error)&&(Eden.DB.emit("error",[t?t.description:"No response from server"]),n([])),t)return Eden.DB.qcacheloaded||(Eden.DB.querycache=JSON.parse(window.localStorage.getItem("query_cache")),Eden.DB.qcacheloaded=!0,null===Eden.DB.querycache&&(Eden.DB.querycache={})),Eden.DB.querycache[e]=t,Eden.DB.requestQCacheSave(),void n(t);n([])},error:function(e,t,r){n([]),Eden.DB.handleError(e,t,r)}});else{console.log("ATTEMPT CACHE",e),Eden.DB.qcacheloaded||(Eden.DB.querycache=JSON.parse(window.localStorage.getItem("query_cache")),Eden.DB.qcacheloaded=!0,null===Eden.DB.querycache&&(Eden.DB.querycache={}));var r=Eden.DB.querycache[e];n(r||[])}},Eden.DB.requestQCacheSave=function(){Eden.DB.qcachetimeout||(Eden.DB.qcachetimeout=setTimeout(function(){window.localStorage.setItem("query_cache",JSON.stringify(Eden.DB.querycache)),Eden.DB.qcachetimeout=void 0},2e3))},Eden.DB.postComment=function(e,t,n){var r=e?e.id:-1,i=e?e.vid:-1;Eden.DB.isLoggedIn()&&$.ajax({url:this.remoteURL+"/comment/post",type:"post",crossDomain:!0,xhrFields:{withCredentials:!0},data:{projectID:r,versionID:i,publiclyVisible:n?0:1,comment:t},success:function(e){(null===e||e.error)&&(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]))},error:function(e,t,n){Eden.DB.handleError(e,t,n)}})};var waitingforcomment=!1;function guid(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}Eden.DB.searchComments=function(e,t,n,r,i,s){if(waitingforcomment)s();else{var o=e?e.id:-1;Eden.DB.isConnected()&&(waitingforcomment=!0,$.ajax({url:this.remoteURL+"/comment/search?projectID="+o+(i?"&newerThan="+i:"")+"&offset="+(n-1)*r+"&limit="+r,type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){waitingforcomment=!1,s(e||[])},error:function(e,t,n){waitingforcomment=!1,s(),Eden.DB.handleError(e,t,n)}}))}},Eden.DB.removeComment=function(e){Eden.DB.isLoggedIn()&&$.ajax({url:this.remoteURL+"/comment/delete",type:"post",crossDomain:!0,xhrFields:{withCredentials:!0},data:{commentID:e},success:function(e){(null===e||e.error)&&(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]))},error:function(e,t,n){Eden.DB.handleError(e,t,n)}})},Eden.DB.follow=function(e,t){Eden.DB.isLoggedIn()&&$.ajax({url:this.remoteURL+"/social/followproject?projectID="+e,type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){null===e||e.error?(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]),t&&t(!1)):t&&t(!0)},error:function(e,n,r){Eden.DB.handleError(e,n,r),t&&t(!1)}})},Eden.DB.adminCommentActivity=function(e,t,n){Eden.DB.isLoggedIn()&&$.ajax({url:this.remoteURL+"/comment/activity?limit=10&offset="+t+(e?"&newerThan="+e:""),type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){null===e||e.error?(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]),n&&n(!1)):n&&n(e)},error:function(e,t,r){Eden.DB.handleError(e,t,r),n&&n(!1)}})},Eden.DB.handleError=function(e,t,n){console.log("DB ERROR",t,n),"error"!=t||n?"error"==t?Eden.DB.emit("error",[n]):"timeout"==t?(Eden.DB.emit("error",["Network timeout"]),Eden.disconnect(!0)):(Eden.DB.emit("error","Unknown network error"),Eden.disconnect(!0)):(Eden.DB.disconnect(!0),Eden.DB.emit("error",["Not connected to construal cloud"]))},Eden.DB.adminProjectActivity=function(e,t,n){Eden.DB.isLoggedIn()&&$.ajax({url:this.remoteURL+"/project/activity?limit=30&offset="+t+(e?"&newerThan="+e:""),type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){null===e||e.error?(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]),n&&n(!1)):n&&n(e)},error:function(e,t,r){Eden.DB.handleError(e,t,r),n&&n(!1)}})},Eden.DB.getPopularTags=function(e,t){$.ajax({url:this.remoteURL+"/project/tags?tag="+e,type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){null===e||e.error?(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]),t&&t(!1)):t&&t(e)},error:function(e,n,r){Eden.DB.handleError(e,n,r),t&&t(!1)}})};var browserID=window.localStorage.construit_uid;null!=browserID&&""!=browserID||(browserID=guid(),window.localStorage.setItem("construit_uid",browserID));var sessionID=guid(),root,eden,edenUI,doneLoading;function touchHandler(e){var t=e.changedTouches[0],n=document.createEvent("MouseEvent");n.initMouseEvent({touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup"}[e.type],!0,!0,window,1,t.screenX,t.screenY,t.clientX,t.clientY,!1,!1,!1,!1,0,null),t.target.dispatchEvent(n),-1==e.target.className.indexOf("ui-dialog-titlebar")&&-1==e.target.className.indexOf("ui-resizable-handle")||e.preventDefault()}Eden.DB.log=function(e,t){console.log("LOG",browserID,Eden.DB.userid?Eden.DB.userid:-1,e,t),$.ajax({url:this.searchServer+"/jsedenlog/jsedenlog",type:"post",data:{browserID:browserID,sessionID:sessionID,userID:Eden.DB.userid,action:e,details:t}})},function(){function e(e,t){return root.lookup("view_"+e+"_"+t)}function t(e){return $("#"+e+"-dialog")}EdenUI.prototype.menuBarHeight=45,EdenUI.prototype.dialogBorderWidth=1,EdenUI.prototype.titleBarHeight=0,EdenUI.prototype.largeTitleBar=41.22+EdenUI.prototype.dialogBorderWidth,EdenUI.prototype.scrollBarSize=14+EdenUI.prototype.dialogBorderWidth,EdenUI.prototype.scrollBarSize2=window.innerHeight-$(window).height(),EdenUI.prototype.dialogFrameWidth=2*EdenUI.prototype.dialogBorderWidth,EdenUI.prototype.dialogFrameHeight=EdenUI.prototype.titleBarHeight+EdenUI.prototype.dialogBorderWidth,EdenUI.prototype.bottomBarHeight=34.906,EdenUI.prototype.gridSizeX=Math.floor(30*window.innerWidth/1920),EdenUI.prototype.gridSizeY=Math.floor(30*window.innerHeight/1920),EdenUI.prototype.minimumWindowWidthShowing=72+EdenUI.prototype.dialogBorderWidth,EdenUI.prototype.createEmbedded=function(e,t){return this.embeddedInstances[e]?this.embeddedInstances[e]:(edenUI.views[t].embed?n=edenUI.views[t].embed(e,e,""):edenUI.views[t].embedded&&(n=edenUI.views[t].embedded(e,e,"")),n?(this.embeddedInstances[e]=n,n):void 0);var n},EdenUI.prototype.createView=function(n,r,i){if(r in this.views){"name"in this.views[r]&&(n=this.views[r].name);var s=this,o=EdenSymbol.defaultAgent,a=this.activeDialogs[n],d=e(n,"visibility"),h=d.value(),c=e(n,"title"),p=c.value();if(a==r)return"visible"!=h&&d.assign("visible",root.scope,o),this.brieflyHighlightView(n),this.viewInstances[n];this.eden.root.beginAutocalcOff(),void 0!==a&&(p==this.views[a].title&&(p=void 0),this.destroyView(n,!1)),this.titleBarHeight="ScriptView"==a?this.largeTitleBar:this.titleBarHeight;var l=this.menuBarHeight,u=this.views[r].title,E=this.views[r].dialog(n+"-dialog",u);void 0===E&&(E={}),this.viewInstances[n]=E;var f;E.position;f="true"==edenUI.getOptionValue("optCollapseToTitleBar")?"collapse":"maximize";var m=t(n);m.dialog({closeOnEscape:!1,position:{using:function(){}},beforeClose:function(){return E.closing?(E.closing=!1,!0):s.closeView(n)},focus:function(){}});var g=[B("type"),B("x"),B("y"),B("width"),B("height"),B("lock"),B("noborder"),B("title"),B("visibility")];m.get(0).setAttribute("data-observables",g.join(","));var S=this.getDialogWindow(n);m.dialogExtend({dblclick:f,minimizable:!0,maximizable:!0,beforeMinimize:function(e){return $(e.target).parent().removeClass("window-activated"),s.hideView(n),!1},minimize:function(){var e=t(n).data("dialog-extend-minimize-controls");e.css("position","relative"),e.css("top",""),e.css("left","")},maximize:function(e){var t=S[0],n=m[0];t.style.top=l+"px";var r=window.innerHeight-l-s.scrollBarSize2-2*s.dialogBorderWidth;"true"!=edenUI.getOptionValue("optHideOnMinimize")&&(r-=s.bottomBarHeight),t.style.height=r+"px",n.style.height=r-s.titleBarHeight+"px"},restore:function(e){m.dialog("moveToTop"),s.brieflyHighlightView(e.target.id.slice(0,-7)),m.dialog("widget").draggable("option","containment",[-Number.MAX_VALUE,l,Number.MAX_VALUE,Number.MAX_VALUE])}}),this.activeDialogs[n]=r;var y=e(n,"type");y.value()!=r&&(y.removeJSObserver("changeType"),y.assign(r,root.scope,EdenSymbol.localJSAgent),y.addJSObserver("changeType",function(e,t){void 0!==t&&-1!==root.lookup("views_list").value().indexOf(n)&&s.createView(n,t)}));var v=root.lookup("views_list"),x=v.value();Array.isArray(x)?-1===x.indexOf(n)&&((x=x.slice()).push(n),v.assign(x,root.scope,EdenSymbol.localJSAgent)):v.assign([n],root.scope,EdenSymbol.localJSAgent);var b=e(n,"lock"),A=b.value();widthSym=e(n,"width"),widthSym.addJSObserver("plugins",P),widthSym.definition||void 0!==widthSym.value()||widthSym.assign(m.dialog("option","width"),root.scope,o);var T=e(n,"height");T.addJSObserver("plugins",P),T.definition||void 0!==T.value()||T.assign(m.dialog("option","height")-(A?0:this.titleBarHeight),root.scope,o),P();var w=m.closest(".ui-dialog").position(),k=e(n,"x");k.addJSObserver("plugins",L),k.definition||void 0!==k.value()||k.assign(w.left,root.scope,o);var I=e(n,"y");I.addJSObserver("plugins",L),I.definition||void 0!==I.value()||I.assign(w.top,root.scope,o),L(),"visible"!=h&&(void 0===h?d.assign("visible",root.scope,o):_(0,h)),d.addJSObserver("changeState",_);var O=E.titleBarInfo;delete E.titleBarInfo,Object.defineProperty(E,"titleBarInfo",{get:function(){return O},set:function(e){O=e;var t=c.value();void 0!==e&&(t=t+" ("+e+")"),m.dialog("option","title",t)},enumerable:!0}),c.addJSObserver("updateTitleBar",j),void 0===p?c.assign(u,root.scope,o):j(0,p),b.addJSObserver("changeState",U),void 0!==A&&U(0,A);var N=e(n,"noborder");N.addJSObserver("changeState",F);var C=N.value();void 0!==C&&F(0,C);var D=e(n,"pin");D.addJSObserver("changeState",V);var R=D.value();return void 0!==R?V(0,R):this.unpinView(n),m.dialog("widget").draggable("option","containment",[-Number.MAX_VALUE,l,Number.MAX_VALUE,Number.MAX_VALUE]),m.resizeExtend=0,m.on("dialogresizestop",function(t,r){m.previousWidth=void 0,m.momentum=0,m.resizeExtend=0;var i=e(n,"width"),o=e(n,"height"),a=s.eden.root;a.beginAutocalcOff(),i.assign(r.size.width,a.scope,EdenSymbol.hciAgent),o.assign(r.size.height-s.titleBarHeight,a.scope,EdenSymbol.hciAgent),a.endAutocalcOff()}),m.on("dialogdragstop",function(t,r){var i=s.eden.root;i.beginAutocalcOff(),console.log(r),e(n,"x").assign(r.position.left,eden.root.scope,EdenSymbol.hciAgent),e(n,"y").assign(r.position.top,eden.root.scope,EdenSymbol.hciAgent),i.endAutocalcOff()}),m.on("dialogdragstart",function(){if(e(n,"x").definition||e(n,"y").definition)return!1}),m.on("dialogresizestart",function(){if(e(n,"width").definition||e(n,"height").definition)return!1}),this.eden.root.endAutocalcOff(),this.emit("createView",[n,r]),e(n,"nostack").value()?m.get(0).parentNode.className+=" ui-back":m.get(0).parentNode.className+=" ui-front",E}function B(e){return"view_"+n+"_"+e}function P(e,t){s.resizeView(n)}function L(e,t){s.moveView(n)}function _(e,t){var r=m.dialogExtend("state");"hidden"==t?"minimized"!=r&&s.minimizeView(n):"maximized"==t||m.dialog("isOpen")&&"minimized"!=r&&"collapsed"!=r||s.showView(n)}function j(e,t){var n=t;void 0!==E.titleBarInfo&&(n=n+" ("+E.titleBarInfo+")"),m.dialog("option","title",n),edenUI.menu&&edenUI.menu.updateViewsMenu()}function U(e,t){lockVal=t,t?(m.siblings(".ui-dialog-titlebar").css("display","none"),m.dialog("option","resizable",!1),s.resizeView(n)):(m.siblings(".ui-dialog-titlebar").css("display","block"),m.dialog("option","resizable",!0),s.resizeView(n))}function F(e,t){var n=m.get(0).parentNode.style;t?(n.border="none",n.boxShadow="none"):(n.border="1px solid #777",n.boxShadow="0 0 40px #6d8cac")}function V(e,t){t?s.pinView(n):s.unpinView(n)}this.eden.error(new Error("View type "+r+" is unavailable.  Check that the associated plug-in is loaded."))},EdenUI.prototype.closeView=function(e){return this.hideView(e),edenUI.eden.root.collectGarbage(),!0},EdenUI.prototype.destroyAllViews=function(){for(var e in this.viewInstances)this.destroyView(e,!0)},EdenUI.prototype.destroyView=function(e,n){if(e in this.viewInstances&&!this.viewInstances[e].closing){this.viewInstances[e].closing=!0,this.viewInstances[e].destroy&&this.viewInstances[e].destroy(),root.forgetAll("^View_"+e+"_",!0,!1,!0),n?root.forgetAll("^view_"+e+"_",!0,!1,!0):root.lookup("view_"+e+"_title").removeJSObserver("updateTitleBar");var r=t(e);if(r.dialog("destroy"),r.remove(),r.html(""),delete this.activeDialogs[e],delete this.viewInstances[e],n){var i=root.lookup("views_list"),s=i.value();if(Array.isArray(s)){var o,a=s.indexOf(e);if(-1!==a)0==a?o=s.slice(1):(s.splice(a,1),o=s),i.assign(o,root.scope,EdenSymbol.hciAgent)}}this.emit("destroyView",[e])}},EdenUI.prototype.getDialogContent=function(e){return t(e)},EdenUI.prototype.getDialogWindow=function(e){return t(e).parent()},EdenUI.prototype.showView=function(e){var n=t(e);n.dialog("open").dialog("moveToTop");var r=n.dialogExtend("state");return"normal"!=r&&"maximized"!=r&&n.dialogExtend("restore"),this.activeDialogs[e]},EdenUI.prototype.updateView=function(e,t){var n=this.viewInstances[e];n&&n.update&&n.update(t)},EdenUI.prototype.highlightView=function(e,t){t?this.windowHighlighter.highlight(e):(this.getDialogContent(e).data("dialog-extend-minimize-controls")||this.getDialogWindow(e)).addClass("window-highlighted")},EdenUI.prototype.stopHighlightingView=function(e,t,n){t?(this.windowHighlighter.stopHighlight(e,n),n&&this.getDialogContent(e).dialog("moveToTop")):(this.getDialogContent(e).data("dialog-extend-minimize-controls")||this.getDialogWindow(e)).removeClass("window-highlighted")},EdenUI.prototype.brieflyHighlightView=function(e){var t=this.getDialogWindow(e);t.addClass("window-activated"),setTimeout(function(){t.removeClass("window-activated")},600)},EdenUI.prototype.hideView=function(e){e in this.viewInstances&&(this.viewInstances[e].closing=!0,t(e).dialog("close"))},EdenUI.prototype.minimizeView=function(e){if("true"==edenUI.getOptionValue("optHideOnMinimize"))this.hideView(e);else{if(!(e in this.viewInstances))return;t(e).dialogExtend("minimize")}},EdenUI.prototype.minimizeObscuredViews=function(e){if("true"!=edenUI.getOptionValue("optHideOnMinimize")){var n=t(e),r=n.closest(".ui-dialog");if(!r.is(this.windowHighlighter.lastDialog)&&"normal"==n.dialogExtend("state"))for(var i=n.get(0),s=r.position(),o=s.left,a=s.top,d=n.dialog("option","width")+2*EdenUI.prototype.dialogBorderWidth,h=n.dialog("option","height")+2*EdenUI.prototype.dialogBorderWidth,c=r.hasClass("ui-top"),p=$(".ui-dialog-content"),l=0;l<p.length;l++){var u=$(p[l]);if(p[l]!==i&&"normal"==u.dialogExtend("state")){var E=u.closest(".ui-dialog");if(!E.hasClass("ui-front")||c){var f=E.position(),m=f.left,g=f.top,S=u.dialog("option","width")+2*EdenUI.prototype.dialogBorderWidth,y=u.dialog("option","height")+2*EdenUI.prototype.dialogBorderWidth;m>=o-0&&m+S<=o+d+0&&g>=a-0&&g+y<=a+h+0&&u.dialogExtend("minimize")}}}}},EdenUI.prototype.moveView=function(n){var r,i,s=t(n),o=e(n,"x"),a=e(n,"y"),d=o.value(),h=a.value(),c=this.minimumWindowWidthShowing-s.dialog("option","width");r=d<c?c:d,i=h<0?0:h;var p=s.parent().get(0);p.style.left=r+"px",p.style.top=i+"px"},EdenUI.prototype.resizeView=function(n){var r=this.viewInstances[n];if(!r.resizing){var i=t(n),s=i.parent().position(),o=s.left,a=s.top,d=e(n,"width"),h=d.value(),c=e(n,"height"),p=c.value()+this.titleBarHeight;e(n,"lock")||this.titleBarHeight,this.scrollBarSize,this.dialogBorderWidth,this.titleBarHeight,window.innerWidth,document.body.scrollLeft,window.innerHeight,document.body.scrollTop,this.scrollBarSize2,this.bottomBarHeight,EdenSymbol.hciAgent.name;d.origin!==EdenSymbol.hciAgent&&i.dialog("option","width",h),c.origin!==EdenSymbol.hciAgent&&i.dialog("option","height",p),"resize"in r&&r.resize(h,p)}},EdenUI.prototype.pinView=function(e){var t=this.getDialogWindow(e);t.removeClass("ui-front"),t.addClass("ui-top"),this.viewInstances[e].pinned=!0},EdenUI.prototype.unpinView=function(e){var t=this.getDialogWindow(e);this.viewInstances[e].pinned&&(t.removeClass("ui-top"),t.get(0).style.zIndex=9999,t.addClass("ui-front"),this.viewInstances[e].pinned=!1,this.windowHighlighter.unpin(t))},EdenUI.prototype.newProject=function(){this.eden.reset(),this.destroyView("jspe",!0),"Canvas2D"in this.plugins&&this.eden.executeEden('createCanvas("picture");',"new project","",EdenSymbol.hciAgent,noop),"ScriptInput"in this.plugins&&this.eden.executeEden('createView("input", "ScriptInput");',"new project","",EdenSymbol.hciAgent,noop),this.views.ErrorLog.errorWindow&&this.views.ErrorLog.errorWindow.html(""),Eden.Agent.removeAll()},EdenUI.prototype.modalDialog=function(e,t,n,r,i){var s=$('<div id="modal"></div>'),o=function(e){return function(t){s.dialog("destroy"),s.remove(),i(e)}},a=$("<div>"+t+"</div>");s.append(a);for(var d=[],h=0;h<n.length;h++){var c={text:n[h],click:o(h)};d.push(c)}var p=n.length,l={text:"Cancel",click:o(p)};d.push(l),s.dialog({buttons:d,modal:!0,resizable:!1,show:"fade",title:e,close:function(){i(p)},open:function(){$(this).parent().find("button")[r].focus()},width:375}),$(".ui-widget-overlay").css("z-index",10001),s.parent().css("z-index",10002)}}(),URLUtil={},URLUtil.getParameterByName=function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)"),n=window.location.href,r=t.exec(n);return null===r?"":decodeURIComponent(r[1].replace(/\+/g," "))},URLUtil.getParameters=function(){var e=window.location.href.split("?")[1];if(!e)return{};for(var t=e.split("&"),n={},r=0;r<t.length;r++){var i=t[r].split("=");void 0===n[i[0]]&&(n[i[0]]=[]),i.length>1&&n[i[0]].push(decodeURIComponent(i[1]))}return n},URLUtil.getArrayParameterByName=function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");for(var t=new RegExp("[\\?&]"+e+"=([^&#]*)","g"),n=window.location.href,r=t.exec(n),i=[];null!==r;){var s=decodeURIComponent(r[1].replace(/\+/g," "));i.push(s),r=t.exec(n)}return i},URLUtil.isCrossDomain=function(e){var t=e.match(/^([a-zA-Z][a-zA-Z\d+.\-]*:)(\/\/)?([^\/@]*@)?([^\/:]+)(:\d+)?(\/|$)/);return null!==t&&(t[1]!=window.location.protocol||t[4]!=document.domain||t[5].slice(1)!=window.location.port)},URLUtil.downloadFile=function(e){var t=e.url,n=e.dataType,r=e.sync,i=e.success,s=e.error;if(void 0===n&&(n="text"),"function"!=typeof s)throw new Error("An error handling function must be specified.");if("function"==typeof i)if(void 0!==t){t=String(t);var o=rt.config.proxyBaseURL,a=this.isCrossDomain(t);if(!0===r&&a&&this.isCrossDomain(o))s(null,"error","Synchronous downloading not possible");else{if("boolean"==typeof r){if(a){var d="crossDomainCallback"+Math.floor(9007199254740991*Math.random());return window[d]=function(e){try{if(e.success){var t,r=e.success,o=!1;switch(n){case"text":t=r;break;case"json":try{t=JSON.parse(r)}catch(e){s(null,"parserror",e),o=!0}break;default:s(null,"error","No cross-domain interpretation available for data type "+n),o=!0}o||i(t,"success",null)}else s(null,"error",e.error)}finally{delete window[d]}},$.ajax({url:o+"?url="+encodeURI(t)+"&callback="+d,dataType:"script",async:!r,error:s})}return e.async=!r,$.ajax(e)}s(null,"error","The sync option must be a boolean, not a "+typeof r)}}else s(null,"error","A URL must be specified.");else s(null,"error","A success callback function must be specified.")},URLUtil.updateQueryString=function(e){var t=URLUtil.getParameters();for(var n in e)t[n]=encodeURI(e[n]);var r="?",i=!0;for(var n in t)i||(r+="&"),i=!1,r+=n+"="+t[n];return r},"isInteger"in Number||(Number.isInteger=function(e){return parseInt(e)===e});var doingNavigateAway=!1,confirmUnload=function(e){if(Eden.DB.log("leave",{project:eden.project?eden.project.id:-1}),!doingNavigateAway&&(eden.root.lookup("jseden_autosave").value()&&eden.project.localSave(),eden.root.lookup("jseden_leaveprompt").value())){var t="Leaving this page will discard the current script. Your work will not be saved.";return e.returnValue=t,t}};function Construit(options,callback){root=new Folder,eden=new Eden(root);var menuBar="false"!=URLUtil.getParameterByName("menus"),pluginsStr=URLUtil.getParameterByName("plugins"),exec=URLUtil.getParameterByName("exec"),load=URLUtil.getParameterByName("load"),lang=URLUtil.getParameterByName("lang"),restore=URLUtil.getParameterByName("restore"),vid=URLUtil.getParameterByName("vid"),readPassword=URLUtil.getParameterByName("r"),writePassword=URLUtil.getParameterByName("w"),roles=URLUtil.getParameterByName("roles"),master=URLUtil.getParameterByName("master"),myid=URLUtil.getParameterByName("id"),query=URLUtil.getParameterByName("q"),mode=URLUtil.getParameterByName("mode"),urlparams=URLUtil.getParameters(),plugins;for(var x in urlparams)urlparams[x].length>1?eden.root.lookup("jseden_url_"+x).assign(urlparams[x],eden.root.scope,Symbol.localJSAgent):eden.root.lookup("jseden_url_"+x).assign(urlparams[x][0],eden.root.scope,Symbol.localJSAgent);""==lang&&(lang="en");var defaultPlugins=["Canvas2D","DependencyMap","HTMLContent","PluginManager","ScriptInput","SymbolLookUpTable","SymbolViewer","VersionViewer"];if(""==pluginsStr)plugins=defaultPlugins;else{var includeDefaultPlugins=" "==pluginsStr[0];includeDefaultPlugins&&(pluginsStr=pluginsStr.slice(1)),plugins=pluginsStr.split(","),includeDefaultPlugins&&(plugins=plugins.concat(defaultPlugins)),""!=views&&"default"!=views||(plugins.push("Canvas2D"),plugins.push("ScriptInput"))}$(document).ready(function(){edenUI=new EdenUI(eden),edenUI.scrollBarSize2=window.innerHeight-$(window).height(),Eden.Project.init(),eden.ismobile=mobilecheck(),eden.root.lookup("jseden_mobile").assign(eden.ismobile,eden.root.scope,Symbol.defaultAgent),$.ajax({url:"version.json",dataType:"json",success:function(e){e.tag&&(document.title=document.title+" "+e.tag);var t=e.tag.slice(1).split("."),n=t[2].split("-");eden.root.lookup("jseden_version_major").assign(parseInt(t[0]),eden.root.scope,Symbol.defaultAgent),eden.root.lookup("jseden_version_minor").assign(parseInt(t[1]),eden.root.scope,Symbol.defaultAgent),eden.root.lookup("jseden_version_patch").assign(parseInt(n[0]),eden.root.scope,Symbol.defaultAgent),eden.root.lookup("jseden_version_commit").assign(parseInt(n[1]),eden.root.scope,Symbol.defaultAgent),eden.root.lookup("jseden_version_name").assign(e.tag,eden.root.scope,Symbol.defaultAgent),eden.root.lookup("jseden_version_sha").assign(e.sha,eden.root.scope,Symbol.defaultAgent)},cache:!1}),$(document).on("keydown",null,"ctrl+m",function(){edenUI.cycleNextView()}).on("keyup",null,"ctrl",function(){edenUI.stopViewCycling()}).on("keydown",null,"backspace",function(e){var t=e.target,n=t.tagName.toUpperCase();"INPUT"==n||"TEXTAREA"==n||t.isContentEditable||e.preventDefault()}),"false"!=edenUI.getOptionValue("optConfirmUnload")&&window.addEventListener("beforeunload",confirmUnload);var loadLanguage=function(lang,callback){$.getScript("js/language/"+lang+".js",function(data){Language.language=lang,eval(data),menuBar?edenUI.menu=new EdenUI.MenuBar:(document.getElementById("jseden-main").style.top="0",eden.root.lookup("jseden_nomenu").assign(!0,eden.root.scope,Symbol.defaultAgent)),options&&options.noload||(edenUI.feedback=new EdenUI.Feedback,edenUI.explorer=new EdenUI.Explorer),callback()})},loadPlugins=function(e,t){var n=function(){if(e.length>0){var r=e.shift();edenUI.loadPlugin(r,n)}else t()};n()};doneLoading=function(e){if(window.scrollTo(0,0),edenUI.finishedLoading(),exec&&(";"!=exec.slice(-1)&&(exec+=";"),eden.execute2(exec)),(""!=myid||""!=master)&&(eden.peer=new Eden.Peer(""!=master?master:void 0,""!=myid?myid:void 0),roles)){roles=roles.split(",");for(var t=0;t<roles.length;t++)eden.peer.roles[roles[t]]=!0}callback&&callback(e)},loadLanguage(lang,function(){options&&options.noload?Eden.DB.connect(Eden.DB.repositories[Eden.DB.repoindex],function(){console.log("DONE LOADING"),doneLoading(!0)}):loadPlugins(plugins,function(){Eden.DB.connect(Eden.DB.repositories[Eden.DB.repoindex],function(){""!=load?(null!==mode&&""!=mode&&eden.root.lookup("jseden_project_mode").assign(mode,eden.root.scope,Symbol.defaultAgent),Eden.DB.log("urlload",{href:window.location.href,useragent:navigator.userAgent,referrer:document.referrer,pid:load,vid:vid,private:null!==readPassword}),Eden.Project.load(parseInt(load),null===vid||""==vid?void 0:parseInt(vid),null===readPassword||""==readPassword?void 0:readPassword,function(){doneLoading(!0)})):""!=restore?(null!==mode&&""!=mode&&eden.root.lookup("jseden_project_mode").assign(mode,eden.root.scope,Symbol.defaultAgent),Eden.project.restore(),doneLoading(!0)):(Eden.DB.log("home",{href:window.location.href,referrer:document.referrer,useragent:navigator.userAgent}),doneLoading(!1))}),Eden.DB.repoindex=(Eden.DB.repoindex+1)%Eden.DB.repositories.length})})})}function EdenSyntaxData(){this.value=void 0,this.error=!1,this.line=0}function EdenStream(e){this.code=e,this.position=0,this.position_stack=[0],this.prevposition=0,this.line=1,this.prevline=1,this.data=new EdenSyntaxData}function edenTokenTest(e){for(var t=new EdenStream(e),n=[],r={};t.valid();)n.push(t.readToken(r));return n}EdenStream.prototype.pushPosition=function(){this.position_stack.push(this.position)},EdenStream.prototype.popPosition=function(){this.position=this.position_stack.pop()},EdenStream.prototype.discardPosition=function(){this.position_stack.pop()},EdenStream.prototype.get=function(){return this.position<this.code.length?this.code.charCodeAt(this.position++):0},EdenStream.prototype.peek=function(){return this.position<this.code.length?this.code.charCodeAt(this.position):0},EdenStream.prototype.peek2=function(){return this.position+1>=this.code.length?0:this.code.charCodeAt(this.position+1)},EdenStream.prototype.peek3=function(){return this.position+2>=this.code.length?0:this.code.charCodeAt(this.position+2)},EdenStream.prototype.readLine=function(){var e=this.code.indexOf("\n",this.position);if(-1==e){var t=this.code.substring(this.position);return this.position=this.code.length,t}t=this.code.substring(this.position,e+1);return this.position=e+1,this.line++,t},EdenStream.prototype.peekLine=function(){var e=this.code.indexOf("\n",this.position);return-1==e?this.code.substring(this.position):this.code.substring(this.position,e+1)},EdenStream.prototype.move=function(e){this.position=e},EdenStream.prototype.reset=function(){this.position=0,this.position_stack=[0],this.prevposition=0,this.line=1},EdenStream.prototype.tokenText=function(){return this.code.substr(this.prevposition,this.position-this.prevposition)},EdenStream.prototype.isBEOL=function(){if(10==this.peek2())return!0;for(var e=this.prevposition-1,t=this.code.charCodeAt(e);9==t||32==t;)e--,t=this.code.charCodeAt(e);return 10==t},EdenStream.prototype.skip=function(){this.position++},EdenStream.prototype.eof=function(){return this.position>=this.code.length},EdenStream.prototype.valid=function(){return this.position<this.code.length},EdenStream.prototype.unget=function(){this.position--},EdenStream.prototype.skipWhiteSpace=function(){for(;this.valid();){var e=this.peek();if(10==e&&this.line++,9!=e&&10!=e&&13!=e&&32!=e&&160!=e)break;this.skip()}},EdenStream.prototype.skipLine=function(){for(;this.valid()&&10!=this.peek();)this.skip()},EdenStream.prototype.isAlphaNumeric=function(e){return e>=48&&e<=57||e>=65&&e<=90||e>=97&&e<=122||95==e||e>=128||36==e},EdenStream.prototype.isNumeric=function(e){return e>=48&&e<=57},EdenStream.prototype.tokenType=function(e){return"OBSERVABLE"==e?"identifier":"JAVASCRIPT"==e?"javascript":"NUMBER"==e?"number":"STRING"==e?"string":"CHARACTER"==e?"character":"BOOLEAN"==e?"boolean":"string"!=typeof e?(console.error(e),"INVALID"):this.isAlphaNumeric(e.charCodeAt(0))?"keyword":"("==e||"["==e||"{"==e?"openbracket":")"==e||"]"==e||"}"==e?"closebracket":","==e||"."==e||";"==e||":"==e?"separator":"operator"},EdenStream.prototype.parseAlphaNumeric=function(e){var t="";if(0==this.isAlphaNumeric(this.peek()))return!1;for(;this.valid()&&this.isAlphaNumeric(this.peek());)t+=String.fromCharCode(this.get());return e.value=t,!0},EdenStream.prototype.parseString=function(e,t){for(var n="";this.valid()&&this.peek()!=t;){var r=String.fromCharCode(this.get());if("\n"==r)return this.unget(),e.error=!0,void(e.value="LINEBREAK");n+="\\"==r?"\\"+(r=String.fromCharCode(this.get())):r}this.valid()&&this.peek()==t?(this.skip(),e.error=!1):e.error=!0,e.value=n},EdenStream.prototype.parseCharacter=function(e){var t=String.fromCharCode(this.get());if("'"==t)return e.value="",void(e.error=!0);"\\"==t&&(t=String.fromCharCode(this.get())),e.value=t,this.valid()&&39==this.peek()?this.skip():e.error=!0},EdenStream.prototype.parseNumber=function(e){for(var t="";this.valid()&&this.isNumeric(this.peek());)t+=String.fromCharCode(this.get());if(46==this.peek()&&this.isNumeric(this.peek2()))for(this.skip(),t+=".";this.valid()&&this.isNumeric(this.peek());)t+=String.fromCharCode(this.get());e.value=parseFloat(t)},EdenStream.prototype.readToken=function(e){if(this.prevline=this.line,this.skipWhiteSpace(),this.prevposition=this.position,this.eof())return"EOF";var t=this.code.charCodeAt(this.position);switch(this.position++,t){case 33:return 61==this.peek()?(this.skip(),"!="):126==this.peek()?(this.skip(),"!~"):"!";case 34:return e?'"':(this.parseString(this.data,34),"STRING");case 35:return 35==this.peek()?(this.skip(),"##"):"#";case 36:if(123==this.peek()&&123==this.peek2())return this.skip(),this.skip(),"${{";break;case 37:return"%";case 38:return 38==this.peek()?(this.skip(),"&&"):61==this.peek()?(this.skip(),"&="):"&";case 39:return e?"'":(this.parseString(this.data,39),"STRING");case 40:return"(";case 41:return")";case 42:return 61==this.peek()?(this.skip(),"*="):47==this.peek()?(this.skip(),"*/"):"*";case 43:return 43==this.peek()?(this.skip(),"++"):61==this.peek()?(this.skip(),"+="):"+";case 44:return",";case 45:return 45==this.peek()?(this.skip(),"--"):61==this.peek()?(this.skip(),"-="):"-";case 46:return 46==this.peek()?(this.skip(),".."):".";case 47:return 47==this.peek()&&61==this.peek2()?(this.skip(),"//="):47==this.peek()?(this.skip(),"//"):61==this.peek()?(this.skip(),"/="):42==this.peek()?(this.skip(),"/*"):"/";case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.unget(),this.parseNumber(this.data),"NUMBER";case 58:return 58==this.peek()?(this.skip(),"::"):":";case 59:return";";case 60:return 60==this.peek()?(this.skip(),"<<"):61==this.peek()?(this.skip(),"<="):47==this.peek()?(this.skip(),"</"):"<";case 61:return 61==this.peek()?(this.skip(),"=="):126==this.peek()?(this.skip(),"=~"):"=";case 62:return 62==this.peek()?(this.skip(),">>"):61==this.peek()?(this.skip(),">="):">";case 63:return"?";case 64:return"@";case 91:return"[";case 92:return'"';case 93:return"]";case 94:return"^";case 96:return"`";case 123:return"{";case 124:return 124==this.peek()?(this.skip(),"||"):61==this.peek()?(this.skip(),"|="):"|";case 125:return 125==this.peek()&&36==this.peek2()?(this.skip(),this.skip(),"}}$"):"}";case 126:return 62==this.peek()?(this.skip(),"~>"):"~"}if(this.unget(),this.parseAlphaNumeric(this.data))return Language.keywords.hasOwnProperty(this.data.value)?Language.keywords[this.data.value]:Language.values.hasOwnProperty(this.data.value)?(this.data.value=Language.values[this.data.value],"BOOLEAN"):"OBSERVABLE";throw this.skip(),new Error("Invalid Token: "+t)},"undefined"!=typeof require&&"undefined"!=typeof exports&&(exports.EdenStream=EdenStream,exports.EdenSyntaxData=EdenSyntaxData),Eden.SyntaxError=function(e,t,n){this.type="syntax",this.context=e,this.errno=t,this.extra=n,this.token=e.token,this.prevtoken=e.previous,this.line=e.stream.prevline,this.position=e.stream.position,this.prevposition=e.stream.prevposition},Eden.SyntaxError.UNKNOWN=0,Eden.SyntaxError.EXPCLOSEBRACKET=1,Eden.SyntaxError.BADFACTOR=2,Eden.SyntaxError.ACTIONCOLON=3,Eden.SyntaxError.ACTIONNOWATCH=4,Eden.SyntaxError.ACTIONCOMMAS=5,Eden.SyntaxError.ACTIONOPEN=6,Eden.SyntaxError.ACTIONCLOSE=7,Eden.SyntaxError.LOCALNAME=8,Eden.SyntaxError.LOCALSEMICOLON=9,Eden.SyntaxError.WHENTYPE=10,Eden.SyntaxError.LISTINDEXEXP=11,Eden.SyntaxError.LISTINDEXCLOSE=12,Eden.SyntaxError.LVALUE=13,Eden.SyntaxError.SEMICOLON=14,Eden.SyntaxError.STATEMENT=15,Eden.SyntaxError.DEFINITION=16,Eden.SyntaxError.FUNCCALLEND=17,Eden.SyntaxError.LISTLITCLOSE=18,Eden.SyntaxError.TERNIFCOLON=19,Eden.SyntaxError.IFCONDOPEN=20,Eden.SyntaxError.IFCONDCLOSE=21,Eden.SyntaxError.PARAMNAME=22,Eden.SyntaxError.PARAMSEMICOLON=23,Eden.SyntaxError.FUNCOPEN=24,Eden.SyntaxError.FUNCCLOSE=25,Eden.SyntaxError.FUNCNAME=26,Eden.SyntaxError.FOROPEN=27,Eden.SyntaxError.FORCLOSE=28,Eden.SyntaxError.FORSTART=29,Eden.SyntaxError.FORCOND=30,Eden.SyntaxError.SUBSCRIBEOPEN=31,Eden.SyntaxError.SUBSCRIBECLOSE=32,Eden.SyntaxError.SWITCHOPEN=33,Eden.SyntaxError.SWITCHCLOSE=34,Eden.SyntaxError.DEFAULTCOLON=35,Eden.SyntaxError.CASELITERAL=36,Eden.SyntaxError.CASECOLON=37,Eden.SyntaxError.INSERTCOMMA=38,Eden.SyntaxError.DELETECOMMA=39,Eden.SyntaxError.APPENDCOMMA=40,Eden.SyntaxError.SCOPENAME=41,Eden.SyntaxError.SCOPEEQUALS=42,Eden.SyntaxError.SCOPECLOSE=43,Eden.SyntaxError.BACKTICK=44,Eden.SyntaxError.WHILEOPEN=45,Eden.SyntaxError.WHILECLOSE=46,Eden.SyntaxError.WHILENOSTATEMENT=47,Eden.SyntaxError.NEGNUMBER=48,Eden.SyntaxError.DEFINELISTIX=49,Eden.SyntaxError.OUTOFBOUNDS=50,Eden.SyntaxError.PROPERTYNAME=51,Eden.SyntaxError.WHILEOFDO=52,Eden.SyntaxError.PARAMNUMBER=53,Eden.SyntaxError.AFTEROPEN=55,Eden.SyntaxError.AFTERCLOSE=56,Eden.SyntaxError.ACTIONNAME=57,Eden.SyntaxError.WHENOPEN=58,Eden.SyntaxError.WHENCLOSE=59,Eden.SyntaxError.DONAME=60,Eden.SyntaxError.PROCNAME=61,Eden.SyntaxError.IMPORTPATH=62,Eden.SyntaxError.IMPORTOPTION=63,Eden.SyntaxError.IMPORTCOMB=64,Eden.SyntaxError.IFNOSTATEMENT=65,Eden.SyntaxError.AFTERNOSTATEMENT=66,Eden.SyntaxError.WHENNOSTATEMENT=67,Eden.SyntaxError.LITCHAREMPTY=68,Eden.SyntaxError.LITCHARCLOSE=69,Eden.SyntaxError.LITSTRLINE=70,Eden.SyntaxError.LITSTRCLOSE=71,Eden.SyntaxError.IMPORTTAG=72,Eden.SyntaxError.SWITCHSCRIPT=73,Eden.SyntaxError.RANGEBANNED=74,Eden.SyntaxError.HEREDOCTOKEN=75,Eden.SyntaxError.SELECTORACTION=76,Eden.SyntaxError.SELECTORATTRIB=77,Eden.SyntaxError.SELECTORTAG=78,Eden.SyntaxError.SELECTORBTICK=79,Eden.SyntaxError.SELECTOROPTION=80,Eden.SyntaxError.QUERYOPEN=81,Eden.SyntaxError.QUERYCLOSE=82,Eden.SyntaxError.QUERYSELECTOPEN=83,Eden.SyntaxError.QUERYSELECTCLOSE=84,Eden.SyntaxError.QUERYSELECTCOMMA=85,Eden.SyntaxError.BLOCKCOMMENT=86,Eden.SyntaxError.NEWLINE=87,Eden.SyntaxError.WHENROLE=88,Eden.SyntaxError.ALIASQUERY=89,Eden.SyntaxError.EVALOPEN=90,Eden.SyntaxError.EVALCLOSE=91,Eden.SyntaxError.DOATTRIBCLOSE=92,Eden.SyntaxError.DOBADATTRIB=93,Eden.SyntaxError.QUERYNOTALLOWED=94,Eden.SyntaxError.SYNCNOTALLOWED=95,Eden.SyntaxError.db=[{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return"}"==this.token||"]"==this.token?0:";"==this.token?1:2},suggestion:{expected:[")"],next:[";","+","-","==","<=",">=","!=","/","*","%","^"]}},{message:function(){if("{"==this.token)return 0;if(")"==this.token)return"operator"==this.context.stream.tokenType(this.prevtoken)?3:1;var e=this.context.stream.tokenType(this.token);return"keyword"==e?4:"operator"==e?3:2},suggestion:{expected:["NUMBER","STRING","OBSERVABLE","&","!","("],next:["NUMBER","STRING","OBSERVABLE","&","!","(",";","+","-","==","<=",">=","!=","/","*","%","^"]}},{message:function(){return"{"==this.token?1:"OBSERVABLE"==this.token?0:"keyword"==this.context.stream.tokenType(this.token)?3:2},suggestion:{expected:[":"],next:["OBSERVABLE"]}},{message:function(){if("{"==this.token)return 2;if("("==this.token)return 3;if("["==this.token&&(":"==this.prevtoken||","==this.prevtoken))return 6;if("NUMBER"==this.token||"STRING"==this.token)return 4;if(","==this.token)return 5;var e=this.context.stream.tokenType(this.token);return"keyword"==e?0:1},suggestion:{expected:["OBSERVABLE"],next:[",","{"]}},{message:function(){return"{"==this.token?0:"("!=this.token||this.context.stream.isBEOL()?"keyword"==this.context.stream.tokenType(this.token)?2:3:1},suggestion:{expected:["OBSERVABLE"],next:[",","{"]}},{message:function(){if(("("==this.token||"["==this.token)&&this.context.stream.isBEOL())return 6;if("("==this.token)return 0;if("["==this.token)return 1;if(";"==this.token)return 2;var e=this.context.stream.tokenType(this.token);return"keyword"==e||"identifier"==e?3:"separator"==e?4:5},suggestion:{expected:["{"],next:["local","OBSERVABLE","if","for","switch","while","return"]}},{message:function(){return(")"==this.token||"]"==this.token)&&this.context.stream.isBEOL()?0:1},suggestion:{expected:["}"],next:["proc","func","if","for","OBSERVABLE","switch","while","return","continue","break"]}},{message:function(){return"keyword"==this.context.stream.tokenType(this.token)?0:";"==this.token?1:2},suggestion:{expected:["OBSERVABLE"],next:[";"]}},{message:function(){return"is"==this.token||"="==this.token?1:0},suggestion:{expected:[";"],next:["local","OBSERVABLE","if","for","switch","while","return"]}},{message:function(){return 0},suggestion:{expected:["touch","change","("],next:["OBSERVABLE",":","NUMBER","STRING","!","&"]}},{message:function(){return 0},suggestion:{expected:["(","OBSERVABLE","NUMBER"],next:["]","OBSERVABLE","NUMBER","+","-","/","*","%","^"]}},{message:function(){return 1},suggestion:{expected:["]"],next:["[",".","=","+=","-=","==","+","-","/","*",";","/=","*=","%","^","is"]}},{message:function(){return 0},suggestion:{expected:["OBSERVABLE"],next:[".","[","is","=","+=","-=","++","--","*=","/="]}},{message:function(){if("."==this.token){var e=this.position>=2?this.context.stream.code.charCodeAt(this.position-2):0;return"NUMBER"==this.prevtoken&&32!=e&&160!=e?1:2}return"OBSERVABLE"==this.token?this.context.stream.isBEOL()?3:4:0},suggestion:{expected:[";"],next:["proc","when","OBSERVABLE","if","for","while","EOF","switch","func"]}},{message:function(){return 0},suggestion:{expected:["proc","func","when","if","for","while","switch","OBSERVABLE","{"],next:["OBSERVABLE","(","change","touch","is","=","+=","-=","*=","proc","func","when","if","for","while","switch"]}},{message:function(){return 0},suggestion:{expected:["=","is","+=","-=","/=","*="],next:["(","OBSERVABLE","NUMBER","STRING","!"]}},{message:function(){return 0},suggestion:{expected:[")"],next:[";","(","[","+","-","/","*","%","^"]}},{message:function(){return 0},suggestion:{expected:["]"],next:[]}},{message:function(){return 0},suggestion:{expected:[":"],next:[]}},{message:function(){return 0},suggestion:{expected:["("],next:[]}},{message:function(){return 0},suggestion:{expected:[")"],next:[]}},{message:function(){return 0},suggestion:{expected:["OBSERVABLE"],next:[";"]}},{message:function(){return 0},suggestion:{expected:[";"],next:["para","local","OBSERVABLE","if","for","switch","while","return"]}},{message:function(){if(("("==this.token||"["==this.token)&&this.context.stream.isBEOL())return 6;if("("==this.token)return 0;if("["==this.token)return 1;if(";"==this.token)return 2;var e=this.context.stream.tokenType(this.token);return"keyword"==e||"identifier"==e?3:"separator"==e?4:5},suggestion:{expected:["{"],next:["local","OBSERVABLE","if","for","switch","while","return"]}},{message:function(){return 0},suggestion:{expected:["}"],next:[";"]}},{message:function(){return 0},suggestion:{expected:["OBSERVABLE"],next:["{"]}},{message:function(){return 0},suggestion:{expected:["("],next:[]}},{message:function(){return 0},suggestion:{expected:[")"],next:[]}},{message:function(){return 0},suggestion:{expected:[";"],next:[]}},{message:function(){return 0},suggestion:{expected:[";"],next:[]}},{message:function(){return 0},suggestion:{expected:["["],next:[]}},{message:function(){return 0},suggestion:{expected:["]"],next:[]}},{message:function(){return 0},suggestion:{expected:["("],next:[]}},{message:function(){return 0},suggestion:{expected:["]"],next:[]}},{message:function(){return 0},suggestion:{expected:[":"],next:[]}},{message:function(){return 0},suggestion:{expected:["NUMBER","STRING"],next:[]}},{message:function(){return 0},suggestion:{expected:[":"],next:[]}},{message:function(){return 0},suggestion:{expected:[","],next:[]}},{message:function(){return 0},suggestion:{expected:[","],next:[]}},{message:function(){return 0},suggestion:{expected:[","],next:[]}},{message:function(){return 0},suggestion:{expected:["OBSERVABLE"],next:[]}},{message:function(){return 0},suggestion:{expected:["="],next:[]}},{message:function(){return 0},suggestion:{expected:["}"],next:[]}},{message:function(){return 0},suggestion:{expected:["`"],next:[]}},{message:function(){return 0},suggestion:{expected:["("],next:[]}},{message:function(){return 0},suggestion:{expected:[")"],next:[]}},{message:function(){return 0},suggestion:{expected:[")"],next:[]}},{message:function(){return 0},suggestion:{expected:["NUMBER"],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){var e=this.context.stream.tokenType(this.token);return"keyword"==e?0:"boolean"==e||"character"==e||"string"==e||"number"==e?1:":"==this.token?4:"{"==this.token?5:"closebracket"==this.token?3:2},suggestion:{expected:["OBSERVABLE"],next:[":"]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}}],Eden.SyntaxError.prototype.extractBefore=function(e){for(var t=this.prevposition;t>0&&e>0&&10!=this.context.stream.code.charCodeAt(t);)t--,e--;return 10==this.context.stream.code.charCodeAt(t)&&t++,this.context.stream.code.substr(t,this.prevposition-t)},Eden.SyntaxError.prototype.extractToken=function(){return this.context.stream.code.substr(this.prevposition,this.position-this.prevposition)},Eden.SyntaxError.prototype.extractAfter=function(e){for(var t=this.position;t<this.context.stream.code.length&&e>0&&10!=this.context.stream.code.charCodeAt(t);)t++,e--;return this.context.stream.code.substr(this.position,t-this.position)},Eden.SyntaxError.prototype.buildSuggestion=function(){var e=Eden.SyntaxError.db[this.errno].suggestion;return-1!=e.next.indexOf(this.token)?this.extractBefore(10)+e.expected[0]+" "+this.extractToken()+this.extractAfter(10):this.extractBefore(10)+e.expected[0]+" "+this.extractAfter(10)},Eden.SyntaxError.prototype.messageText=function(){var e=Eden.SyntaxError.db[this.errno],t=Language.errors[this.errno][e.message.call(this)];return void 0===this.extra?t:t+": "+this.extra},Eden.SyntaxError.prototype.prettyPrint=function(){this.context.stream.pushPosition(),this.context.stream.move(this.position);var e=Eden.SyntaxError.db[this.errno],t="Error:\n    "+Language.errors[this.errno][e.message.call(this)]+"\n    Source : "+this.context.src+", line "+this.line+"\n    Code   : "+this.errno;return t+="\n    Here   : "+this.extractBefore(10)+">>> "+this.extractToken()+" <<<"+this.extractAfter(10),e.suggestion&&(t+="\n    Suggestion : "+this.buildSuggestion()),this.context.stream.popPosition(),t},Eden.SyntaxError.prototype.toString=function(){return this.prettyPrint()},Eden.RuntimeError=function(e,t,n,r){this.type="runtime",this.line=-1,this.statement=n,this.extra=r,this.errno=t,this.context=e,this.lastsymbol=eden.root.lastlookup,console.error(r)},Eden.RuntimeError.UNKNOWN=0,Eden.RuntimeError.ASSIGNEXEC=1,Eden.RuntimeError.FUNCCALL=2,Eden.RuntimeError.ACTIONNAME=3,Eden.RuntimeError.NOAGENT=4,Eden.RuntimeError.NOTSUPPORTED=5,Eden.RuntimeError.ASSIGNTODEFINED=6,Eden.RuntimeError.ASSIGNDIMENSION=7,Eden.RuntimeError.EXTENDSTATIC=8,Eden.RuntimeError.INFINITERANGE=9,Eden.RuntimeError.NOLISTRANGE=10,Eden.RuntimeError.LEFTCONCAT=11,Eden.RuntimeError.RIGHTCONCAT=12,Eden.RuntimeError.AGENTSOURCE=13,Eden.RuntimeError.JSOBSERVER=14,Eden.RuntimeError.PROCAGENT=15,Eden.RuntimeError.ARGUMENTS=16,Eden.RuntimeError.NOTCHILD=17,Eden.RuntimeError.INFINITEWHEN=18,Eden.RuntimeError.prototype.messageText=function(){var e=!this.statement||"functioncall"!=this.statement.type&&"definition"!=this.statement.type&&"assignment"!=this.statement.type?"":"'"+this.statement.lvalue.name+"': ";switch(this.errno){case Eden.RuntimeError.ACTIONNAME:case Eden.RuntimeError.NOAGENT:case Eden.RuntimeError.NOTSUPPORTED:case Eden.RuntimeError.AGENTSOURCE:case Eden.RuntimeError.JSOBSERVER:case Eden.RuntimeError.PROCAGENT:case Eden.RuntimeError.ARGUMENTS:case Eden.RuntimeError.EXTENDSTATIC:return e+this.extra;case Eden.RuntimeError.ASSIGNTODEFINED:return e+"cannot assign to a defined list, use 'is'";case Eden.RuntimeError.ASSIGNDIMENSION:return e+"list does not have this many dimensions";case Eden.RuntimeError.RIGHTCONCAT:return e+"Concatenation: When the right hand side is a list then the left hand side must also be a list";case Eden.RuntimeError.LEFTCONCAT:return e+"Concatenation: When the left hand side is a list then the right hand side must also be a list";case Eden.RuntimeError.INFINITERANGE:return e+"range scope is infinite";case Eden.RuntimeError.NOLISTRANGE:return e+"range 'in' is not a list";case Eden.RuntimeError.INFINITEWHEN:return e+"infinite when loop detected"}return String(this.extra).search("is not a function")>=0?e+"function used does not exist":this.errno==Eden.RuntimeError.FUNCCALL&&(String(this.extra).search("Cannot read property 'call'")>=0||String(this.extra).search("Cannot read property 'apply'")>=0)?e+"procedure does not exist":String(this.extra).match(/Cannot read property .* of undefined/)?e+"uses an undefined list":this.extra},Eden.RuntimeError.prototype.edenSource=function(){if(this.statement)if("definition"==this.statement.type){var e=eden.root.symbols[this.statement.lvalue.name];if(e&&e.definition)return e.getSource()}else{if(this.statement.getSource)return this.statement.getSource();if(this.context)return this.context.getSource(this.statement)}},Eden.RuntimeError.prototype.javascriptSource=function(){return this.statement.generate({scopes:[],dependencies:{}},"scope")},Eden.RuntimeError.prototype.details=function(){var e="";return"definition"!=this.statement.type&&"assignment"!=this.statement.type||(e+="Symbol: "+this.statement.lvalue.name+"\n"),String(this.extra).search("SyntaxError")>=0?e+="JavaScript: "+this.javascriptSource()+"\n":e+="Source: "+this.edenSource()+"\n",this.extra.message&&(e+="Original: "+this.extra.message+"\n"),e},Eden.RuntimeError.prototype.prettyPrint=function(){return this.extra&&this.extra.stack?"Run-time Error:\n"+this.extra.stack:"Run-time Error:\n"},Eden.Selectors={cache:{}},Eden.Selectors.getScriptBase=function(e){for(var t=e;t.parent;)t=t.parent;return t.base.origin.name},Eden.Selectors.buildScriptTree=function(e){for(var t={},n=0;n<e.length;n++)for(var r=e[n].split(/[\.\:]+/),i=t,s=0;s<r.length;s++)void 0===i[r[s]]&&(i[r[s]]={}),i=i[r[s]];return t},Eden.Selectors.getID=function(e){for(var t=e,n=[];t;)"script"==t.type&&t.name?void 0===t.parent?t.base&&t.base.origin&&t.base.origin.id?n.splice(0,0,t.name+".id("+t.base.origin.id+")"):eden.project&&t===eden.project.ast.script?n.splice(0,0,":project"):n.splice(0,0,t.name+".id("+t.id+")"):n.splice(0,0,t.name):n.splice(0,0,".id("+t.id+")"),(t=t.parent)&&("script"==t.type&&t.parent&&"script"!=t.parent.type?t="codeblock"==t.parent.type?t.parent.parent:t.parent:"codeblock"==t.type&&(t=t.parent));return n.join(" > ")},Eden.Selectors.getPath=function(e){},Eden.Selectors.testType=function(e){if("binaryop"==e.type)switch(e.op){case"+":case"-":case"/":case"*":case"^":case"%":return"number";case"//":return"list";case"==":case"<":case">":case"<=":case">=":case"||":case"&&":case"!=":return"boolean";default:return"unknown"}else if("literal"==e.type)switch(e.datatype){case"NUMBER":return"number";case"BOOLEAN":return"boolean";case"STRING":return"string";case"LIST":return"list";default:return"unknown"}return"unknown"},Eden.Selectors.getChildren=function(e,t){var n=[];if(void 0===e)return n;for(var r=0;r<e.length;r++)if("script"==e[r].type)n.push.apply(n,e[r].statements),t&&n.push.apply(n,Eden.Selectors.getChildren(e[r].statements,t));else if("for"==e[r].type)e[r].statement&&"script"==e[r].statement.type&&(n.push.apply(n,e[r].statement.statements),t&&n.push.apply(n,Eden.Selectors.getChildren(e[r].statement.statements,t)));else if("if"==e[r].type)e[r].statement&&"script"==e[r].statement.type&&(n.push.apply(n,e[r].statement.statements),t&&n.push.apply(n,Eden.Selectors.getChildren(e[r].statement.statements,t))),e[r].elsestatement&&"script"==e[r].elsestatement.type&&(n.push.apply(n,e[r].elsestatement.statements),t&&n.push.apply(n,Eden.Selectors.getChildren(e[r].elsestatement.statements,t)));else if("when"==e[r].type)e[r].statement&&"script"==e[r].statement.type&&(n.push.apply(n,e[r].statement.statements),t&&n.push.apply(n,Eden.Selectors.getChildren(e[r].statement.statements,t)));else if("while"==e[r].type)e[r].statement&&"script"==e[r].statement.type&&(n.push.apply(n,e[r].statement.statements),t&&n.push.apply(n,Eden.Selectors.getChildren(e[r].statement.statements,t)));else if("do"==e[r].type)e[r].script&&"script"==e[r].script.type&&(n.push.apply(n,e[r].script.statements),t&&n.push.apply(n,Eden.Selectors.getChildren(e[r].script.statements,t)));else if("section"==e[r].type){for(var i=e[r].nextSibling,s=[];i&&("section"!=i.type||i.depth>e[r].depth);)"dummy"!=i.type&&(n.push(i),s.push(i)),i=i.nextSibling;t&&n.push.apply(n,Eden.Selectors.getChildren(s,t))}return n=n.filter(function(e){return"dummy"!=e.type})},Eden.Selectors.allowedOptions={external:!0,local:!0,history:!0,all:!0,indexed:!0,index:!0,nosort:!0,remote:!0},Eden.Selectors.resultTypes={brief:!0,comment:!0,source:!0,innersource:!0,title:!0,path:!0,name:!0,symbol:!0,line:!0,depends:!0,value:!0,tags:!0,rawcomment:!0,id:!0,remote:!0,root:!0,enabled:!0,executed:!0,exprtree:!0,single:!0,expression:!0,locked:!0},Eden.Selectors.expressionToLists=function(e){switch(e.type){case"binaryop":return[e.op,Eden.Selectors.expressionToLists(e.l),Eden.Selectors.expressionToLists(e.r)];case"ternaryop":return["eif",Eden.Selectors.expressionToLists(e.first),Eden.Selectors.expressionToLists(e.condition),Eden.Selectors.expressionToLists(e.second)];case"unaryop":return[e.op,Eden.Selectors.expressionToLists(e.r)];case"length":return["#",Eden.Selectors.expressionToLists(e.l)];case"index":return Eden.Selectors.expressionToLists(e.expression)}if(console.log(e),"functioncall"==e.type){console.log("FUNCCALL");for(var t=[],n=0;n<e.params.length;n++)t.push(Eden.Selectors.expressionToLists(e.params[n]));return["(",t,")"]}if("literal"==e.type)switch(e.datatype){case"NUMBER":case"STRING":case"BOOLEAN":return["literal",e.value];case"LIST":for(t=[],n=0;n<e.value.length;n++)t.push(Eden.Selectors.expressionToLists(e.value[n]));return["literal",t]}else if("primary"==e.type){if(0==e.extras.length)return e.observable;var r=[e.observable];for(n=0;n<e.extras.length;n++)r.push(Eden.Selectors.expressionToLists(e.extras[n]));return r}},Eden.Selectors.listsToExpression=function(e){if(!Array.isArray(e))return e;for(var t=[],n=0;n<e.length;n++)t.push(Eden.Selectors.listsToExpression(e[n]));return"("+t.join(" ")+")"},Eden.Selectors.processResults=function(e,t){if(t){for(var n=Array.isArray(t)?t:t.split(","),r=[],i=!1,s=0;s<e.length;s++){for(var o=e[s],a=[],d=0;d<n.length;d++){var h=void 0;switch(n[d]){case"single":i=!0;break;case"brief":o.doxyComment&&(h=o.doxyComment.brief());break;case"comment":o.doxyComment&&(h=o.doxyComment.stripped());break;case"source":h=o&&o.getSource?o.getSource():"";break;case"innersource":"script"==o.type?h=o.getInnerSource():"custom"==o.type?h=o.text:o&&o.getSource&&(h=o.getSource());break;case"outersource":h=o.getOuterSource();break;case"exprtree":o.expression&&(h=Eden.Selectors.expressionToLists(o.expression));break;case"title":if(o.base&&o.base.mainDoxyComment){o.base.mainDoxyComment.stripped();var c=o.base.mainDoxyComment.getControls();c&&c["@title"]&&(h=c["@title"][0])}break;case"type":h=o.type;break;case"locked":h=!!o.lock;break;case"name":o.lvalue&&o.lvalue.name?h=o.lvalue.name:o.name&&"do"!=o.type?h=o.name:void 0===o.parent&&o.base&&o.base.origin?h=o.base.origin.name:void 0!==o.path&&(h=o.path);break;case"symbol":o.lvalue&&o.lvalue.name&&(h=o.lvalue.name);break;case"line":void 0!==o.line&&(h=o.line);break;case"depends":h=o.dependencies?Object.keys(o.dependencies):[];break;case"value":if(o instanceof EdenSymbol)h=o.value();else try{h=o.expression?o.expression.execute({scopes:[]},eden.project.ast,eden.root.scope):void 0}catch(e){}break;case"active":h=o.lvalue&&eden.root.symbols[o.lvalue.name]&&eden.root.symbols[o.lvalue.name].origin&&eden.root.symbols[o.lvalue.name].origin.id==o.id;break;case"executed":h=o.executed>0;break;case"historic":h=-1==o.executed;break;case"tags":o.doxyComment&&(h=o.doxyComment.getHashTags());break;case"rawcomment":o.doxyComment&&(h=o.doxyComment.content);break;case"controls":case"id":h=o.id;break;case"path":h=Eden.Selectors.getID(o);break;case"remote":for(var p=o;p.parent;)p=p.parent;if(!p.base||!p.base.origin){h=!1;break}h=p.base.origin.remote;break;case"root":h=void 0===o.parent}a.push(h)}a.length>1?r.push(a):1==a.length&&void 0!==a[0]&&r.push(a[0])}return i?r[0]:r}return e},Eden.Selectors.outerBracket=function(e){for(var t=0,n=0;n<e.length;n++)if("("==e.charAt(n))t++;else if(")"==e.charAt(n)&&0==--t)return n;return e.length},Eden.Selectors.makeRegex=function(e){return e="/"==e.charAt(0)?"/"==e.charAt(e.length-1)?e.substring(1,e.length-1):e.substring(1):"^"+e.replace(/([\\+^$.|(){[])/g,"\\$1").replace(/([*?])/g,".$1")+"$",new RegExp(e)},Eden.Selectors.SortNode=function(){this.type="sort",this.query=void 0},Eden.Selectors.DotNode=function(e){this.type="dot",this.label=e},Eden.Selectors.parse=function(e,t){var n=t;if(e&&""!=e){for(e=e.trim();e.length>0&&"@"==e.charAt(0);){n||(n={});var r=(e=e.substring(1)).search(/[^a-z]+/);-1==r&&(r=e.length);var i=e.substring(0,r);e=e.substring(r).trim(),n[i]=!0}return Eden.Selectors._parse(e,n)}},Eden.Selectors._parse=function(e,t){var n;if(e&&""!=e){if(">"==e.charAt(0))">"==e.charAt(1)?(n=new Eden.Selectors.NavigateNode(">",!0),e=e.substring(2).trim()):(n=new Eden.Selectors.NavigateNode(">",!1),e=e.substring(1).trim());else if("<"==e.charAt(0))"<"==e.charAt(1)?(n=new Eden.Selectors.NavigateNode("<",!0),e=e.substring(2).trim()):(n=new Eden.Selectors.NavigateNode("<",!1),e=e.substring(1).trim());else if(","==e.charAt(0))n=new Eden.Selectors.UnionNode,e=e.substring(1).trim();else if(":"==e.charAt(0)||"."==e.charAt(0)){-1==(c=(a=e.substring(1)).search(/[^a-zA-Z0-9\-]/))?c=e.length:c++;var r=e.substring(0,c),i=void 0;if(c<e.length&&"("==e.charAt(c)){var s=Eden.Selectors.outerBracket(e);i=e.substring(c+1,s),e=e.substring(s+1).trim()}else e=e.substring(c).trim();if(r.charAt(1).match(/[0-9]+/)){var o=parseInt(r.substring(1));n=new Eden.Selectors.PropertyNode(o)}else n=new Eden.Selectors.PropertyNode(r,i)}else if("^"==e.charAt(0)){var a;-1==(c=(a=e.substring(1)).search(/[^a-zA-Z0-9\-]/))&&(c=a.length);r=a.substring(0,c),i=void 0;if(c<a.length&&"("==a.charAt(c)){s=Eden.Selectors.outerBracket(a);i=a.substring(c+1,s),a=a.substring(s+1).trim()}else a=a.substring(c);(n=new Eden.Selectors.SortNode).addSort(r),e=a.trim()}else if("#"==e.charAt(0)){var d=e.match(/#[a-zA-Z0-9_*?]+/);if(null===d)return;d=d[0],n=new Eden.Selectors.TagNode(d),e=e.substring(d.length).trim()}else if(e.charAt(0).match(/[a-zA-Z*?]+/)){-1==(c=e.search(/[^a-zA-Z0-9_*?\s]+/))&&(c=e.length);var h=e.substring(0,c).trim();n=new Eden.Selectors.NameNode(h),e=e.substring(c).trim()}else if("/"==e.charAt(0)){for(var c=-1,p=1;p<e.length;p++){if("/"==e.charAt(p)){c=p+1;break}"\\"==e.charAt(p)&&p++}-1==c&&(c=e.length);h=e.substring(0,c).trim();n=new Eden.Selectors.NameNode(h),e=e.substring(c).trim()}else e="";var l=Eden.Selectors._parse(e,t);if(n)return n.options=t,n.append(l)}},Eden.Selectors.unique=function(e){for(var t={},n=0;n<e.length;n++)t[e[n].id]=e[n];var r=[];for(var i in t)r.push(t[i]);return r},Eden.Selectors.sort=function(e){return e.sort(function(e,t){return t.stamp-e.stamp})},Eden.Selectors.queryWithin=function(e,t,n,r){r||console.error("QUERY WITHIN WITHOUT CB");var i=Eden.Selectors.parse(t),s=[];return i?(i.filter(e).then(e=>{var t=Eden.Selectors.unique(e);s=n?Eden.Selectors.processResults(t,n):t,r&&r(s)}),s):s},Eden.Selectors.query=function(e,t,n,r){if(!r)return[];Eden.Selectors._query(e,t,n,(e,n)=>{r(n?e:Eden.Selectors.processResults(e,t))})},Eden.Selectors._query=function(e,t,n,r){var i,s,o=[];if(r||console.warn("Selector query without callback: ",e),n&&(i=n.context,s=n.minimum),"boolean"==typeof s&&console.trace("Bool"),"string"!=typeof e||""==e){var a=[];return console.log("Invalid selector"),r&&r(a,!0),a}var d=Eden.Selectors.parse(e.trim(),n?n.options:void 0);if(void 0===d)return console.log("Selector parse error"),r&&r([],!0),[];let h=n=>{if(o=n,d.options&&d.options.remote||(d.options&&d.options.all||(o=Eden.Selectors.unique(o)),d.options&&d.options.nosort||(o=Eden.Selectors.sort(o))),0==d.local&&r&&(void 0===s||o.length<s)){var i=e.search(/[\s\.\:\#\@\>]/);-1==i&&(i=e.length);var a=e.substring(0,i).trim();if(a.startsWith("plugins")){for(var h=e.split(">"),c="",p=0;p<h.length;p++)h[p]=h[p].trim(),c+=h[p],p<h.length-1&&(c+="/");$.ajax({url:c+".js-e",dataType:"text",success:function(t){var n=[new Eden.AST(t,void 0,{name:h[h.length-1],remote:!0}).script];Eden.Selectors.cache[e]=n[0],r(n)},error:function(){r([])}})}else d.options&&d.options.local?Eden.Project.local&&Eden.Project.local[a]?$.get(Eden.Project.local[a].file,function(e){var t=[new Eden.AST(e,void 0,{name:a,remote:!0}).script];Eden.Selectors.cache[a]=t[0],o=t,d.filter(t).then(e=>{var t=Eden.Selectors.unique(e);r(t)})},"text"):r(o):Eden.DB.searchSelector(e,void 0===t?["outersource","path"]:t,function(e){if(void 0===t&&e.length>0){let t=n=>{if(n<e.length){var i;i=Eden.AST.parseStatement(e[n][0],{remote:!0});var s=Eden.AST.originFromDoxy(i.doxyComment);s.remote=!0,i.base.origin=s,i.id=s.id,Eden.Selectors.queryWithin([i],e[n][1],null,e=>{var r=e[0];r&&(o.push(r),d.options&&d.options.index&&i.addIndex()),t(++n)})}else r(o)};t(0)}else void 0===e||0==e.length?Eden.Project.local&&Eden.Project.local[a]?$.get(Eden.Project.local[a].file,function(e){var t=[new Eden.AST(e,void 0,{name:a,remote:!0}).script];Eden.Selectors.cache[a]=t[0],d.filter(t).then(e=>{var t=Eden.Selectors.unique(e);r(t)})},"text"):r(o):(o.push.apply(o,e),r(o))})}else r(o)};return d.options&&d.options.remote?h([]):!i||"script"!=i.type||d.options&&d.options.indexed?d.filter().then(e=>{h(e)}):d.filter(i.statements).then(e=>{e&&0!=e.length?h(e):d.filter().then(e=>{h(e)})}),n?n.returnvalue:void 0},Eden.Selectors.queryPromise=function(e,t,n){return new Promise((r,i)=>{Eden.Selectors.query(e,t,n,e=>{r(e)})})},Eden.Selectors.querySync=async function(e,t,n){const r=await Eden.Selectors.queryPromise(e,t,n);return console.log("Result",r),r},Eden.Selectors.execute=function(e,t){Eden.Selectors.query(e,void 0,{minimum:1},function(e){e&&e.length>0?function n(r){for(var i=e[r];i.parent;)i=i.parent;i.base.executeStatement(e[r],-1,EdenSymbol.localJSAgent,function(){++r<e.length?n(r):t&&t()})}(0):t&&t()})},Eden.Selectors.goto=function(e){Eden.Selectors.query(e,void 0,{minimum:1,noindex:!1},function(t){if(0==t.length)return!1;for(var n=[t[0]],r=t[0];r.parent;)n.push(r.parent),r=r.parent;for(var i=!1,s=0;s<n.length;s++)if(Eden.Fragment.emit("goto",[n[s],t[0]])){i=!0;break}if(!i){for(var o in console.log("No Goto Match, create view",e,t[0]),edenUI.activeDialogs)if("ScriptInput"==edenUI.activeDialogs[o]){var a=eden.root.lookup("view_"+o+"_tabs").value(),d="script"==t[0].type?e:Eden.Selectors.getID(t[0].parent);a.push(d),eden.root.lookup("view_"+o+"_tabs").assign(a,eden.root.scope,EdenSymbol.localJSAgent),Eden.Fragment.emit("goto",[void 0,t[0]]),eden.root.lookup("view_"+o+"_current").assign(a.length-1,eden.root.scope,EdenSymbol.localJSAgent),i=!0;break}if(!i){edenUI.createView("gotoscript","ScriptInput");a=[d="script"==t[0].type?e:Eden.Selectors.getID(t[0].parent)];eden.root.lookup("view_gotoscript_tabs").assign(a,eden.root.scope,EdenSymbol.localJSAgent),eden.root.lookup("view_gotoscript_current").assign(0,eden.root.scope,EdenSymbol.localJSAgent),i=!0}}return i})},Eden.Selectors.assign=function(e,t,n,r,i){Eden.Selectors.query(e,void 0,{minimum:1,noindex:!0,options:{self:r}},function(e){var r="string"==typeof t?t.split(","):t,s=Array.isArray(n)?n:[n];if(s.length<r.length)return console.error("Not enough values"),void(i&&i([]));for(var o=0;o<e.length;o++)for(var a=0;a<r.length;a++)switch(r[a]){case"source":if(e[o].parent){var d=e[o].parent;if("string"==typeof s[a]){var h=Eden.AST.parseStatement(s[a]);e[o].parent.replaceChild(e[o],h)}else void 0===s[a]&&e[o].parent.removeChild(e[o]);for(;d;)Eden.Fragment.emit("patch",[void 0,d]),d=d.parent}else console.error("Cannot replace outer source of root script");break;case"innersource":if("script"==e[o].type){h=Eden.AST.parseScript(s[a]);e[o].patchInner(h);for(d=e[o];d;)Eden.Fragment.emit("patch",[void 0,d]),d=d.parent}else console.error("Cannot replace innersource of non-script node");break;case"expression":if("definition"==e[o].type||"assignment"==e[o].type){h=Eden.AST.parseExpression(s[a]);e[o].expression=h,e[o].reset(),e[o].source=e[o].lvalue.source+("definition"==e[o].type?" is ":" = ")+s[a]+";";for(d=e[o];d;)Eden.Fragment.emit("patch",[void 0,d]),d=d.parent}else console.error("Cannot replace expression");break;case"locked":"script"==e[o].type?s[a]?0==e[o].lock&&(e[o].lock=1,Eden.Fragment.emit("lock",[void 0,e[o]])):(e[o].lock=0,Eden.Fragment.emit("unlock",[void 0,e[o]])):console.error("Cannot replace expression");break;case"title":case"comment":case"rawcomment":var c=new Eden.AST.DoxyComment(s[a],0,0),p=new Eden.AST.DummyStatement;p.setSource(0,0,"#! "+s[a].trim().replace(/\n/g,"\n# ")+"\n"),e[o].doxyComment?e[o].parent.replaceChild(e[o].previousSibling,p):e[o].parent.insertBefore(e[o],p),Eden.Index.remove(e[o]),e[o].setDoxyComment(c),Eden.Index.update(e[o]);break;case"tags":case"executed":break;case"enabled":"when"==e[o].type&&(e[o].enabled&&!s[a]?(eden.project.removeAgent(e[o]),e[o].enabled=!1):!e[o].enabled&&s[a]&&(eden.project.registerAgent(e[o]),e[o].enabled=!0));break;case"name":"script"==e[o].type?(Eden.Index.remove(e[o]),e[o].prefix="action "+s[a]+" {",e[o].name=s[a],Eden.Index.update(e[o])):"assignment"!=e[o].type&&"definition"!=e[o].type||(Eden.Index.remove(e[o]),e[o].lvalue.name=s[a],e[o].source=e[o].source.replace(/\w*/,s[a]),Eden.Index.update(e[o]));break;default:console.error("Cannot modify property '"+r[a]+"'")}i&&i(e)})},Eden.Selectors.append=function(e,t,n,r,i){Eden.Selectors.query(e,void 0,{minimum:1,noindex:!0,options:{self:r}},function(e){var r="string"==typeof t?t.split(","):t,s=Array.isArray(n)?n:[n];if(s.length<r.length)return console.error("Not enough values"),void(i&&i([]));for(var o=0;o<e.length;o++)for(var a=0;a<r.length;a++)switch(r[a]){case"source":if(e[o].parent){var d=e[o].parent;if("string"==typeof s[a]){var h=Eden.AST.parseStatement(s[a]);e[o].parent.insertBefore(e[o],h)}else s[a];for(;d;)Eden.Fragment.emit("patch",[void 0,d]),d=d.parent}else console.error("Cannot replace outer source of root script");break;case"innersource":if("script"==e[o].type){h=Eden.AST.parseScript(s[a]);for(var c=0;c<h.statements.length;c++)e[o].appendChild(h.statements[c]);for(d=e[o];d;)Eden.Fragment.emit("patch",[void 0,d]),d=d.parent}else console.error("Cannot replace innersource of non-script node");break;case"title":case"comment":case"rawcomment":var p=new Eden.AST.DoxyComment(s[a],0,0);e[o].doxyComment=p;var l=new Eden.AST.DummyStatement;l.setSource(s[a],0,0),e[o].parent.insertBefore(e[o],l);break;case"tags":case"name":"script"==e[o].type&&(Eden.Index.remove(e[o]),e[o].prefix="action "+s[a]+" {",e[o].name=s[a],Eden.Index.update(e[o]));break;default:console.error("Cannot modify property '"+r[a]+"'")}i&&i(e)})},Eden.Selectors.PropertyNode=function(e,t){if(this.type="property",this.name=e,this.param=t,this.compare=void 0,this.value=t,this.range=!1,this.isreg=!!t&&-1!=t.indexOf("*"),this.meta="string"==typeof e?"."==e.charAt(0)?Eden.Selectors.PropertyNode.attributes[e.substring(1)]:Eden.Selectors.PropertyNode.pseudo[e.substring(1)]:void 0,this.local=!!this.meta&&this.meta.local,t){switch(t.charAt(0)){case"<":this.compare="="==t.charAt(1)?"<=":"<";break;case">":this.compare="="==t.charAt(1)?">=":">";break;case"=":this.compare="=";break;case"!":this.compare="!="}if(this.compare)switch(this.compare){case"!":case"=":case">":case"<":this.value=t.substring(1);break;case">=":case"<=":this.value=t.substring(2)}if(this.isreg?this.value=Eden.Selectors.makeRegex(this.value):null!==t.match(/^[0-9]+\-[0-9]+$/)?this.range=!0:null!==t.match(/^[0-9]+$/)&&(this.value=parseInt(t)),".type"==this.name){switch(this.param){case"is":this.param="definition";break;case"assign":case"=":this.param="assignment";break;case"call":this.param="functioncall";break;case"proc":this.param="action";break;case"action":this.param="script";break;case"+=":case"-=":case"*=":case"/=":case"++":case"--":this.param="modify"}this.value=this.param}}},Eden.Selectors.PropertyNode.attributes={name:{local:!1,indexed:!0,rank:1},type:{local:!1,indexed:!1,rank:3},datatype:{local:!1,indexed:!1,rank:30},id:{local:!1,indexed:!0,rank:2},lines:{local:!1,indexed:!1,rank:3},depends:{local:!1,indexed:!1,rank:4},time:{local:!0,indexed:!1,rank:3},date:{local:!1,indexed:!1,rank:3},title:{local:!1,indexed:!1,rank:10},author:{local:!1,indexed:!1,rank:10},v:{local:!1,indexed:!1,rank:20},vid:{local:!1,indexed:!1,rank:20},version:{local:!1,indexed:!1,rank:20},source:{local:!0,indexed:!1,rank:50},comment:{local:!0,indexed:!1,rank:50}},Eden.Selectors.PropertyNode.pseudo={line:{local:!1,indexed:!1,rank:50},determines:{local:!0,indexed:!0,rank:10},first:{local:!1,indexed:!0,rank:5},last:{local:!1,indexed:!0,rank:5},unexecuted:{local:!0,indexed:!1,rank:3},executed:{local:!0,indexed:!1,rank:3},root:{local:!1,indexed:!0,rank:3},project:{local:!0,indexed:!0,rank:3},nth:{local:!1,indexed:!0,rank:5},value:{local:!0,indexed:!1,rank:50},matches:{local:!1,indexed:!1,rank:100},age:{local:!1,indexed:!1,rank:6},remote:{local:!0,indexed:!0,rank:20},not:{local:!1,indexed:!1,rank:100},active:{local:!0,indexed:!1,rank:10},me:{local:!1,indexed:!1,rank:20},listed:{local:!1,indexed:!1,rank:20},prev:{local:!0,indexed:!1,rank:20},next:{local:!0,indexed:!1,rank:20},this:{local:!0,indexed:!1,rank:20}},Eden.Selectors.PropertyNode.prototype.append=function(e){if(!e)return this;switch(e.type){case"property":case"tag":case"name":var t=new Eden.Selectors.IntersectionNode(this,e);return t.options=this.options,t;case"union":case"intersection":case"navigate":return e.prepend(this),e}return this},Eden.Selectors.PropertyNode.prototype.prepend=function(e){if(!e)return this;switch(e.type){case"property":case"tag":case"name":var t=new Eden.Selectors.IntersectionNode(e,this);return t.options=this.options,t;case"union":case"intersection":case"navigate":return e.append(this),e}return this},Eden.Selectors.PropertyNode.prototype.filter=function(e){return e?new Promise((t,n)=>{this._filter(e,t)}):this.construct()},Eden.Selectors.PropertyNode.prototype._filter=function(e,t){var n=this,r=this.value,i=this.name;if("number"==typeof this.name)return e&&e.length>=this.name?[e[this.name-1]]:[];switch(i){case".name":if(!r)return void t(e.filter(function(e){return void 0!==e.lvalue||void 0!==e.name}));var s=edenUI.regExpFromStr(r);return void t(e.filter(function(e){return e.lvalue&&s.test(e.lvalue.name)||e.name&&s.test(e.name)}));case".id":return void t(e.filter(function(e){return 0==e.id&&e.buildID(),void 0===e.parent&&e.base&&e.base.origin&&e.base.origin.id?e.base.origin.id==r:e.id==r}));case".type":if(!r)break;return void t(e.filter(function(e){return e.type==r}));case".datatype":return void t(e.filter(function(e){return e.expression&&Eden.Selectors.testType(e.expression)==r||e.expression&&"scope"==e.expression.type&&e.expression.range&&"list"==r}));case".lines":case":line":return void t(e);case".op":case".operator":case":pattern":case":determines":return void t(e);case".depends":return void t(e.filter(function(e){return("definition"==e.type||"when"==e.type)&&e.dependencies[r]}));case":active":return void t(e.filter(function(e){if("definition"==e.type||"assignment"==e.type){var t=eden.root.symbols[e.lvalue.name];return t&&(t.origin===e||t.origin&&t.origin.id==e.id)}return"when"==e.type&&e.enabled}));case":first":return void t(e.length>0?[e[0]]:[]);case":last":t(e.length>0?[e[e.length-1]]:[]);case":unexecuted":return void t(e.filter(function(e){return 0==e.executed}));case":executed":return void t(e.filter(function(e){return 1==e.executed}));case":root":return void t(e.filter(function(e){return void 0===e.parent}));case":project":return void t([eden.project.ast.script]);case":nth":return void t(e.filter(function(e){return e.parent&&Eden.Selectors.getChildren([e.parent],!1)[n.value-1]===e}));case":prev":return void t(e.map(function(e){let t=e.previousSibling;for(;t&&"dummy"==t.type;)t=t.previousSibling;return t}));case":next":return void t(e.map(function(e){let t=e.nextSibling;for(;t&&"dummy"==t.type;)t=t.nextSibling;return t}));case":value":return void t(e);case":":case":matches":var o=Eden.Selectors.parse(this.param);return void(o?o.filter(e).then(e=>t(e)):t([]));case".title":return this.isreg?void t(e.filter(function(e){if(!e.doxyComment)return!1;var t=e.doxyComment.getProperty("title");return t&&n.value.test(t)})):void t(e.filter(function(e){if(!e.doxyComment)return!1;var t=e.doxyComment.getProperty("title");return t&&t==n.value}));case".author":return void t(e);case".v":case".vid":case".version":return void t(e);case".source":return this.isreg?void t(e.filter(function(e){return n.value.test(e.getSource())})):void t(e.filter(function(e){return e.getSource()==n.value}));case".comment":return this.isreg?void t(e.filter(function(e){return e.doxyComment&&n.value.test(e.doxyComment.stripped())})):void t(e.filter(function(e){return e.doxyComment&&e.doxyComment.stripped()==n.value}));case":age":var a=generateTimeStamp(this.value),d=Date.now(),h=d-a;return console.log("AGE",a,d,h),void 0===this.compare||"<"==this.compare?void t(e.filter(function(e){return e.stamp>h})):void t(e.filter(function(e){return e.stamp<h}));case".time":case".date":return void t(e);case":remote":return void t(e.filter(function(e){for(var t=e;t.parent;)t=t.parent;return!(!t.base||!t.base.origin)&&1==t.base.origin.remote}));case":not":if(this.param)return void Eden.Selectors.parse(this.param).filter(e).then(n=>{t(e.filter(function(e){for(var t=0;t<n.length;t++)if(e===n[t])return!1;return!0}))});default:t([])}},Eden.Selectors.PropertyNode.prototype.construct=function(){var e;switch(this.name){case".type":e=Eden.Index.getByType(this.value);break;case".id":e=Eden.Index.getByID(this.value);break;case".v":case".vid":case".version":e=[];break;case".name":e=void 0===this.param?Eden.Index.getAllWithName():this.isreg?Eden.Index.getByNameRegex(this.value):Eden.Index.getByName(this.value);break;case":root":e=[eden.project.ast.script].concat(Object.keys(Eden.Selectors.cache).map(function(e){return Eden.Selectors.cache[e]}));break;case":remote":e=Object.keys(Eden.Selectors.cache).map(function(e){return Eden.Selectors.cache[e]});break;case":project":e=[eden.project.ast.script];break;case":this":e=this.options&&this.options.self?[this.options.self]:[];break;case":prev":e=(e=this.options&&this.options.self?[this.options.self]:[]).map(e=>{let t=e.previousSibling;for(;t&&"dummy"==t.type;)t=t.previousSibling;return t});break;case":next":e=(e=this.options&&this.options.self?[this.options.self]:[]).map(e=>{let t=e.nextSibling;for(;t&&"dummy"==t.type;)t=t.nextSibling;return t});break;default:e=Eden.Index.getAll()}return this.options&&this.options.history?Promise.resolve(e):Promise.resolve(e.filter(function(e){return e.executed>=0}))},Eden.Selectors.NameNode=function(e){this.type="name",this.name=e,this.options=void 0,this.isreg="/"==e.charAt(0)||-1!=e.indexOf("*"),this.local=!1},Eden.Selectors.NameNode.prototype.filter=function(e){return e?Promise.resolve(this._filter(e)):this.construct()},Eden.Selectors.NameNode.prototype._filter=function(e){var t=this.name;if(this.isreg){var n=Eden.Selectors.makeRegex(this.name);return e.filter(function(e){return e.lvalue&&n.test(e.lvalue.name)||e.name&&n.test(e.name)})}return e.filter(function(e){return e.lvalue&&e.lvalue.name==t||e.name&&e.name==t})},Eden.Selectors.NameNode.prototype.construct=function(){var e=[];if(this.isreg){var t=Eden.Selectors.makeRegex(this.name);e=Eden.Index.getByNameRegex(t)}else{e=Eden.Index.getByName(this.name);for(var n=this.name.toLowerCase().split(" "),r=Eden.Index.getByTag("#"+n[0]),i=1;i<n.length;i++)r=r.filter(function(e){return(!eden.project||e!==eden.project.ast.script)&&e.doxyComment&&e.doxyComment.hasTag("#"+n[i])});e.push.apply(e,r)}return this.options&&this.options.history?Promise.resolve(e):Promise.resolve(e.filter(function(e){return e.executed>=0}))},Eden.Selectors.NameNode.prototype.append=Eden.Selectors.PropertyNode.prototype.append,Eden.Selectors.NameNode.prototype.prepend=Eden.Selectors.PropertyNode.prototype.prepend,Eden.Selectors.TagNode=function(e){this.type="tag",this.tag=e,this.options=void 0,this.isreg=-1!=e.indexOf("*"),this.local=!1},Eden.Selectors.TagNode.prototype.filter=function(e){return new Promise((t,n)=>{e?t(this._filter(e)):e=this.construct().then(e=>{t(e)})})},Eden.Selectors.TagNode.prototype._filter=function(e){var t=this;return e.filter(function(e){return e.doxyComment&&e.doxyComment.hasTag(t.tag)})},Eden.Selectors.TagNode.prototype.construct=function(){return new Promise((e,t)=>{if(this.isreg){var n=Eden.Selectors.makeRegex(this.tag);stats=Eden.Index.getByTagRegex(n)}else stats=Eden.Index.getByTag(this.tag);this.options&&this.options.history?e(stats):e(stats.filter(function(e){return e.executed>=0}))})},Eden.Selectors.TagNode.prototype.append=Eden.Selectors.PropertyNode.prototype.append,Eden.Selectors.TagNode.prototype.prepend=Eden.Selectors.PropertyNode.prototype.prepend,Eden.Selectors.IntersectionNode=function(e,t){this.type="intersection",this.children=[e,t],this.local=!1},Eden.Selectors.IntersectionNode.prototype.append=function(e){if(!e)return this;switch(e.local&&(this.local=!0),e.type){case"navigate":return e.prepend(this),e}return this.children.push(e),this},Eden.Selectors.IntersectionNode.prototype.prepend=function(e){return e?(e.local&&(this.local=!0),this.children.splice(0,0,e),this):this},Eden.Selectors.IntersectionNode.prototype.filter=function(e,t){return new Promise((n,r)=>{let i=(e,r)=>{e<this.children.length?this.children[e].filter(r,t).then(t=>{i(++e,t)}):n(r||[])};i(0,e)})},Eden.Selectors.IntersectionNode.prototype.construct=function(){},Eden.Selectors.UnionNode=function(){this.type="union",this.children=[void 0],this.local=!1},Eden.Selectors.UnionNode.prototype.filter=function(e,t){return new Promise((n,r)=>{var i={};let s=r=>{r<this.children.length?this.children[r].filter(e,t).then(e=>{for(var t=0;t<e.length;t++)i[e[t].id]=e[t];s(++r)}):n(Object.keys(i).map(function(e){return i[e]}))};s(0)})},Eden.Selectors.UnionNode.prototype.construct=function(){},Eden.Selectors.UnionNode.prototype.prepend=function(e){return e?(e.local&&(this.local=!0),void 0===this.children[0]?(this.children[0]=e,this):(this.children[0]=this.children[0].prepend(e),this)):this},Eden.Selectors.UnionNode.prototype.append=function(e){return e?(e.local&&(this.local=!0),this.children.push(e),this):this},Eden.Selectors.NavigateNode=function(e,t){this.type="navigate",this.left=void 0,this.right=void 0,this.direction=e,this.deep=t,this.local=!1},Eden.Selectors.NavigateNode.prototype.append=function(e){return e?(e.local&&(this.local=!0),"union"==e.type?(e.prepend(this),e):(this.right?this.right.append(e):this.right=e,this)):this},Eden.Selectors.NavigateNode.prototype.prepend=function(e){return e?(e.local&&(this.local=!0),this.left?this.left=this.left.prepend(e):this.left=e,this):this},Eden.Selectors.NavigateNode.prototype.filter=function(e,t){return new Promise((n,r)=>{if(">"==this.direction){e||void 0!==this.left||(this.right?this.right.filter(e,t).then(e=>{n(e.filter(function(e){return void 0!==e.parent}))}):n(Eden.Index.getAll().filter(function(e){return void 0!==e.parent})));let r=e=>{this.right?this.right.filter(e,t).then(e=>{n(e)}):n(e)};void 0===this.left?r(Eden.Selectors.getChildren(e,this.deep)):this.left.filter(e,t).then(e=>{r(Eden.Selectors.getChildren(e,this.deep))})}else if("<"==this.direction){if(!e&&void 0===this.left){if(this.right)return this.right.filter(e,t).then(e=>{n(e.filter(function(e){return"script"==e.type||"when"==e.type||"if"==e.type||"for"==e.type}))});n(Eden.Index.getAll().filter(function(e){return"script"==e.type||"when"==e.type||"if"==e.type||"for"==e.type}))}let r=e=>{if(this.deep){for(var r=[],i=0;i<e.length;i++)for(var s=e[i];s.parent;)"script"==s.parent.type&&s.parent.parent&&"script"!=s.parent.parent.type?"codeblock"==s.parent.parent.type?(s=s.parent.parent.parent,r.push(s)):(s=s.parent.parent,r.push(s)):"codeblock"==s.parent.type?(s=s.parent.parent,r.push(s)):(s=s.parent,r.push(s));this.right?this.right.filter(r,t).then(e=>{n(Eden.Selectors.unique(e))}):n(Eden.Selectors.unique(r))}else{for(r=[],i=0;i<e.length;i++)e[i].parent&&("script"==e[i].parent.type&&e[i].parent.parent&&"script"!=e[i].parent.parent.type?"codeblock"==e[i].parent.parent.type?r.push(e[i].parent.parent.parent):r.push(e[i].parent.parent):"codeblock"==e[i].parent.type?r.push(e[i].parent.parent):r.push(e[i].parent));this.right?this.right.filter(r,t).then(e=>{n(Eden.Selectors.unique(e))}):n(Eden.Selectors.unique(r))}};void 0===this.left?r(e.filter(function(e){return"script"==e.type||"when"==e.type||"if"==e.type||"for"==e.type})):this.left.filter(e,t).then(e=>{r(e)})}})},Eden.Selectors.NavigateNode.prototype.construct=function(){return new Promise((e,t)=>{e([])})},Eden.SyntaxWarning=function(e,t,n,r){this.type="syntax",this.context=e,this.node=t,this.warnno=n,this.extra=r,this.token=e.token,this.prevtoken=e.previous,this.line=e.stream.prevline,this.position=e.stream.position,this.prevposition=e.stream.prevposition},Eden.SyntaxWarning.UNKNOWN=0,Eden.SyntaxWarning.DEPRECATED=1,Eden.SyntaxWarning.NESTEDWHEN=2,Eden.SyntaxWarning.DEFINWHEN=3,Eden.SyntaxWarning.EXPRESSIONLIT=4,Eden.SyntaxWarning.MISSINGSYNC=5,Eden.SyntaxWarning.prototype.messageText=function(){var e;switch(this.warnno){case Eden.SyntaxWarning.DEPRECATED:e="Deprecation: ";break;case Eden.SyntaxWarning.NESTEDWHEN:e='"when"\'s should not be nested';break;case Eden.SyntaxWarning.DEFINWHEN:e='"when"\'s should not contain definitions';break;case Eden.SyntaxWarning.EXPRESSIONLIT:e="Keep literals in separate observables";break;case Eden.SyntaxWarning.USEOFWHILE:e="Try and use 'for', 'when' or 'with' to achieve looping";break;default:e="Warning: "}return e+=this.extra},Eden.RuntimeWarning=function(e,t,n){this.type="runtime",this.node=e,this.warnno=t,this.extra=n,this.line=-1},Eden.RuntimeWarning.UNKNOWN=0,Eden.RuntimeWarning.EMPTYDO=1,Eden.RuntimeWarning.UNDEFINED=2,Eden.RuntimeWarning.AMBIGUITY=3,Eden.RuntimeWarning.prototype.messageText=function(){var e;switch(this.warnno){case Eden.RuntimeWarning.EMPTYDO:e="Empty result for: ";break;case Eden.RuntimeWarning.UNDEFINED:e="Expression is undefined: ";break;default:e="Warning: "}return void 0!==this.extra&&(e+=this.extra),e},Eden.Index={},Eden.Index.id_index={},Eden.Index.name_index={},Eden.Index.tag_index={},Eden.Index.type_index={},Eden.Index.idExists=function(e){return Eden.Index.id_index.hasOwnProperty(e)},Eden.Index.getByID=function(e){var t=Eden.Index.id_index[e];return t||[]},Eden.Index.getAll=function(){var e=[];return Object.values?e.concat.apply(e,Object.values(Eden.Index.id_index)):e.concat.apply(e,Object.keys(Eden.Index.id_index).map(function(e){return Eden.Index.id_index[e]}))},Eden.Index.getAllWithName=function(){var e=[];for(var t in Eden.Index.name_index)e.push.apply(e,Eden.Index.name_index[t].map(function(e){return Eden.Index.id_index[e]}));return e},Eden.Index.getByName=function(e){var t=[];return Eden.Index.name_index[e]?t.concat.apply(t,Eden.Index.name_index[e].map(function(e){return Eden.Index.id_index[e]})):t},Eden.Index.getByNameRegex=function(e){var t=[];for(var n in Eden.Index.name_index)e.test(n)&&(t=t.concat.apply(t,Eden.Index.name_index[n].map(function(e){return Eden.Index.id_index[e]})));return t},Eden.Index.getByType=function(e){var t=[];return Eden.Index.type_index[e]?t.concat.apply(t,Object.keys(Eden.Index.type_index[e]).map(function(e){return Eden.Index.id_index[e]})):t},Eden.Index.getByTag=function(e){var t=[];return Eden.Index.tag_index[e]?t.concat.apply(t,Eden.Index.tag_index[e].map(function(e){return Eden.Index.id_index[e]})):t},Eden.Index.getByTagRegex=function(e){var t=[];for(var n in Eden.Index.tag_index)e.test(n)&&(t=t.concat.apply(t,Eden.Index.tag_index[n].map(function(e){return Eden.Index.id_index[e]})));return t},Eden.Index.remove=function(e){var t=Eden.Index.id_index[e.id];if(t){for(var n=0;n<t.length;n++)t[n]===e&&t.splice(n,1);if(0==t.length){if(delete Eden.Index.id_index[e.id],delete Eden.Index.type_index[e.type][e.id],e.name&&"do"!=e.type||e.lvalue){var r=e.name?e.name:e.lvalue.name;if(void 0===Eden.Index.name_index[r])return;(s=Eden.Index.name_index[r].indexOf(e.id))>=0&&Eden.Index.name_index[r].splice(s,1)}if(e.tags){var i=e.tags;for(n=0;n<i.length;n++){var s;if(void 0!==Eden.Index.tag_index[i[n]])(s=Eden.Index.tag_index[i[n]].indexOf(e.id))>=0&&Eden.Index.tag_index[i[n]].splice(s,1)}}}}},Eden.Index.update=function(e){if(void 0===Eden.Index.id_index[e.id]&&(Eden.Index.id_index[e.id]=[]),Eden.Index.id_index[e.id].push(e),1==Eden.Index.id_index[e.id].length){if(void 0===Eden.Index.type_index[e.type]&&(Eden.Index.type_index[e.type]={}),Eden.Index.type_index[e.type][e.id]=!0,e.name&&"do"!=e.type||e.lvalue){var t=e.name?e.name:e.lvalue.name;void 0===Eden.Index.name_index[t]&&(Eden.Index.name_index[t]=[]),-1==Eden.Index.name_index[t].indexOf(e.id)&&Eden.Index.name_index[t].push(e.id)}if(e.tags)for(var n=e.tags,r=0;r<n.length;r++)void 0===Eden.Index.tag_index[n[r]]&&(Eden.Index.tag_index[n[r]]=[]),-1==Eden.Index.tag_index[n[r]].indexOf(e.id)&&Eden.Index.tag_index[n[r]].push(e.id)}},Eden.AST=function(e,t,n,r){this.stream=void 0!==e?new EdenStream(e):void 0,this.data=new EdenSyntaxData,this.token="INVALID",this.previous="INVALID",this.src="input",this.parent=void 0,this.scripts={},this.definitions={},this.origin=n,this.lastposition=0,this.lastline=0,this.errors=[],this.warnings=[],this.whens=[],this.options=r,this.lastresult=void 0,this.depth=0,this.localStatus=!1,this.isdynamic=!1,n||console.error("NO ORIGIN",e),this.lastDoxyComment=[],this.mainDoxyComment=void 0,this.parentDoxy=void 0,this.lastStatement=void 0,this.lastStatementEndline=-1,this.stream&&(this.stream.data=this.data),this.stamp=Date.now(),this.strict=r&&r.strict,r&&r.noparse||(this.next(),this.script=this.pSCRIPT(),this.script.base=this,this.script.name=n.name,n.id&&(this.script.id=n.id),this.script.setSource(0,e.length,e),this.script.setDoxyComment(this.doxyFromOrigin()),this.options&&this.options.noindex?0==this.script.id&&this.script.buildID():this.script.addIndex(),0==this.errors.length?this.errors=this.script.errors:this.errors.push.apply(this.errors,this.script.errors))},Eden.AST.fnEdenASTerror=function(e){this.errors.unshift(e)},Eden.AST.fnEdenASTleft=function(e){this.l=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors),e&&e.warning&&(this.warning=e.warning)},Eden.AST.debug=!1,Eden.AST.debugstep=!1,Eden.AST.debugstep_cb=void 0,Eden.AST.debugspeed=500,Eden.AST.debugbreakpoint=void 0,Eden.AST.debugbreakpoint_cb=void 0,Eden.AST.debug_begin_cb=void 0,Eden.AST.debug_end_cb=void 0,Eden.AST.fromNode=function(e,t){return new Promise((n,r)=>{var i=new Eden.AST(e.getInnerSource(),void 0,t,{noindex:!0,noparse:!0});i.script=e,i.errors=e.errors,Eden.Selectors.queryWithin([e],">>.type(when)",null,e=>{i.whens=e,n(i)})})},Eden.AST.prototype.doxyFromOrigin=function(){var e=this.origin.name;if(this.origin.title&&(e+="\n * @title "+this.origin.title),this.origin.author&&(e+="\n * @author "+this.origin.author),this.origin.id&&(e+="\n * @id "+this.origin.id),this.origin.saveID&&(e+="\n * @version "+this.origin.vid),this.origin.tags&&this.origin.tags.length>0){e+="\n *";for(var t=0;t<this.origin.tags.length;t++)e+=" #"+this.origin.tags[t]}return new Eden.AST.DoxyComment(e)},Eden.AST.originFromDoxy=function(e){var t={};if(void 0===e)return t;var n=e.getControls();return n["@title"]&&(t.title=n["@title"][0]),n["@author"]&&(t.author=n["@author"][0]),n["@id"]&&(t.id=n["@id"][0]),n["@version"]&&(t.vid=n["@version"][0]),t},Eden.AST.prototype.destroy=function(){for(var e=Eden.Selectors.queryWithin([this.script],">>"),t=0;t<e.length;t++)Eden.Index.remove(e[t]);this.script=void 0,this.stream=void 0,this.lines=void 0,this.scripts=void 0;for(t=0;t<this.whens.length;t++)this.whens[t].enabled&&eden.project.removeAgent(this.whens[t])},Eden.AST.prototype.getActionByName=function(e){var t;if(-1==e.indexOf("/")&&void 0===(t=this.scripts[e]))for(var n=0;n<this.imports.length;n++)if(this.imports[n]&&this.imports[n].ast&&(t=this.imports[n].ast.getActionByName(e)))return t;return t},Eden.AST.prototype.generate=function(){return this.script.generate()},Eden.AST.prototype.execute=function(e,t){this.executeStatement(this.script,0,e,t)},Eden.AST.prototype.clearExecutedState=function(){for(var e=0;e<this.lines.length;e++)this.lines[e]&&this.lines[e].executed>0&&(this.lines[e].executed=0)},Eden.AST.prototype.executeLine=function(e,t,n){var r,i=e;void 0!==(r=-1==e?this.script:this.lines[i])&&(r=this.getBase(r),this.executeStatement(r,i,t,n))},Eden.AST.parseStatement=function(e,t){var n=new Eden.AST(e,void 0,t||{},{noparse:!0,noindex:!0});n.next();var r=n.pSTATEMENT();void 0===r&&(r=new Eden.AST.DummyStatement,console.error("Invalid statement: ",e)),r.base=n,r.setSource(0,e.length,e),r.stamp=n.stamp;var i=r.prefix?(r.prefix+r.postfix).match("\n"):e.match("\n");return r.numlines=null===i?0:i.length,r},Eden.AST.parseScript=function(e,t){var n=new Eden.AST(e,void 0,t||{},{noparse:!0,noindex:!0});n.next();var r=n.pSCRIPT();r.base=n,r.setSource(0,e.length,e),r.stamp=n.stamp;var i=e.match("\n");return r.numlines=null===i?0:i.length,r},Eden.AST.parseExpression=function(e){var t=new Eden.AST(e,void 0,{},{noparse:!0,noindex:!0});return t.next(),t.pEXPRESSION()},Eden.AST.registerStatement=function(e){e.prototype.getOrigin=Eden.AST.BaseStatement.getOrigin,e.prototype.hasErrors=Eden.AST.BaseStatement.hasErrors,e.prototype.setSource=Eden.AST.BaseStatement.setSource,e.prototype.getSource=Eden.AST.BaseStatement.getSource,e.prototype.getOuterSource=Eden.AST.BaseStatement.getOuterSource,e.prototype.getNumberOfLines=Eden.AST.BaseStatement.getNumberOfLines,e.prototype.getStartLine=Eden.AST.BaseStatement.getStartLine,e.prototype.getEndLine=Eden.AST.BaseStatement.getEndLine,e.prototype.getRange=Eden.AST.BaseStatement.getRange,e.prototype.error=Eden.AST.fnEdenASTerror,e.prototype.addIndex=Eden.AST.BaseStatement.addIndex,e.prototype.removeIndex=Eden.AST.BaseStatement.removeIndex,e.prototype.destroy=Eden.AST.BaseStatement.destroy,e.prototype.buildID=Eden.AST.BaseStatement.buildID,e.prototype.setDoxyComment=Eden.AST.BaseStatement.setDoxyComment},Eden.AST.registerScript=function(e){Eden.AST.registerStatement(e),e.prototype.getStatementByLine=Eden.AST.BaseScript.getStatementByLine,e.prototype.getRelativeLine=Eden.AST.BaseScript.getRelativeLine,e.prototype.getNumberOfLines=Eden.AST.BaseScript.getNumberOfLines,e.prototype.getNumberOfInnerLines=Eden.AST.BaseScript.getNumberOfInnerLines,e.prototype.append=Eden.AST.BaseScript.append,e.prototype.appendChild=Eden.AST.BaseScript.appendChild,e.prototype.removeChild=Eden.AST.BaseScript.removeChild,e.prototype.insertBefore=Eden.AST.BaseScript.insertBefore,e.prototype.insertAfter=Eden.AST.BaseScript.insertAfter,e.prototype.replaceChild=Eden.AST.BaseScript.replaceChild,e.prototype.addIndex=Eden.AST.BaseScript.addIndex,e.prototype.addIndexReverse=Eden.AST.BaseScript.addIndexReverse,e.prototype.removeIndex=Eden.AST.BaseScript.removeIndex,e.prototype.destroy=Eden.AST.BaseScript.destroy,e.prototype.buildID=Eden.AST.BaseScript.buildID},Eden.AST.registerContext=function(e){Eden.AST.registerScript(e)},Eden.AST.prototype.getBase=function(e,t){void 0===t&&console.error("Undefined context in getBase");for(var n=e;n&&n.parent&&n.parent!==t;)n=n.parent;return n},Eden.AST.prototype.getBlockLines=function(e,t){for(var n=e,r=this.getBase(this.lines[n],t);n>0&&this.lines[n-1]&&this.getBase(this.lines[n-1],t)==r;)n--;for(var i=n;n<this.lines.length-1&&this.lines[n+1]&&(this.lines[n+1]===r||this.lines[n+1].parent!==t);)n++;return[i,n]},Eden.AST.prototype.getSource=function(e){return this.script.getSource()},Eden.AST.prototype.getRoot=function(){return this.script},Eden.AST.prototype.getErrors=function(){return this.script.errors},Eden.AST.prototype.hasErrors=function(){return this.script.errors.length>0},Eden.AST.prototype.prettyPrint=function(){var e="";if(this.script.errors.length>0)for(var t=0;t<this.script.errors.length;t++)e=e+this.script.errors[t].prettyPrint()+"\n\n";else e=JSON.stringify(this.script,function(e,t){if("errors"!=e)return"parent"==e?!!t||void 0:t},"    ");return e},Eden.AST.prototype.next=function(){this.previous=this.token,this.lastposition=this.stream.position,this.lastline=this.stream.line,this.token=this.stream.readToken();for(var e=this.stream.prevline;;)if("/*"==this.token){var t=1,n=!1,r=this.stream.position-2,i=this.stream.line;for(42==this.stream.peek()&&(n=!0);this.stream.valid()&&("*/"!=this.token||t>0);)this.token=this.stream.readToken(),"/*"==this.token?t++:"*/"==this.token&&t--;if("*/"!=this.token){var s=new Eden.SyntaxError(this,Eden.SyntaxError.BLOCKCOMMENT);s.line=i,this.errors.push(s)}if(n){var o=new Eden.AST.DoxyComment(this.stream.code.substring(r+3,this.stream.position-2).trim(),i,this.stream.line);this.lastDoxyComment.push(o),o.parent=this.parentDoxy,o.content.endsWith("@{")?this.parentDoxy=o:o.content.startsWith("@}")&&this.parentDoxy&&(this.parentDoxy=this.parentDoxy.parent)}this.token=this.stream.readToken()}else{if("${{"!=this.token)break;r=this.stream.position,i=this.stream.line;for(this.data.line=i;this.stream.valid()&&"}}$"!=this.token;)this.token=this.stream.readToken();this.data.value=this.stream.code.substring(r,this.stream.position-3),this.token="JAVASCRIPT",this.stream.prevposition=r-3}this.stream.prevline=e},Eden.AST.prototype.peekNext=function(e){var t;for(this.stream.data={value:""},this.stream.pushPosition();e>0;)t=this.stream.readToken(),e--;return this.stream.popPosition(),this.stream.data=this.data,t},Eden.AST.BaseStatement=function(){this.start=0,this.end=0,this.parent=void 0,this.errors=[],this.warning=void 0,this.executed=0,this.numlines=-1,this.doxyComment=void 0,this.lock=0,this.source=void 0,this.id=0,this.stamp=0,this.nextSibling=void 0,this.previousSibling=void 0,this.tags=void 0,this.local=!1,this.line=-1},Eden.AST.BaseStatement.setDoxyComment=function(e){this.doxyComment=e,e&&(void 0===this.tags?this.tags=e.getHashTags():this.tags=this.tags.concat(e.getHashTags()),e.hasTag("#library")&&("function"==this.type||"action"==this.type?edenFunctions[this.name]=!0:"definition"==this.type&&(edenFunctions[this.lvalue.name]=!0)))},Eden.AST.BaseStatement.buildID=function(){var e=0,t=this.source;this.doxyComment&&(t=this.doxyComment.content+t);for(var n=t.length,r=0;r<n;r++)e=(e<<5)-e+t.charCodeAt(r),e&=e;this.name&&"do"!=this.type?this.id=this.name+"@"+e:this.lvalue?this.id=this.lvalue.name+"@"+e:this.id=this.type+"@"+e;for(var i=this.parent;i&&!i.name;)i=i.parent;i&&i.name&&(this.id=this.id+i.name)},Eden.AST.BaseStatement.addIndex=function(){if("dummy"==this.type&&console.trace("ADDING DUMMY INDEX"),this.buildID(),this.statements)for(var e=0;e<this.statements.length;e++)"dummy"!=this.statements[e].type&&this.statements[e].addIndex();Eden.Index.update(this)},Eden.AST.BaseStatement.removeIndex=function(){if(this.statements)for(var e=0;e<this.statements.length;e++)"dummy"!=this.statements[e].type&&this.statements[e].removeIndex();Eden.Index.remove(this)},Eden.AST.BaseStatement.destroy=function(){if(this.executed<1&&Eden.Index.remove(this),this.parent=void 0,this.nextSibling=void 0,this.previousSibling=void 0,this.statements)for(var e=0;e<this.statements.length;e++)"dummy"!=this.statements[e].type&&this.statements[e].destroy();this.executed=-1},Eden.AST.BaseStatement.hasErrors=function(){return this.errors.length>0},Eden.AST.BaseStatement.getNumberOfLines=function(){return this.numlines},Eden.AST.BaseStatement.getNumberOfInnerLines=function(){return this.numlines},Eden.AST.BaseStatement.getStartLine=function(e){return this.parent?this.parent.getRelativeLine(this,e):-1},Eden.AST.BaseStatement.getEndLine=function(e){return this.getStartLine(e)+this.getNumberOfLines()},Eden.AST.BaseStatement.getRange=function(e){var t=this.getStartLine(e);return[t,t+this.getNumberOfLines()]},Eden.AST.BaseStatement.setSource=function(e,t,n){this.start=e,this.end=t,this.source=n},Eden.AST.BaseStatement.getSource=function(){return this.source},Eden.AST.BaseStatement.getOuterSource=function(){var e=this.getSource();void 0===this.parent&&(e="action "+this.name+"{"+e+"}"),this.doxyComment&&(e="/** "+this.doxyComment.content+" */\n"+e);for(var t=this.parent;t;)"script"==t.type?(e=t.name?"action "+t.name+" {\n"+e+"\n}":"{\n"+e+"\n}",t.doxyComment&&(e="/** "+t.doxyComment.content+" */\n"+e),t=t.parent):t=void 0;return e},Eden.AST.BaseStatement.getOrigin=function(){for(var e=this;e.parent;)e=e.parent;return e.base?e.base.origin:void 0},Eden.AST.BaseScript=function(){Eden.AST.BaseStatement.apply(this),this.statements=[],this.parameters=void 0,this.locals=void 0,this.indexed=!1},Eden.AST.BaseScript.appendChild=function(e){this.statements.push(e),this.statements.length>1&&(e.previousSibling=this.statements[this.statements.length-2],this.statements[this.statements.length-2].nextSibling=e),e.parent=this,this.indexed&&0!=this.id&&console.log("INVALIDATE ID",this),"dummy"!=e.type&&this.indexed&&e.addIndex(),e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.BaseScript.append=Eden.AST.BaseScript.appendChild,Eden.AST.BaseScript.insertAfter=function(e,t){var n;for(n=0;n<this.statements.length&&this.statements[n]!==e;n++);if(n+1<this.statements.length)t.previousSibling=this.statements[n],t.nextSibling=this.statements[n+1],this.statements[n].nextSibling=t,this.statements[n+1].previousSibling=t,this.statements.splice(n+1,0,t);else{if(!(n<this.statements.length))return;t.previousSibling=this.statements[n],t.nextSibling=void 0,this.statements[n].nextSibling=t,this.statements.push(t)}t.parent=this,"dummy"!=t.type&&this.indexed&&t.addIndex(),t.errors.length>0&&this.errors.push.apply(this.errors,t.errors),this.indexed&&0!=this.id&&console.log("INVALIDATE ID",this)},Eden.AST.BaseScript.insertBefore=function(e,t){var n;for(n=0;n<this.statements.length&&this.statements[n]!==e;n++);n<this.statements.length?(n>0?(t.nextSibling=this.statements[n],t.previousSibling=this.statements[n-1],this.statements[n].previousSibling=t,this.statements[n-1].nextSibling=t):(t.nextSibling=this.statements[n],this.statements[n].previousSibling=t),this.statements.splice(n,0,t),t.parent=this,"dummy"!=t.type&&this.indexed&&t.addIndex(),t.errors.length>0&&this.errors.push.apply(this.errors,t.errors)):eden.emit("error",[new Eden.RuntimeError(void 0,Eden.RuntimeError.NOCHILD,this,"Statement is not a child when using insertBefore")])},Eden.AST.BaseScript.removeChild=function(e){var t;for(t=0;t<this.statements.length&&this.statements[t]!==e;t++);t<this.statements.length?(this.statements.splice(t,1),e.nextSibling&&(e.nextSibling.previousSibling=e.previousSibling),e.previousSibling&&(e.previousSibling.nextSibling=e.nextSibling),e.destroy()):eden.emit("error",[new Eden.RuntimeError(void 0,Eden.RuntimeError.NOCHILD,this,"Statement is not a child when using removeChild")])},Eden.AST.BaseScript.replaceChild=function(e,t){var n;if("number"==typeof e)n=e;else{var r;for(r=0;r<this.statements.length&&this.statements[r]!==e;r++);if(r>=this.statements.length)return void eden.emit("error",[new Eden.RuntimeError(void 0,Eden.RuntimeError.NOCHILD,this,"Statement is not a child when using replaceChild")]);n=r}t.nextSibling=this.statements[n].nextSibling,t.nextSibling&&(t.nextSibling.previousSibling=t),t.previousSibling=this.statements[n].previousSibling,t.previousSibling&&(t.previousSibling.nextSibling=t),this.statements[n].destroy(),this.statements[n]=t,t.parent=this,"dummy"!=t.type&&this.indexed&&t.addIndex(),this.indexed&&0!=this.id&&console.log("INVALIDATE ID",this)},Eden.AST.BaseScript.destroy=function(){this.executed<1&&Eden.Index.remove(this);for(var e=0;e<this.statements.length;e++)this.statements[e].destroy();this.executed=-1,this.statements=void 0,this.base=void 0,this.parent=void 0,this.nextSibling=void 0,this.previousSibling=void 0},Eden.AST.BaseScript.addIndex=function(){if(!this.indexed){0==this.id&&this.buildID();for(var e=0;e<this.statements.length;e++)"dummy"!=this.statements[e].type&&this.statements[e].addIndex();this.indexed=!0,Eden.Index.update(this)}},Eden.AST.BaseScript.addIndexReverse=function(){this.indexed||(0==this.id&&this.buildID(),this.parent&&this.parent.addIndexReverse(),this.indexed=!0,Eden.Index.update(this))},Eden.AST.BaseScript.removeIndex=function(){if(this.indexed){for(var e=0;e<this.statements.length;e++)"dummy"!=this.statements[e].type&&this.statements[e].removeIndex();this.indexed=!1,Eden.Index.remove(this)}},Eden.AST.BaseScript.buildID=function(){for(var e=0,t=this.getSource(),n=t.length,r=0;r<n;r++)e=(e<<5)-e+t.charCodeAt(r),e&=e;this.id=this.type+"@"+e},Eden.AST.BaseScript.getStatementByLine=function(e,t){var n=0;if(t&&this.parent&&(n=this.parent.getRelativeLine(this,t)),!(n>e)&&void 0!==this.statements)for(var r=0;r<this.statements.length;r++){var i=this.statements[r].getNumberOfLines();if(e>=n&&e<=n+i&&"dummy"!=this.statements[r].type)return this.statements[r];n+=i}},Eden.AST.BaseScript.getRelativeLine=function(e,t){var n=0;t&&t!==this&&this.parent&&(n=this.parent.getRelativeLine(this,t));for(var r=0;r<this.statements.length;r++){if(this.statements[r]===e)return n;n+=this.statements[r].getNumberOfLines()}return-1},Eden.AST.BaseScript.getNumberOfLines=function(){void 0===this.statements&&console.error("No Statements",this);for(var e=this.numlines,t=0;t<this.statements.length;t++)e+=this.statements[t].getNumberOfLines();return e},Eden.AST.BaseScript.getNumberOfInnerLines=function(){void 0===this.statements&&console.error("No Statements",this);for(var e=0,t=0;t<this.statements.length;t++)e+=this.statements[t].getNumberOfLines();return e},Eden.AST.BaseContext=function(){Eden.AST.BaseScript.apply(this),this.scopes=[],this.backtickCount=0,this.locals=void 0,this.params=void 0,this.dependencies={},this.isconstant=!0,this.isdynamic=!1,this.dynamic_source=""},Eden.AST.Append=function(){this.type="append",Eden.AST.BaseStatement.apply(this),this.destination=void 0,this.index=void 0},Eden.AST.Append.prototype.setDest=function(e){this.destination=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Append.prototype.setIndex=function(e){this.index=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Append.prototype.generate=function(e,t){var n=this.index.generate(e,t,{bound:!1,usevar:"scriptexpr"==e.type}),r=this.destination.generate(e,t);return this.destination.islocal?r+".push("+n+");\n":t+".mutate("+r+", function(s) { scope.lookup(s.name).value.push("+n+"); }, this);"},Eden.AST.Append.prototype.execute=function(e,t,n,r){this.executed=1;var i=this.index.execute(e,t,n);i instanceof BoundValue&&(i=i.value);var s=eden.root.lookup(this.destination.name),o=s.value(n);o.push(i),s.assign(o,n,this)},Eden.AST.registerStatement(Eden.AST.Append),Eden.AST.Shift=function(){this.type="shift",Eden.AST.BaseStatement.apply(this),this.destination=void 0},Eden.AST.Shift.prototype.setDest=function(e){this.destination=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Shift.prototype.generate=function(e,t){var n=this.destination.generate(e,t);return this.destination.islocal?n+".shift();\n":t+".mutate("+n+", function(s) { scope.lookup(s.name).value.shift(); }, this);"},Eden.AST.Shift.prototype.execute=function(e,t,n,r){this.executed=1;var i=eden.root.lookup(this.destination.name),s=i.value(n);s.shift(),i.assign(s,n,this)},Eden.AST.registerStatement(Eden.AST.Shift),Eden.AST.Assignment=function(e){this.type="assignment",Eden.AST.BaseContext.apply(this),this.errors=e?e.errors:[],e&&e.warning&&(this.warning=e.warning),this.expression=e,this.lvalue=void 0,this.compiled=void 0,this.dirty=!1,this.value=void 0,this.compiled=void 0},Eden.AST.Assignment.prototype.reset=function(){this.executed=0,this.dirty=!0},Eden.AST.Assignment.prototype.left=function(e){this.lvalue=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Assignment.prototype.generate=function(e,t){var n=this.lvalue.generate(e,t);return this.lvalue.islocal?(n+=" = ",n+=this.expression.generate(e,t,{bound:!1,usevar:"scriptexpr"==e.type}),n+=";\n"):this.lvalue.hasListIndices()?(n=t+".listAssign("+n+",",n+=this.expression.generate(e,t,{bound:!1,usevar:"scriptexpr"==e.type}),n+=", EdenSymbol.localJSAgent, false, ",n+=this.lvalue.generateCompList(e,t),n+=");\n"):(n=t+".assign("+n+",",n+=this.expression.generate(e,t,{bound:!1,usevar:"scriptexpr"==e.type}),n+=", EdenSymbol.localJSAgent);\n")},Eden.AST.Assignment.prototype.compile=function(ctx){if(!this.compiled||this.dirty){this.dirty=!1,ctx?ctx.scopes=this.scopes:ctx=this;var rhs="(function(context,scope,cache,ctx) { \n",express=this.expression.generate(ctx,"scope",{bound:!0});if(ctx&&ctx.dirty&&(ctx.dirty=!1,this.dirty=!0),this.scopes.length>0){rhs+="\tvar _scopes = [];\n";for(var i=0;i<this.scopes.length;i++)rhs+="\t_scopes.push("+this.scopes[i],rhs+=");\n";rhs+="for(var i=0; i<_scopes.length; i++) _scopes[i].rebuild();\n"}rhs+="var result = "+express+";",rhs+="if (cache) cache.scope = result.scope;",rhs+="return result.value;",rhs+="})",this.compiled=eval(rhs)}},Eden.AST.Assignment.prototype.execute=function(e,t,n,r){if(void 0!==this.expression){this.executed=1,this.compile(e),this.doxyComment&&eden.updateDictionary(this.lvalue.name,this.doxyComment);try{var i,s=this.lvalue.getSymbol(e,t,n);if(this.lvalue.hasListIndices()){i=this.compiled.call(s,eden.root,n,s.cache,e);var o=this.lvalue.executeCompList(e,n);s.listAssign(i,n,this,!1,o)}else i=this.compiled.call(s,eden.root,n,s.cache,e),s.assign(i,this.lvalue.islocal?void 0:n,this);void 0===i&&(this.warning=new Eden.RuntimeWarning(this,Eden.RuntimeWarning.UNDEFINED,this.source.split("=")[1].trim()))}catch(e){var a,d=r;e instanceof Eden.RuntimeError?((a=e).context=t,a.statement=this):a=/[0-9][0-9]*/.test(e.message)?new Eden.RuntimeError(t,parseInt(e.message),this,e.message):new Eden.RuntimeError(t,0,this,e),a.line=this.line,this.errors.push(a),d?eden.emit("error",[d,a]):console.log(a.prettyPrint())}}},Eden.AST.registerStatement(Eden.AST.Assignment),Eden.AST.After=function(){this.type="after",Eden.AST.BaseStatement.apply(this),this.expression=void 0,this.statement=void 0},Eden.AST.After.prototype.setExpression=function(e){this.expression=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.After.prototype.setStatement=function(e){this.statement=e,e&&e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.After.prototype.generate=function(e,t){return void 0===t&&(t="eden.root.scope"),"setTimeout("+("(function() {"+this.statement.generate(e,t,{bound:!1})+"})")+", "+this.expression.generate(e,t,{bound:!1})+");\n"},Eden.AST.After.prototype.execute=function(ctx,base,scope){var statement="(function() { var scope = eden.root.scope;\n"+this.statement.generate(ctx,"root.scope")+"})";setTimeout(eval(statement),this.expression.execute(ctx,base,scope))},Eden.AST.registerStatement(Eden.AST.After),Eden.AST.BinaryOp=function(e){this.type="binaryop",this.op=e,this.errors=[],this.l=void 0,this.r=void 0,this.warning=void 0,"&"==this.op||"and"==this.op?this.op="&&":"|"!=this.op&&"or"!=this.op||(this.op="||")},Eden.AST.BinaryOp.prototype.left=Eden.AST.fnEdenASTleft,Eden.AST.BinaryOp.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.BinaryOp.prototype.setRight=function(e){this.r=e,this.errors.push.apply(this.errors,e.errors),e&&e.warning&&(this.warning=e.warning)},Eden.AST.BinaryOp.prototype.generate=function(e,t,n){var r={bound:!1,usevar:n.usevar};e&&e.isdynamic&&(e.dynamic_source+="(");var i=this.l.generate(e,t,r);e&&e.isdynamic&&(e.dynamic_source+=" "+this.op+" ");var s,o,a=this.r.generate(e,t,r);switch(e&&e.isdynamic&&(e.dynamic_source+=")"),this.op){case"//":s="concat";break;case"+":s="add";break;case"-":s="subtract";break;case"/":s="divide";break;case"*":s="multiply";break;case"==":s="equal";break;case"!=":s="notequal";break;case"%":s="mod";break;case"^":s="pow";break;default:s="RAW"}return o="RAW"!=s?"rt."+s+"(("+i+"),("+a+"))":"("+i+") "+this.op+" ("+a+")",n.bound?"new BoundValue("+o+", "+t+")":o},Eden.AST.BinaryOp.prototype.execute=function(ctx,base,scope){var rhs="(function(context,scope) { return ";return rhs+=this.generate(ctx,"scope",{bound:!1}),rhs+=";})",eval(rhs)(eden.root,scope)},Eden.AST.Break=function(){this.type="break",Eden.AST.BaseStatement.apply(this)},Eden.AST.Break.prototype.generate=function(e,t){return"break; "},Eden.AST.Break.prototype.execute=function(e,t,n,r){var i=new Eden.RuntimeError(t,Eden.RuntimeError.NOTSUPPORTED,this,"Break not supported here");i.line=this.line,this.errors.push(i),Eden.Agent.emit("error",[r,i])},Eden.AST.registerStatement(Eden.AST.Break),Eden.AST.Case=function(){this.type="case",Eden.AST.BaseStatement.apply(this),this.datatype="",this.literal=void 0},Eden.AST.Case.prototype.setLiteral=function(e,t){this.datatype=e,this.literal=t},Eden.AST.Case.prototype.generate=function(e,t){return"string"==typeof this.literal?'case "'+this.literal+'": ':"case "+this.literal+": "},Eden.AST.Case.prototype.execute=function(e,t,n,r){var i=new Eden.RuntimeError(t,Eden.RuntimeError.NOTSUPPORTED,this,"Case not supported here");i.line=this.line,this.errors.push(i),Eden.Agent.emit("error",[r,i])},Eden.AST.registerStatement(Eden.AST.Case),Eden.AST.CodeBlock=function(){this.type="codeblock",Eden.AST.BaseContext.apply(this),this.params=void 0,this.locals=void 0,this.script=void 0},Eden.AST.CodeBlock.prototype.setLocals=function(e){this.locals=e,this.errors.push.apply(this.errors,e.errors)},Eden.AST.CodeBlock.prototype.setParams=function(e){this.params=e,this.errors.push.apply(this.errors,e.errors)},Eden.AST.CodeBlock.prototype.setScript=function(e){this.script=e,e&&(e.parent=this,this.errors.push.apply(this.errors,e.errors))},Eden.AST.CodeBlock.prototype.generate=function(e){var t="(function(context, scope, cache) {\n";if(this.locals&&this.locals.list)for(var n=0;n<this.locals.list.length;n++)t+="var "+this.locals.list[n]+";\n";if(t+="return (function() {\n",this.params&&this.params.list)for(n=0;n<this.params.list.length;n++)t+="var "+this.params.list[n]+" = edenCopy(arguments["+n+"]);\n";return t+=this.script.generate(this,"scope")+"}); })"},Eden.AST.registerContext(Eden.AST.CodeBlock),Eden.AST.Context=function(e){this.symbols={},this.parent=e},Eden.AST.Context.prototype.lookup=function(e){return console.log("LOOKUP CONTEXT",e),this.symbols[e]?this.symbols[e]:(this.symbols[e]=new Eden.AST.Handle(e),this.symbols[e])},Eden.AST.Continue=function(){this.type="continue",Eden.AST.BaseStatement.apply(this)},Eden.AST.Continue.prototype.generate=function(e,t){return"continue; "},Eden.AST.Continue.prototype.execute=function(e,t,n,r){var i=new Eden.RuntimeError(t,Eden.RuntimeError.NOTSUPPORTED,this,"Continue not supported here");i.line=this.line,this.errors.push(i),Eden.Agent.emit("error",[r,i])},Eden.AST.registerStatement(Eden.AST.Continue),Eden.AST.Declarations=function(){this.type="declarations",Eden.AST.BaseStatement.apply(this),this.list=[],this.kind="local"},Eden.AST.Declarations.prototype.execute=function(e,t,n,r){if(e){void 0===e.locals&&(e.locals={});for(var i=0;i<this.list.length;i++)e.locals[this.list[i]]=new Eden.AST.Local(this.list[i])}},Eden.AST.Declarations.prototype.generate=function(e,t,n){if("local"==this.kind){var r="var ";void 0===e.locals&&(e.locals={});for(var i=0;i<this.list.length;i++)e.locals[this.list[i]]=new Eden.AST.Local(this.list[i]),r+=this.list[i],i<this.list.length-1&&(r+=",");return r+=";\n"}if(this.kind="oracle"){r="";void 0===e.locals&&(e.locals={});for(i=0;i<this.list.length;i++)e.locals[this.list[i]]=new Eden.AST.Local(this.list[i]),r+="var "+this.list[i]+" = "+t+'.value("'+this.list[i]+'");\n';return r}},Eden.AST.registerStatement(Eden.AST.Declarations),Eden.AST.Default=function(){this.type="default",Eden.AST.BaseStatement.apply(this)},Eden.AST.Default.prototype.generate=function(e,t){return"default: "},Eden.AST.Default.prototype.execute=function(e,t,n,r){var i=new Eden.RuntimeError(t,Eden.RuntimeError.NOTSUPPORTED,this,"Default not supported here");i.line=this.line,this.errors.push(i),Eden.Agent.emit("error",[r,i])},Eden.AST.registerStatement(Eden.AST.Default),Eden.AST.Definition=function(){this.type="definition",Eden.AST.BaseContext.apply(this),this.expression=void 0,this.lvalue=void 0,this.sources=null},Eden.AST.Definition.prototype.reset=function(){this.executed=0},Eden.AST.Definition.prototype.getParameterByNumber=function(e){if(this.parent&&this.parent.getParameterByNumber)return this.parent.getParameterByNumber(e)},Eden.AST.Definition.prototype.setExpression=function(e){e&&e.warning&&(this.warning=e.warning),this.expression=e,this.errors=e.errors},Eden.AST.Definition.prototype.left=function(e){this.lvalue=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Definition.prototype.locatePrimary=function(e){for(var t=this.expression,n=0;n<e.length;++n){var r=e[n];if("literal"!=t.type)return;if("LIST"==t.datatype){if(!(Array.isArray(t.value)&&r<t.value.length))return;t=t.value[r]}else{if("OBJECT"!=t.datatype)return;t=t.value[r]}}if(t&&"primary"==t.type&&!t.backtick&&0==t.extras.length)return t.observable},Eden.AST.Definition.prototype.generateDef=function(e,t){var n=this.lvalue&&this.lvalue.name?"def_"+this.lvalue.name:"",r="primary"==this.expression.type&&0==this.expression.extras.length||"scope"==this.expression.type,i="function "+n+"(context, scope, cache) {\n";this.locals=e?e.locals:void 0,this.params=e?e.params:void 0,this.backtickCount=0,this.dynamic_source="";var s=this.expression.generate(this,"scope",{bound:r,indef:!0});if(this.backtickCount>0&&(i+="var btick = 0;\n"),this.scopes.length>0){i+="\tvar _scopes = [];\n";for(var o=0;o<this.scopes.length;o++)i+="\t_scopes.push("+this.scopes[o],i+=");\n",i+="if (cache.scopes && "+o+" < cache.scopes.length) { _scopes["+o+"].mergeCache(cache.scopes["+o+"]); _scopes["+o+"].reset(); } else _scopes["+o+"].rebuild();\n";i+="cache.scopes = _scopes;\n"}return"async"==this.expression.type?(i+="\tif (cache) cache.scope = scope;\n",i+="\tvar _r = rt.flattenPromise("+s+");\n",i+="\treturn _r;\n}"):r?(i+="\t var result = "+s+";\n",i+="\tif (cache) cache.scope = result.scope;\n",0==this.scopes.length?i+="\treturn edenCopy(result.value);\n}":i+="\treturn result.value;\n}"):(i+="\tif (cache) cache.scope = scope;\n",i+="\treturn "+s+";\n}"),i},Eden.AST.Definition.prototype.generate=function(e,t){var n=this.lvalue.generate(e,t);if(this.scopes=[],this.dependencies={},this.lvalue.islocal)return"";if(this.lvalue.hasListIndices()){var r=this.lvalue.generateIndexList(this,t);n+=".addExtension("+this.lvalue.generateIdStr()+", function(context, scope, value) {\n\tvalue",n+=r+" = ",n+=this.expression.generate(this,"scope",{bound:!1});var i=[];for(var s in this.dependencies)i.push(s);return n=n+";\n}, undefined, this, "+JSON.stringify(i),n+=");\n"}n=t+".define("+n+","+this.generateDef(e,t);i=[];for(var s in this.dependencies)i.push(s);return n=n+", EdenSymbol.localJSAgent, "+JSON.stringify(i)+");\n"},Eden.AST.Definition.prototype.execute=function(ctx,base,scope,agent){this.executed=1;var sym=this.lvalue.getSymbol(ctx,base,scope),rhs;this.scopes=[],this.dependencies={},this.backtickCount=0;try{if(this.lvalue.hasListIndices()){rhs="(function(context,scope,value) { value",rhs+=this.lvalue.generateIndexList(this,"scope")+" = ",rhs+=this.expression.generate(this,"scope",{bound:!1}),rhs+=";})";var deps=[];for(var d in this.dependencies)deps.push(d);var source=base.getSource(this);sym.addExtension(this.lvalue.generateIdStr(),eval(rhs),source,void 0,deps)}else{rhs="("+this.generateDef(ctx)+")";var deps=[];for(var d in this.dependencies)deps.push(d);this.isdynamic&&(this.sources||(this.sources={}),this.sources[sym.name]=sym.name+" is "+this.dynamic_source+";"),sym.isasync="async"==this.expression.type,sym.define(eval(rhs),this,deps,rhs)}}catch(e){var err;console.log(rhs),err=e.message==Eden.RuntimeError.EXTENDSTATIC?new Eden.RuntimeError(base,Eden.RuntimeError.EXTENDSTATIC,this,"Can only define list items if the list is defined"):new Eden.RuntimeError(base,Eden.RuntimeError.UNKNOWN,this,e),this.errors.push(err),err.line=this.line,eden.emit("error",[agent,this.errors[this.errors.length-1]])}},Eden.AST.registerStatement(Eden.AST.Definition),Eden.AST.Delete=function(){this.type="delete",Eden.AST.BaseStatement.apply(this),this.destination=void 0,this.index=void 0},Eden.AST.Delete.prototype.setDest=function(e){this.destination=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Delete.prototype.setIndex=function(e){this.index=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Delete.prototype.generate=function(e,t){var n=this.index.generate(e,t,{bound:!1});return this.destination.generate(e)+".mutate(scope, function(s) { scope.lookup(s.name).value.splice(rt.index("+n+"), 1); }, this);"},Eden.AST.Delete.prototype.execute=function(e,t,n){this.executed=1;var r=this.index.execute(e,t,n);r instanceof BoundValue&&(r=r.value),eden.root.lookup(this.destination.name).mutate(n,function(e){e.value().splice(r-1,1)},this)},Eden.AST.registerStatement(Eden.AST.Delete),Eden.AST.Do=function(){this.type="do",Eden.AST.BaseStatement.apply(this),this.name=void 0,this.script=void 0,this.parameters=[],this.params=[],this.scope=void 0,this.compScope=void 0,this.nscope=void 0,this.selector=void 0,this.attribs={atomic:!1}},Eden.AST.Do.attributes={atomic:!0,nonatomic:!0},Eden.AST.Do.prototype.addParameter=function(e){this.parameters.push(e),e&&e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Do.prototype.setScript=function(e){this.script=e,this.script&&this.script.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Do.prototype.setAttribute=function(e,t){this.attribs||(this.attribs={}),this.attribs[e]=t},Eden.AST.Do.prototype.setName=function(e){e&&e.errors&&this.errors.push.apply(this.errors,e.errors),this.name=e},Eden.AST.Do.prototype.setScope=function(e){this.scope=e,e&&e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Do.prototype.getScope=function(ctx){try{this.compScope=eval("(function (context, scope) { var s = "+this.scope.generateConstructor(ctx,"scope")+"; s.rebuild(); return s; })")}catch(e){}return this.compScope},Eden.AST.Do.prototype.generate=function(e){var t=new Eden.RuntimeError(e,Eden.RuntimeError.NOTSUPPORTED,this,"Cannot use 'do' here");return this.errors.push(t),eden.emit("error",[EdenSymbol.defaultAgent,t]),""},Eden.AST.Do.prototype.getParameters=function(e,t,n){for(var r=[],i=0;i<this.parameters.length;i++)r.push(this.parameters[i].execute(e,t,n));return r},Eden.AST.Do.prototype.execute=function(e,t,n,r){var i;if(this.executed=1,i=this.script?this.script:t.getActionByName(this.name))return i.execute(e,t,n,r);this.executed=3;var s=new Eden.RuntimeError(t,Eden.RuntimeError.ACTIONNAME,this,"Action '"+this.name+"' does not exist");this.parent&&(this.parent.executed=3),s.line=this.line,this.errors.push(s),Eden.Agent.emit("error",[r,s])},Eden.AST.registerStatement(Eden.AST.Do),Eden.AST.DoxyComment=function(e,t,n){this.type="doxycomment",this.content=e,this.startline=t,this.endline=n,this.tags=void 0,this.controls=void 0,this.parent=void 0},Eden.AST.DoxyComment.prototype.getHashTags=function(){return this.tags?Object.keys(this.tags):(this.stripped(),this.tags?Object.keys(this.tags):[])},Eden.AST.DoxyComment.prototype.hasTag=function(e){return void 0===this.tags&&this.getHashTags(),!(!this.tags||!this.tags[e])},Eden.AST.DoxyComment.prototype.getControls=function(){return this.controls?this.controls:(this.stripped(),this.controls)},Eden.AST.DoxyComment.prototype.getProperty=function(e){var t=this.getControls();return t?t["@"+e]:void 0},Eden.AST.DoxyComment.prototype.stripped=function(){if(void 0===this.content)return"";for(var e={},t={},n=this.content.split("\n"),r="",i=0;i<n.length;i++)if("#"==n[i].charAt(0)?(n[i]=n[i].slice(1)," "==n[i].charAt(0)&&(n[i]=n[i].slice(1))):"*"==n[i].trim().charAt(0)&&(n[i]=n[i].trim().slice(1)," "==n[i].charAt(0)&&(n[i]=n[i].slice(1))),""!=n[i]){var s=n[i].trim();if("@"!=s.charAt(0)){for(var o=n[i].split(/[ \t]+/),a=0;a<o.length;a++)""!=o[a]&&"@"!=o[a].charAt(0)?(r+=o[a]+" ","#"==o[a].charAt(0)&&(t[o[a]]=!0)):r+=" ";r+="\n"}else{var d=s.indexOf(" ");if(-1==d)e[s]=!0;else{var h=s.substring(0,d),c=s.substring(d+1,s.length);void 0===e[h]&&(e[h]=[]),e[h].push(c)}n[i]=""}}else r+="\n";return this.controls=e,this.tags=t,r.trim()},Eden.AST.DoxyComment.prototype.brief=function(){var e=this.stripped();if(e)return e.split(".")[0]},Eden.AST.DoxyComment.prototype.pretty=function(){var e=this.stripped(),t=this.controls["@param"],n=EdenUI.Markdown.html(e);if(t&&t.length>0){n+='<div class="doxy-parameters">Parameters:';for(var r=0;r<t.length;r++){n+='<div class="doxy-parameter"><div class="doxy-parameter-name">'+(e=t[r].split(/[ \t]+/))[0]+'</div><div class="doxy-parameter-details">'+e.slice(1).join(" ")+"</div></div>"}n+="</div>"}return n},Eden.AST.DoxyComment.prototype.getParamString=function(){var e=this.getControls()["@param"];if(e&&e.length>0){for(var t="(",n=0;n<e.length;n++)t+=e[n].split(/[ \t]+/)[0],n<e.length-1&&(t+=", ");return t+=")"}return"()"},Eden.AST.DummyStatement=function(){this.type="dummy",Eden.AST.BaseStatement.apply(this),this.start=-1},Eden.AST.DummyStatement.prototype.generate=function(){return""},Eden.AST.DummyStatement.prototype.execute=function(){},Eden.AST.registerStatement(Eden.AST.DummyStatement),Eden.AST.DummyStatement.prototype.setSource=function(e,t,n){this.start=this.start<0?e:this.start,this.end=t,this.source?this.source+=n:this.source=n},Eden.AST.DummyStatement.prototype.buildID=function(){var e=0,t=this.source+(this.previousSibling?this.previousSibling.getSource():"");this.doxyComment&&(t=this.doxyComment.content+t);for(var n=t.length,r=0;r<n;r++)e=(e<<5)-e+t.charCodeAt(r),e&=e;this.id=this.type+"@"+e},Eden.AST.For=function(){this.type="for",Eden.AST.BaseStatement.apply(this),this.sstart=void 0,this.condition=void 0,this.inc=void 0,this.statement=void 0,this.compiled=void 0,this.started=!1,this.list=void 0,this.index=0,this.dirty=!1},Eden.AST.For.prototype.setStart=function(e){this.sstart=e,e&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.For.prototype.setCondition=function(e){this.condition=e,e&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.For.prototype.setIncrement=function(e){this.inc=e,e&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.For.prototype.setStatement=function(e){this.statement=e,e&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.For.prototype.generate=function(e,t){var n="for (";this.sstart?n+=this.sstart.generate(e,t)+" ":n+="; ",this.condition?n+=this.condition.generate(e,"scope",{bound:!1,usevar:"scriptexpr"==e.type})+"; ":n+="; ";var r=this.inc.generate(e,t);return";"==r.charAt(r.length-2)&&(r=r.slice(0,-2)),n+=r+")\n",n+=this.statement.generate(e,t)},Eden.AST.For.prototype.getCondition=function(ctx){if(this.compiled&&0==this.dirty)return this.compiled;var express=this.condition.generate(ctx,"scope",{bound:!1,usevar:"scriptexpr"==ctx.type});ctx.dirty&&(this.dirty=!0,ctx.dirty=!1);var expfunc=eval("(function(context,scope){ return "+express+"; })");return this.compiled=expfunc,expfunc},Eden.AST.For.prototype.execute=function(e,t,n,r){if(this.executed=1,this.sstart&&"range"==this.sstart.type){void 0===this.list&&(this.sstart.second?(this.index=this.sstart.expression.execute(e,t,n,r),this.list=this.sstart.second.execute(e,t,n,r),this.index instanceof BoundValue&&(this.index=this.index.value),this.list instanceof BoundValue&&(this.list=this.list.value)):(this.list=this.sstart.expression.execute(e,t,n,r),this.index=0));var i=this.sstart.lvalue.getSymbol(e,t,n);if(this.sstart.second)return this.index<=this.list?(i.assign(this.index,n,this),this.index++,[this.statement,this]):(this.index=0,void(this.list=void 0));if(Array.isArray(this.list)){if(this.index<this.list.length){if(this.list[this.index]instanceof BoundValue)i.assign(this.list[this.index].value,n,this),(s=n.lookup(i.name))&&(s.scope=this.list[this.index].scope);else i.assign(this.list[this.index],n,this);return this.index++,[this.statement,this]}return this.index=0,void(this.list=void 0)}if(this.list instanceof BoundValue){if(this.index<this.list.value.length){var s;if(this.list.scopes)i.assign(this.list.value[this.index],n,this),(s=n.lookup(i.name))&&(s.scope=this.list.scopes[this.index]);else if(this.list.value[this.index]instanceof BoundValue)i.assign(this.list.value[this.index].value,n,this),(s=n.lookup(i.name))&&(s.scope=this.list.value[this.index].scope);else i.assign(this.list.value[this.index],n,this),(s=n.lookup(i.name))&&(s.scope=this.list.scope);return this.index++,[this.statement,this]}return this.index=0,void(this.list=void 0)}}else if(this.sstart&&!this.started)return this.started=!0,[this.sstart,this];if(this.getCondition(e)(eden.root,n))return[this.statement,this.inc,this];this.started=!1},Eden.AST.registerStatement(Eden.AST.For),Eden.AST.Function=function(){this.type="function",Eden.AST.BaseStatement.apply(this),this.body=void 0,this.name=""},Eden.AST.Function.prototype.setBody=function(e){this.body=e,e&&(e.parent=this,this.errors.push.apply(this.errors,e.errors))},Eden.AST.Function.prototype.generate=function(e){var t=this.body.generate(e,"scope");return'context.lookup("'+this.name+'").define('+t+", this, []);\n"},Eden.AST.Function.prototype.execute=function(ctx,base,scope,agent){this.executed=1,this.doxyComment&&eden.updateDictionary(this.name,this.doxyComment);var body=this.body.generate(ctx,"scope"),sym=eden.root.lookup(this.name);sym.define(eval(body),this,[])},Eden.AST.registerStatement(Eden.AST.Function),Eden.AST.FunctionCall=function(){this.type="functioncall",Eden.AST.BaseStatement.apply(this),this.lvalue=void 0,this.params=void 0},Eden.AST.FunctionCall.prototype.setParams=function(e){this.params=e;for(var t=0;t<e.length;t++)this.errors.push.apply(this.errors,e[t].errors)},Eden.AST.FunctionCall.prototype.left=function(e){this.lvalue=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.FunctionCall.prototype.generateArgs=function(e,t){var n="[";if(this.params)for(var r=0;r<this.params.length;r++){n+="("+this.params[r].generate(e,t,{bound:!1})+")",r!=this.params.length-1&&(n+=",")}return n+"]"},Eden.AST.FunctionCall.prototype.generate=function(e,t){if(void 0===this.lvalue){e&&e.isdynamic&&(e.dynamic_source+="(");var n=".call(this";if(this.params){this.params.length>0&&(n+=",");for(var r=0;r<this.params.length;r++){n+="("+this.params[r].generate(e,t,{bound:!1})+")",r!=this.params.length-1&&(e&&e.isdynamic&&(e.dynamic_source+=", "),n+=",")}}return e&&e.isdynamic&&(e.dynamic_source+=")"),n+")"}var i=this.lvalue.generate(e,t);n=t+".value("+i+").call(context.lookup("+i+")";if(this.params)for(r=0;r<this.params.length;r++){n+=",",n+="("+this.params[r].generate(e,t,{bound:!1})+")"}return n+");"},Eden.AST.FunctionCall.prototype.execute=function(ctx,base,scope,agent){if(this.lvalue){this.executed=1;var func="(function(context,scope,cache) { ";func+="let name = "+this.lvalue.generate(ctx,scope)+";\n",func+="let args = "+this.generateArgs(ctx,"scope")+";\n",eden.peer&&(func+="eden.peer.callProcedure(name, args);\n"),func+="return scope.value(name).apply(context.lookup(name),args); })";try{return eval(func).call(ctx,eden.root,scope,scope.cache)}catch(e){var err=new Eden.RuntimeError(base,Eden.RuntimeError.FUNCCALL,this,e);this.errors.push(err),err.line=this.line,eden.emit("error",[agent,err])}}},Eden.AST.registerStatement(Eden.AST.FunctionCall),Eden.AST.Handle=function(e){console.log("MAKE HANDLE",e),this.name=e,this.cvalue=void 0,this.definition=void 0},Eden.AST.Handle.prototype.assign=function(e,t){console.log("HANDLE ASSIGN",this.name,e,t),t?t.lookup(this.name).value=e:this.cvalue=e},Eden.AST.Handle.prototype.define=function(e,t,n){console.log("HANDLE DEFINE",e),this.definition=e},Eden.AST.Handle.prototype.value=function(e){return console.log("HANDLE SCOPE",this.name,e,this.cvalue),this.definition?this.definition.call(this,e.context,e):e?e.lookup(this.name).value:this.cvalue},Eden.AST.If=function(){this.type="if",Eden.AST.BaseStatement.apply(this),this.condition="",this.statement=void 0,this.elsestatement=void 0,this.statements=[]},Eden.AST.registerStatement(Eden.AST.If),Eden.AST.If.prototype.setCondition=function(e){this.condition=e,this.errors.push.apply(this.errors,e.errors)},Eden.AST.If.prototype.setStatement=function(e){this.statement=e,e&&(this.statements.push(e),e.parent=this,this.errors.push.apply(this.errors,e.errors))},Eden.AST.If.prototype.setElse=function(e){this.elsestatement=e,e&&(this.statements.push(e),e.parent=this,this.errors.push.apply(this.errors,e.errors))},Eden.AST.If.prototype.generate=function(e,t){var n="if (";return n+=this.condition.generate(e,t,{bound:!1}),n+=") ",n+=this.statement.generate(e,t)+" ",this.elsestatement&&(n+="\nelse "+this.elsestatement.generate(e,t)+"\n"),n},Eden.AST.If.prototype.getCondition=function(ctx){var cond="(function(context,scope,ctx) { return ";return cond+=this.condition.generate(ctx,"scope",{bound:!1}),cond+=";})",eval(cond)},Eden.AST.If.prototype.execute=function(e,t,n,r){return this.executed=1,this.getCondition(e)(eden.root,n,e)?[this.statement]:(this.executed=2,this.elsestatement?[this.elsestatement]:void 0)},Eden.AST.Import=function(){this.type="import",Eden.AST.BaseStatement.apply(this),this.path=void 0,this.selector=void 0,this.statements=void 0},Eden.AST.Import.prototype.setPath=function(e){this.path=e},Eden.AST.registerStatement(Eden.AST.Import),Eden.AST.Index=function(){this.type="index",this.expression=void 0,this.errors=[]},Eden.AST.Index.prototype.setExpression=function(e){this.expression=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Index.prototype.generate=function(e,t,n){return"[rt.index("+this.expression.generate(e,t,{bound:!1})+")]"},Eden.AST.Index.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.Insert=function(){this.type="insert",Eden.AST.BaseStatement.apply(this),this.destination=void 0,this.index=void 0,this.value=void 0},Eden.AST.Insert.prototype.setDest=function(e){this.destination=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Insert.prototype.setIndex=function(e){this.index=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Insert.prototype.setValue=function(e){this.value=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Insert.prototype.generate=function(e,t){var n=this.index.generate(e,t,{bound:!1}),r=this.value.generate(e,t,{bound:!1}),i=this.destination.generate(e);return this.destination.islocal?i+".splice(rt.index("+n+"), 0, ("+r+"));":i+".mutate(scope, function(s) { scope.lookup(s.name).value.splice(rt.index("+n+"), 0, ("+r+")); }, this);"},Eden.AST.Insert.prototype.execute=function(e,t,n){this.executed=1;var r=this.index.execute(e,t,n),i=this.value.execute(e,t,n);r instanceof BoundValue&&(r=r.value),i instanceof BoundValue&&(i=i.value),eden.root.lookup(this.destination.name).mutate(n,function(e){e.value().splice(r-1,0,i)},this)},Eden.AST.registerStatement(Eden.AST.Insert),Eden.AST.Length=function(){this.type="length",this.errors=[],this.l=void 0},Eden.AST.Length.prototype.left=Eden.AST.fnEdenASTleft,Eden.AST.Length.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.Length.prototype.generate=function(e,t,n){var r=this.l.generate(e,t,{bound:!1,usevar:n.usevar});return n.bound?"new BoundValue(rt.length("+r+"), "+t+")":"rt.length("+r+")"},Eden.AST.Length.prototype.execute=function(e,t,n,r){return rt.length(this.l.execute(e,t,n,r))},Eden.AST.Literal=function(e,t){this.type="literal",Eden.AST.BaseStatement.apply(this),this.datatype=e,this.value=t},Eden.AST.Literal.prototype.generate=function(e,t,n){var r;switch(this.datatype){case"NUMBER":r=this.value,e&&e.isdynamic&&(e.dynamic_source+=Eden.edenCodeForValue(this.value));break;case"LIST":r="[",e&&e.isdynamic&&(e.dynamic_source+="[");for(var i=0;i<this.value.length;i++)r+=this.value[i].generate(e,t,{bound:!1}),i!=this.value.length-1&&(r+=",",e&&e.isdynamic&&(e.dynamic_source+=", "));r+="]",e&&e.isdynamic&&(e.dynamic_source+="]");break;case"OBJECT":r="{",e&&e.isdynamic&&(e.dynamic_source+="{");var s=Object.keys(this.value);for(i=0;i<s.length;++i)r+=s[i]+": ",r+=this.value[s[i]].generate(e,t,{bound:!1}),i!=s.length-1&&(r+=",",e&&e.isdynamic&&(e.dynamic_source+=", "));r+="}",e&&e.isdynamic&&(e.dynamic_source+="}");break;case"CHARACTER":case"STRING":r='"'+this.value.replace(/\n/g,"\\n")+'"',e&&e.isdynamic&&(e.dynamic_source+=Eden.edenCodeForValue(this.value));break;case"BOOLEAN":r=this.value,e&&e.isdynamic&&(e.dynamic_source+=this.value?"true":"false");break;case"JAVASCRIPT":r=this.value,e&&e.isdynamic&&(e.dynamic_source+="${{ "+this.value+" }}$");break;case"UNDEFINED":e&&e.isdynamic&&(e.dynamic_source+="@")}return n.bound?"new BoundValue("+r+","+t+")":r},Eden.AST.Literal.prototype.execute=function(ctx,base,scope){switch(this.datatype){case"NUMBER":case"CHARACTER":case"BOOLEAN":return eval(this.value);case"STRING":return eval('"'+this.value+'"');case"OBJECT":case"LIST":var rhs="(function(context,scope) { return ";return rhs+=this.generate(ctx,"scope",{bound:!1}),rhs+=";})",eval(rhs)(eden.root,scope);case"JAVASCRIPT":return eval(this.value)}},Eden.AST.registerStatement(Eden.AST.Literal),Eden.AST.LList=function(){this.type="lvaluelist",this.errors=[],this.llist=[]},Eden.AST.LList.prototype.append=function(e){this.llist.push(e),this.errors.push.apply(this.errors,e.errors)},Eden.AST.LList.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.Local=function(e){this.name=e,this.cvalue=void 0,this.definition=void 0},Eden.AST.Local.prototype.assign=function(e,t){this.cvalue=e},Eden.AST.Local.prototype.define=function(e,t,n){this.definition=e},Eden.AST.Local.prototype.value=function(e){return this.definition?this.definition.call(this,e.context,e):this.cvalue},Eden.AST.LValue=function(){this.type="lvalue",this.errors=[],this.name=void 0,this.express=void 0,this.primary=void 0,this.lvaluep=void 0,this.islocal=!1,this.source=""},Eden.AST.LValue.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.LValue.prototype.setExtras=function(e){if(this.lvaluep=e,e)for(var t=0;t<e.length;t++)this.errors.push.apply(this.errors,e[t].errors)},Eden.AST.LValue.prototype.setObservable=function(e){this.name=e},Eden.AST.LValue.prototype.setPrimary=function(e){this.primary=e,e&&e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.LValue.prototype.setExpression=function(e){this.express=e,e&&e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.LValue.prototype.getSymbol=function(e,t,n){if(e&&e.locals&&"declarations"!=e.locals.type&&e.locals.hasOwnProperty(this.name))return this.islocal=!0,e.locals[this.name];if(this.name)return eden.root.lookup(this.name);if(this.primary){var r=this.primary.execute(e,t,n);return r instanceof BoundValue&&(r=r.value),r}if(this.express){var i=this.express.execute(e,t,n);return i instanceof BoundValue&&(i=i.value),eden.root.lookup(i)}},Eden.AST.LValue.prototype.hasListIndices=function(){return this.lvaluep&&this.lvaluep.length>0&&"index"==this.lvaluep[0].kind},Eden.AST.LValue.prototype.generateCompList=function(e,t){for(var n="[",r=0;r<this.lvaluep.length;r++)n+="rt.index("+this.lvaluep[r].indexexp.generate(e,t,{bound:!1})+")",r<this.lvaluep.length-1&&(n+=",");return n+="]"},Eden.AST.LValue.prototype.generateIndexList=function(e,t){for(var n="[",r=0;r<this.lvaluep.length;r++)n+="rt.index("+this.lvaluep[r].indexexp.generate(e,t,{bound:!1})+")",r<this.lvaluep.length-1&&(n+="][");return n+="]"},Eden.AST.LValue.prototype.generateIdStr=function(){return'"'+this.generateCompList()+'"'},Eden.AST.LValue.prototype.executeCompList=function(ctx,scope){for(var res=[],i=0;i<this.lvaluep.length;i++)if("index"==this.lvaluep[i].kind){var iexp=this.lvaluep[i].indexexp.generate(ctx,"scope",{bound:!1});res.push(rt.index(eval("(function(context,scope) { return "+iexp+"; })")(eden.root,scope)))}return res},Eden.AST.LValue.prototype.generate=function(e,t){if(this.name){if(e&&e.locals){if("declarations"==e.locals.type&&-1!=e.locals.list.indexOf(this.name)){this.islocal=!0;for(var n=this.name,r=0;r<this.lvaluep.length;r++)n+=this.lvaluep[r].generate(e,t,{bound:!1,usevar:"scriptexpr"==e.type});return n}if(e.locals.hasOwnProperty(this.name)){this.islocal=!0;for(n=this.name,r=0;r<this.lvaluep.length;r++)n+=this.lvaluep[r].generate(e,t,{bound:!1,usevar:"scriptexpr"==e.type});return n}}if(e&&e.params&&-1!=e.params.list.indexOf(this.name)){this.islocal=!0;for(n=this.name,r=0;r<this.lvaluep.length;r++)n+=this.lvaluep[r].generate(e,t,{bound:!1,usevar:"scriptexpr"==e.type});return n}return'"'+this.name+'"'}return this.primary?this.primary.generate(e,t,{bound:!1,usevar:"scriptexpr"==e.type}):this.express?this.express.generate(e,t,{bound:!1,usevar:"scriptexpr"==e.type}):void 0},Eden.AST.LValueComponent=function(e){this.type="lvaluecomponent",this.errors=[],this.kind=e,this.indexexp=void 0,this.observable=void 0},Eden.AST.LValueComponent.prototype.index=function(e){this.indexexp=e,this.errors.push.apply(this.errors,e.errors)},Eden.AST.LValueComponent.prototype.property=function(e){this.observable=e},Eden.AST.LValueComponent.prototype.generate=function(e,t){if("index"==this.kind)return"[rt.index("+this.indexexp.generate(e,t,{bound:!1})+")]"},Eden.AST.LValueComponent.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.Modify=function(e,t){this.type="modify",Eden.AST.BaseContext.apply(this),this.errors=t?t.errors:[],this.kind=e,this.expression=t,this.lvalue=void 0},Eden.AST.Modify.prototype.left=function(e){this.lvalue=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Modify.prototype.generate=function(e,t){var n,r=this.lvalue.generate(e,t),i=r;return 0==this.lvalue.islocal?i=t+".assign("+r+","+t+".value("+r+")":i+=" = "+r,this.expression&&(n=this.expression.generate(e,t,{bound:!1,usevar:"scriptexpr"==e.type})),"+="==this.kind?i+=" + "+n:"-="==this.kind?i+=" - "+n:"/="==this.kind?i+=" / "+n:"*="==this.kind?i+=" * "+n:"++"==this.kind?i+="+1":"--"==this.kind&&(i+="-1"),0==this.lvalue.islocal?i+=", EdenSymbol.localJSAgent);\n":i+=";\n",i},Eden.AST.Modify.prototype.execute=function(ctx,base,scope,agent){var _scopes=[];this.executed=1;var sym=this.lvalue.getSymbol(ctx,base);if("++"==this.kind){var newval=sym.value(scope)+1;sym.assign(newval,scope,this)}else if("--"==this.kind){var newval=sym.value(scope)-1;sym.assign(newval,scope,this)}else{var rhs="(function(context,scope) { return ";rhs+=this.expression.generate(ctx,"scope",{bound:!1}),rhs+=";})";for(var context=eden.root,i=0,newval;i<this.scopes.length;i++)_scopes.push(eval(this.scopes[i]));switch(this.scopes=[],this.kind){case"+=":newval=rt.add(sym.value(scope),eval(rhs)(context,scope));break;case"-=":newval=rt.subtract(sym.value(scope),eval(rhs)(context,scope));break;case"/=":newval=rt.divide(sym.value(scope),eval(rhs)(context,scope));break;case"*=":newval=rt.multiply(sym.value(scope),eval(rhs)(context,scope))}sym.assign(newval,scope,this)}},Eden.AST.registerStatement(Eden.AST.Modify),Eden.AST.Parameter=function(e){this.type="parameter",this.index=e,this.errors=[],console.error("DEPRECATED PARAMETER")},Eden.AST.Parameter.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.Parameter.prototype.generate=function(e,t,n){if(-1==this.index){if(e&&e.parameters)return""+e.parameters.length;this.returnsbound=!1,r="0"}else if(e&&e.parameters){e.dirty=!0;var r=e.parameters[this.index-1];return this.returnsbound=r instanceof BoundValue,"ctx.parameters["+this.index+"-1]"}},Eden.AST.Primary=function(){this.type="primary",this.errors=[],this.observable="",this.extras=[],this.backtick=void 0},Eden.AST.Primary.prototype.setBackticks=function(e){this.backtick=e,this.errors.push.apply(this.errors,e.errors)},Eden.AST.Primary.prototype.setObservable=function(e){this.observable=e},Eden.AST.Primary.prototype.getObservable=function(){return this.observable},Eden.AST.Primary.prototype.prepend=function(e){this.extras.unshift(e),e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Primary.prototype.generate=function(ctx,scope,options){var res;if(ctx&&ctx.locals)if("declarations"==ctx.locals.type){if(-1!=ctx.locals.list.indexOf(this.observable)){res=this.observable;for(var i=0;i<this.extras.length;i++)res+=this.extras[i].generate(ctx,scope,{bound:!1});return options.bound?"new BoundValue("+res+","+scope+")":res}}else if(ctx.locals.hasOwnProperty(this.observable)){if(ctx.dirty=!0,options.usevar)res=this.observable;else if(options.indef)res=JSON.stringify(ctx.locals[this.observable].value());else{var val=ctx.locals[this.observable].value();ctx&&ctx.isdynamic&&(ctx.dynamic_source+=Eden.edenCodeForValue(val)),res=JSON.stringify(val),void 0===val&&console.error("Local variable undefined",this.observable)}for(var i=0;i<this.extras.length;i++)res+=this.extras[i].generate(ctx,scope,{bound:!1});return options.bound?"new BoundValue("+res+","+scope+")":res}if(ctx&&ctx.params){var ix=ctx.params.list.indexOf(this.observable);if(-1!=ix){res=this.observable;for(var i=0;i<this.extras.length;i++)res+=this.extras[i].generate(ctx,scope,{bound:!1});return options.bound?"new BoundValue("+res+","+scope+")":res}}if("__BACKTICKS__"==this.observable){var tmpdeplog,tmpdynsrc;ctx&&(tmpdeplog=ctx.isconstant,ctx.isconstant=!0,tmpdynsrc=ctx.dynamic_source);var btickgen=this.backtick.generate(ctx,scope,{bound:!1,usevar:options.usevar});if(!ctx||ctx.isconstant||"definition"!=ctx.type){if(ctx&&ctx.isconstant&&"definition"==ctx.type){try{btickgen=eval(btickgen)}catch(e){return console.error(e),'"ERROR"'}ctx.dependencies[btickgen]=!0,tmpdeplog=!1,ctx&&ctx.isdynamic&&(ctx.dynamic_source=tmpdynsrc+btickgen),btickgen=JSON.stringify(btickgen)}else ctx&&ctx.isdynamic&&(ctx.dynamic_source=tmpdynsrc);res=btickgen}else res="this.subscribeDynamic(0,"+btickgen+", "+scope+")",ctx&&ctx.isdynamic&&(ctx.dynamic_source="`"+ctx.dynamic_source+"`");ctx&&(ctx.isconstant=tmpdeplog)}else ctx&&ctx.dependencies&&(ctx.dependencies[this.observable]=!0,ctx.isconstant=!1),ctx&&ctx.isdynamic&&(ctx.dynamic_source+=this.observable),res='"'+this.observable+'"';if(0==this.extras.length)res=options.bound?options.scopeonly?scope+".scope("+res+")":scope+".boundValue("+res+")":scope+".value("+res+")";else{res=scope+".value("+res+")";for(var i=0;i<this.extras.length;i++)ctx&&ctx.isdynamic&&"index"==this.extras[i].type&&(ctx.dynamic_source+="["),res+=this.extras[i].generate(ctx,scope,{bound:!1,usevar:options.usevar}),ctx&&ctx.isdynamic&&"index"==this.extras[i].type&&(ctx.dynamic_source+="]");options.bound&&(res="new BoundValue("+res+","+scope+")")}return res},Eden.AST.Primary.prototype.execute=function(ctx,base,scope){var rhs="(function(context,scope) { return ";return rhs+=this.generate(ctx,"scope",{bound:!1}),rhs+=";})",eval(rhs)(eden.root,scope)},Eden.AST.Primary.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.Action=function(){this.type="action",Eden.AST.BaseStatement.apply(this),this.kindofaction="touch",this.triggers=[],this.body=void 0,this.name=""},Eden.AST.Action.prototype.kind=function(e){this.kindofaction=e},Eden.AST.Action.prototype.setBody=function(e){this.body=e,e&&(e.parent=this,this.errors.push.apply(this.errors,e.errors))},Eden.AST.Action.prototype.generate=function(e){var t=this.body.generate(e),n='context.lookup("'+this.name+'").define('+t+", this)";return this.triggers.length>0&&(n+=".observe("+JSON.stringify(this.triggers)+");\n"),n},Eden.AST.Action.prototype.execute=function(ctx,base,scope,agent){this.executed=1,this.doxyComment&&eden.updateDictionary(this.name,this.doxyComment);var body=this.body.generate(ctx),sym=eden.root.lookup(this.name);this.triggers.length>0?sym.define(eval(body),this,[]).observe(this.triggers):sym.define(eval(body),this,[])},Eden.AST.registerStatement(Eden.AST.Action),Eden.AST.Range=function(e){this.type="range",this.parent=void 0,this.errors=e?e.errors:[],this.expression=e,this.lvalue=void 0,this.start=0,this.end=0},Eden.AST.Range.prototype.setSource=function(e,t){this.start=e,this.end=t},Eden.AST.Range.prototype.setSecond=function(e){this.second=e,e&&e.errors&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Range.prototype.left=function(e){this.lvalue=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Range.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.Require=function(){this.type="require",Eden.AST.BaseStatement.apply(this),this.expression=void 0},Eden.AST.Require.prototype.setExpression=function(e){this.expression=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Require.prototype.generate=function(e){return"edenUI.loadPlugin("+this.expression.generate(e,"scope",{bound:!1})+");"},Eden.AST.Require.prototype.execute=function(e,t,n){this.executed=1,edenUI.loadPlugin(this.expression.execute(e,t,n))},Eden.AST.registerStatement(Eden.AST.Require),Eden.AST.Return=function(){this.type="return",Eden.AST.BaseStatement.apply(this),this.result=void 0},Eden.AST.Return.prototype.setResult=function(e){this.result=e,this.errors.push.apply(this.errors,e.errors)},Eden.AST.Return.prototype.generate=function(e,t){return this.result?"return "+this.result.generate(e,t,{bound:!1,usevar:"scriptexpr"==e.type})+";\n":"return;\n"},Eden.AST.Return.prototype.execute=function(e,t,n,r){var i=new Eden.RuntimeError(t,Eden.RuntimeError.NOTSUPPORTED,this,"Return not supported here");i.line=this.line,this.errors.push(i),Eden.Agent.emit("error",[r,i])},Eden.AST.registerStatement(Eden.AST.Return),Eden.AST.Scope=function(){this.type="scope",this.errors=[],this.range=!1,this.overrides={},this.expression=void 0},Eden.AST.Scope.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.Scope.prototype.prepend=function(e){this.primary.prepend(e)},Eden.AST.Scope.prototype.setExpression=function(e){this.expression=e,e&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Scope.prototype.addOverride=function(e,t,n,r,i){this.errors.push.apply(this.errors,e.errors),i&&(this.range=!0),r?(this.range=!0,this.overrides[e.observable]={start:t,end:r,increment:n,components:e.components,isin:i},this.errors.push.apply(this.errors,t.errors),this.errors.push.apply(this.errors,n.errors),this.errors.push.apply(this.errors,r.errors)):n?(this.range=!0,this.overrides[e.observable]={start:t,end:n,components:e.components,isin:i},this.errors.push.apply(this.errors,t.errors),this.errors.push.apply(this.errors,n.errors)):t&&(this.overrides[e.observable]={start:t,end:void 0,components:e.components,isin:i},this.errors.push.apply(this.errors,t.errors))},Eden.AST.Scope.prototype.generateConstructor=function(e,t){var n;for(var r in n="new Scope(context, "+t+", [",this.overrides){var i=this.overrides[r];if(e&&e.isdynamic&&(e.dynamic_source+=r,i.isin&&!i.end?e.dynamic_source+=" in ":e.dynamic_source+=" = "),n+='new ScopeOverride("'+r+'", '+(this.range,i.start.generate(e,t,{bound:!1})),i.end){e&&e.isdynamic&&(e.dynamic_source+="..");var s=this.overrides[r].end.generate(e,t,{bound:!1});if(i.increment)n+=", "+s+", "+i.increment.generate(e,t,{bound:!1})+"),";else n+=", "+s+"),"}else n+=", undefined, undefined, "+i.isin+"),";e&&e.isdynamic&&(e.dynamic_source+=", ")}return n=n.slice(0,-1),n+="], "+this.range+", this,true)"},Eden.AST.Scope.prototype._generate_plain_range=function(e,t){var n="_scopes["+(e.scopes.length-1)+"]",r="(function() {\n";return r+=n+".range = false;\n",r+="var results = [];\n",r+="var scoperesults = [];\n",r+="while(true) {\n",r+="var val = "+this.expression.generate(e,"_scopes["+(e.scopes.length-1)+"].clone()",t),t.bound&&(r+=";\n\tif (val.value !== undefined) scoperesults.push(val.scope);\n\tval = val.value"),r+=";\n",r+="if (val !== undefined) results.push(val);\n",r+="if ("+n+".next() == false) break;\n",r+="}\n"+n+".range = true;\n",t.bound?r+="if (cache) cache.scopes = scoperesults;\n return new BoundValue(results,"+n+");}).call(this)":r+="return results;}).call(this)",r},Eden.AST.Scope.prototype._generate_loop_opti=function(e,t,n){var r="_scopes["+(e.scopes.length-1)+"]",i=this.expression.generate(e,"_scopes["+(e.scopes.length-1)+"]",{bound:!1}),s="(function() {\n";return s+=r+".range = false;\n",s+="var looper = "+r+".overrides["+n[0]+"];\n",s+="var ix = 0;\n",s+="var results = new Array(looper.end - looper.start + 1);\n",s+="for (var i=looper.start; i<=looper.end; i++) {\n",s+="\t"+r+".resetCache();\n",s+="\tlooper.current = i;\n",s+="\t"+r+".refresh();\n",s+="\tvar val = "+i,s+=";\n",s+="\tif (val !== undefined) results[ix++] = val;\n",s+="}\n"+r+".range = true;\n",s+="results.length = ix;\n",t.bound?s+="return new BoundValue(results,"+r+");}).call(this)":s+="return results;}).call(this)",s},Eden.AST.Scope.prototype.generate=function(e,t,n){e.scopes.push(this.generateConstructor(e,t));var r,i="";if(e&&e.isdynamic&&(r=e.dynamic_source,e.dynamic_source=""),this.range){var s=!1,o=[],a=0;for(var d in this.overrides){if(!this.overrides[d].end){this.overrides[d].isin&&(s=!0);break}o.push(a),a++}i=s||1!=o.length?this._generate_plain_range(e,n):this._generate_loop_opti(e,n,o)}else{var h=this.expression.generate(e,"_scopes["+(e.scopes.length-1)+"]",n);i="async"==this.expression.type?"(function(){ var _r = "+h+"; _r.then(rr => { cache.value = rr; this.expireAsync(); }); return cache.value; }).call(this)":h}return e&&e.isdynamic&&(e.dynamic_source+=" with ("+r+")"),i},Eden.AST.Scope.prototype.execute=function(ctx,base,scope){var context={scopes:[]},gen=this.generate(context,"scope",{bound:!1}),rhs="(function(context,scope) {\n";if(context.scopes.length>0){rhs+="\tvar _scopes = [];\n";for(var i=0;i<context.scopes.length;i++)rhs+="\t_scopes.push("+context.scopes[i],rhs+=");\n",rhs+="if (this.def_scope) { _scopes["+i+"].mergeCache(this.def_scope["+i+"]); _scopes["+i+"].reset(); } else _scopes["+i+"].rebuild();\n";rhs+="this.def_scope = _scopes;\n"}return rhs+="return ",rhs+=gen,rhs+=";})",eval(rhs)(eden.root,scope)},Eden.AST.ScopedScript=function(e,t){this.type="scopedscript",this.statements=e,this.scope=t},Eden.AST.ScopedScript.prototype.execute=function(e,t,n,r){return this.statements},Eden.AST.ScopePath=function(){this.type="scopepath",this.errors=[],this.primary=void 0,this.path=new Eden.AST.Primary,this.scopestr=void 0},Eden.AST.ScopePath.prototype.prepend=function(e){this.path.prepend(e)},Eden.AST.ScopePath.prototype.setObservable=function(e){this.path.setObservable(e)},Eden.AST.ScopePath.prototype.setBackticks=function(e){this.path.setBackticks(e)},Eden.AST.ScopePath.prototype.getObservable=function(){return this.primary.getObservable()},Eden.AST.ScopePath.prototype.getScopeString=function(){return this.scopestr},Eden.AST.ScopePath.prototype.setPrimary=function(e){this.primary=e,this.primary.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.ScopePath.prototype.generate=function(e,t,n){var r=this.path.generate(e,t,{bound:!0,scopeonly:!0});return this.primary.generate(e,r,n)},Eden.AST.ScopePath.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.ScopePattern=function(){this.type="scopepattern",this.observable="NONAME",this.components=[],this.errors=[]},Eden.AST.ScopePattern.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.ScopePattern.prototype.setObservable=function(e){this.observable=e},Eden.AST.ScopePattern.prototype.addListIndex=function(e){this.components.push(e),e&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Script=function(){this.type="script",Eden.AST.BaseScript.apply(this),this.name=void 0,this.active=!1,this.base=void 0,this.prefix="",this.postfix="",this.readables=null,this.writables=null},Eden.AST.registerScript(Eden.AST.Script),Eden.AST.Script.prototype.getActionByName=function(e){for(var t=0;t<this.statements.length;t++)if("script"==this.statements[t].type&&this.statements[t].name==e)return this.statements[t]},Eden.AST.Script.prototype.getSource=function(){return this.prefix+this.getInnerSource()+this.postfix},Eden.AST.Script.prototype.getInnerSource=function(){for(var e="",t=0;t<this.statements.length;t++)e+=this.statements[t].getSource();return e},Eden.AST.Script.prototype.patchInner=function(e){for(var t=this;t.parent;)t=t.parent;for(var n=[],r=[],i=Eden.Selectors.getID(this),s={},o=0;o<this.statements.length;o++){void 0===s[(a=this.statements[o]).id]&&(s[a.id]=[]),s[a.id].push(a)}for(o=0;o<e.statements.length;o++){var a;(a=e.statements[o]).buildID(),s[a.id]&&s[a.id].length>0?(e.replaceChild(o,s[a.id][0]),s[a.id].shift(),0==s[a.id].length&&delete s[a.id]):("dummy"!=a.type&&this.indexed&&a.addIndex(),"dummy"==a.type?n.push({index:o,path:i,source:a.getSource(),id:a.previousSibling?a.previousSibling.id:0,ws:!0}):n.push({index:o,path:i,source:a.getSource(),ws:!1}))}for(var d in s){var h=s[d];for(o=0;o<h.length;o++)"when"==h[o].type&&h[o].enabled&&eden.project.removeAgent(h[o]),"dummy"==h[o].type?r.push({path:i,id:h[o].previousSibling?h[o].previousSibling.id:0,ws:!0}):r.push({path:i,id:h[o].id,ws:!1}),this.indexed&&0==h[o].executed?h[o].removeIndex():h[o].destroy()}if(void 0===this.parent)for(o=0;o<e.statements.length;o++)"script"==e.statements[o].type&&"ACTIVE"==e.statements[o].name?(e.statements[o]=eden.root,Eden.Index.remove(e.statements[o])):e.statements[o].parent=this;else for(o=0;o<e.statements.length;o++)e.statements[o].parent=this;return this.statements=e.statements,[n,r]},Eden.AST.Script.prototype.patchOuter=function(e){},Eden.AST.Script.prototype.getLine=function(){return this.line},Eden.AST.Script.prototype.isRemote=function(){for(var e=this;e.parent;)e=e.parent;return e.base.origin.remote},Eden.AST.Script.prototype.setLocals=function(e){this.locals=e,e&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Script.prototype.subscribeDynamic=function(e,t){return eden.root.lookup(t)},Eden.AST.Script.prototype.getParameterByNumber=function(e){if(this.parameters)return this.parameters[e-1]},Eden.AST.Script.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.Script.prototype.setName=function(e,t){this.name=t,this.shortName=t},Eden.AST.Script.prototype.setReadables=function(e){this.readables=e},Eden.AST.Script.prototype.setWritables=function(e){this.writables=e},Eden.AST.Script.prototype.setSource=function(e,t,n){if(this.start=e,this.end=t,n){0==this.statements.length||(this.prefix=n.substring(0,this.statements[0].start-e),this.postfix=n.substring(this.statements[this.statements.length-1].end-e)),this.numlines=0;for(var r=0;r<this.prefix.length;r++)"\n"==this.prefix.charAt(r)&&this.numlines++;for(r=0;r<this.postfix.length;r++)"\n"==this.postfix.charAt(r)&&this.numlines++}},Eden.AST.Script.prototype.execute=function(e,t,n,r){var i=[];if(this.executed=1,this.locals&&this.locals.list.length>0){void 0===e.locals&&(e.locals={});for(var s=0;s<this.locals.list.length;s++)e.locals[this.locals.list[s]]=new Eden.AST.Local(this.locals.list[s])}for(s=0;s<this.statements.length;s++)"script"!=this.statements[s].type&&"section"!=this.statements[s].type&&i.push(this.statements[s]);return i},Eden.AST.Script.prototype.generate=function(e,t){for(var n="{\n",r=0;r<this.statements.length;r++)n+=this.statements[r].generate(e,t,{bound:!1});return n+="}"},Eden.AST.Virtual=function(e){this.type="script",Eden.AST.BaseScript.apply(this),this.name=e},Eden.AST.Virtual.prototype.getSource=function(){return""},Eden.AST.Virtual.prototype.getInnerSource=function(){return""},Eden.AST.ScriptExpr=function(){this.type="scriptexpr",this.errors=[],this.statements=[],this.locals={},this.dependencies={}},Eden.AST.ScriptExpr.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.ScriptExpr.prototype.append=function(e){this.statements.push(e),e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.ScriptExpr.prototype.generate=function(e,t){for(var n="(function(escope) {\nescope.isolate = true;\nif (cache) cache.scope = escope;\nvar context = new Eden.AST.Context(context);\nescope.context = context;\n",r=0;r<this.statements.length;r++){if("declarations"==this.statements[r].type&&"oracle"==this.statements[r].kind)for(var i=0;i<this.statements[r].list.length;i++)e.dependencies[this.statements[r].list[i]]=!0,e.isconstant=!1;n+=this.statements[r].generate(e,"escope",{bound:!1})}return n=n+"}).call(this,new Scope(context,"+t+",[],false,this,false))"},Eden.AST.Subscribers=function(){this.type="subscribers",Eden.AST.BaseStatement.apply(this),this.list=[],this.lvalue=void 0},Eden.AST.Subscribers.prototype.left=function(e){this.lvalue=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Subscribers.prototype.execute=function(e,t,n){},Eden.AST.Subscribers.prototype.setList=function(e){this.list=e},Eden.AST.registerStatement(Eden.AST.Subscribers),Eden.AST.Switch=function(){this.type="switch",Eden.AST.BaseStatement.apply(this),this.expression="",this.statement=void 0,this.compiled=void 0},Eden.AST.Switch.prototype.setExpression=function(e){this.expression=e,e&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Switch.prototype.setStatement=function(e){this.statement=e,this.errors.push.apply(this.errors,e.errors)},Eden.AST.Switch.prototype.generate=function(e,t){void 0===t&&(t="eden.root.scope");var n="switch(";return n+=this.expression.generate(e,t,{bound:!1}),n+=") "+this.statement.generate(e,t)},Eden.AST.Switch.prototype.getSelector=function(ctx){if(this.compiled)return this.compiled;var cond="(function(context,scope) { return ";return cond+=this.expression.generate(ctx,"scope",{bound:!1}),cond+=";})",this.compiled=eval(cond),this.compiled},Eden.AST.Switch.prototype.execute=function(e,t,n,r){var i=new Eden.RuntimeError(t,Eden.RuntimeError.NOTSUPPORTED,this,"Switch not supported here");i.line=this.line,this.errors.push(i),Eden.Agent.emit("error",[r,i])},Eden.AST.registerStatement(Eden.AST.Switch),Eden.AST.TernaryOp=function(e){this.type="ternaryop",this.op=e,this.errors=[],this.first=void 0,this.second=void 0,this.condition=void 0,this.warning=void 0},Eden.AST.TernaryOp.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.TernaryOp.prototype.setFirst=function(e){this.first=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors),e&&e.warning&&(this.warning=e.warning)},Eden.AST.TernaryOp.prototype.setSecond=function(e){this.second=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors),e&&e.warning&&(this.warning=e.warning)},Eden.AST.TernaryOp.prototype.setCondition=function(e){this.condition=e,e.errors.length>0&&this.errors.push.apply(this.errors,e.errors),e&&e.warning&&(this.warning=e.warning)},Eden.AST.TernaryOp.prototype.left=function(e){void 0===this.condition?this.condition=e:this.first=e,e&&e.warning&&(this.warning=e.warning)},Eden.AST.TernaryOp.prototype.generate=function(e,t,n){var r=this.first.generate(e,t,n);e&&e.isdynamic&&(e.dynamic_source+=" if ");var i=this.condition.generate(e,t,{bound:!1,usevar:n.usevar});return e&&e.isdynamic&&(e.dynamic_source+=" else "),"(("+i+")?("+r+"):("+this.second.generate(e,t,n)+"))"},Eden.AST.TernaryOp.prototype.execute=function(ctx,base,scope){var rhs="(function(context,scope) { return ";return rhs+=this.generate(ctx,"scope",{bound:!1}),rhs+=";})",eval(rhs)(eden.root,scope)},Eden.AST.UnaryOp=function(e,t){this.type="unaryop",this.op=e,this.errors=t.errors,this.r=t},Eden.AST.UnaryOp.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.UnaryOp.prototype.generate=function(ctx,scope,options){if("eval"==this.op){var tmpconst=ctx.isconstant,tmpdep=ctx.dependencies,tmpdynsrc=ctx.dynamic_source;ctx.dependencies={};var val=this.r.execute(ctx,null,eden.root.scope);return ctx.isconstant=tmpconst,ctx.dependencies=tmpdep,val=Eden.edenCodeForValue(val),ctx&&ctx.isdynamic&&(ctx.dynamic_source=tmpdynsrc+val),val}var tmpconst;ctx&&ctx.isdynamic&&(ctx.dynamic_source+=this.op),ctx&&(tmpconst=ctx.isconstant,ctx.isconstant=!0);var r=this.r.generate(ctx,scope,{bound:!1,usevar:options.usevar}),res,wasconst=!1;if(ctx&&(wasconst=ctx.isconstant,ctx.isconstant=tmpconst&&wasconst),"!"==this.op)res="!("+r+")";else if("&"==this.op){if(ctx&&ctx.dependencies)if(this.r.name);else if(wasconst){var btickval="ERROR";try{btickval=eval(r)}catch(e){}btickval=JSON.stringify(btickval),r=btickval}res="context.lookup("+r+")"}else"-"==this.op?res="-("+r+")":"*"==this.op&&(res="this.subscribeDynValue(0, "+r+", "+scope+")");return options.bound?"new BoundValue("+res+","+scope+")":res},Eden.AST.UnaryOp.prototype.execute=function(ctx,base,scope){var rhs="(function(context,scope) { return ";return rhs+=this.generate(ctx,"scope",{bound:!1}),rhs+=";})",eval(rhs)(eden.root,scope)},Eden.AST.Wait=function(){this.type="wait",Eden.AST.BaseStatement.apply(this),this.delay=void 0,this.compiled_delay=void 0},Eden.AST.Wait.prototype.setDelay=function(e){this.delay=e,e&&e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Wait.prototype.compile=function(ctx){if(void 0!==this.delay&&!this.compiled_delay){var source="(function(context,scope) { return ";source+=this.delay.generate(ctx,"scope",{bound:!1}),source+=";})",this.compiled_delay=eval(source)}},Eden.AST.Wait.prototype.generate=function(e,t){var n=new Eden.RuntimeError(e,Eden.RuntimeError.NOTSUPPORTED,this,"Cannot use 'wait' here");return this.errors.push(n),eden.emit("error",[EdenSymbol.defaultAgent,n]),""},Eden.AST.registerStatement(Eden.AST.Wait),Eden.AST.When=function(){this.type="when",Eden.AST.BaseContext.apply(this),this.name="*When",this.id=0,this.expression=void 0,this.active=!1,this.compiled=void 0,this.scope=void 0,this.compScope=void 0,this.local=!1,this.dirty=!1,this.statement=void 0,this.enabled=!1,this.statements=[],this.retrigger=!1,this.roles=null,this.triggercount=0,this.refreshtimeout=null},Eden.AST.registerContext(Eden.AST.When),Eden.AST.When.prototype.getSource=function(){return this.statement?this.prefix+this.statement.getSource()+this.postfix:this.prefix+this.postfix},Eden.AST.When.prototype.setSource=function(e,t,n){if(this.start=e,this.end=t,n){this.statement?(this.prefix=n.substring(0,this.statement.start-e),this.postfix=n.substring(this.statement.end-e)):(this.prefix=n.substring(0,t),this.postfix=""),this.numlines=0;for(var r=0;r<this.prefix.length;r++)"\n"==this.prefix.charAt(r)&&this.numlines++;for(r=0;r<this.postfix.length;r++)"\n"==this.postfix.charAt(r)&&this.numlines++}},Eden.AST.When.prototype.getLine=function(){return this.line},Eden.AST.When.prototype.doDebug=function(){return this.doxyComment&&this.doxyComment.getControls()["@debug"]},Eden.AST.When.prototype.setScope=function(e){this.scope=e},Eden.AST.When.prototype.subscribeDynamic=function(e,t,n){return console.log("Subscribe Dyn: ",t,n),eden.project.addTrigger(this,t,n),eden.root.lookup(t)},Eden.AST.When.prototype.setExpression=function(e){this.expression=e,e&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.When.prototype.setStatement=function(e){this.statement=e,e&&(this.statements.push(e),this.errors.push.apply(this.errors,e.errors))},Eden.AST.When.prototype.generate=function(e){var t=new Eden.RuntimeError(e,Eden.RuntimeError.NOTSUPPORTED,this,"Cannot use 'when' here");return this.errors.push(t),eden.emit("error",[EdenSymbol.defaultAgent,t]),""},Eden.AST.When.prototype.compile=function(base){var cond="(function(context,scope) { try { return ";if(cond+=this.expression.generate(this,"scope",{bound:!1}),cond+="; } catch(e) {} })",this.compiled=eval(cond),this.scope&&void 0===this.compScope)try{this.compScope=eval("(function (context, scope) { var s = "+this.scope.generateConstructor(this,"scope")+"; s.rebuild(); return s; })")}catch(e){}return""},Eden.AST.When.prototype.trigger=function(){if(this.enabled){var e=eden.root.scope,t=eden.project.ast;if(0==this.active){if(this.triggercount++,this.triggercount>1e3){"*When"==this.name&&this.parent&&this.parent.name&&(this.name=this.parent.name+">when"),this.enabled=!1;var n=new Eden.RuntimeError(t,Eden.RuntimeError.INFINITEWHEN,this);return this.errors.push(n),n.line=this.line,void eden.emit("error",[this,n])}this.refreshtimeout||(this.refreshtimeout=setTimeout(()=>{this.refreshtimeout=null,this.triggercount=0},5e3)),this.active=!0;var r=this.executeReal(this,t,e||eden.root.scope);if(r&&(void 0===eden.peer||eden.peer.authoriseWhen(this))){var i=this;t.executeStatements(r,-1,this,function(){i.active=!1,i.retrigger&&(i.retrigger=!1,setTimeout(function(){i.trigger()},0))},this)}else this.active=!1}else this.retrigger=!0}},Eden.AST.When.prototype.executeReal=function(e,t,n){this.executed=1,this.compiled||this.compile(t),this.doxyComment&&this.doxyComment.getControls()["@local"]&&(this.local=!0),this.locals={};if(void 0!==n&&n!==eden.root.scope||(n=this.compScope?this.compScope.call(this,eden.root,eden.root.scope):eden.root.scope),n.range){n.range=!1;for(var r=[];;){var i=n.clone();if(this.compiled.call(this,eden.root,n)?r.push(new Eden.AST.ScopedScript(this.statement.statements,i)):this.executed=2,0==n.next())break}return n.range=!0,r}if(this.compiled.call(this,eden.root,n))return n!==eden.root.scope&&"script"==this.statement.type?[new Eden.AST.ScopedScript(this.statement.statements,n)]:[this.statement];this.executed=2},Eden.AST.When.prototype.execute=function(e,t,n,r){this.enabled||(this.doxyComment&&this.doxyComment.getControls()["@local"]&&(this.local=!0),eden.project.registerAgent(this)),this.enabled=!0,r&&!r.loading&&t.executeStatements(this.executeReal(e,t,n,r),-1,this,void 0,this)},Eden.AST.When.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.While=function(){this.type="while",Eden.AST.BaseStatement.apply(this),this.condition=void 0,this.statement=void 0,this.compiled=void 0},Eden.AST.While.prototype.setCondition=function(e){this.condition=e,this.errors.push.apply(this.errors,e.errors)},Eden.AST.While.prototype.setStatement=function(e){this.statement=e,e&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.While.prototype.generate=function(e,t){var n="while ("+this.condition.generate(e,t,{bound:!1});return n+=") ",n+=this.statement.generate(e,t)+"\n"},Eden.AST.While.prototype.getCondition=function(ctx){if(this.compiled)return this.compiled;var express=this.condition.generate(ctx,"scope",{bound:!1}),expfunc=eval("(function(context,scope){ return "+express+"; })");return this.compiled=expfunc,expfunc},Eden.AST.While.prototype.execute=function(e,t,n,r){if(this.executed=1,this.getCondition(e)(eden.root,n))return[this.statement,this]},Eden.AST.registerStatement(Eden.AST.While),Eden.AST.Query=function(){this.type="query",Eden.AST.BaseStatement.apply(this),this.selector=void 0,this.observable=void 0,this.restypes=[],this.modexpr=void 0,this.kind="=",this._expr=void 0,this._selector=null,this._modexpr=null},Eden.AST.Query.prototype.setSelector=function(e){this.selector=e,e&&e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Query.prototype.setResultTypes=function(e){this.restypes=e},Eden.AST.Query.prototype.setModify=function(e,t){this.modexpr=e,this.kind=t,e&&e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Query.prototype.generate=function(e,t,n){var r="";if(e&&e.isdynamic&&(e.dynamic_source+="?("),0==this.restypes.length)if(this._expr)r=this._expr.expression.generate(e,t,n);else{let n=this.selector.execute(e,this,t,this);Eden.Selectors.query(n,void 0,{minimum:1},n=>{n.length>0&&n[0].expression&&(n.length>1&&(e.warning=new Eden.RuntimeWarning(this,Eden.RuntimeWarning.AMBIGUITY,"Multiple results for query")),this._expr=n[0],e.execute(e,this,t,this),console.log("RE EXECUTE"))})}else{var i=this.selector.generate(e,t,{bound:!1});if(this.modexpr){var s=new Eden.RuntimeError(e,Eden.RuntimeError.NOTSUPPORTED,this,"Cannot use '?' on lhs here");return this.errors.push(s),eden.emit("error",[EdenSymbol.defaultAgent,s]),""}r="Eden.Selectors.queryPromise("+i+', "'+this.restypes.join(",")+'", {minimum: 1})'}return e&&e.isdynamic&&(e.dynamic_source+=")",this.restypes.length>0&&(e.dynamic_source+="["+this.restypes.join(",")+"]")),n.bound?"new BoundValue("+r+","+t+")":r},Eden.AST.Query.prototype.execute=function(e,t,n,r){if(this.executed=1,this.observable){var i=eden.root.lookup(this.observable).value(n);return console.log(i),void(t.lastresult=i)}if(void 0===this.modexpr){if(this._expr)return this._expr;Eden.Selectors.query(this.selector.execute(e,t,n,r),this.restypes,{minimum:1},n=>{t.lastresult=n,this._expr=n[0],e.cb&&e.cb(n)})}else{var s=this.selector.execute(e,t,n,r),o=this.modexpr.execute(e,t,n,r);switch(this.kind){case"=":Eden.Selectors.assign(s,this.restypes,o);break;case"+=":Eden.Selectors.append(s,this.restypes,o);break;case"//=":Eden.Selectors.concat(s,this.restypes,o)}}},Eden.AST.registerStatement(Eden.AST.Query),Eden.AST.Alias=function(){this.type="script",Eden.AST.BaseStatement.apply(this),this.name=void 0,this.active=!1,this.selector=void 0,this._statements=null,this.lock=1},Eden.AST.Alias.prototype.setName=function(e){this.name=e},Eden.AST.Alias.prototype.setSelector=function(e){this.selector=e,e&&e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Alias.prototype.execute=function(e,t,n,r){var i=[];if(this.executed=1,this.locals&&this.locals.list.length>0){void 0===e.locals&&(e.locals={});for(var s=0;s<this.locals.list.length;s++)e.locals[this.locals.list[s]]=new Eden.AST.Local(this.locals.list[s])}for(s=0;s<this.statements.length;s++)"script"!=this.statements[s].type&&"section"!=this.statements[s].type&&i.push(this.statements[s]);return i},Eden.AST.Alias.prototype.generate=function(e,t,n){},Eden.AST.registerScript(Eden.AST.Alias),Eden.AST.Alias.prototype.getNumberOfLines=function(){return this.numlines},Object.defineProperty(Eden.AST.Alias.prototype,"statements",{get:function(){if(!this._statements&&this.selector){var e=this.selector.execute(this,eden.project?eden.project.ast:{},eden.root.scope,this);Eden.Selectors.query(e,void 0,{minimum:1},e=>{1==e.length&&"script"==e[0].type?(this._statements=e[0].statements,e[0].parent=this.parent):this._statements=e;for(let e=0;e<this._statements.length;e++)"dummy"!=this._statements[e].type&&this._statements[e].addIndex()})}return this._statements?this._statements:[]}}),Eden.AST.Alias.addIndex=function(){this.buildID(),Eden.Index.update(this)},Eden.AST.Alias.removeIndex=function(){Eden.Index.remove(this)},Eden.AST.Alias.prototype.destroy=function(){if(this.executed<1&&Eden.Index.remove(this),this._statements)for(var e=0;e<this._statements.length;e++)this._statements[e].destroy();this.executed=-1,this._statements=void 0,this.base=void 0,this.parent=void 0,this.nextSibling=void 0,this.previousSibling=void 0},Eden.AST.Alias.prototype.getInnerSource=function(){for(var e="",t=0;t<this._statements.length;t++)e+=this._statements[t].getSource();return e},Eden.AST.Indexed=function(){this.type="indexed",this.indexes=[],this.expression=void 0,this.errors=[]},Eden.AST.Indexed.prototype.left=Eden.AST.fnEdenASTleft,Eden.AST.Indexed.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.Indexed.prototype.setExpression=function(e){this.expression=e,e&&e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Indexed.prototype.addIndex=function(e){this.indexes.push(e),e&&e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Indexed.prototype.generate=function(e,t,n){for(var r="",i=0;i<this.indexes.length;i++)r+=this.indexes[i].generate(e,t,n);var s="("+this.expression.generate(e,t,{bound:!1})+")"+r;return n.bound?"new BoundValue("+s+","+t+")":s},Eden.AST.Section=function(){this.type="section",Eden.AST.BaseStatement.apply(this),this.name=void 0,this.depth=1},Eden.AST.Section.prototype.setName=function(e){this.name=e;var t=e.match(/#[\w]+/g);null!==t&&(void 0===this.tags?this.tags=t:this.tags=this.tags.concat(t))},Eden.AST.Section.prototype.generate=function(e,t){return""},Eden.AST.Section.prototype.execute=function(e,t,n,r){for(var i=[],s=this.nextSibling;s&&("section"!=s.type||s.depth>this.depth);)"dummy"!=s.type&&"script"!=s.type&&"section"!=s.type&&i.push(s),s=s.nextSibling;return i},Eden.AST.registerStatement(Eden.AST.Section),Eden.AST.Section.prototype.getRange=function(e){for(var t=this.getStartLine(e),n=this.nextSibling;n&&n.nextSibling&&("section"!=n.nextSibling.type||n.nextSibling.depth>this.depth);)n=n.nextSibling;return n&&"dummy"==n.type&&(n=n.previousSibling),[t,n?n.getEndLine(e):t+this.getNumberOfLines()]},Eden.AST.CustomBlock=function(){this.type="custom",Eden.AST.BaseStatement.apply(this),this.name=null,this.text=null},Eden.AST.CustomBlock.prototype.setName=function(e){this.name=e;var t=e.match(/#[\w]+/g);null!==t&&(void 0===this.tags?this.tags=t:this.tags=this.tags.concat(t))},Eden.AST.CustomBlock.prototype.generate=function(e,t){return""},Eden.AST.CustomBlock.prototype.execute=function(e,t,n,r){this.executed=1,eden.root.lookup("script_"+this.name+"_execute").assign(this.text,n);return[]},Eden.AST.registerStatement(Eden.AST.CustomBlock),Eden.AST.Async=function(){this.type="async",this.errors=[],this.expression=null,this.warning=void 0},Eden.AST.Async.prototype.setExpression=function(e){this.expression=e,e&&e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Async.prototype.generate=function(e,t){return this.expression.generate(e,t,{bound:!1})},Eden.AST.Async.prototype.execute=function(e,t,n){},Eden.AST.Async.prototype.error=Eden.AST.fnEdenASTerror;var htmltags={h1:!0,h2:!0,h3:!0,h4:!0,h5:!0,h6:!0,input:!0,form:!0,p:!0,div:!0,span:!0,b:!0,i:!0,ul:!0,ol:!0,li:!0,button:!0,a:!0,img:!0,canvas:!0,video:!0};function patchDOM(e,t,n){if(t&&e){if("string"==typeof t||"number"==typeof t){if(e.childNodes[n]&&"#text"==e.childNodes[n].nodeType)return void(e.childNodes[n].textContent!=t&&(e.childNodes[n].textContent=t));t=document.createTextNode(t)}if(Array.isArray(t)){for(var r=0,i=0;i<t.length;i++)r+=patchDOM(e,t[i],n+i);return r}if(!e.childNodes||e.childNodes.length<=n)try{e.appendChild(t)}catch(e){}else if(e.childNodes[n]===t);else{console.log("PATCH DOM",t);try{e.replaceChild(t,e.childNodes[n])}catch(e){}}return 1}}rt.patchDOM=patchDOM,rt.cleanDOM=function(e,t){if(e&&e.childNodes)for(;e.childNodes.length>t;)e.removeChild(e.lastChild)};var classSym=Symbol("classname"),classcount=1;function cssFromObject(e){var t=[],n="{";for(var r in e){var i=r.charAt(0);":"==i||"."==i||"#"==i||"@"==i?t.push(r+cssFromObject(e[r]).join(r+": ")):htmltags.hasOwnProperty(r.split(/\s|\.|#|:/)[0])?t.push(r+" "+cssFromObject(e[r]).join(r+": ")):n+=camel2Dash(r)+": "+e[r]+";\n"}return[n+"}\n"].concat(t)}rt.setStyle=function(e,t){if("string"==typeof t)e.setAttribute("style",t);else{var n,r=document.getElementById("dynastyles");r||((r=document.createElement("style")).setAttribute("id","dynastyles"),document.head.appendChild(r));var i=r.sheet;(n=t[classSym])||(n="class"+classcount,classcount++,t[classSym]=n);for(var s=cssFromObject(t),o=0;o<s.length;o++){var a=s[o].charAt(0);":"==a||"."==a||"#"==a?i.insertRule("."+n+s[o],i.cssRules.length):i.insertRule("."+n+" "+s[o],i.cssRules.length)}if(n){var d=e.className?e.className.split(" "):[];-1==d.indexOf(n)&&(d.push(n),e.className=d.join(" "))}}};var attributemapping={class:"className"},svgtags={svg:!0,rect:!0};function _diff(e,t){var n=new diff_match_patch,r=n.diff_main(e,t);n.diff_cleanupSemantic(r);for(var i="",s=0,o=0;o<r.length;o++){var a=r[o][1].match(/[\n]+/g);if(0!=r[o][0]){if(1==r[o][0])i+="<div>line:"+(s+1)+' + <span style="background: #ddffdd;">'+EdenUI.Highlight.html(r[o][1])+"</span></div>",null!==a&&(s+=a.length);else if(2==r[o][1]){i+="<div>line:"+(s+1)+' - <span style="background: #ffdddd;">'+EdenUI.Highlight.html(r[o][1])+"</span></div>",null!==a&&(s-=a.length)}}else null!==a&&(s+=a.length)}return i}function sortByCount(e){var t=e.reduce(function(e,t){return e[t]=(e[t]||0)+1,e},{});return Object.keys(t).sort(function(e,n){return t[e]<t[n]})}function reduceByCount(e,t){var n=e.reduce(function(e,t){return e[t]=(e[t]||0)+1,e},{}),r=[];for(var i in n)n[i]>=t&&r.push(i);return r}function negativeFilter(e,t){for(var n=t.reduce(function(e,t){return e[t]=(e[t]||0)+1,e},{}),r=[],i=0;i<e.length;i++)n[e[i]]||r.push(e[i]);return r}function sortByLoaded(e){for(var t=[],n=[],r=0;r<e.length;r++)Eden.Agent.agents[e[r]]?t.push(e[r]):n.push(e[r]);return t.push.apply(t,n),t}function runEdenAction(e,t,n){var r=this;void 0===t&&(e.active=!1);var i=t.next();if(0==i.done)if("object"==typeof i.value){if(Eden.AST.debug&&"debug"==i.value.type){i.value.next=function(){runEdenAction.call(r,e,t,n)},i.value.statement&&Eden.AST.debugbreakpoint===i.value.statement?Eden.AST.debugbreakpoint_cb&&Eden.AST.debugbreakpoint_cb(i.value):Eden.AST.debugstep_cb&&setTimeout(function(){Eden.AST.debugstep_cb(i.value)},0)}else if("import"==i.value.type)i.value.executed=1,Eden.Selectors.query(i.value.selector,void 0,{context:i.value.parent,minimum:1,options:{external:!0,index:!0}},function(s){if(void 0===s){var o=new Eden.RuntimeError(r,Eden.RuntimeError.UNKNOWN,i.value,"Selector '"+i.value.selector+"' has no results");o.line=i.value.line,i.value.errors.push(o)}else i.value.statements=s;runEdenAction.call(r,e,t,n)});else if("query"==i.value.type){function s(i){runEdenAction.call(r,e,t,n)}switch(i.value.kind){case"=":Eden.Selectors.assign(i.value._selector,i.value.restypes,i.value._modexpr,i.value,s);break;case"+=":Eden.Selectors.append(i.value._selector,i.value.restypes,i.value._modexpr,i.value,s);break;case"//=":Eden.Selectors.concat(i.value._selector,i.value.restypes,i.value._modexpr,i.value,s)}}else if("do"==i.value.type){function s(s){if(s&&s.length>0){var o=i.value.params,a=i.value.nscope;if(i.value.attribs.atomic&&eden.root.beginAutocalcOff(),a.range){a.range=!1;for(var d=[];;){var h=a.clone();if(d.push(new Eden.AST.ScopedScript(s,h)),0==a.next())break}a.range=!0,r.executeStatements(d,void 0,e,function(){i.value.attribs.atomic&&eden.root.endAutocalcOff(),runEdenAction.call(r,e,t,n)},{parameters:o},a)}else r.executeStatements(s,void 0,e,function(){i.value.attribs.atomic&&eden.root.endAutocalcOff(),runEdenAction.call(r,e,t,n)},{parameters:o},a)}else{var c=new Eden.RuntimeWarning(i.value,Eden.RuntimeWarning.EMPTYDO,i.value.selector);c.line=i.value.line,i.value.warning=c,eden.emit("warning",[e,c]),i.value.attribs.atomic&&eden.root.endAutocalcOff(),runEdenAction.call(r,e,t,n)}}i.value.name?Eden.Selectors.query(i.value.selector,void 0,{options:{self:i.value},context:i.value.parent,minimum:1},s):s(i.value.script.statements)}}else 0==i.value?runEdenAction.call(this,e,t,n):i.value>0&&setTimeout(function(){runEdenAction.call(r,e,t,n)},i.value);else e.active=!1,n&&n()}Eden.AST.HTML=function(){this.type="html",this.errors=[],this.name=null,this.attributes=null,this.contents=null},Eden.AST.HTML.prototype.setName=function(e){this.name=e},Eden.AST.HTML.prototype.generate=function(e,t,n){var r="(function($o) {\n",i=null;if(this.attributes&&this.attributes.hasOwnProperty("xmlns")?i=this.attributes.xmlns.value:parent&&parent.attributes&&parent.attributes.hasOwnProperty("xmlns")?i=parent.attributes.xmlns.value:svgtags.hasOwnProperty(this.name.toLowerCase())?i="http://www.w3.org/2000/svg":parent&&svgtags.hasOwnProperty(parent.name)&&(i="http://www.w3.org/2000/svg"),r+=null!==i?'let ele = ($o) ? $o : document.createElementNS("'+i+'", "'+this.name+'");\n':'let ele = ($o && $o.nodeName == "'+this.name+'") ? $o : document.createElement("'+this.name+'");\n',null!==this.attributes)for(var s in this.attributes)"xmlns"!=s&&(s.startsWith("on")?"primary"!=this.attributes[s].type||(void 0===this.attributes[s].backticks?r+='ele["'+s.toLowerCase()+'"] = function(e) { eden.root.lookup("'+this.attributes[s].observable+'").assign(e, eden.root.scope, EdenSymbol.hciAgent); };\n':r+='ele["'+s.toLowerCase()+'"] = function(e) { eden.root.lookup('+this.attributes[s].backticks.generate(e,t,n)+").assign(e, eden.root.scope, EdenSymbol.hciAgent); };\n"):r+="style"==s?"rt.setStyle(ele, "+this.attributes[s].generate(e,t,n)+");\n":'ele.setAttribute("'+s+'",'+this.attributes[s].generate(e,t,n)+");\n");if(null!==this.contents){r+="let count=0;\n";for(var o=0;o<this.contents.length;o++)r+="let item = "+this.contents[o].generate(e,t,n),"html"==this.contents[o].type?r+="(ele.childNodes["+o+"]);\n":r+=";\n",r+="count += rt.patchDOM(ele, item, count);\n";r+="rt.cleanDOM(ele, count);\n"}return r+="return ele;\n})(this.cache.value)"},Eden.AST.HTML.prototype.addAttribute=function(e,t){null===this.attributes&&(this.attributes={}),t.errors.length>0&&this.errors.push.apply(this.errors,t.errors),this.attributes[e]=t},Eden.AST.HTML.prototype.addContent=function(e){null===this.contents&&(this.contents=[]),this.contents.push(e),e.errors.length>0&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.prototype.pACTIONBODY=function(){var e=new Eden.AST.CodeBlock,t=this.parent;return this.parent=e,"{"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONOPEN)),this.parent=t,e):(this.next(),e.setLocals(this.pLOCALS()),e.locals.errors.length>0?(this.parent=t,e):(e.setScript(this.pSCRIPT()),"}"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)),this.parent=t,e):(this.next(),this.parent=t,e)))},Eden.AST.prototype.pAFTER=function(){var e=new Eden.AST.After;if("("!=this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.AFTEROPEN)),e;this.next();var t=this.pEXPRESSION();if(e.setExpression(t),e.errors.length>0)return e;if(")"!=this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.AFTEROPEN)),e;this.next();var n=this.pSTATEMENT();return void 0===n&&e.error(new Eden.SyntaxError(this,Eden.SyntaxError.AFTERNOSTATEMENT)),e.setStatement(n),e.warning=new Eden.SyntaxWarning(this,e,Eden.SyntaxWarning.DEPRECATED,"'after' should not be used, use 'wait' instead"),e},Eden.AST.prototype.pPARAMS=function(){var e=new Eden.AST.Declarations;for(e.kind="oracle";"para"==this.token||"oracle"==this.token;){this.next();var t=this.pOLIST();if(e.list.push.apply(e.list,t),0==t.length||"NONAME"==t[t.length-1])return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.PARAMNAME)),e;if(";"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.PARAMSEMICOLON)),e;this.next()}return e},Eden.AST.prototype.pLOCALS=function(){for(var e=new Eden.AST.Declarations;"auto"==this.token||"local"==this.token;){if(this.next(),"when"==this.token)return this.next(),this.localStatus=!0,e=this.pWHEN(),this.localStatus=!1,e;var t=this.pOLIST();if(e.list.push.apply(e.list,t),0==t.length||"NONAME"==t[t.length-1])return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LOCALNAME)),e;if(";"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LOCALSEMICOLON)),e;this.next()}return e},Eden.AST.prototype.pDO=function(){var e=new Eden.AST.Do,t=this.parent;if(this.parent=e,"["==this.token){if(this.next(),this.pDO_ATTRIBUTES(e),"]"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.DOATTRIBCLOSE)),this.parent=t,e;this.next()}if("{"==this.token){this.next();var n=this.pSCRIPT();return n.parent=e,"}"!=this.token?(e.setScript(n),e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)),this.parent=t,e):(this.next(),e.setScript(n),this.parent=t,"with"!=this.token&&"::"!=this.token||(this.next(),e.setScope(this.pSCOPE())),e)}if("OBSERVABLE"!=this.token&&"."!=this.token&&">>"!=this.token&&">"!=this.token&&"<"!=this.token&&"<<"!=this.token&&":"!=this.token&&"*"!=this.token&&"@"!=this.token&&"#"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.DONAME)),this.parent=t,e;var r=this.pCODESELECTOR();if(e.setName(r),e.errors.length>0)return this.parent=t,e;if("with"==this.token||"::"==this.token)this.next(),e.setScope(this.pSCOPE());else if(";"!=this.token)for(var i=this.pELIST(),s=0;s<i.length;s++)if(e.addParameter(i[s]),e.errors.length>0)return this.parent=t,e;return";"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)),this.parent=t,e):(this.next(),this.parent=t,e)},Eden.AST.prototype.pDO_ATTRIBUTES=function(e){for(;;){if("OBSERVABLE"!=this.token)return void e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.DOBADATTRIB));switch(this.data.value){case"atomic":e.setAttribute(this.data.value,!0);break;case"nonatomic":e.setAttribute(this.data.value,!0),e.setAttribute("atomic",!1);break;default:return void e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.DOBADATTRIB))}if(this.next(),","!=this.token)break;this.next()}},Eden.AST.prototype.pEXPRESSION_PPPPP=function(){if("#"==this.token)return this.next(),new Eden.AST.Length},Eden.AST.prototype.pEXPRESSION_PPPPPP=function(){var e;return"?"==this.token?(this.next(),(e=new Eden.AST.TernaryOp("?")).setFirst(this.pEXPRESSION()),e.warning=new Eden.SyntaxWarning(this,e,Eden.SyntaxWarning.DEPRECATED,"use of ? for 'if'."),e.errors.length>0?e:":"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.TERNIFCOLON)),e):(this.next(),e.setSecond(this.pEXPRESSION()),e)):"if"==this.token?(this.next(),(e=new Eden.AST.TernaryOp("?")).setCondition(this.pEXPRESSION()),e.errors.length>0?e:"else"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.TERNIFCOLON)),e):(this.next(),e.setSecond(this.pEXPRESSION()),e)):void 0},Eden.AST.prototype.pEXPRESSION_PLAIN=function(){for(var e=this.pTERM();"&&"==this.token||"||"==this.token||"&"==this.token||"|"==this.token||"and"==this.token||"or"==this.token;){var t=new Eden.AST.BinaryOp(this.token);this.next(),t.left(e),t.setRight(this.pTERM()),e=t}return e},Eden.AST.prototype.pEXPRESSION_ASYNC=function(){var e;return"sync"==this.token?(this.next(),(e=new Eden.AST.Async).setExpression(this.pEXPRESSION())):e=this.pEXPRESSION(),e},Eden.AST.prototype.pEXPRESSION=function(){var e;if("sync"==this.token)return(e=new Eden.AST.Async).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SYNCNOTALLOWED)),e;if("{"==this.token){if(this.next(),e=this.pSCRIPTEXPR(),"}"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)),e;this.next()}else e=this.pEXPRESSION_PLAIN();if("with"==this.token||"::"==this.token){this.next();var t=this.pSCOPE();return t.setExpression(e),t}return e},Eden.AST.prototype.pFACTOR=function(){if("("==this.token){this.next();var e=this.pEXPRESSION();return e.errors.length>0?e:(")"!=this.token?e.error(new Eden.SyntaxError(this,Eden.SyntaxError.EXPCLOSEBRACKET)):this.next(),"["==this.token||"."==this.token?((d=this.pINDEXED()).setExpression(e),d):e)}if("["==this.token){this.next();var t,n=[],r=!1;if("]"!=this.token&&("OBSERVABLE"==this.token&&58==this.stream.peek()?(n=this.pLLIST(),r=!0):n=this.pELIST()),t=r?new Eden.AST.Literal("OBJECT",n):new Eden.AST.Literal("LIST",n),r)for(var i in n){var s=n[i];s.errors.length>0&&t.errors.push.apply(t.errors,s.errors)}else for(var o=0;o<n.length;o++)n[o].errors.length>0&&t.errors.push.apply(t.errors,n[o].errors);return t.errors.length>0?t:("]"!=this.token?t.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LISTLITCLOSE)):this.next(),t)}if("@"==this.token)return this.next(),new Eden.AST.Literal("UNDEFINED","@");if("JAVASCRIPT"==this.token){var a=new Eden.AST.Literal("JAVASCRIPT",this.data.value);return this.next(),a}if("NUMBER"==this.token){a=new Eden.AST.Literal("NUMBER",this.data.value);return this.next(),a}if("?"==this.token){this.next();var d,h=this.pQUERY();return"["==this.token?((d=this.pINDEXED()).setExpression(h),d):h}if("-"==this.token)return this.next(),new Eden.AST.UnaryOp("-",this.pFACTOR());if("<"==this.token&&eden.root.lookup("jseden_parser_cs3").value())return this.pHTML();if("<<"==this.token){if(this.next(),"OBSERVABLE"!=this.token)return(a=new Eden.AST.Literal("STRING",this.data.value)).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.HEREDOCTOKEN)),a;var c=this.data.value;if(10!=this.stream.get())return(a=new Eden.AST.Literal("STRING",this.data.value)).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.HEREDOCTOKEN)),a;for(var p="";this.stream.valid();){var l=this.stream.position,u=this.stream.readLine();if(u.startsWith(c)){this.stream.position=l+c.length;break}p+=u}return this.stream.valid()||this.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.NEWLINE)),this.next(),a=new Eden.AST.Literal("STRING",p.slice(0,-1).replace(/\\/g,"\\\\").replace(/"/g,'\\"'))}if("STRING"==this.token){a=new Eden.AST.Literal("STRING",this.data.value);for(this.data.error||this.next();0==this.data.error&&"STRING"==this.token;)a.value+="\n"+this.data.value,this.next();return this.data.error&&("LINEBREAK"==this.data.value?a.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LITSTRLINE)):a.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LITSTRCLOSE))),a}if("BOOLEAN"==this.token){a=new Eden.AST.Literal("BOOLEAN",this.data.value);return this.next(),a}if("CHARACTER"==this.token){a=new Eden.AST.Literal("CHARACTER",this.data.value);return this.data.error?(""==this.data.value?a.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LITCHAREMPTY)):a.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LITCHARCLOSE)),a):(this.next(),a)}if("!"==this.token||"not"==this.token){this.next();var E=this.pFACTOR();return new Eden.AST.UnaryOp("!",E)}if("&"==this.token){this.next();var f=this.pLVALUE();return new Eden.AST.UnaryOp("&",f)}if("*"==this.token){this.next();f=this.pFACTOR();return new Eden.AST.UnaryOp("*",f)}if("eval"==this.token){this.next(),this.isdynamic=!0;var m=new Eden.AST.UnaryOp("eval",{errors:[]});if("("!=this.token)return m.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.EVALOPEN)),m;this.next();var g=this.pEXPRESSION();return")"!=this.token?(m.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.EVALCLOSE)),m):(this.next(),m.r=g,m.errors=g.errors,m)}return this.pPRIMARY()},Eden.AST.prototype.pFOR=function(){var e=new Eden.AST.For,t=this.parent;if(this.parent=e,"("!=this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.FOROPEN)),this.parent=t,e;if(this.next(),";"==this.token)this.next();else{if(e.setStart(this.pSTATEMENT_P(!0)),e.errors.length>0)return this.parent=t,e;if("range"!=e.sstart.type&&";"!=this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.FORSTART)),this.parent=t,e;";"==this.token&&this.next()}if("range"!=e.sstart.type){if(";"==this.token)this.next();else{if(e.setCondition(this.pEXPRESSION()),e.errors.length>0)return this.parent=t,e;if(";"!=this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.FORCOND)),this.parent=t,e;this.next()}if(")"==this.token)this.next();else{if(e.setIncrement(this.pSTATEMENT_P()),e.errors.length>0)return this.parent=t,e;if(")"!=this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.FORCLOSE)),this.parent=t,e;this.next()}}else{if(")"!=this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.FORCLOSE)),this.parent=t,e;this.next()}return e.setStatement(this.pSTATEMENT()),e.statement&&(e.statement.parent=e),e.parent=t,this.parent=t,e},Eden.AST.prototype.pFUNCTION=function(){var e=new Eden.AST.Function,t=this.parent;return this.parent=e,"OBSERVABLE"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.FUNCNAME)),this.parent=t,e):(e.name=this.data.value,this.next(),e.setBody(this.pFUNCBODY()),this.parent=t,e)},Eden.AST.prototype.pFUNCBODY=function(){var e=new Eden.AST.CodeBlock,t=this.parent;return this.parent=e,"{"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.FUNCOPEN)),this.parent=t,e):(this.next(),e.setParams(this.pPARAMS()),e.params.errors.length>0?(this.parent=t,e):(e.setLocals(this.pLOCALS()),e.locals.errors.length>0?(this.parent=t,e):(e.setScript(this.pSCRIPT()),"}"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.FUNCCLOSE)),this.parent=t,e):(this.next(),this.parent=t,e))))},Eden.AST.prototype.pIF=function(){var e=new Eden.AST.If;e.parent=this.parent;var t=this.parent;return this.parent=e,"("!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.IFCONDOPEN)),this.parent=t,e):(this.next(),e.setCondition(this.pEXPRESSION()),e.errors.length>0?(this.parent=t,e):")"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.IFCONDCLOSE)),this.parent=t,e):(this.next(),e.setStatement(this.pSTATEMENT()),e.errors.length>0?(this.parent=t,e):void 0===e.statement?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.IFNOSTATEMENT)),this.parent=t,e):(e.setElse(this.pIF_P()),this.parent=t,e)))},Eden.AST.prototype.pIF_P=function(){if("else"==this.token)return this.next(),this.pSTATEMENT()},Eden.AST.prototype.pREQUIRE=function(){var e=new Eden.AST.Require,t=this.pEXPRESSION();return e.setExpression(t),e.warning=new Eden.SyntaxWarning(this,e,Eden.SyntaxWarning.DEPRECATED,"require."),";"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)),e):(this.next(),e)},Eden.AST.prototype.pIMPORT=function(){var e=new Eden.AST.Import;e.warning=new Eden.SyntaxWarning(this,e,Eden.SyntaxWarning.DEPRECATED,"use of import, use action alias instead");var t=this.pCODESELECTOR();return void 0===t||t.errors.length>0?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.IMPORTPATH)),e):(e.setPath(t),";"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)),e):(this.next(),e))},Eden.AST.prototype.pINSERT=function(){var e=new Eden.AST.Insert;return e.setDest(this.pLVALUE()),e.errors.length>0?e:","!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.INSERTCOMMA)),e):(this.next(),e.setIndex(this.pEXPRESSION()),e.errors.length>0?e:","!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.INSERTCOMMA)),e):(this.next(),e.setValue(this.pEXPRESSION()),e.errors.length>0?e:";"!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)),e):(this.next(),e)))},Eden.AST.prototype.pDELETE=function(){var e=new Eden.AST.Delete;return e.setDest(this.pLVALUE()),e.errors.length>0?e:","!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.DELETECOMMA)),e):(this.next(),e.setIndex(this.pEXPRESSION()),e.errors.length>0?e:";"!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)),e):(this.next(),e))},Eden.AST.prototype.pAPPEND=function(){var e=new Eden.AST.Append;return e.setDest(this.pLVALUE()),e.errors.length>0?e:","!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.APPENDCOMMA)),e):(this.next(),e.setIndex(this.pEXPRESSION()),e.errors.length>0?e:";"!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)),e):(this.next(),e))},Eden.AST.prototype.pSHIFT=function(){var e=new Eden.AST.Shift;return e.setDest(this.pLVALUE()),e.errors.length>0?e:";"!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)),e):(this.next(),e)},Eden.AST.prototype.pELIST=function(){var e=this.pEXPRESSION();if(e.errors.length>0)return[e];var t=this.pELIST_P();return t.unshift(e),t},Eden.AST.prototype.pELIST_P=function(){for(var e=[];","==this.token;){this.next();var t=this.pEXPRESSION();if(e.push(t),t.errors.length>0)return e}return e},Eden.AST.prototype.pLLIST=function(){var e=this.data.value;this.next(),this.next();var t,n=this.pEXPRESSION();return n.errors.length>0?((t={})[e]=n,t):((t=this.pLLIST_P())[e]=n,t)},Eden.AST.prototype.pLLIST_P=function(){for(var e={};","==this.token;){this.next();var t=this.data.value;this.next(),this.next();var n=this.pEXPRESSION();if(e[t]=n,n.errors.length>0)return e}return e},Eden.AST.prototype.pOLIST=function(){if("OBSERVABLE"!=this.token)return[];var e=this.data.value;this.next();var t=this.pOLIST_P();return t.unshift(e),t},Eden.AST.prototype.pOLIST_P=function(){for(var e=[];","==this.token;){if(this.next(),"OBSERVABLE"!=this.token)return e.push("NONAME"),e;e.push(this.data.value),this.next()}return e},Eden.AST.prototype.pLVALUE_P=function(){for(var e=[];;)if("["==this.token){this.next();var t=new Eden.AST.LValueComponent("index"),n=this.pEXPRESSION();if(t.index(n),e.push(t),n.errors.length>0&&t.errors.unshift(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXEXP)),"literal"==t.indexexp.type&&"NUMBER"==t.indexexp.datatype&&t.indexexp.value<1&&t.error(new Eden.SyntaxError(this,Eden.SyntaxError.OUTOFBOUNDS)),"]"!=this.token)return t.error(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXCLOSE)),e;this.next()}else{if("."!=this.token)break;this.next();t=new Eden.AST.LValueComponent("index");if("OBSERVABLE"!=this.token)return t.errors.unshift(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXEXP)),e.push(t),e;n=new Eden.AST.Literal("STRING",this.data.value);this.next(),t.index(n),e.push(t)}return e},Eden.AST.prototype.pLVALUE=function(){var e=new Eden.AST.LValue;if("("==this.token){if(this.next(),"*"==this.token?(this.next(),e.setPrimary(this.pPRIMARY())):e.setPrimary(this.pPRIMARY()),")"!=this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.EXPCLOSEBRACKET)),e;this.next()}else if("*"==this.token)this.next(),e.setPrimary(this.pPRIMARY());else if("`"==this.token){if(this.next(),e.setExpression(this.pEXPRESSION()),e.errors.length>0)return e;if("`"!=this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.BACKTICK)),e;this.next()}else{if("OBSERVABLE"!=this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.LVALUE)),e;var t=this.data.value;if(this.next(),"{"==this.token){for(var n=new Eden.AST.Literal("STRING",t);"{"==this.token;){this.next();var r,i=this.pEXPRESSION();if(i.errors.length>0)return e.setExpression(i),e;if("}"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BACKTICK)),e;if(this.next(),(r=new Eden.AST.BinaryOp("//")).left(n),r.setRight(i),n=r,"OBSERVABLE"==this.token)(r=new Eden.AST.BinaryOp("//")).left(n),r.setRight(new Eden.AST.Literal("STRING",this.data.value)),n=r,this.next()}e.setExpression(n)}else e.setObservable(t)}return e.setExtras(this.pLVALUE_P()),e},Eden.AST.prototype.pPRIMARY=function(){if("`"==this.token)return this.next(),(n=this.pEXPRESSION()).errors.length>0?((r=new Eden.AST.Primary).setBackticks(n),r):"`"!=this.token?((r=new Eden.AST.Primary).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BACKTICK)),r):(this.next(),(r=this.pPRIMARY_P()).errors.length>0?r:(r.setBackticks(n),r.setObservable("__BACKTICKS__"),this.isdynamic=!0,r));if("OBSERVABLE"==this.token){var e=this.data.value;if(this.next(),"{"==this.token){for(var t=new Eden.AST.Literal("STRING",e);"{"==this.token;){var n,r,i;if(this.next(),(n=this.pEXPRESSION()).errors.length>0)return(r=new Eden.AST.Primary).setBackticks(n),r;if("}"!=this.token)return(r=new Eden.AST.Primary).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BACKTICK)),r;if(this.next(),(i=new Eden.AST.BinaryOp("//")).left(t),i.setRight(n),t=i,"OBSERVABLE"==this.token)(i=new Eden.AST.BinaryOp("//")).left(t),i.setRight(new Eden.AST.Literal("STRING",this.data.value)),t=i,this.next()}(r=this.pPRIMARY_P()).setBackticks(t),r.setObservable("__BACKTICKS__"),this.isdynamic=!0}else(r=this.pPRIMARY_P()).setObservable(e);return r}return(r=new Eden.AST.Primary).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BADFACTOR)),r},Eden.AST.prototype.pPRIMARY_P=function(){if("["==this.token){this.next();var e=new Eden.AST.Index;if("]"==this.token)return(t=new Eden.AST.Primary).prepend(e),t.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXEXP)),t;if((i=this.pEXPRESSION()).errors.length>0)return e.setExpression(i),(t=new Eden.AST.Primary).prepend(e),t;if("literal"==i.type&&"NUMBER"==i.datatype)if(i.value<1)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.OUTOFBOUNDS)),(t=new Eden.AST.Primary).prepend(e),t;if("]"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXCLOSE)),(t=new Eden.AST.Primary).prepend(e),t;this.next();var t=this.pPRIMARY_PPP();return e.setExpression(i),t.prepend(e),t}if("("==this.token){this.next();var n=new Eden.AST.FunctionCall;if(")"==this.token)return this.next(),(t=this.pPRIMARY_PP()).prepend(n),t;var r=this.pELIST();return n.setParams(r),n.errors.length>0?((t=new Eden.AST.Primary).prepend(n),t):")"!=this.token?((t=new Eden.AST.Primary).prepend(n),n.errors.length>0?t:(t.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.FUNCCALLEND)),t)):(this.next(),(t=this.pPRIMARY_PP()).errors.length>0?t:(t.prepend(n),t))}if("."==this.token){this.next();e=new Eden.AST.Index;if("OBSERVABLE"!=this.token)return(t=new Eden.AST.Primary).prepend(e),t.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXEXP)),t;var i=new Eden.AST.Literal("STRING",this.data.value);this.next();t=this.pPRIMARY_PPP();return e.setExpression(i),t.prepend(e),t}return this.pPRIMARY_PPPP()},Eden.AST.prototype.pPRIMARY_PP=function(){if("["==this.token){this.next();var e=new Eden.AST.Index;if("]"==this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXEXP)),(n=new Eden.AST.Primary).prepend(e),n;var t=this.pEXPRESSION();if(t.errors.length>0){var n=new Eden.AST.Primary;return e.setExpression(t),n.prepend(e),n}if("literal"==t.type&&"NUMBER"==t.datatype)if(t.value<1)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.OUTOFBOUNDS)),(n=new Eden.AST.Primary).prepend(e),n;if("]"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXCLOSE)),(n=new Eden.AST.Primary).prepend(e),n;this.next();n=this.pPRIMARY_PP();return e.setExpression(t),n.prepend(e),n}if("("==this.token){this.next();var r=new Eden.AST.FunctionCall;if(")"==this.token)return this.next(),(n=this.pPRIMARY_PP()).prepend(r),n;var i=this.pELIST();return r.setParams(i),")"!=this.token?((n=new Eden.AST.Primary).prepend(r),r.errors.length>0?n:(n.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.FUNCCALLEND)),n)):(this.next(),(n=this.pPRIMARY_PP()).prepend(r),n)}return this.pPRIMARY_PPPP()},Eden.AST.prototype.pPRIMARY_PPP=function(){if("["==this.token){this.next();var e=new Eden.AST.Index;if("]"==this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXEXP)),(n=new Eden.AST.Primary).prepend(e),n;var t=this.pEXPRESSION();if(t.errors.length>0){var n=new Eden.AST.Primary;return e.setExpression(t),n.prepend(e),n}if("literal"==t.type&&"NUMBER"==t.datatype)if(t.value<1)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.OUTOFBOUNDS)),(n=new Eden.AST.Primary).prepend(e),n;if("]"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXCLOSE)),(n=new Eden.AST.Primary).prepend(e),n;this.next();n=this.pPRIMARY_PP();return e.setExpression(t),n.prepend(e),n}if("("==this.token){this.next();var r=new Eden.AST.FunctionCall;if(")"==this.token)return this.next(),(n=this.pPRIMARY_PP()).prepend(r),n;var i=this.pELIST();return r.setParams(i),")"!=this.token?((n=new Eden.AST.Primary).prepend(r),r.errors.length>0?n:(n.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.FUNCCALLEND)),n)):(this.next(),(n=this.pPRIMARY_PP()).errors.length>0?n:(n.prepend(r),n))}if("."==this.token){this.next();var s=this.pPRIMARY();if(s.errors.length>0)return s;var o=new Eden.AST.ScopePath;return o.setPrimary(s),o}return this.pPRIMARY_PPPP()},Eden.AST.prototype.pPRIMARY_PPPP=function(){return new Eden.AST.Primary},Eden.AST.prototype.pACTION=function(){var e=new Eden.AST.Action,t=this.parent;if(this.parent=e,e.warning=new Eden.SyntaxWarning(this,e,Eden.SyntaxWarning.DEPRECATED,"attempt to use 'when' instead of 'proc'"),"OBSERVABLE"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.PROCNAME)),this.parent=t,e;if(e.name=this.data.value,this.next(),":"==this.token){this.next();var n=this.pOLIST();if(0==n.length)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONNOWATCH)),this.parent=t,e;if("NONAME"==n[n.length-1])return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCOMMAS)),this.parent=t,e;e.triggers=n}return e.setBody(this.pFUNCBODY()),this.parent=t,e},Eden.AST.prototype.pSCOPE=function(){if("("==this.token){this.next();var e=this.pSCOPE_P();return")"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SCOPECLOSE)),e):(this.next(),e)}return this.pSCOPE_P()},Eden.AST.prototype.pSCOPEPATTERN=function(){var e=new Eden.AST.ScopePattern;if("OBSERVABLE"!=this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.SCOPENAME)),e;for(e.setObservable(this.data.value),this.next();;)if("["==this.token){this.next();var t=this.pEXPRESSION();if(e.addListIndex(t),t.errors.length>0)return e;if("]"!=this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXCLOSE)),e;this.next()}else if("."!=this.token)break;return e},Eden.AST.prototype.pSCOPE_P=function(e){var t,n=!1,r=this.peekNext(1);if(void 0===e&&(e=1),"is"!=r&&"="!=r&&"in"!=r)(t=new Eden.AST.ScopePattern).setObservable("$"+e),e++;else{if((t=this.pSCOPEPATTERN()).errors.length>0)return(o=new Eden.AST.Scope).addOverride(t,void 0,void 0,void 0,!1),o;if("is"!=this.token&&"="!=this.token&&"in"!=this.token)return(o=new Eden.AST.Scope).error(new Eden.SyntaxError(this,Eden.SyntaxError.SCOPEEQUALS)),o;"in"==this.token&&(n=!0),this.next()}var i=this.pEXPRESSION();if(i.errors.length>0)return(o=new Eden.AST.Scope).errors.push.apply(o.errors,i.errors),o;var s=void 0;if(".."==this.token&&(this.next(),(s=this.pEXPRESSION()).errors.length>0))return(o=new Eden.AST.Scope).addOverride(t,i,s,void 0,!1),o;var o,a=void 0;if(".."==this.token&&(this.next(),(a=this.pEXPRESSION()).errors.length>0))return(o=new Eden.AST.Scope).addOverride(t,i,s,a,!1),o;return(o=this.pSCOPE_PP(e)).addOverride(t,i,s,a,n),o},Eden.AST.prototype.pSCOPE_PP=function(e){return","==this.token?(this.next(),this.pSCOPE_P(e)):new Eden.AST.Scope},Eden.AST.prototype.pNAMEDSCRIPT=function(){var e;if("OBSERVABLE"!=this.token)return(i=new Eden.AST.Script).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONNAME)),i;let t,n;if(e=this.data.value,this.next(),"("==this.token){if(this.next(),"oracle"==this.token&&(this.next(),t=this.pCODESELECTOR()),";"==this.token&&this.next(),"handle"==this.token&&(this.next(),n=this.pCODESELECTOR()),")"!=this.token)return(i=new Eden.AST.Script).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)),i;this.next()}if("is"==this.token){this.next();var r=new Eden.AST.Alias;return"?"!=this.token?(r.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ALIASQUERY)),r):(this.next(),"("!=this.token?(r.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.QUERYOPEN)),r):(this.next(),r.setSelector(this.pCODESELECTOR()),")"!=this.token?(r.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.QUERYCLOSE)),r):(this.next(),r.setName(e),";"!=this.token?(r.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)),r):(this.next(),r))))}var i;return"{"!=this.token?((i=new Eden.AST.Script).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONOPEN)),i):(this.next(),(i=this.pSCRIPT()).errors.length>0?i:(i.setName(this,e),t&&i.setReadables(t),n&&i.setWritables(n),"}"!=this.token?(i.error(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)),i):(this.next(),this.scripts[e]=i,i)))},Eden.AST.prototype.pSCRIPT=function(){var e=new Eden.AST.Script;e.parent=this.parent;var t=this.parent;this.parent=e,(s=new Eden.AST.DummyStatement).setSource(this.lastposition,this.stream.prevposition,this.stream.code.substring(this.lastposition,this.stream.prevposition)),s.numlines=s.source.match(/\n/g),null===s.numlines?s.numlines=0:s.numlines=s.numlines.length,e.append(s);for(var n=s;"EOF"!=this.token;){var r=this.pSTATEMENT();if(void 0!==r){if(r.errors.length>0){e.appendChild(r);break}var i=r.end;"dummy"==r.type&&n&&"dummy"==n.type?(n.setSource(r.start,r.end,r.source),n.numlines+=r.numlines):(e.appendChild(r),n=r);var s,o=this.stream.code.substring(i,this.stream.prevposition);if(o.length>0)(s=new Eden.AST.DummyStatement).setSource(i,this.stream.prevposition,o),s.numlines=s.source.match(/\n/g),null===s.numlines?s.numlines=0:s.numlines=s.numlines.length,n&&"dummy"==n.type?(n.setSource(s.start,s.end,s.source),n.numlines+=s.numlines):(e.appendChild(s),n=s)}else{if("}"!=this.token&&";"!=this.token&&e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.STATEMENT)),";"!=this.token)break;this.next()}}return this.parent=t,e},Eden.AST.prototype.pSCRIPTEXPR=function(){var e=new Eden.AST.ScriptExpr;e.parent=this.parent;for(this.parent;"EOF"!=this.token;){var t=this.pSTATEXPR();if(void 0!==t){if(e.append(t),t.errors.length>0)break}else{if("}"!=this.token&&";"!=this.token&&e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.STATEMENT)),";"!=this.token)break;this.next()}}return e},Eden.AST.prototype.pAGENTPATH=function(){if("OBSERVABLE"!=this.token&&void 0===Language.keywords[this.token])return"_ERROR_";var e=this.data.value;for(this.next();"/"==this.token;){if(this.next(),"OBSERVABLE"!=this.token&&void 0===Language.keywords[this.token])return"_ERROR_";e+="/"+this.data.value,this.next()}return e},Eden.AST.prototype.pCODESELECTOR=function(){var e=void 0;if("OBSERVABLE"==this.token||Language.keywords[this.token]&&"with"!=this.token)e=new Eden.AST.Literal("STRING",this.data.value),this.next();else if(":"==this.token||"."==this.token){var t=":"==this.token;if(this.next(),"OBSERVABLE"==this.token){if(!(!t&&Eden.Selectors.PropertyNode.attributes[this.data.value]||t&&Eden.Selectors.PropertyNode.pseudo[this.data.value]))return(e=new Eden.AST.Literal("STRING","")).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTORATTRIB)),e;e=new Eden.AST.Literal("STRING",(t?":":".")+this.data.value),this.next()}else if("NUMBER"==this.token)e=new Eden.AST.Literal("STRING",(t?":":".")+this.data.value),this.next();else if("{"==this.token)e=new Eden.AST.Literal("STRING",t?":":".");else{if("("!=this.token)return(e=new Eden.AST.Literal("STRING","")).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTORATTRIB)),e;var n=this.stream.position;for(this.next();this.stream.valid()&&")"!=this.token;)this.next();var r=this.stream.prevposition,i=":("+this.stream.code.substring(n,r).replace(/[\r\n]*/g,"")+")";e=new Eden.AST.Literal("STRING",i),this.next()}}else if("@"==this.token){if(this.next(),"OBSERVABLE"!=this.token)return(e=new Eden.AST.Literal("STRING","")).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTOROPTION)),e;if(!Eden.Selectors.allowedOptions[this.data.value])return(e=new Eden.AST.Literal("STRING","")).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTOROPTION)),e;e=new Eden.AST.Literal("STRING","@"+this.data.value+" "),this.next()}else if("#"==this.token)if(this.next(),"OBSERVABLE"==this.token)e=new Eden.AST.Literal("STRING","#"+this.data.value),this.next();else{if("{"!=this.token)return(e=new Eden.AST.Literal("STRING","")).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTORTAG)),e;e=new Eden.AST.Literal("STRING","#")}else if("{"==this.token){if(this.next(),e=this.pEXPRESSION(),"}"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTORBTICK)),e;this.next()}else if(">"==this.token)e=new Eden.AST.Literal("STRING"," > "),this.next();else if(">>"==this.token)e=new Eden.AST.Literal("STRING"," >> "),this.next();else if("<"==this.token)e=new Eden.AST.Literal("STRING"," < "),this.next();else if(","==this.token)e=new Eden.AST.Literal("STRING",","),this.next();else if("<<"==this.token)e=new Eden.AST.Literal("STRING"," << "),this.next();else if("("==this.token){n=this.stream.position;if(this.next(),"{"==this.token){this.next();var s=this.pEXPRESSION();if("}"!=this.token)return s.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTORBTICK)),s;if(this.next(),")"!=this.token)return s.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTORBTICK)),s;this.next(),(o=new Eden.AST.BinaryOp("//")).left(new Eden.AST.BinaryOp("//")),o.l.left(new Eden.AST.Literal("STRING","(")),o.l.setRight(s),o.setRight(new Eden.AST.Literal("STRING",")")),e=o}else{for(;this.stream.valid()&&")"!=this.token;)this.next();r=this.stream.prevposition,i="("+this.stream.code.substring(n,r).replace(/[\r\n]*/g,"")+")";e=new Eden.AST.Literal("STRING",i),this.next()}}else{if(")"==this.token)return;"*"==this.token&&(e=new Eden.AST.Literal("STRING","*"),this.next())}if(e){var o;if(void 0===(o=this.pCODESELECTOR()))return e;if(o.errors.length>0)return o;if("literal"==e.type&&"literal"==o.type)e.value+=o.value;else{var a=new Eden.AST.BinaryOp("//");a.left(e),a.setRight(o),e=a}}return e},Eden.AST.prototype.pSTATEMENT_PP=function(e){if("is"==this.token){this.next();var t=new Eden.AST.Definition,n=this.parent;this.parent=t,this.isdynamic=!1;var r=this.pEXPRESSION_ASYNC();return t.setExpression(r),this.isdynamic&&(t.isdynamic=!0),this.parent=n,t}if("in"==this.token){if(this.next(),!e)return(i=new Eden.AST.Range).error(new Eden.SyntaxError(this,Eden.SyntaxError.RANGEBANNED)),i;var i=new Eden.AST.Range(this.pEXPRESSION());return".."==this.token&&(this.next(),i.setSecond(this.pEXPRESSION())),i}if("="==this.token){this.next();var s=new Eden.AST.Assignment(this.pEXPRESSION());return s.expression&&"query"==s.expression.type&&(s.warning=new Eden.SyntaxWarning(this,s,Eden.SyntaxWarning.MISSINGSYNC,"This is an asynchronous statement")),s}if("+="==this.token)return this.next(),new Eden.AST.Modify("+=",this.pEXPRESSION());if("-="==this.token)return this.next(),new Eden.AST.Modify("-=",this.pEXPRESSION());if("/="==this.token)return this.next(),new Eden.AST.Modify("/=",this.pEXPRESSION());if("*="==this.token)return this.next(),new Eden.AST.Modify("*=",this.pEXPRESSION());if("~>"==this.token){this.next();var o=new Eden.AST.Subscribers;return"["!=this.token?(o.error(new Eden.SyntaxError(this,Eden.SyntaxError.SUBSCRIBEOPEN)),o):(this.next(),o.setList(this.pOLIST()),o.errors.length>0?o:"]"!=this.token?(o.error(new Eden.SyntaxError(this,Eden.SyntaxError.SUBSCRIBECLOSE)),o):(this.next(),o))}if("++"==this.token)return this.next(),new Eden.AST.Modify("++",void 0);if("--"==this.token)return this.next(),new Eden.AST.Modify("--",void 0);if("("==this.token){var a=new Eden.AST.FunctionCall;if(this.next(),")"!=this.token){if(a.setParams(this.pELIST()),a.errors.length>0)return a;if(")"!=this.token)return a.error(new Eden.SyntaxError(this,Eden.SyntaxError.FUNCCLOSE)),a}return this.next(),a}var d=[];d.push(new Eden.SyntaxError(this,Eden.SyntaxError.DEFINITION));var h=new Eden.AST.Assignment(void 0);return h.errors.unshift(d[0]),h},Eden.AST.prototype.pSTATEMENT_P=function(e){var t=this.pLVALUE();if(t.errors.length>0)return t;var n=this.pSTATEMENT_PP(e);return n.left(t),n.errors.length,n},Eden.AST.prototype.pSTATEMENT=function(){var e,t,n=this.stream.prevposition,r=this.stream.line-1,i=void 0,s=this.lastDoxyComment&&this.lastDoxyComment.length>0?this.lastDoxyComment.pop():void 0;switch(0==this.lastDoxyComment.length&&this.parentDoxy&&this.lastDoxyComment.push(this.parentDoxy),this.token){case"proc":this.next(),i=this.pACTION();break;case"func":this.next(),i=this.pFUNCTION();break;case"when":this.next(),i=this.pWHEN();break;case"action":this.next(),i=this.pNAMEDSCRIPT();break;case"for":this.next(),i=this.pFOR();break;case"while":this.next(),i=this.pWHILE();break;case"do":this.next(),i=this.pDO();break;case"wait":this.next(),i=this.pWAIT();break;case"switch":this.next(),i=this.pSWITCH();break;case"case":this.next(),i=this.pCASE();break;case"insert":this.next(),i=this.pINSERT();break;case"delete":this.next(),i=this.pDELETE();break;case"append":this.next(),i=this.pAPPEND();break;case"shift":this.next(),i=this.pSHIFT();break;case"require":this.next(),i=this.pREQUIRE();break;case"after":this.next(),i=this.pAFTER();break;case"import":this.next(),i=this.pIMPORT();break;case"local":case"auto":i=this.pLOCALS();break;case"default":this.next();var o=new Eden.AST.Default;":"!=this.token?o.error(new Eden.SyntaxError(this,Eden.SyntaxError.DEFAULTCOLON)):this.next(),i=o;break;case"if":this.next(),i=this.pIF();break;case"#":var a=this.stream.position+1,d=this.stream.line,h=33==this.stream.peek();do{this.stream.skipLine(),this.stream.valid()||this.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.NEWLINE)),this.stream.skip(),this.stream.line++}while(35==this.stream.peek()&&35!=this.stream.peek2());if(h){var c=new Eden.AST.DoxyComment(this.stream.code.substring(a,this.stream.position-1).trim(),d,this.stream.line);c.parent=this.parentDoxy,c.content.endsWith("@{")?this.parentDoxy=c:c.content.startsWith("@}")&&this.parentDoxy&&(this.parentDoxy=this.parentDoxy.parent),!this.lastStatement||void 0!==this.lastStatement.doxyComment||this.lastStatEndline!=d-1&&this.lastStatEndline!=d?this.lastDoxyComment.push(c):this.lastStatement.setDoxyComment(c)}this.next(),i=new Eden.AST.DummyStatement;break;case"##":i=this.pSECTION(),this.lastDoxyComment.length>0&&this.lastline==this.lastDoxyComment[0].startline-1&&i.setDoxyComment(this.lastDoxyComment.shift());break;case"%":i=this.pCUSTOM_SECTION();break;case"return":this.next();var p=new Eden.AST.Return;if(";"==this.token){this.next(),i=p;break}if(p.setResult(this.pEXPRESSION()),p.errors.length>0){i=p;break}";"!=this.token?p.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)):this.next(),i=p;break;case"continue":this.next();var l=new Eden.AST.Continue;if(l.errors.length>0){i=l;break}";"!=this.token?l.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)):this.next(),i=l;break;case"break":this.next();var u=new Eden.AST.Break;if(u.errors.length>0){i=u;break}";"!=this.token?u.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)):this.next(),i=u;break;case"{":this.next();var E=this.pSCRIPT();if("}"!=this.token){E.error(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)),i=E;break}this.next(),i=E;break;case"JAVASCRIPT":r=this.data.line-1;var f=this.data.value;this.next(),i=new Eden.AST.Literal("JAVASCRIPT",f);break;case"?":this.next(),i=this.pQUERY(),";"!=this.token?i.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)):this.next();break;case"(":case"`":case"*":case"OBSERVABLE":var m=this.pLVALUE();if(m.errors.length>0){(i=new Eden.AST.DummyStatement).lvalue=m,i.errors=m.errors;break}m.source=this.stream.code.substring(n,this.lastposition).trim();var g=this.pSTATEMENT_PP();if(g.left(m),g.errors.length>0){i=g;break}";"!=this.token?g.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)):this.next(),void 0===this.definitions[m.name]&&(this.definitions[m.name]=[]),this.definitions[m.name].push(g),i=g;break;default:return}return t=this.lastposition,e=this.lastline,i.parent=this.parent,i.local=this.localStatus,i.line=this.stream.line-r,void 0===i.doxyComment&&(i.setDoxyComment||console.error("Bad stat",i),i.setDoxyComment(s)),i.stamp=this.stamp,i.numlines=e-r-1,i.setSource(n,t,this.stream.code.substring(n,t)),"dummy"!=i.type&&(this.lastStatement=i,this.lastStatEndline=e),i},Eden.AST.prototype.pSTATEXPR=function(){this.stream.prevposition;var e=void 0,t=this.lastDoxyComment;switch(this.parentDoxy&&(this.lastDoxyComment=this.parentDoxy),this.token){case"proc":case"func":case"when":case"wait":case"do":case"require":case"after":case"import":case"action":(e=new Eden.AST.DummyStatement).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN));break;case"for":this.next(),e=this.pFOR();break;case"while":this.next(),e=this.pWHILE();break;case"switch":this.next(),e=this.pSWITCH();break;case"case":this.next(),e=this.pCASE();break;case"insert":this.next(),e=this.pINSERT();break;case"delete":this.next(),e=this.pDELETE();break;case"append":this.next(),e=this.pAPPEND();break;case"shift":this.next(),e=this.pSHIFT();break;case"para":case"oracle":e=this.pPARAMS();break;case"local":case"auto":e=this.pLOCALS();break;case"default":this.next();var n=new Eden.AST.Default;":"!=this.token?n.error(new Eden.SyntaxError(this,Eden.SyntaxError.DEFAULTCOLON)):this.next(),e=n;break;case"if":this.next(),e=this.pIF();break;case"return":this.next();var r=new Eden.AST.Return;if(";"==this.token){this.next(),e=r;break}if(r.setResult(this.pEXPRESSION()),r.errors.length>0){e=r;break}";"!=this.token?r.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)):this.next(),e=r;break;case"continue":this.next();var i=new Eden.AST.Continue;if(i.errors.length>0){e=i;break}";"!=this.token?i.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)):this.next(),e=i;break;case"break":this.next();var s=new Eden.AST.Break;if(s.errors.length>0){e=s;break}";"!=this.token?s.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)):this.next(),e=s;break;case"{":this.next();var o=this.pSCRIPT();if("}"!=this.token){o.error(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)),endline=this.stream.line,e=o;break}endline=this.stream.line,this.next(),e=o;break;case"JAVASCRIPT":curline=this.data.line-1;var a=this.data.value;this.next(),e=new Eden.AST.Literal("JAVASCRIPT",a);break;case"`":case"*":case"OBSERVABLE":var d=this.pLVALUE();if(d.errors.length>0){(e=new Eden.AST.DummyStatement).lvalue=d,e.errors=d.errors;break}var h=this.pSTATEMENT_PP();if(h.left(d),h.errors.length>0){e=h,endline=this.stream.line;break}";"!=this.token?h.error(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)):(end=this.stream.position,endline=this.stream.line,this.next()),void 0===this.definitions[d.name]&&(this.definitions[d.name]=[]),this.definitions[d.name].push(h),e=h;break;default:return}return e.parent=this.parent,e.doxyComment=t,e},Eden.AST.prototype.pSWITCH=function(){var e=new Eden.AST.Switch,t=this.parent;return this.parent=e,"("!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.SWITCHOPEN)),this.parent=t,e):(this.next(),e.setExpression(this.pEXPRESSION()),e.errors.length>0?(this.parent=t,e):")"!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.SWITCHCLOSE)),this.parent=t,e):(this.next(),"{"!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.SWITCHSCRIPT)),this.parent=t,e):(e.setStatement(this.pSTATEMENT()),this.parent=t,e)))},Eden.AST.prototype.pCASE=function(){var e=new Eden.AST.Case;return"STRING"!=this.token&&"NUMBER"!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.CASELITERAL)),e):(e.setLiteral(this.token,this.data.value),this.next(),":"!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.CASECOLON)),e):(this.next(),e))},Eden.AST.prototype.pTERM=function(){var e=this.pTERM_A(),t=this.pEXPRESSION_PPPPPP();return t?(t.left(e),t):e},Eden.AST.prototype.pTERM_A=function(){for(var e=this.pTERM_P();"<"==this.token||"<="==this.token||">"==this.token||">="==this.token||"=="==this.token||"!="==this.token;){var t=new Eden.AST.BinaryOp(this.token);this.next(),t.left(e),t.setRight(this.pTERM_P()),e=t}return e},Eden.AST.prototype.pTERM_P=function(){for(var e=this.pTERM_PP();"+"==this.token||"-"==this.token||"//"==this.token;){var t=new Eden.AST.BinaryOp(this.token);this.next(),t.left(e),t.setRight(this.pTERM_PP()),e=t}return e},Eden.AST.prototype.pTERM_PP=function(){for(var e=this.pTERM_PPP();"*"==this.token||"/"==this.token||"%"==this.token||"^"==this.token;){var t=new Eden.AST.BinaryOp(this.token);this.next(),t.left(e),t.setRight(this.pTERM_PPP()),e=t}return e},Eden.AST.prototype.pTERM_PPP=function(){var e=this.pFACTOR(),t=this.pEXPRESSION_PPPPP();return t?(t.left(e),t):e},Eden.AST.prototype.pWAIT=function(){var e=new Eden.AST.Wait;if(";"==this.token)return this.next(),e;var t=this.pEXPRESSION();return e.setDelay(t),";"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)),e):(this.next(),e)},Eden.AST.prototype.pWHEN=function(){var e=new Eden.AST.When,t=this.parent;if(this.parent=e,"role"==this.token){if(this.next(),"OBSERVABLE"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.WHENROLE)),this.parent=t,e;e.roles=this.pOLIST()}if("("!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.WHENOPEN)),this.parent=t,e;if(this.next(),e.setExpression(this.pEXPRESSION()),e.errors.length>0)return this.parent=t,e;if(")"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.WHENCLOSE)),this.parent=t,e;if(this.next(),e.setStatement(this.pSTATEMENT()),e.errors.length>0)return this.parent=t,e;if(void 0===e.statement)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.WHENNOSTATEMENT)),e.active=!0,this.parent=t,e;if("with"==this.token||"::"==this.token){this.next();var n=this.pSCOPE();if(e.setScope(n),n.errors.length>0)return e;if(";"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)),e;this.next()}return e.compile(this),this.whens.push(e),this.parent=t,e},Eden.AST.prototype.pWHILE=function(){var e=new Eden.AST.While,t=this.parent;return this.parent=e,e.warning=new Eden.SyntaxWarning(this,e,Eden.SyntaxWarning.USEOFWHILE),"("!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.WHILEOPEN)),this.parent=t,e):(this.next(),e.setCondition(this.pEXPRESSION()),e.errors.length>0?(this.parent=t,e):")"!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.WHILECLOSE)),this.parent=t,e):(this.next(),e.setStatement(this.pSTATEMENT()),void 0===e.statement?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.WHILENOSTATEMENT)),this.parent=t,e):(this.parent=t,e)))},Eden.AST.prototype.pQUERY=function(){var e=new Eden.AST.Query,t=[];if("OBSERVABLE"==this.token)return e.observable=this.data.value,this.next(),e;if("("!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.QUERYOPEN)),e;if(this.next(),e.setSelector(this.pCODESELECTOR()),")"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.QUERYCLOSE)),e;if(this.next(),"["==this.token){for(this.next();this.stream.valid()&&"]"!=this.token&&(t.push(this.data.value),this.next(),"]"!=this.token);){if(","!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.QUERYSELECTCOMMA)),e;this.next()}if("]"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.QUERYSELECTCLOSE)),e;this.next()}if("="==this.token||"+="==this.token||"//="==this.token){var n=this.token;this.next();var r=this.pEXPRESSION();e.setModify(r,n)}return t.length,e.setResultTypes(t),e},Eden.AST.prototype.pINDEXED=function(){for(var e=new Eden.AST.Indexed;this.stream.valid()&&("["==this.token||"."==this.token);)if("["==this.token){this.next();var t=new Eden.AST.Index;if("]"==this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXEXP)),e;if((n=this.pEXPRESSION()).errors.length>0)return t.setExpression(n),e.addIndex(t),e;if("literal"==n.type&&"NUMBER"==n.datatype&&n.value<1)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.OUTOFBOUNDS)),e;if("]"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXCLOSE)),e;this.next(),t.setExpression(n),e.addIndex(t)}else{this.next();t=new Eden.AST.Index;if("OBSERVABLE"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXEXP)),e;var n=new Eden.AST.Literal("STRING",this.data.value);this.next(),t.setExpression(n),e.addIndex(t)}return e},Eden.AST.prototype.pSECTION=function(){for(var e=1;35==this.stream.peek();)e++,this.stream.skip();var t=this.stream.readLine().trim();return this.stream.valid()?(this.stream.position--,this.stream.line--):this.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.NEWLINE)),this.next(),stat=new Eden.AST.Section,stat.setName(t),stat.depth=e,stat},Eden.AST.prototype.pCUSTOM_SECTION=function(){if(this.next(),"OBSERVABLE"!=this.token)return(e=new Eden.AST.Literal("STRING",this.data.value)).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.HEREDOCTOKEN)),e;var e,t=this.data.value;if(10!=this.stream.get())return(e=new Eden.AST.Literal("STRING",this.data.value)).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.HEREDOCTOKEN)),e;for(var n="";this.stream.valid();){var r=this.stream.position,i=this.stream.readLine();if(i.startsWith("%eden")){this.stream.position=r+5;break}n+=i}this.stream.valid()||this.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.NEWLINE)),this.next();var s=new Eden.AST.CustomBlock;return s.text=n,s.setName(t),s},Eden.AST.prototype.pHTML=function(){this.next();var e=new Eden.AST.HTML;if("OBSERVABLE"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e;for(e.setName(this.data.value),this.next();"OBSERVABLE"==this.token;){var t=this.stream.prevposition,n=this.data.value;for(this.next();"-"==this.token;){if(n+="-",this.next(),"OBSERVABLE"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e;n+=this.data.value,this.next()}if(this.stream.prevposition-t!=n.length)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e;if("OBSERVABLE"!=this.token&&">"!=this.token&&"/"!=this.token){if("="!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e;if(this.next(),"STRING"!=this.token){if("{"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e;if(this.next(),e.addAttribute(n,this.pEXPRESSION()),e.hasErrors())return e;if("}"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e;this.next()}else e.addAttribute(n,new Eden.AST.Literal("STRING",this.data.value)),this.next()}else e.addAttribute(n,new Eden.AST.Literal("BOOLEAN",!0))}if("/"==this.token)return this.next(),">"!=this.token&&e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),this.next(),e;if(">"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e;var r=this.stream.position,i=this.stream.position;for(this.next();this.stream.valid()&&"</"!=this.token;)if("<"==this.token)i-1>r&&e.addContent(new Eden.AST.Literal("STRING",this.stream.code.substring(r,i).replace(/\n/g,"\\n"))),e.addContent(this.pHTML()),r=i=this.stream.prevposition;else if("{"==this.token){if(this.next(),i-1>r&&e.addContent(new Eden.AST.Literal("STRING",this.stream.code.substring(r,i).replace(/\n/g,"\\n"))),e.addContent(this.pEXPRESSION()),"}"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e;r=i=this.stream.position,this.next()}else i=this.stream.position,this.next();return i>r&&e.addContent(new Eden.AST.Literal("STRING",this.stream.code.substring(r,i).replace(/\n/g,"\\n"))),"</"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e):(this.next(),"OBSERVABLE"!=this.token||this.data.value!=e.name?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e):(this.next(),">"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e):(this.next(),e)))},Eden.Project=function(e,t,n){this.title=t,this.name=t.replace(/[^a-zA-Z0-9]/g,""),this.author=void 0,this.authorid=-1,this.tags=t.toLowerCase().split(" "),this.src=n,this.ast=new Eden.AST(n,void 0,this),this.id=e,this.vid=void 0,this.parentid=void 0,this.thumb=void 0,this.desc=void 0,this.readPassword=void 0,this.autosavetimeout=void 0,this.ast&&this.ast.script.errors.length,eden.root.lookup("jseden_project_name").assign(this.name,eden.root.scope,EdenSymbol.localJSAgent)},Eden.Project.listenTo=listenTo,Eden.Project.emit=emit,Eden.Project.unListen=unListen,Eden.Project.listeners={},Eden.Project.init=function(){eden.root.lookup("jseden_project_title").addJSObserver("project",function(e,t){if(e.origin!==eden.project){if(void 0===eden.project)return;eden.project.title=t,void 0===this.id&&(Eden.Index.remove(eden.project.ast.script),eden.project.name=t.replace(/[^a-zA-Z0-9]/g,""),eden.project.ast.script.name=eden.project.name,console.log("REINDEX PROJECT"),Eden.Index.update(eden.project.ast.script)),eden.project.ast.script.doxyComment=eden.project.ast.doxyFromOrigin(),Eden.Fragment.emit("aststatus",[eden.project.ast.script])}}),$.get("resources/projects.db.json",function(e){Eden.Project.local=e;var t=JSON.parse(window.localStorage.getItem("project_list"));if(null!==t)for(var n in t){var r="project_"+n,i=window.localStorage.getItem(r+"_id");"undefined"==i&&(i=void 0);var s=window.localStorage.getItem(r+"_vid");"undefined"==s&&(s=void 0);var o=window.localStorage.getItem(r+"_author");"undefined"==o&&(o=void 0);window.localStorage.getItem(r+"_authorid");var a=window.localStorage.getItem(r+"_name"),d=window.localStorage.getItem(r+"_thumb");"undefined"==d&&(d=void 0);window.localStorage.getItem(r+"_desc");var h=window.localStorage.getItem(r+"_title");Eden.Project.local[a]={author:o,listed:!0,title:h,image:d,id:i}}},"json")},Eden.Project.loadFromFile=function(e){var t=e.name;t=(t=t.substring(0,t.lastIndexOf("."))).replace(/\([0-9]+\)/,""),console.log("FILE",e),Eden.Project.emit("loading",[this]);var n=new FileReader;n.onload=function(e){eden.project=new Eden.Project(void 0,t,e.target.result.replace(/\r/g,"")),eden.project.start()},n.readAsText(e)},Eden.Project.newFromExisting=function(e,t){var n=this;Eden.Project.emit("loading",[n]),Eden.Project.local[e]&&(Eden.Project.local[e].id?Eden.Project.load(Eden.Project.local[e].id,void 0,void 0,t):$.get(Eden.Project.local[e].file,function(r){eden.root.lookup("jseden_project_mode").assign("restore",eden.root.scope,EdenSymbol.defaultAgent),eden.project=new Eden.Project(void 0,e,r),eden.project.start(function(){Eden.Project.emit("load",[n]),t&&t(eden.project)})},"text"))},Eden.Project.search=function(e,t){},Eden.Project.load=function(e,t,n,r){var i=this;3==arguments.length&&(r=n,n=void 0),Eden.Project.emit("loading",[i]),Eden.DB.load(e,t,n,function(t){if(t){var s,o=t;if(null!==o.projectMetaData&&(s=JSON.parse(o.projectMetaData)).env&&!Eden.Project.verifyEnvironment(s.env)){var a=Eden.Project.findEnvironment(s.env);a?document.location=a+URLUtil.updateQueryString({load:e,vid:t.saveID,r:n||""}):alert("This project needs a different version of JS-Eden")}eden.project=new Eden.Project(e,o.minimisedTitle,t.source),console.log("LOAD PROJECT",t),eden.project.vid=t.saveID,eden.project.title=o.title,eden.project.author=o.ownername,eden.project.authorid=o.owner,eden.project.thumb=o.image,eden.project.tags=o.tags.trim().split(" "),eden.project.parentid=o.parentProject,eden.root.lookup("jseden_project_title").assign(o.title,eden.root.scope,EdenSymbol.localJSAgent),eden.root.lookup("jseden_project_name").assign(o.minimisedTitle,eden.root.scope,EdenSymbol.localJSAgent),eden.root.lookup("jseden_project_thumb").assign(o.image,eden.root.scope,EdenSymbol.localJSAgent),eden.root.lookup("jseden_project_author").assign(o.ownername,eden.root.scope,EdenSymbol.localJSAgent),s&&(eden.project.desc=s.description),eden.project.ast.script.doxyComment=eden.project.ast.doxyFromOrigin(),eden.project.start(function(){Eden.Project.emit("load",[i])});var d=URLUtil.updateQueryString({load:eden.project.id,vid:eden.project.vid,r:n||""});document.location.search!=d&&window.history.pushState({id:eden.project.id,vid:eden.project.vid},"",d)}r&&r(eden.project)})},Eden.Project.verifyEnvironment=function(e){for(var t in e){var n=eden.root.lookup("jseden_"+t).value();if("parser_cs3"==t)eden.root.lookup("jseden_parser_cs3").assign(!0,eden.root.scope,EdenSymbol.defaultAgent);else if("string"==typeof e[t]){switch(e[t].charAt(0)){case">":if(n<=parseInt(e[t].substring(1)))return!1;break;case"<":if(n>=parseInt(e[t].substring(1)))return!1;break;case">=":if(n<parseInt(e[t].substring(1)))return!1;break;case"<=":if(n>parseInt(e[t].substring(1)))return!1;break;case"=":if(n!==parseInt(e[t].substring(1)))return!1;break;default:if(n!=e[t])return!1}}else if(n!=e[t])return!1}return!0},Eden.Project.findEnvironment=function(e){return e.webgl&&!eden.root.lookup("jseden_webgl").value()?"http://jseden.dcs.warwick.ac.uk/webgl/index.html":!e.webgl&&eden.root.lookup("jseden_webgl").value()?"http://jseden.dcs.warwick.ac.uk/construit/index.html":null},Eden.Project.prototype.environment=function(){return{version_major:eden.root.lookup("jseden_version_major").value(),webgl:eden.root.lookup("jseden_webgl").value(),p2p_constructs:eden.root.lookup("jseden_p2p_constructs").value(),parser_cs3:eden.root.lookup("jseden_parser_cs3").value()}},Eden.Project.prototype.start=function(e){var t=this;if(this.ast.errors.length>0){for(var n=0;n<this.ast.errors.length;++n)console.error("Project parse error: ",this.ast.errors[n].toString());e&&e()}else this.ast.execute(this,function(){if(t.ast.scripts.ACTIVE){for(var n=0;n<t.ast.script.statements.length;n++)if(t.ast.script.statements[n]===t.ast.scripts.ACTIVE){console.log(t.ast.script.statements[n]),t.ast.script.statements[n].removeIndex(),t.ast.script.statements[n].destroy(),eden.root.start=t.ast.script.statements[n].start,eden.root.end=t.ast.script.statements[n].end,eden.root.prefix=t.ast.script.statements[n].prefix,eden.root.postfix=t.ast.script.statements[n].postfix,eden.root.parent=eden.project.ast.script,Eden.Index.update(eden.root),t.ast.script.statements[n]=eden.root;break}}else t.ast.script.appendChild(eden.root);eden.root.parent=t.ast.script,t.ast.scripts.ACTIVE=eden.root,e&&e()})},Eden.Project.prototype.diff=function(e,t){return _diff(e||this.ast.stream.code,t||this.generate())},Eden.Project.prototype.save=function(e,t){Eden.DB.save(this,e,t)},Eden.Project.prototype.restore=function(){},Eden.Project.prototype.autosave=function(){if(!this.autosavetimeout){var e=this;this.autosavetimeout=setTimeout(function(){this.autosavetimeout=void 0,Eden.DB.localSave(e),console.log("Doing an autosave")},1e4)}},Eden.Project.prototype.patch=function(e,t){},Eden.Project.prototype.localSave=function(){Eden.DB.localSave(this)},Eden.Project.prototype.snapshot=function(){},Eden.Project.prototype.addAction=function(e){var t=Eden.AST.parseStatement("action "+e+" {}");return this.ast.script.appendChild(t),t.addIndex(),t},Eden.Project.prototype.generate=function(){return this.ast.getSource()},Eden.Project.prototype.getDescription=function(){return void 0===this.desc&&(this.desc="# "+this.title+"\nEnter a project description here,\nand some hashtags as below.\n\nTags: #"+this.tags.join(" #")),this.desc},Eden.Project.prototype.setDescription=function(e){this.desc=e;var t=new Eden.AST.DoxyComment(e,0,0);this.tags=t.getHashTags().map(function(e){return e.substring(1)})},Eden.Project.prototype.registerAgent=function(e,t){for(var n in e.executed=1,e.dependencies)eden.root.lookup(n).addObserver(e.id,e);!t&&eden.peer&&eden.peer.activateWhen(e.id)},Eden.Project.prototype.removeAgent=function(e,t){for(var n in e.executed=0,e.dependencies)eden.root.lookup(n).removeObserver(e.id);!t&&eden.peer&&eden.peer.deactivateWhen(e.id)},Eden.Fragment=function(e,t){this.name=e,this.selector=e,this.originast=void 0,this.origin=void 0,this.source=void 0,this.ast=void 0,this.lastast=void 0,this.locked=!0,this.remote=!1,this.results=[],this.title=e,this.scratch=!1,this.edited=!1,this.autosavetimer=void 0,this.history=[],this.snapshot="",this.index=-1;var n=this;this.reset(()=>{Eden.Fragment.listenTo("aststatus",this,function(e){if(e===n.originast){var t=n.originast.doxyComment;if(t){var r=t.getControls();r["@title"]&&(n.title=r["@title"][0])}Eden.Fragment.emit("status",[n])}}),Eden.Fragment.listenTo("patch",this,function(e,t){e!==n&&t===n.originast&&(n.source=n.originast.getInnerSource(),n.ast=Eden.AST.fromNode(n.originast,n),Eden.Fragment.emit("changed",[n]))}),Eden.Fragment.listenTo("lock",this,function(e,t){t===n.originast&&(n.locked=!0,Eden.Fragment.emit("locked",[n]))}),Eden.Fragment.listenTo("unlock",this,function(e,t){t===n.originast&&(n.locked=!1,Eden.Fragment.emit("unlocked",[n]))}),Eden.Fragment.listenTo("goto",this,function(e,t){if(this.originast===e){console.log("Goto line",t.getStartLine(e));var r=t.getStartLine(e);return Eden.Fragment.emit("gotoline",[n,r]),!0}return void 0===e&&this.setSourceInitial(t.source),!1}),t&&t()})},Eden.Fragment.listenTo=listenTo,Eden.Fragment.emit=emit,Eden.Fragment.unListen=unListen,Eden.Fragment.listeners={},Eden.Fragment.prototype.destroy=function(){Eden.Fragment.unListen(this),this.unlock()},Eden.Fragment.prototype.reset=function(e){var t=this;if(this.scratch)return t.lock(),t.snapshot=t.source,Eden.Fragment.emit("changed",[t]),void(e&&e());Eden.Selectors.query(this.selector,void 0,{minimum:1},function(n){if(t.results=n,t.results&&1==t.results.length&&"script"==t.results[0].type)t.originast=t.results[0];else if(t.results&&1==t.results.length&&"assignment"==t.results[0].type)t.originast=void 0;else if(t.results&&t.results.length>1){for(var r="",i=0;i<t.results.length;i++)r+=t.results[i].getSource()+"\n";t.source=r,t.originast=void 0}else t.source="",t.originast=void 0;t.originast?(t.name=t.originast.name?t.originast.name:t.selector,Eden.AST.fromNode(t.originast,t).then(n=>{t.ast=n,t.source=t.ast.stream.code;for(var r=t.originast;r&&r.parent;)r=r.parent;t.origin=r.base?r.base.origin:{remote:!0},t.remote=t.origin.remote,t.locked=t.originast.lock>0||t.remote;var i=t.originast.doxyComment;if(i){t.doxy=i;var s=i.getControls();s["@title"]&&(t.title=s["@title"][0])}else t.doxy=void 0;Eden.Fragment.emit("changed",[t]),t.locked&&Eden.Fragment.emit("locked",[t]),t.lock(),t.snapshot=t.source,e&&e()})):(console.log("Make scratch fragment"),t.locked=!1,t.remote=!1,t.ast=new Eden.AST(t.source,void 0,t,{noindex:!0,strict:!0}),t.originast=t.ast.script,t.name="*Scratch*",t.title=t.name,t.scratch=!0,Eden.Fragment.emit("changed",[t]),t.lock(),t.snapshot=t.source,e&&e())})},Eden.Fragment.prototype.getSource=function(){return this.source?this.source:""},Eden.Fragment.prototype.makeReal=function(e){if(this.scratch){this.name=e,this.title=e,this.originast=eden.project.addAction(e),this.selector=Eden.Selectors.getID(this.originast),this.scratch=!1,this.remote=!1,this.setSource(this.source);for(var t=this.originast;t&&t.parent;)t=t.parent;this.origin=t.base.origin,this.lock()}},Eden.Fragment.prototype.setSourceInitial=function(e){this.source=e,this.snapshot=e,this.ast=new Eden.AST(e,void 0,this,{strict:!0,noindex:this.scratch})},Eden.Fragment.AUTOSAVE_INTERVAL=2e3,Eden.Fragment.prototype.undo=function(){if(!(this.index<0)&&0!=this.history.length){var e,t=this.history[this.index];if(this.index--,this.index>=0&&this.history[this.index].snapshot)e=this.history[this.index].snapshot;else{var n=new diff_match_patch,r=n.patch_fromText(t.undo);e=n.patch_apply(r,this.snapshot)[0]}this.snapshot=e,this.setSource(e)}},Eden.Fragment.prototype.canUndo=function(){return this.history.length>0&&this.index>=0},Eden.Fragment.prototype.canRedo=function(){return this.index<this.history.length-1},Eden.Fragment.prototype.redo=function(){if(!(this.index>=this.history.length-1)){this.index++;var e,t=this.history[this.index];if(t.snapshot)e=t.snapshot;else{var n=new diff_match_patch,r=n.patch_fromText(t.redo);e=n.patch_apply(r,this.snapshot)[0]}this.snapshot=e,this.setSource(e)}},Eden.Fragment.prototype.addHistory=function(e,t){this.history.push({time:Date.now()/1e3|0,redo:e,undo:t}),this.index=this.history.length-1},Eden.Fragment.prototype.autoSave=function(){if(!(void 0===this.ast||this.ast.script.errors.length>0)&&this.originast&&!this.scratch){for(var e=this.originast;e.parent;)e=e.parent;e.base&&e.base.origin&&!e.base.origin.authorid==Eden.DB.userid&&(eden.root.lookup("jseden_script_livepatch").value()&&(console.log("AUTOSAVE",this.selector),Eden.DB.patch(Eden.Selectors.getID(this.originast),this.ast.script.getInnerSource())),this.autosavetimer=void 0)}},Eden.Fragment.prototype.diff=function(){if(this.origin&&this.origin.ast&&this.originast.end>0){var e=this.origin.ast.stream.code.substring(this.originast.start,this.originast.end),t=this.originast.prefix.length,n=this.originast.postfix.length;return e=e.substring(t,e.length-n),DiffUtil.diff(e,this.source)}},Eden.Fragment.prototype.setSource=function(e){if(!this.locked){var t=this;if(this.source=e,this.edited=!0,this.ast=new Eden.AST(e,void 0,this,{noindex:!0,strict:!0}),0==this.ast.errors.length){if(clearTimeout(this.autosavetimer),this.autosavetimer=setTimeout(function(){t.autoSave()},Eden.Fragment.AUTOSAVE_INTERVAL),this.originast){var n=this.originast.parent,r=this.originast.patchInner(this.ast.script);for(Eden.Fragment.emit("patch",[this,this.originast,r]);n;)Eden.Fragment.emit("patch",[this,n]),n=n.parent}Eden.Fragment.emit("status",[this]),eden.root.lookup("jseden_fragment_changed").assign(t.selector,eden.root.scope,Symbol.localJSAgent)}else Eden.Fragment.emit("errored",[this])}},Eden.Fragment.prototype.lock=function(){if(this.originast)for(var e=this.originast.parent;e;)e.lock++,Eden.Fragment.emit("lock",[this,e]),e=e.parent},Eden.Fragment.prototype.unlock=function(){if(this.originast)for(var e=this.originast.parent;e;)e.lock--,0==e.lock&&Eden.Fragment.emit("unlock",[this,e]),e=e.parent},Eden.Fragment.prototype.getTitle=function(){return this.originast&&this.originast.name?this.originast.name:this.name},Eden.Query={},Eden.Query.sortByCount=sortByCount,Eden.Query.reduceByCount=reduceByCount,Eden.Query.negativeFilter=negativeFilter,Eden.Query.search=function(e,t){var n=e.split(/[ ]+/),r=0,i=n.length,s=!0,o=!0,a=!0,d=!0,h={views:[],symbols:[],whens:[],projects:[],scripts:[],statements:[]};if(n.length>0&&":"==n[0].charAt(n[0].length-1)){if(r=1,!0,"select:"==n[0]){var c=e.substring(n[0].length).trim();return h.all=Eden.Selectors.query(c,"source"),void 0===h.all&&(h.all=[]),t&&t(h),t&&c.length>=3&&(Eden.Query.dbseltimeout&&clearTimeout(Eden.Query.dbseltimeout),Eden.Query.dbseltimeout=setTimeout(function(){Eden.Query.dbseltimeout=void 0,Eden.DB.searchSelector(c,"source",function(e){h.all.push.apply(h.all,e),t(h)})},1e3)),h}switch(n[0]){case"procs:":case"whens:":case"agents:":o=!0,s=!1,!1,a=!1,doremovescripts=!1,!0,!1;break;case"scripts:":o=!1,s=!1,a=!0,d=!0,!1,!1,!1}}for(i-=r;r<n.length;r++)if(""!=n[r])if(n[r].startsWith("depends:")){var p=n[r].split(":");if(""==p[1]){i--;continue}var l=edenUI.regExpFromStr(p[1],void 0,void 0,"regexp");s&&h.symbols.push.apply(h.symbols,Eden.Query.searchDepends(l))}else if("#"==n[r].charAt(0)){var u=edenUI.regExpFromStr("^"+n[r].substring(1),void 0,void 0,"regexp");s&&h.symbols.push.apply(h.symbols,Eden.Query.searchTags(u))}else{l=edenUI.regExpFromStr(n[r],void 0,void 0,"regexp"),u=edenUI.regExpFromStr("^"+n[r],void 0,void 0,"regexp");s&&h.symbols.push.apply(h.symbols,Eden.Query.searchSymbols(l,u)),o&&h.whens.push.apply(h.whens,Eden.Query.searchWhens(l)),d&&n[r].length>2?function(e){Eden.Query.dbtimeout&&clearTimeout(Eden.Query.dbtimeout),Eden.Query.dbtimeout=setTimeout(function(){Eden.Query.dbtimeout=void 0,Eden.DB.search(e,function(e){h.scripts.push.apply(h.scripts,e),h.scripts=reduceByCount(h.scripts,i),h.scripts=sortByLoaded(h.scripts),Eden.Query.mergeResults(h),t&&t(h)})},500)}(n[r]):a&&h.scripts.push.apply(h.scripts,Eden.Query.searchScripts(l))}else i--;return h.symbols=reduceByCount(h.symbols,i),Eden.Query.mergeResults(h),t&&t(h),h},Eden.Query.mergeResults=function(e){e.all=[];var t=0;!function n(r,i){t=0;for(var s=i;s<e.symbols.length&&!(t>=r);s++)t++,e.all.push("/"+e.symbols[s]);t=0;for(s=i;s<e.whens.length&&!(t>=r);s++)t++,e.all.push(e.whens[s]);t=0;for(s=i;s<e.scripts.length&&!(t>=r-1);s++)t++,e.all.push("*script"+e.scripts[s]);t=0;for(s=i;s<e.statements.length&&!(t>=r);s++)t++,e.all.push(e.statements[s]);(e.symbols.length>i+r||e.whens.length>i+r||e.scripts.length>i+r)&&n(2,i+r)}(3,0)},Eden.Query.searchViews=function(e){},Eden.Query.searchSymbols=function(e,t){var n=[];for(var r in eden.root.symbols){var i=eden.root.symbols[r];if(e.test(r))i.last_modified_by.internal||"_"==r.charAt(0)||n.push(r);else if(t&&eden.dictionary[r]){var s=eden.dictionary[r].getHashTags();if(s)for(var o=0;o<s.length;o++)if(t.test(s[o].substring(1))){i.last_modified_by.internal||"_"==r.charAt(0)||n.push(r);break}}}return n},Eden.Query.searchTags=function(e){var t=[];for(var n in eden.root.symbols){var r=eden.root.symbols[n];if(e&&eden.dictionary[n]){var i=eden.dictionary[n].getHashTags();if(i)for(var s=0;s<i.length;s++)if(e.test(i[s].substring(1))){r.last_modified_by.internal||"_"==n.charAt(0)||t.push(n);break}}}return t},Eden.Query.searchDepends=function(e){var t=[];for(var n in eden.root.symbols)for(var r in eden.root.symbols[n].dependencies)e.test(r)&&t.push(n);return t},Eden.Query.searchWhens=function(e){var t=[];for(var n in Eden.Agent.agents){var r=Eden.Agent.agents[n];if(r.ast)for(var i in r.ast.triggers)if(e.test(i))for(var s=r.ast.triggers[i],o=0;o<s.length;o++)-1==t.indexOf(s[o].statement)&&t.push(s[o].statement)}return t},Eden.Query.searchProjects=function(e){},Eden.Query.searchScripts=function(e){var t=[];for(var n in Eden.DB.meta)e.test(n)&&t.push(n);return t},Eden.Query.treeBottomUp=function(){var e={};for(var t in eden.root.symbols){var n=eden.root.symbols[t];void 0!==n.definition&&0!=Object.keys(n.dependencies).length||(e[t]={})}return function e(t){for(var n in t){var r=eden.root.symbols[n];if(r){var i=t[n];for(var s in r.subscribers)i[s]={};e(i)}}}(e),e},Eden.Query.treeTopDown=function(e){if(void 0===e)for(var t in e={},eden.root.symbols){var n=eden.root.symbols[t];n&&(0==Object.keys(n.subscribers).length&&(e[t]={}))}else if(Array.isArray(e)){for(var r={},i=0;i<e.length;i++)r[e[i]]={};e=r}return function e(t){for(var n in t){var r=eden.root.symbols[n];if(r){var i=t[n];for(var s in r.dependencies)i[s]={};e(i)}}}(e),e},Eden.Query.objectHierarchy=function(){function e(e){if(void 0!==e.statid){var t=Eden.Statement.statements[e.statid];if(t.statement&&t.statement.doxyComment&&t.statement.doxyComment.hasTag("#library"))return!1}return!0}var t={};for(var n in eden.root.symbols){var r=eden.root.symbols[n];r&&e(r)&&(0==Object.keys(r.subscribers).length&&0!=Object.keys(r.dependencies).length&&(t[n]={}))}return function t(n){for(var r in n){var i=eden.root.symbols[r];if(i&&e(i)){var s=n[r];for(var o in i.dependencies)s[o]={};t(s)}}}(t),t},Eden.Query.dependencyTree=function(e){var t={};function n(e,t){for(var r in t)void 0===e[r]?e[r]=t[r]:n(e[r],t[r])}function r(e){var i=e.name;if(0==Object.keys(e.subscribers).length)return void 0===t[i]&&(t[i]={}),t[i];var s={};for(var o in e.subscribers){var a=r(e.subscribers[o]);void 0!==a[i]&&n(s,a[i]),a[i]=s}return s}for(var i in e)r(eden.root.lookup(i));return t},Eden.Generator={},Eden.Generator.symbolScript=function(e){var t="## Functions\n",n="\n## Definitions\n",r="\n## Restored Definition\n",i="\n## Agent Definitions\n",s="\n## Assignments\n",o="\n## Agent Assignments\n",a="\n## Input Device Assignments\n",d="\n## Restored Assignments\n";for(var h in eden.root.symbols){var c=eden.root.symbols[h],p=c.last_modified_by;if(void 0===p&&console.log(c),"string"!=typeof p.name&&console.log(p),"*Default"!=p.name&&(p.canUndo&&p.canUndo()||e&&e[p.name]||p.meta&&p.last_exec_version!=p.meta.saveID||"*"==p.name.charAt(0)||"/"==p.name.charAt(0)))if(c.eden_definition)c.eden_definition.startsWith("func")?t+=c.eden_definition+"\n":"*Restore"==p.name?r+=c.eden_definition+"\n":"*When"==p.name?i+=c.eden_definition+"\n":n+=c.eden_definition+"\n";else if(void 0!==c.cache.value){var l=h+" = "+Eden.edenCodeForValue(c.cache.value)+";\n";p instanceof Symbol&&p.eden_definition&&p.eden_definition.startsWith("proc")||"*JavaScript"==p.name||"*When"==p.name?o+=l:"*Input Device"==p.name?a+=l:"*Restore"==p.name?d+=l:s+=l}}return t+n+r+i+s+d+o+a+"\n## Procedures\n"},Eden.Generator.importsScript=function(){var e="";for(var t in Eden.Agent.agents){var n=Eden.Agent.agents[t],r="";if(-1!=n.meta.saveID||n.meta.file||(r=" create"),n.last_exec_version)e+="import "+t+"@"+(-1==n.last_exec_version?"origin":n.last_exec_version)+r+";\n";if(n.last_exec_version!=n.meta.saveID)e+="import "+t+"@"+(-1==n.meta.saveID?"origin":n.meta.saveID)+r+" noexec;\n"}return e},Eden.Generator.getScript=function(){return Eden.Generator.importsScript()+"\n"+Eden.Generator.symbolScript()},Eden.Peer=function(e,t){this.connections={},this.id=t,this.master=e;var n=this;function r(e){!function e(t,n,r){Eden.Selectors.query(n.remove[t].path,void 0,void 0,function(i){var s=i[0];if(s){this.frags[n.remove[t].path]=s;var o=void 0;if(0==n.remove[t].id)o=s.statements[0];else for(var a=0;a<s.statements.length;a++)if(s.statements[a].id==n.remove[t].id){n.remove[t].ws?(o=s.statements[a].nextSibling)&&"dummy"!=o.type&&(o=void 0):o=s.statements[a];break}if(o){for(var a=0;a<n.add.length;a++)n.add[a].ws&&n.add[a].id==o.id&&(n.add[a].id=o.previousSibling?o.previousSibling.id:0);this.todorm.push([s,o])}t<n.remove.length-1?e(t+1,n,r):r()}else t<n.remove.length-1?e(t+1,n,r):r()})}(0,e,function(){for(var t=0;t<this.todorm.length;t++)this.todorm[t][0].removeChild(this.todorm[t][1]);!function(e){!function e(t,n,r){Eden.Selectors.query(n.add[t].path,void 0,void 0,function(i){var s=i[0];if(s){if(this.frags[n.add[t].path]=s,n.add[t].ws){var o=new Eden.AST.DummyStatement;if(o.source=n.add[t].source,o.numlines=o.source.split("\n").length-1,0==n.add[t].id)s.statements[0]?s.insertBefore(s.statements[0],o):s.appendChild(o),o.buildID();else{for(var a=0;a<s.statements.length;a++)if(s.statements[a].id==n.add[t].id){var d=s.statements[a].nextSibling;d?s.insertBefore(d,o):s.appendChild(o),o=void 0;break}o&&(s.appendChild(o),o.buildID())}}else{var o=Eden.AST.parseStatement(n.add[t].source);s.statements[n.add[t].index]?s.insertBefore(s.statements[n.add[t].index],o):s.appendChild(o)}t<n.add.length-1?e(t+1,n,r):r()}else t<n.add.length-1?e(t+1,n,r):r()})}(0,e,function(){for(var t in this.frags)Eden.Fragment.emit("patch",[void 0,this.frags[t]]);n.broadcastExcept(e.id,e)})}(e)})}function i(e,t){var i=JSON.parse(t);i.id=e.peer;var s=n.connections[i.id];switch(i.cmd){case"assign":s.observe&&function(e){var t=eden.root.lookup(e.symbol),r=Eden.AST.parseExpression(e.value);t.assign(r.execute({},EdenSymbol.netAgent,eden.root.scope),eden.root.scope,EdenSymbol.netAgent),n.broadcastExcept(e.id,e)}(i);break;case"define":s.observe&&function(e){eden.root.lookup(e.symbol);var t=Eden.AST.parseStatement(e.source);t.local=!0,t.execute({},EdenSymbol.netAgent,eden.root.scope),n.broadcastExcept(e.id,e)}(i);break;case"do":s.observe&&processDo(i);break;case"listassign":s.observe&&function(e){var t=eden.root.lookup(e.symbol),r=Eden.AST.parseExpression(e.value);t.listAssign(r.execute({},EdenSymbol.netAgent,eden.root.scope),eden.root.scope,EdenSymbol.netAgent,!1,e.components),n.broadcastExcept(e.id,e)}(i);break;case"restore":s.observe&&function(e){n.loading=!0,eden.root.lookup("jseden_project_mode").assign(eden.root.lookup("jseden_p2p_doactive").value()?"restore":"normal",eden.root.scope,Symbol.defaultAgent),eden.project=new Eden.Project(e.pid,e.name,e.script),Eden.Project.emit("loading",[eden.project]),eden.project.vid=e.vid,eden.project.title=e.title,eden.project.author=e.ownername,eden.project.authorid=e.owner,eden.project.start(function(){Eden.Project.emit("load",[eden.project]),n.loading=!1})}(i);break;case"execstatus":s.observe;break;case"register":!function(e){console.log("Register peer",e.id,e.username),Eden.Peer.emit("user",[e.id,e.username]),eden.root.lookup("jseden_p2p_"+e.id+"_name").assign(e.username,eden.root.scope,EdenSymbol.localJSAgent),n.connections[e.id].connection.send(JSON.stringify({cmd:"status",status:"Connected",code:1}))}(i);break;case"status":Eden.Peer.emit("status",[i.status,i.code]);break;case"getsnapshot":!function(e){var t=eden.project.generate();n.connections[e.id].connection.send(JSON.stringify({cmd:"callback",data:t,cbid:e.cbid}))}(i);break;case"callback":!function(e){var t=n.callbacks[e.cbid];t&&t(e.data),delete n.callbacks[e.cbid]}(i);break;case"reqshare":!function(e){var t=n.connections[e.id];if(e.value){if(t.share=!0,eden.project&&n.clone){var r=eden.project.generate();t.connection.send(JSON.stringify({cmd:"restore",script:r,pid:eden.project.id,vid:eden.project.vid,ownername:eden.project.author,owner:eden.project.authorid,name:eden.project.name,title:eden.project.title}))}t.connection.send(JSON.stringify({cmd:"callback",data:!0,cbid:e.cbid})),Eden.Peer.emit("share",[e.id])}else t.share=!1,Eden.Peer.emit("unshare",[e.id])}(i);break;case"reqobserve":!function(e){var t=n.connections[e.id];e.value?(t.observe=!0,t.connection.send(JSON.stringify({cmd:"callback",data:!0,cbid:e.cbid})),Eden.Peer.emit("observe",[e.id])):(t.observe=!1,Eden.Peer.emit("unobserve",[e.id]))}(i);break;case"patch":!function(e){this.frags={},this.todorm=[],r(e)}(i);break;case"when":!function(e){console.log("ProcessWhen",e),Eden.Selectors.query(".id("+e.wid+")",void 0,void 0,function(t){for(var n=0;n<t.length;n++)e.status?eden.project.registerAgent(t[n],!0):eden.project.removeAgent(t[n],!0)})}(i);break;case"require":!function(e){edenUI.loadPlugin(e.name)}(i);break;case"call":!function(e){var t=eden.root.lookup(e.name);try{t.value().apply(t,e.args)}catch(e){}}(i)}n.config.logging&&console.log(i)}function s(r){if(!n.enabled){if(r){var s;r.replace(/[ \!\'\-\?\&]/g,"");s=t?new Peer(t,{config:{iceServers:[{url:"stun:stun.l.google.com:19302"}]}}):new Peer({config:{iceServers:[{url:"stun:stun.l.google.com:19302"}]}}),(t||e)&&(n.enabled=!0),s.on("open",function(t){if(console.log("My peer id is "+t),e){var o=s.connect(e,{reliable:!0});o.on("open",function(){n.connections[o.peer]={id:o.peer,username:void 0,connection:o,share:!1,observe:!1},o.on("data",function(e){i(o,e)}),eden.root.lookup("jseden_p2p_newconnections").append(o.peer,eden.root.scope,EdenSymbol.localJSAgent),o.send(JSON.stringify({cmd:"register",username:r,id:t}))})}}),s.on("connection",function(e){n.connections[e.peer]={id:e.peer,username:void 0,connection:e,share:!1,observe:!1},e.on("data",function(t){i(e,t)}),console.log("Peer connection from "+e.peer),Eden.Peer.emit("peer",[e.peer]),eden.root.lookup("jseden_p2p_newconnections").append(e.peer,eden.root.scope,EdenSymbol.localJSAgent),e.on("open",function(){if(n.config.share&&n.clone){var t=eden.project.generate();e.connection.send(JSON.stringify({cmd:"restore",script:t,pid:eden.project.id,vid:eden.project.vid,ownername:eden.project.author,owner:eden.project.authorid,name:eden.project.name,title:eden.project.title}))}})}),s.on("error",function(e){console.log("Peer error: ",e),Eden.Peer.emit("error",[e]),eden.root.lookup("jseden_p2p_errors").append(e,eden.root.scope,EdenSymbol.localJSAgent)}),s.on("disconnected",function(e){Eden.Peer.emit("disconnect",[e.peer,n.connections[e.peer]?n.connections[e.peer].username:void 0]),delete n.connections[e.peer],eden.root.lookup("jseden_p2p_newdisconnections").append(e.peer,eden.root.scope,EdenSymbol.localJSAgent)})}Eden.Fragment.listenTo("patch",this,function(e,t,r){if(r&&r.length>0&&n.capturepatch){var i={cmd:"patch",remove:r[1],add:r[0]};n.broadcast(i)}})}}this.roles={},this.enabled=!1,this.loading=!1,this.config={control:!0,share:!1,observe:!1,logging:!1},this.callbacks={},this.callbackid=0,this.capturepatch=!1,this.record=!1,this.clone=!0,this.startrecordtime=0,this.log=null,this.frags={},this.todorm=[],void 0===eden.root.lookup("jseden_p2p_newconnections").value()&&eden.root.lookup("jseden_p2p_newconnections").assign([],eden.root.scope,EdenSymbol.defaultAgent),void 0===eden.root.lookup("jseden_p2p_newdisconnections").value()&&eden.root.lookup("jseden_p2p_newdisconnections").assign([],eden.root.scope,EdenSymbol.defaultAgent),void 0===eden.root.lookup("jseden_p2p_errors").value()&&eden.root.lookup("jseden_p2p_errors").assign([],eden.root.scope,EdenSymbol.defaultAgent),void 0===eden.root.lookup("jseden_p2p_doactive").value()&&eden.root.lookup("jseden_p2p_doactive").assign(!0,eden.root.scope,EdenSymbol.defaultAgent),Eden.Selectors.execute("lib > p2p"),Eden.DB.listenTo("login",this,s),(e||Eden.DB.isLoggedIn()&&t)&&s(Eden.DB.username?Eden.DB.username:"Anonymous"),eden.root.lookup("jseden_p2p_captureinput").addJSObserver("p2p",function(e,t){t?(EdenSymbol.hciAgent.local=!1,EdenSymbol.localJSAgent.local=!1):(EdenSymbol.hciAgent.local=!0,EdenSymbol.localJSAgent.local=!0)});var o=eden.root.lookup("jseden_p2p_clone");void 0===o.value()&&o.assign(!0,eden.root.scope,EdenSymbol.defaultAgent),o.addJSObserver("p2p",function(e,t){n.clone=!!t}),eden.root.lookup("jseden_p2p_captureedits").addJSObserver("p2p",function(e,t){n.capturepatch=t}),eden.root.lookup("jseden_p2p_record").addJSObserver("p2p",function(e,t){n.record=t,t&&(n.startrecordtime=Date.now(),n.log=[])}),edenUI.views.Peers={dialog:function(e,t){e.slice(0,-7),$('<div id="'+e+'"></div>').html("").dialog({title:"Peer Connections",width:200,height:300,minHeight:120,minWidth:100})},title:"Connections",category:edenUI.viewCategories.environment},edenUI.menu.updateViewsMenu()},Eden.Peer.listeners={},Eden.Peer.emit=emit,Eden.Peer.listenTo=listenTo,Eden.Peer.prototype.broadcast=function(e){if(!this.loading)for(var t in e=JSON.stringify(e),this.record&&this.log.push('{"timestamp": '+(Date.now()-this.startrecordtime)+', "message": "'+e+'"}'),this.connections){var n=this.connections[t];n.share&&n.connection.send(e)}},Eden.Peer.prototype.broadcastExcept=function(e,t){if(!this.loading&&void 0!==this.id)for(var n in t=JSON.stringify(t),this.connections)if(n!=e){var r=this.connections[n];r.share&&r.connection.send(t)}},Eden.Peer.prototype.authoriseWhen=function(e){if(this.enabled){if(e.roles){var t=e.roles;if(t&&t.length>0){for(var n=0;n<t.length;n++)if(this.roles[t[n]])return!0;return!1}}return!0}return!0},Eden.Peer.prototype.assign=function(e,t,n){!e||e.loading||e.local||this.broadcast({cmd:"assign",symbol:t,value:Eden.edenCodeForValue(n)})},Eden.Peer.prototype.define=function(e,t,n,r){!e||e.loading||e.local||this.broadcast({cmd:"define",symbol:t,source:n,dependencies:r})},Eden.Peer.prototype.doRequire=function(e){this.broadcast({cmd:"require",name:e})},Eden.Peer.prototype.doImport=function(e,t){},Eden.Peer.prototype.callProcedure=function(e,t){this.broadcast({cmd:"call",name:e,args:t})},Eden.Peer.prototype.activateWhen=function(e){this.broadcast({cmd:"when",status:!0,wid:e})},Eden.Peer.prototype.deactivateWhen=function(e){this.broadcast({cmd:"when",status:!1,wid:e})},Eden.Peer.prototype.listAssign=function(e,t,n,r){!e||e.loading||e.local||this.broadcast({cmd:"listassign",symbol:t,value:Eden.edenCodeForValue(n),components:r})},Eden.Peer.prototype.addCallback=function(e){var t=this.callbackid++;return this.callbacks[t]=e,t},Eden.Peer.prototype.getSnapshot=function(e,t){this.connections[e]&&this.connections[e].connection.send(JSON.stringify({cmd:"getsnapshot",cbid:this.addCallback(t)}))},Eden.Peer.prototype.requestShare=function(e,t){var n=this.connections[e];n&&(n.observe=!0,n.connection.send(JSON.stringify({cmd:"reqshare",value:!0,cbid:this.addCallback(t)})))},Eden.Peer.prototype.requestUnShare=function(e,t){var n=this.connections[e];n&&(n.observe=!1,n.connection.send(JSON.stringify({cmd:"reqshare",value:!1,cbid:this.addCallback(t)})))},Eden.Peer.prototype.requestObserve=function(e,t){var n=this.connections[e];if(n&&(n.share=!0,n.connection.send(JSON.stringify({cmd:"reqobserve",value:!0,cbid:this.addCallback(t)})),eden.project&&this.clone)){var r=eden.project.generate();n.connection.send(JSON.stringify({cmd:"restore",script:r,pid:eden.project.id,vid:eden.project.vid,ownername:eden.project.author,owner:eden.project.authorid,name:eden.project.name,title:eden.project.title}))}},Eden.Peer.prototype.requestUnObserve=function(e,t){var n=this.connections[e];n&&(n.share=!1,n.connection.send(JSON.stringify({cmd:"reqobserve",value:!1,cbid:this.addCallback(t)})))},Eden.Peer.prototype.requestCollaborate=function(e,t){var n=this,r=this.connections[e];if(r&&(r.connection.send(JSON.stringify({cmd:"reqshare",value:!0,cbid:this.addCallback(function(){r.observe=!0,n.requestObserve(e,t)})})),eden.project&&n.clone)){var i=eden.project.generate();r.connection.send(JSON.stringify({cmd:"restore",script:i,pid:eden.project.id,vid:eden.project.vid,ownername:eden.project.author,owner:eden.project.authorid,name:eden.project.name,title:eden.project.title}))}},Eden.Peer.prototype.requestUnCollaborate=function(e,t){},Eden.AST.DummyContext={subscribeDynamic:function(e,t){return eden.root.lookup(t)},scopes:[]},Eden.AST.prototype.executeGenerator=function*(e,t,n,r,i){var s=[];this.executed=1;var o=0;if(void 0!==e)for(;o<e.length||s.length>0;)if(o>=e.length&&s.length>0)e=s[s.length-1].statements,o=s[s.length-1].index,r=s[s.length-1].scope,s.pop(),!0;else{if(Eden.AST.debug&&"script"!=e[o].type)if(Eden.AST.debugstep||i&&i.doDebug&&i.doDebug())yield{type:"debug",base:n,script:this,index:o,statement:e[o],context:t,agent:i};if("wait"==e[o].type)e[o].executed=1,e[o].compile(t),e[o].compiled_delay?yield e[o].compiled_delay(eden.root,r):yield 0;else if("import"==e[o].type)void 0===e[o].statements&&(e[o].selector=e[o].path?e[o].path.execute(t,n,r,i):void 0,yield e[o]);else if("query"==e[o].type&&e[o].modexpr)e[o].executed=1,e[o]._selector=e[o].selector.execute(t,n,r,i),e[o]._modexpr=e[o].modexpr.execute(t,n,r,i),yield e[o];else if("do"==e[o].type)e[o].executed=1,e[o].selector=e[o].name?e[o].name.execute(t,n,r,i):void 0,e[o].params=e[o].getParameters(void 0,n,r),e[o].nscope=e[o].scope?e[o].getScope(t)(eden.root,r):r,yield e[o];else if("when"==e[o].type){var a=e[o];if(0==a.active)a.active=!0,(d=a.execute(void 0,n,eden.root.scope,i))?n.executeStatements(d,-1,a):a.active=!1}else{var d;if((d=e[o].execute(t,n,r,i))&&Array.isArray(d)&&d.length>0){var h=r;"scopedscript"==e[o].type&&(h=e[o].scope),++o<e.length&&s.push({statements:e,index:o,scope:r}),e=d,r=h,o=0;continue}}e[o].errors.length>0&&this.script.errors.push.apply(this.script.errors,e[o].errors),o++}},Eden.AST.prototype.executeStatement=function(e,t,n,r){Eden.AST.debug&&(Eden.AST.debugstep||n&&n.doDebug&&n.doDebug())&&Eden.AST.debug_begin_cb&&Eden.AST.debug_begin_cb({base:this,agent:n}),Eden.AST.DummyContext.locals=void 0;let i={cb:r};try{var s=this.executeGenerator([e],i,this,eden.root.scope,n);runEdenAction.call(this,n,s,function(){Eden.AST.debug&&(Eden.AST.debugstep||n&&n.doDebug&&n.doDebug())&&Eden.AST.debug_end_cb&&Eden.AST.debug_end_cb({base:this,agent:n}),r&&r()})}catch(e){var o;Eden.AST.debug&&(Eden.AST.debugstep||n&&n.doDebug&&n.doDebug())&&Eden.AST.debug_end_cb&&Eden.AST.debug_end_cb({base:this,agent:n}),r&&r(),(o=/[0-9][0-9]*/.test(e.message)?new Eden.RuntimeError(this,parseInt(e.message),void 0,e.message):new Eden.RuntimeError(this,0,void 0,e)).line=this.line,n?eden.emit("error",[n,o]):console.log(o.prettyPrint())}},Eden.AST.prototype.executeStatements=function(e,t,n,r,i,s){void 0===s&&(s=eden.root.scope),Eden.AST.debug&&(Eden.AST.debugstep||n&&n.doDebug&&n.doDebug())&&Eden.AST.debug_begin_cb&&Eden.AST.debug_begin_cb({base:this,agent:n});try{var o=this.executeGenerator(e,i,this,s,n);runEdenAction.call(this,n,o,function(){Eden.AST.debug&&(Eden.AST.debugstep||n&&n.doDebug&&n.doDebug())&&Eden.AST.debug_end_cb&&Eden.AST.debug_end_cb({base:this,agent:n}),r&&r()})}catch(e){var a;Eden.AST.debug&&(Eden.AST.debugstep||n&&n.doDebug&&n.doDebug())&&Eden.AST.debug_end_cb&&Eden.AST.debug_end_cb({base:this,agent:n}),r&&r(),(a=/[0-9][0-9]*/.test(e.message)?new Eden.RuntimeError(this,parseInt(e.message),void 0,e.message):new Eden.RuntimeError(this,0,void 0,e)).line=this.line,n?eden.emit("error",[n,a]):console.log(a.prettyPrint())}};