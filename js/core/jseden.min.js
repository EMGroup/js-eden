function noop(){}function get_time_diff(e){var t=1e3*e,n=Date.now();if(t-=6e4*(new Date).getTimezoneOffset(),isNaN(t))return"";e=t<n?n-t:t-n;n=Math.floor(e/1e3/60/1440),e=new Date(e);if(5<n)return new Date(t).toDateString();var r,t="";return 0<n?(t+=n,t+=1<n?" days ago":" day ago"):0<e.getUTCHours()?(t+=r=e.getUTCHours(),t+=1<r?" hours ago":" hour ago"):0<(r=e.getUTCMinutes())?(t+=r,t+=1<r?" minutes ago":" minute ago"):(t+=e.getUTCSeconds(),t+=" seconds ago"),t}function generateTimeStamp(e){for(var t,n=/(\d*)(minutes|minute|min|hours|hour|days|day|weeks|week|months|month|mon|years|year|Quarters|Quarter|seconds|second|sec|s|m|h|d|M|y|Y|Q|ms|w)/g,r=0;null!==(t=n.exec(e));)switch(console.log("Reltime:",t),t[2]){case"second":case"seconds":case"s":r+=1e3*parseInt(t[1]);break;case"minute":case"minutes":case"m":r+=6e4*parseInt(t[1]);break;case"hour":case"hours":case"h":r+=36e5*parseInt(t[1]);break;case"days":case"d":r+=36e5*parseInt(t[1])*24}return r}function hashCode(e){var t=0;if(0==e.length)return t;for(i=0;i<e.length;i++)char=e.charCodeAt(i),t=(t<<5)-t+char,t&=t;return t}function getTextWidth(e,t){var n=(getTextWidth.canvas||(getTextWidth.canvas=document.createElement("canvas"))).getContext("2d");return n.font=t,n.measureText(e).width}function unListen(e){for(var t in this.listeners)for(var n=this.listeners[t],r=0;r<n.length;r++)if(n[r].target===e){n.splice(r,1);break}}function listenTo(e,t,n){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push({target:t,callback:n})}function emit(e,t){var n=this.listeners[e];if(n){for(var r=0;r<n.length;++r){var i=n[r].target;if(n[r].callback.apply(i,t))return!0}return!1}}function concatAndResolveUrl(e,t){for(var n=e.split("/"),r=t.split("/"),i=[],s=0,o=n.length;s<o;s++)".."==n[s]?i.pop():"."!=n[s]&&i.push(n[s]);for(s=0,o=r.length;s<o;s++)".."==r[s]?i.pop():"."!=r[s]&&i.push(r[s]);return i.join("/")}function ajaxGet(r){return new Promise((e,t)=>{var n=new XMLHttpRequest;n.open("GET",r),n.onload=function(){200<=this.status&&this.status<300?e(n.response):t({status:this.status,statusText:n.statusText})},n.onerror=function(){t({status:this.status,statusText:n.statusText})},n.send()})}function ajaxPost(r,i){return new Promise((e,t)=>{var n=new XMLHttpRequest;n.open("POST",r),n.onload=function(){200<=this.status&&this.status<300?e(JSON.parse(n.response)):t({status:this.status,statusText:n.statusText})},n.onerror=function(){t({status:this.status,statusText:n.statusText})},n.send(i)})}if(mobilecheck=function(){if(void 0!==Eden.mobile)return Eden.mobile;var e,t=!1;return e=navigator.userAgent||navigator.vendor||window.opera,(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))&&(t=!0),Eden.mobile=t},Utils={flatten:function(e){for(var t=[],n=0,r=e.length;n<r;++n)t=t.concat(e[n]instanceof Array?this.flatten(e[n]):e[n]);return t},construct:function(){function i(){}return function(e){i.prototype=e.prototype;for(var t=new i,n=[],r=1;r<arguments.length;r++)n.push(arguments[r]);return e.apply(t,n),t}}()},"undefined"!=typeof require&&"undefined"!=typeof exports){const fs=require("fs");Utils.getURL=function(e){return(e.startsWith("plugins")||e.startsWith("resources"))&&(e=URLUtil.prefix+e),new Promise((n,r)=>{fs.readFile(e,"utf8",function(e,t){e?r(e):n(t)})})}}else Utils.getURL=function(e){return ajaxGet(e=e.startsWith("plugins")||e.startsWith("resources")?URLUtil.prefix+e:e)};"undefined"!=typeof require&&"undefined"!=typeof exports&&(exports.get_time_diff=get_time_diff,exports.noop=noop,exports.listenTo=listenTo,exports.emit=emit,exports.unListen=unListen,exports.flatten=Utils.flatten,exports.construct=Utils.construct,exports.getURL=Utils.getURL),function(e){function l(e){this.root=e||new l.Folder(null,this),(this.root.base=this).dictionary={},this.options={},this.errorNumber=0,this.listeners={},this.reportErrors=!0,this.ready=l.Project.init(this)}var t;l.edenFunctions={apply:!0,array:!0,canvasURL:!0,centroid:!0,char:!0,charCode:!0,choose:!0,compose:!0,concat:!0,curry:!0,decodeHTML:!0,definitionOf:!0,definitionRHS:!0,doDefault:!0,edenCode:!0,escapeRE:!0,foldl:!0,foldr:!0,hasProperty:!0,hslColour:!0,htmlBulletList:!0,htmlNumberedList:!0,positionInList:!0,positionOfRE:!0,substringPosition:!0,int:!0,isBoolean:!0,isCallable:!0,isChar:!0,isDefined:!0,isDependency:!0,isDependent:!0,isFunc:!0,isInt:!0,isList:!0,isNaN:!0,isNumber:!0,isObject:!0,isPoint:!0,isPointer:!0,isProc:!0,isString:!0,isValue:!0,distanceMoved:!0,angleTurned:!0,List:!0,listcat:!0,lookup:!0,lowercase:!0,map:!0,mapPartial:!0,max:!0,Menu:!0,MenuItem:!0,min:!0,mod:!0,nameof:!0,partApply:!0,Point:!0,pow:!0,properties:!0,randomBoolean:!0,randomFloat:!0,randomInteger:!0,RE:!0,replaceFirst:!0,reverse:!0,rgbColour:!0,rotatePoint:!0,round:!0,roundMultiple:!0,scalePoint:!0,search:!0,sequenceItoJ:!0,sequenceN:!0,sequenceArithmeticN:!0,sequenceList:!0,sequencePrevious:!0,sort:!0,str:!0,sqrt:!0,strcat:!0,sublist:!0,substitute:!0,substr:!0,sum:!0,tail:!0,trim:!0,type:!0,uppercase:!0,include_css:!0,html:!0,time:!0,execute:!0,Text:!0,textWidth:!0,textHeight:!0,Arc:!0,Curve:!0,FillPattern:!0,Ellipse:!0,Line:!0,LinearGradient:!0,LineSequence:!0,PixelList:!0,GreyPixelList:!0,Rectangle:!0,RotateAboutCentre:!0,RotateAboutPoint:!0,CombinedRotation:!0,Scale:!0,Translate:!0,RoundedRectangle:!0,Polygon:!0,RegularPolygon:!0,Sector:!0,Shadow:!0,Circle:!0,Button:!0,Checkbox:!0,Div:!0,Image:!0,imageWithZones:!0,HTMLImage:!0,RadioButtons:!0,Slider:!0,Textbox:!0,DropDownList:!0,Combobox:!0,BulletSlide:!0,Video:!0,Audio:!0,Slide:!0,TitledSlide:!0,TitleSlide:!0,cos:!0,sin:!0,tan:!0,abs:!0,acos:!0,asin:!0,atan:!0,ceil:!0,roundUp:!0,exp:!0,floor:!0,roundDown:!0,log:!0,random:!0,forget:!0,forgetAll:!0,shapeOnTopAt:!0,zoneOnTopAt:!0,observableOnTopAt:!0,shapeOnBottomAt:!0,zoneOnBottomAt:!0,observableOnBottomAt:!0,shapesAt:!0,zonesAt:!0,observablesAt:!0,observableForShape:!0,alias:!0,arrangeWindows:!0,attemptMouseCapture:!0,bindCSSNumericProperty:!0,bindCSSProperty:!0,bindCSSRule:!0,createCanvas:!0,createHTMLView:!0,createProjectList:!0,createView:!0,destroyView:!0,eager:!0,error:!0,hideView:!0,highlightView:!0,moveView:!0,patch:!0,removeedenclock:!0,resizeView:!0,setedenclock:!0,showObservables:!0,showView:!0,stopHighlightingView:!0,todo:!0,touch:!0,unbind:!0,withAppendedItem:!0,writeln:!0},e.Eden=l,"undefined"!=typeof require&&"undefined"!=typeof exports?(e.rt=require("./runtime").rt,require("./symbol"),require("./context"),require("./scope"),require("./warnings"),require("../language/lang"),require("../language/en"),require("../selectors/selector"),require("../ast/ast"),require("../lex"),require("./engine"),require("./errors"),require("../index"),t=require("../util/misc"),e.listenTo=t.listenTo,e.emit=t.emit,e.unListen=t.unListen,l.Utils=t,require("../project")):l.Utils=Utils,l.logging=!1,l.create=function(){return new Promise((t,e)=>{let n=new l;n.ready.then(e=>{t(n)})})},l.prototype.updateDictionary=function(e,t,n){this.dictionary[e]=t},l.isValidIdentifier=function(e){return Boolean(e&&/^[_a-zA-Z$]\w*$/.test(e))},l.load=function(r,i,s,o){console.log("Loading project: "+r+"@"+i),l.DB.load(r,i,void 0,function(e){var t,n;"object"==typeof e&&EdenUI.MenuBar.saveTitle(e.title),eden.root.lookup("_jseden_loaded").assign(!0,eden.root.scope),o||(t=URLUtil.getParameterByName("master"),n=URLUtil.getParameterByName("id"),e="?load="+r+"&tag="+i,""!=n&&(e+="&id="+n),""!=t&&(e+="&master="+t),window.history.pushState({project:r,tag:i},"",e)),s&&s()})},l.reset=function(){edenUI.destroyAllViews(),eden.reset()},l.prototype.reset=function(){this.root.forgetAll("",!0,!1),this.root.collectGarbage(),this.errorNumber=0,this.reportErrors=!0},l.prototype.listenTo=listenTo,l.prototype.emit=emit,l.prototype.error=function(e,t,n){throw new l.RuntimeError(this.root,n||0,void 0,e)},l.prototype.assign=function(e,t,n){this.root.lookup(e).assign(t,n||this.root.scope,EdenSymbol.hciAgent)},l.prototype.get=function(e,t){return this.root.lookup(e).value(t)},l.prototype.getAttribute=function(e,t){e="string"==typeof e?this.root.lookup(e):e;return l.Selectors.processResults([e],t)[0]},l.prototype.execute2=function(e,t,n){var r=t;void 0!==t&&"string"!=typeof t||(r={name:"*execute"},t&&(r.name=t));e=new l.AST(e,void 0,r,{noindex:!0});0==e.script.errors.length?e.execute(r,this.root.scope,n):(console.error(e.script.errors[0].prettyPrint()),n&&n(!1))},l.prototype.execute=l.prototype.execute2,l.prototype.exec=function(i){return new Promise((t,e)=>{var n={name:"*execute"},r=new l.AST(i,void 0,n,{noindex:!0});0==r.script.errors.length?r.execute(n,this.root.scope,e=>{t(e)}):e(r.script.errors[0].messageText())})},l.prototype.evalEden=function(e,t,n){var r;if("string"==typeof e){if(0<(r=l.AST.parseExpression(e)).errors.length)return void this.emit("error",[{name:t?t.name:"Inline"},r.errors[0]])}else r=e;n=n||this.root.scope;t={symbol:t,isconstant:!0,statement:t?t.origin:null};return l.AST.executeExpressionNode(r,n,t)},l.prototype.transpileExpression=function(e,t,n){var r=l.AST.parseExpression(e);if(!(0<r.errors.length)){n=n||this.root.scope;e={symbol:t,isconstant:!0,statement:t?t.origin:null};return l.AST.transpileExpressionNode(r,n,e)}this.emit("error",[{name:t?t.name:"Inline"},r.errors[0]])},l.prototype.parseExpression=function(e,t){if("string"!=typeof e)return err=new l.RuntimeError(this.root,l.RuntimeError.ARGUMENTS,null,"`parse()` requires a string"),void this.emit("error",[{name:t?t.name:"Inline"},err]);e=l.AST.parseExpression(e);if(!(0<e.errors.length))return e;this.emit("error",[{name:t?t.name:"Inline"},e.errors[0]])},l.edenCodeForValue=function(e,t,n){var r=typeof e,i="";if("undefined"==r)i="@";else if(null===e)i="${{ null }}$";else if("string"==r)i=0<=e.indexOf("\n")?"<<END\n"+e.replace(/\n/g,"\\n")+"\nEND":'"'+e.replace(/\\/g,"\\\\").replace(/\"/g,'\\"')+'"';else if(Array.isArray(e))if(-1!=(t=void 0===t?[]:t).indexOf(e))i+="<<circular reference>>";else{t.push(e);for(var i="[",s=0;s<e.length-1;s++)i=i+l.edenCodeForValue(e[s],t,n)+", ";0<e.length&&(i+=l.edenCodeForValue(e[e.length-1],t,n)),i+="]",t.pop()}else if("object"==r){if("getEdenCode"in e?i=e.getEdenCode(n):"keys"in e&&Array.isArray(e.keys)&&0<e.keys.length&&"parent"in e&&e.parent instanceof Symbol?i="&"+e.parent.name.slice(1)+"["+e.keys[0]+"]":"object"==typeof window&&"object"==typeof document&&"function"==typeof Element&&(e==window?i="${{ window }}$":e==document?i="${{ document }}$":e==document.documentElement?i="${{ document.documentElement }}$":e==document.body?i="${{ document.body }}$":e instanceof Element&&e.id&&(i='${{ document.getElementById("'+e.id+'") }}$')),""==i)if(-1!=(t=void 0===t?[]:t).indexOf(e))i+="<<circular reference>>";else{for(var o in t.push(e),i="{",e)o in Object.prototype||(i=i+o+": "+l.edenCodeForValue(e[o],t,n)+", ");"{"!=i&&(i=i.slice(0,-2)),i+="}",t.pop()}}else i="function"==r?"${{\n\t"+e.toString().replace(/\n/g,"\n\t")+"\n}}$":"number"==r&&n?e.toFixed(n):String(e);return i},l.edenCodeForValues=function(){for(var e="",t=0;t<arguments.length-1;t++)e=e+l.edenCodeForValue(arguments[t])+", ";return e+=l.edenCodeForValue(arguments[arguments.length-1])},l.edenCodeForValuesP=function(e){for(var t="",n=1;n<arguments.length-1;n++)t=t+l.edenCodeForValue(arguments[n],void 0,e)+", ";return t+=l.edenCodeForValue(arguments[arguments.length-1],void 0,e)},l.intersection=function(e,t){return Object.keys(e).filter({}.hasOwnProperty.bind(t))},l.prettyPrintValue=function(e,t,n,r,i,s){void 0===i&&(i=!0);var o=typeof t,a="",d=!1;if("undefined"==o)a="@";else if(null===t)a="${{ null }}$";else if("string"==o)a='"'+t.replace(/\\/g,"\\\\").replace(/\"/g,'\\"')+'"',void 0!==n&&a.length>n+1&&(a=a.slice(0,n)+"...",d=!0);else if(Array.isArray(t))if(-1!=(s=void 0===s?[]:s).indexOf(t))a+="...";else{s.push(t);for(var a="[",c=0;c<t.length-1;c++){if(a=l.prettyPrintValue(a,t[c],n,r,i,s)+",",void 0!==n&&a.length>=n-1){"..."!=a.slice(-3)&&(a+="..."),d=!0;break}a+=" "}0<t.length&&!d&&(a=l.prettyPrintValue(a,t[t.length-1],n,r,i,s)),a+="]",s.pop()}else if("object"==o){if(t instanceof Symbol?a=t.getEdenCode():"keys"in t&&Array.isArray(t.keys)&&0<t.keys.length&&"parent"in t&&t.parent instanceof Symbol?a="&"+t.parent.name.slice(1)+"["+t.keys[0]+"]":"object"==typeof window&&"object"==typeof document&&"function"==typeof Element&&(t==window?a="${{ window }}$":t==document?a="${{ document }}$":t==document.documentElement?a="${{ document.documentElement }}$":t==document.body?a="${{ document.body }}$":t instanceof Element&&t.id&&(a='${{ document.getElementById("'+t.id+'") }}$')),""==a)if(t.toString!=Object.prototype.toString)a=t.toString(),void 0!==n&&a.length>n&&(a=a.slice(0,n)+"...",d=!0);else if(-1!=(s=void 0===s?[]:s).indexOf(t))a+="...";else{s.push(t);var h,p=!(a="{");for(h in t)if(!(h in Object.prototype)){if(p){a=a.slice(0,-1)+"...",d=!0;break}if(a=a+h+": ","..."==(a=l.prettyPrintValue(a,t[h],n,r,i,s)).slice(-3)){d=!0;break}void 0!==n&&a.length>=n&&(p=!0),a+=", "}"{"==a||d||(a=a.slice(0,-2)),a+="}",s.pop()}}else"function"==o?r?(a="${{\n\t"+t.toString().replace(/\n/g,"\n\t")+"\n}}$",void 0!==n&&a.length>n&&(a=a.slice(0,n)+"...",d=!0)):a="func":a=String(t);if(e)return e+a;e=(e=l.htmlEscape(a,!i)).replace(/\.\.\./g,"&hellip;");return e=!i?e.replace(/\n/g,"\\n"):e},l.htmlEscape=function(e,t,n){return void 0===e?"":(e=(e=(e=(e=(e=(e=String(e)).replace(/&/g,"&amp;")).replace(/</g,"&lt;")).replace(/>/g,"&gt;")).replace(/"/g,"&quot;")).replace(/'/g,"&#39;"),n?e=t?e.replace(/\n/g," "):e.replace(/\n/g,"<br/>"):t||(e=e.replace(/\n/g,"<br/>\n")),e)},l.prototype.nextEvalID=0,l.prototype.initialDefinition=function(){console.error("INIT DEF DEP")},"undefined"!=typeof require&&"undefined"!=typeof exports&&(exports.Eden=l)}("undefined"!=typeof window?window:global),function(e){function n(e,t){this.getLabel=function(){return e},this.getMenuPriority=function(){return t}}function s(e){this.eden=e,this.views={},this.viewInstances={},this.embeddedInstances={},this.activeDialogs={},this.plugins={};this.loaded=!1,this.branding={},this.$uimsg=$("<div class='message-box'></div>"),this.$uimsg.appendTo("body"),this.$uimsg.hide(),this.messagetimeout=void 0,this.messagedisplaytime=5e3,this.eden.listenTo("executeFileLoad",this,function(e){edenUI.updateStatus("Loading "+e)}),this.eden.listenTo("executeError",this,function(e,t){console.error("DEPRECATED ERROR REPORTING",e);var n=Eden.htmlEscape(e.message),e=(t.errorNumber,t.path&&t.path,"string"==typeof e?e:e.message);edenUI.showMessage("error","Error: "+e)}),this.listeners={},this.windowHighlighter=new WindowHighlighter(this),this.currentView=void 0,this.viewCategories={},this.numberOfViewCategories=0,this.addViewCategory("comprehension","Comprehension"),this.addViewCategory("interpretation","Making Definitions"),this.addViewCategory("history","History &amp; State"),this.addViewCategory("visualization","Visualization"),this.addViewCategory("extension","Extensions"),this.addViewCategory("environment","Management"),$(document).on("click",function(e){if(e.ctrlKey||e.metaKey)for(var t=[],n=e.target;"BODY"!=n.nodeName;){var r=n.getAttribute("data-observables");r&&""!=r&&t.push.apply(t,r.split(",")),n=n.parentNode}})}s.prototype.brieflyHighlightView=function(e){var t=$("#"+viewName+"-dialog").dialog.parent();t.addClass("window-activated"),setTimeout(function(){t.removeClass("window-activated")},600)},s.prototype.cycleNextView=function(){this.stopHighlightingView(this.currentView,!0,!1);var e=Object.keys(this.activeDialogs);if(void 0===this.currentView)this.currentView=e[0];else for(i=0;i<e.length;i++)if(this.currentView==e[i]){this.currentView=e[(i+1)%e.length];break}this.highlightView(this.currentView,!0)},s.prototype.stopViewCycling=function(){this.stopHighlightingView(this.currentView,!0,!0)},s.plugins={},s.prototype.loadPlugin=function(e,t,n){if(2===arguments.length&&(n=t,t={name:"/loadPlugin"}),void 0===s.plugins[e])return this.eden.error("Plugin '"+e+"' does not exist"),n&&n.call(t,!1),!1;eden.peer&&eden.peer.doRequire(e);function r(){i.emit("loadPlugin",[e]),n&&n.call(t)}var i=this;void 0===this.plugins[e]?(this.plugins[e]=!0,this.plugins[e]=new s.plugins[e](this,r)):r()},s.prototype.addViewCategory=function(e,t){this.viewCategories[e]=new n(t,this.numberOfViewCategories),this.numberOfViewCategories++},s.prototype.updateStatus=function(e){this.loaded?this.showMessage("info",e):(console.log(e),$(".loadmessage").html(e))},s.prototype.hideMessage=function(){edenUI.$uimsg.hide("slow")},s.prototype.showMessage=function(e,t){"info"==e?this.$uimsg.html("<div class='message-infotext'>"+t+"</div>"):"error"==e&&this.$uimsg.html("<div class='message-errortext'>"+t+"</div>"),this.$uimsg.show("fast"),clearTimeout(this.messagetimeout),this.messagetimeout=setTimeout(this.hideMessage,this.messagedisplaytime)},s.prototype.finishedLoading=function(){this.loaded=!0},s.prototype.listenTo=listenTo,s.prototype.emit=emit,s.showTooltip=function(e,t){var n=document.getElementById("tooltip"),r=e.clientX+2,i=e.clientY+20,e=window.pageXOffset+window.innerWidth-r-15;e<200&&(r-=200-e,e=200),n.style.left=r+"px",n.style.maxWidth=e+"px",n.style.top=i+"px","string"==typeof t?n.innerHTML=t:(n.innerHTML="",n.appendChild(t)),n.style.display="block";var s=document.querySelectorAll(".ui-front");let o=0;for(var a=0;a<s.length;++a)if("none"!==s[a].style.display){let e=s[a].style.zIndex;"string"==typeof e&&(e=parseInt(e)),e>o&&(o=e)}n.style.zIndex=Math.max(o,1e4)+1},s.closeTooltip=function(){document.getElementById("tooltip").style.display="none"},s.prototype.options={},s.prototype.getOptionValue=function(e){if(e in this.options)return this.options[e];try{if(window.localStorage)return window.localStorage.getItem(e)}catch(e){return null}},s.prototype.setOptionValue=function(e,t){this.options[e]=String(t),this.emit("optionChange",[e,String(t)]);try{if(window.localStorage)return window.localStorage.setItem(e,t),!0}catch(e){return!1}},s.prototype.setDefaultOptionValue=function(e,t){null===this.getOptionValue(e)&&(this.options[e]=String(t),this.emit("optionChange",[e,String(t)]))},s.prototype.unsetOptionValue=function(e){delete this.options[e],this.emit("optionChange",[e,null]);try{window.localStorage&&window.localStorage.removeItem(e)}catch(e){}},s.prototype.fullscreen=function(e,t){var n=eden.root.lookup(t),t=n.value();document.webkitExitFullscreen?t?(document.onwebkitfullscreenchange=function(){document.webkitIsFullScreen||(n.assign(!1,eden.root.scope,Symbol.hciAgent),edenUI.menu.show())},document.getElementById(e+"-canvascontent").webkitRequestFullscreen(),edenUI.menu.hide()):(document.webkitExitFullscreen(),edenUI.menu.show()):document.mozCancelFullScreen&&(t?(document.onmozfullscreenchange=function(){document.mozFullScreen||(n.assign(!1,eden.root.scope,Symbol.hciAgent),edenUI.menu.show())},document.getElementById(e+"-canvascontent").mozRequestFullScreen(),edenUI.menu.hide()):(document.mozCancelFullScreen(),edenUI.menu.show()))},s.prototype.regExpFromStr=function(t,n,r,e){var i,s,o,a=!0;if("object"==typeof t&&(t=(o=t)[0].value),void 0===n&&(n=""),void 0===e)p=!/[\\+^$|({[]|(\.\*[^\s*?])/.test(t)&&"false"!==this.getOptionValue("optSimpleWildcards");else if("simple"==e)p=!0;else{if("regexp"!=e)throw new Error("EdenUI.regExpFromStr: Unsupported search language "+e);p=!1}if(/[A-Z]/.test(t)||(n+="i"),p){for(var d=(t=t.replace(/([\\+^$.|(){[])/g,"\\$1").replace(/([*?])/g,".$1")).split(new RegExp("\\s+(?:"+Language.ui.search.disjunction+"|or)\\s+","i")),c=0;c<d.length;c++){var h=d[c];r||/[?*]/.test(h)?d[c]="^("+h+")$":h.length<3&&(d[c]="^("+h+")")}i=d.join("|"),s=new RegExp(i,n)}else try{i=t,r&&(i="^("+i+")$"),s=new RegExp(i,n)}catch(e){var a=!1,p=t.match(/^([^*+?\\(){[]([^\\()[]*(\\.)?)*)?/)[0];r&&(p="^("+p+")"),s=new RegExp(p,n)}return o&&(a?o.removeClass("invalid_form"):o.addClass("invalid_form")),s},e.EdenUI=s,"undefined"!=typeof require&&"undefined"!=typeof exports&&(exports.EdenUI=s)}("undefined"!=typeof window?window:global),DiffUtil={diff:function(e,t){var n=new diff_match_patch,r=n.diff_main(e,t);n.diff_cleanupSemantic(r),console.log(r);for(var i={remove:{},insert:{}},s=0,o=0,a=0,d=0,c=0;c<r.length;c++){var h=r[c][1].match(/\n/g);if(0!=r[c][0]){if(1==r[c][0]){lines=r[c][1].split("\n");for(var p=0;p<lines.length&&(p!=lines.length-1||0!=lines[p].length);p++)void 0===i.insert[o+p]&&(i.insert[o+p]={oline:s,chars:[]}),i.insert[o+p].chars.push({start:a,length:lines[p].length}),0<p&&(i.insert[o+p].consecutive=!0),i.insert[o+p].partial=null===h,a+=lines[p].length,p<lines.length-1&&a++;null!==h&&(o+=h.length)}else if(-1==r[c][0]){lines=r[c][1].split("\n");for(p=0;p<lines.length&&(p!=lines.length-1||0!=lines[p].length);p++)void 0===i.remove[s+p]&&(i.remove[s+p]={nline:o,chars:[]}),i.remove[s+p].chars.push({start:d,length:lines[p].length}),i.remove[s+p].partial=null===h,0<p&&(i.remove[s+p].consecutive=!0),d+=lines[p].length,p<lines.length-1&&d++;null!==h&&(s+=h.length)}}else null!==h&&(s+=h.length,o+=h.length),d+=r[c][1].length,a+=r[c][1].length}for(var l=e.split("\n"),u=t.split("\n"),E=[0],c=0;c<l.length-1;c++)E.push(l[c].length+E[c]+1);for(var g,f=[0],c=0;c<u.length-1;c++)f.push(u[c].length+f[c]+1);for(g in i.insert)if(0<i.insert[g].chars.length){for(c=0;c<i.insert[g].chars.length;c++)i.insert[g].chars[c].start-=f[g];i.insert[g].iline=u[g]}for(g in i.remove)if(0<i.remove[g].chars.length){for(c=0;c<i.remove[g].chars.length;c++)i.remove[g].chars[c].start-=E[g];i.remove[g].rline=l[g]}return console.log(i),i}},function(){var e={language:"en",loadSymbols:function(e){for(var t in this.symbols)t!=this.symbols[t]&&void 0===e.symbols[this.symbols[t]]&&(e.symbols[this.symbols[t]]=e.lookup(t))},addKeywords:function(e){for(var t in e)this.keywords[t]=e[t]},addSymbols:function(e){for(var t in e)this.symbols[t]=e[t]},importoptions:{readonly:"readonly",remote:"remote",local:"local",rebase:"rebase",noexec:"noexec",reload:"reload",force:"force",async:"async",create:"create",remove:"remove"},selectors:{"has-name":!0,name:!0,type:!0,definition:!0,assignment:!0,script:!0,when:!0,for:!0,if:!0,last:!0,nth:!0,executed:!0,not:!0,unexecuted:!0,remote:!0,value:!0,active:!0,depends:!0},doxytags:{title:"title",author:"author",version:"version",param:"param",return:"return",debug:"debug",local:"local",role:"role",shared:"shared",oracle:"oracle",handle:"handle",deprecated:"deprecated",see:"see","{":"{","}":"}",hidden:"hidden",script:"script"},keywords:{func:"func",function:"func",oracle:"oracle",handle:"handle",proc:"proc",auto:"auto",para:"para",action:"action",procedure:"proc",local:"local",role:"role",if:"if",is:"is",in:"in",else:"else",for:"for",while:"while",do:"do",switch:"switch",case:"case",default:"default",break:"break",continue:"continue",return:"return",when:"when",wait:"wait",import:"import",insert:"insert",append:"append",delete:"delete",require:"require",shift:"shift",with:"with",and:"and",or:"or",not:"not",eval:"eval",sync:"sync",parse:"parse",compile:"compile",exec:"exec",execute:"exec"},symbols:{int:"int",str:"str",round:"round",min:"min",max:"max",random:"random",floor:"floor",ceil:"ceil",abs:"abs",acos:"acos",asin:"asin",atan:"atan",cos:"cos",exp:"exp",ln:"ln",log:"log",mod:"mod",randomInteger:"randomInteger",randomFloat:"randomFloat",sin:"sin",sqrt:"sqrt",sum:"sum",tan:"tan",length:"length",error:"error",substr:"substr",type:"type",createView:"createView",createCanvas:"createCanvas",zonesAt:"zonesAt",execute:"execute",indexOf:"indexOf",forget:"forget",eager:"eager",time:"time",writeln:"writeln",apply:"apply",todo:"todo",char:"char",isBoolean:"isBoolean",isCallable:"isCallable",isChar:"isChar",isDefined:"isDefined",isValue:"isValue",isFunc:"isFunc",isInt:"isInt",isNaN:"isNaN",isNumber:"isNumber",isObject:"isObject",isPoint:"isPoint",isProc:"isProc",showView:"showView",array:"array",sublist:"sublist",reverse:"reverse",search:"search",sort:"sort",tail:"tail",concat:"concat",decodeHTML:"decodeHTML"},values:{true:"true",false:"false"},errors:{}};function t(e){var t=Object.create(null);return Object.assign(t,e),t}(Eden.Language=e).keywords=t(e.keywords),e.values=t(e.values),"undefined"!=typeof require&&"undefined"!=typeof exports&&(exports.Language=e)}();const GLOBAL="undefined"!=typeof global?global:window;GLOBAL.Point=function(e,t){this.x=e,this.y=t},Point.prototype.toString=function(e){return"Point("+Eden.edenCodeForValue(this.x,void 0,e)+", "+Eden.edenCodeForValue(this.y,void 0,e)+")"},Point.prototype.getEdenCode=Point.prototype.toString;var rt={f:{},index:function(e){return"number"==typeof e?e-1:e},flattenPromise:function(e){return e instanceof Promise?e:Array.isArray(e)&&0<e.length&&e[0]instanceof Promise?Promise.all(e):Promise.resolve(e)},length:function(e){if(null!=e)return e.length},equal:function(e,t){var n;if(e===t)return!0;if(e instanceof Array&&t instanceof Array){if(e.length!==t.length)return!1;for(n=0;n<e.length;++n)if(!rt.equal(e[n],t[n]))return!1;return!0}return!1},notequal:function(e,t){return!rt.equal(e,t)},add:function(e,t){if(void 0!==e&&void 0!==t)return e instanceof Point?new Point(e.x+t.x,e.y+t.y):e+t},subtract:function(e,t){if(void 0!==e&&void 0!==t)return e instanceof Point?new Point(e.x-t.x,e.y-t.y):e-t},addA:function(e,t){if(void 0!==e&&void 0!==t)return e+t},subtractA:function(e,t){if(void 0!==e&&void 0!==t)return e-t},multiply:function(e,t){if(void 0!==e&&void 0!==t)return e*t},divide:function(e,t){if(void 0!==e&&void 0!==t)return e/t},mod:function(e,t){if(void 0!==e&&void 0!==t)return e%t},pow:function(e,t){if(void 0!==e&&void 0!==t)return Math.pow(e,t)},concat:function(e,t){if(void 0!==e&&void 0!==t){if(Array.isArray(e)){if(Array.isArray(t))return e.concat(t);throw new Error(Eden.RuntimeError.LEFTCONCAT)}if(Array.isArray(t))throw new Error(Eden.RuntimeError.RIGHTCONCAT);return String(e)+t}},concatS:function(e,t){if(void 0!==e&&void 0!==t)return String(e)+t},regExpMatch:function(e,t){if(void 0!==e&&void 0!==t)return(t instanceof RegExp?t:new RegExp(t)).test(e)},regExpNotMatch:function(e,t){if(void 0!==e&&void 0!==t)return t instanceof RegExp?!t.test(e):!new RegExp(t).test(e)}};function WindowHighlighter(e){this.edenUI=e,this.lastDialog=void 0,this.lastDialogMinimized=!1,this.lastDialogHidden=!1,this.previousZIndex=void 0}function ScopeCache(e,t,n,r){this.up_to_date=e,this.value=t,this.symbol=n,this.scopes=null,this.override=r}function BoundValue(e,t){this.value=e,this.scope=t}function ScopeOverride(e,t,n,r,i){if(this.name=e,this.start=t,this.end=n,this.increment=r,this.current=i&&t?t[0]:t,this.isin=i,this.index=1,0==this.increment)throw new Error(Eden.RuntimeError.INFINITERANGE);if(this.isin&&void 0===this.end&&!(this.start instanceof Array))throw new Error(Eden.RuntimeError.NOLISTRANGE)}function Scope(e,t,n,r,i,s){this.parent=t,this.context=e,this.cache=void 0,this.pcache=Object.create(null),this.overrides=n,this.cause=t&&t.cause?t.cause:i,this.causecount=0,this.range=r,this.isolate=!1,this.depth=t?t.depth+1:0,e||console.error("MISSING SCOPE CONTEXT"),this.cachearray=null;r=t&&e.lookup("jseden_scope_depth").value(t)||50;if(this.depth>r)throw e.instance?(r=new Eden.RuntimeError(this.root,Eden.RuntimeError.SCOPERECURSION,null,""),e.instance.emit("error",[{name:i?i.name:""},r])):console.error("Recursive scope detected : "+(i?i.name:"")),"Scope Depth Exceeded";if(this.cause&&this.cause.hasOwnProperty("scopecount")){t=t&&e.lookup("jseden_scope_limit").value(t)||1e5;if(++this.cause.scopecount>t)throw e.instance?(t=new Eden.RuntimeError(this.root,Eden.RuntimeError.SCOPELIMIT,null,""),e.instance.emit("error",[{name:i?i.name:""},t])):console.error("Scope limit exceeded",this.cause.name),"Scope limit exceeded"}s||this.rebuild()}function ScopeList(){this.raw=[],this.caches=[]}function copy(e){var t,n;if(e instanceof Array){for(n=e.slice(),t=0;t<e.length;++t)n[t]=copy(n[t]);return n}return e}function Pointer(e){this.value=e}GLOBAL.rt=rt,"undefined"!=typeof require&&"undefined"!=typeof exports&&(exports.rt=rt),WindowHighlighter.prototype.highlight=function(e){this.lastDialog=edenUI.getDialogWindow(e);var t=edenUI.getDialogContent(e);t.dialog("isOpen")?((n=t.data("dialog-extend-minimize-controls"))?(this.previousZIndex=n.css("z-index"),t.dialogExtend("restore"),this.lastDialog.removeClass("window-activated"),this.lastDialogMinimized=!0):(this.previousZIndex=this.lastDialog.css("z-index"),this.lastDialog.css("z-index",2147483646),this.lastDialogMinimized=!1),this.lastDialogHidden=!1):(this.previousZIndex=void 0,edenUI.showView(e),edenUI.moveView(e),this.lastDialogHidden=!0),this.lastDialogLeft=this.lastDialog[0].offsetLeft,this.lastDialogWidth=this.lastDialog[0].offsetWidth,this.lastDialogTop=this.lastDialog[0].offsetTop,this.lastDialogHeight=this.lastDialog[0].offsetHeight;var n=window.pageXOffset,e=window.pageYOffset;(this.lastDialogLeft>=n+window.innerWidth||this.lastDialogLeft+this.lastDialogWidth<n||this.lastDialogTop>=e+window.innerHeight||this.lastDialogTop+this.lastDialogHeight<e)&&t.parent().offset({left:n+(window.innerWidth-this.lastDialogWidth)/2,top:e+(window.innerHeight-this.lastDialogHeight)/2}),this.lastDialog.addClass("menubar-window-raise"),this.lastDialog.css("z-index",2147483646)},WindowHighlighter.prototype.stopHighlight=function(e,t){var n,r,i;this.lastDialog&&(this.lastDialog.removeClass("menubar-window-raise"),(n=edenUI.getDialogContent(e)).parent().offset({left:this.lastDialogLeft,top:this.lastDialogTop+edenUI.menuBarHeight}),t?(r=window.pageXOffset,i=window.pageYOffset,t=!1,this.lastDialogLeft+this.lastDialogWidth>r+window.innerWidth?(r=this.lastDialogLeft+this.lastDialogWidth-window.innerWidth,t=!0):this.lastDialogLeft<r&&(r=this.lastDialogLeft,t=!0),this.lastDialogTop+this.lastDialogHeight>i+window.innerHeight-edenUI.menuBarHeight?(i=this.lastDialogTop+this.lastDialogHeight-window.innerHeight-edenUI.menuBarHeight+edenUI.scrollBarSize2+edenUI.bottomBarHeight,t=!0):this.lastDialogTop<i&&(i=this.lastDialogTop-edenUI.menuBarHeight,t=!0),t&&window.scrollTo(r,i)):this.lastDialogHidden?edenUI.hideView(e):this.lastDialogMinimized&&n.dialogExtend("minimize"),void 0!==this.previousZIndex&&this.lastDialog.css("z-index",this.previousZIndex),this.lastDialog=void 0,this.lastDialogMinimized=!1,this.lastDialogHidden=!1,this.previousZIndex=void 0)},WindowHighlighter.prototype.unpin=function(e){e===this.lastDialog&&(this.previousZIndex=void 0)},Scope.prototype.error=function(e,t){this.context.instance.error(e,t)},Scope.prototype.execute=function(e,t,n){return this.context.instance.execute(e,t,n)},Scope.prototype.exec=function(e){return this.context.instance.exec(e)},Scope.prototype.evalEden=function(e,t){return this.context.instance.evalEden(e,t,this)},Scope.prototype.symbol=function(e){e=this.l(e);return e?e.symbol:null},Scope.prototype.project=function(){var e=this.context.instance.project;return e||this.context},Scope.prototype.assertNumber=function(e,t){var n=this.value(e);return"number"!=typeof n&&this.context.instance.error(`expected a number from '${e}'`,t,Eden.RuntimeError.ASSERTTYPE),n},Scope.prototype.assertBoolean=function(e,t){var n=this.value(e);return"boolean"!=typeof n&&this.context.instance.error(`expected a boolean from '${e}'`,t,Eden.RuntimeError.ASSERTTYPE),n},Scope.prototype.assertString=function(e,t){var n=this.value(e);return"string"!=typeof n&&this.context.instance.error(`expected a string from '${e}'`,t,Eden.RuntimeError.ASSERTTYPE),n},Scope.prototype.assertList=function(e,t){var n=this.value(e);return Array.isArray(n)||this.context.instance.error(`expected a list from '${e}'`,t,Eden.RuntimeError.ASSERTTYPE),n},Scope.prototype.assertObject=function(e,t){var n=this.value(e);return"object"!=typeof n&&this.context.instance.error(`expected an object from '${e}'`,t,Eden.RuntimeError.ASSERTTYPE),n},Scope.prototype.assertValid=function(e,t){var n=this.value(e);return void 0===n&&this.context.instance.error(`Missing required value for '${e}'`,t,Eden.RuntimeError.ASSERTVALID),n},Scope.prototype.hasCause=function(e){for(var t=this,n=e;t;){if(t.cause.name==n)return!0;t=t.parent}return!1},Scope.prototype.baseCause=function(){for(var e=this;e.parent&&e.parent.parent;)e=e.parent;return e.cause.name},Scope.prototype.allCauses=function(){for(var e=[],t=this;t;)t.cause&&e.push(t.cause),t=t.parent;return e},Scope.prototype.allOverrides=function(){},Scope.prototype.hasOverride=function(e){for(var t=this;t;){for(var n=0;n<t.overrides.length;n++)if(t.overrides[n].name==e)return!0;t=t.parent}return!1},Scope.prototype.primaryCause=function(){return this.cause&&"null"==this.cause.name&&this.parent&&this.parent.cause?this.parent.cause.name:"null"},Scope.prototype.isRange=function(){return this.range},Scope.prototype.clear=function(){this!==eden.root&&(this.cache=void 0)},Scope.prototype.resetCache=function(){if(this.cachearray)for(var e of this.cachearray)e.up_to_date=e.override;else for(var t in this.cachearray=[],this.cache)(e=this.cache[t]).up_to_date=e.override,this.cachearray.push(e)},Scope.prototype.rebuild=function(){if(void 0===this.cache){this.cache=Object.create(null);for(var e=0;e<this.overrides.length;e++)this.updateOverride(this.overrides[e]);if(this.context)for(e=0;e<this.overrides.length;e++){var t=this.context.lookup(this.overrides[e].name);this.addSubscribers(t)}}},Scope.prototype.refresh=function(){for(var e=0;e<this.overrides.length;e++)this.updateOverride(this.overrides[e])},Scope.prototype.rebuildForce=function(){for(var e=0;e<this.overrides.length;e++)this.updateSubscriberForce(this.overrides[e],!0)},Scope.prototype.rebuildForceAll=function(){this.rebuildForce(),this.parent&&this.parent!==eden.root.scope&&this.parent.rebuildForceAll()},Scope.prototype.cloneAt=function(e){for(var t=[],n=0;n<this.overrides.length;n++)t.push(new ScopeOverride(this.overrides[n].name,this.overrides[n].start,this.overrides[n].end));for(var r=new Scope(this.context,this.parent,t,this.range,this.cause),n=0;n<e;n++)r.next();return r.range=!1,r},Scope.prototype.lookup=function(e){var t=this.cache[e];if(t)return t;if(this.parent)return this.parent.lookup(e);t=new ScopeCache(!0,void 0,this.context.lookup(e),!1);return this.cache[e]=t},Scope.prototype.l=function(t){var e=this.cache[t];if(e)return e;if(this.parent){if(3<this.depth){let e=this.pcache[t];return e?e:(e=this.parent.l(t),e&&(this.pcache[t]=e),e)}return this.parent.l(t)}},Scope.prototype.v=function(e){if(e.up_to_date)return e.value;var t=e.symbol;return t.definition&&(this.cause?t.liteEvaluate(this,e):t.evaluate(this,e)),e.value},Scope.prototype.value=function(e){var t=this.l(e);if(void 0===t)return this.parent?this.parent.value(e):void 0;if(t.up_to_date)return t.value;e=t.symbol;return e.definition&&(this.cause?e.liteEvaluate(this,t):e.evaluate(this,t)),t.value},Scope.prototype.assign=function(e,t,n){var r=this.context.lookup(e);this.isolate?void 0===this.cache[e]?this.cache[e]=new ScopeCache(!0,t,r,!0):(this.cache[e].up_to_date=!0,this.cache[e].override=!0,this.cache[e].value=t):r.assign(t,this,n)},Scope.prototype.mutate=function(e,t,n){this.context.lookup(e).mutate(this,t,n)},Scope.prototype.listAssign=function(e,t,n,r,i){this.context.lookup(e).listAssign(t,this,n,!1,i)},Scope.prototype.define=function(e,t,n,r){this.context.lookup(e).define(t,n,r)},Scope.prototype.lookup2=function(e){if(0==this.isolate)return this.lookup(e);var t=this.cache[e];return void 0===t&&(t=new ScopeCache(!0,void 0,this.context.lookup(e),!1),this.cache[e]=t),t},Scope.prototype.add=function(e,t){t=new ScopeCache(!1,void 0,t,!1);return this.cache[e]=t},Scope.prototype.addIfNotExist=function(e,t){var n=this.cache[e];return n||(n=new ScopeCache(!1,void 0,t,!1),this.cache[e]=n)},Scope.prototype.addAlias=function(e,t,n){t=this.cache[t];return this.cache[e]=t},Scope.prototype.addOverride=function(e){if(!this.updateOverride(e)&&this.context)for(var t in this.context.lookup(e.name).subscribers)this.updateSubscriber(t)},Scope.prototype.updateOverride=function(e){var t=e.name,n=e.current;if(void 0===this.cache[t]){e=this.context.lookup(t);return this.cache[t]=new ScopeCache(!0,n,e,!0),!1}t=this.cache[t];return t.value=n,t.up_to_date=!0,t.override=!0},Scope.prototype.addSubscribers=function(e){var t=[];e.subscribersArray||(e.subscribersArray=Object.keys(e.subscribers)),t.push.apply(t,e.subscribersArray);for(var n,r,i=0;i<t.length;)this.cache[t[i]]||(n=t[i],r=this.context.lookup(n),this.cache[n]=new ScopeCache(!1,void 0,r,!1),r.subscribersArray||(r.subscribersArray=Object.keys(r.subscribers)),t.push.apply(t,r.subscribersArray)),++i},Scope.prototype.addSubscriber=function(e){if(!this.cache[e]){var t,n=this.context.lookup(e),r=new ScopeCache(!1,void 0,n,!1);this.cache[e]=r,this.cachearray&&this.cachearray.push(r),n.subscribersArray||(n.subscribersArray=Object.keys(n.subscribers));for(t of n.subscribersArray)this.addSubscriber(t)}},Scope.prototype.updateSubscriber=function(e){if(void 0===this.cache[e]){var t,n=this.context.lookup(e);for(t in this.cache[e]=new ScopeCache(!1,void 0,n,!1),n.subscribers)this.updateSubscriber(t)}else{e=this.cache[e];e.up_to_date=!1,e.value=void 0}},Scope.prototype.updateSubscriberForce=function(e,t){var n,r;for(r in void 0===this.cache[e]?(n=new ScopeCache(!1,void 0,this.context.lookup(e),t),this.cache[e]=n):((n=this.cache[e]).up_to_date=!1,n.value=void 0),n.symbol.subscribers)this.updateSubscriberForce(r,!1)},Scope.prototype.first=function(){for(var e=this.overrides.length-1;0<=e;e--){var t=this.overrides[e];if(void 0!==t.end){if(t.isin){var n=isbound?t.start.value.length:t.start?t.start.length:0;return t.index<n}if(t.current<=t.end)return!0}}return!1},Scope.prototype.mergeCache=function(e){e||console.error("Missing scope cache"),this.cache=e.cache,this.cachearray=e.cachearray},Scope.prototype.reset=function(){this.resetCache(),this.refresh()},Scope.prototype.next=function(){this.resetCache();for(var e=this.overrides.length-1;0<=e;e--){var t=this.overrides[e];if(void 0!==t.end||t.isin){var n=t.start?t.start.length:0;if(t.isin){if(t.index<n)return t.current=t.start[t.index],t.index++,this.refresh(),!0;t.index=1,t.current=t.start[0]}else{if(t.current<t.end)return t.increment?t.current+=t.increment:t.current++,this.refresh(),!0;t.current=t.start}}}return!1},Eden.Scope=Scope,Eden.ScopeOverride=ScopeOverride,edenCopy=copy,function(){function d(e,t){this.context=e,this.name=t,this.cache=e?e.scope.add(t,this):new ScopeCache(!0,void 0,this,!1),this.definition=void 0,this.def_scope=void 0,this.extend=void 0,this.needsGlobalNotify=0,this.has_evaled=!1,this.isasync=!1,this.volatile=!1,this.eager=!1,this.scopecount=0,this.changed=!0,this.errored=!1,this.dependencies=Object.create(null),this.subscribers=Object.create(null),this.subscribersArray=null,this.dynamicDependencies=Object.create(null),this.observers=Object.create(null),this.observees=Object.create(null),this.jsObservers={},this.origin=void 0,this.garbage=!1}Object.defineProperty(d.prototype,"type",{get:function(){return this.origin&&this.origin.type?this.origin.type:"assignment"}}),Object.defineProperty(d.prototype,"lvalue",{get:function(){return this.origin?this.origin.lvalue:void 0}}),Object.defineProperty(d.prototype,"expression",{get:function(){return this.origin?this.origin.expression:void 0}}),Object.defineProperty(d.prototype,"doxyComment",{get:function(){return this.origin?this.origin.doxyComment:void 0}}),Object.defineProperty(d.prototype,"parent",{get:function(){return this.context}}),Object.defineProperty(d.prototype,"stamp",{get:function(){return this.origin?this.origin.stamp:void 0}}),Object.defineProperty(d.prototype,"id",{get:function(){return this.origin&&this.origin.id?this.origin.id:this.name}}),Object.defineProperty(d.prototype,"executed",{get:function(){return 1}}),d.prototype.buildID=function(){},d.prototype.getStartLine=function(e){return this.origin?this.origin.getStartLine(e):-1},d.prototype.getLocationName=function(){return this.origin?this.origin.getLocationName():"ACTIVE"},d.prototype.getASTOrigin=function(){if(this.origin){for(var e=this.origin;e.parent;)e=e.parent;if(e.base)return e.base.origin}},d.prototype.getOrigin=function(){if(this.origin)return this.origin.getOrigin()},InternalAgent=function(e,t){this.name=e,this.local=t,this.internal=!0},InternalAgent.prototype.getOrigin=function(){return"*Default"!=this.name?eden.project:void 0},InternalAgent.prototype.numlines=0,d.hciAgent=new InternalAgent("*Input Device",!0),d.jsAgent=new InternalAgent("*JavaScript",!1),d.localJSAgent=new InternalAgent("*JavaScript",!0),d.netAgent=new InternalAgent("*net",!0),d.defaultAgent=new InternalAgent("*Default",!0),d.NONOTIFY=0,d.CREATED=1,d.EXPIRED=2,d.REDEFINED=3,d.ASSIGNED=4,d.ASYN_UPDATE=5,d.prototype.value=function(e){if(e&&e.isRange())return this.multiValue(e);var t=e;this.garbage=!1,void 0===t&&(t=this.context.scope);e=void 0===this.context||t===this.context.scope?this.cache:t.lookup(this.name);return this.definition&&(e.up_to_date||this.evaluate(t,e)),e.value},d.prototype.multiValue=function(e){var t=[];if(console.log("mutli value"),e.range=!1,!e.first())return[];for(;;){var n=this.value(e);if(void 0!==n&&t.push(n),0==e.next())break}return e.range=!0,(void 0===this.context||e===this.context.scope?this.cache:e.lookup(this.name)).scope=e,t},d.prototype.evaluate=function(e,t){this.context&&this.context.beginEvaluation(this),this.subscribersArray||(this.subscribersArray=Object.keys(this.subscribers));try{t.up_to_date=!this.volatile,this.has_evaled||this.clearDynamicDependencies(),this.has_evaled=!0,this.scopecount=0,this.errored=!1;var n=t.value;t.value=this.definition.call(this,this.context,e,t),1e3<this.scopecount&&console.log("Scope count for "+this.name,this.scopecount),this.changed=n!==t.value}catch(e){if(e instanceof Eden.RuntimeError&&this.context.instance.emit("error",[this,e]),t.up_to_date=!this.volatile,-1===e)return this.context&&this.context.endEvaluation(this),-1;t.value=void 0,this.changed=!0,this.errored=!0}this.context&&this.context.endEvaluation(this)},d.prototype.liteEvaluate=function(e,t){this.subscribersArray||(this.subscribersArray=Object.keys(this.subscribers)),t.up_to_date=!this.volatile,t.value=void 0,this.has_evaled||this.clearDynamicDependencies(),this.has_evaled=!0;try{t.value=this.definition.call(this,this.context,e,t)}catch(e){}},d.prototype.isSourceOfUndefined=function(){if(void 0!==this.value())return!1;for(var e in this.dependencies)if(void 0===this.dependencies[e].cache.value)return!1;for(var t in this.dynamicDependencies)if(void 0===this.dynamicDependencies[t].cache.value)return!1;return!0},d.prototype.clearObservees=function(){for(var e in this.observees)this.observees[e].removeObserver(this.name);this.observees=Object.create(null)},d.prototype.subscribe=function(){for(var e=Utils.flatten(arguments),t=0;t<e.length;++t){var n=e[t],r=this.context.lookup(n);r.name!=this.name&&(r.addSubscriber(this.name,this),n=r.name,this.dependencies[n]=r,delete this.dynamicDependencies[n])}return this},d.prototype.subscribeDynValue=function(e,t,n){var r=t.name;return this.subscribeDynamic(e,r,n),t.value(n)},d.prototype.subscribeDynamicSym=function(e){e.name in this.dependencies||e.name in this.dynamicDependencies||(e.addSubscriber(this.name,this),this.dynamicDependencies[e.name]=e)},d.prototype.subscribeDynamic=function(e,t,n){if(!Eden.isValidIdentifier(t))return"__error__";var r=this.context.lookup(t);return n&&n!==this.context.scope&&n.cause&&r.definition&&!n.cache[t]&&n.addSubscriber(t),this.dependencies[t]||this.dynamicDependencies[t]||(r.addSubscriber(this.name,this),this.dynamicDependencies[r.name]=r),t},d.prototype.clearDependencies=function(){for(var e in this.dependencies)this.dependencies[e].removeSubscriber(this.name);for(e in this.dependencies=Object.create(null),this.dynamicDependencies)this.dynamicDependencies[e].removeSubscriber(this.name);this.dynamicDependencies=Object.create(null)},d.prototype.clearDynamicDependencies=function(){var e,t=0;for(e in this.dynamicDependencies)this.dynamicDependencies[e].removeSubscriber(this.name),++t;0<t&&(this.dynamicDependencies=Object.create(null))},d.prototype.getSource=function(){return this.origin&&!this.origin.internal?this.origin.getSource():this.name+" = "+Eden.edenCodeForValue(this.value())+";"},d.prototype.toString=function(){return"&"+this.name},d.prototype.indirectDependencies=function(e){var t,n=e||{};for(t in this.dependencies){var r=this.dependencies[t];(n[t]=r).indirectDependencies(n)}for(t in this.dynamicDependencies){r=this.dynamicDependencies[t];(n[t]=r).indirectDependencies(n)}return n},d.prototype.indirectSubscribers=function(e){var t,n=e||{};for(t in this.subscribers){var r=this.subscribers[t];(n[t]=r).indirectSubscribers(n)}return n},d.prototype.define=function(e,t,n,r){return this.garbage=!1,this.definition=e,this.origin=t,this.needsGlobalNotify=d.REDEFINED,this.clearObservees(),this.clearDependencies(),this.subscribe(n),this.context&&this.context.expireEdenSymbol(this),Eden.logging&&t&&("assignment"!==t.type&&"definition"!==t.type&&"modify"!==t.type||this.context.instance.emit("debug_log",[t])),this.context.instance.peer&&this.context.instance.peer.define(t,this.name,t.getSource(),n),this},d.prototype.expireSubscribers=function(){for(var t in this.subscribers){let e=this.subscribers[t];e.needsGlobalNotify=d.EXPIRED,this.context.expireEdenSymbol(e)}},d.prototype.expireAsync=function(){this.context&&(this.needsGlobalNotify=d.ASYNC_UPDATE,this.context.expireEdenSymbol(this))},d.prototype.observe=function(e){e=Utils.flatten(arguments);for(var t=0;t<e.length;++t){var n=this.context.lookup(e[t]);(this.observees[n.name]=n).addObserver(this.name,this)}return this.context&&this.context.triggerEdenSymbol(this),this},d.prototype.stopObserving=function(e){this.observees[e].removeObserver(this.name),this.observees[e]=void 0},d.prototype.isUpToDate=function(){return this.cache.up_to_date},d.prototype.append=function(e,t,n){var r=this.value(t);r.push(e),this.assign(r,t,n)},d.prototype.hasChanged=function(){return this.cache.up_to_date||this.value(),this.changed},d.prototype.assign=function(e,t,n){this.garbage=!1,this.cache.value!==e&&(e=copy(e)),"autocalc"===this.name&&(!0===e?e=1:!1===e&&(e=0),this.context&&this.context.autocalc(1===e));var r=void 0===this.context||t==this.context.scope?this.cache:t.lookup2(this.name);return r.symbol!==this?(console.log("Different symbols for "+this.name),void r.symbol.assign(e,t,n)):(this.origin=n,this.needsGlobalNotify=this.definition?d.REDEFINED:d.ASSIGNED,this.definition=void 0,this.has_evaled=!0,this.extend=void 0,this.changed=r.value!==e,r.value=e,r.up_to_date=!0,this.clearObservees(),this.clearDependencies(),this.context&&this.context.expireEdenSymbol(this),Eden.logging&&n&&("assignment"!==n.type&&"definition"!==n.type&&"modify"!==n.type||this.context.instance.emit("debug_log",[n])),this.context.instance&&this.context.instance.peer&&this.context.instance.peer.assign(n,this.name,e),this)},d.prototype.assigned=function(e){return this.garbage=!1,this.origin=e,this.definition=void 0,this.clearObservees(),this.clearDependencies(),this},d.prototype.mutate=function(e,t,n,r){this.garbage=!1;this.origin=n,this.value(e),this.definition=void 0,this.needsGlobalNotify=d.ASSIGNED;for(var i=[],s=1;s<arguments.length;s++)i.push(arguments[s]);return t.apply(void 0,[this].concat(i)),this.context&&this.context.expireEdenSymbol(this),this},d.prototype.getEdenCode=function(){return"&"+this.name},d.prototype.trigger=function(){try{this.value().call(this,this.context,this.context.scope)}catch(e){var t=new Eden.RuntimeError(void 0,Eden.RuntimeError.PROCAGENT,void 0,"Triggered proc failed: "+e);this.context.instance.emit("error",[this,t])}},d.prototype.fireJSObservers=function(){for(var t in this.jsObservers)try{this.jsObservers[t](this,this.value())}catch(e){var n=new Eden.RuntimeError(void 0,Eden.RuntimeError.JSOBSERVER,void 0,"JavaScript observer '"+t+"' failed: "+e);throw this.context.instance.emit("error",[this,n]),!this.context||"object"==typeof(n=this.cache.value)&&n.jsExceptions,e}},d.prototype.expire=function(e,t,n,r){if(this.has_evaled||r&&this.needsGlobalNotify!=d.EXPIRED)if(this.isasync&&this.definition&&this.needsGlobalNotify!=d.ASYNC_UPDATE){this.context&&this.context.beginEvaluation(this),this.has_evaled=!1;try{this.clearDynamicDependencies(),this.definition.call(this,this.context,this.context.scope,this.cache).then(e=>{this.has_evaled=!0,this.cache.up_to_date=!0,this.changed=this.cache.value!==e,this.cache.value=e,this.expireAsync()})}catch(e){e instanceof Eden.RuntimeError&&this.context.instance.emit("error",[this,e]),console.error(this.name,e),this.cache.value=void 0,this.changed=!0,this.cache.up_to_date=!0}this.context&&this.context.endEvaluation(this)}else if(!this.definition||this.needsGlobalNotify==d.ASYNC_UPDATE||(this.cache.up_to_date=!1,this.has_evaled=!1,e[this.name]=t.value,t.value++,r&&(this.cache.scopes=null),!this.eager||-1!==this.evaluate(this.context.scope,this.cache))){for(var i in this.observers)n[i]=this.observers[i];for(var s in this.needsGlobalNotify=d.EXPIRED,this.subscribers){s=this.subscribers[s];s&&s.expire(e,t,n,r)}}},d.prototype.isDependentOn=function(e){if(e==this.name||this.dependencies[e])return!0;for(var t in this.dependencies)if(this.dependencies[t].isDependentOn(e))return!0;for(t in this.dynamicDependencies)if(this.dynamicDependencies[t].isDependentOn(e))return!0;return!1},d.prototype.getDependencies=function(){var e,t=[];for(e in this.dependencies)t.push(e);return console.log("Dependencies"),t},d.prototype.assertNotDependentOn=function(e,t){if((t=void 0===t?[]:t).push(this.name),this.dependencies[e]){var n=t.join(" -> ")+" -> "+e+" -> "+t[0];throw new Error("Cyclic dependency detected: "+n)}for(var r in this.dependencies)this.dependencies[r].assertNotDependentOn(e,t);for(r in this.dynamicDependencies)this.dynamicDependencies[r].assertNotDependentOn(e,t);t.pop()},d.prototype.addSubscriber=function(e,t){this.garbage=!1,this.subscribers[e]=t,this.subscribersArray&&this.subscribersArray.push(e)},d.prototype.removeSubscriber=function(e){delete this.subscribers[e],this.subscribersArray=null,void 0===this.origin&&this.canSafelyBeForgotten()&&this.forget()},d.prototype.canSafelyBeForgotten=function(){for(var e in this.subscribers)return!1;for(var t in this.observers)return!1;return!0},d.prototype.forget=function(){for(var e in this.origin=void 0,this.definition=void 0,this.cache.value=void 0,this.cache.up_to_date=!0,this.context&&this.context.expireEdenSymbol(this),this.clearObservees(),this.clearDependencies(),this.garbage=!0,this.jsObservers)this.jsObservers[e].call(this,this,void 0);this.jsObservers={},this.context.queueForGarbageCollection(this)},d.prototype.addObserver=function(e,t){this.garbage=!1,this.observers[e]=t},d.prototype.addJSObserver=function(e,t){if("function"!=typeof t)throw new Error("Failed adding JavaScript observer "+t);this.jsObservers[e]=t,0==this.cache.up_to_date&&this.value()},d.prototype.removeObserver=function(e){delete this.observers[e],void 0===this.origin&&this.canSafelyBeForgotten()&&this.forget()},d.prototype.removeJSObserver=function(e){delete this.jsObservers[e]},d.prototype.addExtension=function(e,t,n,r,i){if(!this.definition)throw new Error(Eden.RuntimeError.EXTENDSTATIC);void 0===this.extend&&(this.extend={}),this.extend[e]={code:t,source:n,deps:i},this.subscribe(i),this.needsGlobalNotify=d.REDEFINED,this.context&&this.context.expireEdenSymbol(this)},d.prototype.listAssign=function(e,t,n,r,i){if(this.definition){if(this.origin&&"definition"==this.origin.type){var s=this.origin.locatePrimary(i);if(s)return void this.context.lookup(s).assign(e,t,n)}throw new Error(Eden.RuntimeError.ASSIGNTODEFINED)}for(var o=this.value(t),a=0;a<i.length-1;a++)o=o&&o[i[a]];if(!o)throw new Error(Eden.RuntimeError.ASSIGNDIMENSION);return o[i[i.length-1]]=e,this.origin=n,this.needsGlobalNotify=d.ASSIGNED,this.context&&this.context.expireEdenSymbol(this),this.context.instance.peer&&this.context.instance.peer.listAssign(n,this.name,e,i),this},Eden.EdenSymbol=d}();var EdenSymbol=Eden.EdenSymbol;function fireActions(e,t){var n,r=Date.now();for(n in e){var i=e[n];i&&i.trigger(t,r)}}function fireJSActions(e){for(var t=0;t<e.length;t++)e[t].fireJSObservers()}function Folder(e,t,n,r){this.type="script",this.executed=1,this.start=0,this.end=0,this.prefix="",this.postfix="",this.id="ACTIVE",this.instance=t||{},this.name=e||"ACTIVE",this.base={origin:void 0},this.errors=[],this.lock=1,this.numlines=0,this.root=r||this,this.scope=new Eden.Scope(this,void 0,{}),this.symbols=Object.create(null),this.f=Object.create(null),this.delayedaction=Object.create(null),this.autoaction=!0,this.globalobservers=[],this.subscribers={},this.autocalc_state=!0,this.needsExpire=[],this.needsTrigger={},this.firetimer=void 0,this.needsGlobalNotify=[],this.globalNotifyIndex=0,this.expiryCount=new Pointer(0),this.potentialGarbage={},this.saved_autocalc_state=!0,this.saved_autocalc_level=0,this.currentObservables=[],Object.defineProperty(this,"statements",{enumerable:!0,get:function(){var t=this;return Object.keys(this.symbols).map(function(e){return t.symbols[e]})}}),Object.defineProperty(this,"parent",{enumerable:!0,get:function(){return eden.project.ast.script}})}if(Folder.prototype.registerAgent=function(e){},Folder.prototype.addSubscriber=function(e){this.subscribers[e]=this.lookup(e)},Folder.prototype.removeSubscriber=function(e){delete this.subscribers[e]},Folder.prototype.getNumberOfLines=function(){return this.numlines+1},Folder.prototype.hasErrors=function(){return!1},Folder.prototype.getOrigin=function(){return eden.project},Folder.prototype.addIndex=function(){},Folder.prototype.getStatementByLine=function(e){},Folder.prototype.getStartLine=function(e){return this.parent?this.parent.getRelativeLine(this,e):-1},Folder.prototype.getRange=function(e){e=this.getStartLine(e);return[e,e+this.getNumberOfLines()]},Folder.prototype.getInnerSource=function(){var e,t="";for(e in this.numlines=0,this.symbols){var n,r=this.symbols[e];r.origin&&r.origin.getOrigin&&((n=r.origin.getOrigin())&&(!n||n.remote)||(n=r.getSource())&&(t+=n+"\n",this.numlines+=r.origin.numlines+1))}return t},Folder.prototype.destroy=function(){},Folder.prototype.getSource=function(){var e="action ACTIVE {\n";return e+=this.getInnerSource(),e+="}"},Folder.prototype.execute=function(){},Folder.prototype.lookup=function(e){if(void 0===this.symbols[e]){for(var t in this.symbols[e]=new Eden.EdenSymbol(this,e),this.subscribers)this.expireEdenSymbol(this.subscribers[t]);this.notifyGlobals(this.symbols[e],1)}return this.symbols[e]},Folder.prototype.currentObservableName=function(){if(0!=this.currentObservables.length)return this.currentObservables[this.currentObservables.length-1].name},Folder.prototype.beginEvaluation=function(e){this.currentObservables.push(e)},Folder.prototype.endEvaluation=function(e){this.currentObservables.pop()},Folder.prototype.queueForGarbageCollection=function(e){this.potentialGarbage[e.name]=e},Folder.prototype.collectGarbage=function(){for(var e in this.potentialGarbage)this.potentialGarbage[e].garbage&&delete this.symbols[e];this.potentialGarbage={}},Folder.prototype.putEval=function(e,t){this.evalResults[e]=t},Folder.prototype.getEval=function(e){return this.evalResults[e]},Folder.prototype.clearEval=function(e){delete this.evalResults[e]},Folder.prototype.addGlobal=function(e){this.globalobservers.push(e)},Folder.prototype.removeGlobal=function(e){for(var t=0;t<this.globalobservers.length;t++)if(this.globalobservers[t]===e)return this.globalobservers.splice(t,1),!0;return!1},Folder.prototype.notifyGlobals=function(e,t){for(var n=0;n<this.globalobservers.length;n++)void 0!==this.globalobservers[n]&&this.globalobservers[n].call(this,e,t)},Folder.prototype.autocalc=function(e){this.autocalc_state=e,this.expireAndFireActions()},Folder.prototype.beginAutocalcOff=function(){this.saved_autocalc_level++,1==this.saved_autocalc_level&&(this.saved_autocalc_state=this.autocalc_state,this.autocalc_state&&this.autocalc(!1))},Folder.prototype.endAutocalcOff=function(){this.saved_autocalc_level--,0==this.saved_autocalc_level&&this.saved_autocalc_state&&this.autocalc(!0)},Folder.prototype.expireEdenSymbol=function(e){-1==this.needsExpire.indexOf(e)&&this.needsExpire.push(e),this.expireAndFireActions()},Folder.prototype.triggerEdenSymbol=function(e){var t;this.needsTrigger[e.name]=e,void 0===this.firetimer&&((t=this).firetimer=setTimeout(function(){this.firetimer=void 0,t.expireAndFireActions()},0))},Folder.prototype.expireAndFireActions=function(){if(this.autocalc_state){this.expiryCount.value=0;var n={},e=this.needsExpire;this.needsExpire=[];for(var t=0;t<e.length;t++)(i=e[t]).expire(n,this.expiryCount,this.needsTrigger,i.needsGlobalNotify==EdenSymbol.REDEFINED);var r=Object.keys(n);r.sort(function(e,t){return n[e]-n[t]});for(var i,s=[],t=0;t<r.length;t++)(i=this.symbols[r[t]]).needsGlobalNotify=EdenSymbol.EXPIRED,s.push(i);var o,a=this.needsTrigger;if(this.needsTrigger={},fireActions(a,this.scope),this.autoaction)fireJSActions(e),fireJSActions(s),0==this.needsGlobalNotify.length?(s.push.apply(s,e),0<s.length&&(this.needsGlobalNotify=s,o=this,setTimeout(function(){o.processGlobalNotifyQueue()},0))):((a=this.needsGlobalNotify).push.apply(a,s),a.push.apply(a,e));else{for(var d of e)this.delayedaction[d.name]=d;for(var d of s)this.delayedaction[d.name]=d}}},Folder.prototype.enableActions=function(){this.autoaction=!0;var e=Object.values(this.delayedaction);0<e.length&&fireJSActions(e),this.delayedaction=Object.create(null)},Folder.prototype.processGlobalNotifyQueue=function(){for(var e=this.needsGlobalNotify,t=0;t<e.length;){this.globalNotifyIndex++;var n,r=e[t];r.needsGlobalNotify&&(n=r.needsGlobalNotify,r.needsGlobalNotify=0,this.notifyGlobals(r,n)),t=this.globalNotifyIndex}this.needsGlobalNotify=[],this.globalNotifyIndex=0},Folder.prototype.forgetAll=function(){var e,t=void 0;if(4<arguments.length)return eden.error(new Error("forgetAll: This function requires at most 4 arguments."),"error"),[[],void 0,[]];if(0==arguments.length)m="";else if("string"==typeof arguments[0])m=arguments[0];else{if(!Array.isArray(arguments[0]))return void 0===arguments[0]||eden.error(new Error("forgetAll: The first argument must be a string, not a "+typeof arguments[0]),"error"),[[],void 0,[]];t=arguments[0]}if(1<arguments.length){if("boolean"!=typeof arguments[1])return eden.error(new Error("forgetAll: The second argument must be a boolean, not a "+typeof arguments[1]),"error"),[[],void 0,[]];S=arguments[1]}else S=!0;if(void 0!==t&&2<arguments.length)return eden.error(new Error("forgetAll: Cannot specify case sensitivity when selecting using a list."),"error"),[[],void 0,[]];if(3<=arguments.length){if("boolean"!=typeof arguments[2])return eden.error(new Error("forgetAll: The third argument must be a boolean, not a "+typeof arguments[2]),"error"),[[],void 0,[]];f=arguments[2]}else f=void 0===t||2!=arguments.length||arguments[1];if(3<arguments.length){if("boolean"!=typeof arguments[3])return eden.error(new Error("forgetAll: The forth argument must be a boolean, not a "+typeof arguments[3]),"error"),[[],void 0,[]];e=arguments[3]}else e=!1;var n,r={},i=[],s={};if(void 0!==t)for(var o=0;o<t.length;o++){if(t[o]instanceof h)v=t[o].name,h=t[o];else{if("string"!=typeof t[o]){if(void 0===t)continue;return eden.error(new Error("forgetAll: All list items must be strings or pointers.  Item "+o+" is a "+typeof t[o]),"error"),[[],void 0,[]]}v=t[o],h=root.lookup(v)}if(e||!Eden.isitSystemEdenSymbol(v))if(n=eden.initialDefinition(v))s[v]=n;else{var a=[];for(p in h.subscribers)a.push(p);for(l in h.observers)a.push(l);r[v]=a}else i.push(v)}else{var d=S?new RegExp(m):new RegExp(m,"i"),c=/^_[vV]iew(s?)_/;for(v in root.symbols)if(d.test(v)&&(e||!Eden.isitSystemEdenSymbol(v)&&!c.test(v))){var h,p,l,a=[];for(p in(h=root.symbols[v]).subscribers)a.push(p);for(l in h.observers)a.push(l);r[v]=a}}var u={},E=function(e){if(e in u)return u[e];if(e in s)return!0;if(!(e in r))return u[e]=!1;var t=r[e];if(0==t.length)return u[e]=!0;for(var n=0;n<t.length;n++)if(!E(t[n]))return u[e]=!1;return u[e]=!0},g=[];for(v in r)(E(v)?g:i).push(v);var f,S=Object.keys(s),m=g.concat(S);if(!(0<m.length&&f)||(m.length<=50?confirm("You are about to delete the following "+m.length+" symbols.  Is this correct?\n\n"+m.join("\n")):(f=m.length-50,confirm("You are about to delete "+m.length+" symbols.  Is this correct?\n\n"+m.slice(0,50).join("\n")+"\n...\n("+f+" more)")))){for(v in root.beginAutocalcOff(),s);for(o=0;o<g.length;o++){var y,v=g[o];void 0!==(h=root.symbols[v])&&("refreshView"in h.jsObservers&&(h.assign(void 0,root.scope),edenUI.plugins.Canvas2D&&edenUI.plugins.Canvas2D.destroyViews&&edenUI.plugins.Canvas2D.destroyViews(v)),h.forget(),null!==(y=v.match(/^_view_(.*)_content$/))&&edenUI.destroyView(y[1],!0))}return root.collectGarbage(),root.endAutocalcOff(),[g,i,S]}return[[],i,[]]},Eden.Folder=Folder,Eden.DB={directory:{},meta:{},remoteMeta:{},remoteURL:void 0,username:void 0,userid:void 0,repositories:[document.location.protocol+"//jseden.dcs.warwick.ac.uk/construalmanager","http://localhost:18882"],repoindex:0,retrycount:0,connected:!1,searchServer:document.location.protocol+"//jseden.dcs.warwick.ac.uk",querycache:null,qcacheloaded:!1,qcachetimeout:void 0},Eden.DB.storageSpace=function(){var e,t=0;for(e in localStorage)t+=2*(localStorage[e].length+e.length);return t},console.log("Local Usage:",Eden.DB.storageSpace()/1024/1024+"Mb"),4194304<Eden.DB.storageSpace())for(var x in console.log("WARNING - CLEARING LOCAL STORAGE"),window.localStorage)delete window.localStorage[x];function removeActive(e){for(var t=e.indexOf("action ACTIVE {"),n=1,r=t+16;r<e.length;r++){var i=e.charAt(r);if("{"==i?n++:"}"==i&&n--,0==n)break}return e.substring(0,t)+e.substring(r)}Eden.DB.listeners={},Eden.DB.emit=emit,Eden.DB.listenTo=listenTo,Eden.DB.isConnecting=function(){return void 0!==Eden.DB.remoteURL},Eden.DB.isConnected=function(){return Eden.DB.connected},Eden.DB.isLoggedIn=function(){return void 0!==Eden.DB.username},Eden.DB.logOut=function(t){Eden.DB.isLoggedIn()&&$.ajax({url:Eden.DB.remoteURL+"/logout",type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){Eden.DB.username=void 0,Eden.DB.emit("logout",[]),t&&t(),function t(){Eden.DB.isConnected()&&void 0===Eden.DB.username&&setTimeout(function(){Eden.DB.getLoginName(function(e){e?(Eden.DB.emit("login",[e]),eden.root.lookup("jseden_pm_user").assign(e,eden.root.scope,Symbol.localJSAgent)):t()})},5e3)}()},error:function(e){Eden.DB.disconnect(!0)}})},Eden.DB.connect=function(t,n){function r(){Eden.DB.isConnected()&&void 0===Eden.DB.username&&setTimeout(function(){Eden.DB.getLoginName(function(e){e?(Eden.DB.emit("login",[e]),eden.root.lookup("jseden_pm_user").assign(e,eden.root.scope,Symbol.localJSAgent),function t(){Eden.DB.isConnected()&&setTimeout(function(){Eden.DB.getLoginName(function(e){e?t():Eden.DB.disconnect()})},3e5)}()):r()})},5e3)}Eden.DB.remoteURL=t,function e(t){for(var n in t)t[n].missing=!0,t[n].children&&e(t[n].children)}(Eden.DB.directory),Eden.DB.refreshint=setInterval(function(){for(var e in Eden.DB.directory)Eden.DB.directory[e].missing=!0},2e4),Eden.DB.getLoginName(function(e){Eden.DB.isConnected()?(Eden.DB.retrycount=0,n&&n(Eden.DB.isConnected()),Eden.DB.emit("connected",[t]),eden.root.lookup("jseden_pm_connected").assign(!0,eden.root.scope,Symbol.localJSAgent),e?(Eden.DB.emit("login",[e]),eden.root.lookup("jseden_pm_user").assign(e,eden.root.scope,Symbol.localJSAgent)):r()):n&&n(Eden.DB.isConnected())})},Eden.DB.disconnect=function(e){Eden.DB.remoteURL=void 0,Eden.DB.connected&&(Eden.DB.emit("disconnected",[]),eden.root.lookup("jseden_pm_connected").assign(!1,eden.root.scope,Symbol.localJSAgent)),Eden.DB.connected=!1,Eden.DB.refreshint&&(clearInterval(Eden.DB.refreshint),Eden.DB.refreshint=void 0),e&&(Eden.DB.retrycount<12&&Eden.DB.retrycount++,setTimeout(function(){Eden.DB.repoindex>=Eden.DB.repositories.length&&(Eden.DB.repoindex=Eden.DB.repositories.length-1),Eden.DB.connect(Eden.DB.repositories[Eden.DB.repoindex]),Eden.DB.repoindex=(Eden.DB.repoindex+1)%Eden.DB.repositories.length},200*Math.pow(2,Math.ceil(Eden.DB.retrycount/Eden.DB.repositories.length))))},Eden.DB.getLoginName=function(r){Eden.DB.isConnecting()?$.ajax({url:Eden.DB.remoteURL+"/user/details",type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){Eden.DB.connected=!0,null==e||e.error?(Eden.DB.username=void 0,r()):(Eden.DB.username=e.name,Eden.DB.userid=e.id,!e.id||""!=e.name&&e.name||(Eden.DB.username="NoName"),r(Eden.DB.username))},error:function(e,t,n){Eden.DB.disconnect(!0),r(void 0)}}):r()},Eden.DB.localSave=function(e){var t;window.localStorage&&(t="project_"+e.id,window.localStorage.setItem(t+"_project",e.generate()),window.localStorage.setItem(t+"_id",e.id),window.localStorage.setItem(t+"_vid",e.vid),window.localStorage.setItem(t+"_author",e.author),window.localStorage.setItem(t+"_authorid",e.authorid),window.localStorage.setItem(t+"_name",e.name),window.localStorage.setItem(t+"_title",e.title),window.localStorage.setItem(t+"_thumb",e.thumb),window.localStorage.setItem(t+"_desc",e.desc),window.localStorage.setItem(t+"_tags",e.tags.join(" ")),(t=null===(t=JSON.parse(window.localStorage.getItem("project_list")))?{}:t)[e.id]=!0,window.localStorage.setItem("project_list",JSON.stringify(t)))},Eden.DB.save=function(r,e,i){Eden.DB.isConnected()?$.ajax({url:this.remoteURL+"/project/add",type:"post",crossDomain:!0,xhrFields:{withCredentials:!0},data:{projectID:r.id,title:r.title,source:r.generate(),tags:r.tags.join(" "),minimisedTitle:r.name,from:r.vid,image:r.thumb,listed:e,metadata:JSON.stringify({description:r.desc,env:r.environment()}),parentProject:r.parentid},success:function(e){null===e||e.error?(Eden.DB.localSave(r),console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]),i&&i(!1)):(console.log("Saved",e),r.id=e.projectID,r.vid=e.saveID,r.readPassword=e.readPassword,r.author=Eden.DB.username,r.authorid=Eden.DB.userid,Eden.DB.localSave(r),i&&i(!0))},error:function(e,t,n){Eden.DB.localSave(r),Eden.DB.handleError(e,t,n),i&&i(!1)}}):(Eden.DB.localSave(r),console.error("Cannot upload, not connected to server. Local save only."),i&&i(!1),eden.error("Cannot upload "+path+", not connected to server. Local save only"))},Eden.DB.getVersions=function(e,t){Eden.DB.isConnected()?$.ajax({url:Eden.DB.remoteURL+"/project/versions?projectID="+e,type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){t(e)},error:function(e){Eden.DB.disconnect(!0)}}):t(void 0)},Eden.DB.loadLocal=function(e){if(window.localStorage){var t="project_"+e,n=window.localStorage.getItem(t+"_project");"undefined"==(e=window.localStorage.getItem(t+"_id"))&&(e=void 0);var r=window.localStorage.getItem(t+"_vid");"undefined"==r&&(r=void 0);var i=window.localStorage.getItem(t+"_author");"undefined"==i&&(i=void 0);var s=window.localStorage.getItem(t+"_authorid"),o=window.localStorage.getItem(t+"_name"),a=window.localStorage.getItem(t+"_tags"),d=window.localStorage.getItem(t+"_thumb");"undefined"==d&&(d=void 0);e=window.localStorage.getItem(t+"_desc"),t=window.localStorage.getItem(t+"_title");if(n&&""!=n)return{source:n,saveID:r,title:t,ownername:i,owner:s,image:d,tags:a,parentProject:null,minimisedTitle:o,projectMetaData:JSON.stringify({description:e})}}},Eden.DB.hasLocal=function(e,t){var n=JSON.parse(window.localStorage.getItem("project_list"));if(null!==n&&n[e]){if(!t)return!0;e="project_"+e,e=window.localStorage.getItem(e+"_vid");return console.log("Load local",e,t),t<=(e=parseInt(e))}return!1},Eden.DB.load=function(r,i,e,s){3==arguments.length&&(s=e,e=void 0),Eden.DB.isConnected()?$.ajax({url:Eden.DB.remoteURL+"/project/get?api=3&projectID="+r+(i?"&to="+i:"")+(e?"&readPassword="+e:""),type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){var t,n;null==e||e.error?(s(void 0,"No such version"),console.error("No such version "+i+" for "+r),console.log(e),Eden.DB.emit("error",[e?e.description:"No response from server"])):eden.root.lookup("jseden_autosave").value()&&Eden.DB.hasLocal(r,e.saveID)?(console.log("Yes, load local"),removeActive((t=Eden.DB.loadLocal(r)).source)!=removeActive(e.source)?(n=window.confirm("You have local changes, restore these?"),s(n?t:e)):s(e)):s(e)},error:function(e,t,n){Eden.DB.handleError(e,t,n),s(void 0,"Disconnected")}}):s&&(eden.root.lookup("jseden_autosave").value()&&Eden.DB.hasLocal(r,i)&&window.confirm("You have local changes, restore these?")?s(Eden.DB.loadLocal(r)):s(void 0,"Disconnected"))},Eden.DB.search=function(e,t,n,r,i){var s=this.remoteURL+"/project/";s+=""==e?"search?limit="+n+"&offset="+(t-1)*n:"search?limit="+n+"&offset="+(t-1)*n+"&query="+encodeURIComponent(e),r&&(s+="&by="+r),$.ajax({url:s,type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){e&&e.error?(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]),i(void 0)):i(e||void 0)},error:function(e,t,n){Eden.DB.handleError(e,t,n),i(void 0)}})},Eden.DB.getMeta=function(e,t){var n=this.remoteURL+"/project/";n+="search?limit=20&query=.id("+e+")",$.ajax({url:n,type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){e&&e.error?(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]),t(void 0)):t(e||void 0)},error:function(e,t,n){Eden.DB.handleError(e,t,n)}})},Eden.DB.remove=function(e,r){$.ajax({url:this.remoteURL+"/project/remove",type:"post",crossDomain:!0,xhrFields:{withCredentials:!0},data:{projectID:e},success:function(e){null===e||e.error?(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]),r&&r(!1)):(console.log("Removed",e),r&&r(!0))},error:function(e,t,n){Eden.DB.handleError(e,t,n),r&&r(!1)}})},Eden.DB.rate=function(e,t){$.ajax({url:this.remoteURL+"/project/rate",type:"post",crossDomain:!0,xhrFields:{withCredentials:!0},data:{projectID:e,stars:t},success:function(e){null!==e&&!e.error||(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]))},error:function(e,t,n){Eden.DB.handleError(e,t,n)}})},Eden.DB.patch=function(e,t){$.ajax({url:this.remoteURL+"/project/patch",type:"post",crossDomain:!0,xhrFields:{withCredentials:!0},data:{selector:e,source:t},success:function(e){null!==e&&!e.error||(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]))},error:function(e,t,n){Eden.DB.handleError(e,t,n)}})},Eden.DB.getSelector=function(e,t,r){Eden.DB.isConnected()?$.ajax({url:this.remoteURL+"/code/get?selector="+e.replace("#","%23")+"&timestamp="+t,type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){null!==e&&!e.error||(Eden.DB.emit("error",[e?e.description:"No response from server"]),r({})),r(e||{})},error:function(e,t,n){r({}),Eden.DB.handleError(e,t,n)}}):r({})},Eden.DB.searchSelector=function(t,e,r){Eden.DB.isConnected()?$.ajax({url:this.remoteURL+"/code/search?selector="+t.replace("#","%23")+"&outtype="+e,type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){null!==e&&!e.error||(Eden.DB.emit("error",[e?e.description:"No response from server"]),r([])),e?(Eden.DB.qcacheloaded||(Eden.DB.querycache=JSON.parse(window.localStorage.getItem("query_cache")),Eden.DB.qcacheloaded=!0,null===Eden.DB.querycache&&(Eden.DB.querycache={})),Eden.DB.querycache[t]=e,Eden.DB.requestQCacheSave(),r(e)):r([])},error:function(e,t,n){r([]),Eden.DB.handleError(e,t,n)}}):(console.log("ATTEMPT CACHE",t),Eden.DB.qcacheloaded||(Eden.DB.querycache=JSON.parse(window.localStorage.getItem("query_cache")),Eden.DB.qcacheloaded=!0,null===Eden.DB.querycache&&(Eden.DB.querycache={})),e=Eden.DB.querycache[t],r(e||[]))},Eden.DB.requestQCacheSave=function(){Eden.DB.qcachetimeout||(Eden.DB.qcachetimeout=setTimeout(function(){window.localStorage.setItem("query_cache",JSON.stringify(Eden.DB.querycache)),Eden.DB.qcachetimeout=void 0},2e3))},Eden.DB.postComment=function(e,t,n){var r=e?e.id:-1,e=e?e.vid:-1;Eden.DB.isLoggedIn()&&$.ajax({url:this.remoteURL+"/comment/post",type:"post",crossDomain:!0,xhrFields:{withCredentials:!0},data:{projectID:r,versionID:e,publiclyVisible:n?0:1,comment:t},success:function(e){null!==e&&!e.error||(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]))},error:function(e,t,n){Eden.DB.handleError(e,t,n)}})};var waitingforcomment=!1;function guid(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}Eden.DB.searchComments=function(e,t,n,r,i,s){waitingforcomment?s():(e=e?e.id:-1,Eden.DB.isConnected()&&(waitingforcomment=!0,$.ajax({url:this.remoteURL+"/comment/search?projectID="+e+(i?"&newerThan="+i:"")+"&offset="+(n-1)*r+"&limit="+r,type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){waitingforcomment=!1,s(e||[])},error:function(e,t,n){waitingforcomment=!1,s(),Eden.DB.handleError(e,t,n)}})))},Eden.DB.removeComment=function(e){Eden.DB.isLoggedIn()&&$.ajax({url:this.remoteURL+"/comment/delete",type:"post",crossDomain:!0,xhrFields:{withCredentials:!0},data:{commentID:e},success:function(e){null!==e&&!e.error||(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]))},error:function(e,t,n){Eden.DB.handleError(e,t,n)}})},Eden.DB.follow=function(e,r){Eden.DB.isLoggedIn()&&$.ajax({url:this.remoteURL+"/social/followproject?projectID="+e,type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){null===e||e.error?(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]),r&&r(!1)):r&&r(!0)},error:function(e,t,n){Eden.DB.handleError(e,t,n),r&&r(!1)}})},Eden.DB.adminCommentActivity=function(e,t,n){Eden.DB.isLoggedIn()&&$.ajax({url:this.remoteURL+"/comment/activity?limit=10&offset="+t+(e?"&newerThan="+e:""),type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){null===e||e.error?(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]),n&&n(!1)):n&&n(e)},error:function(e,t,n){Eden.DB.handleError(e,t,n)}})},Eden.DB.handleError=function(e,t,n){console.log("DB ERROR",t,n),"error"!=t||n?"error"==t?Eden.DB.emit("error",[n]):("timeout"==t?Eden.DB.emit("error",["Network timeout"]):Eden.DB.emit("error","Unknown network error"),Eden.disconnect(!0)):(Eden.DB.disconnect(!0),Eden.DB.emit("error",["Not connected to construal cloud"]))},Eden.DB.adminProjectActivity=function(e,t,r){Eden.DB.isLoggedIn()&&$.ajax({url:this.remoteURL+"/project/activity?limit=30&offset="+t+(e?"&newerThan="+e:""),type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){null===e||e.error?(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]),r&&r(!1)):r&&r(e)},error:function(e,t,n){Eden.DB.handleError(e,t,n),r&&r(!1)}})},Eden.DB.getPopularTags=function(e,r){$.ajax({url:this.remoteURL+"/project/tags?tag="+e,type:"get",crossDomain:!0,xhrFields:{withCredentials:!0},success:function(e){null===e||e.error?(console.error(e),Eden.DB.emit("error",[e?e.description:"No response from server"]),r&&r(!1)):r&&r(e)},error:function(e,t,n){Eden.DB.handleError(e,t,n),r&&r(!1)}})};var browserID=window.localStorage.construit_uid;null!=browserID&&""!=browserID||(browserID=guid(),window.localStorage.setItem("construit_uid",browserID));var sessionID=guid(),root,eden,edenUI,doneLoading;function touchHandler(e){var t=e.changedTouches[0],n=document.createEvent("MouseEvent");n.initMouseEvent({touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup"}[e.type],!0,!0,window,1,t.screenX,t.screenY,t.clientX,t.clientY,!1,!1,!1,!1,0,null),t.target.dispatchEvent(n),-1==e.target.className.indexOf("ui-dialog-titlebar")&&-1==e.target.className.indexOf("ui-resizable-handle")||e.preventDefault()}Eden.DB.log=function(e,t){console.log("LOG",browserID,Eden.DB.userid||-1,e,t),$.ajax({url:this.searchServer+"/jsedenlog/jsedenlog",type:"post",data:{browserID:browserID,sessionID:sessionID,userID:Eden.DB.userid,action:e,details:t}})},function(){function I(e,t){return root.lookup("view_"+e+"_"+t)}function N(e){return $("#"+e+"-dialog")}EdenUI.prototype.menuBarHeight=45,EdenUI.prototype.dialogBorderWidth=1,EdenUI.prototype.titleBarHeight=0,EdenUI.prototype.largeTitleBar=41.22+EdenUI.prototype.dialogBorderWidth,EdenUI.prototype.scrollBarSize=14+EdenUI.prototype.dialogBorderWidth,EdenUI.prototype.scrollBarSize2=window.innerHeight-$(window).height(),EdenUI.prototype.dialogFrameWidth=2*EdenUI.prototype.dialogBorderWidth,EdenUI.prototype.dialogFrameHeight=EdenUI.prototype.titleBarHeight+EdenUI.prototype.dialogBorderWidth,EdenUI.prototype.bottomBarHeight=34.906,EdenUI.prototype.gridSizeX=Math.floor(30*window.innerWidth/1920),EdenUI.prototype.gridSizeY=Math.floor(30*window.innerHeight/1920),EdenUI.prototype.minimumWindowWidthShowing=72+EdenUI.prototype.dialogBorderWidth,EdenUI.prototype.createEmbedded=function(e,t){return this.embeddedInstances[e]||(edenUI.views[t].embed?n=edenUI.views[t].embed(e,e,""):edenUI.views[t].embedded&&(n=edenUI.views[t].embedded(e,e,"")),n?this.embeddedInstances[e]=n:void 0);var n},EdenUI.prototype.createView=function(s,e,t){if(e in this.views){"name"in this.views[e]&&(s=this.views[e].name);var o=this,n=EdenSymbol.defaultAgent,r=this.activeDialogs[s],i=I(s,"visibility"),a=i.value(),d=I(s,"title"),c=d.value();if(r==e)return"visible"!=a&&i.assign("visible",root.scope,n),this.brieflyHighlightView(s),this.viewInstances[s];this.eden.root.beginAutocalcOff(),void 0!==r&&(c==this.views[r].title&&(c=void 0),this.destroyView(s,!1)),this.titleBarHeight="ScriptView"==r?this.largeTitleBar:this.titleBarHeight;var h=this.menuBarHeight,p=this.views[e].title,l=this.views[e].dialog(s+"-dialog",p);void 0===l&&(l={});(this.viewInstances[s]=l).position;var u="true"==edenUI.getOptionValue("optCollapseToTitleBar")?"collapse":"maximize",E=N(s);E.dialog({closeOnEscape:!1,position:{using:function(){}},beforeClose:function(){return l.closing?!(l.closing=!1):o.closeView(s)},focus:function(){}});var g=[y("type"),y("x"),y("y"),y("width"),y("height"),y("lock"),y("noborder"),y("title"),y("visibility")];E.get(0).setAttribute("data-observables",g.join(","));var f=this.getDialogWindow(s);E.dialogExtend({dblclick:u,minimizable:!0,maximizable:!0,beforeMinimize:function(e){return $(e.target).parent().removeClass("window-activated"),o.hideView(s),!1},minimize:function(){var e=N(s).data("dialog-extend-minimize-controls");e.css("position","relative"),e.css("top",""),e.css("left","")},maximize:function(e){var t=f[0],n=E[0];t.style.top=h+"px";var r=window.innerHeight-h-o.scrollBarSize2-2*o.dialogBorderWidth;"true"!=edenUI.getOptionValue("optHideOnMinimize")&&(r-=o.bottomBarHeight),t.style.height=r+"px",n.style.height=r-o.titleBarHeight+"px"},restore:function(e){E.dialog("moveToTop"),o.brieflyHighlightView(e.target.id.slice(0,-7)),E.dialog("widget").draggable("option","containment",[-Number.MAX_VALUE,h,Number.MAX_VALUE,Number.MAX_VALUE])}}),this.activeDialogs[s]=e;var S=I(s,"type");S.value()!=e&&(S.removeJSObserver("changeType"),S.assign(e,root.scope,EdenSymbol.localJSAgent),S.addJSObserver("changeType",function(e,t){void 0!==t&&-1!==root.lookup("views_list").value().indexOf(s)&&o.createView(s,t)}));r=root.lookup("views_list"),g=r.value();Array.isArray(g)?-1===g.indexOf(s)&&((g=g.slice()).push(s),r.assign(g,root.scope,EdenSymbol.localJSAgent)):r.assign([s],root.scope,EdenSymbol.localJSAgent);u=I(s,"lock"),S=u.value();widthSym=I(s,"width"),widthSym.addJSObserver("plugins",v),widthSym.definition||void 0!==widthSym.value()||widthSym.assign(E.dialog("option","width"),root.scope,n);g=I(s,"height");g.addJSObserver("plugins",v),g.definition||void 0!==g.value()||g.assign(E.dialog("option","height")-(S?0:this.titleBarHeight),root.scope,n),v();r=E.closest(".ui-dialog").position(),g=I(s,"x");g.addJSObserver("plugins",x),g.definition||void 0!==g.value()||g.assign(r.left,root.scope,n);g=I(s,"y");g.addJSObserver("plugins",x),g.definition||void 0!==g.value()||g.assign(r.top,root.scope,n),x(),"visible"!=a&&(void 0===a?i.assign("visible",root.scope,n):T(0,a)),i.addJSObserver("changeState",T);var m=l.titleBarInfo;delete l.titleBarInfo,Object.defineProperty(l,"titleBarInfo",{get:function(){return m},set:function(e){m=e;var t=d.value();void 0!==e&&(t=t+" ("+e+")"),E.dialog("option","title",t)},enumerable:!0}),d.addJSObserver("updateTitleBar",A),void 0===c?d.assign(p,root.scope,n):A(0,c),u.addJSObserver("changeState",b),void 0!==S&&b(0,S);S=I(s,"noborder");S.addJSObserver("changeState",w);S=S.value();void 0!==S&&w(0,S);S=I(s,"pin");S.addJSObserver("changeState",k);S=S.value();return void 0!==S?k(0,S):this.unpinView(s),E.dialog("widget").draggable("option","containment",[-Number.MAX_VALUE,h,Number.MAX_VALUE,Number.MAX_VALUE]),E.resizeExtend=0,E.on("dialogresizestop",function(e,t){E.previousWidth=void 0,E.momentum=0,E.resizeExtend=0;var n=I(s,"width"),r=I(s,"height"),i=o.eden.root;i.beginAutocalcOff(),n.assign(t.size.width,i.scope,EdenSymbol.hciAgent),r.assign(t.size.height-o.titleBarHeight,i.scope,EdenSymbol.hciAgent),i.endAutocalcOff()}),E.on("dialogdragstop",function(e,t){var n=o.eden.root;n.beginAutocalcOff(),console.log(t),I(s,"x").assign(t.position.left,eden.root.scope,EdenSymbol.hciAgent),I(s,"y").assign(t.position.top,eden.root.scope,EdenSymbol.hciAgent),n.endAutocalcOff()}),E.on("dialogdragstart",function(){if(I(s,"x").definition||I(s,"y").definition)return!1}),E.on("dialogresizestart",function(){if(I(s,"width").definition||I(s,"height").definition)return!1}),this.eden.root.endAutocalcOff(),this.emit("createView",[s,e]),I(s,"nostack").value()?E.get(0).parentNode.className+=" ui-back":E.get(0).parentNode.className+=" ui-front",l}function y(e){return"view_"+s+"_"+e}function v(e,t){o.resizeView(s)}function x(e,t){o.moveView(s)}function T(e,t){var n=E.dialogExtend("state");"hidden"==t?"minimized"!=n&&o.minimizeView(s):"maximized"==t||E.dialog("isOpen")&&"minimized"!=n&&"collapsed"!=n||o.showView(s)}function A(e,t){void 0!==l.titleBarInfo&&(t=t+" ("+l.titleBarInfo+")"),l.title!==t&&(l.title=t,E.dialog("option","title",t),edenUI.menu&&edenUI.menu.updateViewsMenu())}function b(e,t){(lockVal=t)?(E.siblings(".ui-dialog-titlebar").css("display","none"),E.dialog("option","resizable",!1)):(E.siblings(".ui-dialog-titlebar").css("display","block"),E.dialog("option","resizable",!0)),o.resizeView(s)}function w(e,t){var n=E.get(0).parentNode.style;t?(n.border="none",n.boxShadow="none"):(n.border="1px solid #777",n.boxShadow="0 0 40px #6d8cac")}function k(e,t){t?o.pinView(s):o.unpinView(s)}this.eden.error(new Error("View type "+e+" is unavailable.  Check that the associated plug-in is loaded."))},EdenUI.prototype.closeView=function(e){return this.hideView(e),edenUI.eden.root.collectGarbage(),!0},EdenUI.prototype.destroyAllViews=function(){for(var e in this.viewInstances)this.destroyView(e,!0)},EdenUI.prototype.destroyView=function(e,t){var n,r;e in this.viewInstances&&!this.viewInstances[e].closing&&(this.viewInstances[e].closing=!0,this.viewInstances[e].destroy&&this.viewInstances[e].destroy(),root.forgetAll("^View_"+e+"_",!0,!1,!0),t?root.forgetAll("^view_"+e+"_",!0,!1,!0):root.lookup("view_"+e+"_title").removeJSObserver("updateTitleBar"),(r=N(e)).dialog("destroy"),r.remove(),r.html(""),delete this.activeDialogs[e],delete this.viewInstances[e],t&&(r=(n=root.lookup("views_list")).value(),!Array.isArray(r)||-1!==(t=r.indexOf(e))&&(r=0==t?r.slice(1):(r.splice(t,1),r),n.assign(r,root.scope,EdenSymbol.hciAgent))),this.emit("destroyView",[e]))},EdenUI.prototype.getDialogContent=N,EdenUI.prototype.getDialogWindow=function(e){return N(e).parent()},EdenUI.prototype.showView=function(e){var t=N(e);t.dialog("open").dialog("moveToTop");var n=t.dialogExtend("state");return"normal"!=n&&"maximized"!=n&&t.dialogExtend("restore"),this.activeDialogs[e]},EdenUI.prototype.updateView=function(e,t){e=this.viewInstances[e];e&&e.update&&e.update(t)},EdenUI.prototype.highlightView=function(e,t){t?this.windowHighlighter.highlight(e):(this.getDialogContent(e).data("dialog-extend-minimize-controls")||this.getDialogWindow(e)).addClass("window-highlighted")},EdenUI.prototype.stopHighlightingView=function(e,t,n){t?(this.windowHighlighter.stopHighlight(e,n),n&&this.getDialogContent(e).dialog("moveToTop")):(this.getDialogContent(e).data("dialog-extend-minimize-controls")||this.getDialogWindow(e)).removeClass("window-highlighted")},EdenUI.prototype.brieflyHighlightView=function(e){var t=this.getDialogWindow(e);t.addClass("window-activated"),setTimeout(function(){t.removeClass("window-activated")},600)},EdenUI.prototype.hideView=function(e){e in this.viewInstances&&(this.viewInstances[e].closing=!0,N(e).dialog("close"))},EdenUI.prototype.minimizeView=function(e){"true"==edenUI.getOptionValue("optHideOnMinimize")?this.hideView(e):e in this.viewInstances&&N(e).dialogExtend("minimize")},EdenUI.prototype.minimizeObscuredViews=function(e){if("true"!=edenUI.getOptionValue("optHideOnMinimize")){var t=N(e),n=t.closest(".ui-dialog");if(!n.is(this.windowHighlighter.lastDialog)&&"normal"==t.dialogExtend("state"))for(var r=t.get(0),e=n.position(),i=e.left,s=e.top,o=t.dialog("option","width")+2*EdenUI.prototype.dialogBorderWidth,a=t.dialog("option","height")+2*EdenUI.prototype.dialogBorderWidth,d=n.hasClass("ui-top"),c=$(".ui-dialog-content"),h=0;h<c.length;h++){var p,l,u,E,g=$(c[h]);c[h]!==r&&"normal"==g.dialogExtend("state")&&((u=g.closest(".ui-dialog")).hasClass("ui-front")&&!d||(p=(E=u.position()).left,l=E.top,u=g.dialog("option","width")+2*EdenUI.prototype.dialogBorderWidth,E=g.dialog("option","height")+2*EdenUI.prototype.dialogBorderWidth,+i<=p&&p+u<=i+o+0&&+s<=l&&l+E<=s+a+0&&g.dialogExtend("minimize")))}}},EdenUI.prototype.moveView=function(e){var t=N(e),n=I(e,"x"),r=I(e,"y"),e=n.value(),n=r.value(),r=this.minimumWindowWidthShowing-t.dialog("option","width"),e=e<r?r:e,n=n<0?0:n,t=t.parent().get(0);t.style.left=e+"px",t.style.top=n+"px"},EdenUI.prototype.resizeView=function(e){var t,n,r,i,s=this.viewInstances[e];s.resizing||(t=N(e),r=(n=I(e,"width")).value(),e=(i=I(e,"height")).value()+this.titleBarHeight,n.origin!==EdenSymbol.hciAgent&&t.dialog("option","width",r),i.origin!==EdenSymbol.hciAgent&&t.dialog("option","height",e),"resize"in s&&s.resize(r,e))},EdenUI.prototype.pinView=function(e){var t=this.getDialogWindow(e);t.removeClass("ui-front"),t.addClass("ui-top"),this.viewInstances[e].pinned=!0},EdenUI.prototype.unpinView=function(e){var t=this.getDialogWindow(e);this.viewInstances[e].pinned&&(t.removeClass("ui-top"),t.get(0).style.zIndex=9999,t.addClass("ui-front"),this.viewInstances[e].pinned=!1,this.windowHighlighter.unpin(t))},EdenUI.prototype.newProject=function(){this.eden.reset(),this.destroyView("jspe",!0),"Canvas2D"in this.plugins&&this.eden.executeEden('createCanvas("picture");',"new project","",EdenSymbol.hciAgent,noop),"ScriptInput"in this.plugins&&this.eden.executeEden('createView("input", "ScriptInput");',"new project","",EdenSymbol.hciAgent,noop),this.views.ErrorLog.errorWindow&&this.views.ErrorLog.errorWindow.html(""),Eden.Agent.removeAll()},EdenUI.prototype.modalDialog=function(e,t,n,r,i){function s(t){return function(e){o.dialog("destroy"),o.remove(),i(t)}}var o=$('<div id="modal"></div>'),t=$("<div>"+t+"</div>");o.append(t);for(var a=[],d=0;d<n.length;d++){var c={text:n[d],click:s(d)};a.push(c)}var h=n.length,t={text:"Cancel",click:s(h)};a.push(t),o.dialog({buttons:a,modal:!0,resizable:!1,show:"fade",title:e,close:function(){i(h)},open:function(){$(this).parent().find("button")[r].focus()},width:375}),$(".ui-widget-overlay").css("z-index",10001),o.parent().css("z-index",10002)}}(),URLUtil={getParameterByName:function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)"),e=window.location.href,e=t.exec(e);return null===e?"":decodeURIComponent(e[1].replace(/\+/g," "))},getParameters:function(){var e=window.location.href.split("?")[1];if(!e)return{};for(var t=e.split("&"),n={},r=0;r<t.length;r++){var i=t[r].split("=");void 0===n[i[0]]&&(n[i[0]]=[]),1<i.length&&n[i[0]].push(decodeURIComponent(i[1]))}return n},getArrayParameterByName:function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");for(var t=new RegExp("[\\?&]"+e+"=([^&#]*)","g"),n=window.location.href,r=t.exec(n),i=[];null!==r;){var s=decodeURIComponent(r[1].replace(/\+/g," "));i.push(s),r=t.exec(n)}return i},isCrossDomain:function(e){e=e.match(/^([a-zA-Z][a-zA-Z\d+.\-]*:)(\/\/)?([^\/@]*@)?([^\/:]+)(:\d+)?(\/|$)/);return null!==e&&(e[1]!=window.location.protocol||e[4]!=document.domain||e[5].slice(1)!=window.location.port)},downloadFile:function(e){var t=e.url,i=e.dataType,n=e.sync,s=e.success,o=e.error;if(void 0===i&&(i="text"),"function"!=typeof o)throw new Error("An error handling function must be specified.");if("function"==typeof s)if(void 0!==t){var t=String(t),r=rt.config.proxyBaseURL,a=this.isCrossDomain(t);if(!0===n&&a&&this.isCrossDomain(r))o(null,"error","Synchronous downloading not possible");else{if("boolean"==typeof n){if(a){var d="crossDomainCallback"+Math.floor(9007199254740991*Math.random());return window[d]=function(e){try{if(e.success){var t,n=e.success,r=!1;switch(i){case"text":t=n;break;case"json":try{t=JSON.parse(n)}catch(e){o(null,"parserror",e),r=!0}break;default:o(null,"error","No cross-domain interpretation available for data type "+i),r=!0}r||s(t,"success",null)}else o(null,"error",e.error)}finally{delete window[d]}},$.ajax({url:r+"?url="+encodeURI(t)+"&callback="+d,dataType:"script",async:!n,error:o})}return e.async=!n,$.ajax(e)}o(null,"error","The sync option must be a boolean, not a "+typeof n)}}else o(null,"error","A URL must be specified.");else o(null,"error","A success callback function must be specified.")},updateQueryString:function(e){var t=URLUtil.getParameters();for(n in e)t[n]=encodeURI(e[n]);var n,r="?",i=!0;for(n in t)i||(r+="&"),i=!1,r+=n+"="+t[n];return r},prefix:""},"isInteger"in Number||(Number.isInteger=function(e){return parseInt(e)===e});var doingNavigateAway=!1,confirmUnload=function(e){if(Eden.DB.log("leave",{project:eden.project?eden.project.id:-1}),!doingNavigateAway&&(eden.root.lookup("jseden_autosave").value()&&eden.project.localSave(),eden.root.lookup("jseden_leaveprompt").value())){var t="Leaving this page will discard the current script. Your work will not be saved.";return e.returnValue=t}};function Construit(options,callback){eden=new Eden,root=eden.root;var menuBar="false"!=URLUtil.getParameterByName("menus"),pluginsStr=URLUtil.getParameterByName("plugins"),exec=URLUtil.getParameterByName("exec"),load=URLUtil.getParameterByName("load"),lang=URLUtil.getParameterByName("lang"),restore=URLUtil.getParameterByName("restore"),vid=URLUtil.getParameterByName("vid"),readPassword=URLUtil.getParameterByName("r"),writePassword=URLUtil.getParameterByName("w"),api=URLUtil.getParameterByName("api"),parser=URLUtil.getParameterByName("parser");""!=parser&&(eden.options.parser=parseInt(parser)),api&&(Eden.DB.repositories=[api]);var roles=URLUtil.getParameterByName("roles"),master=URLUtil.getParameterByName("master"),myid=URLUtil.getParameterByName("id"),query=URLUtil.getParameterByName("q"),mode=URLUtil.getParameterByName("mode"),urlparams=URLUtil.getParameters(),x,plugins;for(x in urlparams)1<urlparams[x].length?eden.root.lookup("jseden_url_"+x).assign(urlparams[x],eden.root.scope,Symbol.localJSAgent):eden.root.lookup("jseden_url_"+x).assign(urlparams[x][0],eden.root.scope,Symbol.localJSAgent);""==lang&&(lang="en");var defaultPlugins=["Canvas2D","DependencyMap","HTMLContent","PluginManager","ScriptInput","SymbolLookUpTable","SymbolViewer","VersionViewer","P2PManager"],includeDefaultPlugins;""==pluginsStr?plugins=defaultPlugins:(includeDefaultPlugins=" "==pluginsStr[0],includeDefaultPlugins&&(pluginsStr=pluginsStr.slice(1)),plugins=pluginsStr.split(","),includeDefaultPlugins&&(plugins=plugins.concat(defaultPlugins)),""!=views&&"default"!=views||(plugins.push("Canvas2D"),plugins.push("ScriptInput"))),$(document).ready(function(){edenUI=new EdenUI(eden),edenUI.scrollBarSize2=window.innerHeight-$(window).height(),eden.ismobile=mobilecheck(),eden.root.lookup("jseden_mobile").assign(eden.ismobile,eden.root.scope,Symbol.defaultAgent),eden.root.lookup("jseden_parser_cs3").assign(!0,eden.root.scope,EdenSymbol.defaultAgent),eden.root.lookup("jseden_parser_cs3").addJSObserver("parser",(e,t)=>{Eden.AST.version=t?Eden.AST.VERSION_CS3:Eden.AST.VERSION_CS2}),$.ajax({url:"version.json",dataType:"json",success:function(e){e.tag&&(document.title=document.title+" "+e.tag);var t=e.tag.slice(1).split("."),n=t[2].split("-");eden.root.lookup("jseden_version_major").assign(parseInt(t[0]),eden.root.scope,Symbol.defaultAgent),eden.root.lookup("jseden_version_minor").assign(parseInt(t[1]),eden.root.scope,Symbol.defaultAgent),eden.root.lookup("jseden_version_patch").assign(parseInt(n[0]),eden.root.scope,Symbol.defaultAgent),eden.root.lookup("jseden_version_commit").assign(parseInt(n[1]),eden.root.scope,Symbol.defaultAgent),eden.root.lookup("jseden_version_name").assign(e.tag,eden.root.scope,Symbol.defaultAgent),eden.root.lookup("jseden_version_sha").assign(e.sha,eden.root.scope,Symbol.defaultAgent)},cache:!1}),$(document).on("keydown",null,"ctrl+m",function(){edenUI.cycleNextView()}).on("keyup",null,"ctrl",function(){edenUI.stopViewCycling()}).on("keydown",null,"backspace",function(e){var t=e.target,n=t.tagName.toUpperCase();"INPUT"==n||"TEXTAREA"==n||t.isContentEditable||e.preventDefault()}),"false"!=edenUI.getOptionValue("optConfirmUnload")&&window.addEventListener("beforeunload",confirmUnload);var loadLanguage=function(lang,callback){$.getScript("js/language/"+lang+".js",function(data){Language.language=lang,eval(data),menuBar?edenUI.menu=new EdenUI.MenuBar:(document.getElementById("jseden-main").style.top="0",eden.root.lookup("jseden_nomenu").assign(!0,eden.root.scope,Symbol.defaultAgent)),options&&options.noload||(edenUI.feedback=new EdenUI.Feedback,edenUI.explorer=new EdenUI.Explorer),callback()})},loadPlugins=function(t,n){var r=function(){var e;0<t.length?(e=t.shift(),edenUI.loadPlugin(e,r)):n()};r()};doneLoading=function(e){if(window.scrollTo(0,0),edenUI.finishedLoading(),exec&&(";"!=exec.slice(-1)&&(exec+=";"),eden.execute2(exec)),(""!=myid||""!=master)&&(eden.peer=new Eden.Peer(""!=master?master:void 0,""!=myid?myid:void 0),roles)){roles=roles.split(",");for(var t=0;t<roles.length;t++)eden.peer.roles[roles[t]]=!0}callback&&callback(e)},loadLanguage(lang,function(){options&&options.noload?Eden.DB.connect(Eden.DB.repositories[Eden.DB.repoindex],function(){console.log("DONE LOADING"),doneLoading(!0)}):loadPlugins(plugins,function(){Eden.DB.connect(Eden.DB.repositories[Eden.DB.repoindex],function(){""!=load?(null!==mode&&""!=mode&&eden.root.lookup("jseden_project_mode").assign(mode,eden.root.scope,Symbol.defaultAgent),Eden.DB.log("urlload",{href:window.location.href,useragent:navigator.userAgent,referrer:document.referrer,pid:load,vid:vid,private:null!==readPassword}),Eden.Project.load(parseInt(load),null===vid||""==vid?void 0:parseInt(vid),null===readPassword||""==readPassword?void 0:readPassword,function(){doneLoading(!0)})):""!=restore?(null!==mode&&""!=mode&&eden.root.lookup("jseden_project_mode").assign(mode,eden.root.scope,Symbol.defaultAgent),Eden.project.restore(),doneLoading(!0)):(Eden.DB.log("home",{href:window.location.href,referrer:document.referrer,useragent:navigator.userAgent}),doneLoading(!1))}),Eden.DB.repoindex=(Eden.DB.repoindex+1)%Eden.DB.repositories.length})})})}function removeHash(e){var t=e.lastIndexOf("_");return e.substring(0,t)}function scopehash(e){for(var t=0,n=e.length,r=0;r<n;r++)t=(t<<5)-t+e.charCodeAt(r),t&=t;return t}!function(){function t(){this.value=void 0,this.error=!1,this.line=0}Eden.EdenSyntaxData=t;var e=Eden.Language,n=e.keywords,r=e.values;function i(e){this.code=e,this.position=0,this.position_stack=[0],this.prevposition=0,this.line=1,this.prevline=1,this.data=new t}(Eden.EdenStream=i).prototype.pushPosition=function(){this.position_stack.push([this.position,this.line,this.prevposition,this.prevline])},i.prototype.popPosition=function(){var[e,t,n,r]=this.position_stack.pop();this.position=e,this.line=t,this.prevposition=n,this.prevline=r},i.prototype.discardPosition=function(){this.position_stack.pop()},i.prototype.get=function(){return this.position<this.code.length?this.code.charCodeAt(this.position++):0},i.prototype.peek=function(){return this.position<this.code.length?this.code.charCodeAt(this.position):0},i.prototype.peek2=function(){return this.position+1>=this.code.length?0:this.code.charCodeAt(this.position+1)},i.prototype.peek3=function(){return this.position+2>=this.code.length?0:this.code.charCodeAt(this.position+2)},i.prototype.readLine=function(){var e=this.code.indexOf("\n",this.position);if(-1==e){var t=this.code.substring(this.position);return this.position=this.code.length,t}t=this.code.substring(this.position,e+1);return this.position=e+1,this.line++,t},i.prototype.peekLine=function(){var e=this.code.indexOf("\n",this.position);return-1!=e?this.code.substring(this.position,e+1):this.code.substring(this.position)},i.prototype.move=function(e){this.position=e},i.prototype.reset=function(){this.position=0,this.position_stack=[0],this.prevposition=0,this.line=1},i.prototype.tokenText=function(){return this.code.substr(this.prevposition,this.position-this.prevposition)},i.prototype.isBEOL=function(){if(0==this.prevposition)return!0;if(10==this.peek2())return!0;for(var e=this.prevposition-1,t=this.code.charCodeAt(e);9==t||32==t;)e--,t=this.code.charCodeAt(e);return 10==t},i.prototype.isBOL=function(){if(0==this.prevposition)return!0;var e=this.prevposition-1;return 10==this.code.charCodeAt(e)},i.prototype.isFollowingWhiteSpace=function(){var e=0<=this.prevposition-1?this.code.charCodeAt(this.prevposition-1):0;return 0==this.prevposition||this.isWhiteSpace(e)},i.prototype.previousChar=function(){return 0<=this.prevposition-1?this.code.charCodeAt(this.prevposition-1):0},i.prototype.skip=function(){this.position++},i.prototype.eof=function(){return this.position>=this.code.length},i.prototype.valid=function(){return this.position<this.code.length},i.prototype.unget=function(){this.position--},i.prototype.skipWhiteSpace=function(){for(;this.valid();){var e=this.peek();if(10===e&&this.line++,9!==e&&10!==e&&13!==e&&32!==e&&160!==e)break;this.skip()}},i.prototype.isWhiteSpace=function(e){return 9===e||10===e||13===e||32===e||160===e},i.prototype.skipLine=function(){for(;this.valid()&&10!==this.peek();)this.skip()},i.prototype.isAlphaNumeric=function(e){return 48<=e&&e<=57||65<=e&&e<=90||97<=e&&e<=122||95===e||128<=e||36===e},i.prototype.isNumeric=function(e){return 48<=e&&e<=57},i.prototype.tokenType=function(e){switch(e){case"OBSERVABLE":return"identifier";case"JAVASCRIPT":return"javascript";case"NUMBER":return"number";case"STRING":return"string";case"CHARACTER":return"character";case"BOOLEAN":return"boolean";case"(":case"[":case"{":return"openbracket";case")":case"]":case"}":return"closebracket";case",":case".":case";":case":":return"separator"}return"string"!=typeof e?(console.error(e),"INVALID"):this.isAlphaNumeric(e.charCodeAt(0))?"keyword":"operator"},i.prototype.parseAlphaNumeric=function(e){for(var t=this.position;this.isAlphaNumeric(this.peek());)++this.position;var n=this.code.substring(t,this.position);return e.value=n,0<this.position-t},i.prototype.parseString=function(e,t){for(var n="";this.valid()&&this.peek()!=t;){var r=String.fromCharCode(this.get());if("\n"===r)return this.unget(),e.error=!0,void(e.value="LINEBREAK");n+="\\"===r?"n"===(r=String.fromCharCode(this.get()))?"\n":"t"===r?"\t":r:r}this.valid()&&this.peek()===t?(this.skip(),e.error=!1):e.error=!0,e.value=n},i.prototype.parseCharacter=function(e){var t=String.fromCharCode(this.get());if("'"===t)return e.value="",void(e.error=!0);"\\"===t&&(t=String.fromCharCode(this.get())),e.value=t,this.valid()&&39==this.peek()?this.skip():e.error=!0},i.prototype.parseNumber=function(e){var t="";let n=this.peek();for(;this.valid()&&this.isNumeric(n);)t+=String.fromCharCode(this.get()),n=this.peek();if(46===n&&this.isNumeric(this.peek2()))for(this.skip(),t+=".",n=this.peek();this.valid()&&this.isNumeric(n);)t+=String.fromCharCode(this.get()),n=this.peek();if(101===n||69===n){var r=this.peek2();if(this.isNumeric(r)||45===r)for(t+="e",this.skip(),45===r&&this.isNumeric(this.peek2())&&(t+="-",this.skip()),n=this.peek();this.valid()&&this.isNumeric(n);)t+=String.fromCharCode(this.get()),n=this.peek()}e.value=parseFloat(t)},i.prototype.readCommentToken=function(){if(this.prevline=this.line,this.skipWhiteSpace(),this.prevposition=this.position,this.eof())return"EOF";for(var e=0;this.valid();){var t=this.code.charCodeAt(this.position++);if(10===t&&++this.line,47===t){if(42===e)return"*/";if(42==this.peek())return this.skip(),"/*"}e=t}return"INVALID"},i.prototype.readJSToken=function(){if(this.prevline=this.line,this.skipWhiteSpace(),this.prevposition=this.position,this.eof())return"EOF";for(var e=0,t=0;this.valid();){var n=this.code.charCodeAt(this.position++);if(10===n&&++this.line,36===n&&125===e&&125==t)return"}}$";t=e,e=n}return"INVALID"},i.prototype.readToken=function(e){if(this.prevline=this.line,this.skipWhiteSpace(),this.prevposition=this.position,this.eof())return"EOF";var t=this.code.charCodeAt(this.position);switch(this.position++,t){case 33:return 61===this.peek()?(this.skip(),"!="):126===this.peek()?(this.skip(),"!~"):"!";case 34:return this.parseString(this.data,34),"STRING";case 35:return 35===this.peek()?(this.skip(),"##"):"#";case 36:if(123===this.peek()&&123===this.peek2())return this.skip(),this.skip(),"${{";if(123===this.peek())return this.skip(),"${";break;case 37:return"%";case 38:return 38===this.peek()?(this.skip(),"&&"):61===this.peek()?(this.skip(),"&="):"&";case 39:return"'";case 40:return"(";case 41:return")";case 42:return 61===this.peek()?(this.skip(),"*="):47===this.peek()?(this.skip(),"*/"):"*";case 43:return 43===this.peek()?(this.skip(),"++"):61===this.peek()?(this.skip(),"+="):"+";case 44:return",";case 45:return 45===this.peek()?(this.skip(),"--"):61===this.peek()?(this.skip(),"-="):"-";case 46:return 46===this.peek()?(this.skip(),".."):".";case 47:return 47===this.peek()&&61==this.peek2()?(this.skip(),this.skip(),"//="):47===this.peek()?(this.skip(),"//"):61===this.peek()?(this.skip(),"/="):42===this.peek()?(this.skip(),"/*"):"/";case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.unget(),this.parseNumber(this.data),"NUMBER";case 58:return 58===this.peek()?(this.skip(),"::"):":";case 59:return";";case 60:return 60===this.peek()?(this.skip(),"<<"):61===this.peek()?(this.skip(),"<="):47===this.peek()?(this.skip(),"</"):126===this.peek()?(this.skip(),"<~"):"<";case 61:return 61===this.peek()?(this.skip(),"=="):126===this.peek()?(this.skip(),"=~"):"=";case 62:return 62===this.peek()?(this.skip(),">>"):61===this.peek()?(this.skip(),">="):">";case 63:return"?";case 64:return"@";case 91:return"[";case 92:return"\\";case 93:return"]";case 94:return"^";case 96:return"`";case 123:return"{";case 124:return 124===this.peek()?(this.skip(),"||"):61===this.peek()?(this.skip(),"|="):"|";case 125:return 125===this.peek()&&36===this.peek2()?(this.skip(),this.skip(),"}}$"):"}";case 126:return 62===this.peek()?(this.skip(),"~>"):"~"}if(this.unget(),this.parseAlphaNumeric(this.data)){t=n[this.data.value];if(t)return t;t=r[this.data.value];return t?(this.data.value=t,"BOOLEAN"):"OBSERVABLE"}return this.skip(),"INVALID"},"undefined"!=typeof require&&"undefined"!=typeof exports?(exports.EdenStream=i,exports.EdenSyntaxData=t):window.EdenStream=i}(),function(){Eden.SyntaxError=function(e,t,n){this.type="syntax",this.context=e,this.errno=t,this.extra=n,this.token=e.token,this.prevtoken=e.previous,this.line=e.stream.prevline,this.position=e.stream.position,this.prevposition=e.stream.prevposition},Eden.SyntaxError.UNKNOWN=0,Eden.SyntaxError.EXPCLOSEBRACKET=1,Eden.SyntaxError.BADFACTOR=2,Eden.SyntaxError.ACTIONCOLON=3,Eden.SyntaxError.ACTIONNOWATCH=4,Eden.SyntaxError.ACTIONCOMMAS=5,Eden.SyntaxError.ACTIONOPEN=6,Eden.SyntaxError.ACTIONCLOSE=7,Eden.SyntaxError.LOCALNAME=8,Eden.SyntaxError.LOCALSEMICOLON=9,Eden.SyntaxError.WHENTYPE=10,Eden.SyntaxError.LISTINDEXEXP=11,Eden.SyntaxError.LISTINDEXCLOSE=12,Eden.SyntaxError.LVALUE=13,Eden.SyntaxError.SEMICOLON=14,Eden.SyntaxError.STATEMENT=15,Eden.SyntaxError.DEFINITION=16,Eden.SyntaxError.FUNCCALLEND=17,Eden.SyntaxError.LISTLITCLOSE=18,Eden.SyntaxError.TERNIFCOLON=19,Eden.SyntaxError.IFCONDOPEN=20,Eden.SyntaxError.IFCONDCLOSE=21,Eden.SyntaxError.PARAMNAME=22,Eden.SyntaxError.PARAMSEMICOLON=23,Eden.SyntaxError.FUNCOPEN=24,Eden.SyntaxError.FUNCCLOSE=25,Eden.SyntaxError.FUNCNAME=26,Eden.SyntaxError.FOROPEN=27,Eden.SyntaxError.FORCLOSE=28,Eden.SyntaxError.FORSTART=29,Eden.SyntaxError.FORCOND=30,Eden.SyntaxError.SUBSCRIBEOPEN=31,Eden.SyntaxError.SUBSCRIBECLOSE=32,Eden.SyntaxError.SWITCHOPEN=33,Eden.SyntaxError.SWITCHCLOSE=34,Eden.SyntaxError.DEFAULTCOLON=35,Eden.SyntaxError.CASELITERAL=36,Eden.SyntaxError.CASECOLON=37,Eden.SyntaxError.INSERTCOMMA=38,Eden.SyntaxError.DELETECOMMA=39,Eden.SyntaxError.APPENDCOMMA=40,Eden.SyntaxError.SCOPENAME=41,Eden.SyntaxError.SCOPEEQUALS=42,Eden.SyntaxError.SCOPECLOSE=43,Eden.SyntaxError.BACKTICK=44,Eden.SyntaxError.WHILEOPEN=45,Eden.SyntaxError.WHILECLOSE=46,Eden.SyntaxError.WHILENOSTATEMENT=47,Eden.SyntaxError.NEGNUMBER=48,Eden.SyntaxError.DEFINELISTIX=49,Eden.SyntaxError.OUTOFBOUNDS=50,Eden.SyntaxError.PROPERTYNAME=51,Eden.SyntaxError.WHILEOFDO=52,Eden.SyntaxError.PARAMNUMBER=53,Eden.SyntaxError.AFTEROPEN=55,Eden.SyntaxError.AFTERCLOSE=56,Eden.SyntaxError.ACTIONNAME=57,Eden.SyntaxError.WHENOPEN=58,Eden.SyntaxError.WHENCLOSE=59,Eden.SyntaxError.DONAME=60,Eden.SyntaxError.PROCNAME=61,Eden.SyntaxError.IMPORTPATH=62,Eden.SyntaxError.IMPORTOPTION=63,Eden.SyntaxError.IMPORTCOMB=64,Eden.SyntaxError.IFNOSTATEMENT=65,Eden.SyntaxError.AFTERNOSTATEMENT=66,Eden.SyntaxError.WHENNOSTATEMENT=67,Eden.SyntaxError.LITCHAREMPTY=68,Eden.SyntaxError.LITCHARCLOSE=69,Eden.SyntaxError.LITSTRLINE=70,Eden.SyntaxError.LITSTRCLOSE=71,Eden.SyntaxError.IMPORTTAG=72,Eden.SyntaxError.SWITCHSCRIPT=73,Eden.SyntaxError.RANGEBANNED=74,Eden.SyntaxError.HEREDOCTOKEN=75,Eden.SyntaxError.SELECTORACTION=76,Eden.SyntaxError.SELECTORATTRIB=77,Eden.SyntaxError.SELECTORTAG=78,Eden.SyntaxError.SELECTORBTICK=79,Eden.SyntaxError.SELECTOROPTION=80,Eden.SyntaxError.QUERYOPEN=81,Eden.SyntaxError.QUERYCLOSE=82,Eden.SyntaxError.QUERYSELECTOPEN=83,Eden.SyntaxError.QUERYSELECTCLOSE=84,Eden.SyntaxError.QUERYSELECTCOMMA=85,Eden.SyntaxError.BLOCKCOMMENT=86,Eden.SyntaxError.NEWLINE=87,Eden.SyntaxError.WHENROLE=88,Eden.SyntaxError.ALIASQUERY=89,Eden.SyntaxError.EVALOPEN=90,Eden.SyntaxError.EVALCLOSE=91,Eden.SyntaxError.DOATTRIBCLOSE=92,Eden.SyntaxError.DOBADATTRIB=93,Eden.SyntaxError.QUERYNOTALLOWED=94,Eden.SyntaxError.SYNCNOTALLOWED=95,Eden.SyntaxError.BADEXPRTYPE=96,Eden.SyntaxError.db=[{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return"}"==this.token||"]"==this.token?0:";"==this.token?1:2},suggestion:{expected:[")"],next:[";","+","-","==","<=",">=","!=","/","*","%","^"]}},{message:function(){if("{"==this.token)return 0;if(")"==this.token)return"operator"==this.context.stream.tokenType(this.prevtoken)?3:1;var e=this.context.stream.tokenType(this.token);return"keyword"==e?4:"operator"==e?3:2},suggestion:{expected:["NUMBER","STRING","OBSERVABLE","&","!","("],next:["NUMBER","STRING","OBSERVABLE","&","!","(",";","+","-","==","<=",">=","!=","/","*","%","^"]}},{message:function(){return"{"==this.token?1:"OBSERVABLE"==this.token?0:"keyword"==this.context.stream.tokenType(this.token)?3:2},suggestion:{expected:[":"],next:["OBSERVABLE"]}},{message:function(){if("{"==this.token)return 2;if("("==this.token)return 3;if("["==this.token&&(":"==this.prevtoken||","==this.prevtoken))return 6;if("NUMBER"==this.token||"STRING"==this.token)return 4;if(","==this.token)return 5;var e=this.context.stream.tokenType(this.token);return"keyword"==e?0:1},suggestion:{expected:["OBSERVABLE"],next:[",","{"]}},{message:function(){return"{"==this.token?0:"("!=this.token||this.context.stream.isBEOL()?"keyword"==this.context.stream.tokenType(this.token)?2:3:1},suggestion:{expected:["OBSERVABLE"],next:[",","{"]}},{message:function(){if(("("==this.token||"["==this.token)&&this.context.stream.isBEOL())return 6;if("("==this.token)return 0;if("["==this.token)return 1;if(";"==this.token)return 2;var e=this.context.stream.tokenType(this.token);return"keyword"==e||"identifier"==e?3:"separator"==e?4:5},suggestion:{expected:["{"],next:["local","OBSERVABLE","if","for","switch","while","return"]}},{message:function(){return(")"==this.token||"]"==this.token)&&this.context.stream.isBEOL()?0:1},suggestion:{expected:["}"],next:["proc","func","if","for","OBSERVABLE","switch","while","return","continue","break"]}},{message:function(){return"keyword"==this.context.stream.tokenType(this.token)?0:";"==this.token?1:2},suggestion:{expected:["OBSERVABLE"],next:[";"]}},{message:function(){return"is"==this.token||"="==this.token?1:0},suggestion:{expected:[";"],next:["local","OBSERVABLE","if","for","switch","while","return"]}},{message:function(){return 0},suggestion:{expected:["touch","change","("],next:["OBSERVABLE",":","NUMBER","STRING","!","&"]}},{message:function(){return 0},suggestion:{expected:["(","OBSERVABLE","NUMBER"],next:["]","OBSERVABLE","NUMBER","+","-","/","*","%","^"]}},{message:function(){return 1},suggestion:{expected:["]"],next:["[",".","=","+=","-=","==","+","-","/","*",";","/=","*=","%","^","is"]}},{message:function(){return 0},suggestion:{expected:["OBSERVABLE"],next:[".","[","is","=","+=","-=","++","--","*=","/="]}},{message:function(){if("."!=this.token)return"OBSERVABLE"==this.token?this.context.stream.isBEOL()?3:4:0;var e=2<=this.position?this.context.stream.code.charCodeAt(this.position-2):0;return"NUMBER"==this.prevtoken&&32!=e&&160!=e?1:2},suggestion:{expected:[";"],next:["proc","when","OBSERVABLE","if","for","while","EOF","switch","func"]}},{message:function(){return 0},suggestion:{expected:["proc","func","when","if","for","while","switch","OBSERVABLE","{"],next:["OBSERVABLE","(","change","touch","is","=","+=","-=","*=","proc","func","when","if","for","while","switch"]}},{message:function(){return 0},suggestion:{expected:["=","is","+=","-=","/=","*="],next:["(","OBSERVABLE","NUMBER","STRING","!"]}},{message:function(){return 0},suggestion:{expected:[")"],next:[";","(","[","+","-","/","*","%","^"]}},{message:function(){return 0},suggestion:{expected:["]"],next:[]}},{message:function(){return 0},suggestion:{expected:[":"],next:[]}},{message:function(){return 0},suggestion:{expected:["("],next:[]}},{message:function(){return 0},suggestion:{expected:[")"],next:[]}},{message:function(){return 0},suggestion:{expected:["OBSERVABLE"],next:[";"]}},{message:function(){return 0},suggestion:{expected:[";"],next:["para","local","OBSERVABLE","if","for","switch","while","return"]}},{message:function(){if(("("==this.token||"["==this.token)&&this.context.stream.isBEOL())return 6;if("("==this.token)return 0;if("["==this.token)return 1;if(";"==this.token)return 2;var e=this.context.stream.tokenType(this.token);return"keyword"==e||"identifier"==e?3:"separator"==e?4:5},suggestion:{expected:["{"],next:["local","OBSERVABLE","if","for","switch","while","return"]}},{message:function(){return 0},suggestion:{expected:["}"],next:[";"]}},{message:function(){return 0},suggestion:{expected:["OBSERVABLE"],next:["{"]}},{message:function(){return 0},suggestion:{expected:["("],next:[]}},{message:function(){return 0},suggestion:{expected:[")"],next:[]}},{message:function(){return 0},suggestion:{expected:[";"],next:[]}},{message:function(){return 0},suggestion:{expected:[";"],next:[]}},{message:function(){return 0},suggestion:{expected:["["],next:[]}},{message:function(){return 0},suggestion:{expected:["]"],next:[]}},{message:function(){return 0},suggestion:{expected:["("],next:[]}},{message:function(){return 0},suggestion:{expected:["]"],next:[]}},{message:function(){return 0},suggestion:{expected:[":"],next:[]}},{message:function(){return 0},suggestion:{expected:["NUMBER","STRING"],next:[]}},{message:function(){return 0},suggestion:{expected:[":"],next:[]}},{message:function(){return 0},suggestion:{expected:[","],next:[]}},{message:function(){return 0},suggestion:{expected:[","],next:[]}},{message:function(){return 0},suggestion:{expected:[","],next:[]}},{message:function(){return 0},suggestion:{expected:["OBSERVABLE"],next:[]}},{message:function(){return 0},suggestion:{expected:["="],next:[]}},{message:function(){return 0},suggestion:{expected:["}"],next:[]}},{message:function(){return 0},suggestion:{expected:["`"],next:[]}},{message:function(){return 0},suggestion:{expected:["("],next:[]}},{message:function(){return 0},suggestion:{expected:[")"],next:[]}},{message:function(){return 0},suggestion:{expected:[")"],next:[]}},{message:function(){return 0},suggestion:{expected:["NUMBER"],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){var e=this.context.stream.tokenType(this.token);return"keyword"==e?0:"boolean"==e||"character"==e||"string"==e||"number"==e?1:":"==this.token?4:"{"==this.token?5:"closebracket"==this.token?3:2},suggestion:{expected:["OBSERVABLE"],next:[":"]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}},{message:function(){return 0},suggestion:{expected:[],next:[]}}];var n=Eden.Language;Eden.SyntaxError.prototype.extractBefore=function(e){for(var t=this.prevposition;0<t&&0<e&&10!=this.context.stream.code.charCodeAt(t);)t--,e--;return 10==this.context.stream.code.charCodeAt(t)&&t++,this.context.stream.code.substr(t,this.prevposition-t)},Eden.SyntaxError.prototype.extractToken=function(){return this.context.stream.code.substr(this.prevposition,this.position-this.prevposition)},Eden.SyntaxError.prototype.extractAfter=function(e){for(var t=this.position;t<this.context.stream.code.length&&0<e&&10!=this.context.stream.code.charCodeAt(t);)t++,e--;return this.context.stream.code.substr(this.position,t-this.position)},Eden.SyntaxError.prototype.buildSuggestion=function(){var e=Eden.SyntaxError.db[this.errno].suggestion;return-1!=e.next.indexOf(this.token)?this.extractBefore(10)+e.expected[0]+" "+this.extractToken()+this.extractAfter(10):this.extractBefore(10)+e.expected[0]+" "+this.extractAfter(10)},Eden.SyntaxError.prototype.messageText=function(){var e=Eden.SyntaxError.db[this.errno],e=n.errors[this.errno][e.message.call(this)];return void 0===this.extra?e:e+": "+this.extra},Eden.SyntaxError.prototype.prettyPrint=function(){this.context.stream.pushPosition(),this.context.stream.move(this.position);var e=Eden.SyntaxError.db[this.errno],t="Error:\n    "+n.errors[this.errno][e.message.call(this)]+"\n    Source : "+this.context.src+", line "+this.line+"\n    Code   : "+this.errno;return t+="\n    Here   : "+this.extractBefore(10)+">>> "+this.extractToken()+" <<<"+this.extractAfter(10),e.suggestion&&(t+="\n    Suggestion : "+this.buildSuggestion()),this.context.stream.popPosition(),t},Eden.SyntaxError.prototype.toString=function(){return this.prettyPrint()},Eden.RuntimeError=function(e,t,n,r){this.type="runtime",this.line=-1,this.statement=n,this.extra=r,this.errno=t,this.context=e},Eden.RuntimeError.UNKNOWN=0,Eden.RuntimeError.ASSIGNEXEC=1,Eden.RuntimeError.FUNCCALL=2,Eden.RuntimeError.ACTIONNAME=3,Eden.RuntimeError.NOAGENT=4,Eden.RuntimeError.NOTSUPPORTED=5,Eden.RuntimeError.ASSIGNTODEFINED=6,Eden.RuntimeError.ASSIGNDIMENSION=7,Eden.RuntimeError.EXTENDSTATIC=8,Eden.RuntimeError.INFINITERANGE=9,Eden.RuntimeError.NOLISTRANGE=10,Eden.RuntimeError.LEFTCONCAT=11,Eden.RuntimeError.RIGHTCONCAT=12,Eden.RuntimeError.AGENTSOURCE=13,Eden.RuntimeError.JSOBSERVER=14,Eden.RuntimeError.PROCAGENT=15,Eden.RuntimeError.ARGUMENTS=16,Eden.RuntimeError.NOTCHILD=17,Eden.RuntimeError.INFINITEWHEN=18,Eden.RuntimeError.ASSERTVALID=19,Eden.RuntimeError.ASSERTTYPE=20,Eden.RuntimeError.EXECUTESYNTAX=21,Eden.RuntimeError.IDENTIFIER=22,Eden.RuntimeError.SCOPERECURSION=23,Eden.RuntimeError.SCOPELIMIT=24,Eden.RuntimeError.prototype.messageText=function(){var e=!this.statement||"functioncall"!=this.statement.type&&"definition"!=this.statement.type&&"assignment"!=this.statement.type?"":"'"+this.statement.lvalue.name+"': ";switch(!this.statement&&this.context&&this.context.currentObservables&&0<this.context.currentObservables.length&&(e=this.context.currentObservables[this.context.currentObservables.length-1].name+": "),this.errno){case Eden.RuntimeError.ACTIONNAME:case Eden.RuntimeError.NOAGENT:case Eden.RuntimeError.NOTSUPPORTED:case Eden.RuntimeError.AGENTSOURCE:case Eden.RuntimeError.JSOBSERVER:case Eden.RuntimeError.PROCAGENT:case Eden.RuntimeError.ARGUMENTS:case Eden.RuntimeError.IDENTIFIER:case Eden.RuntimeError.EXTENDSTATIC:return e+this.extra;case Eden.RuntimeError.EXECUTESYNTAX:return"Execute: "+this.extra;case Eden.RuntimeError.ASSERTVALID:return e+"Assert - "+this.extra;case Eden.RuntimeError.ASSERTTYPE:return e+"bad type - "+this.extra;case Eden.RuntimeError.ASSIGNTODEFINED:return e+"cannot assign to a defined list, use 'is'";case Eden.RuntimeError.ASSIGNDIMENSION:return e+"list does not have this many dimensions";case Eden.RuntimeError.RIGHTCONCAT:return e+"Concatenation: When the right hand side is a list then the left hand side must also be a list";case Eden.RuntimeError.LEFTCONCAT:return e+"Concatenation: When the left hand side is a list then the right hand side must also be a list";case Eden.RuntimeError.INFINITERANGE:return e+"range scope is infinite";case Eden.RuntimeError.NOLISTRANGE:return e+"range 'in' is not a list";case Eden.RuntimeError.INFINITEWHEN:return e+"infinite when loop detected";case Eden.RuntimeError.SCOPERECURSION:return e+"scope recursion limit hit";case Eden.RuntimeError.SCOPELIMIT:return e+"scope limit hit"}return 0<=String(this.extra).search("is not a function")?e+"function used does not exist":this.errno==Eden.RuntimeError.FUNCCALL&&(0<=String(this.extra).search("Cannot read property 'call'")||0<=String(this.extra).search("Cannot read property 'apply'"))?e+"procedure does not exist":String(this.extra).match(/Cannot read property .* of undefined/)?e+"uses an undefined list":this.extra},Eden.RuntimeError.prototype.edenSource=function(){if(this.statement)if("definition"==this.statement.type){var e=this.context.symbols[this.statement.lvalue.name];if(e&&e.definition)return e.getSource()}else if(this.statement.getSource)return this.statement.getSource()},Eden.RuntimeError.prototype.javascriptSource=function(){return this.statement.generate({scopes:[],dependencies:{}},"scope")},Eden.RuntimeError.prototype.details=function(){var e="";return"definition"!=this.statement.type&&"assignment"!=this.statement.type||(e+="Symbol: "+this.statement.lvalue.name+"\n"),0<=String(this.extra).search("SyntaxError")?e+="JavaScript: "+this.javascriptSource()+"\n":e+="Source: "+this.edenSource()+"\n",this.extra.message&&(e+="Original: "+this.extra.message+"\n"),e},Eden.RuntimeError.prototype.prettyPrint=function(){return this.extra&&this.extra.stack?"Run-time Error:\n"+this.extra.stack:"Run-time Error:\n"}}(),function(){Eden.Selectors={cache:{}};var l=Eden.EdenSymbol;Eden.Selectors.getScriptBase=function(e){for(var t=e;t.parent;)t=t.parent;return t.base.origin.name},Eden.Selectors.buildScriptTree=function(e){for(var t={},n=0;n<e.length;n++)for(var r=e[n].split(/[\.\:]+/),i=t,s=0;s<r.length;s++)void 0===i[r[s]]&&(i[r[s]]={}),i=i[r[s]];return t},Eden.Selectors.getID=function(e){for(var t=e,n=[];t;)"script"==t.type&&t.name?void 0===t.parent?t.base&&t.base.origin&&t.base.origin.id?n.splice(0,0,t.name+".id("+t.base.origin.id+")"):eden.project&&t===eden.project.ast.script?n.splice(0,0,":project"):n.splice(0,0,t.name+".id("+t.id+")"):n.splice(0,0,t.name):n.splice(0,0,".id("+t.id+")"),(t=t.parent)&&("script"==t.type&&t.parent&&"script"!=t.parent.type?t=("codeblock"==t.parent.type?t.parent:t).parent:"codeblock"==t.type&&(t=t.parent));return n.join(" > ")},Eden.Selectors.getPath=function(e){},Eden.Selectors.testType=function(e){if("binaryop"==e.type)switch(e.op){case"+":case"-":case"/":case"*":case"^":case"%":return"number";case"//":return"list";case"==":case"<":case">":case"<=":case">=":case"||":case"&&":case"!=":return"boolean";default:return"unknown"}else if("literal"==e.type)switch(e.datatype){case"NUMBER":return"number";case"BOOLEAN":return"boolean";case"STRING":return"string";case"LIST":return"list";default:return"unknown"}return"unknown"},Eden.Selectors.getChildren=function(e,t){var n=[];if(void 0===e)return n;for(var r=0;r<e.length;r++)if("script"===e[r].type)n.push.apply(n,e[r].statements.map(e=>"substat"===e.type&&e.last?e.last:e)),t&&n.push.apply(n,Eden.Selectors.getChildren(e[r].statements,t));else if("for"===e[r].type)e[r].statement&&"script"===e[r].statement.type&&(n.push.apply(n,e[r].statement.statements),t&&n.push.apply(n,Eden.Selectors.getChildren(e[r].statement.statements,t)));else if("if"===e[r].type)e[r].statement&&"script"===e[r].statement.type&&(n.push.apply(n,e[r].statement.statements),t&&n.push.apply(n,Eden.Selectors.getChildren(e[r].statement.statements,t))),e[r].elsestatement&&"script"===e[r].elsestatement.type&&(n.push.apply(n,e[r].elsestatement.statements),t&&n.push.apply(n,Eden.Selectors.getChildren(e[r].elsestatement.statements,t)));else if("when"===e[r].type)e[r].statement&&"script"==e[r].statement.type&&(n.push.apply(n,e[r].statement.statements),t&&n.push.apply(n,Eden.Selectors.getChildren(e[r].statement.statements,t)));else if("while"===e[r].type)e[r].statement&&"script"==e[r].statement.type&&(n.push.apply(n,e[r].statement.statements),t&&n.push.apply(n,Eden.Selectors.getChildren(e[r].statement.statements,t)));else if("do"===e[r].type)e[r].script&&"script"==e[r].script.type&&(n.push.apply(n,e[r].script.statements),t&&n.push.apply(n,Eden.Selectors.getChildren(e[r].script.statements,t)));else if("section"===e[r].type){for(var i=e[r].nextSibling,s=[];i&&("section"!=i.type||i.depth>e[r].depth);)"dummy"!=i.type&&(n.push(i),s.push(i)),i=i.nextSibling;t&&n.push.apply(n,Eden.Selectors.getChildren(s,t))}return n=n.filter(function(e){return"dummy"!=e.type})},Eden.Selectors.allowedOptions={external:!0,local:!0,history:!0,all:!0,indexed:!0,index:!0,nosort:!0,remote:!0,depend:!0},Eden.Selectors.resultTypes={brief:!0,comment:!0,source:!0,innersource:!0,outersource:!0,standalone_outersource:!0,title:!0,path:!0,name:!0,symbol:!0,line:!0,depends:!0,value:!0,tags:!0,rawcomment:!0,id:!0,remote:!0,root:!0,enabled:!0,executed:!0,exprtree:!0,single:!0,expression:!0,locked:!0,ast:!0,static:!0,volatile:!0,eager:!0,number:!0,string:!0,object:!0,list:!0,boolean:!0,datatype:!0},Eden.Selectors.expressionToLists=function(e){switch(e.type){case"binaryop":return[e.op,Eden.Selectors.expressionToLists(e.l),Eden.Selectors.expressionToLists(e.r)];case"ternaryop":return["eif",Eden.Selectors.expressionToLists(e.first),Eden.Selectors.expressionToLists(e.condition),Eden.Selectors.expressionToLists(e.second)];case"unaryop":return[e.op,Eden.Selectors.expressionToLists(e.r)];case"length":return["#",Eden.Selectors.expressionToLists(e.l)];case"index":return Eden.Selectors.expressionToLists(e.expression);case"async":return["sync",Eden.Selectors.expressionToLists(e.expression)];case"query":return["query",Eden.Selectors.expressionToLists(e.selector),e.restypes]}if(console.log(e),"functioncall"==e.type){console.log("FUNCCALL");for(var t=[],n=0;n<e.params.length;n++)t.push(Eden.Selectors.expressionToLists(e.params[n]));return["(",t,")"]}if("literal"==e.type)switch(e.datatype){case"NUMBER":case"STRING":case"BOOLEAN":return["literal",e.value];case"LIST":for(t=[],n=0;n<e.value.length;n++)t.push(Eden.Selectors.expressionToLists(e.value[n]));return["literal",t]}else{if("primary"==e.type){if(0==e.extras.length)return e.observable;for(var r=[e.observable],n=0;n<e.extras.length;n++)r.push(Eden.Selectors.expressionToLists(e.extras[n]));return r}if("indexed"==e.type){(r=["indexed"]).push(Eden.Selectors.expressionToLists(e.expression));for(n=0;n<e.indexes.length;n++)r.push(Eden.Selectors.expressionToLists(e.indexes[n]));return r}}},Eden.Selectors.listsToExpression=function(e){if(!Array.isArray(e))return e;for(var t=[],n=0;n<e.length;n++)t.push(Eden.Selectors.listsToExpression(e[n]));return"("+t.join(" ")+")"},Eden.Selectors.processResults=function(e,t){if(t){for(var n=Array.isArray(t)?t:t.split(","),r=[],i=!1,s=0;s<e.length;s++){for(var o=e[s],a=[],d=0;d<n.length;d++){var c,h=void 0;switch(n[d]){case"ast":h=o;break;case"single":i=!0;break;case"brief":o.doxyComment&&(h=o.doxyComment.brief());break;case"comment":o.doxyComment&&(h=o.doxyComment.stripped());break;case"standalone_outersource":o?(h=1===o.version?'"use cs2;"\n':'"use cs3;"\n',h+=o.getOuterSource()):h="";break;case"source":h=o&&o.getSource?o.getSource():"";break;case"innersource":"script"==o.type?h=o.getInnerSource():"custom"==o.type?h=o.text:o&&o.getSource&&(h=o.getSource());break;case"outersource":h=o.getOuterSource();break;case"exprtree":o.expression&&(h=Eden.Selectors.expressionToLists(o.expression));break;case"expression":o.expression&&o.lvalue&&o.lvalue.source&&(h=o.getSource().substr(o.lvalue.source.length).trim(),"definition"==o.type?h=h.substring(2,h.length-1).trim():"assignment"==o.type&&(h=h.substr(1,h.length-1).trim()));break;case"title":o.base&&o.base.mainDoxyComment&&(o.base.mainDoxyComment.stripped(),(c=o.base.mainDoxyComment.getControls())&&c["@title"]&&(h=c["@title"][0]));break;case"type":h=o.type;break;case"locked":h=!!o.lock;break;case"name":o.lvalue&&o.lvalue.name?h=o.lvalue.name:o.name&&"do"!=o.type?h=o.name:void 0===o.parent&&o.base&&o.base.origin?h=o.base.origin.name:void 0!==o.path&&(h=o.path);break;case"symbol":o.lvalue&&o.lvalue.name&&(h=o.lvalue.name);break;case"line":void 0!==o.line&&(h=o.line);break;case"depends":h=o.dependencies?Object.keys(o.dependencies):[];break;case"value":if(o instanceof l)h=o.value();else try{h=o.expression?o.expression.execute({scopes:[]},eden.project.ast,eden.root.scope):void 0}catch(e){}break;case"active":h="when"==o.type&&o.enabled||o.lvalue&&eden.root.symbols[o.lvalue.name]&&eden.root.symbols[o.lvalue.name].origin&&eden.root.symbols[o.lvalue.name].origin.id==o.id;break;case"executed":h=0<o.executed;break;case"historic":h=-1==o.executed;break;case"tags":o.doxyComment&&(h=o.doxyComment.getHashTags());break;case"rawcomment":o.doxyComment&&(h=o.doxyComment.content);break;case"controls":case"id":h=o.id;break;case"path":h=Eden.Selectors.getID(o);break;case"remote":for(var p=o;p.parent;)p=p.parent;if(!p.base||!p.base.origin){h=!1;break}h=p.base.origin.remote;break;case"root":h=void 0===o.parent;break;case"static":h=!!(o instanceof l&&o.origin)&&o.origin.lvalue.isstatic}a.push(h)}1<a.length?r.push(a):1==a.length&&void 0!==a[0]&&r.push(a[0])}return i?r[0]:r}return e},Eden.Selectors.outerBracket=function(e){for(var t=0,n=0;n<e.length;n++)if("("==e.charAt(n))t++;else if(")"==e.charAt(n)&&0==--t)return n;return e.length},Eden.Selectors.makeRegex=function(e){return e="/"==e.charAt(0)?"/"==e.charAt(e.length-1)?e.substring(1,e.length-1):e.substring(1):"^"+e.replace(/([\\+^$.|(){[])/g,"\\$1").replace(/([*?])/g,".$1")+"$",new RegExp(e)},Eden.Selectors.SortNode=function(){this.type="sort",this.query=void 0},Eden.Selectors.DotNode=function(e){this.type="dot",this.label=e},Eden.Selectors.parse=function(e,t){var n=t;if(e&&""!=e){for(e=e.trim();0<e.length&&"@"==e.charAt(0);){var n=n||{},r=(e=e.substring(1)).search(/[^a-z]+/);-1==r&&(r=e.length);var i=e.substring(0,r);e=e.substring(r).trim(),n[i]=!0}return Eden.Selectors._parse(e,n)}},Eden.Selectors._parse=function(e,t){if(e&&""!=e){if(">"==e.charAt(0))e=">"==e.charAt(1)?(r=new Eden.Selectors.NavigateNode(">",!0),e.substring(2).trim()):(r=new Eden.Selectors.NavigateNode(">",!1),e.substring(1).trim());else if("<"==e.charAt(0))e="<"==e.charAt(1)?(r=new Eden.Selectors.NavigateNode("<",!0),e.substring(2).trim()):(r=new Eden.Selectors.NavigateNode("<",!1),e.substring(1).trim());else if(","==e.charAt(0))r=new Eden.Selectors.UnionNode,e=e.substring(1).trim();else if(":"==e.charAt(0)||"."==e.charAt(0)){-1==(c=(a=e.substring(1)).search(/[^a-zA-Z0-9\-]/))?c=e.length:c++;var n,r,i=e.substring(0,c),s=void 0;e=c<e.length&&"("==e.charAt(c)?(o=Eden.Selectors.outerBracket(e),s=e.substring(c+1,o),e.substring(o+1).trim()):e.substring(c).trim(),r=i.charAt(1).match(/[0-9]+/)?(n=parseInt(i.substring(1)),new Eden.Selectors.PropertyNode(n)):new Eden.Selectors.PropertyNode(i,s)}else if("^"==e.charAt(0)){-1==(c=(a=e.substring(1)).search(/[^a-zA-Z0-9\-]/))&&(c=a.length);var o,i=a.substring(0,c),s=void 0;a=c<a.length&&"("==a.charAt(c)?(o=Eden.Selectors.outerBracket(a),s=a.substring(c+1,o),a.substring(o+1).trim()):a.substring(c),(r=new Eden.Selectors.SortNode).addSort(i),e=a.trim()}else if("#"==e.charAt(0)){var a=e.match(/#[a-zA-Z0-9_*?]+/);if(null===a)return;a=a[0],r=new Eden.Selectors.TagNode(a),e=e.substring(a.length).trim()}else if(e.charAt(0).match(/[a-zA-Z*?]+/)){-1==(c=e.search(/[^a-zA-Z0-9_*?\s]+/))&&(c=e.length);var d=e.substring(0,c).trim();r=new Eden.Selectors.NameNode(d),e=e.substring(c).trim()}else if("/"==e.charAt(0)){for(var c=-1,h=1;h<e.length;h++){if("/"==e.charAt(h)){c=h+1;break}"\\"==e.charAt(h)&&h++}-1==c&&(c=e.length);d=e.substring(0,c).trim();r=new Eden.Selectors.NameNode(d),e=e.substring(c).trim()}else e="";d=Eden.Selectors._parse(e,t);if(r)return r.options=t,r.append(d)}},Eden.Selectors.unique=function(e){for(var t={},n=0;n<e.length;n++)void 0!==e[n]&&(t[e[n].id]=e[n]);var r,i=[];for(r in t)i.push(t[r]);return i},Eden.Selectors.sort=function(e){return e.sort(function(e,t){return t.stamp-e.stamp})},Eden.Selectors._depend=function(e){return this.options&&this.options.depend&&this.options.self&&this.options.self instanceof l?e.then(e=>{for(var t of e)t.addSubscriber&&this.options.self.subscribeDynamicSym(t);return e}):e},Eden.Selectors.queryWithinSync=function(e,t,n,r){t=Eden.Selectors.parse(t,r?r.options:null),r=[];if(!t)return r;e=t._filter(e);return e?(e=Eden.Selectors.unique(e),r=n?Eden.Selectors.processResults(e,n):e):[]},Eden.Selectors.queryWithin=function(e,t,n,r){r||console.error("QUERY WITHIN WITHOUT CB");var t=Eden.Selectors.parse(t),i=[];return t&&t.filter(e).then(e=>{e=Eden.Selectors.unique(e);i=n?Eden.Selectors.processResults(e,n):e,r&&r(i)}),i},Eden.Selectors.query=function(e,n,t,r){if(!r)return[];Eden.Selectors._query(e,n,t,(e,t)=>{r(t?e:Eden.Selectors.processResults(e,n))})},Eden.Selectors._query=function(s,o,e,a){var t,d,c=[];if(a||console.warn("Selector query without callback: ",s),e&&(t=e.context,d=e.minimum),"boolean"==typeof d&&console.trace("Bool"),"string"!=typeof s||""==s){var n=[];return console.log("Invalid selector"),a&&a(n,!0),n}var h=Eden.Selectors.parse(s.trim(),e?e.options:void 0);if(void 0===h)return console.log("Selector parse error"),a&&a([],!0),[];var r=e=>{if(c=e,h.options&&h.options.remote||(h.options&&h.options.all||(c=Eden.Selectors.unique(c)),h.options&&h.options.nosort||(c=Eden.Selectors.sort(c))),0==h.local&&a&&(void 0===d||c.length<d)){e=s.search(/[\s\.\:\#\@\>]/);-1==e&&(e=s.length);var t=s.substring(0,e).trim();if(t.startsWith("plugins")){for(var n=s.split(">"),r="",i=0;i<n.length;i++)n[i]=n[i].trim(),r+=n[i],i<n.length-1&&(r+="/");Eden.Utils.getURL(r+".js-e").then(function(e){e=[new Eden.AST(e,void 0,{name:n[n.length-1],remote:!0}).script];Eden.Selectors.cache[s]=e[0],a(e)}).catch(e=>{a([])})}else h.options&&h.options.local||!Eden.DB?Eden.Project.local&&Eden.Project.local[t]?Eden.Utils.getURL(Eden.Project.local[t].file).then(function(e){e=[new Eden.AST(e,void 0,{name:t,remote:!0}).script];Eden.Selectors.cache[t]=e[0],c=e,h.filter(e).then(e=>{e=Eden.Selectors.unique(e);a(e)})}):a(c):Eden.DB.searchSelector(s,void 0===o?["standalone_outersource","path"]:o,function(i){if(void 0===o&&0<i.length){let r=t=>{var n,e;t<i.length?(n=Eden.AST.parseStatement(i[t][0],{remote:!0,version:0}),(e=Eden.AST.originFromDoxy(n.doxyComment)).remote=!0,n.base.origin=e,n.id=e.id,Eden.Selectors.queryWithin([n],i[t][1],null,e=>{e=e[0];e&&(c.push(e),h.options&&h.options.index&&n.addIndex()),r(++t)})):a(c)};r(0)}else void 0===i||0==i.length?Eden.Project.local&&Eden.Project.local[t]?Eden.Utils.getURL(Eden.Project.local[t].file).then(function(e){e=[new Eden.AST(e,void 0,{name:t,remote:!0}).script];Eden.Selectors.cache[t]=e[0],h.filter(e).then(e=>{e=Eden.Selectors.unique(e);a(e)})}):a(c):(c.push.apply(c,i),a(c,!0))})}else a(c)};return h.options&&h.options.remote?r([]):!t||"script"!=t.type||h.options&&h.options.indexed?h.filter().then(e=>{r(e)}):h.filter(t.statements).then(e=>{e&&0!=e.length?r(e):h.filter().then(e=>{r(e)})}),e?e.returnvalue:void 0},Eden.Selectors.queryPromise=function(n,r,i){return new Promise((t,e)=>{Eden.Selectors.query(n,r,i,e=>{t(e)})})},Eden.Selectors.execute=function(e,i,s){Eden.Selectors.query(e,void 0,{minimum:1},function(r){r&&0<r.length?function e(t){for(var n=r[t];n.parent;)n=n.parent;n.base.executeStatement(r[t],i,l.localJSAgent,function(){++t<r.length?e(t):s&&s()})}(0):s&&s()})},Eden.Selectors.goto=function(d){Eden.Selectors.query(d,void 0,{minimum:1,noindex:!1},function(e){if(0==e.length)return!1;for(var t=[e[0]],n=e[0];n.parent;)t.push(n.parent),n=n.parent;for(var r=!1,i=0;i<t.length;i++)if(Eden.Fragment.emit("goto",[t[i],e[0]])){r=!0;break}if(!r){for(var s in console.log("No Goto Match, create view",d,e[0]),edenUI.activeDialogs)if("ScriptInput"==edenUI.activeDialogs[s]){var o=eden.root.lookup("view_"+s+"_tabs").value(),a="script"==e[0].type?d:Eden.Selectors.getID(e[0].parent);o.push(a),eden.root.lookup("view_"+s+"_tabs").assign(o,eden.root.scope,l.localJSAgent),Eden.Fragment.emit("goto",[void 0,e[0]]),eden.root.lookup("view_"+s+"_current").assign(o.length-1,eden.root.scope,l.localJSAgent),r=!0;break}r||(edenUI.createView("gotoscript","ScriptInput"),o=[a="script"==e[0].type?d:Eden.Selectors.getID(e[0].parent)],eden.root.lookup("view_gotoscript_tabs").assign(o,eden.root.scope,l.localJSAgent),eden.root.lookup("view_gotoscript_current").assign(0,eden.root.scope,l.localJSAgent),r=!0)}return r})},Eden.Selectors.assign=function(e,c,h,t,p){Eden.Selectors.query(e,void 0,{minimum:1,noindex:!0,options:{self:t}},function(e){var t="string"==typeof c?c.split(","):c,n=Array.isArray(h)?h:[h];if(n.length<t.length)return console.error("Not enough values"),void(p&&p([]));for(var r=0;r<e.length;r++)for(var i=0;i<t.length;i++)switch(t[i]){case"source":if(e[r].parent){var s=e[r].parent;for("string"==typeof n[i]?(o=Eden.AST.parseStatement(n[i]),e[r].parent.replaceChild(e[r],o)):void 0===n[i]&&e[r].parent.removeChild(e[r]);s;)Eden.Fragment.emit("patch",[void 0,s]),s=s.parent}else console.error("Cannot replace outer source of root script");break;case"innersource":if("script"==e[r].type){var o=Eden.AST.parseScript(n[i]);e[r].patchInner(o);for(s=e[r];s;)Eden.Fragment.emit("patch",[void 0,s]),s=s.parent}else console.error("Cannot replace innersource of non-script node");break;case"expression":if("definition"==e[r].type||"assignment"==e[r].type){o=Eden.AST.parseExpression(n[i]);e[r].expression=o,e[r].reset(),e[r].source=e[r].lvalue.source+("definition"==e[r].type?" is ":" = ")+n[i]+";";for(s=e[r];s;)Eden.Fragment.emit("patch",[void 0,s]),s=s.parent}else console.error("Cannot replace expression");break;case"locked":"script"==e[r].type?n[i]?0==e[r].lock&&(e[r].lock=1,Eden.Fragment.emit("lock",[void 0,e[r]])):(e[r].lock=0,Eden.Fragment.emit("unlock",[void 0,e[r]])):console.error("Cannot replace expression");break;case"title":case"comment":case"rawcomment":var a=new Eden.AST.DoxyComment(n[i],0,0),d=new Eden.AST.DummyStatement;d.setSource(0,0,"#! "+n[i].trim().replace(/\n/g,"\n# ")+"\n"),e[r].doxyComment?e[r].parent.replaceChild(e[r].previousSibling,d):e[r].parent.insertBefore(e[r],d),Eden.Index.remove(e[r]),e[r].setDoxyComment(a),Eden.Index.update(e[r]);break;case"tags":case"executed":break;case"enabled":"when"==e[r].type&&(e[r].enabled&&!n[i]?(eden.project.removeAgent(e[r]),e[r].enabled=!1):!e[r].enabled&&n[i]&&(eden.project.registerAgent(e[r]),e[r].enabled=!0));break;case"name":"script"==e[r].type?(Eden.Index.remove(e[r]),e[r].prefix="action "+n[i]+" {",e[r].name=n[i],Eden.Index.update(e[r])):"assignment"!=e[r].type&&"definition"!=e[r].type||(Eden.Index.remove(e[r]),e[r].lvalue.name=n[i],e[r].source=e[r].source.replace(/\w*/,n[i]),Eden.Index.update(e[r]));break;default:console.error("Cannot modify property '"+t[i]+"'")}p&&p(e)})},Eden.Selectors.append=function(e,c,h,t,p){Eden.Selectors.query(e,void 0,{minimum:1,noindex:!0,options:{self:t}},function(e){var t="string"==typeof c?c.split(","):c,n=Array.isArray(h)?h:[h];if(n.length<t.length)return console.error("Not enough values"),void(p&&p([]));for(var r=0;r<e.length;r++)for(var i=0;i<t.length;i++)switch(t[i]){case"source":if(e[r].parent){var s=e[r].parent;for("string"==typeof n[i]?(o=Eden.AST.parseStatement(n[i]),e[r].parent.insertBefore(e[r],o)):n[i];s;)Eden.Fragment.emit("patch",[void 0,s]),s=s.parent}else console.error("Cannot replace outer source of root script");break;case"innersource":if("script"==e[r].type){for(var o=Eden.AST.parseScript(n[i]),a=0;a<o.statements.length;a++)e[r].appendChild(o.statements[a]);for(s=e[r];s;)Eden.Fragment.emit("patch",[void 0,s]),s=s.parent}else console.error("Cannot replace innersource of non-script node");break;case"title":case"comment":case"rawcomment":var d=new Eden.AST.DoxyComment(n[i],0,0);e[r].doxyComment=d;d=new Eden.AST.DummyStatement;d.setSource(n[i],0,0),e[r].parent.insertBefore(e[r],d);break;case"tags":case"name":"script"==e[r].type&&(Eden.Index.remove(e[r]),e[r].prefix="action "+n[i]+" {",e[r].name=n[i],Eden.Index.update(e[r]));break;default:console.error("Cannot modify property '"+t[i]+"'")}p&&p(e)})},"undefined"!=typeof require&&"undefined"!=typeof exports&&(require("./property"),require("./navigate"),require("./name"),require("./tag"),require("./union"),require("./intersection"))}(),Eden.Selectors.PropertyNode=function(e,t){if(this.type="property",this.name=e,this.param=t,this.compare=void 0,this.value=t,this.range=!1,this.isreg=!!t&&-1!=t.indexOf("*"),this.meta="string"==typeof e?("."==e.charAt(0)?Eden.Selectors.PropertyNode.attributes:Eden.Selectors.PropertyNode.pseudo)[e.substring(1)]:void 0,this.local=!!this.meta&&this.meta.local,t){switch(t.charAt(0)){case"<":this.compare="="==t.charAt(1)?"<=":"<";break;case">":this.compare="="==t.charAt(1)?">=":">";break;case"=":this.compare="=";break;case"!":this.compare="!="}if(this.compare)switch(this.compare){case"!":case"=":case">":case"<":this.value=t.substring(1);break;case">=":case"<=":this.value=t.substring(2)}if(this.isreg?this.value=Eden.Selectors.makeRegex(this.value):null!==t.match(/^[0-9]+\-[0-9]+$/)?this.range=!0:null!==t.match(/^[0-9]+$/)&&(this.value=parseInt(t)),".type"==this.name){switch(this.param){case"is":this.param="definition";break;case"assign":case"=":this.param="assignment";break;case"call":this.param="functioncall";break;case"proc":this.param="action";break;case"action":this.param="script";break;case"+=":case"-=":case"*=":case"/=":case"++":case"--":this.param="modify"}this.value=this.param}}},Eden.Selectors.PropertyNode.attributes={name:{local:!1,indexed:!0,rank:1},type:{local:!1,indexed:!1,rank:3},datatype:{local:!1,indexed:!1,rank:30},id:{local:!1,indexed:!0,rank:2},lines:{local:!1,indexed:!1,rank:3},depends:{local:!1,indexed:!1,rank:4},determines:{local:!1,indexed:!1,rank:4},time:{local:!0,indexed:!1,rank:3},date:{local:!1,indexed:!1,rank:3},locked:{local:!0,indexed:!1,rank:3},title:{local:!1,indexed:!1,rank:10},warning:{local:!1,indexed:!1,rank:10},author:{local:!1,indexed:!1,rank:10},v:{local:!1,indexed:!1,rank:20},vid:{local:!1,indexed:!1,rank:20},version:{local:!1,indexed:!1,rank:20},source:{local:!0,indexed:!1,rank:50},comment:{local:!0,indexed:!1,rank:50}},Eden.Selectors.PropertyNode.pseudo={line:{local:!1,indexed:!1,rank:50},determines:{local:!0,indexed:!0,rank:10},depends:{local:!0,indexed:!0,rank:10},first:{local:!1,indexed:!0,rank:5},last:{local:!1,indexed:!0,rank:5},unexecuted:{local:!0,indexed:!1,rank:3},executed:{local:!0,indexed:!1,rank:3},root:{local:!1,indexed:!0,rank:3},project:{local:!0,indexed:!0,rank:3},nth:{local:!1,indexed:!0,rank:5},value:{local:!0,indexed:!1,rank:50},matches:{local:!1,indexed:!1,rank:100},age:{local:!1,indexed:!1,rank:6},remote:{local:!0,indexed:!0,rank:20},not:{local:!1,indexed:!1,rank:100},active:{local:!0,indexed:!1,rank:10},me:{local:!1,indexed:!1,rank:20},listed:{local:!1,indexed:!1,rank:20},prev:{local:!0,indexed:!1,rank:20},next:{local:!0,indexed:!1,rank:20},this:{local:!0,indexed:!1,rank:20}},Eden.Selectors.PropertyNode.prototype.append=function(e){if(!e)return this;switch(e.type){case"property":case"tag":case"name":var t=new Eden.Selectors.IntersectionNode(this,e);return t.options=this.options,t;case"union":case"intersection":case"navigate":return e.prepend(this),e}return this},Eden.Selectors.PropertyNode.prototype.prepend=function(e){if(!e)return this;switch(e.type){case"property":case"tag":case"name":var t=new Eden.Selectors.IntersectionNode(e,this);return t.options=this.options,t;case"union":case"intersection":case"navigate":return e.append(this),e}return this},Eden.Selectors.PropertyNode.prototype.depend=Eden.Selectors._depend,Eden.Selectors.PropertyNode.prototype.filter=function(n){return n?this.depend(new Promise((e,t)=>{e(this._filter(n))})):this.depend(this.construct())},Eden.Selectors.PropertyNode.prototype._indirectSubFilter=function(e,t){var n=eden.root.lookup(t).indirectSubscribers();return e.filter(function(e){e=e.lvalue&&e.lvalue.name?e.lvalue.name:e.name||void 0;return e&&n.hasOwnProperty(e)})},Eden.Selectors.PropertyNode.prototype._indirectDepFilter=function(e,t){var n=eden.root.lookup(t).indirectDependencies();return e.filter(function(e){e=e.lvalue&&e.lvalue.name?e.lvalue.name:e.name||void 0;return e&&n.hasOwnProperty(e)})},Eden.Selectors.PropertyNode.prototype._filter=function(e){var t=this,n=this.value,r=this.name;if(!e)return this._construct();if("number"==typeof this.name)e&&e.length>=this.name?resolve([e[this.name-1]]):resolve([]);else switch(r){case".name":if(!n)return e.filter(function(e){return void 0!==e.lvalue||void 0!==e.name});var i=edenUI.regExpFromStr(n);return e.filter(function(e){return e.lvalue&&i.test(e.lvalue.name)||e.name&&i.test(e.name)});case".id":return e.filter(function(e){return 0==e.id&&e.buildID(),void 0===e.parent&&e.base&&e.base.origin&&e.base.origin.id?e.base.origin.id==n:e.id==n});case".type":if(!n)break;return e.filter(function(e){return e.type==n});case".warning":return e.filter(function(e){return e.warning});case".locked":return e.filter(function(e){return 0<e.lock});case".datatype":return e.filter(function(e){return e.expression&&Eden.Selectors.testType(e.expression)==n||e.expression&&"scope"==e.expression.type&&e.expression.range&&"list"==n});case".lines":case":line":return e;case".op":case".operator":case":pattern":return e;case".depends":return e.filter(function(e){return("definition"==e.type||"when"==e.type)&&(e.dependencies[n]||e.dynamicDependencies&&e.dynamicDependencies[n])});case".determines":return e.filter(function(e){return e instanceof EdenSymbol&&e.subscribers[n]});case":depends":return this._indirectSubFilter(e,n);case":determines":return this._indirectDepFilter(e,n);case":active":return e.filter(function(e){if("definition"!=e.type&&"assignment"!=e.type)return"when"==e.type&&e.enabled;var t=eden.root.symbols[e.lvalue.name];return t&&(t.origin===e||t.origin&&t.origin.id==e.id)});case":first":return 0<e.length?[e[0]]:[];case":last":return 0<e.length?[e[e.length-1]]:[];case":unexecuted":return e.filter(function(e){return 0==e.executed});case":executed":return e.filter(function(e){return 1==e.executed});case":root":return e.filter(function(e){return void 0===e.parent});case":project":return[eden.project.ast.script];case":nth":return e.filter(function(e){return e.parent&&Eden.Selectors.getChildren([e.parent],!1)[t.value-1]===e});case":prev":return e.map(function(e){let t=e.previousSibling;for(;t&&"dummy"==t.type;)t=t.previousSibling;return t});case":next":return e.map(function(e){let t=e.nextSibling;for(;t&&"dummy"==t.type;)t=t.nextSibling;return t});case":value":return e;case":":case":matches":var s=Eden.Selectors.parse(this.param);return s?s._filter(e):[];case".title":return this.isreg?e.filter(function(e){if(!e.doxyComment)return!1;e=e.doxyComment.getProperty("title");return e&&t.value.test(e)}):e.filter(function(e){if(!e.doxyComment)return!1;e=e.doxyComment.getProperty("title");return e&&e==t.value});case".author":return e;case".v":case".vid":case".version":return e;case".source":return this.isreg?e.filter(function(e){return t.value.test(e.getSource())}):e.filter(function(e){return e.getSource()==t.value});case".comment":return this.isreg?e.filter(function(e){return e.doxyComment&&t.value.test(e.doxyComment.stripped())}):e.filter(function(e){return e.doxyComment&&e.doxyComment.stripped()==t.value});case":age":var o=generateTimeStamp(this.value),s=Date.now(),a=s-o;return console.log("AGE",o,s,a),void 0===this.compare||"<"==this.compare?e.filter(function(e){return e.stamp>a}):e.filter(function(e){return e.stamp<a});case".time":case".date":return e;case":remote":return e.filter(function(e){for(var t=e;t.parent;)t=t.parent;return!(!t.base||!t.base.origin)&&1==t.base.origin.remote});case":not":if(this.param){var d=Eden.Selectors.parse(this.param)._filter(e);return e.filter(function(e){for(var t=0;t<d.length;t++)if(e===d[t])return!1;return!0})}default:return[]}},Eden.Selectors.PropertyNode.prototype._construct=function(){var e;switch(this.name){case".type":e=Eden.Index.getByType(this.value);break;case".id":e=Eden.Index.getByID(this.value);break;case".v":case".vid":case".version":e=[];break;case".name":e=void 0===this.param?Eden.Index.getAllWithName():this.isreg?Eden.Index.getByNameRegex(this.value):Eden.Index.getByName(this.value);break;case":root":e=[eden.project.ast.script].concat(Object.keys(Eden.Selectors.cache).map(function(e){return Eden.Selectors.cache[e]}));break;case":remote":e=Object.keys(Eden.Selectors.cache).map(function(e){return Eden.Selectors.cache[e]});break;case":project":e=[eden.project.ast.script];break;case":this":e=this.options&&this.options.self?[this.options.self]:[],console.log("THIS",this.options);break;case":prev":e=(e=this.options&&this.options.self?[this.options.self]:[]).map(e=>{let t=e.previousSibling;for(;t&&"dummy"==t.type;)t=t.previousSibling;return t});break;case":next":e=(e=this.options&&this.options.self?[this.options.self]:[]).map(e=>{let t=e.nextSibling;for(;t&&"dummy"==t.type;)t=t.nextSibling;return t});break;case":active":e=[eden.root];break;case":depends":e=Object.values(eden.root.lookup(this.value).indirectSubscribers());break;case":determines":e=Object.values(eden.root.lookup(this.value).indirectDependencies());break;case".determines":e=Object.values(eden.root.lookup(this.value).dependencies).concat(Object.values(eden.root.lookup(this.value).dynamicDependencies));break;case".depends":e=Object.values(eden.root.lookup(this.value).subscribers);break;default:e=this._filter(Eden.Index.getAll())}return e},Eden.Selectors.PropertyNode.prototype.construct=function(){var e=this._construct();return this.options&&this.options.history?Promise.resolve(e):Promise.resolve(e.filter(function(e){return 0<=e.executed}))},Eden.Selectors.NameNode=function(e){this.type="name",this.name=e,this.options=void 0,this.isreg="/"==e.charAt(0)||-1!=e.indexOf("*"),this.local=!1},Eden.Selectors.NameNode.prototype.depend=Eden.Selectors._depend,Eden.Selectors.NameNode.prototype.filter=function(e){return e?this.depend(Promise.resolve(this._filter(e))):this.depend(this.construct())},Eden.Selectors.NameNode.prototype._filter=function(e){var t=this.name;if(!e)return this._construct();if(this.isreg){var n=Eden.Selectors.makeRegex(this.name);return e.filter(function(e){return e.lvalue&&n.test(e.lvalue.name)||e.name&&n.test(e.name)})}return e.filter(function(e){return e.lvalue&&e.lvalue.name==t||e.name&&e.name==t})},Eden.Selectors.NameNode.prototype._construct=function(){var e=[];if(this.isreg)var t=Eden.Selectors.makeRegex(this.name),e=Eden.Index.getByNameRegex(t);else{e=Eden.Index.getByName(this.name);for(var n=this.name.toLowerCase().split(" "),r=Eden.Index.getByTag("#"+n[0]),i=1;i<n.length;i++)r=r.filter(function(e){return(!eden.project||e!==eden.project.ast.script)&&e.doxyComment&&e.doxyComment.hasTag("#"+n[i])});e.push.apply(e,r)}return e},Eden.Selectors.NameNode.prototype.construct=function(){let e=this._construct();return this.options&&this.options.history?Promise.resolve(e):Promise.resolve(e.filter(function(e){return 0<=e.executed}))},Eden.Selectors.NameNode.prototype.append=Eden.Selectors.PropertyNode.prototype.append,Eden.Selectors.NameNode.prototype.prepend=Eden.Selectors.PropertyNode.prototype.prepend,Eden.Selectors.TagNode=function(e){this.type="tag",this.tag=e,this.options=void 0,this.isreg=-1!=e.indexOf("*"),this.local=!1},Eden.Selectors.TagNode.prototype.filter=function(n){return new Promise((t,e)=>{n?t(this._filter(n)):n=this.construct().then(e=>{t(e)})})},Eden.Selectors.TagNode.prototype._filter=function(e){var t=this;return e.filter(function(e){return e.doxyComment&&e.doxyComment.hasTag(t.tag)})},Eden.Selectors.TagNode.prototype.construct=function(){return new Promise((e,t)=>{var n;stats=this.isreg?(n=Eden.Selectors.makeRegex(this.tag),Eden.Index.getByTagRegex(n)):Eden.Index.getByTag(this.tag),this.options&&this.options.history?e(stats):e(stats.filter(function(e){return 0<=e.executed}))})},Eden.Selectors.TagNode.prototype.append=Eden.Selectors.PropertyNode.prototype.append,Eden.Selectors.TagNode.prototype.prepend=Eden.Selectors.PropertyNode.prototype.prepend,Eden.Selectors.IntersectionNode=function(e,t){this.type="intersection",this.children=[e,t],this.local=!1},Eden.Selectors.IntersectionNode.prototype.append=function(e){return e?(e.local&&(this.local=!0),"navigate"===e.type?(e.prepend(this),e):(this.children.push(e),this)):this},Eden.Selectors.IntersectionNode.prototype.prepend=function(e){return e&&(e.local&&(this.local=!0),this.children.splice(0,0,e)),this},Eden.Selectors.IntersectionNode.prototype._filter=function(e,t){let n=e;for(var r=0;r<this.children.length;++r)n=this.children[r]._filter(n,t);return n},Eden.Selectors.IntersectionNode.prototype.filter=function(t,i){return new Promise((n,e)=>{let r=(t,e)=>{t<this.children.length?this.children[t].filter(e,i).then(e=>{r(++t,e)}):n(e||[])};r(0,t)})},Eden.Selectors.IntersectionNode.prototype.construct=function(){},Eden.Selectors.UnionNode=function(){this.type="union",this.children=[void 0],this.local=!1},Eden.Selectors.UnionNode.prototype._filter=function(e,t){for(var n={},r=0;r<this.children.length;++r)for(var i=this.children[r]._filter(e,t),s=0;s<i.length;s++)n[i[s].id]=i[s];return Object.keys(n).map(function(e){return n[e]})},Eden.Selectors.UnionNode.prototype.filter=function(s,o){return new Promise((e,t)=>{var r={};let i=n=>{n<this.children.length?this.children[n].filter(s,o).then(e=>{for(var t=0;t<e.length;t++)r[e[t].id]=e[t];i(++n)}):e(Object.keys(r).map(function(e){return r[e]}))};i(0)})},Eden.Selectors.UnionNode.prototype.construct=function(){},Eden.Selectors.UnionNode.prototype.prepend=function(e){return e&&(e.local&&(this.local=!0),void 0===this.children[0]?this.children[0]=e:this.children[0]=this.children[0].prepend(e)),this},Eden.Selectors.UnionNode.prototype.append=function(e){return e&&(e.local&&(this.local=!0),this.children.push(e)),this},Eden.Selectors.NavigateNode=function(e,t){this.type="navigate",this.left=void 0,this.right=void 0,this.direction=e,this.deep=t,this.local=!1},Eden.Selectors.NavigateNode.prototype.append=function(e){return e?(e.local&&(this.local=!0),"union"==e.type?(e.prepend(this),e):(this.right?this.right.append(e):this.right=e,this)):this},Eden.Selectors.NavigateNode.prototype.prepend=function(e){return e&&(e.local&&(this.local=!0),this.left?this.left=this.left.prepend(e):this.left=e),this},Eden.Selectors.NavigateNode.prototype.filter=function(r,s){return new Promise((i,e)=>{if(">"==this.direction){r||void 0!==this.left||(this.right?this.right.filter(r,s).then(e=>{i(e.filter(function(e){return void 0!==e.parent}))}):i(Eden.Index.getAll().filter(function(e){return void 0!==e.parent})));var t=e=>{this.right?this.right.filter(e,s).then(e=>{i(e)}):i(e)};void 0===this.left?t(Eden.Selectors.getChildren(r,this.deep)):this.left.filter(r,s).then(e=>{t(Eden.Selectors.getChildren(e,this.deep))})}else if("<"==this.direction){if(!r&&void 0===this.left){if(this.right)return this.right.filter(r,s).then(e=>{i(e.filter(function(e){return"script"==e.type||"when"==e.type||"if"==e.type||"for"==e.type}))});i(Eden.Index.getAll().filter(function(e){return"script"==e.type||"when"==e.type||"if"==e.type||"for"==e.type}))}var n=e=>{if(this.deep){for(var t=[],n=0;n<e.length;n++)for(var r=e[n];r.parent;)r=("script"==r.parent.type&&r.parent.parent&&"script"!=r.parent.parent.type?("codeblock"==r.parent.parent.type?r.parent:r).parent:"codeblock"==r.parent.type?r.parent:r).parent,t.push(r);this.right?this.right.filter(t,s).then(e=>{i(Eden.Selectors.unique(e))}):i(Eden.Selectors.unique(t))}else{for(t=[],n=0;n<e.length;n++)e[n].parent&&("script"==e[n].parent.type&&e[n].parent.parent&&"script"!=e[n].parent.parent.type?"codeblock"==e[n].parent.parent.type?t.push(e[n].parent.parent.parent):t.push(e[n].parent.parent):"codeblock"==e[n].parent.type?t.push(e[n].parent.parent):t.push(e[n].parent));this.right?this.right.filter(t,s).then(e=>{i(Eden.Selectors.unique(e))}):i(Eden.Selectors.unique(t))}};void 0===this.left?n(r.filter(function(e){return"script"==e.type||"when"==e.type||"if"==e.type||"for"==e.type})):this.left.filter(r,s).then(e=>{n(e)})}})},Eden.Selectors.NavigateNode.prototype._filter=function(e,i){if(">"==this.direction){if(!e&&void 0===this.left)return this.right?this.right._filter(e,i).filter(function(e){return void 0!==e.parent}):Eden.Index.getAll().filter(function(e){return void 0!==e.parent});var t=e=>this.right?this.right._filter(e,i):e;if(void 0===this.left)return t(Eden.Selectors.getChildren(e,this.deep));var n=this.left._filter(e,i);return t(Eden.Selectors.getChildren(n,this.deep))}if("<"==this.direction){if(!e&&void 0===this.left)return this.right?this.right._filter(e,i).filter(function(e){return"script"==e.type||"when"==e.type||"if"==e.type||"for"==e.type}):Eden.Index.getAll().filter(function(e){return"script"==e.type||"when"==e.type||"if"==e.type||"for"==e.type});n=e=>{if(this.deep){for(var t=[],n=0;n<e.length;n++)for(var r=e[n];r.parent;)r=("script"==r.parent.type&&r.parent.parent&&"script"!=r.parent.parent.type?("codeblock"==r.parent.parent.type?r.parent:r).parent:"codeblock"==r.parent.type?r.parent:r).parent,t.push(r);return this.right?Eden.Selectors.unique(this.right._filter(t,i)):Eden.Selectors.unique(t)}for(t=[],n=0;n<e.length;n++)e[n].parent&&("script"==e[n].parent.type&&e[n].parent.parent&&"script"!=e[n].parent.parent.type?"codeblock"==e[n].parent.parent.type?t.push(e[n].parent.parent.parent):t.push(e[n].parent.parent):"codeblock"==e[n].parent.type?t.push(e[n].parent.parent):t.push(e[n].parent));return this.right?Eden.Selectors.unique(this.right._filter(t,i)):Eden.Selectors.unique(t)};return void 0===this.left?n(e.filter(function(e){return"script"==e.type||"when"==e.type||"if"==e.type||"for"==e.type})):n(this.left._filter(e,i))}},Eden.Selectors.NavigateNode.prototype.construct=function(){return new Promise((e,t)=>{e([])})},Eden.SyntaxWarning=function(e,t,n,r){this.type="syntax",this.context=e,this.node=t,this.warnno=n,this.extra=r,this.token=e.token,this.prevtoken=e.previous,this.line=e.stream.prevline,this.position=e.stream.position,this.prevposition=e.stream.prevposition},Eden.SyntaxWarning.UNKNOWN=0,Eden.SyntaxWarning.DEPRECATED=1,Eden.SyntaxWarning.NESTEDWHEN=2,Eden.SyntaxWarning.DEFINWHEN=3,Eden.SyntaxWarning.EXPRESSIONLIT=4,Eden.SyntaxWarning.MISSINGSYNC=5,Eden.SyntaxWarning.NESTEDSCOPE=6,Eden.SyntaxWarning.USEOFWHILE=7,Eden.SyntaxWarning.prototype.messageText=function(){var e;switch(this.warnno){case Eden.SyntaxWarning.DEPRECATED:e="Deprecation: ";break;case Eden.SyntaxWarning.NESTEDWHEN:e='"when"\'s should not be nested';break;case Eden.SyntaxWarning.DEFINWHEN:e='"when"\'s should not contain definitions';break;case Eden.SyntaxWarning.EXPRESSIONLIT:e="Keep literals in separate observables";break;case Eden.SyntaxWarning.USEOFWHILE:e="Try and use 'for', 'when' or 'with' to achieve looping";break;default:e="Warning: "}return e+=this.extra},Eden.RuntimeWarning=function(e,t,n){this.type="runtime",this.node=e,this.warnno=t,this.extra=n,this.line=-1},Eden.RuntimeWarning.UNKNOWN=0,Eden.RuntimeWarning.EMPTYDO=1,Eden.RuntimeWarning.UNDEFINED=2,Eden.RuntimeWarning.AMBIGUITY=3,Eden.RuntimeWarning.prototype.messageText=function(){var e;switch(this.warnno){case Eden.RuntimeWarning.EMPTYDO:e="Empty result for: ";break;case Eden.RuntimeWarning.UNDEFINED:e="Expression is undefined: ";break;default:e="Warning: "}return void 0!==this.extra&&(e+=this.extra),e},Eden.TypeWarning=function(e,t,n){this.type="type",this.node=e,this.expected=t,this.got=n},Eden.TypeWarning.prototype.messageText=function(){function e(e){switch(e){case Eden.AST.TYPE_BOOLEAN:return"boolean";case Eden.AST.TYPE_STRING:return"string";case Eden.AST.TYPE_LIST:return"list";case Eden.AST.TYPE_OBJECT:return"object";case Eden.AST.TYPE_NUMBER:return"number";default:return"unknown"}}return this.got&&this.expected?`Expected type '${e(this.expected)}' but got '${e(this.got)}'`:this.expected?`Expected type '${e(this.expected)}'`:this.got?`Got unexpected type '${e(this.got)}'`:"Type mismatch"},Eden.Index={},Eden.Index.id_index={},Eden.Index.name_index={},Eden.Index.tag_index={},Eden.Index.type_index={},Eden.Index.idExists=function(e){return Eden.Index.id_index.hasOwnProperty(e)},Eden.Index.getByID=function(e){e=Eden.Index.id_index[e];return e||[]},Eden.Index.getAll=function(){var e=[];return Object.values?e.concat.apply(e,Object.values(Eden.Index.id_index)):e.concat.apply(e,Object.keys(Eden.Index.id_index).map(function(e){return Eden.Index.id_index[e]}))},Eden.Index.getAllWithName=function(){var e,t=[];for(e in Eden.Index.name_index)t.push.apply(t,Eden.Index.name_index[e].map(function(e){return Eden.Index.id_index[e]}));return t},Eden.Index.getByName=function(e){var t=[];return Eden.Index.name_index[e]?t.concat.apply(t,Eden.Index.name_index[e].map(function(e){return Eden.Index.id_index[e]})):t},Eden.Index.getByNameRegex=function(e){var t,n=[];for(t in Eden.Index.name_index)e.test(t)&&(n=n.concat.apply(n,Eden.Index.name_index[t].map(function(e){return Eden.Index.id_index[e]})));return n},Eden.Index.getByType=function(e){var t=[];return Eden.Index.type_index[e]?t.concat.apply(t,Object.keys(Eden.Index.type_index[e]).map(function(e){return Eden.Index.id_index[e]})):t},Eden.Index.getByTag=function(e){var t=[];return Eden.Index.tag_index[e]?t.concat.apply(t,Eden.Index.tag_index[e].map(function(e){return Eden.Index.id_index[e]})):t},Eden.Index.getByTagRegex=function(e){var t,n=[];for(t in Eden.Index.tag_index)e.test(t)&&(n=n.concat.apply(n,Eden.Index.tag_index[t].map(function(e){return Eden.Index.id_index[e]})));return n},Eden.Index.remove=function(e){var t=Eden.Index.id_index[e.id];if(t){for(var n=0;n<t.length;n++)t[n]===e&&t.splice(n,1);if(0==t.length){if(delete Eden.Index.id_index[e.id],delete Eden.Index.type_index[e.type][e.id],e.name&&"do"!=e.type||e.lvalue){var r=e.name||e.lvalue.name;if(void 0===Eden.Index.name_index[r])return;0<=(i=Eden.Index.name_index[r].indexOf(e.id))&&Eden.Index.name_index[r].splice(i,1)}if(e.tags)for(var i,s=e.tags,n=0;n<s.length;n++)void 0!==Eden.Index.tag_index[s[n]]&&0<=(i=Eden.Index.tag_index[s[n]].indexOf(e.id))&&Eden.Index.tag_index[s[n]].splice(i,1)}}},Eden.Index.update=function(e){var t;if((void 0===Eden.Index.id_index[e.id]&&(Eden.Index.id_index[e.id]=[]),Eden.Index.id_index[e.id].push(e),1==Eden.Index.id_index[e.id].length)&&(void 0===Eden.Index.type_index[e.type]&&(Eden.Index.type_index[e.type]={}),Eden.Index.type_index[e.type][e.id]=!0,(e.name&&"do"!=e.type||e.lvalue)&&(t=e.name||e.lvalue.name,void 0===Eden.Index.name_index[t]&&(Eden.Index.name_index[t]=[]),-1==Eden.Index.name_index[t].indexOf(e.id)&&Eden.Index.name_index[t].push(e.id)),e.tags))for(var n=e.tags,r=0;r<n.length;r++)void 0===Eden.Index.tag_index[n[r]]&&(Eden.Index.tag_index[n[r]]=[]),-1==Eden.Index.tag_index[n[r]].indexOf(e.id)&&Eden.Index.tag_index[n[r]].push(e.id)},Eden.AST=function(e,t,n,r){if(this.stream=void 0!==e?new Eden.EdenStream(e):void 0,this.data=new Eden.EdenSyntaxData,this.token="INVALID",this.previous="INVALID",this.src="input",this.parent=void 0,this.scripts={},this.definitions={},this.origin=n,this.lastposition=0,this.lastline=0,this.errors=[],this.warnings=[],this.whens=[],this.options=r,this.lastresult=void 0,this.depth=0,this.localStatus=!1,this.last_error=null,n||console.error("NO ORIGIN",e),this.lastDoxyComment=[],this.mainDoxyComment=void 0,this.parentDoxy=void 0,this.lastStatement=void 0,this.lastStatementEndline=-1,this.stream&&(this.stream.data=this.data),this.stamp=Date.now(),this.strict=r&&r.strict,this.version=Eden.AST.version,r&&void 0!==r.version&&(this.version=r.version),!r||!r.noparse){for(this.next();"STRING"===this.token;)r&&void 0!==r.version||("use cs2;"===this.data.value?this.version=Eden.AST.VERSION_CS2:"use cs3;"===this.data.value&&(this.version=Eden.AST.VERSION_CS3)),this.next();this.script=this.pSCRIPT(),(this.script.base=this).script.name=n.name,n.id&&(this.script.id=n.id),this.script.setSource(0,e.length,e),this.script.setDoxyComment(this.doxyFromOrigin()),this.options&&this.options.noindex?0==this.script.id&&this.script.buildID():this.script.addIndex(),0==this.errors.length?this.errors=this.script.errors:this.errors.push.apply(this.errors,this.script.errors)}},Eden.AST.TYPE_UNKNOWN=0,Eden.AST.TYPE_NUMBER=1,Eden.AST.TYPE_STRING=2,Eden.AST.TYPE_LIST=3,Eden.AST.TYPE_BOOLEAN=4,Eden.AST.TYPE_SYMBOL=5,Eden.AST.TYPE_OBJECT=6,Eden.AST.TYPE_PROMISE=7,Eden.AST.TYPE_AST=8,Eden.AST.VERSION_CS2=0,Eden.AST.VERSION_CS3=1,Eden.AST.version=1,Eden.AST.fnEdenASTerror=function(e){this.errors.unshift(e)},Eden.AST.fnEdenASTleft=function(e){this.l=e,this.mergeExpr(e)},Eden.AST.transpileExpressionNode=function(e,t,n){n&&(n.dependencies||(n.dependencies={}));var r={type:n.statement?n.statement.type:null,dependencies:n?n.dependencies:{},vars:Object.create(null),isconstant:!0,scopes:[],locals:n?n.locals:void 0},i={symbol:n.symbol,bound:!1,scope:t,indef:n.statement&&"definition"===n.statement.type};t||console.warn("Missing scope in transpile",e);var s,o="",i=e.generate(r,"scope",i),a={};for(s in r.vars){var d=r.vars[s];a.hasOwnProperty(d)||(a[d]=""),a[d]+="\tlet v_"+s+" = "+d+'.l("'+removeHash(s)+'");\n'}if(a.hasOwnProperty("scope")&&(o+=a.scope),0<r.scopes.length){o+="\tvar _scopes = [];\n";for(var c=0;c<r.scopes.length;c++)o+="\t_scopes.push("+r.scopes[c],o+=");\n",o+="\tif (cache && cache.scopes && "+c+" < cache.scopes.length) { _scopes["+c+"].mergeCache(cache.scopes["+c+"]); _scopes["+c+"].reset(); } else _scopes["+c+"].rebuild();\n",a.hasOwnProperty("_scopes["+c+"]")&&(o+=a["_scopes["+c+"]"]);o+="if (cache) cache.scopes = _scopes;\n"}return"async"==e.type?(o+="\tvar _r = rt.flattenPromise("+i+");\n",o+="\treturn _r;"):o+="\treturn "+i+";",n.isconstant=r.isconstant&&n.isconstant,o},Eden.AST.executeExpressionNode=function(t,n,r){var e=Eden.AST.transpileExpressionNode(t,n,r);try{var i=new Function(["context","scope","cache"],e);return r.symbol?i.call(r.symbol,n.context,n,n.lookup(r.symbol.name)):i(n.context,n,null)}catch(e){return err=new Eden.RuntimeError(n.context,Eden.RuntimeError.UNKNOWN,r.statement||t,"Expression evaluation failed: "+t.toEdenString(n,r)),r.statement?(err.line=r.statement.line,r.statement.errors.push(err)):t.errors.push(err),void n.context.instance.emit("error",[{name:r.symbol?r.symbol.name:"Inline"},err])}},Eden.AST.debug=!1,Eden.AST.debugstep=!1,Eden.AST.debugstep_cb=void 0,Eden.AST.debugspeed=500,Eden.AST.debugbreakpoint=void 0,Eden.AST.debugbreakpoint_cb=void 0,Eden.AST.debug_begin_cb=void 0,Eden.AST.debug_end_cb=void 0,Eden.AST.fromNode=function(r,i){return new Promise((t,e)=>{var n=new Eden.AST(r.getInnerSource(),void 0,i,{noindex:!0,noparse:!0});n.script=r,n.errors=r.errors,Eden.Selectors.queryWithin([r],">>.type(when)",null,e=>{n.whens=e,t(n)})})},Eden.AST.prototype.doxyFromOrigin=function(){var e=this.origin.name;if(this.origin.title&&(e+="\n * @title "+this.origin.title),this.origin.author&&(e+="\n * @author "+this.origin.author),this.origin.id&&(e+="\n * @id "+this.origin.id),this.origin.saveID&&(e+="\n * @version "+this.origin.vid),this.origin.tags&&0<this.origin.tags.length){e+="\n *";for(var t=0;t<this.origin.tags.length;t++)e+=" #"+this.origin.tags[t]}return new Eden.AST.DoxyComment(e)},Eden.AST.originFromDoxy=function(e){var t={};if(void 0===e)return t;e=e.getControls();return e["@title"]&&(t.title=e["@title"][0]),e["@author"]&&(t.author=e["@author"][0]),e["@id"]&&(t.id=e["@id"][0]),e["@version"]&&(t.vid=e["@version"][0]),t},Eden.AST.prototype.destroy=function(){for(var e=Eden.Selectors.queryWithin([this.script],">>"),t=0;t<e.length;t++)Eden.Index.remove(e[t]);this.script=void 0,this.stream=void 0,this.lines=void 0,this.scripts=void 0;for(t=0;t<this.whens.length;t++)this.whens[t].enabled&&eden.project.removeAgent(this.whens[t])},Eden.AST.prototype.getActionByName=function(e){var t;if(-1==e.indexOf("/")&&void 0===(t=this.scripts[e]))for(var n=0;n<this.imports.length;n++)if(this.imports[n]&&this.imports[n].ast&&(t=this.imports[n].ast.getActionByName(e)))return t;return t},Eden.AST.prototype.generate=function(){return this.script.generate()},Eden.AST.prototype.execute=function(e,t,n){this.executeStatement(this.script,t,e,n)},Eden.AST.prototype.clearExecutedState=function(){for(var e=0;e<this.lines.length;e++)this.lines[e]&&0<this.lines[e].executed&&(this.lines[e].executed=0)},Eden.AST.prototype.executeLine=function(e,t,n){var r=e,e=-1==e?this.script:this.lines[r];void 0!==e&&(e=this.getBase(e),this.executeStatement(e,r,t,n))},Eden.AST.prototype.syntaxError=function(e,t,n){n=new Eden.SyntaxError(this,t,n);e.errors.push(n)},Eden.AST.prototype.typeWarning=function(e,t){t=new Eden.TypeWarning(e,t);e.warning=t},Eden.AST.prototype.syntaxWarning=function(e,t,n){e.warning=new Eden.SyntaxWarning(this,e,t,n)},Eden.AST.prototype.deprecated=function(e,t){e.warning=new Eden.SyntaxWarning(this,e,Eden.SyntaxWarning.DEPRECATED,t)},Eden.AST.typeCheck=function(e,t){var n=typeof t;switch(e){case 0:return!0;case Eden.AST.TYPE_BOOLEAN:return"boolean"==n;case Eden.AST.TYPE_STRING:return"string"==n;case Eden.AST.TYPE_NUMBER:return"number"==n;case Eden.AST.TYPE_OBJECT:return"object"==n;case Eden.AST.TYPE_LIST:return Array.isArray(t);default:return!0}},Eden.AST.parseStatement=function(e,t){var n=new Eden.AST(e,void 0,t||{},{noparse:!0,noindex:!0});for(n.next();"STRING"===n.token;)"use cs2;"===n.data.value?n.version=Eden.AST.VERSION_CS2:"use cs3;"===n.data.value&&(n.version=Eden.AST.VERSION_CS3),n.next();t=n.pSTATEMENT();void 0===t&&(t=new Eden.AST.DummyStatement,console.error("Invalid statement: ",e),n.syntaxError(t,Eden.SyntaxError.UNKNOWN)),"EOF"!=n.token&&n.syntaxError(t,Eden.SyntaxError.UNKNOWN),t.base=n,t.setSource(0,e.length,e),t.stamp=n.stamp;e=(t.prefix?t.prefix+t.postfix:e).match("\n");return t.numlines=null===e?0:e.length,t},Eden.AST.parseScript=function(e,t){if("string"!=typeof e)return null;var n=new Eden.AST(e,void 0,t||{},{noparse:!0,noindex:!0});for(n.next();"STRING"===n.token;)"use cs2;"===n.data.value?n.version=Eden.AST.VERSION_CS2:"use cs3;"===n.data.value&&(n.version=Eden.AST.VERSION_CS3),n.next();t=n.pSCRIPT();t.base=n,t.setSource(0,e.length,e),t.stamp=n.stamp;e=e.match("\n");return t.numlines=null===e?0:e.length,t},Eden.AST.parseScript3=function(e,t){if("string"!=typeof e)return null;var n=new Eden.AST(e,void 0,t||{},{noparse:!0,noindex:!0});for(n.next();"STRING"===n.token;)n.next();n.version=Eden.AST.VERSION_CS3;t=n.pSCRIPT();t.base=n,t.setSource(0,e.length,e),t.stamp=n.stamp;e=e.match("\n");return t.numlines=null===e?0:e.length,t},Eden.AST.parseExpression=function(e){var t=new Eden.AST(e,void 0,{},{noparse:!0,noindex:!0});t.next();e=t.pEXPRESSION();return"EOF"!=t.token&&t.syntaxError(e,Eden.SyntaxError.UNKNOWN),e},Eden.AST.parseRule=function(e,t,n){t=new Eden.AST(t,void 0,{},{noparse:!0,noindex:!0});t.next();e=n?t[e].apply(t,n):t[e]();return"EOF"!=t.token&&t.syntaxError(e,Eden.SyntaxError.UNKNOWN),e},Eden.AST.registerExpression=function(e){e.prototype.execute=Eden.AST.BaseExpression.execute,e.prototype.mergeExpr=Eden.AST.BaseExpression.mergeExpr,e.prototype.error=Eden.AST.fnEdenASTerror,e.prototype.toString=Eden.AST.BaseExpression.toString,e.prototype.getEdenCode=Eden.AST.BaseExpression.getEdenCode},Eden.AST.registerStatement=function(e){e.prototype.getOrigin=Eden.AST.BaseStatement.getOrigin,e.prototype.hasErrors=Eden.AST.BaseStatement.hasErrors,e.prototype.setSource=Eden.AST.BaseStatement.setSource,e.prototype.getSource=Eden.AST.BaseStatement.getSource,e.prototype.getOuterSource=Eden.AST.BaseStatement.getOuterSource,e.prototype.getNumberOfLines=Eden.AST.BaseStatement.getNumberOfLines,e.prototype.getStartLine=Eden.AST.BaseStatement.getStartLine,e.prototype.getEndLine=Eden.AST.BaseStatement.getEndLine,e.prototype.getRange=Eden.AST.BaseStatement.getRange,e.prototype.error=Eden.AST.fnEdenASTerror,e.prototype.addIndex=Eden.AST.BaseStatement.addIndex,e.prototype.removeIndex=Eden.AST.BaseStatement.removeIndex,e.prototype.destroy=Eden.AST.BaseStatement.destroy,e.prototype.buildID=Eden.AST.BaseStatement.buildID,e.prototype.setDoxyComment=Eden.AST.BaseStatement.setDoxyComment,e.prototype.addSubscriber=Eden.AST.BaseStatement.addSubscriber,e.prototype.removeSubscriber=Eden.AST.BaseStatement.removeSubscriber,e.prototype.getEdenCode=Eden.AST.BaseStatement.getEdenCode,e.prototype.getLocationName=Eden.AST.BaseStatement.getLocationName,e.prototype.attribute=Eden.AST.BaseStatement.attribute},Eden.AST.registerScript=function(e){Eden.AST.registerStatement(e),e.prototype.getStatementByLine=Eden.AST.BaseScript.getStatementByLine,e.prototype.getRelativeLine=Eden.AST.BaseScript.getRelativeLine,e.prototype.getNumberOfLines=Eden.AST.BaseScript.getNumberOfLines,e.prototype.getNumberOfInnerLines=Eden.AST.BaseScript.getNumberOfInnerLines,e.prototype.append=Eden.AST.BaseScript.append,e.prototype.appendChild=Eden.AST.BaseScript.appendChild,e.prototype.removeChild=Eden.AST.BaseScript.removeChild,e.prototype.insertBefore=Eden.AST.BaseScript.insertBefore,e.prototype.insertAfter=Eden.AST.BaseScript.insertAfter,e.prototype.replaceChild=Eden.AST.BaseScript.replaceChild,e.prototype.addIndex=Eden.AST.BaseScript.addIndex,e.prototype.addIndexReverse=Eden.AST.BaseScript.addIndexReverse,e.prototype.removeIndex=Eden.AST.BaseScript.removeIndex,e.prototype.destroy=Eden.AST.BaseScript.destroy,e.prototype.buildID=Eden.AST.BaseScript.buildID},Eden.AST.registerContext=function(e){Eden.AST.registerScript(e)},Eden.AST.prototype.getBase=function(e,t){void 0===t&&console.error("Undefined context in getBase");for(var n=e;n&&n.parent&&n.parent!==t;)n=n.parent;return n},Eden.AST.prototype.getBlockLines=function(e,t){for(var n=e,r=this.getBase(this.lines[n],t);0<n&&this.lines[n-1]&&this.getBase(this.lines[n-1],t)==r;)n--;for(e=n;n<this.lines.length-1&&this.lines[n+1]&&(this.lines[n+1]===r||this.lines[n+1].parent!==t);)n++;return[e,n]},Eden.AST.prototype.getSource=function(e){return this.script.getSource()},Eden.AST.prototype.getRoot=function(){return this.script},Eden.AST.prototype.getErrors=function(){return this.script.errors},Eden.AST.prototype.hasErrors=function(){return 0<this.script.errors.length},Eden.AST.prototype.prettyPrint=function(){var e="";if(0<this.script.errors.length)for(var t=0;t<this.script.errors.length;t++)e=e+this.script.errors[t].prettyPrint()+"\n\n";else e=JSON.stringify(this.script,function(e,t){if("errors"!=e)return"parent"==e?!!t||void 0:t},"    ");return e},Eden.AST.prototype.next=function(){this.previous=this.token,this.lastposition=this.stream.position,this.lastline=this.stream.line,this.token=this.stream.readToken();for(var e=this.stream.prevline;;)if("/*"===this.token){var t,n=1,r=!1,i=this.stream.position-2,s=this.stream.line;for(42==this.stream.peek()&&(r=!0);this.stream.valid()&&("*/"!==this.token||0<n);)this.token=this.stream.readCommentToken(),"/*"===this.token?n++:"*/"===this.token&&n--;"*/"!==this.token&&((t=new Eden.SyntaxError(this,Eden.SyntaxError.BLOCKCOMMENT)).line=s,this.errors.push(t)),r&&(r=new Eden.AST.DoxyComment(this.stream.code.substring(i+3,this.stream.position-2).trim(),s,this.stream.line),this.lastDoxyComment.push(r),r.parent=this.parentDoxy,r.content.endsWith("@{")?this.parentDoxy=r:r.content.startsWith("@}")&&this.parentDoxy&&(this.parentDoxy=this.parentDoxy.parent)),this.token=this.stream.readToken()}else{if("${{"!==this.token)break;i=this.stream.position,s=this.stream.line;for(this.data.line=s;this.stream.valid()&&"}}$"!==this.token;)this.token=this.stream.readJSToken();this.data.value=this.stream.code.substring(i,this.stream.position-3),this.token="JAVASCRIPT",this.stream.prevposition=i-3}this.stream.prevline=e},Eden.AST.prototype.peekNext=function(e){var t;for(this.stream.data={value:""},this.stream.pushPosition();0<e;)t=this.stream.readToken(),e--;return this.stream.popPosition(),this.stream.data=this.data,t},"undefined"!=typeof require&&"undefined"!=typeof exports&&(require("./basestatement"),require("./baseexpression"),require("./basescript"),require("./basecontext"),require("./after"),require("./alias"),require("./append"),require("./assignment"),require("./async"),require("./binaryop"),require("./break"),require("./case"),require("./codeblock"),require("./context"),require("./continue"),require("./cs3_html"),require("./customblock"),require("./declarations"),require("./default"),require("./definition"),require("./delete"),require("./do"),require("./doxycomments"),require("./dummy"),require("./for"),require("./function"),require("./functioncall"),require("./handle"),require("./if"),require("./import"),require("./index"),require("./indexed"),require("./insert"),require("./length"),require("./literal"),require("./llist"),require("./local"),require("./lvalue"),require("./modify"),require("./parameter"),require("./primary"),require("./proc"),require("./querystat"),require("./range"),require("./require"),require("./return"),require("./scope"),require("./scopedscript"),require("./scopepath"),require("./scopepattern"),require("./script"),require("./scriptexpr"),require("./section"),require("./shift"),require("./subscribers"),require("./substatement"),require("./switch"),require("./ternaryop"),require("./unaryop"),require("./virtual"),require("./wait"),require("./when"),require("./while"),require("../grammar/template"),require("../grammar/actionbody"),require("../grammar/after"),require("../grammar/attributes"),require("../grammar/cs3_html"),require("../grammar/declarations"),require("../grammar/do"),require("../grammar/expression"),require("../grammar/factor"),require("../grammar/for"),require("../grammar/function"),require("../grammar/if"),require("../grammar/import"),require("../grammar/listops"),require("../grammar/lists"),require("../grammar/lvalue"),require("../grammar/primary"),require("../grammar/proc"),require("../grammar/query"),require("../grammar/scope"),require("../grammar/script"),require("../grammar/section"),require("../grammar/selector"),require("../grammar/statement"),require("../grammar/switch"),require("../grammar/terms"),require("../grammar/wait"),require("../grammar/when"),require("../grammar/while")),Eden.AST.BaseStatement=function(){this.start=0,this.end=0,this.parent=void 0,this.errors=[],this.warning=void 0,this.executed=0,this.numlines=-1,this.doxyComment=void 0,this.lock=0,this.source=void 0,this.id=0,this.stamp=0,this.nextSibling=void 0,this.previousSibling=void 0,this.tags=void 0,this.local=!1,this.subscribers=null,this.line=-1,this.generated=null,this.dependencies=Object.create(null),this.version=0},Eden.AST.BaseStatement.attribute=function(e,t){let n;switch(e){case"ast":n=this;break;case"brief":this.doxyComment&&(n=this.doxyComment.brief());break;case"comment":this.doxyComment&&(n=this.doxyComment.stripped());break;case"source":n=this.getSource();break;case"innersource":n="script"===this.type?this.getInnerSource():"custom"===this.type?this.text:this.getSource();break;case"outersource":n="script"===this.type?this.getOuterSource():this.getSource();break;case"exprtree":this.expression&&(n=Eden.Selectors.expressionToLists(this.expression));break;case"expression":this.expression&&this.lvalue&&this.lvalue.source&&(n=this.getSource().substr(this.lvalue.source.length).trim(),"definition"===this.type?n=n.substring(2,n.length-1).trim():"assignment"===this.type&&(n=n.substr(1,n.length-1).trim()));break;case"title":var r;this.base&&this.base.mainDoxyComment&&(this.base.mainDoxyComment.stripped(),(r=this.base.mainDoxyComment.getControls())&&r["@title"]&&(n=r["@title"][0]));break;case"type":n=this.type;break;case"locked":n=!!this.lock;break;case"location":n=this.getLocationName();break;case"name":this.lvalue?n=this.lvalue.getSymbol({},{},t).name:this.name&&"do"!==this.type?n=this.name:void 0===this.parent&&this.base&&this.base.origin?n=this.base.origin.name:void 0!==this.path&&(n=this.path);break;case"symbol":this.lvalue&&(n=this.lvalue.getSymbol({},{},t));break;case"line":void 0!==this.line&&(n=this.line);break;case"depends":n=this.dependencies?Object.keys(this.dependencies):[];break;case"datatype":n=this.expression?this.expression.typevalue:0;break;case"value":try{n=this.expression?this.expression.execute({scopes:[]},{},t):void 0}catch(e){}break;case"active":n="when"===this.type&&this.enabled||this.lvalue&&t.context.symbols[this.lvalue.name]&&t.context.symbols[this.lvalue.name].origin&&t.context.symbols[this.lvalue.name].origin.id===this.id;break;case"executed":n=0<this.executed;break;case"historic":n=-1==this.executed;break;case"tags":this.doxyComment&&(n=this.doxyComment.getHashTags());break;case"rawcomment":this.doxyComment&&(n=this.doxyComment.content);break;case"controls":case"id":n=this.id;break;case"path":n=Eden.Selectors.getID(this);break;case"remote":for(var i=this;i.parent;)i=i.parent;if(!i.base||!i.base.origin){n=!1;break}n=i.base.origin.remote;break;case"root":n=void 0===this.parent;break;case"static":n=!!this.lvalue&&this.lvalue.isstatic}return n},Eden.AST.BaseStatement.addSubscriber=function(e){this.subscribers||(this.subscribers={}),this.subscribers[e]=eden.root.lookup(e)},Eden.AST.BaseStatement.removeSubscriber=function(e){delete this.subscribers[e]},Eden.AST.BaseStatement.setDoxyComment=function(e){(this.doxyComment=e)&&(void 0===this.tags?this.tags=e.getHashTags():this.tags=this.tags.concat(e.getHashTags()),e.hasTag("#library")&&("function"===this.type||"action"===this.type?Eden.edenFunctions[this.name]=!0:"definition"!==this.type&&"assignment"!==this.type||(Eden.edenFunctions[this.lvalue.name]=!0)))},Eden.AST.BaseStatement.getLocationName=function(){let e=this.parent;for(;e&&!e.name;)e=e.parent;return e&&e.name?"*When"!=e.name?e.name:e.getLocationName()+" > when":"*unknown*"},Eden.AST.BaseStatement.buildID=function(){for(var e=0,t=this.source,n=(t=this.doxyComment?this.doxyComment.content+t:t).length,r=0;r<n;r++)e=(e<<5)-e+t.charCodeAt(r),e&=e;this.name&&"do"!=this.type?this.id=this.name+"@"+e:this.lvalue?this.id=this.lvalue.name+"@"+e:this.id=this.type+"@"+e;for(var i=this.parent;i&&!i.name;)i=i.parent;i&&i.name&&(this.id=this.id+i.name)},Eden.AST.BaseStatement.addIndex=function(){if("dummy"==this.type&&console.trace("ADDING DUMMY INDEX"),this.buildID(),this.statements)for(var e=0;e<this.statements.length;e++)"dummy"!=this.statements[e].type&&this.statements[e].addIndex();Eden.Index.update(this)},Eden.AST.BaseStatement.removeIndex=function(){if(this.statements)for(var e=0;e<this.statements.length;e++)"dummy"!=this.statements[e].type&&this.statements[e].removeIndex();Eden.Index.remove(this)},Eden.AST.BaseStatement.destroy=function(){if(this.executed<1&&Eden.Index.remove(this),this.parent=void 0,this.nextSibling=void 0,this.previousSibling=void 0,this.statements)for(var e=0;e<this.statements.length;e++)"dummy"!=this.statements[e].type&&this.statements[e].destroy();this.executed=-1},Eden.AST.BaseStatement.hasErrors=function(){return 0<this.errors.length},Eden.AST.BaseStatement.getNumberOfLines=function(){return this.numlines},Eden.AST.BaseStatement.getNumberOfInnerLines=function(){return this.numlines},Eden.AST.BaseStatement.getStartLine=function(e){return this.parent?this.parent.getRelativeLine(this,e):-1},Eden.AST.BaseStatement.getEndLine=function(e){return this.getStartLine(e)+this.getNumberOfLines()},Eden.AST.BaseStatement.getRange=function(e){e=this.getStartLine(e);return[e,e+this.getNumberOfLines()]},Eden.AST.BaseStatement.setSource=function(e,t,n){this.start=e,this.end=t,this.source=n},Eden.AST.BaseStatement.getSource=function(){return this.source},Eden.AST.BaseStatement.getOuterSource=function(){var e=this.getSource();void 0===this.parent&&(e="action "+this.name+"{"+e+"}"),this.doxyComment&&(e="/** "+this.doxyComment.content+" */\n"+e);for(var t=this.parent;t;)t="script"==t.type?(e=t.name?"action "+t.name+" {\n"+e+"\n}":"{\n"+e+"\n}",t.doxyComment&&(e="/** "+t.doxyComment.content+" */\n"+e),t.parent):void 0;return e},Eden.AST.BaseStatement.getOrigin=function(){for(var e=this;e.parent;)e=e.parent;return e.base?e.base.origin:void 0},Eden.AST.BaseStatement.getEdenCode=function(){return'parse("'+this.getSource()+'")'},Eden.AST.BaseScript=function(){Eden.AST.BaseStatement.apply(this),this.statements=[],this.parameters=void 0,this.locals=void 0,this.indexed=!1,this.subscripts={}},Eden.AST.BaseScript.appendChild=function(e){this.statements.push(e),1<this.statements.length&&(e.previousSibling=this.statements[this.statements.length-2],this.statements[this.statements.length-2].nextSibling=e),(e.parent=this).indexed&&0!=this.id&&console.log("INVALIDATE ID",this),"dummy"!==e.type&&this.indexed&&e.addIndex(),"script"===e.type&&e.name&&(this.subscripts[e.name]=e),0<e.errors.length&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.BaseScript.append=Eden.AST.BaseScript.appendChild,Eden.AST.BaseScript.insertAfter=function(e,t){for(var n=0;n<this.statements.length&&this.statements[n]!==e;n++);if(n+1<this.statements.length)t.previousSibling=this.statements[n],t.nextSibling=this.statements[n+1],this.statements[n].nextSibling=t,this.statements[n+1].previousSibling=t,this.statements.splice(n+1,0,t);else{if(!(n<this.statements.length))return;t.previousSibling=this.statements[n],t.nextSibling=void 0,this.statements[n].nextSibling=t,this.statements.push(t)}t.parent=this,"dummy"!=t.type&&this.indexed&&t.addIndex(),"script"===t.type&&t.name&&(this.subscripts[t.name]=t),0<t.errors.length&&this.errors.push.apply(this.errors,t.errors),this.indexed&&0!=this.id&&console.log("INVALIDATE ID",this)},Eden.AST.BaseScript.insertBefore=function(e,t){for(var n=0;n<this.statements.length&&this.statements[n]!==e;n++);n<this.statements.length?(0<n?(t.nextSibling=this.statements[n],t.previousSibling=this.statements[n-1],this.statements[n].previousSibling=t,this.statements[n-1].nextSibling=t):(t.nextSibling=this.statements[n],this.statements[n].previousSibling=t),this.statements.splice(n,0,t),t.parent=this,"dummy"!=t.type&&this.indexed&&t.addIndex(),"script"===t.type&&t.name&&(this.subscripts[t.name]=t),0<t.errors.length&&this.errors.push.apply(this.errors,t.errors)):eden.emit("error",[new Eden.RuntimeError(void 0,Eden.RuntimeError.NOCHILD,this,"Statement is not a child when using insertBefore")])},Eden.AST.BaseScript.removeChild=function(e){for(var t=0;t<this.statements.length&&this.statements[t]!==e;t++);t<this.statements.length?(this.statements.splice(t,1),e.nextSibling&&(e.nextSibling.previousSibling=e.previousSibling),e.previousSibling&&(e.previousSibling.nextSibling=e.nextSibling),"script"===e.type&&e.name&&this.subscripts[e.name]===e&&delete this.subscripts[e.name],e.destroy()):eden.emit("error",[new Eden.RuntimeError(void 0,Eden.RuntimeError.NOCHILD,this,"Statement is not a child when using removeChild")])},Eden.AST.BaseScript.replaceChild=function(e,t){var n;if("number"==typeof e)n=e;else{for(var r=0;r<this.statements.length&&this.statements[r]!==e;r++);if(r>=this.statements.length)return void eden.emit("error",[new Eden.RuntimeError(void 0,Eden.RuntimeError.NOCHILD,this,"Statement is not a child when using replaceChild")]);n=r}t.nextSibling=this.statements[n].nextSibling,t.nextSibling&&(t.nextSibling.previousSibling=t),t.previousSibling=this.statements[n].previousSibling,t.previousSibling&&(t.previousSibling.nextSibling=t),this.statements[n].destroy(),(this.statements[n]=t).parent=this,"dummy"!=t.type&&this.indexed&&t.addIndex(),"script"===t.type&&t.name&&(this.subscripts[t.name]=t),"script"===e.type&&e.name&&this.subscripts[e.name]===child&&delete this.subscripts[e.name],this.indexed&&0!=this.id&&console.log("INVALIDATE ID",this)},Eden.AST.BaseScript.destroy=function(){this.executed<1&&Eden.Index.remove(this);for(var e=0;e<this.statements.length;e++)this.statements[e].destroy();this.executed=-1,this.statements=void 0,this.base=void 0,this.parent=void 0,this.nextSibling=void 0,this.previousSibling=void 0},Eden.AST.BaseScript.addIndex=function(){if(!this.indexed){0==this.id&&this.buildID();for(var e=0;e<this.statements.length;e++)"dummy"!=this.statements[e].type&&this.statements[e].addIndex();this.indexed=!0,Eden.Index.update(this)}},Eden.AST.BaseScript.addIndexReverse=function(){this.indexed||(0==this.id&&this.buildID(),this.parent&&this.parent.addIndexReverse(),this.indexed=!0,Eden.Index.update(this))},Eden.AST.BaseScript.removeIndex=function(){if(this.indexed){for(var e=0;e<this.statements.length;e++)"dummy"!=this.statements[e].type&&this.statements[e].removeIndex();this.indexed=!1,Eden.Index.remove(this)}},Eden.AST.BaseScript.buildID=function(){for(var e=0,t=this.getSource(),n=t.length,r=0;r<n;r++)e=(e<<5)-e+t.charCodeAt(r),e&=e;this.id=this.type+"@"+e},Eden.AST.BaseScript.getStatementByLine=function(e,t){var n=0;if(t&&this.parent&&(n=this.parent.getRelativeLine(this,t)),!(e<n)&&void 0!==this.statements)for(var r=0;r<this.statements.length;r++){var i=this.statements[r].getNumberOfLines();if(n<=e&&e<=n+i&&"dummy"!=this.statements[r].type)return this.statements[r];n+=i}},Eden.AST.BaseScript.getRelativeLine=function(e,t){var n=0;t&&t!==this&&this.parent&&(n=this.parent.getRelativeLine(this,t));for(var r=0;r<this.statements.length;r++){if(this.statements[r]===e)return n;n+=this.statements[r].getNumberOfLines()}return-1},Eden.AST.BaseScript.getNumberOfLines=function(){void 0===this.statements&&console.error("No Statements",this);for(var e=this.numlines,t=0;t<this.statements.length;t++)e+=this.statements[t].getNumberOfLines();return e},Eden.AST.BaseScript.getNumberOfInnerLines=function(){void 0===this.statements&&console.error("No Statements",this);for(var e=0,t=0;t<this.statements.length;t++)e+=this.statements[t].getNumberOfLines();return e},Eden.AST.BaseContext=function(){Eden.AST.BaseScript.apply(this),this.scopes=[],this.locals=void 0,this.params=void 0,this.dependencies={},this.vars=Object.create(null)},Eden.AST.BaseExpression=function(){this.isconstant=!0,this.isdependant=!1,this.isdynamic=!1,this.typevalue=Eden.AST.TYPE_UNKNOWN,this._is_eden_expression=!0,this.isscoped=!1,this.errors=[],this.warning=null},Eden.AST.BaseExpression.mergeExpr=function(e){e&&(this.isconstant=this.isconstant&&e.isconstant,this.isdependant=this.isdependant||e.isdependant,this.isdynamic=this.isdynamic||e.isdynamic,this.isscoped=this.isscoped||e.isscoped,0===this.typevalue?this.typevalue=e.typevalue:0===e.typevalue||e.typevalue!==this.typevalue&&(this.typevalue=0),e.errors&&0<e.errors.length&&(this.errors||(this.errors=[]),this.errors.push.apply(this.errors,e.errors)),e.warning&&!this.warning&&(this.warning=e.warning))},Eden.AST.BaseExpression.execute=function(e,t,n){var r={isconstant:!0,locals:e.locals,symbol:e.symbol},e=Eden.AST.transpileExpressionNode(this,n,r);return new Function(["context","scope","cache"],e).call(r.symbol||null,n.context,n,r.symbol?n.lookup(r.symbol.name):null)},Eden.AST.BaseExpression.toString=function(){return"__error__"},Eden.AST.BaseExpression.getEdenCode=Eden.AST.BaseExpression.toString,Eden.AST.Append=function(){this.type="append",Eden.AST.BaseStatement.apply(this),this.destination=void 0,this.index=void 0},Eden.AST.Append.prototype.setDest=function(e){0<(this.destination=e).errors.length&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Append.prototype.setIndex=function(e){0<(this.index=e).errors.length&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Append.prototype.generate=function(e,t,n){var r=this.index.generate(e,t,n),n=this.destination.generate(e,t,n);return this.destination.islocal?n+".push("+r+");\n":t+".mutate("+n+", function(s) { scope.lookup(s.name).value.push("+r+"); }, this);"},Eden.AST.Append.prototype.execute=function(e,t,n,r){this.executed=1;var i=this.index.execute(e,t,n);i instanceof BoundValue&&(i=i.value);e=n.context.lookup(this.destination.name),t=e.value(n);t.push(i),e.assign(t,n,this)},Eden.AST.registerStatement(Eden.AST.Append),Eden.AST.Shift=function(){this.type="shift",Eden.AST.BaseStatement.apply(this),this.destination=void 0},Eden.AST.Shift.prototype.setDest=function(e){0<(this.destination=e).errors.length&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Shift.prototype.generate=function(e,t){e=this.destination.generate(e,t);return this.destination.islocal?e+".shift();\n":t+".mutate("+e+", function(s) { scope.lookup(s.name).value.shift(); }, this);"},Eden.AST.Shift.prototype.execute=function(e,t,n,r){this.executed=1;var i=eden.root.lookup(this.destination.name),s=i.value(n);s.shift(),i.assign(s,n,this)},Eden.AST.registerStatement(Eden.AST.Shift),Eden.AST.Assignment=function(e){this.type="assignment",Eden.AST.BaseStatement.apply(this),this.errors=e?e.errors:[],e&&e.warning&&(this.warning=e.warning),this.expression=e,this.lvalue=void 0,this.compiled=void 0,this.dirty=!1,this.value=void 0,this.isstatic=!1},Eden.AST.Assignment.prototype.setExpression=function(e){(this.expression=e)&&0<e.errors.length&&(this.errors=e.errors),e&&e.warning&&!this.warning&&(this.warning=e.warning)},Eden.AST.Assignment.prototype.reset=function(){this.executed=0,this.dirty=!0},Eden.AST.Assignment.prototype.left=function(e){(this.lvalue=e)&&0<e.errors.length&&this.errors.push.apply(this.errors,e.errors),!this.warning&&e.warning&&(this.warning=e.warning)},Eden.AST.Assignment.prototype.setAttributes=function(e){for(var t in e)return!1;return!0},Eden.AST.Assignment.prototype.generate=function(e,t,n){n||console.warn("Missing assignment generator options");var r=this.lvalue.generate(e,t,n);return this.lvalue.islocal?(r+=" = ",r+=this.expression.generate(e,t,n),r+=";\n"):this.lvalue.hasListIndices()?(r=t+".listAssign("+r+",",r+=this.expression.generate(e,t,n),r+=`, ${n.symbol?"this":"EdenSymbol.localJSAgent"}, false, `,r+=this.lvalue.generateCompList(e,t),r+=");\n"):(r=t+".assign("+r+",",r+=this.expression.generate(e,t,n),r+=`, ${n.symbol?"this":"EdenSymbol.localJSAgent"});\n`)},Eden.AST.Assignment.prototype.compile=function(e,t,n){this.dirty=!1;e={statement:this,symbol:n,isconstant:!0,dependant:!1,locals:e.locals},e=Eden.AST.transpileExpressionNode(this.expression,t,e);this.compiled=new Function(["context","scope","cache"],e)},Eden.AST.Assignment.prototype.execute=function(e,t,n,r){if(void 0!==this.expression){this.executed=1,this.doxyComment&&n.context.instance.updateDictionary(this.lvalue.name,this.doxyComment);try{var i=this.lvalue.getSymbol(e,t,n);if(this.compile(e,n,i),i.scopecount=0,this.lvalue.hasListIndices()){var s=this.compiled.call(i,n.context,n,n.lookup(i.name)),o=this.lvalue.executeCompList(e,n);i.listAssign(s,n,this,!1,o)}else{if(s=this.compiled.call(i,n.context,n,n.lookup(i.name)),i.origin&&i.origin.lvalue){o=i.origin.lvalue;o.isstatic&&(this.warning=new Eden.RuntimeWarning(this,Eden.RuntimeWarning.UNKNOWN,"Changing a [static] symbol"));o=(0!==this.lvalue.typevalue?this.lvalue:o).typevalue;if(!Eden.AST.typeCheck(o,s))throw"Type Error"}i.assign(s,n,this)}void 0===s&&(this.warning=new Eden.RuntimeWarning(this,Eden.RuntimeWarning.UNDEFINED))}catch(e){var a;if(0===e)return;e instanceof Eden.RuntimeError?(a=e).statement=this:a=/[0-9][0-9]*/.test(e.message)?new Eden.RuntimeError(n.context,parseInt(e.message),this,e.message):new Eden.RuntimeError(n.context,0,this,e),a.line=this.line,this.errors.push(a),n.context.instance.emit("error",[r||{name:"Unknown"},a])}}},Eden.AST.registerStatement(Eden.AST.Assignment),Eden.AST.BinaryOp=function(e){switch(this.type="binaryop",Eden.AST.BaseExpression.apply(this),this.op=e,this.l=void 0,this.r=void 0,"&"==this.op||"and"==this.op?this.op="&&":"|"!=this.op&&"or"!=this.op||(this.op="||"),e){case">":case"<":case">=":case"<=":case"==":case"!=":this.typevalue=Eden.AST.TYPE_BOOLEAN;break;case"*":case"/":case"^":case"%":this.typevalue=Eden.AST.TYPE_NUMBER}},Eden.AST.BinaryOp.prototype.left=Eden.AST.fnEdenASTleft,Eden.AST.BinaryOp.prototype.setRight=function(e){this.r=e,this.mergeExpr(e)},Eden.AST.BinaryOp.prototype.toEdenString=function(e,t){return`(${this.l.toEdenString(e,t)} ${this.op} ${this.r.toEdenString(e,t)})`},Eden.AST.BinaryOp.prototype.generate=function(e,t,n){var r,i=n,n=this.l.generate(e,t,i),e=this.r.generate(e,t,i),t=0;t=this.l.typevalue===this.r.typevalue?this.l.typevalue:this.l.typevalue===Eden.AST.TYPE_STRING||this.r.typevalue===Eden.AST.TYPE_STRING?Eden.AST.TYPE_STRING:(0===this.l.typevalue?this.r:this.l).typevalue;t=(this.l.typevalue!==this.r.typevalue&&this.l.typevalue===Eden.AST.TYPE_UNKNOWN?this.r:this.l).typevalue;switch(this.op){case"//":r="concat";break;case"+":r="add";break;case"-":r="subtract";break;case"/":r="divide";break;case"*":r="multiply";break;case"==":r="equal";break;case"!=":r="notequal";break;case"%":r="mod";break;case"^":r="pow";break;default:r="RAW"}i=this.op;return t===Eden.AST.TYPE_NUMBER?this.l.typevalue===this.r.typevalue?"^"!==this.op&&(r="RAW"):"+"===this.op?r="addA":"-"===this.op?r="subtractA":"=="!==this.op&&"!="!==this.op||(r="RAW"):t===Eden.AST.TYPE_STRING&&("//"==this.op?this.l.typevalue===this.r.typevalue?(r="RAW",i=" + "):r="concatS":"=="!=this.op&&"!="!=this.op||(r="RAW")),"RAW"!=r?"rt."+r+"(("+n+"),("+e+"))":"("+n+") "+i+" ("+e+")"},Eden.AST.registerExpression(Eden.AST.BinaryOp),Eden.AST.Break=function(){this.type="break",Eden.AST.BaseStatement.apply(this)},Eden.AST.Break.prototype.generate=function(e,t){return"break; "},Eden.AST.Break.prototype.execute=function(e,t,n,r){n=new Eden.RuntimeError(n.context,Eden.RuntimeError.NOTSUPPORTED,this,"Break not supported here");n.line=this.line,this.errors.push(n),Eden.Agent.emit("error",[r,n])},Eden.AST.registerStatement(Eden.AST.Break),Eden.AST.Case=function(){this.type="case",Eden.AST.BaseStatement.apply(this),this.datatype="",this.literal=void 0},Eden.AST.Case.prototype.setLiteral=function(e,t){this.datatype=e,this.literal=t},Eden.AST.Case.prototype.generate=function(e,t){return"string"==typeof this.literal?'case "'+this.literal+'": ':"case "+this.literal+": "},Eden.AST.Case.prototype.execute=function(e,t,n,r){n=new Eden.RuntimeError(n.context,Eden.RuntimeError.NOTSUPPORTED,this,"Case not supported here");n.line=this.line,this.errors.push(n),Eden.Agent.emit("error",[r,n])},Eden.AST.registerStatement(Eden.AST.Case),Eden.AST.Context=function(e){this.symbols={},this.parent=e},Eden.AST.Context.prototype.lookup=function(e){return console.log("LOOKUP CONTEXT",e),this.symbols[e]||(this.symbols[e]=new Eden.AST.Handle(e),this.symbols[e])},Eden.AST.Continue=function(){this.type="continue",Eden.AST.BaseStatement.apply(this)},Eden.AST.Continue.prototype.generate=function(e,t){return"continue; "},Eden.AST.Continue.prototype.execute=function(e,t,n,r){n=new Eden.RuntimeError(n.context,Eden.RuntimeError.NOTSUPPORTED,this,"Continue not supported here");n.line=this.line,this.errors.push(n),Eden.Agent.emit("error",[r,n])},Eden.AST.registerStatement(Eden.AST.Continue),Eden.AST.Declarations=function(){this.type="declarations",Eden.AST.BaseStatement.apply(this),this.list=[],this.kind="local"},Eden.AST.Declarations.prototype.toEdenString=function(e,t){var n,r="local"==this.kind?"local ":"para ",i=!0;for(n of this.list)i||(r+=", "),i=!1,r+=n;return r+";"},Eden.AST.Declarations.prototype.execute=function(e,t,n,r){if("local"==this.kind)for(var i=0;i<this.list.length;i++){var s=new Eden.AST.Local(this.list[i]);n.addIfNotExist(this.list[i],s),e.locals[this.list[i]]=s}else if("oracle"==this.kind)for(i=0;i<this.list.length;i++){s=new Eden.AST.Local(this.list[i]);n.addAlias(this.list[i],"$"+(i+1),s),e.locals[this.list[i]]=s}},Eden.AST.Declarations.prototype.generate=function(e,t,n){if("local"==this.kind){var r="var ";void 0===e.locals&&(e.locals={});for(var i=0;i<this.list.length;i++)e.locals[this.list[i]]="local",r+=this.list[i],i<this.list.length-1&&(r+=",");return r+=";\n"}this.kind="oracle";r="";void 0===e.locals&&(e.locals={});for(i=0;i<this.list.length;i++)e.locals[this.list[i]]="oracle";return r},Eden.AST.registerStatement(Eden.AST.Declarations),Eden.AST.Default=function(){this.type="default",Eden.AST.BaseStatement.apply(this)},Eden.AST.Default.prototype.generate=function(e,t){return"default: "},Eden.AST.Default.prototype.execute=function(e,t,n,r){n=new Eden.RuntimeError(n.context,Eden.RuntimeError.NOTSUPPORTED,this,"Default not supported here");n.line=this.line,this.errors.push(n),Eden.Agent.emit("error",[r,n])},Eden.AST.registerStatement(Eden.AST.Default),Eden.AST.Definition=function(){this.type="definition",Eden.AST.BaseStatement.apply(this),this.expression=void 0,this.lvalue=void 0,this.eager=!1,this.volatile=!1,this.isstatic=!1},Eden.AST.Definition.prototype.reset=function(){this.executed=0},Eden.AST.Definition.prototype.setAttributes=function(e){for(var t in e)switch(t){case"eager":this.eager=!0;break;case"volatile":this.volatile=!0;break;case"static":this.isstatic=!0;break;case"async":break;case"number":case"boolean":case"object":case"undefined":case"string":case"list":break;default:return!!t.startsWith("depends(")&&(this.dependencies[e[t]]=!0)}return!0},Eden.AST.Definition.prototype.setExpression=function(e){e&&e.warning&&(this.warning=e.warning),this.expression=e,this.errors=e.errors},Eden.AST.Definition.prototype.left=function(e){(this.lvalue=e)&&0<e.errors.length&&this.errors.push.apply(this.errors,e.errors),!this.warning&&e.warning&&(this.warning=e.warning)},Eden.AST.Definition.prototype.locatePrimary=function(e){for(var t=this.expression,n=0;n<e.length;++n){var r=e[n];if("literal"!=t.type)return;if("LIST"==t.datatype){if(!(Array.isArray(t.value)&&r<t.value.length))return;t=t.value[r]}else{if("OBJECT"!=t.datatype)return;t=t.value[r]}}if(t&&"primary"==t.type&&!t.backtick&&0==t.extras.length)return t.observable},Eden.AST.Definition.prototype.generate=function(e,t,n){throw Eden.RuntimeError(n.scope.context,Eden.RuntimeError.NOTSUPPORTED,this,"Cannot generate defintions here")},Eden.AST.Definition.prototype.safeEval=function(__name,__code){return eval(`(function ${__name}(context,scope,cache){${__code}})`)},Eden.AST.Definition.prototype.execute=function(e,t,n,r){this.executed=1;var i=this.lvalue.getSymbol(e,t,n),s=this.lvalue&&this.lvalue.name?"def_"+this.lvalue.name:"";if(this!==i.origin)if(this.lvalue.isDynamic()||this.expression.isdependant){var o={isconstant:!0,locals:e.locals,statement:this,symbol:i},a=this.expression.toEdenString(n,o),a=o.isconstant?i.name+" = "+a+";":i.name+" is "+a+";",a=Eden.AST.parseStatement(a);a.generated=this,a.parent=this.parent,a.addIndex(),a.execute(e,t,n,r)}else try{var o={statement:this,symbol:i,isconstant:!0,dependant:!1,locals:e.locals,dependencies:this.dependencies},d=Eden.AST.transpileExpressionNode(this.expression,n,o),c=Object.keys(this.dependencies);i.isasync="async"==this.expression.type,i.eager=this.eager,i.volatile=this.volatile;var h=this.safeEval(s,d);i.origin&&i.origin.isstatic&&(this.warning=new Eden.RuntimeWarning(this,Eden.RuntimeWarning.UNKNOWN,"Changing a [static] symbol")),i.define(h,this,c)}catch(e){console.log(d,e),t=e.message==Eden.RuntimeError.EXTENDSTATIC?new Eden.RuntimeError(n.context,Eden.RuntimeError.EXTENDSTATIC,this,"Can only define list items if the list is defined"):new Eden.RuntimeError(n.context,Eden.RuntimeError.UNKNOWN,this,e),this.errors.push(t),t.line=this.line,n.context.instance.emit("error",[r,this.errors[this.errors.length-1]])}},Eden.AST.registerStatement(Eden.AST.Definition),Eden.AST.Delete=function(){this.type="delete",Eden.AST.BaseStatement.apply(this),this.destination=void 0,this.index=void 0},Eden.AST.Delete.prototype.setDest=function(e){0<(this.destination=e).errors.length&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Delete.prototype.setIndex=function(e){0<(this.index=e).errors.length&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Delete.prototype.generate=function(e,t,n){n=this.index.generate(e,t,n);return this.destination.generate(e)+".mutate(scope, function(s) { scope.lookup(s.name).value.splice(rt.index("+n+"), 1); }, this);"},Eden.AST.Delete.prototype.execute=function(e,t,n){this.executed=1;var r=this.index.execute(e,t,n);r instanceof BoundValue&&(r=r.value),n.context.lookup(this.destination.name).mutate(n,function(e){e.value().splice(r-1,1)},this)},Eden.AST.registerStatement(Eden.AST.Delete),Eden.AST.Do=function(){this.type="do",Eden.AST.BaseStatement.apply(this),this.name=void 0,this.script=void 0,this.scope=void 0,this.compScope=void 0,this.nscope=void 0,this.selector=void 0,this.literal=void 0,this.statements=void 0,this.attribs={}},Eden.AST.Do.attributes={atomic:!0,nonatomic:!0},Eden.AST.Do.prototype.setScript=function(e){this.script=e,this.script&&0<this.script.errors.length&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Do.prototype.setAttributes=function(e){for(var t in this.attribs=e)if(!Eden.AST.Do.attributes.hasOwnProperty(t))return!1;return!0},Eden.AST.Do.prototype.setLiteral=function(e){(this.literal=e)&&0<e.errors.length&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Do.prototype.setName=function(e){e&&e.errors&&this.errors.push.apply(this.errors,e.errors),this.name=e},Eden.AST.Do.prototype.setScope=function(e){(this.scope=e)&&0<e.errors.length&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Do.prototype.getScope=function(e,t){if(void 0===this.compScope)if(this.scope)try{this.compScope=new Function(["context","scope"],"var s = "+this.scope.generateConstructor(e,"scope",{bound:!1,scope:t})+"; s.rebuild(); return s;")}catch(e){console.error("Scope generate failed",e)}else this.compScope=function(e,t){return new Eden.Scope(e,t,[],!1,null,!1)};return this.compScope},Eden.AST.Do.prototype.generate=function(e,t,n){if(this.literal)return"context.instance.execute("+this.literal.generate(e,t,n)+");";t=new Eden.RuntimeError(n.scope.context,Eden.RuntimeError.NOTSUPPORTED,this,"Cannot use 'do' here");return this.errors.push(t),n.scope.emit("error",[EdenSymbol.defaultAgent,t]),""},Eden.AST.Do.prototype.execute=function(e,t,n,r){},Eden.AST.registerStatement(Eden.AST.Do),Eden.AST.DoxyComment=function(e,t,n){this.type="doxycomment",this.content=e,this.startline=t,this.endline=n,this.tags=void 0,this.controls=void 0,this.parent=void 0},Eden.AST.DoxyComment.prototype.getHashTags=function(){return this.tags?Object.keys(this.tags):(this.stripped(),this.tags?Object.keys(this.tags):[])},Eden.AST.DoxyComment.prototype.hasTag=function(e){return void 0===this.tags&&this.getHashTags(),!(!this.tags||!this.tags[e])},Eden.AST.DoxyComment.prototype.getControls=function(){return this.controls||(this.stripped(),this.controls)},Eden.AST.DoxyComment.prototype.getProperty=function(e){var t=this.getControls();return t?t["@"+e]:void 0},Eden.AST.DoxyComment.prototype.stripped=function(){if(void 0===this.content)return"";for(var e={},t={},n=this.content.split("\n"),r="",i=0;i<n.length;i++)if("#"==n[i].charAt(0)?(n[i]=n[i].slice(1)," "==n[i].charAt(0)&&(n[i]=n[i].slice(1))):"*"==n[i].trim().charAt(0)&&(n[i]=n[i].trim().slice(1)," "==n[i].charAt(0)&&(n[i]=n[i].slice(1))),""!=n[i]){var s=n[i].trim();if("@"!=s.charAt(0)){for(var o=n[i].split(/[ \t]+/),a=0;a<o.length;a++)""!=o[a]&&"@"!=o[a].charAt(0)?(r+=o[a]+" ","#"==o[a].charAt(0)&&(t[o[a]]=!0)):r+=" ";r+="\n"}else{var d,c=s.indexOf(" ");-1==c?e[s]=!0:(d=s.substring(0,c),s=s.substring(c+1,s.length),void 0===e[d]&&(e[d]=[]),e[d].push(s)),n[i]=""}}else r+="\n";return this.controls=e,this.tags=t,r.trim()},Eden.AST.DoxyComment.prototype.brief=function(){var e=this.stripped();if(e)return e.split(".")[0]},Eden.AST.DoxyComment.prototype.pretty=function(){var e=this.stripped(),t=this.controls["@param"],n=EdenUI.Markdown.html(e);if(t&&0<t.length){n+='<div class="doxy-parameters">Parameters:';for(var r=0;r<t.length;r++)n+='<div class="doxy-parameter"><div class="doxy-parameter-name">'+(e=t[r].split(/[ \t]+/))[0]+'</div><div class="doxy-parameter-details">'+e.slice(1).join(" ")+"</div></div>";n+="</div>"}return n},Eden.AST.DoxyComment.prototype.getParamString=function(){var e=this.getControls()["@param"];if(e&&0<e.length){for(var t="(",n=0;n<e.length;n++)t+=e[n].split(/[ \t]+/)[0],n<e.length-1&&(t+=", ");return t+=")"}return"()"},Eden.AST.DummyStatement=function(){this.type="dummy",Eden.AST.BaseStatement.apply(this),this.start=-1},Eden.AST.DummyStatement.prototype.generate=function(){return""},Eden.AST.DummyStatement.prototype.execute=function(){},Eden.AST.registerStatement(Eden.AST.DummyStatement),Eden.AST.DummyStatement.prototype.setSource=function(e,t,n){this.start=this.start<0?e:this.start,this.end=t,this.source?this.source+=n:this.source=n},Eden.AST.DummyStatement.prototype.toEdenString=function(e,t){return""},Eden.AST.DummyStatement.prototype.buildID=function(){for(var e=0,t=this.source+(this.previousSibling?this.previousSibling.getSource():""),n=(t=this.doxyComment?this.doxyComment.content+t:t).length,r=0;r<n;r++)e=(e<<5)-e+t.charCodeAt(r),e&=e;this.id=this.type+"@"+e},Eden.AST.For=function(){this.type="for",Eden.AST.BaseStatement.apply(this),this.sstart=void 0,this.condition=void 0,this.inc=void 0,this.statement=void 0,this.compiled=void 0,this.started=!1,this.list=void 0,this.index=0,this.dirty=!1},Eden.AST.For.prototype.setStart=function(e){(this.sstart=e)&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.For.prototype.setCondition=function(e){(this.condition=e)&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.For.prototype.setIncrement=function(e){(this.inc=e)&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.For.prototype.setStatement=function(e){(this.statement=e)&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.For.prototype.generate=function(e,t,n){var r="for (";this.sstart?r+=this.sstart.generate(e,t,n)+" ":r+="; ",this.condition?r+=this.condition.generate(e,"scope",n)+"; ":r+="; ";var i=this.inc.generate(e,t,n);return r+=(i=";"==i.charAt(i.length-2)?i.slice(0,-2):i)+")\n",r+=this.statement.generate(e,t,n)},Eden.AST.For.prototype.getCondition=function(e,t){if(this.compiled&&0==this.dirty)return this.compiled;t=this.condition.generate(e,"scope",{bound:!1,usevar:"scriptexpr"==e.type,scope:t});e.dirty&&(this.dirty=!0,e.dirty=!1);t=new Function(["context","scope"],"return "+t+";");return this.compiled=t},Eden.AST.For.prototype.execute=function(e,t,n,r){if(this.executed=1,this.sstart&&"range"===this.sstart.type){void 0===this.list&&(this.sstart.second?(this.index=this.sstart.expression.execute(e,t,n,r),this.list=this.sstart.second.execute(e,t,n,r)):(this.list=this.sstart.expression.execute(e,t,n,r),this.index=0));t=this.sstart.lvalue.getSymbol(e,t,n);if(this.sstart.second)return this.index<=this.list?(t.assign(this.index,n,this),this.index++,[this.statement,this]):(this.index=0,void(this.list=void 0));if(Array.isArray(this.list))return this.index<this.list.length?(t.assign(this.list[this.index],n,this),this.index++,[this.statement,this]):(this.index=0,void(this.list=void 0))}else if(this.sstart&&!this.started)return this.started=!0,[this.sstart,this];if(!this.condition||this.getCondition(e,n)(n.context,n))return this.inc?[this.statement,this.inc,this]:[this.statement,this];this.started=!1},Eden.AST.registerStatement(Eden.AST.For),Eden.AST.FunctionCall=function(){this.type="functioncall",Eden.AST.BaseStatement.apply(this),Eden.AST.BaseExpression.apply(this),this.lvalue=void 0,this.params=void 0},Eden.AST.FunctionCall.prototype.setParams=function(e){this.params=e;for(var t=0;t<e.length;t++)this.mergeExpr(e[t]);this.typevalue=0,this.isconstant=!1},Eden.AST.FunctionCall.prototype.left=function(e){0<(this.lvalue=e).errors.length&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.FunctionCall.prototype.toEdenString=function(e,t){var n="(";if(this.params)for(var r=0;r<this.params.length;++r)0<r&&(n+=", "),n+=this.params[r].toEdenString(e,t);return n+")"},Eden.AST.FunctionCall.prototype.generateArgs=function(e,t,n){var r="[";if(this.params)for(var i=0;i<this.params.length;i++)r+="("+this.params[i].generate(e,t,n)+")",i!=this.params.length-1&&(r+=",");return r+"]"},Eden.AST.FunctionCall.prototype.generate=function(e,t,n){if(void 0===this.lvalue){var r=`(${t}).call(this`;if(this.params)for(var i=0;i<this.params.length;i++)r+=",",r+="("+this.params[i].generate(e,t,n)+")";return r+")"}var s=this.lvalue.generate(e,t,n),r=`${t}.value(${s})(${t}).call(scope.lookup(${s}).symbol`;if(this.params)for(i=0;i<this.params.length;i++)r+=",",r+="("+this.params[i].generate(e,t,n)+")";return r+");"},Eden.AST.registerExpression(Eden.AST.FunctionCall),Eden.AST.FunctionCall.prototype.execute=function(ctx,base,scope,agent){if(this.lvalue){this.executed=1;var sym=this.lvalue.getSymbol(ctx,base,scope),argsstr=this.generateArgs(ctx,"scope",{scope:scope});try{var args=eval(argsstr);sym.value(scope)(scope).apply(sym,args)}catch(e){var err=new Eden.RuntimeError(scope.context,Eden.RuntimeError.FUNCCALL,this,e);this.errors.push(err),err.line=this.line,scope.context.instance.emit("error",[agent,err]),console.error(func)}}},Eden.AST.registerStatement(Eden.AST.FunctionCall),Eden.AST.Handle=function(e){console.log("MAKE HANDLE",e),this.name=e,this.cvalue=void 0,this.definition=void 0},Eden.AST.Handle.prototype.assign=function(e,t){console.log("HANDLE ASSIGN",this.name,e,t),t?t.lookup(this.name).value=e:this.cvalue=e},Eden.AST.Handle.prototype.define=function(e,t,n){console.log("HANDLE DEFINE",e),this.definition=e},Eden.AST.Handle.prototype.value=function(e){return console.log("HANDLE SCOPE",this.name,e,this.cvalue),this.definition?this.definition.call(this,e.context,e):e?e.lookup(this.name).value:this.cvalue},Eden.AST.If=function(){this.type="if",Eden.AST.BaseStatement.apply(this),this.condition="",this.statement=void 0,this.elsestatement=void 0,this.statements=[]},Eden.AST.registerStatement(Eden.AST.If),Eden.AST.If.prototype.setCondition=function(e){this.condition=e,this.errors.push.apply(this.errors,e.errors)},Eden.AST.If.prototype.setStatement=function(e){(this.statement=e)&&(this.statements.push(e),(e.parent=this).errors.push.apply(this.errors,e.errors),e.warning&&!this.warning&&(this.warning=e.warning))},Eden.AST.If.prototype.setElse=function(e){(this.elsestatement=e)&&(this.statements.push(e),(e.parent=this).errors.push.apply(this.errors,e.errors),e.warning&&!this.warning&&(this.warning=e.warning))},Eden.AST.If.prototype.generate=function(e,t,n){var r="if (";return r+=this.condition.generate(e,t,n),r+=") ",r+=this.statement.generate(e,t,n)+" ",this.elsestatement&&(r+="\nelse "+this.elsestatement.generate(e,t,n)+"\n"),r},Eden.AST.If.prototype.getCondition=function(e,t){var n="return ";return n+=this.condition.generate(e,"scope",{bound:!1,scope:t}),n+=";",new Function(["context","scope","ctx"],n)},Eden.AST.If.prototype.execute=function(e,t,n,r){return this.executed=1,this.getCondition(e,n)(n.context,n,e)?[this.statement]:(this.executed=2,this.elsestatement?[this.elsestatement]:void 0)},Eden.AST.Import=function(){this.type="import",Eden.AST.BaseStatement.apply(this),this.path=void 0,this.selector=void 0,this.statements=void 0},Eden.AST.Import.prototype.setPath=function(e){this.path=e},Eden.AST.registerStatement(Eden.AST.Import),Eden.AST.Index=function(){this.type="index",Eden.AST.BaseExpression.apply(this),this.expression=void 0,this.errors=[]},Eden.AST.Index.prototype.setExpression=function(e){0<(this.expression=e).errors.length&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Index.prototype.toEdenString=function(e,t){return`[${this.expression.toEdenString(e,t)}]`},Eden.AST.Index.prototype.generate=function(e,t,n){n=this.expression.generate(e,t,n);return"literal"==this.expression.type&&"NUMBER"==this.expression.datatype?"["+n+"-1]":"[rt.index("+n+")]"},Eden.AST.registerExpression(Eden.AST.Index),Eden.AST.Insert=function(){this.type="insert",Eden.AST.BaseStatement.apply(this),this.destination=void 0,this.index=void 0,this.value=void 0},Eden.AST.Insert.prototype.setDest=function(e){0<(this.destination=e).errors.length&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Insert.prototype.setIndex=function(e){0<(this.index=e).errors.length&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Insert.prototype.setValue=function(e){0<(this.value=e).errors.length&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Insert.prototype.generate=function(e,t,n){var r=this.index.generate(e,t,n),i=this.value.generate(e,t,n),n=this.destination.generate(e,t,n);return this.destination.islocal?n+".splice(rt.index("+r+"), 0, ("+i+"));":n+".mutate(scope, function(s) { scope.lookup(s.name).value.splice(rt.index("+r+"), 0, ("+i+")); }, this);"},Eden.AST.Insert.prototype.execute=function(e,t,n){this.executed=1;var r=this.index.execute(e,t,n),i=this.value.execute(e,t,n);r instanceof BoundValue&&(r=r.value),i instanceof BoundValue&&(i=i.value),n.context.lookup(this.destination.name).mutate(n,function(e){e.value().splice(r-1,0,i)},this)},Eden.AST.registerStatement(Eden.AST.Insert),Eden.AST.Length=function(){this.type="length",Eden.AST.BaseExpression.apply(this),this.l=void 0,this.typevalue=Eden.AST.TYPE_NUMBER},Eden.AST.Length.prototype.left=function(e){this.l=e,this.mergeExpr(e),this.typevalue=Eden.AST.TYPE_NUMBER},Eden.AST.Length.prototype.toEdenString=function(e,t){return`${this.l.toEdenString(e,t)}#`},Eden.AST.Length.prototype.generate=function(e,t,n){return"rt.length("+this.l.generate(e,t,n)+")"},Eden.AST.registerExpression(Eden.AST.Length),Eden.AST.Literal=function(e,t){switch(this.type="literal",Eden.AST.BaseStatement.apply(this),Eden.AST.BaseExpression.apply(this),this.datatype=e,this.value=t,e){case"NUMBER":this.typevalue=Eden.AST.TYPE_NUMBER;break;case"LIST":this.typevalue=Eden.AST.TYPE_LIST;break;case"OBJECT":this.typevalue=Eden.AST.TYPE_OBJECT;break;case"STRING":case"CHARACTER":this.typevalue=Eden.AST.TYPE_STRING;break;case"BOOLEAN":this.typevalue=Eden.AST.TYPE_BOOLEAN;break;case"NODE":this.typevalue=Eden.AST.TYPE_AST;break;default:this.typevalue=Eden.AST.TYPE_UNKNOWN}},Eden.AST.Literal.prototype.toEdenString=function(e,t){switch(this.datatype){case"NUMBER":return Eden.edenCodeForValue(this.value);case"LIST":for(var n="[",r=0;r<this.value.length;r++)n+=this.value[r].toEdenString(e,t),r!=this.value.length-1&&(n+=",");return n+"]";case"OBJECT":n="[";for(var i=Object.keys(this.value),r=0;r<i.length;++r)n+=i[r]+": ",n+=this.value[i[r]].toEdenString(e,t),r!=i.length-1&&(n+=",");return n+"]";case"CHARACTER":case"STRING":return Eden.edenCodeForValue(this.value);case"BOOLEAN":return this.value?"true":"false";case"JAVASCRIPT":return"${{"+this.value+"}}$";case"UNDEFINED":return"@";case"NODE":return`parse(${JSON.stringify(this.value.getSource())})`}return"@"},Eden.AST.Literal.prototype.generate=function(e,t,n){switch(this.datatype){case"NUMBER":r=this.value;break;case"LIST":for(var r="[",i=0;i<this.value.length;i++)r+=this.value[i].generate(e,t,n),i!=this.value.length-1&&(r+=",");r+="]";break;case"OBJECT":r="{";for(var s=Object.keys(this.value),i=0;i<s.length;++i)r+=s[i]+": ",r+=this.value[s[i]].generate(e,t,n),i!=s.length-1&&(r+=",");r+="}";break;case"CHARACTER":case"STRING":r=JSON.stringify(this.value);break;case"BOOLEAN":case"JAVASCRIPT":r=this.value;break;case"UNDEFINED":break;case"NODE":r=`Eden.AST.parseStatement(${JSON.stringify(this.value.getSource())})`}return r},Eden.AST.registerExpression(Eden.AST.Literal),Eden.AST.Literal.prototype.execute=function(ctx,base,scope){switch(this.datatype){case"NUMBER":case"CHARACTER":case"BOOLEAN":return eval(this.value);case"STRING":return eval('"'+this.value+'"');case"OBJECT":case"LIST":var rhs="return ";return rhs+=this.generate(ctx,"scope",{bound:!1,scope:scope}),rhs+=";",new Function(["context","scope"],rhs)(scope.context,scope);case"JAVASCRIPT":return eval(this.value);case"NODE":return this.value}},Eden.AST.registerStatement(Eden.AST.Literal),Eden.AST.LList=function(){this.type="lvaluelist",this.errors=[],this.llist=[]},Eden.AST.LList.prototype.append=function(e){this.llist.push(e),this.errors.push.apply(this.errors,e.errors)},Eden.AST.LList.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.Local=function(e){this.name=e,this.cvalue=void 0,this.definition=void 0},Eden.AST.Local.prototype.assign=function(e,t){t=t.lookup2(this.name);t.value=e,t.up_to_date=!0},Eden.AST.Local.prototype.define=function(e,t,n){this.definition=e},Eden.AST.Local.prototype.value=function(e){return e||console.error("Missing scope in local read"),this.definition?this.definition.call(this,e.context,e):e.lookup2(this.name).value},Eden.AST.LValue=function(){this.type="lvalue",Eden.AST.BaseExpression.apply(this),this.name=void 0,this.express=void 0,this.primary=void 0,this.lvaluep=void 0,this.islocal=!1,this.source="",this.isstatic=!1},Eden.AST.LValue.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.LValue.prototype.isDynamic=function(){return void 0!==this.express},Eden.AST.LValue.prototype.toEdenString=function(e,t){if(this.name)return this.name;if(this.primary)return this.primary.toEdenString(e,t);if(this.express){var n={dependencies:{},isconstant:!0,scopes:[],locals:t.locals},r="return "+this.express.generate(n,"scope",{bound:!1,scope:e})+";";return n.isconstant?new Function(["context","scope"],r)(e.context,e):"`"+this.express.toEdenString(e,t)+"`"}},Eden.AST.LValue.prototype.setAttributes=function(e){for(var t in e)switch(t){case"static":this.isstatic=!0;break;case"number":this.typevalue=Eden.AST.TYPE_NUMBER;break;case"string":this.typevalue=Eden.AST.TYPE_STRING;break;case"boolean":this.typevalue=Eden.AST.TYPE_BOOLEAN;break;case"list":this.typevalue=Eden.AST.TYPE_LIST;break;case"any":this.typevalue=0;break;case"object":this.typevalue=Eden.AST.TYPE_OBJECT;break;default:return!1}return!0},Eden.AST.LValue.prototype.setExtras=function(e){if(this.lvaluep=e)for(var t=0;t<e.length;t++)this.errors.push.apply(this.errors,e[t].errors),!this.warning&&e[t].warning&&(this.warning=e[t].warning)},Eden.AST.LValue.prototype.setObservable=function(e){this.name=e},Eden.AST.LValue.prototype.setPrimary=function(e){(this.primary=e)&&0<e.errors.length&&this.errors.push.apply(this.errors,e.errors),!this.warning&&e.warning&&(this.warning=e.warning),e&&"unaryop"===e.type&&(this.primary=e.r)},Eden.AST.LValue.prototype.setExpression=function(e){(this.express=e)&&0<e.errors.length&&this.errors.push.apply(this.errors,e.errors),!this.warning&&e.warning&&(this.warning=e.warning)},Eden.AST.LValue.prototype.setBackticks=Eden.AST.LValue.prototype.setExpression,Eden.AST.LValue.prototype.getSymbol=function(e,t,n){if(e&&e.locals&&"declarations"!=e.locals.type&&e.locals.hasOwnProperty(this.name))return this.islocal=!0,e.locals[this.name];if(this.name)return n.context.lookup(this.name);if(this.primary)return this.primary.execute(e,t,n);if(this.express){t=this.express.execute(e,t,n);if(Eden.isValidIdentifier(t))return n.context.lookup(t);throw new Eden.RuntimeError(n.context,Eden.RuntimeError.IDENTIFIER,this,"Bad identifier - "+t)}},Eden.AST.LValue.prototype.hasListIndices=function(){return this.lvaluep&&0<this.lvaluep.length&&"index"==this.lvaluep[0].kind},Eden.AST.LValue.prototype.generateCompList=function(e,t,n){for(var r="[",i=0;i<this.lvaluep.length;i++)r+="rt.index("+this.lvaluep[i].indexexp.generate(e,t,n)+")",i<this.lvaluep.length-1&&(r+=",");return r+="]"},Eden.AST.LValue.prototype.generateIndexList=function(e,t,n){for(var r="[",i=0;i<this.lvaluep.length;i++)r+="rt.index("+this.lvaluep[i].indexexp.generate(e,t,n)+")",i<this.lvaluep.length-1&&(r+="][");return r+="]"},Eden.AST.LValue.prototype.generateIdStr=function(){return'"'+this.generateCompList()+'"'},Eden.AST.LValue.prototype.executeCompList=function(e,t){for(var n,r=[],i=0;i<this.lvaluep.length;i++)"index"==this.lvaluep[i].kind&&(n=this.lvaluep[i].indexexp.generate(e,"scope",{bound:!1}),r.push(rt.index(new Function(["context","scope"],"return "+n+";")(t.context,t))));return r},Eden.AST.LValue.prototype.generate=function(e,t,n){if(this.name){if(e&&e.locals){if("declarations"==e.locals.type&&-1!=e.locals.list.indexOf(this.name)){this.islocal=!0;for(var r=this.name,i=0;i<this.lvaluep.length;i++)r+=this.lvaluep[i].generate(e,t,n);return r}if(e.locals.hasOwnProperty(this.name)){this.islocal=!0;for(r=this.name,i=0;i<this.lvaluep.length;i++)r+=this.lvaluep[i].generate(e,t,n);return r}}if(e&&e.params&&-1!=e.params.list.indexOf(this.name)){this.islocal=!0;for(r=this.name,i=0;i<this.lvaluep.length;i++)r+=this.lvaluep[i].generate(e,t,n);return r}return'"'+this.name+'"'}return this.primary?this.primary.generate(e,t,n):this.express?this.express.generate(e,t,n):void 0},Eden.AST.registerExpression(Eden.AST.LValue),Eden.AST.LValueComponent=function(e){this.type="lvaluecomponent",Eden.AST.BaseExpression.apply(this),this.kind=e,this.indexexp=void 0,this.observable=void 0},Eden.AST.LValueComponent.prototype.toEdenString=function(e,t){return""},Eden.AST.LValueComponent.prototype.index=function(e){this.indexexp=e,this.errors.push.apply(this.errors,e.errors)},Eden.AST.LValueComponent.prototype.property=function(e){this.observable=e},Eden.AST.LValueComponent.prototype.generate=function(e,t,n){if("index"==this.kind)return"[rt.index("+this.indexexp.generate(e,t,n)+")]"},Eden.AST.registerExpression(Eden.AST.LValueComponent),Eden.AST.Modify=function(e,t){this.type="modify",Eden.AST.BaseContext.apply(this),this.errors=t?t.errors:[],this.kind=e,this.expression=t,this.lvalue=void 0,t&&t.warning&&(this.warning=t.warning)},Eden.AST.Modify.prototype.left=function(e){0<(this.lvalue=e).errors.length&&this.errors.push.apply(this.errors,e.errors),!this.warning&&e.warning&&(this.warning=e.warning)},Eden.AST.Modify.prototype.generate=function(e,t,n){var r,i=this.lvalue.generate(e,t),s=i;return 0==this.lvalue.islocal?s=t+".assign("+i+","+t+".value("+i+")":s+=" = "+i,this.expression&&(r=this.expression.generate(e,t,{bound:!1,usevar:"scriptexpr"==e.type})),"+="==this.kind?s+=" + "+r:"-="==this.kind?s+=" - "+r:"/="==this.kind?s+=" / "+r:"*="==this.kind?s+=" * "+r:"++"==this.kind?s+="+1":"--"==this.kind&&(s+="-1"),0==this.lvalue.islocal?s=`${s}, ${n.symbol?"this":"EdenSymbol.localJSAgent"});\n`:s+=";\n",s},Eden.AST.Modify.prototype.execute=function(e,t,n,r){this.executed=1;var i=this.lvalue.getSymbol(e,t,n);if("++"==this.kind){var s=i.value(n)+1;i.assign(s,n,this)}else if("--"==this.kind){s=i.value(n)-1;i.assign(s,n,this)}else{var e={statement:this,symbol:i,isconstant:!0,dependant:!1,locals:e.locals},e=Eden.AST.transpileExpressionNode(this.expression,n,e),o=new Function(["context","scope","cache"],e).call(i,n.context,n,n.lookup(i.name));switch(this.kind){case"+=":s=rt.add(i.value(n),o);break;case"-=":s=rt.subtract(i.value(n),o);break;case"/=":s=rt.divide(i.value(n),o);break;case"*=":s=rt.multiply(i.value(n),o);break;case"//=":s=rt.concat(i.value(n),o)}i.assign(s,n,this)}},Eden.AST.registerStatement(Eden.AST.Modify),Eden.AST.Parameter=function(e){this.type="parameter",this.index=e,this.errors=[],console.error("DEPRECATED PARAMETER")},Eden.AST.Parameter.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.Parameter.prototype.generate=function(e,t,n){if(-1==this.index){if(e&&e.parameters)return""+e.parameters.length;this.returnsbound=!1,r="0"}else if(e&&e.parameters){e.dirty=!0;var r=e.parameters[this.index-1];return this.returnsbound=r instanceof BoundValue,"ctx.parameters["+this.index+"-1]"}},Eden.AST.Primary=function(){this.type="primary",Eden.AST.BaseExpression.apply(this),this.observable="",this.extras=[],this.backtick=void 0,this.isconstant=!1,this.isstatic=!1,this.isrequired=!1,this.attrib=""},Eden.AST.Primary.prototype.setBackticks=function(e){this.backtick=e,this.mergeExpr(e),this.typevalue=Eden.AST.TYPE_UNKNOWN,this.isdynamic=!0},Eden.AST.Primary.prototype.setObservable=function(e){this.observable=e},Eden.AST.Primary.prototype.getObservable=function(){return this.observable},Eden.AST.Primary.prototype.prepend=function(e){this.extras.unshift(e),0<e.errors.length&&this.errors.push.apply(this.errors,e.errors),e.warning&&!this.warning&&(this.warning=e.warning)},Eden.AST.Primary.prototype.setAttributes=function(e){for(var t in e)switch(t){case"changed":case"source":case"expression":case"dependencies":case"subscribers":this.attrib=t;break;case"static":this.isstatic=!0;break;case"require":this.isrequired=!0;break;case"number":if(0!=this.typevalue)return!1;this.typevalue=Eden.AST.TYPE_NUMBER;break;case"string":if(0!=this.typevalue)return!1;this.typevalue=Eden.AST.TYPE_STRING;break;case"boolean":if(0!=this.typevalue)return!1;this.typevalue=Eden.AST.TYPE_BOOLEAN;break;case"object":if(0!=this.typevalue)return!1;this.typevalue=Eden.AST.TYPE_OBJECT;break;case"list":if(0!=this.typevalue)return!1;this.typevalue=Eden.AST.TYPE_LIST;break;default:return!1}return!0},Eden.AST.Primary.prototype.toEdenString=function(e,t){var n;if(t.isconstant=!1,"__BACKTICKS__"==this.observable){var r={dependencies:{},isconstant:!0,scopes:[],locals:t.locals},i="return "+this.backtick.generate(r,"scope",{bound:!1,scope:e})+";";if(r.isconstant){i=new Function(["context","scope"],i)(e.context,e);if(!Eden.isValidIdentifier(i))return"__error__";n=i}else n="`"+this.backtick.toEdenString(e,t)+"`"}else n=this.observable,t.locals&&t.locals.hasOwnProperty(n)&&(t.isconstant=!0);for(var s=0;s<this.extras.length;s++)"index"==this.extras[s].type&&(n+="["),n+=this.extras[s].toEdenString(e,t),"index"==this.extras[s].type&&(n+="]");return n},Eden.AST.Primary.prototype._checkFunction=function(e){var t=e.context.lookup(this.observable);return!!(t.origin&&t.origin.isstatic&&e.context.f.hasOwnProperty("func_"+this.observable))&&(console.log("has static function: "+this.observable),!0)},Eden.AST.Primary.prototype.generate=function(e,t,n){var r,i,s;if(e&&e.locals)if("declarations"==e.locals.type){if(-1!=e.locals.list.indexOf(this.observable))return i=this.observable}else if(e.locals.hasOwnProperty(this.observable))return e.dirty=!0,n.usevar?i=this.observable:n.indef?i=JSON.stringify(e.locals[this.observable].value(n.scope)):(r=e.locals[this.observable].value(n.scope),i=`${t}.value("${this.observable}")`,void 0===r&&console.error("Local variable undefined",this.observable)),i;if(e&&e.params&&-1!=e.params.list.indexOf(this.observable))return i=this.observable;if("__BACKTICKS__"==this.observable){e&&(s=e.isconstant,e.isconstant=!0,e.dynamic_source);var o=this.backtick.generate(e,t,n);if(!e||e.isconstant||"definition"!=e.type){if(e&&e.isconstant&&"definition"==e.type){try{o=new Function("return "+o+";")()}catch(e){return console.error(e),'"__error__"'}this.isstatic||(e.dependencies[o]=!0),s=!1,Eden.isValidIdentifier(o)||(o="__error__"),o=JSON.stringify(o)}i=o}else i=this.isstatic?o:"this.subscribeDynamic(0,"+o+", "+t+")";e&&(e.isconstant=s)}else e&&e.dependencies&&!this.isstatic&&(e.dependencies[this.observable]=!0,e.isconstant=!1),i='"'+this.observable+'"';if(0===this.attrib.length)if(0!=this.typevalue)switch(this.typevalue){case Eden.AST.TYPE_NUMBER:i=`${t}.assertNumber(${i},this)`;break;case Eden.AST.TYPE_STRING:i=`${t}.assertString(${i},this)`;break;case Eden.AST.TYPE_LIST:i=`${t}.assertList(${i},this)`;break;case Eden.AST.TYPE_OBJECT:i=`${t}.assertObject(${i},this)`;break;case Eden.AST.TYPE_BOOLEAN:i=`${t}.assertBoolean(${i},this)`}else i=this.isrequired?`${t}.assertValid(${i},this)`:t+".value("+i+")";else switch(this.attrib){case"changed":i=`${t}.symbol(${i}).hasChanged()`;break;case"source":i=`${t}.symbol(${i}).getSource()`;break;default:i=t+".value("+i+")"}return i},Eden.AST.registerExpression(Eden.AST.Primary),Eden.AST.Range=function(e){this.type="range",Eden.AST.BaseStatement.apply(this),this.parent=void 0,this.errors=e?e.errors:[],this.expression=e,this.lvalue=void 0,this.start=0,this.end=0,this.second=null},Eden.AST.Range.prototype.setSource=function(e,t){this.start=e,this.end=t},Eden.AST.Range.prototype.setSecond=function(e){(this.second=e)&&e.errors&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Range.prototype.left=function(e){0<(this.lvalue=e).errors.length&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Range.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.registerStatement(Eden.AST.Range),Eden.AST.Require=function(){this.type="require",Eden.AST.BaseStatement.apply(this),this.expression=void 0},Eden.AST.Require.prototype.setExpression=function(e){0<(this.expression=e).errors.length&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Require.prototype.generate=function(e,t,n){return"edenUI.loadPlugin("+this.expression.generate(e,t,n)+");"},Eden.AST.Require.prototype.execute=function(e,t,n){this.executed=1,edenUI.loadPlugin(this.expression.execute(e,t,n))},Eden.AST.registerStatement(Eden.AST.Require),Eden.AST.Return=function(){this.type="return",Eden.AST.BaseStatement.apply(this),this.result=void 0},Eden.AST.Return.prototype.setResult=function(e){this.result=e,this.errors.push.apply(this.errors,e.errors)},Eden.AST.Return.prototype.toEdenString=function(e,t){return`return ${this.result.toEdenString(e,t)};`},Eden.AST.Return.prototype.generate=function(e,t,n){return this.result?"return "+this.result.generate(e,t,n)+";\n":"return;\n"},Eden.AST.Return.prototype.execute=function(e,t,n,r){return e.result=this.result.execute(e,t,n,r),-1},Eden.AST.registerStatement(Eden.AST.Return),Eden.AST.Scope=function(){this.type="scope",Eden.AST.BaseExpression.apply(this),this.range=!1,this.overrides={},this.expression=void 0},Eden.AST.Scope.prototype.prepend=function(e){this.primary.prepend(e)},Eden.AST.Scope.prototype.setExpression=function(e){this.expression=e,this.mergeExpr(e),this.isscoped=!0},Eden.AST.Scope.prototype.addOverride=function(e,t,n,r,i){this.errors.push.apply(this.errors,e.errors),i&&(this.range=!0),r?(this.range=!0,this.overrides[e.observable]={start:t,end:r,increment:n,components:e.components,isin:i},this.errors.push.apply(this.errors,t.errors),this.errors.push.apply(this.errors,n.errors),this.errors.push.apply(this.errors,r.errors)):n?(this.range=!0,this.overrides[e.observable]={start:t,end:n,components:e.components,isin:i},this.errors.push.apply(this.errors,t.errors),this.errors.push.apply(this.errors,n.errors)):t&&(this.overrides[e.observable]={start:t,end:void 0,components:e.components,isin:i},this.errors.push.apply(this.errors,t.errors))},Eden.AST.Scope.prototype.toEdenString=function(e,t){var n="("+this.expression.toEdenString(e,t)+" with ";if(t.isconstant)return n;var r,i=!0;for(r in this.overrides){var s=this.overrides[r],o=r,a={isconstant:!0,locals:t.locals};i||(o=", "+o),i=!1,s.isin||s.end?o+=" in ":o+=" = ";var d=s.start.toEdenString(e,a);a.isconstant?o+=Eden.AST.executeExpressionNode(s.start,e,a):o+=d,a.isconstant=!0,s.increment&&(o+=".."+s.increment.toEdenString(e,t)),s.end&&(o+=".."+s.end.toEdenString(e,t)),n+=o}return n+")"},Eden.AST.Scope.prototype.generateConstructor=function(e,t,n){var r,i="new Eden.Scope(context, "+t+", [";for(r in this.overrides){var s=this.overrides[r],o=(this.range,s.start.generate(e,t,n));i+='new Eden.ScopeOverride("'+r+'", '+o,s.end?(o=this.overrides[r].end.generate(e,t,n),s.increment?i+=", "+o+", "+s.increment.generate(e,t,n)+"),":i+=", "+o+"),"):i+=", undefined, undefined, "+s.isin+"),"}return i=i.slice(0,-1),i+="], "+this.range+", this,true)"},Eden.AST.Scope.prototype._generate_plain_range=function(e,t){var n="_scopes["+(e.scopes.length-1)+"]",r="(function() {\n";return r+=n+".range = false;\n",r+="var results = [];\n",r+="var scoperesults = [];\n",r+="while(true) {\n",r+="var val = "+this.expression.generate(e,"_scopes["+(e.scopes.length-1)+"]",t),t.bound&&(r+=";\n\tif (val.value !== undefined) scoperesults.push(val.scope);\n\tval = val.value"),r+=";\n",r+="if (val !== undefined) results.push(val);\n",r+="if ("+n+".next() == false) break;\n",r+="}\n"+n+".range = true;\n",t.bound?r+="if (cache) cache.scopes = scoperesults;\n return new BoundValue(results,"+n+");}).call(this)":r+="return results;}).call(this)",r},Eden.AST.Scope.prototype._generate_loop_opti=function(e,t,n){var r="_scopes["+(e.scopes.length-1)+"]",t=this.expression.generate(e,"_scopes["+(e.scopes.length-1)+"]",t);return`(function() {
		${r}.range = false;
		var looper = ${r}.overrides[${n[0]}];
		var ix = 0;
		var loopsize = looper.end - looper.start+1;
		if (loopsize <= 0 || loopsize > 1000000 || isNaN(loopsize)) return [];
		var results = new Array(loopsize);
		for (var i=looper.start; i<=looper.end; i++) {
			if (i>looper.start) ${r}.resetCache();
			looper.current = i;
			${r}.refresh();
			var val = ${t};
			if (val !== undefined) results[ix++] = val;
		}
		${r}.range = true;
		if (results.length > ix) results.length = ix;
		return results;
	}).call(this)`},Eden.AST.Scope.prototype.generate=function(e,t,n){e.scopes.push(this.generateConstructor(e,t,n));t="";if(this.range){var r,i=!1,s=[],o=0;for(r in this.overrides){if(!this.overrides[r].end){this.overrides[r].isin&&(i=!0);break}s.push(o),o++}t=i||1!=s.length?this._generate_plain_range(e,n):this._generate_loop_opti(e,n,s)}else n=this.expression.generate(e,"_scopes["+(e.scopes.length-1)+"]",n),t="async"==this.expression.type?"(function(){ var _r = "+n+"; _r.then(rr => { cache.value = rr; this.expireAsync(); }); return cache.value; }).call(this)":n;return t},Eden.AST.registerExpression(Eden.AST.Scope),Eden.AST.ScopedScript=function(e,t){this.type="scopedscript",this.statements=e,this.scope=t,this.errors=[]},Eden.AST.ScopedScript.prototype.execute=function(e,t,n,r){return this.statements},Eden.AST.ScopePath=function(){this.type="scopepath",this.errors=[],this.primary=void 0,this.path=new Eden.AST.Primary,this.scopestr=void 0},Eden.AST.ScopePath.prototype.prepend=function(e){this.path.prepend(e)},Eden.AST.ScopePath.prototype.setObservable=function(e){this.path.setObservable(e)},Eden.AST.ScopePath.prototype.setBackticks=function(e){this.path.setBackticks(e)},Eden.AST.ScopePath.prototype.getObservable=function(){return this.primary.getObservable()},Eden.AST.ScopePath.prototype.getScopeString=function(){return this.scopestr},Eden.AST.ScopePath.prototype.setPrimary=function(e){this.primary=e,0<this.primary.errors.length&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.ScopePath.prototype.generate=function(e,t,n){t=this.path.generate(e,t,{bound:!0,scopeonly:!0});return this.primary.generate(e,t,n)},Eden.AST.ScopePath.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.ScopePattern=function(){this.type="scopepattern",this.observable="NONAME",this.components=[],this.errors=[]},Eden.AST.ScopePattern.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.ScopePattern.prototype.setObservable=function(e){this.observable=e},Eden.AST.ScopePattern.prototype.addListIndex=function(e){this.components.push(e),e&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Script=function(){this.type="script",Eden.AST.BaseScript.apply(this),this.name=void 0,this.active=!1,this.base=void 0,this.prefix="",this.postfix="",this.readables=null,this.writables=null},Eden.AST.registerScript(Eden.AST.Script),Eden.AST.Script.prototype.getActionByName=function(e){for(var t=0;t<this.statements.length;t++)if("script"==this.statements[t].type&&this.statements[t].name==e)return this.statements[t]},Eden.AST.Script.prototype.getSource=function(){return this.prefix+this.getInnerSource()+this.postfix},Eden.AST.Script.prototype.getInnerSource=function(){for(var e="",t=0;t<this.statements.length;t++)e+=this.statements[t].getSource();return e},Eden.AST.Script.prototype.patchInner=function(e){for(var t=this;t.parent;)t=t.parent;this.source=null;for(var n=[],r=[],i=Eden.Selectors.getID(this),s={},o=0;o<this.statements.length;o++)void 0===s[(a=this.statements[o]).id]&&(s[a.id]=[]),s[a.id].push(a);for(var a,d,o=0;o<e.statements.length;o++)(a=e.statements[o]).buildID(),s[a.id]&&0<s[a.id].length?(e.replaceChild(o,s[a.id][0]),s[a.id].shift(),0==s[a.id].length&&delete s[a.id]):("dummy"!=a.type&&this.indexed&&a.addIndex(),"dummy"==a.type?n.push({index:o,path:i,source:a.getSource(),id:a.previousSibling?a.previousSibling.id:0,ws:!0}):n.push({index:o,path:i,source:a.getSource(),ws:!1}));for(d in s)for(var c=s[d],o=0;o<c.length;o++)"when"==c[o].type&&c[o].enabled&&eden.project.removeAgent(c[o]),"dummy"==c[o].type?r.push({path:i,id:c[o].previousSibling?c[o].previousSibling.id:0,ws:!0}):r.push({path:i,id:c[o].id,ws:!1}),this.indexed&&0==c[o].executed?c[o].removeIndex():c[o].destroy();if(void 0===this.parent)for(o=0;o<e.statements.length;o++)"script"==e.statements[o].type&&"ACTIVE"==e.statements[o].name?(e.statements[o]=eden.root,Eden.Index.remove(e.statements[o])):e.statements[o].parent=this;else for(o=0;o<e.statements.length;o++)e.statements[o].parent=this;if(this.statements=e.statements,this.subscribers)for(var h in this.subscribers)eden.root.expireEdenSymbol(this.subscribers[h]);return[n,r]},Eden.AST.Script.prototype.patchOuter=function(e){},Eden.AST.Script.prototype.getLine=function(){return this.line},Eden.AST.Script.prototype.isRemote=function(){for(var e=this;e.parent;)e=e.parent;return e.base.origin.remote},Eden.AST.Script.prototype.setLocals=function(e){(this.locals=e)&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Script.prototype.subscribeDynamic=function(e,t){return eden.root.lookup(t)},Eden.AST.Script.prototype.getParameterByNumber=function(e){if(this.parameters)return this.parameters[e-1]},Eden.AST.Script.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.Script.prototype.setName=function(e,t){this.name=t,this.shortName=t},Eden.AST.Script.prototype.setAttributes=function(e){return!0},Eden.AST.Script.prototype.setReadables=function(e){this.readables=e},Eden.AST.Script.prototype.setWritables=function(e){this.writables=e},Eden.AST.Script.prototype.setSource=function(e,t,n){if(this.start=e,this.end=t,n){0==this.statements.length||(this.prefix=n.substring(0,this.statements[0].start-e),this.postfix=n.substring(this.statements[this.statements.length-1].end-e));for(var r=this.numlines=0;r<this.prefix.length;r++)"\n"==this.prefix.charAt(r)&&this.numlines++;for(r=0;r<this.postfix.length;r++)"\n"==this.postfix.charAt(r)&&this.numlines++}},Eden.AST.Script.prototype.execute=function(e,t,n,r){var i=[];if(this.executed=1,this.locals&&0<this.locals.list.length){void 0===e.locals&&(e.locals={});for(var s=0;s<this.locals.list.length;s++)e.locals[this.locals.list[s]]=new Eden.AST.Local(this.locals.list[s])}for(s=0;s<this.statements.length;s++)"script"!=this.statements[s].type&&"section"!=this.statements[s].type&&i.push(this.statements[s]);return i},Eden.AST.Script.prototype.generate=function(e,t,n){for(var r="{\n",i=0;i<this.statements.length;i++)r+=this.statements[i].generate(e,t,n);return r+="}"},Eden.AST.Virtual=function(e){this.type="script",Eden.AST.BaseScript.apply(this),this.name=e},Eden.AST.Virtual.prototype.getSource=function(){return""},Eden.AST.Virtual.prototype.getInnerSource=function(){return""},Eden.AST.ScriptExpr=function(){this.type="scriptexpr",Eden.AST.BaseScript.apply(this),Eden.AST.BaseExpression.apply(this),this.script=null},Eden.AST.ScriptExpr.prototype.toEdenString=function(e,t){for(var n="func {\n",r=0;r<this.script.statements.length;r++)n+=this.script.statements[r].toEdenString(e,t)+"\n";return n+="}"},Eden.AST.ScriptExpr.prototype.setScript=function(e){(this.script=e)&&e.errors&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.ScriptExpr.prototype.generate=function(e,t,n){var r="if (!scope) { console.warn('No function scope'); throw 'No scope'; }\n";r+="var context = scope.context;\n";var i=Object.assign({},n);if(i.usevar=!0,!n.scope)throw console.error("Missing scope"),"Missing scope";for(var s,o,a={dependencies:e.dependencies,locals:{}},d=[],c=0;c<this.script.statements.length;c++)r+=this.script.statements[c].generate(a,"scope",i);for(s in a.locals)"oracle"==a.locals[s]&&d.push(s);void 0===n.funcindex&&(n.funcindex=0),n.symbol?(o=n.symbol.name,0!=n.funcindex++&&(o+=n.funcindex)):o=Math.random().toString(36).substr(2,9),r=`return function func_${o}(${d.join(",")}){ ${r} };`,this.script.setName(null,o),this.script.addIndex();try{var h=new Function(["scope"],r);n.scope.context.f["func_"+o]=h}catch(e){console.error("Func compile error: "+o,e,r)}return`context.f.func_${o}`},Eden.AST.registerScript(Eden.AST.ScriptExpr),Eden.AST.registerExpression(Eden.AST.ScriptExpr),Eden.AST.Subscribers=function(){this.type="subscribers",Eden.AST.BaseStatement.apply(this),this.list=[],this.lvalue=void 0},Eden.AST.Subscribers.prototype.left=function(e){0<(this.lvalue=e).errors.length&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Subscribers.prototype.execute=function(e,t,n){},Eden.AST.Subscribers.prototype.setList=function(e){this.list=e},Eden.AST.registerStatement(Eden.AST.Subscribers),Eden.AST.SubStatement=function(){this.type="substat",Eden.AST.BaseStatement.apply(this),this.kind="parse",this.expression=void 0,this.last=null},Eden.AST.SubStatement.prototype.setOperation=function(e,t){(this.expression=t)&&0<t.errors.length&&this.errors.push.apply(this.errors,t.errors)},Eden.AST.SubStatement.prototype.toEdenString=function(e,t){return Eden.AST.executeExpressionNode(this.expression,e,t)},Eden.AST.SubStatement.prototype.generate=function(e,t,n){var r={isconstant:!0,locals:e.locals,scope:n.scope,symbol:n.symbol},i=Eden.AST.executeExpressionNode(this.expression,n.scope,r),r=Eden.AST.parseStatement(i);return console.log("PARSE STRING = "+i,r),r.generate(e,t,n)},Eden.AST.SubStatement.prototype.execute=function(e,t,n,r){this.executed=1;e={isconstant:!0,locals:e.locals,scope:n},e=Eden.AST.executeExpressionNode(this.expression,n,e),e=Eden.AST.parseStatement(e);return 0==e.errors.length&&(e.parent=this.parent,e.nextSibling=this.nextSibling,e.previousSibling=this.previousSibling,e.generated=this,e.buildID(),this.last&&this.last.id!==e.id?("when"===this.last.type&&this.last.enabled&&(console.warn("When disable is needed"),eden.project.removeAgent(this.last)),this.last.destroy(),"script"===this.last.type&&this.last.name&&this.parent&&"script"===this.parent.type&&delete this.parent.subscripts[this.last.name],(this.last=e).addIndex()):this.last||((this.last=e).addIndex(),"script"===e.type&&e.name&&this.parent&&"script"===this.parent.type&&(e.lock=1,this.parent.subscripts[e.name]=e))),0==e.errors.length?[e]:[]},Eden.AST.registerStatement(Eden.AST.SubStatement),Eden.AST.SubStatement.prototype.destroy=function(){this.last&&("when"===this.last.type&&this.last.enabled&&(console.warn("When disable is needed"),eden.project.removeAgent(this.last)),this.last.destroy()),Eden.AST.BaseStatement.destroy.call(this)},Eden.AST.Switch=function(){this.type="switch",Eden.AST.BaseStatement.apply(this),this.expression="",this.statement=void 0,this.compiled=void 0},Eden.AST.Switch.prototype.setExpression=function(e){(this.expression=e)&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Switch.prototype.setStatement=function(e){this.statement=e,this.errors.push.apply(this.errors,e.errors)},Eden.AST.Switch.prototype.generate=function(e,t){void 0===t&&(t="eden.root.scope");var n="switch(";return n+=this.expression.generate(e,t,{bound:!1}),n+=") "+this.statement.generate(e,t)},Eden.AST.Switch.prototype.getSelector=function(e){if(this.compiled)return this.compiled;var t="return ";return t+=this.expression.generate(e,"scope",{bound:!1}),t+=";",this.compiled=new Function(["context","scope"],t),this.compiled},Eden.AST.Switch.prototype.execute=function(e,t,n,r){n=new Eden.RuntimeError(n.context,Eden.RuntimeError.NOTSUPPORTED,this,"Switch not supported here");n.line=this.line,this.errors.push(n),Eden.Agent.emit("error",[r,n])},Eden.AST.registerStatement(Eden.AST.Switch),Eden.AST.TernaryOp=function(e){this.type="ternaryop",Eden.AST.BaseExpression.apply(this),this.op=e,this.first=void 0,this.second=void 0,this.condition=void 0},Eden.AST.TernaryOp.prototype.setFirst=function(e){this.first=e,this.mergeExpr(e)},Eden.AST.TernaryOp.prototype.setSecond=function(e){this.second=e,this.mergeExpr(e)},Eden.AST.TernaryOp.prototype.setCondition=function(e){(this.condition=e)&&(this.isconstant=this.isconstant&&e.isconstant,this.isdependant=this.isdependant||e.isdependant,this.isdynamic=this.isdynamic||e.isdynamic,0<e.errors.length&&this.errors.push.apply(this.errors,e.errors),e.warning&&!this.warning&&(this.warning=e.warning))},Eden.AST.TernaryOp.prototype.left=function(e){void 0===this.condition?this.setCondition(e):this.setFirst(e)},Eden.AST.TernaryOp.prototype.toEdenString=function(e,t){return`(${this.first.toEdenString(e,t)} if ${this.condition.toEdenString(e,t)} else ${this.second.toEdenString(e,t)})`},Eden.AST.TernaryOp.prototype.generate=function(e,t,n){var r=this.first.generate(e,t,n);return"(("+this.condition.generate(e,t,n)+")?("+r+"):("+this.second.generate(e,t,n)+"))"},Eden.AST.registerExpression(Eden.AST.TernaryOp),Eden.AST.UnaryOp=function(e,t){switch(this.type="unaryop",Eden.AST.BaseExpression.apply(this),this.op=e,this.r=t,this.mergeExpr(t),e){case"&":this.typevalue=Eden.AST.TYPE_SYMBOL;break;case"!":this.typevalue=Eden.AST.TYPE_BOOLEAN;break;case"-":this.typevalue=Eden.AST.TYPE_NUMBER;break;case"*":this.typevalue=Eden.AST.TYPE_UNKNOWN,this.isconstant=!1,this.isdynamic=!0;break;case"sub":this.isdependant=!0,this.isconstant=!0,this.isdynamic=!1;break;case"compile":this.typevalue=Eden.AST.TYPE_STRING;break;case"parse":this.typevalue=Eden.AST.TYPE_AST}},Eden.AST.UnaryOp.prototype.toEdenString=function(e,t){if("sub"==this.op){var n=Eden.AST.executeExpressionNode(this.r,e,t),r=typeof n;return"object"==r&&n._is_eden_expression?n.toEdenString(e,t):n="object"==r&&n instanceof EdenSymbol?"&"+n.name:Eden.edenCodeForValue(n)}switch(this.op){case"*":case"&":return`${this.op}${this.r.toEdenString(e,t)}`;case"compile":case"eval":case"parse":case"!":case"-":return`${this.op}(${this.r.toEdenString(e,t)})`}},Eden.AST.UnaryOp.prototype.generate=function(e,t,n){if("sub"==this.op){var r={isconstant:!0,locals:e.locals},r=typeof(i=Eden.AST.executeExpressionNode(this.r,n.scope,r)),i="object"==r&&i._is_eden_expression?i.generate(e,t,n):"object"==r&&i instanceof EdenSymbol?`${t}.context.lookup("${i.name}")`:JSON.stringify(i);return e.dependant=!0,i}var s;e&&(s=e.isconstant,e.isconstant=!0);var o,a=this.r.generate(e,t,n),i=!1;if(e&&(i=e.isconstant,e.isconstant=s&&i),"compile"==this.op)return"scope.context.instance.transpileExpression("+a+", this, "+t+")";if("parse"==this.op)return"scope.context.instance.parseExpression("+a+", this)";if("eval"==this.op)return"scope.context.instance.evalEden("+a+", this, "+t+")";if("!"==this.op)o="!("+a+")";else if("&"==this.op){if(e&&e.dependencies&&!this.r.observable&&i){var d="ERROR";try{d=new Function(["context","scope"],"return "+a+";")(n.scope.context,n.scope)}catch(e){console.error("Backtick evaluation error",e)}a=d=JSON.stringify(d)}o="scope.context.lookup("+a+")"}else"-"==this.op?o="-("+a+")":"*"==this.op&&(o="this.subscribeDynValue(0, "+a+", "+t+")");return o},Eden.AST.registerExpression(Eden.AST.UnaryOp),Eden.AST.Wait=function(){this.type="wait",Eden.AST.BaseStatement.apply(this),this.delay=void 0,this.compiled_delay=void 0},Eden.AST.Wait.prototype.setDelay=function(e){(this.delay=e)&&0<e.errors.length&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Wait.prototype.compile=function(e){var t;void 0!==this.delay&&(this.compiled_delay||(t="return ",t+=this.delay.generate(e,"scope",{bound:!1}),t+=";",this.compiled_delay=new Function(["context","scope"],t)))},Eden.AST.Wait.prototype.generate=function(e,t,n){var r=new Eden.RuntimeError(n.scope.context,Eden.RuntimeError.NOTSUPPORTED,this,"Cannot use 'wait' here");return this.errors.push(r),n.scope.context.instance.emit("error",[EdenSymbol.defaultAgent,r]),""},Eden.AST.registerStatement(Eden.AST.Wait),Eden.AST.When=function(){this.type="when",Eden.AST.BaseContext.apply(this),this.name="*When",this.id=0,this.expression=void 0,this.active=!1,this.compiled=void 0,this.scope=void 0,this.nscope=void 0,this.compScope=void 0,this.local=!1,this.dirty=!1,this.statement=void 0,this.enabled=!1,this.statements=[],this.retrigger=!1,this.roles=null,this.triggercount=0,this.refreshtimeout=null,this.triggertimestamp=0},Eden.AST.registerContext(Eden.AST.When),Eden.AST.When.prototype.getSource=function(){return this.statement?this.prefix+this.statement.getSource()+this.postfix:this.prefix+this.postfix},Eden.AST.When.prototype.setSource=function(e,t,n){if(this.start=e,this.end=t,n){this.statement?(this.prefix=n.substring(0,this.statement.start-e),this.postfix=n.substring(this.statement.end-e)):(this.prefix=n.substring(0,t),this.postfix="");for(var r=this.numlines=0;r<this.prefix.length;r++)"\n"==this.prefix.charAt(r)&&this.numlines++;for(r=0;r<this.postfix.length;r++)"\n"==this.postfix.charAt(r)&&this.numlines++}},Eden.AST.When.prototype.getLine=function(){return this.line},Eden.AST.When.prototype.doDebug=function(){return this.doxyComment&&this.doxyComment.getControls()["@debug"]},Eden.AST.When.prototype.setScope=function(e){this.scope=e},Eden.AST.When.prototype.subscribeDynamic=function(e,t,n){return console.log("Subscribe Dyn: ",t,n),n.context.instance.project.addTrigger(this,t,n),n.context.lookup(t)},Eden.AST.When.prototype.setExpression=function(e){(this.expression=e)&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.When.prototype.setStatement=function(e){(this.statement=e)&&(this.statements.push(e),this.errors.push.apply(this.errors,e.errors),e.warning&&!this.warning&&(this.warning=e.warning))},Eden.AST.When.prototype.generate=function(e,t,n){var r=new Eden.RuntimeError(n.scope.context,Eden.RuntimeError.NOTSUPPORTED,this,"Cannot use 'when' here");return this.errors.push(r),n.scope.context.instance.emit("error",[EdenSymbol.defaultAgent,r]),""},Eden.AST.When.prototype.getScope=function(e){if(void 0===this.compScope)if(this.scope)try{this.compScope=new Function(["context","scope"],"var s = "+this.scope.generateConstructor(e,"scope",{bound:!1})+"; s.rebuild(); return s;")}catch(e){}else this.compScope=function(e,t){return 0===Object.keys(t.cache).length?t:new Eden.Scope(e,t,[],!1,null,!1)};return this.compScope},Eden.AST.When.prototype.compile=function(e,t){var n="try { return ";n+=this.expression.generate(this,"scope",{bound:!1,scope:t}),n+="; } catch(e) {}";try{this.compiled=new Function(["context","scope"],n)}catch(e){console.error("Error compiling when condition")}return""},Eden.AST.When.prototype.trigger=function(e,t){var n,r,i;this.enabled&&(n=eden.project.ast,0==this.active?(this.triggercount++,this.active=!0,e=this.getScope(this)(e.context,e),(r=this.executeReal(this,n,e))&&(void 0===eden.peer||eden.peer.authoriseWhen(this))?(this.triggertimestamp=t,i=this,n.executeStatements(r,-1,this,function(){i.active=!1,i.retrigger&&(i.retrigger=!1,setTimeout(function(){i.trigger(e,Date.now())},0))},this,e)):this.active=!1):this.retrigger=!0)},Eden.AST.When.prototype.executeReal=function(e,t,n){this.executed=1,this.compiled||this.compile(t,n),this.doxyComment&&this.doxyComment.getControls()["@local"]&&(this.local=!0),this.locals={};if(n.range){n.range=!1;for(var r=[];;){var i=n.clone();if(this.compiled.call(this,n.context,n)?r.push(new Eden.AST.ScopedScript(this.statement.statements,i)):this.executed=2,0==n.next())break}return n.range=!0,r}if(this.compiled.call(this,n.context,n))return n!==n.context.scope&&"script"==this.statement.type?[new Eden.AST.ScopedScript(this.statement.statements,n)]:[this.statement];this.executed=2},Eden.AST.When.prototype.execute=function(e,t,n,r){if(!this.enabled){this.doxyComment&&this.doxyComment.getControls()["@local"]&&(this.local=!0);let e=n.project();e&&e.registerAgent(this)}this.enabled=!0,n=this.nscope||this.getScope(this)(n.context,n),this.nscope=n,r&&!r.loading&&t.executeStatements(this.executeReal(e,t,n,r),-1,this,void 0,this,n)},Eden.AST.When.prototype.error=Eden.AST.fnEdenASTerror,Eden.AST.While=function(){this.type="while",Eden.AST.BaseStatement.apply(this),this.condition=void 0,this.statement=void 0,this.compiled=void 0},Eden.AST.While.prototype.setCondition=function(e){this.condition=e,this.errors.push.apply(this.errors,e.errors)},Eden.AST.While.prototype.setStatement=function(e){(this.statement=e)&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.While.prototype.generate=function(e,t,n){var r="while ("+this.condition.generate(e,t,n);return r+=") ",r+=this.statement.generate(e,t,n)+"\n"},Eden.AST.While.prototype.getCondition=function(ctx,scope){if(this.compiled)return this.compiled;var express=this.condition.generate(ctx,"scope",{bound:!1,scope:scope}),expfunc=eval("(function(context,scope){ return "+express+"; })");return this.compiled=expfunc,expfunc},Eden.AST.While.prototype.execute=function(e,t,n,r){if(this.executed=1,this.getCondition(e)(n.context,n))return[this.statement,this]},Eden.AST.registerStatement(Eden.AST.While),Eden.AST.Query=function(){this.type="query",Eden.AST.BaseStatement.apply(this),Eden.AST.BaseExpression.apply(this),this.selector=void 0,this.observable=void 0,this.restypes=[],this.modexpr=void 0,this.kind="=",this._expr=void 0,this._selector=null,this._modexpr=null},Eden.AST.Query.prototype.setSelector=function(e){(this.selector=e)&&0<e.errors.length&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Query.prototype.setResultTypes=function(e){this.restypes=e},Eden.AST.Query.prototype.setModify=function(e,t){this.modexpr=e,this.kind=t,e&&0<e.errors.length&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Query.prototype.generate=function(e,t,n){var r="",i=this.selector.generate(e,t,{bound:!1});if(this.modexpr){e=new Eden.RuntimeError(t.context,Eden.RuntimeError.NOTSUPPORTED,this,"Cannot use '?' on lhs here");return this.errors.push(e),n.scope.context.instance.emit("error",[EdenSymbol.defaultAgent,e]),""}return r=0==this.restypes.length?"Eden.Selectors.queryWithinSync(null, "+i+', "value", {minimum: 1, options: {self: this.origin}})':"Eden.Selectors.queryWithinSync(null, "+i+', "'+this.restypes.join(",")+'", {minimum: 1, options: {self: this.origin}})',n.bound?"new BoundValue("+r+","+t+")":r},Eden.AST.registerExpression(Eden.AST.Query),Eden.AST.Query.prototype.execute=function(t,n,e,r){if(this.executed=1,this.observable){var i=e.context.lookup(this.observable).value(e);return console.log(i),void(n.lastresult=i)}if(void 0===this.modexpr){if(this._expr)return this._expr;Eden.Selectors.query(this.selector.execute(t,n,e,r),this.restypes,{minimum:1},e=>{n.lastresult=e,this._expr=e[0],t.cb&&t.cb(e)})}else{var s=this.selector.execute(t,n,e,r),o=this.modexpr.execute(t,n,e,r);switch(this.kind){case"=":Eden.Selectors.assign(s,this.restypes,o);break;case"+=":Eden.Selectors.append(s,this.restypes,o);break;case"//=":Eden.Selectors.concat(s,this.restypes,o)}}},Eden.AST.registerStatement(Eden.AST.Query),Eden.AST.Alias=function(){this.type="script",Eden.AST.BaseStatement.apply(this),this.name=void 0,this.active=!1,this.selector=void 0,this._statements=null,this.lock=1,this.subscripts={}},Eden.AST.Alias.prototype.setName=function(e){this.name=e},Eden.AST.Alias.prototype.setSelector=function(e){(this.selector=e)&&0<e.errors.length&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Alias.prototype.setAttributes=function(e){return!0},Eden.AST.Alias.prototype.execute=function(e,t,n,r){var i=[];if(this.executed=1,this.locals&&0<this.locals.list.length){void 0===e.locals&&(e.locals={});for(var s=0;s<this.locals.list.length;s++)e.locals[this.locals.list[s]]=new Eden.AST.Local(this.locals.list[s])}for(s=0;s<this.statements.length;s++)"script"!=this.statements[s].type&&"section"!=this.statements[s].type&&i.push(this.statements[s]);return i},Eden.AST.Alias.prototype.generate=function(e,t,n){},Eden.AST.registerScript(Eden.AST.Alias),Eden.AST.Alias.prototype.getNumberOfLines=function(){return this.numlines},Object.defineProperty(Eden.AST.Alias.prototype,"statements",{get:function(){var e;return!this._statements&&this.selector&&(e=this.selector.execute(this,eden.project?eden.project.ast:{},eden.root.scope,this),Eden.Selectors.query(e,void 0,{minimum:1},e=>{1==e.length&&"script"==e[0].type?(this._statements=e[0].statements,e[0].parent=this.parent):this._statements=e;for(let e=0;e<this._statements.length;e++)"dummy"!=this._statements[e].type&&(this._statements[e].addIndex(),"script"===this._statements[e].type&&this._statements[e].name&&(this.subscripts[this._statements[e].name]=this._statements[e]))})),this._statements||[]}}),Eden.AST.Alias.addIndex=function(){this.buildID(),Eden.Index.update(this)},Eden.AST.Alias.removeIndex=function(){Eden.Index.remove(this)},Eden.AST.Alias.prototype.destroy=function(){if(this.executed<1&&Eden.Index.remove(this),this._statements)for(var e=0;e<this._statements.length;e++)this._statements[e].destroy();this.executed=-1,this._statements=void 0,this.base=void 0,this.parent=void 0,this.nextSibling=void 0,this.previousSibling=void 0},Eden.AST.Alias.prototype.getInnerSource=function(){for(var e="",t=0;t<this._statements.length;t++)e+=this._statements[t].getSource();return e},Eden.AST.Indexed=function(){this.type="indexed",Eden.AST.BaseExpression.apply(this),this.indexes=[],this.expression=void 0},Eden.AST.Indexed.prototype.left=Eden.AST.fnEdenASTleft,Eden.AST.Indexed.prototype.setExpression=function(e){this.expression=e,this.mergeExpr(e),this.typevalue=0},Eden.AST.Indexed.prototype.addIndex=function(e){this.indexes.push(e),this.mergeExpr(e)},Eden.AST.Indexed.prototype.toEdenString=function(e,t){for(var n="",r=0;r<this.indexes.length;r++)n+=this.indexes[r].toEdenString(e,t);return"("+this.expression.toEdenString(e,t)+")"+n},Eden.AST.Indexed.prototype.generate=function(e,t,n){for(var r="",i=0;i<this.indexes.length;i++)r+=this.indexes[i].generate(e,t,n);var s="("+this.expression.generate(e,t,n)+")"+r;return n.bound?"new BoundValue("+s+","+t+")":s},Eden.AST.registerExpression(Eden.AST.Indexed),Eden.AST.Section=function(){this.type="section",Eden.AST.BaseStatement.apply(this),this.name=void 0,this.depth=1},Eden.AST.Section.prototype.setName=function(e){e=(this.name=e).match(/#[\w]+/g);null!==e&&(void 0===this.tags?this.tags=e:this.tags=this.tags.concat(e))},Eden.AST.Section.prototype.generate=function(e,t){return""},Eden.AST.Section.prototype.execute=function(e,t,n,r){for(var i=[],s=this.nextSibling;s&&("section"!=s.type||s.depth>this.depth);)"dummy"!=s.type&&"script"!=s.type&&"section"!=s.type&&i.push(s),s=s.nextSibling;return i},Eden.AST.registerStatement(Eden.AST.Section),Eden.AST.Section.prototype.getRange=function(e){for(var t=this.getStartLine(e),n=this.nextSibling;n&&n.nextSibling&&("section"!=n.nextSibling.type||n.nextSibling.depth>this.depth);)n=n.nextSibling;return[t,(n=n&&"dummy"==n.type?n.previousSibling:n)?n.getEndLine(e):t+this.getNumberOfLines()]},Eden.AST.CustomBlock=function(){this.type="custom",Eden.AST.BaseStatement.apply(this),this.name=null,this.text=null},Eden.AST.CustomBlock.prototype.setName=function(e){e=(this.name=e).match(/#[\w]+/g);null!==e&&(void 0===this.tags?this.tags=e:this.tags=this.tags.concat(e))},Eden.AST.CustomBlock.prototype.generate=function(e,t){return""},Eden.AST.CustomBlock.prototype.execute=function(e,t,n,r){this.executed=1,n.context.lookup("script_"+this.name+"_execute").assign(this.text,n);return[]},Eden.AST.registerStatement(Eden.AST.CustomBlock),Eden.AST.Async=function(){this.type="async",Eden.AST.BaseExpression.apply(this),this.expression=null},Eden.AST.Async.prototype.setExpression=function(e){(this.expression=e)&&0<e.errors.length&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.Async.prototype.generate=function(e,t){return this.expression.generate(e,t,{bound:!1})},Eden.AST.Async.prototype.execute=function(e,t,n){},Eden.AST.registerExpression(Eden.AST.Async);var htmltags={h1:!0,h2:!0,h3:!0,h4:!0,h5:!0,h6:!0,input:!0,form:!0,p:!0,div:!0,span:!0,b:!0,i:!0,ul:!0,ol:!0,li:!0,button:!0,a:!0,img:!0,canvas:!0,video:!0};function patchDOM(e,t,n){if(t&&e){if("string"==typeof t||"number"==typeof t){if(e.childNodes[n]&&"#text"==e.childNodes[n].nodeType)return void(e.childNodes[n].textContent!=t&&(e.childNodes[n].textContent=t));t=document.createTextNode(t)}if(Array.isArray(t)){for(var r=0,i=0;i<t.length;i++)r+=patchDOM(e,t[i],n+i);return r}if(!e.childNodes||e.childNodes.length<=n)try{e.appendChild(t)}catch(e){}else if(e.childNodes[n]!==t){console.log("PATCH DOM",t);try{e.replaceChild(t,e.childNodes[n])}catch(e){}}return 1}}rt.patchDOM=patchDOM,rt.cleanDOM=function(e,t){if(e&&e.childNodes)for(;e.childNodes.length>t;)e.removeChild(e.lastChild)};var classSym=Symbol("classname"),classcount=1;function cssFromObject(e){var t,n=[],r="{";for(t in e){var i=t.charAt(0);":"==i||"."==i||"#"==i||"@"==i?n.push(t+cssFromObject(e[t]).join(t+": ")):htmltags.hasOwnProperty(t.split(/\s|\.|#|:/)[0])?n.push(t+" "+cssFromObject(e[t]).join(t+": ")):r+=camel2Dash(t)+": "+e[t]+";\n"}return[r+"}\n"].concat(n)}rt.setStyle=function(e,t){if("string"==typeof t)e.setAttribute("style",t);else{var n=document.getElementById("dynastyles");n||((n=document.createElement("style")).setAttribute("id","dynastyles"),document.head.appendChild(n));var r,i=n.sheet;(r=t[classSym])||(r="class"+classcount,classcount++,t[classSym]=r);for(var s=cssFromObject(t),o=0;o<s.length;o++){var a=s[o].charAt(0);":"==a||"."==a||"#"==a?i.insertRule("."+r+s[o],i.cssRules.length):i.insertRule("."+r+" "+s[o],i.cssRules.length)}!r||-1==(t=e.className?e.className.split(" "):[]).indexOf(r)&&(t.push(r),e.className=t.join(" "))}};var attributemapping={class:"className"},svgtags={svg:!0,rect:!0};function _diff(e,t){var n=new diff_match_patch,r=n.diff_main(e,t);n.diff_cleanupSemantic(r);for(var i="",s=0,o=0;o<r.length;o++){var a=r[o][1].match(/[\n]+/g);0!=r[o][0]?1==r[o][0]?(i+="<div>line:"+(s+1)+' + <span style="background: #ddffdd;">'+EdenUI.Highlight.html(r[o][1])+"</span></div>",null!==a&&(s+=a.length)):2==r[o][1]&&(i+="<div>line:"+(s+1)+' - <span style="background: #ffdddd;">'+EdenUI.Highlight.html(r[o][1])+"</span></div>",null!==a&&(s-=a.length)):null!==a&&(s+=a.length)}return i}function sortByCount(e){var n=e.reduce(function(e,t){return e[t]=(e[t]||0)+1,e},{});return Object.keys(n).sort(function(e,t){return n[e]<n[t]})}function reduceByCount(e,t){var n,r=e.reduce(function(e,t){return e[t]=(e[t]||0)+1,e},{}),i=[];for(n in r)r[n]>=t&&i.push(n);return i}function negativeFilter(e,t){for(var n=t.reduce(function(e,t){return e[t]=(e[t]||0)+1,e},{}),r=[],i=0;i<e.length;i++)n[e[i]]||r.push(e[i]);return r}function sortByLoaded(e){for(var t=[],n=[],r=0;r<e.length;r++)(Eden.Agent.agents[e[r]]?t:n).push(e[r]);return t.push.apply(t,n),t}function runEdenAction(s,o,a,d){var c=this;void 0===a&&(s.active=!1);var h=a.next();if(0==h.done)if("object"==typeof h.value)if(Eden.AST.debug&&"debug"===h.value.type)h.value.next=function(){runEdenAction.call(c,s,o,a,d)},h.value.statement&&Eden.AST.debugbreakpoint===h.value.statement?Eden.AST.debugbreakpoint_cb&&Eden.AST.debugbreakpoint_cb(h.value):Eden.AST.debugstep_cb&&setTimeout(function(){Eden.AST.debugstep_cb(h.value)},0);else if("import"===h.value.type)h.value.executed=1,Eden.Selectors.query(h.value.selector,void 0,{context:h.value.parent,minimum:1,options:{external:!0,index:!0}},function(e){var t;void 0===e?((t=new Eden.RuntimeError(c,Eden.RuntimeError.UNKNOWN,h.value,"Selector '"+h.value.selector+"' has no results")).line=h.value.line,h.value.errors.push(t)):h.value.statements=e,runEdenAction.call(c,s,o,a,d)});else if("query"===h.value.type){function e(e){runEdenAction.call(c,s,o,a,d)}switch(h.value.kind){case"=":Eden.Selectors.assign(h.value._selector,h.value.restypes,h.value._modexpr,h.value,e);break;case"+=":Eden.Selectors.append(h.value._selector,h.value.restypes,h.value._modexpr,h.value,e);break;case"//=":Eden.Selectors.concat(h.value._selector,h.value.restypes,h.value._modexpr,h.value,e)}}else{function e(e){if(e&&0<e.length){h.value.params;var t=(t=h.value.nscope)||o;if(h.value.attribs.atomic&&o.context.beginAutocalcOff(),t.range){t.range=!1;for(var n=[];;){var r=t.clone();if(n.push(new Eden.AST.ScopedScript(e,r)),0==t.next())break}t.range=!0,c.executeStatements(n,void 0,s,function(){h.value.attribs.atomic&&o.context.endAutocalcOff(),runEdenAction.call(c,s,o,a,d)},{locals:{}},t)}else c.executeStatements(e,void 0,s,function(){h.value.attribs.atomic&&o.context.endAutocalcOff(),runEdenAction.call(c,s,o,a,d)},{locals:{}},t)}else{var i=new Eden.RuntimeWarning(h.value,Eden.RuntimeWarning.EMPTYDO,h.value.selector);i.line=h.value.line,h.value.warning=i,o.context.instance.emit("warning",[s,i]),h.value.attribs.atomic&&o.context.endAutocalcOff(),runEdenAction.call(c,s,o,a,d)}}"do"===h.value.type&&(h.value.statements?e(h.value.statements):h.value.name?Eden.Selectors.query(h.value.selector,void 0,{options:{self:h.value},context:h.value.parent,minimum:1},e):e(h.value.script.statements))}else 0===h.value?runEdenAction.call(this,s,o,a,d):0<h.value&&setTimeout(function(){runEdenAction.call(c,s,o,a,d)},h.value);else s.active=!1,d&&d()}Eden.AST.HTML=function(){this.type="html",this.errors=[],this.name=null,this.attributes=null,this.contents=null},Eden.AST.HTML.prototype.setName=function(e){this.name=e},Eden.AST.HTML.prototype.generate=function(e,t,n){var r="(function($o) {\n",i=null;if(this.attributes&&this.attributes.hasOwnProperty("xmlns")?i=this.attributes.xmlns.value:parent&&parent.attributes&&parent.attributes.hasOwnProperty("xmlns")?i=parent.attributes.xmlns.value:(svgtags.hasOwnProperty(this.name.toLowerCase())||parent&&svgtags.hasOwnProperty(parent.name))&&(i="http://www.w3.org/2000/svg"),r+=null!==i?'let ele = ($o) ? $o : document.createElementNS("'+i+'", "'+this.name+'");\n':'let ele = ($o && $o.nodeName == "'+this.name+'") ? $o : document.createElement("'+this.name+'");\n',null!==this.attributes)for(var s in this.attributes)"xmlns"!=s&&(s.startsWith("on")?"primary"!=this.attributes[s].type||(void 0===this.attributes[s].backticks?r+='ele["'+s.toLowerCase()+'"] = function(e) { eden.root.lookup("'+this.attributes[s].observable+'").assign(true, eden.root.scope, EdenSymbol.hciAgent); };\n':r+='ele["'+s.toLowerCase()+'"] = function(e) { eden.root.lookup('+this.attributes[s].backticks.generate(e,t,n)+").assign(true, eden.root.scope, EdenSymbol.hciAgent); };\n"):r+="style"==s?"rt.setStyle(ele, "+this.attributes[s].generate(e,t,n)+");\n":'ele.setAttribute("'+s+'",'+this.attributes[s].generate(e,t,n)+");\n");if(null!==this.contents){r+="let count=0;\n";for(var o=0;o<this.contents.length;o++)r+="let item = "+this.contents[o].generate(e,t,n),"html"==this.contents[o].type?r+="(ele.childNodes["+o+"]);\n":r+=";\n",r+="count += rt.patchDOM(ele, item, count);\n";r+="rt.cleanDOM(ele, count);\n"}return r+="return ele;\n})(this.cache.value)"},Eden.AST.HTML.prototype.addAttribute=function(e,t){null===this.attributes&&(this.attributes={}),0<t.errors.length&&this.errors.push.apply(this.errors,t.errors),this.attributes[e]=t},Eden.AST.HTML.prototype.addContent=function(e){null===this.contents&&(this.contents=[]),this.contents.push(e),0<e.errors.length&&this.errors.push.apply(this.errors,e.errors)},Eden.AST.prototype.pACTIONBODY=function(){var e=new Eden.AST.CodeBlock,t=this.parent;return this.parent=e,"{"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONOPEN)),this.parent=t,e):(this.next(),e.setLocals(this.pLOCALS()),0<e.locals.errors.length?(this.parent=t,e):(e.setScript(this.pSCRIPT()),"}"!=this.token?e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)):this.next(),this.parent=t,e))},Eden.AST.prototype.pAFTER=function(){var e=new Eden.AST.After;if("("!=this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.AFTEROPEN)),e;this.next();var t=this.pEXPRESSION();if(e.setExpression(t),0<e.errors.length)return e;if(")"!=this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.AFTEROPEN)),e;this.next();t=this.pSTATEMENT();return void 0===t&&e.error(new Eden.SyntaxError(this,Eden.SyntaxError.AFTERNOSTATEMENT)),e.setStatement(t),e.warning=new Eden.SyntaxWarning(this,e,Eden.SyntaxWarning.DEPRECATED,"'after' should not be used, use 'wait' instead"),e},Eden.AST.prototype.pATTRIBUTES=function(){if("["!=this.token){if("OBSERVABLE"!=this.token)return{errors:new Eden.SyntaxError(this,Eden.SyntaxError.DOBADATTRIB)};var e=this.data.value;const n={};this.next();return n[e]=!0,n}this.next();const n={};for(;;){if("OBSERVABLE"!=this.token)return{errors:new Eden.SyntaxError(this,Eden.SyntaxError.DOBADATTRIB)};let e=this.data.value;this.next();let t=!0;if("("===this.token){switch(this.next(),this.token){case"STRING":case"NUMBER":case"OBSERVABLE":e+="("+this.data.value+")",t=this.data.value;break;default:return{errors:new Eden.SyntaxError(this,Eden.SyntaxError.DOBADATTRIB)}}if(this.next(),")"!==this.token)return{errors:new Eden.SyntaxError(this,Eden.SyntaxError.DOBADATTRIB)};this.next()}if(n[e]=t,","!=this.token)break;this.next()}return"]"!=this.token?{error:new Eden.SyntaxError(this,Eden.SyntaxError.DOATTRIBCLOSE)}:(this.next(),n)},Eden.AST.prototype.pPARAMS=function(){var e=new Eden.AST.Declarations;for(e.kind="oracle";"para"==this.token||"oracle"==this.token;){this.next();var t=this.pOLIST();if(e.list.push.apply(e.list,t),0==t.length||"NONAME"==t[t.length-1])return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.PARAMNAME)),e;";"==this.token&&this.next()}return e},Eden.AST.prototype.pLOCALS=function(){var e=new Eden.AST.Declarations;for(e.kind="local";"auto"===this.token||"local"===this.token;){if(this.next(),"when"===this.token)return this.next(),this.localStatus=!0,e=this.pWHEN(),this.localStatus=!1,e;var t=this.pOLIST();if(e.list.push.apply(e.list,t),0===t.length||"NONAME"===t[t.length-1])return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LOCALNAME)),e;";"===this.token&&this.next()}return e},Eden.AST.prototype.pEXEC=function(){var e=new Eden.AST.Do,t=this.parent;if(this.parent=e,"["==this.token){var n=this.pATTRIBUTES();if(!e.setAttributes(n))return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.DOBADATTRIB)),this.parent=t,e}if("("!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)),this.parent=t,e;this.next();n=this.pEXPRESSION();return e.setLiteral(n),")"!=this.token?e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)):(this.next(),"with"!=this.token&&"::"!=this.token||(this.next(),e.setScope(this.pSCOPE()))),this.parent=t,e},Eden.AST.prototype.pDO=function(){var e=new Eden.AST.Do,t=this.parent;if(this.parent=e,"["==this.token){var n=this.pATTRIBUTES();if(!e.setAttributes(n))return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.DOBADATTRIB)),this.parent=t,e}if("{"==this.token){this.next();var r=this.pSCRIPT();return(r.parent=e,"}"!=this.token)?(e.setScript(r),e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)),this.parent=t,e):(this.next(),e.setScript(r),this.parent=t,"with"!=this.token&&"::"!=this.token||(this.next(),e.setScope(this.pSCOPE())),e)}if("OBSERVABLE"!=this.token&&"."!=this.token&&">>"!=this.token&&">"!=this.token&&"<"!=this.token&&"<<"!=this.token&&":"!=this.token&&"*"!=this.token&&"@"!=this.token&&"#"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.DONAME)),this.parent=t,e;r=this.pCODESELECTOR();return e.setName(r),0<e.errors.length?(this.parent=t,e):("with"!=this.token&&"::"!=this.token||(this.next(),e.setScope(this.pSCOPE())),";"!=this.token?e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SEMICOLON)):this.next(),this.parent=t,e)},Eden.AST.prototype.pEXPRESSION_PPPPP=function(){if("#"===this.token&&this.stream.position===this.lastposition+1)return this.next(),new Eden.AST.Length},Eden.AST.prototype.pEXPRESSION_PPPPPP=function(){var e;return this.version===Eden.AST.VERSION_CS2&&"?"===this.token?(this.next(),(e=new Eden.AST.TernaryOp("?")).setFirst(this.pEXPRESSION()),e.warning=new Eden.SyntaxWarning(this,e,Eden.SyntaxWarning.DEPRECATED,"use of ? for 'if'."),0<e.errors.length||(":"!=this.token?e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.TERNIFCOLON)):(this.next(),e.setSecond(this.pEXPRESSION()))),e):"if"===this.token?(this.next(),(e=new Eden.AST.TernaryOp("?")).setCondition(this.pEXPRESSION()),0<e.errors.length||("else"!==this.token?e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.TERNIFCOLON)):(this.next(),e.setSecond(this.pEXPRESSION()))),e):void 0},Eden.AST.prototype.pEXPRESSION_PLAIN=function(){for(var e=this.pTERM();this.stream.valid();)switch(this.token){case"&&":case"||":case"&":case"|":case"and":case"or":var t=new Eden.AST.BinaryOp(this.token);this.next(),t.left(e),t.setRight(this.pTERM()),e=t;continue;default:return e}return e},Eden.AST.prototype.pEXPRESSION_ASYNC=function(){var e;return"sync"===this.token?(this.next(),(e=new Eden.AST.Async).setExpression(this.pEXPRESSION())):e=this.pEXPRESSION(),e},Eden.AST.prototype.pFUNC_EXPR=function(){let e;if(this.next(),"{"===this.token)return this.next(),e=this.pSCRIPTEXPR(),"}"!==this.token?e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)):this.next(),e;var t=new Eden.AST.ScriptExpr;return t.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONOPEN)),t},Eden.AST.prototype.pEXPRESSION=function(){var e;if("sync"===this.token)return(e=new Eden.AST.Async).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SYNCNOTALLOWED)),e;switch(this.token){case"func":e=this.pFUNC_EXPR();break;case"action":e=new Eden.AST.Literal("NODE",this.pSTATEMENT());break;default:e=this.pEXPRESSION_PLAIN()}for(;"with"===this.token||"::"===this.token;){this.next(),e.isscoped&&this.syntaxWarning(e,Eden.SyntaxWarning.NESTEDSCOPE,"Should not chain scopes in single expression");var t=this.pSCOPE();t.setExpression(e),e.isconstant&&!t.range&&t.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BADEXPRTYPE)),e=t}return e},Eden.AST.prototype.pFACTOR_SUBEXP=function(){this.next();var e=this.pEXPRESSION();if(0<e.errors.length)return e;if(")"!==this.token?e.error(new Eden.SyntaxError(this,Eden.SyntaxError.EXPCLOSEBRACKET)):this.next(),"["!==this.token&&"."!==this.token&&"("!==this.token)return e;var t=this.pINDEXED();return t.setExpression(e),t},Eden.AST.prototype.pFACTOR_OBJECTLITERAL=function(){this.next();var e={};"}"!==this.token&&(e=this.pLLIST());var t,n=new Eden.AST.Literal("OBJECT",e);for(t in e){var r=e[t];n.mergeExpr(r)}return n.typevalue=Eden.AST.TYPE_OBJECT,0<n.errors.length||("}"!==this.token?n.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LISTLITCLOSE)):this.next()),n},Eden.AST.prototype.pFACTOR_LISTLITERAL=function(){this.next();var e=[];"]"!==this.token&&(e=this.pELIST());for(var t=new Eden.AST.Literal("LIST",e),n=0;n<e.length;n++)t.mergeExpr(e[n]);return t.typevalue=Eden.AST.TYPE_LIST,0<t.errors.length||("]"!==this.token?t.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LISTLITCLOSE)):this.next()),t},Eden.AST.prototype.pFACTOR_UNDEFINED=function(){return this.next(),new Eden.AST.Literal("UNDEFINED","@")},Eden.AST.prototype.pFACTOR_JAVASCRIPT=function(){var e=new Eden.AST.Literal("JAVASCRIPT",this.data.value);return e.isconstant=!1,this.next(),e},Eden.AST.prototype.pFACTOR_NUMBER=function(){var e=new Eden.AST.Literal("NUMBER",this.data.value);return this.next(),e},Eden.AST.prototype.pFACTOR_STRING=function(){var e=new Eden.AST.Literal("STRING",this.data.value);for(this.data.error||this.next();0==this.data.error&&"STRING"==this.token;)e.value+="\n"+this.data.value,this.next();return this.data.error&&("LINEBREAK"===this.data.value?e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LITSTRLINE)):e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LITSTRCLOSE))),e},Eden.AST.prototype.pFACTOR_HEREDOC=function(){if(this.next(),"OBSERVABLE"!==this.token)return(i=new Eden.AST.Literal("STRING",this.data.value)).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.HEREDOCTOKEN)),i;var e=this.data.value;if(10!=this.stream.get())return(i=new Eden.AST.Literal("STRING",this.data.value)).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.HEREDOCTOKEN)),i;for(var t="";this.stream.valid();){var n=this.stream.position,r=this.stream.readLine();if(r.startsWith(e)){this.stream.position=n;break}t+=r}var i=new Eden.AST.Literal("STRING",t.slice(0,-1));return this.stream.valid()?(this.next(),this.next()):i.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.NEWLINE)),i},Eden.AST.prototype.pFACTOR_BOOLEAN=function(){var e=new Eden.AST.Literal("BOOLEAN",this.data.value);return this.next(),e},Eden.AST.prototype.pFACTOR_NEGATION=function(){if(this.next(),"NUMBER"===this.token){var e=new Eden.AST.Literal("NUMBER",-this.data.value);return this.next(),e}var t=this.pFACTOR(),e=new Eden.AST.UnaryOp("-",t);return 0!==t.typevalue&&t.typevalue!==Eden.AST.TYPE_NUMBER&&this.typeWarning(e,Eden.AST.TYPE_NUMBER,t.typevalue),e},Eden.AST.prototype.pFACTOR_QUERY=function(){this.next();var e=this.pQUERY();if("["!==this.token)return e;var t=this.pINDEXED();return t.setExpression(e),t},Eden.AST.prototype.pFACTOR_HTML=function(){return this.pHTML()},Eden.AST.prototype.pFACTOR_NOT=function(){this.next();var e=this.pFACTOR();return new Eden.AST.UnaryOp("!",e)},Eden.AST.prototype.pFACTOR_DEREFERENCE=function(){if(this.next(),"("===this.token){this.next();let e=this.pFACTOR_PRIMARY();return")"!==this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.EXPCLOSEBRACKET)),e):(this.next(),new Eden.AST.UnaryOp("*",e))}var e=this.pPRIMARY(),t=new Eden.AST.UnaryOp("*",e);if("["!==this.token&&"."!==this.token&&"("!==this.token)return t;e=this.pINDEXED();return e.setExpression(t),e},Eden.AST.prototype.pFACTOR_DEREFERENCE_NOIX=function(){if(this.next(),"("===this.token){this.next();let e=this.pFACTOR_PRIMARY();return")"!==this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.EXPCLOSEBRACKET)),e):(this.next(),new Eden.AST.UnaryOp("*",e))}var e=this.pPRIMARY();return new Eden.AST.UnaryOp("*",e)},Eden.AST.prototype.pFACTOR_ADDRESSOF=function(){this.next();var e=this.pLVALUE();return e.lvaluep&&0<e.lvaluep.length&&e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),new Eden.AST.UnaryOp("&",e)},Eden.AST.prototype.pFACTOR_BUILTIN=function(){var e=this.token;if(this.next(),"("!==this.token)return(t=new Eden.AST.UnaryOp(e,null)).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.EVALCLOSE)),t;this.next();var t,n=this.pEXPRESSION();return(t=new Eden.AST.UnaryOp(e,n)).isconstant&&0!=t.typevalue&&t.typevalue!=Eden.AST.TYPE_STRING&&this.typeWarning(t,Eden.AST.TYPE_STRING),")"!==this.token?t.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.EVALCLOSE)):this.next(),t},Eden.AST.prototype.pFACTOR_SUBSTITUTION=function(){this.next();var e=this.pEXPRESSION(),t=new Eden.AST.UnaryOp("sub",e);if("}"!==this.token)return t.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.EVALCLOSE)),t;if(this.next(),"["!==this.token&&"."!==this.token&&"("!==this.token)return t;e=this.pINDEXED();return e.setExpression(t),e},Eden.AST.prototype.pFACTOR_PRIMARY=function(){var e=this.pPRIMARY();if(0<e.errors.length)return e;if("["!==this.token&&"."!==this.token&&"("!==this.token)return e;var t=this.pINDEXED();return t.setExpression(e),t},Eden.AST.prototype.pFACTOR_TYPED_TSTRING=function(){if(this.next(),"OBSERVABLE"!==this.token){let e=new Eden.AST.Literal("UNDEFINED");return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e}this.data.value;if(this.next(),"'"===this.token)return this.pTEMPLATE_STRING(!0);{let e=new Eden.AST.Literal("UNDEFINED");return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e}},Eden.AST.prototype.pFACTOR=function(){switch(this.token){case"(":return this.pFACTOR_SUBEXP();case"{":return this.pFACTOR_OBJECTLITERAL();case"[":return this.pFACTOR_LISTLITERAL();case"@":return this.pFACTOR_UNDEFINED();case"JAVASCRIPT":return this.pFACTOR_JAVASCRIPT();case"NUMBER":return this.pFACTOR_NUMBER();case"?":return this.pFACTOR_QUERY();case"-":return this.pFACTOR_NEGATION();case"<":return this.pFACTOR_HTML();case"<<":return this.pFACTOR_HEREDOC();case"%":return this.pFACTOR_TYPED_TSTRING();case"'":return this.pTEMPLATE_STRING(!0);case"STRING":return this.pFACTOR_STRING();case"BOOLEAN":return this.pFACTOR_BOOLEAN();case"!":case"not":return this.pFACTOR_NOT();case"&":return this.pFACTOR_ADDRESSOF();case"*":return this.pFACTOR_DEREFERENCE();case"eval":case"parse":case"compile":return this.pFACTOR_BUILTIN();case"${":return this.pFACTOR_SUBSTITUTION();default:return this.pFACTOR_PRIMARY()}},Eden.AST.prototype.pFOR=function(){var e=new Eden.AST.For,t=this.parent;if(this.parent=e,"("!==this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.FOROPEN)),this.parent=t,e;if(this.next(),";"===this.token)this.next();else{if(e.setStart(this.pSTATEMENT_P(!0)),0<e.errors.length)return this.parent=t,e;if("range"!==e.sstart.type&&";"!==this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.FORSTART)),this.parent=t,e;";"===this.token&&this.next()}if(e.sstart&&"range"===e.sstart.type){if(")"!==this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.FORCLOSE)),this.parent=t,e;this.next()}else{if(";"===this.token)this.next();else{if(e.setCondition(this.pEXPRESSION()),0<e.errors.length)return this.parent=t,e;if(";"!==this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.FORCOND)),this.parent=t,e;this.next()}if(")"===this.token)this.next();else{if(e.setIncrement(this.pSTATEMENT_P()),0<e.errors.length)return this.parent=t,e;if(")"!==this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.FORCLOSE)),this.parent=t,e;this.next()}}return";"!==this.token?(e.setStatement(this.pSTATEMENT()),e.statement&&(e.statement.parent=e)):this.next(),e.parent=t,this.parent=t,e},Eden.AST.prototype.pFUNCTION=function(){var e=new Eden.AST.Definition,t=this.parent;this.parent=e;var n=this.token;if(this.next(),this.version>=Eden.AST.VERSION_CS3&&":"===this.token){this.next();var r=this.pATTRIBUTES();if(!e.setAttributes(r))return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.FUNCNAME)),this.parent=t,e}if("OBSERVABLE"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.FUNCNAME)),this.parent=t,e;var i=new Eden.AST.LValue;if(i.setObservable(this.data.value),this.next(),":"===this.token)if(this.version===Eden.AST.VERSION_CS2&&"proc"===n){this.next();var s=this.pOLIST();const o={eager:!0};for(const a of s)o["depends("+a+")"]=!0;if(!e.setAttributes(o))return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.FUNCNAME)),e.left(i),this.parent=t,e}else{this.next();r=this.pATTRIBUTES();if(!i.setAttributes(r))return i.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.FUNCNAME)),e.left(i),this.parent=t,e}if("<~"===this.token){this.next();r=this.pOLIST();const o={eager:!0};for(const d of r)o["depends("+d+")"]=!0;if(!e.setAttributes(o))return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.FUNCNAME)),e.left(i),this.parent=t,e}if(e.left(i),"{"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.FUNCOPEN)),this.parent=t,e;this.next();i=this.pSCRIPTEXPR();if("proc"===n&&e.eager){n=new Eden.AST.FunctionCall;const c=new Eden.AST.Indexed;c.addIndex(n),c.setExpression(i),i=c}return e.setExpression(i),"}"!=this.token?e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)):this.next(),this.parent=t,e},Eden.AST.prototype.pFUNCBODY=function(){var e=new Eden.AST.CodeBlock,t=this.parent;return this.parent=e,"{"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.FUNCOPEN)),this.parent=t,e):(this.next(),e.setParams(this.pPARAMS()),0<e.params.errors.length?(this.parent=t,e):(e.setLocals(this.pLOCALS()),0<e.locals.errors.length?(this.parent=t,e):(e.setScript(this.pSCRIPT()),"}"!=this.token?e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.FUNCCLOSE)):this.next(),this.parent=t,e)))},Eden.AST.prototype.pIF=function(){var e=new Eden.AST.If;e.parent=this.parent;var t=this.parent;return(this.parent=e).setCondition(this.pEXPRESSION()),0<e.errors.length?(this.parent=t,e):(e.setStatement(this.pSTATEMENT()),0<e.errors.length||(void 0===e.statement?e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.IFNOSTATEMENT)):e.setElse(this.pIF_P())),this.parent=t,e)},Eden.AST.prototype.pIF_P=function(){if("else"==this.token)return this.next(),this.pSTATEMENT()},Eden.AST.prototype.pREQUIRE=function(){var e=new Eden.AST.Require,t=this.pEXPRESSION();return e.setExpression(t),e.warning=new Eden.SyntaxWarning(this,e,Eden.SyntaxWarning.DEPRECATED,"require."),e},Eden.AST.prototype.pIMPORT=function(){var e=new Eden.AST.Import;e.warning=new Eden.SyntaxWarning(this,e,Eden.SyntaxWarning.DEPRECATED,"use of import, use action alias instead");var t=this.pCODESELECTOR();return void 0===t||0<t.errors.length?e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.IMPORTPATH)):e.setPath(t),e},Eden.AST.prototype.pINSERT=function(){var e=new Eden.AST.Insert;return"("!=this.token?this.deprecated(e,"'insert' should use brackets: 'insert(a,b,c)'"):this.next(),e.setDest(this.pLVALUE()),0<e.errors.length?e:","!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.INSERTCOMMA)),e):(this.next(),e.setIndex(this.pEXPRESSION()),0<e.errors.length?e:","!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.INSERTCOMMA)),e):(this.next(),e.setValue(this.pEXPRESSION()),0<e.errors.length||")"==this.token&&this.next(),e))},Eden.AST.prototype.pDELETE=function(){var e=new Eden.AST.Delete;return"("!=this.token?this.deprecated(e,"'delete' should use brackets: 'delete(a,b)'"):this.next(),e.setDest(this.pLVALUE()),0<e.errors.length?e:","!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.DELETECOMMA)),e):(this.next(),e.setIndex(this.pEXPRESSION()),0<e.errors.length||")"==this.token&&this.next(),e)},Eden.AST.prototype.pAPPEND=function(){var e=new Eden.AST.Append;return"("!=this.token?this.deprecated(e,"'append' should use brackets: 'append(a,b)'"):this.next(),e.setDest(this.pLVALUE()),0<e.errors.length?e:","!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.APPENDCOMMA)),e):(this.next(),e.setIndex(this.pEXPRESSION()),0<e.errors.length||")"==this.token&&this.next(),e)},Eden.AST.prototype.pSHIFT=function(){var e=new Eden.AST.Shift;return"("!=this.token?this.deprecated(e,"'shift' should use brackets: 'shift(a)'"):this.next(),e.setDest(this.pLVALUE()),0<e.errors.length||")"==this.token&&this.next(),e},Eden.AST.prototype.pELIST=function(){var e=this.pEXPRESSION();if(0<e.errors.length)return[e];var t=this.pELIST_P();return t.unshift(e),t},Eden.AST.prototype.pELIST_P=function(){for(var e=[];","==this.token;){this.next();var t=this.pEXPRESSION();if(e.push(t),0<t.errors.length)return e}return e},Eden.AST.prototype.pLLIST=function(){if("OBSERVABLE"!=this.token){var e=new Eden.AST.Literal("UNDEFINED");return this.syntaxError(e,Eden.SyntaxError.UNKNOWN),{__error__:e}}var t=this.data.value;if(this.next(),":"!=this.token){e=new Eden.AST.Literal("UNDEFINED");return this.syntaxError(e,Eden.SyntaxError.UNKNOWN),{label:e}}this.next();var n,e=this.pEXPRESSION();return 0<e.errors.length?(n={})[t]=e:((n=this.pLLIST_P()).hasOwnProperty(t)&&this.syntaxError(e,Eden.SyntaxError.UNKNOWN),n[t]=e),n},Eden.AST.prototype.pLLIST_P=function(){for(var e={};","==this.token;){if(this.next(),"OBSERVABLE"!=this.token){var t=new Eden.AST.Literal("UNDEFINED");return this.syntaxError(t,Eden.SyntaxError.UNKNOWN),{__error__:t}}var n=this.data.value;if(this.next(),":"!=this.token){t=new Eden.AST.Literal("UNDEFINED");return this.syntaxError(t,Eden.SyntaxError.UNKNOWN),{label:t}}this.next();var r=this.pEXPRESSION();if(e.hasOwnProperty(n)&&this.syntaxError(r,Eden.SyntaxError.UNKNOWN),0<(e[n]=r).errors.length)return e}return e},Eden.AST.prototype.pOLIST=function(){if("OBSERVABLE"!=this.token)return[];var e=this.data.value;this.next();var t=this.pOLIST_P();return t.unshift(e),t},Eden.AST.prototype.pOLIST_P=function(){for(var e=[];","==this.token;){if(this.next(),"OBSERVABLE"!=this.token)return e.push("NONAME"),e;e.push(this.data.value),this.next()}return e},Eden.AST.prototype.pLVALUE_P=function(){for(var e=[];;)if("["===this.token){this.next();var t=new Eden.AST.LValueComponent("index"),n=this.pEXPRESSION();if(t.index(n),e.push(t),0<n.errors.length&&t.errors.unshift(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXEXP)),"literal"==t.indexexp.type&&"NUMBER"==t.indexexp.datatype&&t.indexexp.value<1&&t.error(new Eden.SyntaxError(this,Eden.SyntaxError.OUTOFBOUNDS)),"]"!==this.token)return t.error(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXCLOSE)),e;this.next()}else{if("."!==this.token)break;this.next();t=new Eden.AST.LValueComponent("index");if("OBSERVABLE"!=this.token)return t.errors.unshift(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXEXP)),e.push(t),e;n=new Eden.AST.Literal("STRING",this.data.value);this.next(),t.index(n),e.push(t)}return e},Eden.AST.prototype.pLVALUE=function(){var e=new Eden.AST.LValue;if("*"===this.token){var t=this.pFACTOR_DEREFERENCE_NOIX();e.setPrimary(t)}else if("`"===this.token){if(this.version===Eden.AST.VERSION_CS2){if(this.next(),n=this.pEXPRESSION(),this.deprecated(n,"Backticks are now identifier templates"),"`"!==this.token)return(r=new Eden.AST.Primary).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BACKTICK)),r;this.next()}else n=this.pTEMPLATE_STRING(!1);if(0!=n.typevalue&&n.typevalue!=Eden.AST.TYPE_STRING&&(r=new Eden.AST.Primary,this.typeWarning(r,Eden.AST.TYPE_STRING,n.typevalue)),e.setExpression(n),0<e.errors.length)return e}else{if("OBSERVABLE"!==this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.LVALUE)),e;var n,r=this.data.value;if(this.next(),"{"===this.token&&this.version===Eden.AST.VERSION_CS2?(n=this.pDEPRECATED_BTICK(r),this.deprecated(n,"Backticks are now identifier templates"),e.setExpression(n)):e.setObservable(r),this.version>=Eden.AST.VERSION_CS3&&":"===this.token){this.next();r=this.pATTRIBUTES();if(!e.setAttributes(r))return this.syntaxError(e,Eden.SyntaxError.DOBADATTRIB),e}}return e.setExtras(this.pLVALUE_P()),e},Eden.AST.prototype.pDEPRECATED_BTICK=function(e){var t=new Eden.AST.Literal("STRING",e||"");for(t.typevalue=Eden.AST.TYPE_STRING;"{"==this.token;){this.next();var n,r=this.pEXPRESSION();if(0<r.errors.length)return(n=new Eden.AST.Primary).setBackticks(r),n;if("}"!=this.token)return(n=new Eden.AST.Primary).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BACKTICK)),n;this.next();var i=new Eden.AST.BinaryOp("//");i.left(t),i.setRight(r),i.typevalue=Eden.AST.TYPE_STRING,t=i,"OBSERVABLE"==this.token&&((i=new Eden.AST.BinaryOp("//")).left(t),(r=new Eden.AST.Literal("STRING",this.data.value)).typevalue=Eden.AST.TYPE_STRING,i.setRight(r),i.typevalue=Eden.AST.TYPE_STRING,t=i,this.next())}return t},Eden.AST.prototype.pPRIMARY_DEPRECATED_BTICK=function(e,t){t=this.pDEPRECATED_BTICK(t);return(e=this.pPRIMARY_P(e)).setBackticks(t),e.setObservable("__BACKTICKS__"),this.isdynamic=!0,e},Eden.AST.prototype.pIDENTIFIER=function(e){if("`"===this.token){if(this.version===Eden.AST.VERSION_CS2){if(this.next(),t=this.pEXPRESSION(),this.deprecated(t,"Backticks are now identifier templates"),"`"!==this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BACKTICK)),e;this.next()}else t=this.pTEMPLATE_STRING(!1);return(e=this.pPRIMARY_P(e),0!=t.typevalue&&t.typevalue!=Eden.AST.TYPE_STRING&&this.typeWarning(e,Eden.AST.TYPE_STRING,t.typevalue),0<e.errors.length)?e:(e.setBackticks(t),e.setObservable("__BACKTICKS__"),e)}if("OBSERVABLE"!==this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BADFACTOR)),e;var t=this.data.value;if(this.next(),"{"!==this.token||this.version!==Eden.AST.VERSION_CS2)return 0<(e=this.pPRIMARY_P(e)).errors.length||e.setObservable(t),e;t=this.pPRIMARY_DEPRECATED_BTICK(e,t);return this.deprecated(t,"Backticks are now identifier templates"),t},Eden.AST.prototype.pPRIMARY=function(){var e=new Eden.AST.Primary;return this.pIDENTIFIER(e)},Eden.AST.prototype.pPRIMARY_P=function(e){var t;return this.version>=Eden.AST.VERSION_CS3&&":"==this.token&&(this.next(),t=this.pATTRIBUTES(),e.setAttributes(t)||e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.DOBADATTRIB))),e},Eden.AST.prototype.pACTION=function(){var e=new Eden.AST.Action,t=this.parent;if((this.parent=e).warning=new Eden.SyntaxWarning(this,e,Eden.SyntaxWarning.DEPRECATED,"attempt to use 'when' instead of 'proc'"),"OBSERVABLE"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.PROCNAME)),this.parent=t,e;if(e.name=this.data.value,this.next(),":"==this.token){this.next();var n=this.pOLIST();if(0==n.length)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONNOWATCH)),this.parent=t,e;if("NONAME"==n[n.length-1])return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCOMMAS)),this.parent=t,e;e.triggers=n}return e.setBody(this.pFUNCBODY()),this.parent=t,e},Eden.AST.prototype.pSCOPE=function(){let e;if("("===this.token){if(this.next(),e=this.pSCOPE_P(),")"!==this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SCOPECLOSE)),e;this.next()}else e=this.pSCOPE_P();return e},Eden.AST.prototype.pSCOPEPATTERN=function(){var e=new Eden.AST.ScopePattern;if("OBSERVABLE"!==this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.SCOPENAME)),e;for(e.setObservable(this.data.value),this.next();;)if("["===this.token){this.next();var t=this.pEXPRESSION();if(e.addListIndex(t),0<t.errors.length)return e;if("]"!==this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXCLOSE)),e;this.next()}else if("."!==this.token)break;return e},Eden.AST.prototype.pSCOPE_P=function(e){var t=!1,n=this.peekNext(1);if(void 0===e&&(e=1),"is"!==n&&"="!==n&&"in"!==n)(r=new Eden.AST.ScopePattern).setObservable("$"+e),e++;else{var r=this.pSCOPEPATTERN();if(0<r.errors.length)return(o=new Eden.AST.Scope).addOverride(r,void 0,void 0,void 0,!1),o;if("is"!==this.token&&"="!==this.token&&"in"!==this.token)return(o=new Eden.AST.Scope).error(new Eden.SyntaxError(this,Eden.SyntaxError.SCOPEEQUALS)),o;"in"===this.token&&(t=!0),this.next()}var i=this.pEXPRESSION();if(0<i.errors.length)return(o=new Eden.AST.Scope).errors.push.apply(o.errors,i.errors),o;if(t&&".."!==this.token&&0!==i.typevalue&&i.typevalue!==Eden.AST.TYPE_LIST)return(o=new Eden.AST.Scope).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BADEXPRTYPE)),o;var s=void 0;if(".."===this.token){if(0!==i.typevalue&&i.typevalue!==Eden.AST.TYPE_NUMBER)return(o=new Eden.AST.Scope).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BADEXPRTYPE)),o;if(this.next(),s=this.pEXPRESSION(),0<s.errors.length)return(o=new Eden.AST.Scope).addOverride(r,i,s,void 0,!1),o;if(0!==s.typevalue&&s.typevalue!==Eden.AST.TYPE_NUMBER)return(o=new Eden.AST.Scope).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BADEXPRTYPE)),o}var o,n=void 0;if(".."===this.token){if(this.next(),n=this.pEXPRESSION(),0<n.errors.length)return(o=new Eden.AST.Scope).addOverride(r,i,s,n,!1),o;if(0!==n.typevalue&&n.typevalue!==Eden.AST.TYPE_NUMBER)return(o=new Eden.AST.Scope).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BADEXPRTYPE)),o}return(o=this.pSCOPE_PP(e)).addOverride(r,i,s,n,t),o},Eden.AST.prototype.pSCOPE_PP=function(e){return","===this.token?(this.next(),this.pSCOPE_P(e)):new Eden.AST.Scope},Eden.AST.prototype.pNAMEDSCRIPT=function(){var e,t=null;if("["===this.token&&(t=this.pATTRIBUTES()),"OBSERVABLE"!==this.token)return(i=new Eden.AST.Script).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONNAME)),i;e=this.data.value,this.next();let n,r;if("("===this.token){if(this.next(),"oracle"===this.token&&(this.next(),n=this.pCODESELECTOR()),";"===this.token&&this.next(),"handle"===this.token&&(this.next(),r=this.pCODESELECTOR()),")"!==this.token)return(i=new Eden.AST.Script).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)),i;this.next()}if("is"!==this.token)return"{"!==this.token?((i=new Eden.AST.Script).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONOPEN)),i):(this.next(),(i=this.pSCRIPT()).setAttributes(t)?(i.setName(this,e),n&&i.setReadables(n),r&&i.setWritables(r),"}"!==this.token?(i.error(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)),i):(this.next(),this.scripts[e]=i)):(i.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.DOBADATTRIB)),i));this.next();var i=new Eden.AST.Alias;return i.setAttributes(t)?"?"!==this.token?(i.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.ALIASQUERY)),i):(this.next(),"("!==this.token?(i.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.QUERYOPEN)),i):(this.next(),i.setSelector(this.pCODESELECTOR()),")"!==this.token?i.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.QUERYCLOSE)):(this.next(),i.setName(e)),i)):(i.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.DOBADATTRIB)),i)},Eden.AST.prototype.pSCRIPT=function(){var e=new Eden.AST.Script;e.parent=this.parent;var t=this.parent;this.parent=e,(s=new Eden.AST.DummyStatement).setSource(this.lastposition,this.stream.prevposition,this.stream.code.substring(this.lastposition,this.stream.prevposition)),s.numlines=s.source.match(/\n/g),null===s.numlines?s.numlines=0:s.numlines=s.numlines.length,e.append(s);for(var n=s;this.stream.valid();){var r=this.pSTATEMENT();if(void 0!==r){!e.warning&&r.warning&&(e.warning=r.warning);var i=r.end;"dummy"===r.type&&n&&"dummy"===n.type?(n.setSource(r.start,r.end,r.source),n.numlines+=r.numlines):(e.appendChild(r),n=r);var s,o=this.stream.code.substring(i,this.stream.prevposition);if(0<o.length&&((s=new Eden.AST.DummyStatement).setSource(i,this.stream.prevposition,o),s.numlines=s.source.match(/\n/g),null===s.numlines?s.numlines=0:s.numlines=s.numlines.length,n&&"dummy"===n.type?(n.setSource(s.start,s.end,s.source),n.numlines+=s.numlines):(e.appendChild(s),n=s)),0<r.errors.length)break}else{if(";"!==this.token){if("}"===this.token||"EOF"===this.token)break;e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.STATEMENT));break}this.next()}}return"}"!==this.token&&"EOF"!==this.token&&";"!==this.token&&e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.STATEMENT)),this.parent=t,e},Eden.AST.prototype.pSCRIPTEXPR=function(){var e=new Eden.AST.ScriptExpr,t=this.pSCRIPT();return e.setScript(t),e},function(){var a=Eden.Language;Eden.AST.prototype.pCODESELECTOR=function(e){var t=void 0;if("OBSERVABLE"==this.token||a.keywords[this.token]&&"with"!=this.token)t=new Eden.AST.Literal("STRING",this.data.value),this.next();else if(":"==this.token||"."==this.token){var n=":"==this.token;if(this.next(),"OBSERVABLE"==this.token||a.keywords[this.token]){if(!(!n&&Eden.Selectors.PropertyNode.attributes[this.data.value]||n&&Eden.Selectors.PropertyNode.pseudo[this.data.value]))return(t=new Eden.AST.Literal("STRING","")).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTORATTRIB)),t;t=new Eden.AST.Literal("STRING",(n?":":".")+this.data.value),this.next()}else if("NUMBER"==this.token)t=new Eden.AST.Literal("STRING",(n?":":".")+this.data.value),this.next();else if("{"==this.token)t=new Eden.AST.Literal("STRING",n?":":".");else{if("("!=this.token)return(t=new Eden.AST.Literal("STRING","")).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTORATTRIB)),t;var r=this.stream.position;for(this.next();this.stream.valid()&&")"!=this.token;)this.next();var i=this.stream.prevposition,s=":("+this.stream.code.substring(r,i).replace(/[\r\n]*/g,"")+")",t=new Eden.AST.Literal("STRING",s);if(")"!=this.token)return t.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTORATTRIB)),t;this.next()}}else if("@"==this.token){if(this.next(),"OBSERVABLE"!=this.token)return(t=new Eden.AST.Literal("STRING","")).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTOROPTION)),t;if(!Eden.Selectors.allowedOptions[this.data.value])return(t=new Eden.AST.Literal("STRING","")).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTOROPTION)),t;t=new Eden.AST.Literal("STRING","@"+this.data.value+" "),this.next()}else if("#"==this.token)if(this.next(),"OBSERVABLE"==this.token)t=new Eden.AST.Literal("STRING","#"+this.data.value),this.next();else{if("{"!=this.token)return(t=new Eden.AST.Literal("STRING","")).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTORTAG)),t;t=new Eden.AST.Literal("STRING","#")}else if("{"==this.token){if(this.next(),t=this.pEXPRESSION(),"}"!=this.token)return t.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTORBTICK)),t;this.next()}else if(">"==this.token)t=new Eden.AST.Literal("STRING"," > "),this.next();else if(">>"==this.token)t=new Eden.AST.Literal("STRING"," >> "),this.next();else if("<"==this.token)t=new Eden.AST.Literal("STRING"," < "),this.next();else if(","==this.token)t=new Eden.AST.Literal("STRING",","),this.next();else if("<<"==this.token)t=new Eden.AST.Literal("STRING"," << "),this.next();else if("("==this.token){r=this.stream.position;if(this.next(),"{"==this.token){this.next();var o,n=this.pEXPRESSION();if("}"!=this.token)return n.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTORBTICK)),n;if(this.next(),")"!=this.token)return n.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTORBTICK)),n;this.next(),(o=new Eden.AST.BinaryOp("//")).left(new Eden.AST.BinaryOp("//")),o.l.left(new Eden.AST.Literal("STRING","(")),o.l.setRight(n),o.setRight(new Eden.AST.Literal("STRING",")")),t=o}else{for(;this.stream.valid()&&")"!=this.token;)this.next();var i=this.stream.prevposition,s="("+this.stream.code.substring(r,i).replace(/[\r\n]*/g,"")+")";if(t=new Eden.AST.Literal("STRING",s),")"!=this.token)return t.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.SELECTORATTRIB)),t;this.next()}}else{if(")"==this.token)return;"*"==this.token&&(t=new Eden.AST.Literal("STRING","*"),this.next())}if(t){if(void 0===(o=this.pCODESELECTOR(!0)))return t;if(0<o.errors.length)return o;"literal"==t.type&&"literal"==o.type?t.value+=o.value:((s=new Eden.AST.BinaryOp("//")).left(t),s.setRight(o),t=s)}else e||(t=new Eden.AST.Literal("STRING","")).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN));return t}}(),Eden.AST.prototype.pDEFINITION=function(){this.next();var e=new Eden.AST.Definition,t=this.parent;if(this.parent=e,this.isdynamic=!1,this.version>=Eden.AST.VERSION_CS3&&":"==this.token&&(this.next(),n=this.pATTRIBUTES(),!e.setAttributes(n)))return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.DOBADATTRIB)),this.parent=t,e;var n=this.pEXPRESSION_ASYNC();return e.setExpression(n),this.isdynamic&&(e.isdynamic=!0),this.parent=t,e},Eden.AST.prototype.pRANGE_STATEMENT=function(){this.next();var e=new Eden.AST.Range(this.pEXPRESSION());return".."===this.token||e.expression.typevalue!==Eden.AST.TYPE_NUMBER&&e.expression.typevalue!==Eden.AST.TYPE_BOOLEAN?".."===this.token&&(this.next(),e.setSecond(this.pEXPRESSION())):e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BADEXPRTYPE)),e},Eden.AST.prototype.pASSIGNMENT=function(){var e;this.next(),this.version>=Eden.AST.VERSION_CS3&&":"==this.token&&(this.next(),e=this.pATTRIBUTES());var t=new Eden.AST.Assignment(this.pEXPRESSION());return t.setAttributes(e)?t.expression&&"query"==t.expression.type&&(t.warning=new Eden.SyntaxWarning(this,t,Eden.SyntaxWarning.MISSINGSYNC,"This is an asynchronous statement")):(t.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.DOBADATTRIB)),this.parent=parent),t},Eden.AST.prototype.pMODIFY_PLUS=function(){return this.next(),new Eden.AST.Modify("+=",this.pEXPRESSION())},Eden.AST.prototype.pMODIFY_ARITH=function(){var e=this.token;this.next();let t=new Eden.AST.Modify(e,this.pEXPRESSION());return t.expression&&t.expression.typevalue!==Eden.AST.TYPE_NUMBER&&0!==t.expression.typevalue&&t.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BADEXPRTYPE)),t},Eden.AST.prototype.pMODIFY_CONCAT=function(){this.next();let e=new Eden.AST.Modify("//=",this.pEXPRESSION());return!e.expression||e.expression.typevalue!==Eden.AST.TYPE_NUMBER&&e.expression.typevalue!==Eden.AST.TYPE_BOOLEAN&&e.expression.typevalue!==Eden.AST.TYPE_OBJECT||e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BADEXPRTYPE)),e},Eden.AST.prototype.pMODIFY_INCDEC=function(){var e=this.token;return this.next(),new Eden.AST.Modify(e,void 0)},Eden.AST.prototype.pSUBSCRIBERS=function(){this.next();var e=new Eden.AST.Subscribers;return"["!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.SUBSCRIBEOPEN)),e):(this.next(),e.setList(this.pOLIST()),0<e.errors.length||("]"!=this.token?e.error(new Eden.SyntaxError(this,Eden.SyntaxError.SUBSCRIBECLOSE)):this.next()),e)},Eden.AST.prototype.pFUNCCALL_STAT=function(){var e=new Eden.AST.FunctionCall;if(this.next(),")"!=this.token){if(e.setParams(this.pELIST()),0<e.errors.length)return e;if(")"!=this.token)return e.error(new Eden.SyntaxError(this,Eden.SyntaxError.FUNCCLOSE)),e}return this.next(),e},Eden.AST.prototype.pSTATEMENT_PP=function(e){switch(this.scopedependencies=null,this.token){case"is":return this.pDEFINITION();case"in":return this.pRANGE_STATEMENT();case"=":return this.pASSIGNMENT();case"+=":return this.pMODIFY_PLUS();case"-=":case"/=":case"*=":return this.pMODIFY_ARITH();case"//=":return this.pMODIFY_CONCAT();case"++":case"--":return this.pMODIFY_INCDEC();case"~>":return this.pSUBSCRIBERS();case"(":return this.pFUNCCALL_STAT()}var t=[];t.push(new Eden.SyntaxError(this,Eden.SyntaxError.DEFINITION));var n=new Eden.AST.Assignment(void 0);return n.errors.unshift(t[0]),n},Eden.AST.prototype.pSTATEMENT_P=function(e){var t=this.stream.prevposition,n=this.pLVALUE();if(0<n.errors.length)return n;var r=this.pSTATEMENT_PP(e);if(r.left(n),0<r.errors.length)return r;e=this.lastposition,n=this.stream.code.substring(t,e);return";"!==n[n.length-1]&&(n+=";"),r.setSource(t,e,n),r.parent=this.parent,r},Eden.AST.prototype.pSUB_STATEMENT=function(){var e=new Eden.AST.SubStatement;if("parse"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BADEXPRTYPE)),e;if(this.next(),"("!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.EVALCLOSE)),e;this.next();var t=this.pEXPRESSION();return e.setOperation("parse",t),t.isconstant&&0!=t.typevalue&&t.typevalue!=Eden.AST.TYPE_STRING&&this.typeWarning(e,Eden.AST.TYPE_STRING,t.typevalue),")"!=this.token?e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.EVALCLOSE)):this.next(),e},Eden.AST.prototype.pSTAT_DEFAULT=function(){this.next();var e=new Eden.AST.Default;return":"!=this.token?e.error(new Eden.SyntaxError(this,Eden.SyntaxError.DEFAULTCOLON)):this.next(),e},Eden.AST.prototype.pSTAT_COMMENT=function(){var e=this.stream.position+1,t=this.stream.line,n=33==this.stream.peek(),r=0;do{let e=this.stream;for(;e.valid();){var i=e.code.charCodeAt(e.position);if(123===i?++r:125===i&&--r,10===i||r<0)break;++e.position}}while(!(r<0)&&(this.stream.valid()||this.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.NEWLINE)),this.stream.skip(),this.stream.line++,35==this.stream.peek()&&35!=this.stream.peek2()));return n&&((e=new Eden.AST.DoxyComment(this.stream.code.substring(e,this.stream.position-1).trim(),t,this.stream.line)).parent=this.parentDoxy,e.content.endsWith("@{")?this.parentDoxy=e:e.content.startsWith("@}")&&this.parentDoxy&&(this.parentDoxy=this.parentDoxy.parent),!this.lastStatement||void 0!==this.lastStatement.doxyComment||this.lastStatEndline!=t-1&&this.lastStatEndline!=t?this.lastDoxyComment.push(e):this.lastStatement.setDoxyComment(e)),this.next(),new Eden.AST.DummyStatement},Eden.AST.prototype.pSTAT_RETURN=function(){this.next();var e=new Eden.AST.Return;return";"==this.token?e:(e.setResult(this.pEXPRESSION()),e.errors.length,e)},Eden.AST.prototype.pSTAT_OBSERVABLE=function(e){var t,n=this.pLVALUE();if(0<n.errors.length)return(t=new Eden.AST.DummyStatement).lvalue=n,t.errors=n.errors,t;n.source=this.stream.code.substring(e,this.lastposition).trim();e=this.pSTATEMENT_PP();return e.left(n),t=(e.errors.length,e)},Eden.AST.prototype.pSTATEMENT=function(){var e,t,n=this.stream.prevposition,r=this.stream.line-1,i=void 0,s=this.lastDoxyComment&&0<this.lastDoxyComment.length?this.lastDoxyComment.pop():void 0;0==this.lastDoxyComment.length&&this.parentDoxy&&this.lastDoxyComment.push(this.parentDoxy);switch(this.token){case"proc":case"func":i=this.pFUNCTION();break;case"when":this.next(),i=this.pWHEN();break;case"action":this.next(),i=this.pNAMEDSCRIPT();break;case"for":this.next(),i=this.pFOR();break;case"while":this.next(),i=this.pWHILE();break;case"do":this.next(),i=this.pDO();break;case"exec":this.next(),i=this.pEXEC();break;case"wait":this.next(),i=this.pWAIT();break;case"switch":this.next(),i=this.pSWITCH();break;case"case":this.next(),i=this.pCASE();break;case"insert":this.next(),i=this.pINSERT();break;case"delete":this.next(),i=this.pDELETE();break;case"append":this.next(),i=this.pAPPEND();break;case"shift":this.next(),i=this.pSHIFT();break;case"require":this.next(),i=this.pREQUIRE();break;case"after":this.next(),i=this.pAFTER();break;case"import":this.next(),i=this.pIMPORT();break;case"para":i=this.pPARAMS();break;case"const":case"local":case"auto":i=this.pLOCALS();break;case"default":i=this.pSTAT_DEFAULT();break;case"if":this.next(),i=this.pIF();break;case"#":i=this.pSTAT_COMMENT();break;case"##":i=this.pSECTION(),0<this.lastDoxyComment.length&&this.lastline==this.lastDoxyComment[0].startline-1&&i.setDoxyComment(this.lastDoxyComment.shift());break;case"%":i=this.pCUSTOM_SECTION();break;case"return":i=this.pSTAT_RETURN();break;case"continue":this.next();var o=new Eden.AST.Continue;if(0<o.errors.length){i=o;break}i=o;break;case"break":this.next(),0;o=new Eden.AST.Break;if(0<o.errors.length){i=o;break}i=o;break;case"{":this.next();var a=this.pSCRIPT();if("}"!==this.token){a.error(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)),i=a;break}this.next(),i=a;break;case"${":if(this.next(),i=this.pSUB_STATEMENT(),"}"!==this.token){i.error(new Eden.SyntaxError(this,Eden.SyntaxError.EVALCLOSE));break}this.next();break;case"JAVASCRIPT":r=this.data.line-1,a=this.data.value;this.next(),i=new Eden.AST.Literal("JAVASCRIPT",a);break;case"?":this.next(),i=this.pQUERY();break;case"(":case"`":case"*":case"OBSERVABLE":i=this.pSTAT_OBSERVABLE(n);break;default:i=void 0}if(!i&&this.options&&this.options.tolerant)switch(this.token){case"is":case"=":var d=new Eden.AST.LValue;d.setObservable("__error__");var c=this.pSTATEMENT_PP();c.left(d),i=c,console.error("Recovery",i)}if(!i)return i;0<i.errors.length&&i.errors[i.errors.length-1]!==this.last_error&&(this.last_error=i.errors[i.errors.length-1]),";"===this.token&&this.next(),t=this.lastposition,e=this.lastline,i.parent=this.parent,i.local=this.localStatus,i.line=this.stream.line-r,void 0===i.doxyComment&&(i.setDoxyComment||console.error("Bad stat",i),i.setDoxyComment(s)),i.stamp=this.stamp;var h=this.stream.code.substring(n,t),s=s?(s.content.match(/\n/g)||"").length:0;return i.numlines=e-r-1+s,i.setSource(n,t,h),"dummy"!==i.type&&(this.lastStatement=i,this.lastStatEndline=e),i},Eden.AST.prototype.pSTATEXPR=function(){this.stream.prevposition;var e=void 0,t=this.lastDoxyComment;switch(this.parentDoxy&&(this.lastDoxyComment=this.parentDoxy),this.token){case"proc":case"func":case"when":case"wait":case"do":case"require":case"after":case"import":case"action":(e=new Eden.AST.DummyStatement).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN));break;case"for":this.next(),e=this.pFOR();break;case"while":this.next(),e=this.pWHILE();break;case"switch":this.next(),e=this.pSWITCH();break;case"case":this.next(),e=this.pCASE();break;case"insert":this.next(),e=this.pINSERT();break;case"delete":this.next(),e=this.pDELETE();break;case"append":this.next(),e=this.pAPPEND();break;case"shift":this.next(),e=this.pSHIFT();break;case"para":case"oracle":e=this.pPARAMS();break;case"local":case"auto":e=this.pLOCALS();break;case"default":this.next();var n=new Eden.AST.Default;":"!=this.token?n.error(new Eden.SyntaxError(this,Eden.SyntaxError.DEFAULTCOLON)):this.next(),e=n;break;case"if":this.next(),e=this.pIF();break;case"return":this.next();var r=new Eden.AST.Return;if(";"==this.token){e=r;break}if(r.setResult(this.pEXPRESSION()),0<r.errors.length){e=r;break}e=r;break;case"continue":this.next();r=new Eden.AST.Continue;if(0<r.errors.length){e=r;break}e=r;break;case"break":this.next();var i=new Eden.AST.Break;if(0<i.errors.length){e=i;break}e=i;break;case"{":this.next();i=this.pSCRIPT();if("}"!=this.token){i.error(new Eden.SyntaxError(this,Eden.SyntaxError.ACTIONCLOSE)),endline=this.stream.line,e=i;break}endline=this.stream.line,this.next(),e=i;break;case"JAVASCRIPT":curline=this.data.line-1;var s=this.data.value;this.next(),e=new Eden.AST.Literal("JAVASCRIPT",s);break;case"`":case"*":case"OBSERVABLE":s=this.pLVALUE();if(0<s.errors.length){(e=new Eden.AST.DummyStatement).lvalue=s,e.errors=s.errors;break}var o=this.pSTATEMENT_PP();if(o.left(s),0<o.errors.length){e=o,endline=this.stream.line;break}end=this.stream.position,endline=this.stream.line,void 0===this.definitions[s.name]&&(this.definitions[s.name]=[]),this.definitions[s.name].push(o),e=o;break;default:return}return";"===this.token&&this.next(),e.parent=this.parent,e.doxyComment=t,e.version=this.version,e},Eden.AST.prototype.pSWITCH=function(){var e=new Eden.AST.Switch,t=this.parent;return this.parent=e,"("!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.SWITCHOPEN)),this.parent=t,e):(this.next(),e.setExpression(this.pEXPRESSION()),0<e.errors.length?(this.parent=t,e):")"!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.SWITCHCLOSE)),this.parent=t,e):(this.next(),"{"!=this.token?e.error(new Eden.SyntaxError(this,Eden.SyntaxError.SWITCHSCRIPT)):e.setStatement(this.pSTATEMENT()),this.parent=t,e))},Eden.AST.prototype.pCASE=function(){var e=new Eden.AST.Case;return"STRING"!=this.token&&"NUMBER"!=this.token?(e.error(new Eden.SyntaxError(this,Eden.SyntaxError.CASELITERAL)),e):(e.setLiteral(this.token,this.data.value),this.next(),":"!=this.token?e.error(new Eden.SyntaxError(this,Eden.SyntaxError.CASECOLON)):this.next(),e)},Eden.AST.prototype.pTERM=function(){var e=this.pTERM_A(),t=this.pEXPRESSION_PPPPPP();return t?(t.left(e),t):e},Eden.AST.prototype.pTERM_A=function(){for(var e=this.pTERM_P();"<"===this.token||"<="===this.token||">"===this.token||">="===this.token||"=="===this.token||"!="===this.token;){var t=new Eden.AST.BinaryOp(this.token);this.next(),t.left(e),t.setRight(this.pTERM_P()),(e=t).typevalue=Eden.AST.TYPE_BOOLEAN}return e},Eden.AST.prototype.pTERM_P=function(){for(var e=this.pTERM_PP();"+"===this.token||"-"===this.token||"//"===this.token;){var t=new Eden.AST.BinaryOp(this.token);this.next(),t.left(e),t.setRight(this.pTERM_PP()),"//"===(e=t).op?(0!==t.l.typevalue&&0!==t.r.typevalue&&t.l.typevalue!==t.r.typevalue&&this.typeWarning(t),t.l.typevalue!==Eden.AST.TYPE_NUMBER&&t.r.typevalue!==Eden.AST.TYPE_NUMBER||this.typeWarning(t,null,Eden.AST.TYPE_NUMBER),t.l.typevalue!==Eden.AST.TYPE_OBJECT&&t.r.typevalue!==Eden.AST.TYPE_OBJECT||this.typeWarning(t,null,Eden.AST.TYPE_OBJECT)):(t.l.typevalue!==Eden.AST.TYPE_OBJECT&&t.r.typevalue!==Eden.AST.TYPE_OBJECT||this.typeWarning(t,null,Eden.AST.TYPE_OBJECT),t.l.typevalue!==Eden.AST.TYPE_LIST&&t.r.typevalue!==Eden.AST.TYPE_LIST||this.typeWarning(t,null,Eden.AST.TYPE_LIST))}return e},Eden.AST.prototype.pTERM_PP=function(){for(var e=this.pTERM_PPP();"*"===this.token||"/"===this.token||"%"===this.token||"^"===this.token;){var t=new Eden.AST.BinaryOp(this.token);this.next(),t.left(e),t.setRight(this.pTERM_PPP()),(0!==(e=t).l.typevalue&&t.l.typevalue!==Eden.AST.TYPE_NUMBER||0!==t.r.typevalue&&t.r.typevalue!==Eden.AST.TYPE_NUMBER)&&this.typeWarning(t,Eden.AST.TYPE_NUMBER)}return e},Eden.AST.prototype.pTERM_PPP=function(){var e=this.pFACTOR(),t=this.pEXPRESSION_PPPPP();return t?(t.left(e),e.typevalue!==Eden.AST.TYPE_UNKNOWN&&e.typevalue!==Eden.AST.TYPE_LIST&&e.typevalue!==Eden.AST.TYPE_STRING&&t.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.BADEXPRTYPE)),t):e},Eden.AST.prototype.pWAIT=function(){var e=new Eden.AST.Wait;if(";"==this.token)return this.next(),e;var t=this.pEXPRESSION();return e.setDelay(t),";"===this.token&&this.next(),e},Eden.AST.prototype.pWHEN=function(){var e=new Eden.AST.When,t=this.parent;if(this.parent=e,"role"==this.token){if(this.next(),"OBSERVABLE"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.WHENROLE)),this.parent=t,e;e.roles=this.pOLIST()}if("("!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.WHENOPEN)),this.parent=t,e;if(this.next(),e.setExpression(this.pEXPRESSION()),0<e.errors.length)return this.parent=t,e;if(")"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.WHENCLOSE)),this.parent=t,e;if(this.next(),e.setStatement(this.pSTATEMENT()),0<e.errors.length)return this.parent=t,e;if(void 0===e.statement)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.WHENNOSTATEMENT)),e.active=!0,this.parent=t,e;if("with"==this.token||"::"==this.token){this.next();var n=this.pSCOPE();if(e.setScope(n),0<n.errors.length)return e}return e.compile(this),this.whens.push(e),this.parent=t,e},Eden.AST.prototype.pWHILE=function(){var e=new Eden.AST.While,t=this.parent;return(this.parent=e).warning=new Eden.SyntaxWarning(this,e,Eden.SyntaxWarning.USEOFWHILE),e.setCondition(this.pEXPRESSION()),0<e.errors.length?(this.parent=t,e):(e.setStatement(this.pSTATEMENT()),void 0===e.statement&&e.error(new Eden.SyntaxError(this,Eden.SyntaxError.WHILENOSTATEMENT)),this.parent=t,e)},Eden.AST.prototype.pQUERY=function(){var e,t,n=new Eden.AST.Query,r=[];return"OBSERVABLE"==this.token?(n.observable=this.data.value,this.next(),n):"("!=this.token?(n.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.QUERYOPEN)),n):(this.next(),n.setSelector(this.pCODESELECTOR()),")"!=this.token?n.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.QUERYCLOSE)):(this.next(),this.version>=Eden.AST.VERSION_CS3&&":"==this.token?(this.next(),e=this.pATTRIBUTES(),r=Object.keys(e)):"["==this.token&&(t=this.pATTRIBUTES(),r=Object.keys(t)),"="!=this.token&&"+="!=this.token&&"//="!=this.token||(e=this.token,this.next(),t=this.pEXPRESSION(),n.setModify(t,e)),r.length,n.setResultTypes(r)),n)},Eden.AST.prototype.pINDEXED=function(){for(var e=new Eden.AST.Indexed;this.stream.valid()&&("["==this.token||"."==this.token||"("==this.token);)if("["==this.token){this.next();var t=new Eden.AST.Index;if("]"==this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXEXP)),e;if(0<(i=this.pEXPRESSION()).errors.length)return t.setExpression(i),e.addIndex(t),e;if("literal"==i.type&&"NUMBER"==i.datatype&&i.value<1)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.OUTOFBOUNDS)),e;if("]"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXCLOSE)),e;this.next(),t.setExpression(i),e.addIndex(t)}else if("("==this.token){this.next();var n=new Eden.AST.FunctionCall;if(")"==this.token)this.next(),e.addIndex(n);else{var r=this.pELIST();if(n.setParams(r),0<n.errors.length)return e.addIndex(n),e;if(")"!=this.token)return e.addIndex(n),0<n.errors.length||e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.FUNCCALLEND)),e;this.next(),e.addIndex(n)}}else{this.next();t=new Eden.AST.Index;if("OBSERVABLE"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.LISTINDEXEXP)),e;var i=new Eden.AST.Literal("STRING",this.data.value);this.next(),t.setExpression(i),e.addIndex(t)}return e},Eden.AST.prototype.pSECTION=function(){for(var e=1;35==this.stream.peek();)e++,this.stream.skip();var t=this.stream.readLine().trim();return this.stream.valid()?(this.stream.position--,this.stream.line--):this.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.NEWLINE)),this.next(),stat=new Eden.AST.Section,stat.setName(t),stat.depth=e,stat},Eden.AST.prototype.pCUSTOM_SECTION=function(){if(this.next(),"OBSERVABLE"!=this.token)return(i=new Eden.AST.Literal("STRING",this.data.value)).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.HEREDOCTOKEN)),i;var e=this.data.value;if(10!=this.stream.get())return(i=new Eden.AST.Literal("STRING",this.data.value)).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.HEREDOCTOKEN)),i;for(var t="";this.stream.valid();){var n=this.stream.position,r=this.stream.readLine();if(r.startsWith("%eden")){this.stream.position=n+5;break}t+=r}this.stream.valid()||this.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.NEWLINE)),this.next();var i=new Eden.AST.CustomBlock;return i.text=t,i.setName(e),i},Eden.AST.prototype.pHTML=function(){this.next();var e=new Eden.AST.HTML;if("OBSERVABLE"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e;for(e.setName(this.data.value),this.next();"OBSERVABLE"==this.token;){var t=this.stream.prevposition,n=this.data.value;for(this.next();"-"==this.token;){if(n+="-",this.next(),"OBSERVABLE"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e;n+=this.data.value,this.next()}if(this.stream.prevposition-t!=n.length)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e;if("OBSERVABLE"!=this.token&&">"!=this.token&&"/"!=this.token){if("="!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e;if(this.next(),"STRING"!=this.token){if("{"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e;if(this.next(),e.addAttribute(n,this.pEXPRESSION()),0<e.errors.length)return e;if("}"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e;this.next()}else e.addAttribute(n,new Eden.AST.Literal("STRING",this.data.value)),this.next()}else e.addAttribute(n,new Eden.AST.Literal("BOOLEAN",!0))}if("/"==this.token)return this.next(),">"!=this.token&&e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),this.next(),e;if(">"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e;var r=this.stream.position,i=this.stream.position;for(this.next();this.stream.valid()&&"</"!=this.token;)if("<"==this.token)r<i-1&&e.addContent(new Eden.AST.Literal("STRING",this.stream.code.substring(r,i).replace(/\n/g,"\\n"))),e.addContent(this.pHTML()),r=i=this.stream.prevposition;else if("{"==this.token){if(this.next(),r<i-1&&e.addContent(new Eden.AST.Literal("STRING",this.stream.code.substring(r,i).replace(/\n/g,"\\n"))),e.addContent(this.pEXPRESSION()),"}"!=this.token)return e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e;r=i=this.stream.position,this.next()}else i=this.stream.position,this.next();return r<i&&e.addContent(new Eden.AST.Literal("STRING",this.stream.code.substring(r,i).replace(/\n/g,"\\n"))),"</"!=this.token?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e):(this.next(),"OBSERVABLE"!=this.token||this.data.value!=e.name?(e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)),e):(this.next(),">"!=this.token?e.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN)):this.next(),e))},Eden.AST.prototype.pTEMPLATE_STRING=function(e){for(var t,n=this.token,r=this.stream.position;!this.stream.eof();){var i,s,o,a=this.stream.get(),d=String.fromCharCode(a);if(d===n)return s=(s=this.stream.code.substring(r,this.stream.position-1)).replace(/\\([\\\{\}'])/g,"$1"),this.next(),0==s.length&&t?t:t?((i=new Eden.AST.BinaryOp("//")).left(t),i.setRight(new Eden.AST.Literal("STRING",s)),i):new Eden.AST.Literal("STRING",s);if("\\"===d)this.stream.skip();else{if("}"===d)return t=new Eden.AST.Literal("UNDEFINED"),this.syntaxError(t,Eden.SyntaxError.UNKNOWN),t;if("{"===d){if(s=(s=this.stream.code.substring(r,this.stream.position-1)).replace(/\\([\\\{\}'])/g,"$1"),this.next(),(c=this.pEXPRESSION()).typevalue!=Eden.AST.TYPE_LIST&&c.typevalue!=Eden.AST.TYPE_OBJECT||this.typeWarning(c,Eden.AST.TYPE_STRING,c.typevalue),"}"!==this.token)return c.errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN,"Missing template expression close")),c;r=this.stream.position,t=0<s.length&&t?((i=new Eden.AST.BinaryOp("//")).left(t),i.setRight(new Eden.AST.Literal("STRING",s)),t=i,(i=new Eden.AST.BinaryOp("//")).left(t),i.setRight(c),i):0<s.length?((i=new Eden.AST.BinaryOp("//")).left(new Eden.AST.Literal("STRING",s)),i.setRight(c),i):c}else if("${"===d){var c=this.pEXPRESSION();this.token}else if(!e&&this.stream.isWhiteSpace(a))return s=(s=this.stream.code.substring(r,this.stream.position-1)).replace(/\\([\\\{\}'])/g,"$1"),(o=new Eden.AST.Literal("STRING",s)).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN,"White space not allowed")),o}}return s=(s=this.stream.code.substring(r,this.stream.position-1)).replace(/\\([\\\{\}'])/g,"$1"),(o=new Eden.AST.Literal("STRING",s)).errors.push(new Eden.SyntaxError(this,Eden.SyntaxError.UNKNOWN,"End of input")),o},Eden.Project=function(e,t,n,r){this.title=t,this.name=t.replace(/[^a-zA-Z0-9]/g,""),this.author=void 0,this.authorid=-1,this.tags=t.toLowerCase().split(" "),this.src=n;const i={autorecover:!0,tolerant:!0};void 0!==r.options.parser&&(i.version=r.options.parser),this.ast=new Eden.AST(n,void 0,this,i),this.id=e,this.vid=void 0,this.parentid=void 0,this.thumb=void 0,this.desc=void 0,this.readPassword=void 0,this.autosavetimeout=void 0,this.success=this.ast&&0==this.ast.script.errors.length,this.instance=r,this.ast&&0==this.ast.script.errors.length||(console.error("Project Error",this.ast.script.errors),r.exec("do lib:unexecuted; do lib > recovery;").then(e=>{for(let e=0;e<this.ast.script.errors.length;++e)r.emit("error",[{name:"Project"},this.ast.script.errors[e]])})),r.root.lookup("jseden_project_name").assign(this.name,r.root.scope,EdenSymbol.localJSAgent),Object.defineProperty(this,"statements",{enumerable:!0,get:function(){return this.ast.script.statements}})},Eden.Project.listenTo=listenTo,Eden.Project.emit=emit,Eden.Project.unListen=unListen,Eden.Project.listeners={},Eden.Project.init=function(n){return n.root.lookup("jseden_project_title").addJSObserver("project",function(e,t){e.origin!==n.project&&void 0!==n.project&&(n.project.title=t,void 0===this.id&&(Eden.Index.remove(n.project.ast.script),n.project.name=t.replace(/[^a-zA-Z0-9]/g,""),n.project.ast.script.name=n.project.name,console.log("REINDEX PROJECT"),Eden.Index.update(n.project.ast.script)),n.project.ast.script.doxyComment=n.project.ast.doxyFromOrigin(),Eden.Fragment.emit("aststatus",[n.project.ast.script]))}),Eden.Utils.getURL("resources/projects.db.json").then(function(e){Eden.Project.local=JSON.parse(e)})},Eden.Project.loadFromFile=function(e){var t=e.name;t=(t=t.substring(0,t.lastIndexOf("."))).replace(/\([0-9]+\)/,""),console.log("FILE",e),Eden.Project.emit("loading",[this]);var n=new FileReader;n.onload=function(e){eden.project=new Eden.Project(void 0,t,e.target.result.replace(/\r/g,""),eden),eden.project.start()},n.readAsText(e)},Eden.Project.newFromExisting=function(t,n,r){var i=this;Eden.Project.emit("loading",[i]),Eden.Project.local[t]&&(Eden.Project.local[t].id?Eden.Project.load(Eden.Project.local[t].id,void 0,void 0,r):Eden.Utils.getURL(Eden.Project.local[t].file).then(function(e){n.root.lookup("jseden_project_mode").assign("restore",n.root.scope,EdenSymbol.defaultAgent),n.project=new Eden.Project(void 0,t,e,n),n.project.start(function(){Eden.Project.emit("load",[i]),r&&r(n.project)})}))},Eden.Project.search=function(e,t){},Eden.Project.load=function(s,e,o,a){var d=this;3==arguments.length&&(a=o,o=void 0),Eden.Project.emit("loading",[d]),Eden.DB.load(s,e,o,function(e){var t,n,r,i;e&&(r=!0,null!==(t=e).projectMetaData&&(i=JSON.parse(t.projectMetaData)).env&&(Eden.Project.verifyEnvironment(i.env)||((n=Eden.Project.findEnvironment(i.env))?document.location=n+URLUtil.updateQueryString({load:s,vid:e.saveID,r:o||""}):alert("This project needs a different version of JS-Eden")),i.env.parser_cs3&&(r=!1)),r=r&&!e.source.startsWith('"use cs2;"')?'"use cs2;"\n'+e.source:e.source,eden.project=new Eden.Project(s,t.minimisedTitle,r,eden),console.log("LOAD PROJECT",e),eden.project.vid=e.saveID,eden.project.title=t.title,eden.project.author=t.ownername,eden.project.authorid=t.owner,eden.project.thumb=t.image,eden.project.tags=t.tags.trim().split(" "),eden.project.parentid=t.parentProject,eden.root.lookup("jseden_project_title").assign(t.title,eden.root.scope,EdenSymbol.localJSAgent),eden.root.lookup("jseden_project_name").assign(t.minimisedTitle,eden.root.scope,EdenSymbol.localJSAgent),eden.root.lookup("jseden_project_thumb").assign(t.image,eden.root.scope,EdenSymbol.localJSAgent),eden.root.lookup("jseden_project_author").assign(t.ownername,eden.root.scope,EdenSymbol.localJSAgent),i&&(eden.project.desc=i.description),eden.project.ast.script.doxyComment=eden.project.ast.doxyFromOrigin(),eden.project.start(function(){Eden.Project.emit("load",[d])}),i=URLUtil.updateQueryString({load:eden.project.id,vid:eden.project.vid,r:o||""}),document.location.search!=i&&window.history.pushState({id:eden.project.id,vid:eden.project.vid},"",i)),a&&a(eden.project)})},Eden.Project.verifyEnvironment=function(e){for(var t in console.log("Environment:",e),e.hasOwnProperty("parser_cs3")&&0!=e.parser_cs3||(Eden.AST.version=Eden.AST.VERSION_CS2,eden.root.lookup("jseden_parser_cs3").assign(!1,eden.root.scope,EdenSymbol.defaultAgent),console.log("Disable cs3")),e){var n=eden.root.lookup("jseden_"+t).value();if("string"==typeof e[t])switch(e[t].charAt(0)){case">":if(n<=parseInt(e[t].substring(1)))return!1;break;case"<":if(n>=parseInt(e[t].substring(1)))return!1;break;case">=":if(n<parseInt(e[t].substring(1)))return!1;break;case"<=":if(n>parseInt(e[t].substring(1)))return!1;break;case"=":if(n!==parseInt(e[t].substring(1)))return!1;break;default:if(n!=e[t])return!1}else if(n!=e[t])return console.log("Environment mismatch: ",t,n,e[t]),!1}return!0},Eden.Project.findEnvironment=function(e){return e.webgl&&!eden.root.lookup("jseden_webgl").value()?"http://jseden.dcs.warwick.ac.uk/webgl/index.html":!e.webgl&&eden.root.lookup("jseden_webgl").value()?"http://jseden.dcs.warwick.ac.uk/construit/index.html":null},Eden.Project.prototype.environment=function(){return{version_major:eden.root.lookup("jseden_version_major").value(),webgl:eden.root.lookup("jseden_webgl").value(),p2p_constructs:eden.root.lookup("jseden_p2p_constructs").value(),parser_cs3:eden.root.lookup("jseden_parser_cs3").value()}},Eden.Project.prototype.start=function(t){var n=this;if(0<this.ast.errors.length){for(var e=0;e<this.ast.errors.length;++e)console.error("Project parse error: ",this.ast.errors[e].toString());t&&t()}else{if("recover"==this.instance.get("jseden_project_mode"))return this.success=!1,void eden.exec("do lib:unexecuted; do lib > recovery;").then(e=>{eden.root.enableActions(),t&&t()});this.ast.execute(this,eden.root.scope,function(){if(n.ast.scripts.ACTIVE){for(var e=0;e<n.ast.script.statements.length;e++)if(n.ast.script.statements[e]===n.ast.scripts.ACTIVE){console.log(n.ast.script.statements[e]),n.ast.script.statements[e].removeIndex(),n.ast.script.statements[e].destroy(),eden.root.start=n.ast.script.statements[e].start,eden.root.end=n.ast.script.statements[e].end,eden.root.prefix=n.ast.script.statements[e].prefix,eden.root.postfix=n.ast.script.statements[e].postfix,eden.root.parent=eden.project.ast.script,Eden.Index.update(eden.root),n.ast.script.statements[e]=eden.root;break}}else n.ast.script.appendChild(eden.root);eden.root.parent=n.ast.script,n.ast.scripts.ACTIVE=eden.root,eden.root.enableActions(),t&&t()})}},Eden.Project.prototype.diff=function(e,t){return _diff(e||this.ast.stream.code,t||this.generate())},Eden.Project.prototype.save=function(e,t){Eden.DB.save(this,e,t)},Eden.Project.prototype.restore=function(){},Eden.Project.prototype.autosave=function(){var e;this.autosavetimeout||((e=this).autosavetimeout=setTimeout(function(){this.autosavetimeout=void 0,Eden.DB.localSave(e),console.log("Doing an autosave")},1e4))},Eden.Project.prototype.patch=function(e,t){},Eden.Project.prototype.localSave=function(){Eden.DB.localSave(this)},Eden.Project.prototype.snapshot=function(){},Eden.Project.prototype.addAction=function(e){e=Eden.AST.parseStatement("action "+e+" {}");return this.ast.script.appendChild(e),e.addIndex(),e},Eden.Project.prototype.generate=function(){return this.success?this.ast.getSource():this.src},Eden.Project.prototype.getDescription=function(){return void 0===this.desc&&(this.desc="# "+this.title+"\nEnter a project description here,\nand some hashtags as below.\n\nTags: #"+this.tags.join(" #")),this.desc},Eden.Project.prototype.setDescription=function(e){this.desc=e;e=new Eden.AST.DoxyComment(e,0,0);this.tags=e.getHashTags().map(function(e){return e.substring(1)})},Eden.Project.prototype.registerAgent=function(e,t){for(var n in e.executed=1,e.dependencies)eden.root.lookup(n).addObserver(e.id,e);!t&&eden.peer&&eden.peer.activateWhen(e.id)},Eden.Project.prototype.removeAgent=function(e,t){for(var n in e.executed=0,e.dependencies)eden.root.lookup(n).removeObserver(e.id);!t&&eden.peer&&eden.peer.deactivateWhen(e.id)},Eden.Fragment=function(e,t){this.name=e,this.selector=e,this.originast=void 0,this.origin=void 0,this.source=void 0,this.ast=void 0,this.lastast=void 0,this.locked=!0,this.remote=!1,this.results=[],this.title=e,this.scratch=!1,this.edited=!1,this.autosavetimer=void 0,this.history=[],this.snapshot="",this.index=-1;var r=this;this.reset(()=>{Eden.Fragment.listenTo("aststatus",this,function(e){e===r.originast&&(!(e=r.originast.doxyComment)||(e=e.getControls())["@title"]&&(r.title=e["@title"][0]),Eden.Fragment.emit("status",[r]))}),Eden.Fragment.listenTo("patch",this,function(e,t){e!==r&&t===r.originast&&(r.source=r.originast.getInnerSource(),r.ast=Eden.AST.fromNode(r.originast,r),Eden.Fragment.emit("changed",[r]))}),Eden.Fragment.listenTo("lock",this,function(e,t){t===r.originast&&(r.locked=!0,Eden.Fragment.emit("locked",[r]))}),Eden.Fragment.listenTo("unlock",this,function(e,t){t===r.originast&&(r.locked=!1,Eden.Fragment.emit("unlocked",[r]))}),Eden.Fragment.listenTo("goto",this,function(e,t){if(r.originast===e||e&&r.originast.id===e.id){var n=t.getStartLine(e);return Eden.Fragment.emit("gotoline",[r,n]),!0}return void 0===e&&this.setSourceInitial(t.source),!1}),t&&t()})},Eden.Fragment.listenTo=listenTo,Eden.Fragment.emit=emit,Eden.Fragment.unListen=unListen,Eden.Fragment.listeners={},Eden.Fragment.prototype.destroy=function(){Eden.Fragment.unListen(this),this.unlock()},Eden.Fragment.prototype.reset=function(r){var i=this;if(this.scratch)return i.lock(),i.snapshot=i.source,Eden.Fragment.emit("changed",[i]),void(r&&r());Eden.Selectors.query(this.selector,void 0,{minimum:1},function(e){if(i.results=e,i.results&&1==i.results.length&&"script"==i.results[0].type)i.originast=i.results[0];else if(i.results&&1==i.results.length&&"assignment"==i.results[0].type)i.originast=void 0;else if(i.results&&1<i.results.length){for(var t="",n=0;n<i.results.length;n++)t+=i.results[n].getSource()+"\n";i.source=t,i.originast=void 0}else i.source="",i.originast=void 0;i.originast?(i.name=i.originast.name||i.selector,Eden.AST.fromNode(i.originast,i).then(e=>{i.ast=e,i.source=i.ast.stream.code;for(var t=i.originast;t&&t.parent;)t=t.parent;i.origin=t.base?t.base.origin:{remote:!0},i.remote=i.origin.remote,i.locked=0<i.originast.lock||i.remote;e=i.originast.doxyComment;e?(e=(i.doxy=e).getControls())["@title"]&&(i.title=e["@title"][0]):i.doxy=void 0,Eden.Fragment.emit("changed",[i]),i.locked&&Eden.Fragment.emit("locked",[i]),i.lock(),i.snapshot=i.source,r&&r()})):(console.log("Make scratch fragment"),i.locked=!1,i.remote=!1,i.ast=new Eden.AST(i.source,void 0,i,{noindex:!0,strict:!0}),i.originast=i.ast.script,i.name="*Scratch*",i.title=i.name,i.scratch=!0,Eden.Fragment.emit("changed",[i]),i.lock(),i.snapshot=i.source,r&&r())})},Eden.Fragment.prototype.getSource=function(){return this.source||""},Eden.Fragment.prototype.makeReal=function(e){if(this.scratch){this.name=e,this.title=e,this.originast=eden.project.addAction(e),this.selector=Eden.Selectors.getID(this.originast),this.scratch=!1,this.remote=!1,this.setSource(this.source);for(var t=this.originast;t&&t.parent;)t=t.parent;this.origin=t.base.origin,this.lock()}},Eden.Fragment.prototype.setSourceInitial=function(e){this.source=e,this.snapshot=e,this.ast=new Eden.AST(e,void 0,this,{strict:!0,noindex:this.scratch})},Eden.Fragment.AUTOSAVE_INTERVAL=2e3,Eden.Fragment.prototype.undo=function(){var e,t,n;this.index<0||0!=this.history.length&&(e=this.history[this.index],this.index--,n=0<=this.index&&this.history[this.index].snapshot?this.history[this.index].snapshot:(n=(t=new diff_match_patch).patch_fromText(e.undo),t.patch_apply(n,this.snapshot)[0]),this.snapshot=n,this.setSource(n))},Eden.Fragment.prototype.canUndo=function(){return 0<this.history.length&&0<=this.index},Eden.Fragment.prototype.canRedo=function(){return this.index<this.history.length-1},Eden.Fragment.prototype.redo=function(){var e,t,n;this.index>=this.history.length-1||(this.index++,n=(e=this.history[this.index]).snapshot||(n=(t=new diff_match_patch).patch_fromText(e.redo),t.patch_apply(n,this.snapshot)[0]),this.snapshot=n,this.setSource(n))},Eden.Fragment.prototype.addHistory=function(e,t){this.history.push({time:Date.now()/1e3|0,redo:e,undo:t}),this.index=this.history.length-1},Eden.Fragment.prototype.autoSave=function(){if(!(void 0===this.ast||0<this.ast.script.errors.length)&&this.originast&&!this.scratch){for(var e=this.originast;e.parent;)e=e.parent;e.base&&e.base.origin&&!e.base.origin.authorid==Eden.DB.userid&&(eden.root.lookup("jseden_script_livepatch").value()&&(console.log("AUTOSAVE",this.selector),Eden.DB.patch(Eden.Selectors.getID(this.originast),this.ast.script.getInnerSource())),this.autosavetimer=void 0)}},Eden.Fragment.prototype.diff=function(){if(this.origin&&this.origin.ast&&0<this.originast.end){var e=this.origin.ast.stream.code.substring(this.originast.start,this.originast.end),t=this.originast.prefix.length,n=this.originast.postfix.length,e=e.substring(t,e.length-n);return DiffUtil.diff(e,this.source)}},Eden.Fragment.prototype.setSource=function(e){if(!this.locked){var t=this;if(this.source=e,this.edited=!0,this.ast=new Eden.AST(e,void 0,this,{noindex:!0,strict:!0}),0==this.ast.errors.length){if(clearTimeout(this.autosavetimer),this.autosavetimer=setTimeout(function(){t.autoSave()},Eden.Fragment.AUTOSAVE_INTERVAL),this.originast){var n=this.originast.parent,e=this.originast.patchInner(this.ast.script);for(Eden.Fragment.emit("patch",[this,this.originast,e]);n;)Eden.Fragment.emit("patch",[this,n]),n=n.parent}Eden.Fragment.emit("status",[this]),eden.root.lookup("jseden_fragment_changed").assign(t.selector,eden.root.scope,Symbol.localJSAgent)}else Eden.Fragment.emit("errored",[this])}},Eden.Fragment.prototype.lock=function(){if(this.originast)for(var e=this.originast.parent;e;)e.lock++,Eden.Fragment.emit("lock",[this,e]),e=e.parent},Eden.Fragment.prototype.unlock=function(){if(this.originast)for(var e=this.originast.parent;e;)e.lock--,0==e.lock&&Eden.Fragment.emit("unlock",[this,e]),e=e.parent},Eden.Fragment.prototype.getTitle=function(){return(this.originast&&this.originast.name?this.originast:this).name},Eden.Query={},Eden.Query.sortByCount=sortByCount,Eden.Query.reduceByCount=reduceByCount,Eden.Query.negativeFilter=negativeFilter,Eden.Query.search=function(e,t){var n,r,i,s=e.split(/[ ]+/),o=0,a=s.length,d=!0,c=!0,h=!0,p=!0,l={views:[],symbols:[],whens:[],projects:[],scripts:[],statements:[]};if(0<s.length&&":"==s[0].charAt(s[0].length-1)){if(o=1,"select:"==s[0]){var u=e.substring(s[0].length).trim();return l.all=Eden.Selectors.queryWithinSync(null,u,"source"),void 0===l.all&&(l.all=[]),t&&t(l),t&&3<=u.length&&(Eden.Query.dbseltimeout&&clearTimeout(Eden.Query.dbseltimeout),Eden.Query.dbseltimeout=setTimeout(function(){Eden.Query.dbseltimeout=void 0,Eden.DB.searchSelector(u,"source",function(e){l.all.push.apply(l.all,e),t(l)})},1e3)),l}switch(s[0]){case"procs:":case"whens:":case"agents:":doremovescripts=h=d=!(c=!0);break;case"scripts:":p=h=!(d=c=!1)}}for(a-=o;o<s.length;o++)""!=s[o]?s[o].startsWith("depends:")?""!=(n=s[o].split(":"))[1]?(r=edenUI.regExpFromStr(n[1],void 0,void 0,"regexp"),d&&l.symbols.push.apply(l.symbols,Eden.Query.searchDepends(r))):a--:"#"==s[o].charAt(0)?(i=edenUI.regExpFromStr("^"+s[o].substring(1),void 0,void 0,"regexp"),d&&l.symbols.push.apply(l.symbols,Eden.Query.searchTags(i))):(r=edenUI.regExpFromStr(s[o],void 0,void 0,"regexp"),i=edenUI.regExpFromStr("^"+s[o],void 0,void 0,"regexp"),d&&l.symbols.push.apply(l.symbols,Eden.Query.searchSymbols(r,i)),c&&l.whens.push.apply(l.whens,Eden.Query.searchWhens(r)),p&&2<s[o].length?function(e){Eden.Query.dbtimeout&&clearTimeout(Eden.Query.dbtimeout),Eden.Query.dbtimeout=setTimeout(function(){Eden.Query.dbtimeout=void 0,Eden.DB.search(e,function(e){l.scripts.push.apply(l.scripts,e),l.scripts=reduceByCount(l.scripts,a),l.scripts=sortByLoaded(l.scripts),Eden.Query.mergeResults(l),t&&t(l)})},500)}(s[o]):h&&l.scripts.push.apply(l.scripts,Eden.Query.searchScripts(r))):a--;return l.symbols=reduceByCount(l.symbols,a),Eden.Query.mergeResults(l),t&&t(l),l},Eden.Query.mergeResults=function(i){i.all=[];var s=0;!function e(t,n){s=0;for(var r=n;r<i.symbols.length&&!(t<=s);r++)s++,i.all.push("/"+i.symbols[r]);s=0;for(r=n;r<i.whens.length&&!(t<=s);r++)s++,i.all.push(i.whens[r]);s=0;for(r=n;r<i.scripts.length&&!(t-1<=s);r++)s++,i.all.push("*script"+i.scripts[r]);s=0;for(r=n;r<i.statements.length&&!(t<=s);r++)s++,i.all.push(i.statements[r]);(i.symbols.length>n+t||i.whens.length>n+t||i.scripts.length>n+t)&&e(2,n+t)}(3,0)},Eden.Query.searchViews=function(e){},Eden.Query.searchSymbols=function(e,t){var n,r=[];for(n in eden.root.symbols){var i=eden.root.symbols[n];if(e.test(n))i.last_modified_by.internal||"_"==n.charAt(0)||r.push(n);else if(t&&eden.dictionary[n]){var s=eden.dictionary[n].getHashTags();if(s)for(var o=0;o<s.length;o++)if(t.test(s[o].substring(1))){i.last_modified_by.internal||"_"==n.charAt(0)||r.push(n);break}}}return r},Eden.Query.searchTags=function(e){var t,n=[];for(t in eden.root.symbols){var r=eden.root.symbols[t];if(e&&eden.dictionary[t]){var i=eden.dictionary[t].getHashTags();if(i)for(var s=0;s<i.length;s++)if(e.test(i[s].substring(1))){r.last_modified_by.internal||"_"==t.charAt(0)||n.push(t);break}}}return n},Eden.Query.searchDepends=function(e){var t,n=[];for(t in eden.root.symbols)for(var r in eden.root.symbols[t].dependencies)e.test(r)&&n.push(t);return n},Eden.Query.searchWhens=function(e){var t,n=[];for(t in Eden.Agent.agents){var r=Eden.Agent.agents[t];if(r.ast)for(var i in r.ast.triggers)if(e.test(i))for(var s=r.ast.triggers[i],o=0;o<s.length;o++)-1==n.indexOf(s[o].statement)&&n.push(s[o].statement)}return n},Eden.Query.searchProjects=function(e){},Eden.Query.searchScripts=function(e){var t,n=[];for(t in Eden.DB.meta)e.test(t)&&n.push(t);return n},Eden.Query.treeBottomUp=function(){var e,t={};for(e in eden.root.symbols){var n=eden.root.symbols[e];void 0!==n.definition&&0!=Object.keys(n.dependencies).length||(t[e]={})}return function e(t){for(var n in t){var r=eden.root.symbols[n];if(r){var i,s=t[n];for(i in r.subscribers)s[i]={};e(s)}}}(t),t},Eden.Query.treeTopDown=function(e){if(void 0===e)for(var t in e={},eden.root.symbols){var n=eden.root.symbols[t];n&&0==Object.keys(n.subscribers).length&&(e[t]={})}else if(Array.isArray(e)){for(var r={},i=0;i<e.length;i++)r[e[i]]={};e=r}return function e(t){for(var n in t){var r=eden.root.symbols[n];if(r){var i,s=t[n];for(i in r.dependencies)s[i]={};e(s)}}}(e),e},Eden.Query.objectHierarchy=function(){function o(e){if(void 0!==e.statid){e=Eden.Statement.statements[e.statid];if(e.statement&&e.statement.doxyComment&&e.statement.doxyComment.hasTag("#library"))return}return 1}var e,t={};for(e in eden.root.symbols){var n=eden.root.symbols[e];n&&o(n)&&0==Object.keys(n.subscribers).length&&0!=Object.keys(n.dependencies).length&&(t[e]={})}return function e(t){for(var n in t){var r=eden.root.symbols[n];if(r&&o(r)){var i,s=t[n];for(i in r.dependencies)s[i]={};e(s)}}}(t),t},Eden.Query.dependencyTree=function(e){var t,s={};function o(e){var t=e.name;if(0==Object.keys(e.subscribers).length)return void 0===s[t]&&(s[t]={}),s[t];var n,r={};for(n in e.subscribers){var i=o(e.subscribers[n]);void 0!==i[t]&&!function e(t,n){for(var r in n)void 0===t[r]?t[r]=n[r]:e(t[r],n[r])}(r,i[t]),i[t]=r}return r}for(t in e)o(eden.root.lookup(t));return s},Eden.Generator={},Eden.Generator.symbolScript=function(e){var t,n="## Functions\n",r="\n## Definitions\n",i="\n## Restored Definition\n",s="\n## Agent Definitions\n",o="\n## Assignments\n",a="\n## Agent Assignments\n",d="\n## Input Device Assignments\n",c="\n## Restored Assignments\n";for(t in eden.root.symbols){var h=eden.root.symbols[t],p=h.last_modified_by;void 0===p&&console.log(h),"string"!=typeof p.name&&console.log(p),"*Default"!=p.name&&(p.canUndo&&p.canUndo()||e&&e[p.name]||p.meta&&p.last_exec_version!=p.meta.saveID||"*"==p.name.charAt(0)||"/"==p.name.charAt(0))&&(h.eden_definition?h.eden_definition.startsWith("func")?n+=h.eden_definition+"\n":"*Restore"==p.name?i+=h.eden_definition+"\n":"*When"==p.name?s+=h.eden_definition+"\n":r+=h.eden_definition+"\n":void 0!==h.cache.value&&(h=t+" = "+Eden.edenCodeForValue(h.cache.value)+";\n",p instanceof Symbol&&p.eden_definition&&p.eden_definition.startsWith("proc")||"*JavaScript"==p.name||"*When"==p.name?a+=h:"*Input Device"==p.name?d+=h:"*Restore"==p.name?c+=h:o+=h))}return n+r+i+s+o+c+a+d+"\n## Procedures\n"},Eden.Generator.importsScript=function(){var e,t="";for(e in Eden.Agent.agents){var n=Eden.Agent.agents[e],r="";-1!=n.meta.saveID||n.meta.file||(r=" create"),n.last_exec_version&&(t+="import "+e+"@"+(-1==n.last_exec_version?"origin":n.last_exec_version)+r+";\n"),n.last_exec_version!=n.meta.saveID&&(t+="import "+e+"@"+(-1==n.meta.saveID?"origin":n.meta.saveID)+r+" noexec;\n")}return t},Eden.Generator.getScript=function(){return Eden.Generator.importsScript()+"\n"+Eden.Generator.symbolScript()},Eden.Peer=function(i,e){this.connections={},this.id=e,this.master=i;var E=this;function g(n){!function i(s,o,a){Eden.Selectors.query(o.remove[s].path,void 0,void 0,function(e){var t=e[0];if(t){this.frags[o.remove[s].path]=t;var n=void 0;if(0==o.remove[s].id)n=t.statements[0];else for(var r=0;r<t.statements.length;r++)if(t.statements[r].id==o.remove[s].id){o.remove[s].ws?(n=t.statements[r].nextSibling)&&"dummy"!=n.type&&(n=void 0):n=t.statements[r];break}if(n){for(var r=0;r<o.add.length;r++)o.add[r].ws&&o.add[r].id==n.id&&(o.add[r].id=n.previousSibling?n.previousSibling.id:0);this.todorm.push([t,n])}s<o.remove.length-1?i(s+1,o,a):a()}else s<o.remove.length-1?i(s+1,o,a):a()})}(0,n,function(){for(var t,e=0;e<this.todorm.length;e++)this.todorm[e][0].removeChild(this.todorm[e][1]);(function s(o,a,d){Eden.Selectors.query(a.add[o].path,void 0,void 0,function(e){var t=e[0];if(t){if(this.frags[a.add[o].path]=t,a.add[o].ws){var n=new Eden.AST.DummyStatement;if(n.source=a.add[o].source,n.numlines=n.source.split("\n").length-1,0==a.add[o].id)t.statements[0]?t.insertBefore(t.statements[0],n):t.appendChild(n),n.buildID();else{for(var r=0;r<t.statements.length;r++)if(t.statements[r].id==a.add[o].id){var i=t.statements[r].nextSibling;i?t.insertBefore(i,n):t.appendChild(n),n=void 0;break}n&&(t.appendChild(n),n.buildID())}}else{var n=Eden.AST.parseStatement(a.add[o].source);t.statements[a.add[o].index]?t.insertBefore(t.statements[a.add[o].index],n):t.appendChild(n)}o<a.add.length-1?s(o+1,a,d):d()}else o<a.add.length-1?s(o+1,a,d):d()})})(0,t=n,function(){for(var e in this.frags)Eden.Fragment.emit("patch",[void 0,this.frags[e]]);E.broadcastExcept(t.id,t)})})}function s(e,t){var n=JSON.parse(t);n.id=e.peer;var r,i,s,o,a,d,c,h,p,l,u=E.connections[n.id];switch(n.cmd){case"assign":u.observe&&(h=n,p=eden.root.lookup(h.symbol),l=Eden.AST.parseExpression(h.value),p.assign(l.execute({},EdenSymbol.netAgent,eden.root.scope),eden.root.scope,EdenSymbol.netAgent),E.broadcastExcept(h.id,h));break;case"define":u.observe&&function(e){eden.root.lookup(e.symbol);var t=Eden.AST.parseStatement(e.source);t.local=!0,t.execute({},EdenSymbol.netAgent,eden.root.scope),E.broadcastExcept(e.id,e)}(n);break;case"do":u.observe&&processDo(n);break;case"listassign":u.observe&&(p=n,l=eden.root.lookup(p.symbol),h=Eden.AST.parseExpression(p.value),l.listAssign(h.execute({},EdenSymbol.netAgent,eden.root.scope),eden.root.scope,EdenSymbol.netAgent,!1,p.components),E.broadcastExcept(p.id,p));break;case"restore":u.observe&&(c=n,E.loading=!0,eden.root.lookup("jseden_project_mode").assign(eden.root.lookup("jseden_p2p_doactive").value()?"restore":"normal",eden.root.scope,Symbol.defaultAgent),eden.project=new Eden.Project(c.pid,c.name,c.script,eden),Eden.Project.emit("loading",[eden.project]),eden.project.vid=c.vid,eden.project.title=c.title,eden.project.author=c.ownername,eden.project.authorid=c.owner,eden.project.start(function(){Eden.Project.emit("load",[eden.project]),E.loading=!1}));break;case"execstatus":u.observe;break;case"register":d=n,console.log("Register peer",d.id,d.username),Eden.Peer.emit("user",[d.id,d.username]),eden.root.lookup("jseden_p2p_"+d.id.replace(/\-/g,"_")+"_name").assign(d.username,eden.root.scope,EdenSymbol.localJSAgent),E.connections[d.id].connection.send(JSON.stringify({cmd:"status",status:"Connected",code:1}));break;case"status":Eden.Peer.emit("status",[n.status,n.code]);break;case"getsnapshot":c=n,d=eden.project.generate(),E.connections[c.id].connection.send(JSON.stringify({cmd:"callback",data:d,cbid:c.cbid}));break;case"callback":o=n,(a=E.callbacks[o.cbid])&&a(o.data),delete E.callbacks[o.cbid];break;case"reqshare":s=n,a=E.connections[s.id],s.value?(a.share=!0,eden.project&&E.clone&&(o=eden.project.generate(),a.connection.send(JSON.stringify({cmd:"restore",script:o,pid:eden.project.id,vid:eden.project.vid,ownername:eden.project.author,owner:eden.project.authorid,name:eden.project.name,title:eden.project.title}))),a.connection.send(JSON.stringify({cmd:"callback",data:!0,cbid:s.cbid})),Eden.Peer.emit("share",[s.id])):(a.share=!1,Eden.Peer.emit("unshare",[s.id]));break;case"reqobserve":i=n,s=E.connections[i.id],i.value?(s.observe=!0,s.connection.send(JSON.stringify({cmd:"callback",data:!0,cbid:i.cbid})),Eden.Peer.emit("observe",[i.id])):(s.observe=!1,Eden.Peer.emit("unobserve",[i.id]));break;case"patch":!function(e){this.frags={},this.todorm=[],g(e)}(n);break;case"when":r=n,console.log("ProcessWhen",r),Eden.Selectors.query(".id("+r.wid+")",void 0,void 0,function(e){for(var t=0;t<e.length;t++)r.status?eden.project.registerAgent(e[t],!0):eden.project.removeAgent(e[t],!0)});break;case"require":i=n,edenUI.loadPlugin(i.name);break;case"call":!function(e){var t=eden.root.lookup(e.name);try{t.value().apply(t,e.args)}catch(e){}}(n)}E.config.logging&&console.log(n)}function t(n){var r;E.enabled||(n&&(n.replace(/[ \!\'\-\?\&]/g,""),r=e?new Peer(e,{config:{iceServers:[{url:"stun:stun.l.google.com:19302"}]}}):new Peer({config:{iceServers:[{url:"stun:stun.l.google.com:19302"}]}}),(e||i)&&(E.enabled=!0),r.on("open",function(e){var t;console.log("My peer id is "+e),i&&(t=r.connect(i,{reliable:!0})).on("open",function(){E.connections[t.peer]={id:t.peer,username:void 0,connection:t,share:!1,observe:!1},t.on("data",function(e){s(t,e)}),eden.root.lookup("jseden_p2p_newconnections").append(t.peer,eden.root.scope,EdenSymbol.localJSAgent),t.send(JSON.stringify({cmd:"register",username:n,id:e}))})}),r.on("connection",function(t){E.connections[t.peer]={id:t.peer,username:void 0,connection:t,share:!1,observe:!1},t.on("data",function(e){s(t,e)}),console.log("Peer connection from "+t.peer),Eden.Peer.emit("peer",[t.peer]),eden.root.lookup("jseden_p2p_newconnections").append(t.peer,eden.root.scope,EdenSymbol.localJSAgent),t.on("open",function(){var e;E.config.share&&E.clone&&(e=eden.project.generate(),t.connection.send(JSON.stringify({cmd:"restore",script:e,pid:eden.project.id,vid:eden.project.vid,ownername:eden.project.author,owner:eden.project.authorid,name:eden.project.name,title:eden.project.title})))})}),r.on("error",function(e){console.log("Peer error: ",e),Eden.Peer.emit("error",[e]),eden.root.lookup("jseden_p2p_errors").append(e,eden.root.scope,EdenSymbol.localJSAgent)}),r.on("disconnected",function(e){Eden.Peer.emit("disconnect",[e.peer,E.connections[e.peer]?E.connections[e.peer].username:void 0]),delete E.connections[e.peer],eden.root.lookup("jseden_p2p_newdisconnections").append(e.peer,eden.root.scope,EdenSymbol.localJSAgent)})),Eden.Fragment.listenTo("patch",this,function(e,t,n){n&&0<n.length&&E.capturepatch&&(n={cmd:"patch",remove:n[1],add:n[0]},E.broadcast(n))}))}this.roles={},this.enabled=!1,this.loading=!1,this.config={control:!0,share:!1,observe:!1,logging:!1},this.callbacks={},this.callbackid=0,this.capturepatch=!1,this.record=!1,this.clone=!0,this.startrecordtime=0,this.log=null,this.frags={},this.todorm=[],void 0===eden.root.lookup("jseden_p2p_newconnections").value()&&eden.root.lookup("jseden_p2p_newconnections").assign([],eden.root.scope,EdenSymbol.defaultAgent),void 0===eden.root.lookup("jseden_p2p_newdisconnections").value()&&eden.root.lookup("jseden_p2p_newdisconnections").assign([],eden.root.scope,EdenSymbol.defaultAgent),void 0===eden.root.lookup("jseden_p2p_errors").value()&&eden.root.lookup("jseden_p2p_errors").assign([],eden.root.scope,EdenSymbol.defaultAgent),void 0===eden.root.lookup("jseden_p2p_doactive").value()&&eden.root.lookup("jseden_p2p_doactive").assign(!0,eden.root.scope,EdenSymbol.defaultAgent),Eden.Selectors.execute("lib > p2p",eden.root.scope),this.init=t,Eden.DB.listenTo("login",this,t),(i||Eden.DB.isLoggedIn()&&e)&&t(Eden.DB.username||"Anonymous"),eden.root.lookup("jseden_p2p_captureinput").addJSObserver("p2p",function(e,t){t?(EdenSymbol.hciAgent.local=!1,EdenSymbol.localJSAgent.local=!1):(EdenSymbol.hciAgent.local=!0,EdenSymbol.localJSAgent.local=!0)});var n=eden.root.lookup("jseden_p2p_clone");void 0===n.value()&&n.assign(!0,eden.root.scope,EdenSymbol.defaultAgent),n.addJSObserver("p2p",function(e,t){E.clone=!!t}),eden.root.lookup("jseden_p2p_captureedits").addJSObserver("p2p",function(e,t){E.capturepatch=t}),eden.root.lookup("jseden_p2p_record").addJSObserver("p2p",function(e,t){(E.record=t)&&(E.startrecordtime=Date.now(),E.log=[])}),edenUI.views.Peers={dialog:function(e,t){e.slice(0,-7),$('<div id="'+e+'"></div>').html("").dialog({title:"Peer Connections",width:200,height:300,minHeight:120,minWidth:100})},title:"Connections",category:edenUI.viewCategories.environment},edenUI.menu.updateViewsMenu()},Eden.Peer.listeners={},Eden.Peer.emit=emit,Eden.Peer.listenTo=listenTo,Eden.Peer.prototype.broadcast=function(e){if(!this.loading)for(var t in e=JSON.stringify(e),this.record&&this.log.push('{"timestamp": '+(Date.now()-this.startrecordtime)+', "message": "'+e+'"}'),this.connections){t=this.connections[t];t.share&&t.connection.send(e)}},Eden.Peer.prototype.broadcastExcept=function(e,t){if(!this.loading&&void 0!==this.id)for(var n in t=JSON.stringify(t),this.connections)n!=e&&((n=this.connections[n]).share&&n.connection.send(t))},Eden.Peer.prototype.authoriseWhen=function(e){if(this.enabled){if(e.roles){var t=e.roles;if(t&&0<t.length){for(var n=0;n<t.length;n++)if(this.roles[t[n]])return!0;return!1}}return!0}return!0},Eden.Peer.prototype.assign=function(e,t,n){!e||e.loading||e.local||this.broadcast({cmd:"assign",symbol:t,value:Eden.edenCodeForValue(n)})},Eden.Peer.prototype.define=function(e,t,n,r){!e||e.loading||e.local||this.broadcast({cmd:"define",symbol:t,source:n,dependencies:r})},Eden.Peer.prototype.doRequire=function(e){this.broadcast({cmd:"require",name:e})},Eden.Peer.prototype.doImport=function(e,t){},Eden.Peer.prototype.callProcedure=function(e,t){this.broadcast({cmd:"call",name:e,args:t})},Eden.Peer.prototype.activateWhen=function(e){this.broadcast({cmd:"when",status:!0,wid:e})},Eden.Peer.prototype.deactivateWhen=function(e){this.broadcast({cmd:"when",status:!1,wid:e})},Eden.Peer.prototype.listAssign=function(e,t,n,r){!e||e.loading||e.local||this.broadcast({cmd:"listassign",symbol:t,value:Eden.edenCodeForValue(n),components:r})},Eden.Peer.prototype.addCallback=function(e){var t=this.callbackid++;return this.callbacks[t]=e,t},Eden.Peer.prototype.getSnapshot=function(e,t){this.connections[e]&&this.connections[e].connection.send(JSON.stringify({cmd:"getsnapshot",cbid:this.addCallback(t)}))},Eden.Peer.prototype.requestShare=function(e,t){e=this.connections[e];e&&(e.observe=!0,e.connection.send(JSON.stringify({cmd:"reqshare",value:!0,cbid:this.addCallback(t)})))},Eden.Peer.prototype.requestUnShare=function(e,t){e=this.connections[e];e&&(e.observe=!1,e.connection.send(JSON.stringify({cmd:"reqshare",value:!1,cbid:this.addCallback(t)})))},Eden.Peer.prototype.requestObserve=function(e,t){e=this.connections[e];e&&(e.share=!0,e.connection.send(JSON.stringify({cmd:"reqobserve",value:!0,cbid:this.addCallback(t)})),eden.project&&this.clone&&(t=eden.project.generate(),e.connection.send(JSON.stringify({cmd:"restore",script:t,pid:eden.project.id,vid:eden.project.vid,ownername:eden.project.author,owner:eden.project.authorid,name:eden.project.name,title:eden.project.title}))))},Eden.Peer.prototype.requestUnObserve=function(e,t){e=this.connections[e];e&&(e.share=!1,e.connection.send(JSON.stringify({cmd:"reqobserve",value:!1,cbid:this.addCallback(t)})))},Eden.Peer.prototype.requestCollaborate=function(e,t){var n,r=this,i=this.connections[e];i&&(i.connection.send(JSON.stringify({cmd:"reqshare",value:!0,cbid:this.addCallback(function(){i.observe=!0,r.requestObserve(e,t)})})),eden.project&&r.clone&&(n=eden.project.generate(),i.connection.send(JSON.stringify({cmd:"restore",script:n,pid:eden.project.id,vid:eden.project.vid,ownername:eden.project.author,owner:eden.project.authorid,name:eden.project.name,title:eden.project.title}))))},Eden.Peer.prototype.requestUnCollaborate=function(e,t){},Eden.AST.DummyContext={subscribeDynamic:function(e,t){return t},scopes:[]},Eden.AST.prototype.executeGenerator=function*(e,n,r,i,s){var o=[];this.executed=1;var a=0;if(void 0!==e)for(;a<e.length||0<o.length;)if(a>=e.length&&0<o.length)e=o[o.length-1].statements,a=o[o.length-1].index,i=o[o.length-1].scope,o.pop();else{let t=e[a];switch(Eden.AST.debug&&"script"!==t.type&&(Eden.AST.debugstep||s&&s.doDebug&&s.doDebug())&&(yield{type:"debug",base:r,script:this,index:a,statement:t,context:n,agent:s}),t.type){case"wait":t.executed=1,t.compile(n),t.compiled_delay?yield t.compiled_delay(i.context,i):yield 0;break;case"import":void 0===t.statements&&(t.selector=t.path?t.path.execute(n,r,i,s):void 0,yield t);break;case"query":t.modexpr&&(t.executed=1,t._selector=t.selector.execute(n,r,i,s),t._modexpr=t.modexpr.execute(n,r,i,s),yield t);break;case"do":if(t.executed=1,t.selector=t.name?t.name.execute(n,r,i,s):void 0,t.nscope=t.getScope(n,i)(i.context,i),t.literal){var d={isconstant:!1,locals:n.locals},c=Eden.AST.executeExpressionNode(t.literal,t.nscope,d),d="string"==typeof c?Eden.AST.parseScript(c,t):c;if(d&&0<d.errors.length){let e=new Eden.RuntimeError(i.context,Eden.RuntimeError.EXECUTESYNTAX,t,'"'+c+'" - '+d.errors[0].messageText());e.line=t.line,i.context.instance.emit("error",[t.parent,e]),t.statements=[]}else d&&(d.parent=t.parent),t.statements=d?d.statements:[]}yield t;break;case"when":var h,p=t;0==p.active&&(p.active=!0,(h=p.execute(void 0,r,i,s))?r.executeStatements(h,-1,p,null,null,i):p.active=!1);break;default:if((h=t.execute(n,r,i,s))&&Array.isArray(h)&&0<h.length){p=i;"scopedscript"==t.type&&(p=t.scope),++a<e.length&&o.push({statements:e,index:a,scope:i}),e=h,i=p,a=0;continue}if(-1===h)return}0<t.errors.length&&this.script.errors.push.apply(this.script.errors,t.errors),a++}},Eden.AST.prototype.executeStatement=function(e,t,n,r){Eden.AST.debug&&(Eden.AST.debugstep||n&&n.doDebug&&n.doDebug())&&Eden.AST.debug_begin_cb&&Eden.AST.debug_begin_cb({base:this,agent:n}),Eden.AST.DummyContext.locals=void 0;var i,s={cb:r,result:void 0};try{var o=this.executeGenerator([e],s,this,t,n);runEdenAction.call(this,n,t,o,function(){Eden.AST.debug&&(Eden.AST.debugstep||n&&n.doDebug&&n.doDebug())&&Eden.AST.debug_end_cb&&Eden.AST.debug_end_cb({base:this,agent:n}),r&&r(s.result)})}catch(e){Eden.AST.debug&&(Eden.AST.debugstep||n&&n.doDebug&&n.doDebug())&&Eden.AST.debug_end_cb&&Eden.AST.debug_end_cb({base:this,agent:n}),r&&r(e),(i=/[0-9][0-9]*/.test(e.message)?new Eden.RuntimeError(t.context,parseInt(e.message),void 0,e.message):new Eden.RuntimeError(t.context,0,void 0,e)).line=this.line,n?t.context.instance.emit("error",[n,i]):console.log(i.prettyPrint())}},Eden.AST.prototype.executeStatements=function(e,t,n,r,i,s){if(!s)throw"Missing scope";Eden.AST.debug&&(Eden.AST.debugstep||n&&n.doDebug&&n.doDebug())&&Eden.AST.debug_begin_cb&&Eden.AST.debug_begin_cb({base:this,agent:n});try{var o=this.executeGenerator(e,i,this,s,n);runEdenAction.call(this,n,s,o,function(){Eden.AST.debug&&(Eden.AST.debugstep||n&&n.doDebug&&n.doDebug())&&Eden.AST.debug_end_cb&&Eden.AST.debug_end_cb({base:this,agent:n}),r&&r()})}catch(e){var a;console.error(e),Eden.AST.debug&&(Eden.AST.debugstep||n&&n.doDebug&&n.doDebug())&&Eden.AST.debug_end_cb&&Eden.AST.debug_end_cb({base:this,agent:n}),r&&r(),(a=/[0-9][0-9]*/.test(e.message)?new Eden.RuntimeError(this,parseInt(e.message),void 0,e.message):new Eden.RuntimeError(this,0,void 0,e)).line=this.line,n?s.context.instance.emit("error",[n,a]):console.log(a.prettyPrint())}};